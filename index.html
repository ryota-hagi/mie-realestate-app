<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="VBmM5Mikm2LrkY9dXa30MUHtT9KD2SpZFsoGHBuFPWM" />
<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SZV3XF0W0G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SZV3XF0W0G');
</script>
<title>注文住宅の物件比較ツール｜AIで簡単比較 | 注文相談.com</title>
<meta name="description" content="注文住宅の土地探しに。気になる物件のURLを貼るだけでAIが自動整理。複数物件を並べて比較表を作成。SUUMO・アットホーム等の物件を統一フォーマットで比較できる無料ツール。">
<meta name="keywords" content="注文住宅,物件比較,土地比較,AI,土地探し,SUUMO,アットホーム,不動産比較,比較表">
<link rel="canonical" href="https://research.chuumon-soudan.com/">
<!-- OGP -->
<meta property="og:title" content="注文住宅の物件比較ツール｜AIで簡単比較">
<meta property="og:description" content="注文住宅の土地探しに。気になる物件のURLを貼るだけでAIが自動整理。複数物件を並べて比較表を作成。SUUMO・アットホーム等の物件を統一フォーマットで比較できる無料ツール。">
<meta property="og:type" content="website">
<meta property="og:url" content="https://research.chuumon-soudan.com/">
<meta property="og:site_name" content="注文相談.com">
<meta property="og:locale" content="ja_JP">
<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="注文住宅の物件比較ツール｜AIで簡単比較">
<meta name="twitter:description" content="注文住宅の土地探しに。気になる物件のURLを貼るだけでAIが自動整理。複数物件を並べて比較表を作成。">
<!-- 構造化データ (JSON-LD) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "注文住宅 物件比較ツール",
  "description": "注文住宅の土地探しに。AIが物件情報を自動整理し、複数物件を比較表で一覧比較できる無料ツール",
  "url": "https://research.chuumon-soudan.com/",
  "applicationCategory": "RealEstate",
  "operatingSystem": "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "JPY" },
  "author": { "@type": "Organization", "name": "注文相談.com" },
  "about": [
    { "@type": "Thing", "name": "注文住宅" },
    { "@type": "Thing", "name": "物件比較" },
    { "@type": "Thing", "name": "土地探し" }
  ]
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* === Tailwind CSS v3.4.19 (production build) === */
  *,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sticky{position:sticky}.top-0{top:0}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-1{margin-left:.25rem}.mt-0\.5{margin-top:.125rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.h-6{height:1.5rem}.w-12{width:3rem}.w-16{width:4rem}.w-28{width:7rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-8{width:2rem}.w-full{width:100%}.min-w-0{min-width:0}.max-w-6xl{max-width:72rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity,1))}.border-blue-100{--tw-border-opacity:1;border-color:rgb(219 234 254/var(--tw-border-opacity,1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-50{--tw-border-opacity:1;border-color:rgb(249 250 251/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.bg-amber-500{--tw-bg-opacity:1;background-color:rgb(245 158 11/var(--tw-bg-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgb(156 163 175/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94/var(--tw-bg-opacity,1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity,1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255/var(--tw-bg-opacity,1))}.bg-slate-400{--tw-bg-opacity:1;background-color:rgb(148 163 184/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.p-2{padding:.5rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.leading-relaxed{line-height:1.625}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-amber-800{--tw-text-opacity:1;color:rgb(146 64 14/var(--tw-text-opacity,1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.shadow-md,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.outline{outline-style:solid}.blur{--tw-blur:blur(8px)}.blur,.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-filter{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-100:hover{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:bg-green-100:hover{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity,1))}@media (min-width:640px){.sm\:block{display:block}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.sm\:flex-row{flex-direction:row}}@media (min-width:768px){.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  * { font-family: 'Noto Sans JP', sans-serif; }
  body { background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 50%, #f5f0ff 100%); min-height: 100vh; }
  .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); }
  .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; transition: all 0.2s; }
  .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  /* === Second Opinion Feature === */
  .so-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; }
  .so-modal { background: white; border-radius: 16px; max-width: 560px; width: 90%; max-height: 85vh; overflow-y: auto; padding: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
  .so-badge-yellow { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-red { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-none { background: #f0fdf4; color: #166534; border: 1px solid #86efac; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-compare-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .so-compare-table th, .so-compare-table td { padding: 8px 12px; border: 1px solid #e5e7eb; text-align: left; }
  .so-compare-table th { background: #f9fafb; font-weight: 600; white-space: nowrap; }
  .so-compare-table .missing { color: #d97706; font-style: italic; }
  .so-radio-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .so-radio-group label { padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
  .so-radio-group label:hover { border-color: #3b82f6; background: #eff6ff; }
  .so-radio-group input:checked + span { color: #1d4ed8; }
  .so-radio-group label:has(input:checked) { border-color: #3b82f6; background: #dbeafe; }
  @media (max-width: 768px) {
    .comp-layout-sidebar { flex-direction: column !important; }
    .comp-layout-sidebar > div:first-child { width: 100% !important; }
    .comp-layout-sidebar > div:first-child .sticky { position: relative !important; top: 0 !important; }
  }
</style>
</head>
<body>
<div id="app"></div>

<script>
// ============================================================
// 設定
// ============================================================
const CONFIG = {
  SUPABASE_URL: 'https://jvfmvitknqnmuduyscnl.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2Zm12aXRrbnFubXVkdXlzY25sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4ODE5NTQsImV4cCI6MjA4NjQ1Nzk1NH0.dDsHJXxFW4R-8ts-sKfGHtE-P0Ge9mPYEtpl-30dAdg',
};

// ============================================================
// Supabase Client + Anonymous Auth
// ============================================================
const supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

async function ensureAuth() {
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) return session.user;
    const { data, error } = await supabaseClient.auth.signInAnonymously();
    if (error) { console.warn('Anonymous auth failed:', error.message); return null; }
    return data.user;
  } catch(e) { console.warn('Auth error:', e.message); return null; }
}

// ============================================================
// Auth Helpers
// ============================================================
function isAnonymousUser() {
  return !state.authUser || state.authUser.is_anonymous;
}

function updateAuthState(user) {
  if (user) {
    state.authUser = {
      id: user.id,
      email: user.email || null,
      is_anonymous: user.is_anonymous || !user.email,
    };
  } else {
    state.authUser = null;
  }
}

async function handleSendOtp(email) {
  state.authLoading = true;
  state.authError = '';
  render();
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    const currentUser = session?.user;
    if (currentUser && currentUser.is_anonymous) {
      // 匿名→正式アカウントへアップグレード（確認メール送信）
      const { error } = await supabaseClient.auth.updateUser({ email });
      if (error) throw error;
      state.authEmail = email;
      state.authStep = 'link_sent'; // リンククリック待ち
    } else {
      // 通常ログイン（OTP送信）
      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: { shouldCreateUser: true },
      });
      if (error) throw error;
      state.authEmail = email;
      state.authStep = 'otp';
    }
  } catch(e) {
    state.authError = e.message || '送信に失敗しました';
  }
  state.authLoading = false;
  render();
}

async function handleVerifyOtp(email, token) {
  state.authLoading = true;
  state.authError = '';
  render();
  try {
    const { data, error } = await supabaseClient.auth.verifyOtp({
      email,
      token,
      type: 'email',
    });
    if (error) throw error;
    updateAuthState(data.user);
    state.authModalOpen = false;
    state.authStep = 'email';
    state.authEmail = '';
    // データ再読み込み
    await loadSavedProperties();
    await loadSavedComparisons();
    // 未保存の比較表があればDBに保存
    await saveUnsavedComparisons();
    // マイページプロファイル読み込み
    await loadUserProfile();
  } catch(e) {
    state.authError = e.message || '認証に失敗しました';
  }
  state.authLoading = false;
  render();
}

async function handleLogout() {
  await supabaseClient.auth.signOut();
  state.authUser = null;
  state.userProfile = null;
  state.savedProperties = [];
  state.savedComparisons = [];
  state.soComparison = null;
  state.soView = null;
  try {
    localStorage.removeItem('mie_saved_properties');
    localStorage.removeItem('mie_comparison');
    localStorage.removeItem('mie_saved_comparisons');
  } catch(e) {}
  // 新しい匿名セッションを開始
  const user = await ensureAuth();
  if (user) updateAuthState(user);
  render();
}

function openAuthModal() {
  state.authModalOpen = true;
  state.authStep = 'email';
  state.authEmail = '';
  state.authError = '';
  state.authLoading = false;
  render();
}

async function saveUnsavedComparisons() {
  const user = state.authUser;
  if (!user || user.is_anonymous) return;
  const unsaved = state.savedComparisons.filter(c => c._unsaved);
  for (const comp of unsaved) {
    try {
      const { data } = await supabaseClient.from('comparisons').insert({
        user_id: user.id, name: comp.name, property_ids: comp.property_ids,
        ai_summary: comp.summary, ai_questions: comp.questions,
      }).select().single();
      if (data) {
        comp.id = data.id;
        comp.created_at = data.created_at;
        delete comp._unsaved;
        // soComparisonも更新
        if (state.soComparison && state.soComparison._unsaved) {
          state.soComparison.id = data.id;
          delete state.soComparison._unsaved;
        }
      }
    } catch(e) { console.warn('Failed to save comparison:', e.message); }
  }
  backupComparisonsToLS();
}

// ============================================================
// User Profile (マイページ)
// ============================================================
const PRIORITY_OPTIONS = [
  { key: 'garden', label: '庭が広い' },
  { key: 'sunlight', label: '日当たりが良い' },
  { key: 'quiet', label: '静かな環境' },
  { key: 'childcare', label: '子育てしやすい' },
  { key: 'park_nearby', label: '近くに公園がある' },
  { key: 'shopping_nearby', label: '商業施設が近い' },
  { key: 'residential', label: '閑静な住宅街' },
  { key: 'station_near', label: '駅が近い' },
  { key: 'large_lot', label: '土地が広い' },
  { key: 'nature', label: '自然環境が豊か' },
];

async function loadUserProfile() {
  const user = state.authUser;
  if (!user || user.is_anonymous) return;
  try {
    const { data } = await supabaseClient
      .from('user_profiles')
      .select('*')
      .eq('user_id', user.id)
      .maybeSingle();
    state.userProfile = data || null;
  } catch(e) { console.warn('Failed to load profile:', e.message); }
}

async function geocodeAddress(address) {
  if (!address || !address.trim()) return null;
  try {
    const res = await fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`);
    if (!res.ok) return null;
    const data = await res.json();
    if (data && data.length > 0 && data[0].geometry && data[0].geometry.coordinates) {
      const [lng, lat] = data[0].geometry.coordinates;
      return { lat, lng };
    }
  } catch(e) { console.warn('Geocode failed:', e.message); }
  return null;
}

async function saveUserProfile(profileData) {
  const user = state.authUser;
  if (!user || user.is_anonymous) return;
  state._profileLoading = true;
  state._profileSaved = false;
  // フォーム値を一時保持（render()でリセットされないよう）
  state.userProfile = { ...state.userProfile, ...profileData };
  render();

  // 勤務先住所のジオコーディング
  if (profileData.spouse1_workplace) {
    const geo = await geocodeAddress(profileData.spouse1_workplace);
    if (geo) { profileData.spouse1_lat = geo.lat; profileData.spouse1_lng = geo.lng; }
    else { profileData.spouse1_lat = null; profileData.spouse1_lng = null; }
  } else {
    profileData.spouse1_lat = null; profileData.spouse1_lng = null;
  }
  if (profileData.spouse2_workplace) {
    const geo = await geocodeAddress(profileData.spouse2_workplace);
    if (geo) { profileData.spouse2_lat = geo.lat; profileData.spouse2_lng = geo.lng; }
    else { profileData.spouse2_lat = null; profileData.spouse2_lng = null; }
  } else {
    profileData.spouse2_lat = null; profileData.spouse2_lng = null;
  }

  const row = { ...profileData, user_id: user.id, updated_at: new Date().toISOString() };

  try {
    const { error } = await supabaseClient
      .from('user_profiles')
      .upsert(row, { onConflict: 'user_id' });
    if (error) throw error;
    state.userProfile = row;
    state._profileSaved = true;
    setTimeout(() => { state._profileSaved = false; render(); }, 3000);
  } catch(e) { console.warn('Failed to save profile:', e.message); alert('保存に失敗しました: ' + e.message); }

  state._profileLoading = false;
  render();
}

// ============================================================
// Area Data (used by calculateBadge and generateComparison)
// ============================================================
const AREAS = [
  { id: "yokkaichi", name: "四日市市", pricePerTsubo: 188498 },
  { id: "kuwana", name: "桑名市", pricePerTsubo: 183614 },
  { id: "suzuka", name: "鈴鹿市", pricePerTsubo: 135587 },
  { id: "inabe", name: "いなべ市", pricePerTsubo: 81000 },
  { id: "kameyama", name: "亀山市", pricePerTsubo: 97500 },
  { id: "komono", name: "菰野町", pricePerTsubo: 73000 },
  { id: "toin", name: "東員町", pricePerTsubo: 106000 }
];

// ============================================================
// Property CRUD (Supabase)
// ============================================================
async function loadSavedProperties() {
  const user = await ensureAuth();
  if (!user) return;
  const { data, error } = await supabaseClient.from('saved_properties').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
  if (!error && data) state.savedProperties = data;
}

async function saveProperty(prop) {
  try {
    const user = await ensureAuth();
    if (!user) { alert('物件の保存にはページの再読み込みが必要です'); return null; }
    let areaData = AREAS.find(a => a.id === prop.area_id);
    if (!areaData && prop.address) areaData = AREAS.find(a => prop.address.includes(a.name));
    const badge = calculateBadge(prop, areaData);
    const row = { ...prop, user_id: user.id, badge };
    const { data, error } = await supabaseClient.from('saved_properties').insert(row).select().single();
    if (error) { alert('保存に失敗しました: ' + error.message); console.error('Save failed:', error); return null; }
    state.savedProperties.unshift(data);
    backupToLocalStorage();
    // 位置情報がある場合、バックグラウンドでenrichment実行
    if (data.lat && data.lng) {
      triggerEnrichment(data.id).catch(e => console.warn('Auto-enrichment failed:', e.message));
    }
    return data;
  } catch(e) { alert('保存エラー: ' + e.message); return null; }
}

async function updateProperty(id, updates) {
  const prop = state.savedProperties.find(p => p.id === id);
  if (!prop) return;
  Object.assign(prop, updates);
  backupToLocalStorage();
  try {
    await supabaseClient.from('saved_properties').update(updates).eq('id', id);
  } catch(e) { console.warn('Supabase update failed, saved to localStorage:', e.message); }
}

async function deleteProperty(id) {
  const { error } = await supabaseClient.from('saved_properties').delete().eq('id', id);
  if (!error) state.savedProperties = state.savedProperties.filter(p => p.id !== id);
  backupToLocalStorage();
}

// ============================================================
// Property Enrichment（詳細情報の自動取得）
// ============================================================
async function triggerEnrichment(propertyId) {
  // ローカルステートを「取得中」に更新
  const prop = state.savedProperties.find(p => p.id === propertyId);
  if (prop) { prop.enrichment_status = 'pending'; render(); }

  try {
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    if (token) headers['Authorization'] = `Bearer ${token}`;
    else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/property-enrich`, {
      method: 'POST', headers,
      body: JSON.stringify({ action: 'enrich', property_id: propertyId })
    });
    if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
    const result = await res.json();
    if (result.error) throw new Error(result.error);

    // ローカルステートに結果を反映
    if (prop) {
      Object.assign(prop, result);
      backupToLocalStorage();
      render();
    }
    return result;
  } catch(e) {
    console.warn('Enrichment failed for', propertyId, ':', e.message);
    if (prop) { prop.enrichment_status = 'error'; render(); }
    throw e;
  }
}

async function handleEnrichProperty(propertyId) {
  try {
    await triggerEnrichment(propertyId);
  } catch(e) {
    // silently handled in triggerEnrichment
  }
}

// ============================================================
// Comparisons CRUD
// ============================================================
async function loadSavedComparisons() {
  try {
    const user = await ensureAuth();
    if (!user) return;
    const { data, error } = await supabaseClient.from('comparisons')
      .select('*').eq('user_id', user.id).order('created_at', { ascending: false });
    if (!error && data) {
      state.savedComparisons = data.map(c => ({
        id: c.id,
        name: c.name || '比較表',
        created_at: c.created_at,
        summary: c.ai_summary,
        questions: c.ai_questions,
        property_ids: c.property_ids,
        properties: null, // lazy load
      }));
      backupComparisonsToLS();
    }
  } catch(e) { console.warn('Load comparisons failed:', e.message); }
}

async function renameComparison(compId, newName) {
  const comp = state.savedComparisons.find(c => c.id === compId);
  if (!comp) return;
  comp.name = newName;
  if (state.soComparison && state.soComparison.id === compId) state.soComparison.name = newName;
  backupComparisonsToLS();
  try {
    await supabaseClient.from('comparisons').update({ name: newName }).eq('id', compId);
  } catch(e) { console.warn('Rename failed:', e.message); }
}

async function deleteComparison(compId) {
  state.savedComparisons = state.savedComparisons.filter(c => c.id !== compId);
  if (state.soComparison?.id === compId) { state.soComparison = null; state.soView = null; }
  backupComparisonsToLS();
  try {
    await supabaseClient.from('comparisons').delete().eq('id', compId);
  } catch(e) { console.warn('Delete comparison failed:', e.message); }
}

async function loadComparisonDetail(compId) {
  const comp = state.savedComparisons.find(c => c.id === compId);
  if (!comp) return;
  // property_idsから物件データを取得
  const propIds = comp.property_ids || [];
  let props = state.savedProperties.filter(p => propIds.includes(p.id));
  // Supabaseからも取得を試みる（削除済み物件対応）
  if (props.length < propIds.length) {
    try {
      const { data } = await supabaseClient.from('saved_properties').select('*').in('id', propIds);
      if (data) props = data;
    } catch(e) {}
  }
  let questions = [];
  try { questions = typeof comp.questions === 'string' ? JSON.parse(comp.questions) : (comp.questions || []); } catch(e) {}

  state.soComparison = {
    id: comp.id,
    name: comp.name,
    summary: comp.summary,
    questions,
    properties: props,
    property_ids: propIds,
    _unsaved: comp._unsaved || false,
  };
  state.soView = 'compare';
  backupToLocalStorage();
  render();
}

// localStorage バックアップ
const LS_PROPS_KEY = 'mie_saved_properties';
const LS_COMP_KEY = 'mie_comparison';
const LS_COMPS_KEY = 'mie_saved_comparisons';

function backupToLocalStorage() {
  try {
    localStorage.setItem(LS_PROPS_KEY, JSON.stringify(state.savedProperties));
    if (state.soComparison) localStorage.setItem(LS_COMP_KEY, JSON.stringify(state.soComparison));
  } catch(e) {}
}

function backupComparisonsToLS() {
  try { localStorage.setItem(LS_COMPS_KEY, JSON.stringify(state.savedComparisons)); } catch(e) {}
}

function restoreFromLocalStorage() {
  try {
    const props = localStorage.getItem(LS_PROPS_KEY);
    if (props) {
      const parsed = JSON.parse(props);
      if (Array.isArray(parsed) && parsed.length > 0 && state.savedProperties.length === 0) {
        state.savedProperties = parsed;
      }
    }
    const comp = localStorage.getItem(LS_COMP_KEY);
    if (comp) state.soComparison = JSON.parse(comp);
    const comps = localStorage.getItem(LS_COMPS_KEY);
    if (comps) {
      const parsed = JSON.parse(comps);
      if (Array.isArray(parsed) && state.savedComparisons.length === 0) state.savedComparisons = parsed;
    }
  } catch(e) {}
}

async function toggleComparison(id) {
  const prop = state.savedProperties.find(p => p.id === id);
  if (!prop) return;
  const newVal = !prop.in_comparison;
  const inCompCount = state.savedProperties.filter(p => p.in_comparison).length;
  if (newVal && inCompCount >= 5) { alert('比較は最大5件までです'); return; }
  const { error } = await supabaseClient.from('saved_properties').update({ in_comparison: newVal }).eq('id', id);
  if (!error) prop.in_comparison = newVal;
}

async function generateComparison() {
  const props = state.savedProperties.filter(p => p.in_comparison);
  if (props.length < 2) { alert('比較するには2件以上の物件を選択してください'); return null; }
  const areas = {};
  AREAS.forEach(a => { areas[a.id] = { name: a.name, pricePerTsubo: a.pricePerTsubo }; });
  try {
    const user = await ensureAuth();
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    headers['Authorization'] = token ? `Bearer ${token}` : `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-compare`, {
      method: 'POST', headers,
      body: JSON.stringify({ properties: props, areas })
    });
    const result = await res.json();
    const compName = '比較表 ' + new Date().toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

    // 匿名ユーザーの場合: DBに保存せず、ローカルのみで比較表を表示
    if (isAnonymousUser()) {
      const tempComp = {
        id: 'temp_' + Date.now(), name: compName, created_at: new Date().toISOString(),
        summary: result.summary, questions: JSON.stringify(result.questions),
        property_ids: props.map(p => p.id), properties: props, _unsaved: true,
      };
      state.savedComparisons.unshift(tempComp);
      backupComparisonsToLS();
      return { ...result, id: tempComp.id, name: compName, properties: props, _unsaved: true };
    }

    // ログイン済み: DBに保存
    const { data } = await supabaseClient.from('comparisons').insert({
      user_id: user.id, name: compName, property_ids: props.map(p => p.id), ai_summary: result.summary, ai_questions: JSON.stringify(result.questions)
    }).select().single();
    if (data) {
      state.savedComparisons.unshift({
        id: data.id, name: compName, created_at: data.created_at,
        summary: result.summary, questions: JSON.stringify(result.questions),
        property_ids: props.map(p => p.id), properties: props,
      });
      backupComparisonsToLS();
    }
    return { ...result, id: data?.id, name: compName, properties: props };
  } catch(e) { console.error('Comparison failed:', e); return null; }
}

function calculateBadge(property, areaData) {
  let yellowReasons = [], redReasons = [];
  if (!property.price) yellowReasons.push('価格未入力');
  if (!property.land_area) yellowReasons.push('面積未入力');
  if (!property.zoning) yellowReasons.push('用途地域不明');
  if (!property.road_access) yellowReasons.push('接道情報不明');
  if (!property.building_coverage) yellowReasons.push('建ぺい率不明');
  if (property.price && property.land_area && areaData) {
    const tsuboPr = property.price / (property.land_area / 3.305785);
    const areaTsubo = areaData.pricePerTsubo;
    if (areaTsubo && Math.abs(tsuboPr - areaTsubo) / areaTsubo > 0.25) redReasons.push('坪単価がエリア相場から乖離');
  }
  const missingCritical = [property.zoning, property.road_access, property.building_coverage, property.elevation, property.infrastructure].filter(v => !v).length;
  if (missingCritical >= 3) redReasons.push('重要項目が複数不明');
  return redReasons.length > 0 ? 'red' : yellowReasons.length > 0 ? 'yellow' : 'none';
}

// ============================================================
// Auto Scoring（物件スコアリング）
// ============================================================
// Haversine距離（メートル）
function haversineDistanceClient(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function calculateLifestyleScore(prop, profile) {
  if (!profile) return null;
  const priorities = profile.priorities || [];
  const hasWorkplace = (profile.spouse1_lat && profile.spouse1_lng) || (profile.spouse2_lat && profile.spouse2_lng);
  if (priorities.length === 0 && !hasWorkplace) return null;

  let score = 50;

  // --- 通勤サブスコア（±25pt） ---
  if (hasWorkplace && prop.lat && prop.lng) {
    const distances = [];
    if (profile.spouse1_lat && profile.spouse1_lng) {
      distances.push(haversineDistanceClient(prop.lat, prop.lng, profile.spouse1_lat, profile.spouse1_lng) / 1000);
    }
    if (profile.spouse2_lat && profile.spouse2_lng) {
      distances.push(haversineDistanceClient(prop.lat, prop.lng, profile.spouse2_lat, profile.spouse2_lng) / 1000);
    }
    if (distances.length > 0) {
      const avgKm = distances.reduce((a, b) => a + b, 0) / distances.length;
      if (avgKm < 5) score += 25;
      else if (avgKm < 10) score += 15;
      else if (avgKm < 20) score += 5;
      else if (avgKm < 30) score += 0;
      else score -= 10;
    }
  }

  // --- 重視項目サブスコア（±25pt） ---
  if (priorities.length > 0) {
    const extractDist = (str) => {
      if (!str) return null;
      const m = str.match(/(\d+)m/);
      return m ? parseInt(m[1]) : null;
    };

    const checks = {
      garden: () => {
        if (!prop.land_area) return null;
        return prop.land_area >= 200 ? 1 : prop.land_area >= 150 ? 0.5 : 0.2;
      },
      sunlight: () => {
        if (!prop.zoning) return null;
        if (/一低住|第一種低層/.test(prop.zoning)) return 1;
        if (/二低住|第二種低層/.test(prop.zoning)) return 0.7;
        if (/商業|工業/.test(prop.zoning)) return 0.2;
        return 0.5;
      },
      quiet: () => {
        if (!prop.zoning) return null;
        if (/低層|低住/.test(prop.zoning)) return 1;
        if (/住居/.test(prop.zoning)) return 0.6;
        if (/商業|工業/.test(prop.zoning)) return 0.1;
        return 0.5;
      },
      childcare: () => {
        const nursery = extractDist(prop.nearest_nursery);
        const school = extractDist(prop.school_elementary);
        let val = 0, count = 0;
        if (nursery != null) { val += nursery < 800 ? 1 : nursery < 1500 ? 0.6 : 0.2; count++; }
        if (school != null) { val += school < 800 ? 1 : school < 1500 ? 0.6 : 0.2; count++; }
        return count > 0 ? val / count : null;
      },
      park_nearby: () => {
        const d = extractDist(prop.nearest_park);
        if (d == null) return null;
        return d < 300 ? 1 : d < 600 ? 0.7 : d < 1000 ? 0.4 : 0.1;
      },
      shopping_nearby: () => {
        const d = extractDist(prop.nearest_supermarket);
        if (d == null) return null;
        return d < 500 ? 1 : d < 1000 ? 0.7 : d < 2000 ? 0.4 : 0.1;
      },
      residential: () => {
        if (!prop.zoning) return null;
        if (/低層|低住/.test(prop.zoning)) return 1;
        if (/住居/.test(prop.zoning)) return 0.7;
        if (/商業|工業/.test(prop.zoning)) return 0.2;
        return 0.5;
      },
      station_near: () => {
        if (!prop.station_distance) return null;
        const m = prop.station_distance.match(/(\d+)\s*分/);
        if (m) {
          const mins = parseInt(m[1]);
          return mins <= 5 ? 1 : mins <= 10 ? 0.7 : mins <= 20 ? 0.4 : 0.1;
        }
        const m2 = prop.station_distance.match(/(\d+)\s*m/);
        if (m2) {
          const mins = Math.round(parseInt(m2[1]) / 80);
          return mins <= 5 ? 1 : mins <= 10 ? 0.7 : mins <= 20 ? 0.4 : 0.1;
        }
        return null;
      },
      large_lot: () => {
        if (!prop.land_area) return null;
        return prop.land_area >= 250 ? 1 : prop.land_area >= 200 ? 0.7 : prop.land_area >= 150 ? 0.5 : 0.2;
      },
      nature: () => {
        const d = extractDist(prop.nearest_park);
        if (d == null) return null;
        return d < 500 ? 1 : d < 1000 ? 0.7 : 0.3;
      },
    };

    let totalVal = 0;
    let count = 0;
    for (const key of priorities) {
      const fn = checks[key];
      if (fn) {
        const result = fn();
        if (result !== null) { totalVal += result; count++; }
      }
    }
    if (count > 0) {
      score += Math.round((totalVal / count) * 25);
    }
  }

  return Math.max(0, Math.min(100, Math.round(score)));
}

function calculateScores(prop, userProfile) {
  if (!prop) return null;

  // リスクレベル判定ヘルパー
  // AI出力形式: 「低（理由...）」「中。理由...」「高（理由...）」
  // → 先頭の「低/中/高」を最優先で判定する（理由文中のキーワードに惑わされない）
  function riskLevel(text) {
    if (!text) return null;
    const t = text.trim();
    // 先頭が「高」「中」「低」で始まる場合はそれを採用
    if (/^高/.test(t)) return 'high';
    if (/^中/.test(t)) return 'medium';
    if (/^低/.test(t)) return 'low';
    // 先頭にない場合: 「。」や「（」の前の部分で判定
    const prefix = t.split(/[。（(]/)[0];
    if (prefix.includes('高')) return 'high';
    if (prefix.includes('中')) return 'medium';
    if (prefix.includes('低')) return 'low';
    return 'unknown';
  }

  // 安全性スコア (0-100) — ベースライン50、各項目で加減点
  let scoreSafety = 50;

  const floodRisk = riskLevel(prop.hazard_flood);
  if (floodRisk === 'low') scoreSafety += 15;
  else if (floodRisk === 'medium') scoreSafety -= 10;
  else if (floodRisk === 'high') scoreSafety -= 25;

  const sedimentRisk = riskLevel(prop.hazard_sediment);
  if (sedimentRisk === 'low') scoreSafety += 15;
  else if (sedimentRisk === 'medium') scoreSafety -= 15;
  else if (sedimentRisk === 'high') scoreSafety -= 30;

  const tsunamiRisk = riskLevel(prop.hazard_tsunami);
  if (tsunamiRisk === 'low') scoreSafety += 10;
  else if (tsunamiRisk === 'medium') scoreSafety -= 10;
  else if (tsunamiRisk === 'high') scoreSafety -= 20;

  if (prop.ground_type) {
    if (prop.ground_type.includes('台地') || prop.ground_type.includes('丘陵')) scoreSafety += 10;
    else if (prop.ground_type.includes('沖積') || prop.ground_type.includes('埋立')) scoreSafety -= 15;
  }

  // 物件情報のhazardフィールドに明確な指定記載がある場合のみ減点
  // 「指定有」「指定されています」等の確定表現のみ対象（「可能性」「推定」は除外）
  if (prop.hazard) {
    if (/指定有|指定されて|該当して|区域内/.test(prop.hazard)) scoreSafety -= 15;
  }

  // 利便性スコア (0-100)
  let scoreConvenience = 50;
  const extractDist = (str) => {
    if (!str) return null;
    const m = str.match(/(\d+)m/);
    return m ? parseInt(m[1]) : null;
  };
  const superDist = extractDist(prop.nearest_supermarket);
  if (superDist) { scoreConvenience += superDist < 500 ? 20 : superDist < 1000 ? 10 : superDist < 2000 ? 0 : -10; }
  const hospDist = extractDist(prop.nearest_hospital);
  if (hospDist) { scoreConvenience += hospDist < 1000 ? 10 : hospDist < 2000 ? 5 : 0; }
  const parkDist = extractDist(prop.nearest_park);
  if (parkDist) { scoreConvenience += parkDist < 500 ? 10 : parkDist < 1000 ? 5 : 0; }
  if (prop.school_elementary) {
    const schoolDist = extractDist(prop.school_elementary);
    if (schoolDist) { scoreConvenience += schoolDist < 800 ? 10 : schoolDist < 1500 ? 5 : 0; }
  }

  // コストスコア (0-100) — 追加費用リスクが主軸、エリア相場は参考程度
  // 追加コストが少ない物件ほど高スコアにする
  let scoreCost = 70; // 追加コストなしならベース70

  // AI判定による追加コスト減点（主軸: 0〜-50の範囲）
  if (prop.extra_cost_score != null && typeof prop.extra_cost_score === 'number') {
    scoreCost += prop.extra_cost_score; // 負の値が加算される（減点）
  }

  // エリア相場比較（参考: 控えめな加減点）
  if (prop.price && prop.land_area) {
    const tsuboPrice = prop.price / (prop.land_area / 3.305785) / 10000; // 万円/坪
    let areaData = AREAS.find(a => a.id === prop.area_id);
    if (!areaData && prop.address) areaData = AREAS.find(a => prop.address.includes(a.name));
    if (areaData) {
      const areaAvg = areaData.pricePerTsubo / 10000; // 万円/坪
      const ratio = tsuboPrice / areaAvg;
      if (ratio < 0.7) scoreCost += 15;       // 相場よりかなり安い
      else if (ratio < 0.9) scoreCost += 8;   // 相場よりやや安い
      else if (ratio < 1.1) scoreCost += 0;   // 相場並み
      else if (ratio > 1.3) scoreCost -= 10;  // 相場よりかなり高い
      else if (ratio > 1.1) scoreCost -= 5;   // 相場よりやや高い
    }
  }

  // ライフスタイルスコア
  const lifestyle = calculateLifestyleScore(prop, userProfile || null);

  // 総合スコア
  let scoreTotal;
  if (lifestyle !== null) {
    scoreTotal = Math.round(scoreSafety * 0.25 + scoreConvenience * 0.25 + scoreCost * 0.25 + lifestyle * 0.25);
  } else {
    scoreTotal = Math.round(scoreSafety * 0.35 + scoreConvenience * 0.35 + scoreCost * 0.3);
  }

  return {
    score_safety: Math.max(0, Math.min(100, Math.round(scoreSafety))),
    score_convenience: Math.max(0, Math.min(100, Math.round(scoreConvenience))),
    score_cost: Math.max(0, Math.min(100, Math.round(scoreCost))),
    score_lifestyle: lifestyle,
    score_total: Math.max(0, Math.min(100, scoreTotal)),
  };
}

function getScoreColor(score) {
  if (score >= 70) return '#16a34a'; // green
  if (score >= 45) return '#d97706'; // amber
  return '#dc2626'; // red
}

function renderScoreBar(label, score) {
  if (score == null) return '';
  const color = getScoreColor(score);
  return `<div class="flex items-center gap-2 text-xs">
    <span class="text-gray-500 w-12">${label}</span>
    <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
      <div class="h-full rounded-full" style="width:${score}%;background:${color};"></div>
    </div>
    <span class="font-medium" style="color:${color};">${score}</span>
  </div>`;
}

// ============================================================
// CSV Export
// ============================================================
function exportComparisonCSV() {
  const comp = state.soComparison;
  if (!comp || !comp.properties || comp.properties.length === 0) { alert('比較表がありません'); return; }
  const props = comp.properties;
  const labels = ['A','B','C','D','E'];

  const allKeys = [
    { label: '物件', fmt: (p, i) => '物件' + labels[i] },
    { label: '所在地', fmt: p => p.address || '' },
    { label: '価格(万円)', fmt: p => p.price ? (p.price / 10000) : '' },
    { label: '土地面積(㎡)', fmt: p => p.land_area || '' },
    { label: '坪単価(万円)', fmt: p => p.price && p.land_area ? (p.price / (p.land_area / 3.305785) / 10000).toFixed(1) : '' },
    { label: '駅距離', fmt: p => p.station_distance || '' },
    { label: '用途地域', fmt: p => p.zoning || '' },
    { label: '建ぺい率', fmt: p => p.building_coverage || '' },
    { label: '容積率', fmt: p => p.floor_area_ratio || '' },
    { label: '接道', fmt: p => p.road_access || '' },
    { label: 'インフラ', fmt: p => p.infrastructure || '' },
    { label: 'ハザード', fmt: p => p.hazard || '' },
    { label: '小学校区', fmt: p => p.school_elementary || '' },
    { label: '中学校区', fmt: p => p.school_junior_high || '' },
    { label: '最寄スーパー', fmt: p => p.nearest_supermarket || '' },
    { label: '最寄病院', fmt: p => p.nearest_hospital || '' },
    { label: '洪水リスク', fmt: p => p.hazard_flood || '' },
    { label: '土砂災害', fmt: p => p.hazard_sediment || '' },
    { label: '地盤', fmt: p => p.ground_type || '' },
    { label: 'AIコメント', fmt: p => p.ai_comment || '' },
    { label: 'メモ', fmt: p => p.user_memo || p.memo || '' },
    { label: '物件URL', fmt: p => p.url || '' },
  ];

  const csvRows = [];
  // ヘッダー
  csvRows.push(['項目', ...props.map((_, i) => '物件' + labels[i])].join(','));
  // データ行
  for (const row of allKeys) {
    const values = props.map((p, i) => {
      const val = row.fmt(p, i);
      // CSVエスケープ
      const str = String(val).replace(/"/g, '""');
      return str.includes(',') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
    });
    csvRows.push([row.label, ...values].join(','));
  }

  const bom = '\uFEFF';
  const blob = new Blob([bom + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (comp.name || '比較表') + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// SUUMO検索URL生成
const SUUMO_CITY_CODES = { yokkaichi:'24202', kuwana:'24205', suzuka:'24207', inabe:'24212', kameyama:'24210', komono:'24341', toin:'24343' };
function buildSuumoUrl(areaId, opts = {}) {
  const sc = SUUMO_CITY_CODES[areaId] || '';
  const params = new URLSearchParams({ ar:'060', bs:'030', ta:'24', sc, kb: opts.priceMin || '1', kt: opts.priceMax || '999999', mb: opts.areaMin || '1', mt: opts.areaMax || '999999' });
  if (opts.walkMin) params.set('ek', opts.walkMin);
  return `https://suumo.jp/jj/bukken/ichiran/JJ012FC001/?${params}`;
}
function buildAthomeUrl(areaId, opts = {}) {
  return `https://www.athome.co.jp/tochi/mie/list/?ESSION=true`;
}

// ============================================================
// App State
// ============================================================
const state = {
  savedProperties: [],
  savedComparisons: [],
  soView: null,
  soComparison: null,
  soModalOpen: false,
  soModalType: null,
  soSearchAreaId: null,
  _importUrl: '',
  _aiParsedProperty: null,
  // 一括取り込み用
  _batchUrls: [''],       // URL入力欄の値一覧
  _batchResults: [],      // [{url, status, parsed, error, saved}]
  _batchProcessing: false,
  _batchCurrentIndex: -1,
  // 認証UI
  authModalOpen: false,
  authStep: 'email', // 'email' | 'otp'
  authEmail: '',
  authLoading: false,
  authError: '',
  authUser: null, // { id, email, is_anonymous }
  _pendingSaveCompId: null, // ログイン後に保存する比較表ID
  // マイページ
  userProfile: null,       // { spouse1_name, spouse1_workplace, ..., priorities[], priorities_freetext }
  _profileLoading: false,
  _profileSaved: false,
};

// ============================================================
// Render
// ============================================================
function render() {
  const app = document.getElementById('app');
  const isMyPage = state.soView === 'mypage';
  app.innerHTML = `
    ${renderHeader()}
    <div class="max-w-6xl mx-auto px-4 py-6">
      ${isMyPage ? '' : renderHeroSection()}
      ${renderPropertyView()}
      ${isMyPage ? '' : renderSEOContent()}
      ${isMyPage ? '' : renderFooter()}
      ${renderSOModal()}
      ${renderAuthModal()}
    </div>
  `;
  bindEvents();
}

function renderHeader() {
  const user = state.authUser;
  const loggedIn = user && !user.is_anonymous && user.email;

  const authHtml = loggedIn
    ? `<div class="flex items-center gap-2">
        <button onclick="state.soView='mypage'; loadUserProfile().then(()=>render());" class="px-2 py-1 text-xs font-medium text-purple-700 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors">マイページ</button>
        <span class="text-xs text-gray-500">${user.email}</span>
        <button onclick="handleLogout()" class="text-xs text-gray-400 hover:text-red-500 transition-colors">ログアウト</button>
      </div>`
    : `<button onclick="openAuthModal()" class="px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">ログイン</button>`;

  return `
    <header class="glass border-b border-gray-200">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">🏠 注文住宅 物件比較ツール</h1>
            <p class="text-sm text-gray-500 mt-1">気になる物件をAIで自動整理。複数物件を並べて比較できます</p>
          </div>
          <div class="flex items-center gap-3">
            ${authHtml}
            <a href="area.html" class="hidden sm:block px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors whitespace-nowrap">
              📊 三重県エリア比較 →
            </a>
          </div>
        </div>
      </div>
    </header>
  `;
}

function renderHeroSection() {
  // Only show when no properties saved yet
  if (state.savedProperties.length > 0) return '';
  return `
    <div class="card p-6 mb-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200">
      <h2 class="text-xl font-bold text-gray-800 mb-3">注文住宅の土地選び、こんなお悩みありませんか？</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
        <div class="bg-white/80 rounded-lg p-3 border border-gray-100">
          <div class="text-lg mb-1">😵</div>
          <div class="text-sm text-gray-700">複数サイトの物件情報がバラバラで比較しにくい</div>
        </div>
        <div class="bg-white/80 rounded-lg p-3 border border-gray-100">
          <div class="text-lg mb-1">📝</div>
          <div class="text-sm text-gray-700">Excelにまとめるのが面倒で、結局感覚で選んでしまう</div>
        </div>
        <div class="bg-white/80 rounded-lg p-3 border border-gray-100">
          <div class="text-lg mb-1">❓</div>
          <div class="text-sm text-gray-700">用途地域や建ぺい率など、確認すべき項目がわからない</div>
        </div>
      </div>
      <div class="bg-white rounded-lg p-4 border border-blue-100">
        <h3 class="text-base font-bold text-blue-800 mb-3">このツールが解決します</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="flex items-start gap-2">
            <span class="text-lg">🤖</span>
            <div>
              <div class="text-sm font-medium text-gray-800">AI自動整理</div>
              <div class="text-xs text-gray-500">URLを貼るだけでAIが物件情報を自動抽出</div>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <span class="text-lg">📋</span>
            <div>
              <div class="text-sm font-medium text-gray-800">一覧で比較</div>
              <div class="text-xs text-gray-500">SUUMO・アットホーム等を統一フォーマットで比較</div>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <span class="text-lg">💡</span>
            <div>
              <div class="text-sm font-medium text-gray-800">AI注意点指摘</div>
              <div class="text-xs text-gray-500">比較表をAIが分析し注意点やおすすめを指摘</div>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
        <p class="text-sm text-amber-800 font-medium">📖 使い方はかんたん3ステップ</p>
        <div class="flex flex-col sm:flex-row gap-2 mt-2">
          <div class="flex items-center gap-2 text-sm text-gray-700"><span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">1</span>物件URLを貼り付け</div>
          <div class="hidden sm:block text-gray-300">→</div>
          <div class="flex items-center gap-2 text-sm text-gray-700"><span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">2</span>AIが自動で整理</div>
          <div class="hidden sm:block text-gray-300">→</div>
          <div class="flex items-center gap-2 text-sm text-gray-700"><span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">3</span>比較表を作成</div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Property View
// ============================================================
function renderMyPage() {
  const p = state.userProfile || {};
  const selectedPriorities = p.priorities || [];
  const loading = state._profileLoading;
  const saved = state._profileSaved;

  const priorityCheckboxes = PRIORITY_OPTIONS.map(opt => {
    const checked = selectedPriorities.includes(opt.key) ? 'checked' : '';
    return `<label class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer select-none">
      <input type="checkbox" name="priority" value="${opt.key}" ${checked} class="rounded border-gray-300 text-purple-600 focus:ring-purple-500" style="width:18px;height:18px;">
      <span class="text-sm text-gray-700">${opt.label}</span>
    </label>`;
  }).join('');

  return `
    <div class="space-y-6">
      <button onclick="state.soView=null; render();" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
        &larr; 物件リストに戻る
      </button>

      <div class="card p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-6">マイページ</h2>
        <p class="text-sm text-gray-500 mb-6">勤務先と重視項目を登録すると、比較表に「ライフスタイル」スコアが追加されます。</p>

        <form id="mypage-form" onsubmit="event.preventDefault(); handleSaveProfile();">
          <!-- 上部保存ボタン -->
          <div class="flex items-center gap-4 mb-6 pb-4 border-b border-gray-200">
            <button type="submit" ${loading ? 'disabled' : ''} class="px-8 py-3 bg-purple-600 text-white rounded-lg font-bold text-base hover:bg-purple-700 transition-colors disabled:opacity-50 shadow-lg">
              ${loading ? '⏳ 保存中...' : '💾 保存する'}
            </button>
            ${saved ? '<span class="text-sm text-green-600 font-medium">✅ 保存しました</span>' : ''}
          </div>
          <!-- 勤務先情報 -->
          <div class="mb-8">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold">勤務先情報</span>
              通勤距離からスコアを算出します
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-600">配偶者 1</div>
                <div>
                  <label class="text-xs text-gray-500">お名前（任意）</label>
                  <input type="text" id="spouse1_name" value="${p.spouse1_name || ''}" placeholder="例: 太郎" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                  <label class="text-xs text-gray-500">勤務先の住所</label>
                  <input type="text" id="spouse1_workplace" value="${p.spouse1_workplace || ''}" placeholder="例: 三重県四日市市諏訪町1-5" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                ${p.spouse1_lat ? `<div class="text-xs text-green-600">座標取得済み</div>` : ''}
              </div>
              <div class="space-y-3 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-600">配偶者 2</div>
                <div>
                  <label class="text-xs text-gray-500">お名前（任意）</label>
                  <input type="text" id="spouse2_name" value="${p.spouse2_name || ''}" placeholder="例: 花子" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                  <label class="text-xs text-gray-500">勤務先の住所</label>
                  <input type="text" id="spouse2_workplace" value="${p.spouse2_workplace || ''}" placeholder="例: 三重県津市栄町1-891" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                ${p.spouse2_lat ? `<div class="text-xs text-green-600">座標取得済み</div>` : ''}
              </div>
            </div>
          </div>

          <!-- 重視項目 -->
          <div class="mb-8">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs font-bold">重視項目</span>
              土地に求める条件を選んでください
            </h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-1">
              ${priorityCheckboxes}
            </div>
            <div class="mt-4">
              <label class="text-xs text-gray-500">その他・自由記述</label>
              <textarea id="priorities_freetext" rows="2" placeholder="上記以外に重視することがあれば記入してください" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">${p.priorities_freetext || ''}</textarea>
            </div>
          </div>

          <!-- 保存ボタン -->
          <div class="flex items-center gap-4 pt-4 border-t border-gray-200">
            <button type="submit" ${loading ? 'disabled' : ''} class="px-8 py-3 bg-purple-600 text-white rounded-lg font-bold text-base hover:bg-purple-700 transition-colors disabled:opacity-50 shadow-lg">
              ${loading ? '⏳ 保存中...' : '💾 保存する'}
            </button>
            ${saved ? '<span class="text-sm text-green-600 font-medium animate-pulse">✅ 保存しました</span>' : ''}
          </div>
          <p class="text-xs text-gray-400 mt-3">登録した内容は比較表の「🏡 ライフスタイル」スコアに反映されます</p>
        </form>
      </div>
    </div>
  `;
}

function handleSaveProfile() {
  const form = document.getElementById('mypage-form');
  if (!form) return;
  const checkedPriorities = Array.from(form.querySelectorAll('input[name="priority"]:checked')).map(el => el.value);
  const profileData = {
    spouse1_name: document.getElementById('spouse1_name')?.value?.trim() || null,
    spouse1_workplace: document.getElementById('spouse1_workplace')?.value?.trim() || null,
    spouse2_name: document.getElementById('spouse2_name')?.value?.trim() || null,
    spouse2_workplace: document.getElementById('spouse2_workplace')?.value?.trim() || null,
    priorities: checkedPriorities,
    priorities_freetext: document.getElementById('priorities_freetext')?.value?.trim() || null,
  };
  saveUserProfile(profileData);
}

function renderPropertyView() {
  // マイページ
  if (state.soView === 'mypage') {
    return renderMyPage();
  }

  const savedCount = state.savedProperties.length;
  const compProps = state.savedProperties.filter(p => p.in_comparison);

  // Sub-view: comparison table with sidebar
  if (state.soView === 'compare' && state.soComparison) {
    return renderComparisonWithSidebar();
  }

  const hasSavedComps = state.savedComparisons.length > 0;

  const mainContent = `
    <div class="space-y-4">
      <!-- サイト説明セクション -->
      <div class="card p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200">
        <h2 class="text-lg font-bold text-gray-800 mb-3">📊 物件比較ツールとは？</h2>
        <p class="text-sm text-gray-700 leading-relaxed mb-4">
          気になる物件の情報をAIが自動で整理・構造化。複数の物件を並べて比較し、最適な土地選びをサポートします。
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="bg-white/80 rounded-lg p-3 border border-blue-100">
            <div class="text-lg mb-1">🤖</div>
            <div class="text-sm font-medium text-gray-800 mb-1">AI自動整理</div>
            <div class="text-xs text-gray-500">物件URLやテキストを貼るだけで、AIが価格・面積・立地など重要項目を自動で抽出・整理します</div>
          </div>
          <div class="bg-white/80 rounded-lg p-3 border border-blue-100">
            <div class="text-lg mb-1">📋</div>
            <div class="text-sm font-medium text-gray-800 mb-1">一覧で比較</div>
            <div class="text-xs text-gray-500">SUUMO・アットホーム等の複数サイトの物件を統一フォーマットで一覧比較。見落としを防ぎます</div>
          </div>
          <div class="bg-white/80 rounded-lg p-3 border border-blue-100">
            <div class="text-lg mb-1">💡</div>
            <div class="text-sm font-medium text-gray-800 mb-1">AIが注意点を指摘</div>
            <div class="text-xs text-gray-500">比較表をAIが分析し、各物件の注意点やおすすめポイントをコメント。判断材料が増えます</div>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-800">🏠 保存した物件${savedCount > 0 ? `（${savedCount}件）` : ''}</h2>
        ${savedCount > 0 ? `<div class="flex gap-2">
          <button onclick="clearAllProperties()" class="text-xs text-gray-400 hover:text-red-500 transition-colors">全件削除</button>
        </div>` : ''}
      </div>

      <!-- 物件取り込みセクション（常に表示） -->
      <div class="card p-5 space-y-3 border-green-200 bg-green-50/30">
        <h3 class="text-sm font-bold text-gray-700">🤖 物件情報をAIで取り込み</h3>
        <p class="text-xs text-gray-500">不動産サイトの物件ページURLを貼り付けてAI取り込み。<span class="text-green-600 font-medium">複数件まとめて取り込みOK！</span></p>
        <div class="flex gap-2">
          <input id="url-import-property" type="url" placeholder="物件URLを貼り付け（https://suumo.jp/...）" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" />
          <button onclick="openImportModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors whitespace-nowrap">
            🤖 AI取り込み
          </button>
        </div>
      </div>

      ${savedCount === 0 ? `
        <div class="card p-8 text-center">
          <div class="text-4xl mb-3">🏠</div>
          <p class="text-gray-600 font-medium mb-2">まだ物件が保存されていません</p>
          <p class="text-sm text-gray-400">上のフォームから物件URLやテキストを取り込んで<br>保存・比較できます</p>
        </div>
      ` : `
        <div class="grid grid-cols-1 gap-3">
          ${state.savedProperties.map(prop => {
            const badgeClass = prop.badge === 'red' ? 'so-badge-red' : prop.badge === 'yellow' ? 'so-badge-yellow' : 'so-badge-none';
            const badgeLabel = prop.badge === 'red' ? '🔴 注意' : prop.badge === 'yellow' ? '🟡 要確認' : '🟢 OK';
            const areaName = AREAS.find(a => a.id === prop.area_id)?.name || (prop.address ? AREAS.find(a => prop.address.includes(a.name))?.name : '') || '';
            const priceStr = prop.price ? `${(prop.price / 10000).toLocaleString()}万円` : '価格未入力';
            const tsuboPriceStr = (prop.price && prop.land_area) ? `（坪${(prop.price / (prop.land_area / 3.305785) / 10000).toFixed(1)}万）` : '';
            const areaStr = prop.land_area ? `${(prop.land_area / 3.305785).toFixed(1)}坪（${prop.land_area}㎡）` : '面積未入力';
            // 位置精度バッジ
            const geoConf = prop.geo_confidence;
            const geoBadge = geoConf === 'high' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#dcfce7;color:#166534;border:1px solid #86efac;">📍 高精度</span>'
              : geoConf === 'medium' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fef9c3;color:#854d0e;border:1px solid #fde047;">📍 中精度</span>'
              : geoConf === 'low' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;">📍 低精度</span>'
              : '';
            const mapLink = (prop.lat && prop.lng) ? `<a href="https://www.google.com/maps?q=${prop.lat},${prop.lng}" target="_blank" rel="noopener" class="text-xs text-green-600 hover:underline">🗺️ 地図で確認</a>` : '';
            // enrichmentステータス
            const enrichBadge = prop.enrichment_status === 'done' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#dbeafe;color:#1e40af;border:1px solid #93c5fd;">✅ 詳細情報あり</span>'
              : prop.enrichment_status === 'pending' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fef3c7;color:#92400e;border:1px solid #fbbf24;">⏳ 詳細取得中</span>'
              : prop.enrichment_status === 'error' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;">❌ 取得失敗</span>'
              : '';
            // enrichmentボタン表示条件
            const canEnrich = prop.lat && prop.lng && !prop.enrichment_status;
            const canRetryEnrich = prop.lat && prop.lng && prop.enrichment_status === 'error';
            // enrichment詳細表示 + スコア
            const enrichDetails = prop.enrichment_status === 'done' ? (() => {
              const scores = calculateScores(prop, state.userProfile);
              const lifestyleBar = scores && scores.score_lifestyle != null ? renderScoreBar('ライフ', scores.score_lifestyle) : '';
              const scoreSection = scores ? '<div class="grid grid-cols-2 gap-1 mb-2">' +
                renderScoreBar('安全', scores.score_safety) +
                renderScoreBar('利便', scores.score_convenience) +
                renderScoreBar('コスト', scores.score_cost) +
                lifestyleBar +
                '<div class="flex items-center gap-2 text-xs"><span class="text-gray-500 w-12">総合</span><div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden"><div class="h-full rounded-full" style="width:' + scores.score_total + '%;background:' + getScoreColor(scores.score_total) + ';"></div></div><span class="font-bold" style="color:' + getScoreColor(scores.score_total) + ';">' + scores.score_total + '</span></div>' +
                '</div>' : '';
              const items = [];
              if (prop.school_elementary) items.push('🏫 ' + prop.school_elementary);
              if (prop.school_junior_high) items.push('🏫 ' + prop.school_junior_high);
              if (prop.nearest_supermarket) items.push('🛒 ' + prop.nearest_supermarket);
              if (prop.nearest_hospital) items.push('🏥 ' + prop.nearest_hospital);
              if (prop.nearest_park) items.push('🌳 ' + prop.nearest_park);
              if (prop.hazard_flood) items.push('🌊 洪水: ' + prop.hazard_flood);
              if (prop.hazard_sediment) items.push('⛰️ 土砂: ' + prop.hazard_sediment);
              if (prop.ground_type) items.push('🪨 地盤: ' + prop.ground_type);
              if (prop.ai_comment) items.push('💬 ' + prop.ai_comment);
              // 追加コスト要因の表示
              const costReasonHtml = (prop.extra_cost_reasons && prop.extra_cost_score != null && prop.extra_cost_score < 0)
                ? '<div class="mt-1 p-1.5 bg-amber-50 rounded border border-amber-200">' +
                  '<div class="text-xs font-medium text-amber-800 mb-0.5">💰 追加コスト要因（' + Math.abs(prop.extra_cost_score) + '点減点）</div>' +
                  '<div class="text-xs text-amber-700">' + prop.extra_cost_reasons.split('、').map(r => '・' + r.trim()).join('<br>') + '</div>' +
                  '</div>' : '';
              return (scoreSection || items.length > 0 || costReasonHtml) ? '<div class="mt-2 p-2 bg-blue-50 rounded border border-blue-100 space-y-1">' +
                scoreSection +
                items.map(i => '<div class="text-xs text-gray-600">' + i + '</div>').join('') +
                costReasonHtml +
                '</div>' : '';
            })() : '';
            return `
              <div class="card p-4">
                <div class="flex items-start justify-between">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                      <span class="${badgeClass}" style="font-size:11px;padding:2px 8px;border-radius:9999px;">${badgeLabel}</span>
                      ${geoBadge}
                      ${enrichBadge}
                      ${areaName ? `<span class="text-xs text-gray-400">${areaName}</span>` : ''}
                    </div>
                    <div class="text-sm font-medium text-gray-800">${prop.address || '住所未入力'}</div>
                    <div class="flex items-center gap-3 mt-1 text-sm">
                      <span class="font-bold text-blue-700">${priceStr}</span><span class="text-xs text-gray-400">${tsuboPriceStr}</span>
                      <span class="text-gray-500">${areaStr}</span>
                    </div>
                    ${prop.station_distance ? `<div class="text-xs text-gray-400 mt-1">🚃 ${prop.station_distance}</div>` : ''}
                    ${prop.user_memo ? `<div class="text-xs text-gray-500 mt-1 bg-green-50 rounded px-2 py-1">📝 ${prop.user_memo}</div>` : (prop.memo ? `<div class="text-xs text-gray-500 mt-1 bg-gray-50 rounded px-2 py-1">💡 ${prop.memo}</div>` : '')}
                    <div class="flex items-center gap-3 mt-1">
                      ${prop.url ? `<a href="${prop.url}" target="_blank" rel="noopener" class="text-xs text-blue-500 hover:underline">🔗 物件ページ</a>` : ''}
                      ${mapLink}
                    </div>
                    ${enrichDetails}
                  </div>
                  <div class="flex flex-col gap-1 ml-3">
                    <button onclick="handleToggleComparison('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border transition-colors ${prop.in_comparison ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-600 border-gray-300 hover:bg-blue-50'}">
                      ${prop.in_comparison ? '✓ 比較中' : '比較に追加'}
                    </button>
                    ${canEnrich || canRetryEnrich ? `<button onclick="handleEnrichProperty('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border border-purple-200 text-purple-600 hover:bg-purple-50 transition-colors">🔍 詳細取得</button>` : ''}
                    <button onclick="handleDeleteProperty('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border border-gray-200 text-gray-400 hover:text-red-500 hover:border-red-300 transition-colors">削除</button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        ${compProps.length > 0 ? `
          <div class="card p-4 bg-blue-50 border-blue-200">
            <div class="flex items-center justify-between">
              <div>
                <span class="text-sm font-medium text-blue-800">📊 比較に追加: ${compProps.length}件</span>
                <span class="text-xs text-blue-500 ml-2">${compProps.length < 2 ? '（2件以上で比較可能）' : ''}</span>
              </div>
              <button onclick="handleGenerateComparison()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors ${compProps.length < 2 ? 'opacity-50 cursor-not-allowed' : ''}" ${compProps.length < 2 ? 'disabled' : ''}>
                比較表を作成
              </button>
            </div>
          </div>
        ` : ''}
      `}
    </div>
  `;

  // サイドバーあり（過去の比較表がある場合）
  if (hasSavedComps) {
    return `
      <div class="flex gap-4 fade-in comp-layout-sidebar">
        ${renderComparisonSidebar()}
        <div class="flex-1 min-w-0">${mainContent}</div>
      </div>
    `;
  }
  // サイドバーなし
  return `<div class="fade-in">${mainContent}</div>`;
}

// ============================================================
// Second Opinion: Comparison Table
// ============================================================
function renderComparisonSidebar() {
  const comps = state.savedComparisons;
  const currentId = state.soComparison?.id;
  const isCompareView = state.soView === 'compare' && state.soComparison;

  return `
    <div class="flex-shrink-0" style="width:220px;">
      <div class="card p-3 sticky" style="top:1rem;">
        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">📂 比較表一覧</h3>
        ${isCompareView ? `
          <button onclick="state.soView=null; state.soComparison=null; render();" class="w-full mb-3 px-3 py-2 text-xs bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors text-left">
            ← 物件リストに戻る
          </button>
        ` : ''}
        <div class="space-y-1 max-h-96 overflow-y-auto">
          ${comps.length === 0 ? `<p class="text-xs text-gray-400 py-2">比較表を作成すると<br>ここに一覧表示されます</p>` : ''}
          ${comps.map(c => {
            const isActive = isCompareView && c.id === currentId;
            const dateStr = c.created_at ? new Date(c.created_at).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }) : '';
            return `
              <div class="group rounded-lg p-2 cursor-pointer transition-colors ${isActive ? 'bg-blue-50 border border-blue-200' : 'hover:bg-gray-50 border border-transparent'}" onclick="loadComparisonDetail('${c.id}')">
                <div class="flex items-start justify-between gap-1">
                  <div class="flex-1 min-w-0">
                    <div class="text-xs font-medium ${isActive ? 'text-blue-700' : 'text-gray-700'} truncate">${c.name || '比較表'}</div>
                    <div class="text-xs text-gray-400">${dateStr} · ${(c.property_ids||[]).length}件</div>
                  </div>
                  <button onclick="event.stopPropagation(); handleDeleteComparison('${c.id}')" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 text-xs transition-opacity" title="削除">✕</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

function renderComparisonWithSidebar() {
  return `
    <div class="flex gap-4 fade-in comp-layout-sidebar" style="min-height:60vh;">
      ${renderComparisonSidebar()}
      <div class="flex-1 min-w-0">
        ${renderComparisonTable()}
      </div>
    </div>
  `;
}

function renderComparisonTable() {
  const comp = state.soComparison;
  if (!comp) return '';
  const props = comp.properties || [];
  if (props.length === 0) return '';

  const labels = ['A','B','C','D','E'];

  // editable=true のセルはクリックで編集可能（テキスト型）
  // editable='number' は万円単位の数値入力
  const rows = [
    { label: '価格', key: 'price', fmt: v => v ? `${(v/10000).toLocaleString()}万円` : '—', editable: 'price' },
    { label: '土地面積', key: 'land_area', fmt: v => v ? `${(v/3.305785).toFixed(1)}坪（${v}㎡）` : '—', editable: 'area' },
    { label: '坪単価', key: '_tsubo', fmt: (v, p) => p.price && p.land_area ? `${(p.price / (p.land_area / 3.305785) / 10000).toFixed(1)}万円/坪` : '—' },
    { label: '所在地', key: 'address', fmt: v => v || '—', editable: true },
    { label: '駅距離', key: 'station_distance', fmt: v => v || '—', editable: true },
  ];
  const checkRows = [
    { label: '用途地域', key: 'zoning', editable: true },
    { label: '建ぺい率', key: 'building_coverage', editable: true },
    { label: '容積率', key: 'floor_area_ratio', editable: true },
    { label: '接道', key: 'road_access', editable: true },
    { label: '高低差/造成', key: 'elevation', editable: true },
    { label: 'インフラ', key: 'infrastructure', editable: true },
    { label: 'ハザード', key: 'hazard', editable: true },
  ];

  function editableCell(prop, key, displayVal, editType) {
    const propId = prop.id;
    const escaped = (typeof displayVal === 'string' ? displayVal : String(displayVal || '')).replace(/"/g, '&quot;');
    const editHint = editType ? ' title="クリックして編集" style="cursor:pointer;border-bottom:1px dashed #cbd5e1;"' : '';
    if (!editType) return `<td class="p-3 text-sm text-gray-800">${displayVal}</td>`;
    return `<td class="p-3 text-sm text-gray-800 hover:bg-blue-50 transition-colors" onclick="startCellEdit(this, '${propId}', '${key}', '${editType}')"${editHint}>${displayVal}<span class="text-gray-300 text-xs ml-1">✏️</span></td>`;
  }

  let questions = [];
  try { questions = typeof comp.questions === 'string' ? JSON.parse(comp.questions) : (comp.questions || []); } catch(e) { questions = []; }
  if (typeof questions === 'string') questions = questions.split('\n').filter(q => q.trim());

  return `
    <div class="space-y-4 fade-in">
      <div class="flex items-center gap-3 flex-wrap">
        <h2 class="text-lg font-bold text-gray-800">📊</h2>
        <span id="comp-name-display" class="text-lg font-bold text-gray-800 cursor-pointer hover:text-blue-600 border-b border-dashed border-gray-300" onclick="startCompNameEdit()" title="クリックして名前を変更">${comp.name || '比較表'}</span>
        <span class="text-xs text-gray-400">（セルをクリックして編集可能）</span>
        <button onclick="exportComparisonCSV()" class="ml-auto px-3 py-1 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 transition-colors">📥 CSV出力</button>
      </div>

      ${comp.summary ? `
        <div class="card p-4 bg-blue-50 border-blue-200">
          <h3 class="text-sm font-bold text-blue-800 mb-2">💡 AIサマリ</h3>
          <p class="text-sm text-gray-700 leading-relaxed">${comp.summary}</p>
        </div>
      ` : ''}

      ${comp._unsaved ? `
        <div class="card p-4 bg-green-50 border-green-200" style="border:1px solid #86efac;">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <span class="text-sm font-bold text-green-800">この比較表を保存しますか？</span>
              <p class="text-xs text-green-600 mt-0.5">ユーザー登録すると、次回以降もこの比較表を確認できます</p>
            </div>
            <button onclick="openAuthModal(); state._pendingSaveCompId='${comp.id}';" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
              ユーザー登録して保存
            </button>
          </div>
        </div>
      ` : ''}

      <div class="card overflow-x-auto">
        <table class="so-compare-table">
          <thead>
            <tr>
              <th class="text-left p-3 bg-gray-50 text-xs text-gray-500 font-medium" style="min-width:80px;"></th>
              ${props.map((p,i) => `
                <th class="p-3 bg-gray-50 text-sm font-bold text-gray-800" style="min-width:140px;">
                  物件${labels[i]}<br><span class="text-xs font-normal text-gray-400">${AREAS.find(a=>a.id===p.area_id)?.name || (p.address ? AREAS.find(a=>p.address.includes(a.name))?.name : '') || ''}</span>
                  ${p.url ? `<br><a href="${p.url}" target="_blank" rel="noopener" class="text-xs text-blue-500 font-normal hover:underline">🔗 物件ページ</a>` : ''}
                </th>
              `).join('')}
            </tr>
          </thead>
          <tbody>
            ${(() => {
              if (!props.some(p => p.enrichment_status === 'done')) return '';
              const allScores = props.map(p => calculateScores(p, state.userProfile));
              const maxTotal = Math.max(...allScores.map(s => s ? s.score_total : 0));
              const hasLifestyle = allScores.some(s => s && s.score_lifestyle !== null);
              const scoreKeys = ['score_safety','score_convenience','score_cost'];
              if (hasLifestyle) scoreKeys.push('score_lifestyle');
              const labelMap = {score_safety:'🛡️ 安全', score_convenience:'🏪 利便', score_cost:'💰 コスト', score_lifestyle:'🏡 ライフ'};
              const scoreRows = scoreKeys.map(key => {
                const maxCat = Math.max(...allScores.map(s => s && s[key] != null ? s[key] : 0));
                return '<tr>' +
                  '<td class="p-2 text-xs font-medium text-gray-500 bg-gray-50">' + labelMap[key] + '</td>' +
                  props.map((p, i) => {
                    const s = allScores[i];
                    if (!s || s[key] == null) return '<td class="p-2 text-center text-xs text-gray-300">—</td>';
                    const v = s[key];
                    const color = getScoreColor(v);
                    const isBest = v === maxCat && maxCat > 0;
                    return '<td class="p-2 text-center">' +
                      '<div style="display:inline-flex;align-items:center;gap:4px;">' +
                      '<div style="width:50px;height:6px;background:#e5e7eb;border-radius:9999px;overflow:hidden;"><div style="height:100%;border-radius:9999px;width:' + v + '%;background:' + color + ';"></div></div>' +
                      '<span class="text-xs font-semibold" style="color:' + color + ';">' + v + '</span>' +
                      (isBest ? '<span style="font-size:9px;">★</span>' : '') +
                      '</div></td>';
                  }).join('') + '</tr>';
              }).join('');
              const lifestyleBadge = hasLifestyle ? '<span class="text-xs text-purple-500 ml-2">🏡 ライフスタイルスコアあり</span>' : '';
              return '<tr><td colspan="' + (props.length + 1) + '" class="p-2 bg-purple-50"><span class="text-xs font-bold text-purple-700">📈 スコア比較</span>' + lifestyleBadge + '</td></tr>' +
                '<tr style="border-bottom:2px solid #e5e7eb;">' +
                '<td class="p-2 text-xs font-bold text-gray-600 bg-gray-50">総合</td>' +
                props.map((p, i) => {
                  const s = allScores[i];
                  if (!s) return '<td class="p-2 text-center text-xs text-gray-300">—</td>';
                  const isBest = s.score_total === maxTotal && maxTotal > 0;
                  return '<td class="p-2 text-center">' +
                    '<div style="text-align:center;font-size:1.5rem;font-weight:900;color:' + getScoreColor(s.score_total) + ';">' + s.score_total +
                    (isBest ? '<span style="font-size:0.75rem;margin-left:2px;">👑</span>' : '') + '</div></td>';
                }).join('') + '</tr>' + scoreRows;
            })()}
            ${rows.map(r => `
              <tr>
                <td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">${r.label}</td>
                ${props.map(p => editableCell(p, r.key, r.fmt(p[r.key], p), r.editable)).join('')}
              </tr>
            `).join('')}
            ${props.some(p => p.ai_comment) ? `
            <tr>
              <td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">💬 AIコメント</td>
              ${props.map(p => `<td class="p-3 text-xs text-gray-700">${p.ai_comment || '<span class="text-gray-300">—</span>'}</td>`).join('')}
            </tr>
            ` : ''}
            <tr><td colspan="${props.length+1}" class="p-2 bg-amber-50"><span class="text-xs font-bold text-amber-700">⚠️ 重要確認項目（不動産屋に確認）</span></td></tr>
            ${checkRows.map(r => `
              <tr>
                <td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">${r.label}</td>
                ${props.map(p => {
                  const val = p[r.key];
                  const display = val ? val : '🟡 不明';
                  const cls = val ? 'text-gray-800' : 'text-amber-600';
                  return `<td class="p-3 text-sm ${cls} hover:bg-blue-50 transition-colors" onclick="startCellEdit(this, '${p.id}', '${r.key}', true)" title="クリックして編集" style="cursor:pointer;border-bottom:1px dashed #cbd5e1;">${display}<span class="text-gray-300 text-xs ml-1">✏️</span></td>`;
                }).join('')}
              </tr>
            `).join('')}
            <!-- AI詳細情報（enrichment） -->
            ${props.some(p => p.enrichment_status === 'done') || props.some(p => p.lat && p.lng) ? `
              <tr><td colspan="${props.length+1}" class="p-2 bg-blue-50"><span class="text-xs font-bold text-blue-700">🔍 AI自動取得情報（周辺環境・ハザード）</span></td></tr>
              ${[
                { label: '小学校区', key: 'school_elementary' },
                { label: '中学校区', key: 'school_junior_high' },
                { label: '最寄スーパー', key: 'nearest_supermarket' },
                { label: '最寄病院', key: 'nearest_hospital' },
                { label: '最寄公園', key: 'nearest_park' },
                { label: '最寄保育園', key: 'nearest_nursery' },
                { label: '洪水リスク', key: 'hazard_flood' },
                { label: '土砂災害', key: 'hazard_sediment' },
                { label: '津波リスク', key: 'hazard_tsunami' },
                { label: '地盤', key: 'ground_type' },
              ].map(r => {
                return '<tr><td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">' + r.label + '</td>' +
                  props.map(p => {
                    const val = p[r.key];
                    if (p.enrichment_status === 'done') {
                      return '<td class="p-3 text-xs text-gray-700">' + (val || '<span class="text-gray-300">\u2014</span>') + '</td>';
                    } else if (p.enrichment_status === 'pending') {
                      return '<td class="p-3 text-xs text-amber-500">\u23f3 取得中...</td>';
                    } else if (p.lat && p.lng) {
                      return '<td class="p-3 text-xs"><button onclick="handleEnrichProperty(' + "'" + p.id + "'" + ')" class="text-blue-500 hover:underline text-xs">\ud83d\udd0d 取得する</button></td>';
                    } else {
                      return '<td class="p-3 text-xs text-gray-300">位置情報なし</td>';
                    }
                  }).join('') + '</tr>';
              }).join('')}
            ` : ''}
            <!-- メモ行 -->
            <tr><td colspan="${props.length+1}" class="p-2 bg-green-50"><span class="text-xs font-bold text-green-700">📝 メモ（自由入力）</span></td></tr>
            <tr>
              <td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">メモ</td>
              ${props.map(p => `
                <td class="p-2">
                  <textarea class="w-full px-2 py-1 border border-gray-200 rounded text-sm text-gray-700 focus:border-blue-400 focus:ring-1 focus:ring-blue-200 outline-none" rows="3" placeholder="自由にメモを入力..." onblur="handleMemoEdit('${p.id}', this.value)" style="resize:vertical;">${p.user_memo || p.memo || ''}</textarea>
                </td>
              `).join('')}
            </tr>
          </tbody>
        </table>
      </div>

      ${questions.length > 0 ? `
        <div class="card p-4">
          <h3 class="text-sm font-bold text-gray-800 mb-3">📋 確認質問テンプレート</h3>
          <div class="space-y-2">
            ${questions.map((q,i) => `
              <label class="flex items-start gap-2 text-sm text-gray-700">
                <input type="checkbox" class="mt-1 so-question-check" />
                <span>${typeof q === 'object' ? q.text || q.question || JSON.stringify(q) : q}</span>
              </label>
            `).join('')}
          </div>
          <button onclick="copyQuestions()" class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition-colors">📋 質問をコピー</button>
        </div>
      ` : ''}
    </div>
  `;
}

function copyQuestions() {
  const checks = document.querySelectorAll('.so-question-check');
  const texts = [];
  checks.forEach((cb, i) => {
    const label = cb.parentElement?.querySelector('span')?.textContent;
    if (label) texts.push(`${cb.checked ? '✅' : '□'} ${label}`);
  });
  if (texts.length === 0) return;
  navigator.clipboard.writeText(texts.join('\n')).then(() => alert('質問をクリップボードにコピーしました'));
}

// 比較表の名前編集
function startCompNameEdit() {
  const el = document.getElementById('comp-name-display');
  if (!el || !state.soComparison) return;
  const current = state.soComparison.name || '比較表';
  el.outerHTML = `<input id="comp-name-input" type="text" value="${current.replace(/"/g, '&quot;')}" class="text-lg font-bold text-gray-800 border border-blue-300 rounded px-2 py-0.5 focus:ring-2 focus:ring-blue-200 outline-none" style="max-width:250px;" />`;
  const input = document.getElementById('comp-name-input');
  if (input) {
    input.focus();
    input.select();
    input.onblur = () => finishCompNameEdit(input.value);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') render(); };
  }
}

async function finishCompNameEdit(newName) {
  const trimmed = (newName || '').trim() || '比較表';
  if (state.soComparison) {
    state.soComparison.name = trimmed;
    if (state.soComparison.id) await renameComparison(state.soComparison.id, trimmed);
  }
  render();
}

async function handleDeleteComparison(compId) {
  if (!confirm('この比較表を削除しますか？')) return;
  await deleteComparison(compId);
  render();
}

// セル編集: クリック → inline input
function startCellEdit(td, propId, key, editType) {
  if (td.querySelector('input,textarea')) return; // 既に編集中
  const prop = state.savedProperties.find(p => p.id === propId);
  if (!prop) return;

  const currentVal = prop[key];
  td.innerHTML = '';

  if (editType === 'price') {
    // 万円 → 円で保存されているので万円で表示・入力
    const input = document.createElement('input');
    input.type = 'number';
    input.className = 'w-full px-2 py-1 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none';
    input.value = currentVal ? currentVal / 10000 : '';
    input.placeholder = '万円';
    input.focus();
    input.onblur = () => finishCellEdit(propId, key, input.value ? Number(input.value) * 10000 : null);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { render(); } };
    td.appendChild(input);
    setTimeout(() => input.focus(), 0);
  } else if (editType === 'area') {
    // ㎡で保存
    const input = document.createElement('input');
    input.type = 'number';
    input.step = '0.1';
    input.className = 'w-full px-2 py-1 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none';
    input.value = currentVal || '';
    input.placeholder = '㎡';
    input.onblur = () => finishCellEdit(propId, key, input.value ? Number(input.value) : null);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { render(); } };
    td.appendChild(input);
    setTimeout(() => input.focus(), 0);
  } else {
    // テキスト入力
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'w-full px-2 py-1 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none';
    input.value = currentVal || '';
    input.onblur = () => finishCellEdit(propId, key, input.value.trim() || null);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { render(); } };
    td.appendChild(input);
    setTimeout(() => input.focus(), 0);
  }
}

async function finishCellEdit(propId, key, newVal) {
  const prop = state.savedProperties.find(p => p.id === propId);
  if (!prop) return;
  if (prop[key] === newVal) { render(); return; }
  // comparison内のpropsも同期
  if (state.soComparison?.properties) {
    const cp = state.soComparison.properties.find(p => p.id === propId);
    if (cp) cp[key] = newVal;
  }
  await updateProperty(propId, { [key]: newVal });
  render();
}

async function handleMemoEdit(propId, value) {
  const trimmed = value.trim();
  const prop = state.savedProperties.find(p => p.id === propId);
  if (!prop) return;
  if ((prop.user_memo || '') === trimmed) return;
  if (state.soComparison?.properties) {
    const cp = state.soComparison.properties.find(p => p.id === propId);
    if (cp) cp.user_memo = trimmed;
  }
  await updateProperty(propId, { user_memo: trimmed });
}

// ============================================================
// Modals (Import)
// ============================================================
function renderAuthModal() {
  if (!state.authModalOpen) return '';

  const isOtpStep = state.authStep === 'otp';
  const isLinkSent = state.authStep === 'link_sent';
  const loading = state.authLoading;

  return `
    <div class="so-modal-overlay" onclick="if(event.target===this){state.authModalOpen=false;render();}">
      <div class="so-modal" style="max-width:400px;">
        ${isLinkSent ? `
          <h2 class="text-lg font-bold text-gray-900 mb-1">確認メールを送信しました</h2>
          <p class="text-sm text-gray-500 mb-4"><span class="font-medium text-gray-700">${state.authEmail}</span> に確認メールを送信しました。</p>
          <div class="p-4 bg-blue-50 rounded-lg mb-4">
            <p class="text-sm text-blue-800">メール内のリンクをクリックして、アカウント登録を完了してください。</p>
            <p class="text-xs text-blue-600 mt-2">クリック後、このページに戻るとログイン状態になります。</p>
          </div>
          <button onclick="state.authModalOpen=false;render();" class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
            閉じる
          </button>
        ` : isOtpStep ? `
          <h2 class="text-lg font-bold text-gray-900 mb-1">認証コードを入力</h2>
          <p class="text-sm text-gray-500 mb-4"><span class="font-medium text-gray-700">${state.authEmail}</span> に6桁のコードを送信しました</p>
          ${state.authError ? `<p class="text-sm text-red-600 mb-3">${state.authError}</p>` : ''}
          <input id="auth-otp-input" type="text" inputmode="numeric" maxlength="6" placeholder="000000"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-2xl font-bold tracking-widest focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
            ${loading ? 'disabled' : ''}>
          <button onclick="handleAuthVerify()" class="w-full mt-4 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors ${loading ? 'opacity-50 cursor-not-allowed' : ''}" ${loading ? 'disabled' : ''}>
            ${loading ? '確認中...' : 'ログイン'}
          </button>
          <button onclick="state.authStep='email';state.authError='';render();" class="w-full mt-2 px-4 py-2 text-sm text-gray-500 hover:text-gray-700 transition-colors">
            ← メールアドレスを変更
          </button>
        ` : `
          <h2 class="text-lg font-bold text-gray-900 mb-1">ログイン / アカウント登録</h2>
          <p class="text-sm text-gray-500 mb-4">メールアドレスを入力してください。パスワードは不要です。</p>
          ${state.authError ? `<p class="text-sm text-red-600 mb-3">${state.authError}</p>` : ''}
          <input id="auth-email-input" type="email" placeholder="example@mail.com"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
            value="${state.authEmail}" ${loading ? 'disabled' : ''}>
          <button onclick="handleAuthSendOtp()" class="w-full mt-4 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors ${loading ? 'opacity-50 cursor-not-allowed' : ''}" ${loading ? 'disabled' : ''}>
            ${loading ? '送信中...' : '認証コードを送信'}
          </button>
          <p class="text-xs text-gray-400 mt-3 text-center">6桁の認証コードがメールに届きます</p>
        `}
      </div>
    </div>
  `;
}

function renderSOModal() {
  if (!state.soModalOpen) return '';

  if (state.soModalType === 'import') {
    return renderImportModal();
  }
  return '';
}

function renderImportModal() {
  const areaId = state.soSearchAreaId;
  const area = AREAS.find(a => a.id === areaId);
  const areaName = area ? area.name : '';
  const parsed = state._aiParsedProperty;
  const batch = state._batchResults;
  const batchProcessing = state._batchProcessing;
  const batchUrls = state._batchUrls;

  return `
    <div class="so-modal-overlay" onclick="closeSOModal(event)">
      <div class="so-modal" onclick="event.stopPropagation()" style="max-height:90vh; overflow-y:auto;">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">🤖 物件情報をAIで取り込み${areaName ? `（${areaName}）` : ''}</h3>
          <button onclick="closeBatchModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>

        <div class="space-y-4">
          <!-- タブ切替: URL / テキスト -->
          <div class="flex border-b border-gray-200">
            <button id="tab-url" onclick="document.getElementById('panel-url').style.display='block'; document.getElementById('panel-text').style.display='none'; document.getElementById('tab-url').className='flex-1 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600'; document.getElementById('tab-text').className='flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent';" class="flex-1 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
              🔗 物件URLから登録
            </button>
            <button id="tab-text" onclick="document.getElementById('panel-text').style.display='block'; document.getElementById('panel-url').style.display='none'; document.getElementById('tab-text').className='flex-1 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600'; document.getElementById('tab-url').className='flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent';" class="flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent">
              📋 テキスト貼り付け
            </button>
          </div>

          <!-- URL入力パネル（複数URL入力欄） -->
          <div id="panel-url">
            ${batch.length === 0 && !batchProcessing ? `
              <label class="text-sm font-medium text-gray-700">物件ページのURL</label>
              <div class="space-y-2 mt-1" id="url-fields-container">
                ${batchUrls.map((url, i) => `
                  <div class="flex gap-2 items-center">
                    <span class="text-xs text-gray-400 w-5 text-right shrink-0">${i + 1}</span>
                    <input type="url" value="${(url || '').replace(/"/g, '&quot;')}" placeholder="https://suumo.jp/tochi/... や athome.co.jp/..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm batch-url-input" data-idx="${i}" oninput="updateBatchUrlValue(${i}, this.value)" />
                    ${batchUrls.length > 1 ? `<button onclick="removeBatchUrlField(${i})" class="text-gray-300 hover:text-red-400 text-lg leading-none shrink-0" title="削除">×</button>` : '<div class="w-5"></div>'}
                  </div>
                `).join('')}
              </div>
              <button onclick="addBatchUrlField()" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                ＋ URLを追加
              </button>
              <p class="text-xs text-gray-400 mt-1">SUUMO・アットホーム・HOMES等の個別物件ページURLを入力してください</p>
              <button id="btn-fetch-url" onclick="handleBatchFetchUrls()" class="w-full mt-3 px-4 py-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                🔗 URLから物件情報を取得${batchUrls.filter(u => u && u.startsWith('http')).length > 1 ? `（${batchUrls.filter(u => u && u.startsWith('http')).length}件）` : ''}
              </button>
            ` : ''}

            ${batchProcessing || batch.length > 0 ? renderBatchProgress() : ''}
          </div>

          <!-- テキスト貼り付けパネル -->
          <div id="panel-text" style="display:none;">
            <div>
              <label class="text-sm font-medium text-gray-700">物件URL（任意）</label>
              <input id="import-url-text" type="url" placeholder="https://suumo.jp/... （任意）" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div class="mt-3">
              <label class="text-sm font-medium text-gray-700">物件情報を貼り付け <span class="text-red-500">*</span></label>
              <textarea id="ai-import-text" rows="5" placeholder="物件サイトの情報をコピペしてください&#10;&#10;例:&#10;価格 2,580万円&#10;土地面積 182.5㎡（55.2坪）&#10;所在地 四日市市富田浜町&#10;最寄り駅 富田浜駅 徒歩5分&#10;用途地域 第一種住居地域" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" style="resize:vertical;"></textarea>
            </div>
            <button id="btn-ai-parse" onclick="handleAIParse()" class="w-full mt-3 px-4 py-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
              🤖 AIで情報を整理して保存
            </button>
          </div>

          ${parsed && batch.length === 0 ? renderSingleParsedPreview(parsed) : ''}
        </div>
      </div>
    </div>
  `;
}

// 単件プレビュー表示（テキスト貼り付け用）
function renderSingleParsedPreview(parsed) {
  return `
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 space-y-2">
      <p class="text-sm font-bold text-green-800">✅ AIが整理した物件情報</p>
      ${renderParsedPropertyGrid(parsed)}
      ${renderGeoInfo(parsed)}
      ${renderDupWarning(parsed)}
      ${parsed.memo ? `<p class="text-xs text-amber-700 mt-2">💡 ${parsed.memo}</p>` : ''}
      ${parsed.source_url ? `<p class="text-xs mt-1"><a href="${parsed.source_url}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">🔗 ${parsed.source_url}</a></p>` : ''}
      <div class="flex gap-2 mt-3">
        <button onclick="handleSaveParsed()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">💾 この内容で保存</button>
        <button onclick="state._aiParsedProperty=null; render();" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors">やり直す</button>
      </div>
    </div>
  `;
}

// 物件情報グリッド（共通パーツ）
function renderParsedPropertyGrid(parsed) {
  return `<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
    <span class="text-gray-500">価格:</span><span class="font-medium">${parsed.price ? parsed.price.toLocaleString() + '万円' : '—'}</span>
    <span class="text-gray-500">面積:</span><span class="font-medium">${parsed.land_area ? (parsed.land_area/3.305785).toFixed(1) + '坪（' + parsed.land_area + '㎡）' : '—'}</span>
    <span class="text-gray-500">住所:</span><span class="font-medium">${parsed.address || '—'}</span>
    <span class="text-gray-500">駅:</span><span class="font-medium">${parsed.station_distance || '—'}</span>
    ${parsed.zoning ? `<span class="text-gray-500">用途地域:</span><span class="font-medium">${parsed.zoning}</span>` : ''}
    ${parsed.building_coverage ? `<span class="text-gray-500">建ぺい率:</span><span class="font-medium">${parsed.building_coverage}</span>` : ''}
    ${parsed.road_access ? `<span class="text-gray-500">接道:</span><span class="font-medium">${parsed.road_access}</span>` : ''}
  </div>`;
}

// 位置情報表示（共通パーツ）
function renderGeoInfo(parsed) {
  const geoConf = parsed.geo_confidence;
  if (!parsed.lat || !parsed.lng) return '';
  const confLabel = geoConf === 'high' ? '🟢 高精度（ページ内座標）'
    : geoConf === 'medium' ? '🟡 中精度（住所ジオコーディング）'
    : '🔴 低精度（AI推定）';
  const confClass = geoConf === 'high' ? 'text-green-700 bg-green-50'
    : geoConf === 'medium' ? 'text-amber-700 bg-amber-50'
    : 'text-red-700 bg-red-50';
  return '<div class="mt-2 p-2 rounded ' + confClass + ' border">' +
    '<div class="flex items-center gap-2 text-xs font-medium">' +
    '<span>📍 位置情報: ' + confLabel + '</span>' +
    '<a href="https://www.google.com/maps?q=' + parsed.lat + ',' + parsed.lng + '" target="_blank" rel="noopener" class="text-blue-600 hover:underline ml-auto">🗺️ 地図で確認</a>' +
    '</div>' +
    (geoConf !== 'high' ? '<p class="text-xs mt-1 opacity-75">※ 保存後、地図リンクから位置をご確認ください</p>' : '') +
    '</div>';
}

// 重複警告（共通パーツ）
function renderDupWarning(parsed) {
  if (!parsed.dedup_hash) return '';
  const dup = state.savedProperties.find(p => p.dedup_hash === parsed.dedup_hash);
  if (!dup) return '';
  return '<div class="mt-2 p-2 rounded bg-red-50 border border-red-200 text-xs text-red-700">' +
    '⚠️ <strong>重複の可能性:</strong> 同じ住所・面積・価格の物件が既に保存されています（' + (dup.address || '住所不明') + '）' +
    '</div>';
}

// 一括取り込みの進捗表示
function renderBatchProgress() {
  const batch = state._batchResults;
  const processing = state._batchProcessing;
  const currentIdx = state._batchCurrentIndex;
  const total = batch.length;
  const doneCount = batch.filter(b => b.status === 'done' || b.status === 'error').length;
  const successCount = batch.filter(b => b.status === 'done').length;
  const errorCount = batch.filter(b => b.status === 'error').length;
  const savedCount = batch.filter(b => b.saved).length;

  // 全完了したか
  const allDone = !processing && doneCount === total;

  return `
    <div class="space-y-3">
      <!-- プログレスバー -->
      <div>
        <div class="flex items-center justify-between text-sm mb-1">
          <span class="font-medium text-gray-700">${processing ? `⏳ 取得中... (${doneCount}/${total})` : allDone ? `✅ 取得完了 (${successCount}件成功${errorCount > 0 ? '、' + errorCount + '件失敗' : ''})` : ''}</span>
          ${allDone ? `<button onclick="resetBatch()" class="text-xs text-gray-400 hover:text-gray-600">✕ 閉じる</button>` : ''}
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: ${total > 0 ? (doneCount / total * 100) : 0}%"></div>
        </div>
      </div>

      <!-- 各URL結果一覧 -->
      <div class="space-y-2 max-h-96 overflow-y-auto">
        ${batch.map((item, idx) => {
          const isProcessing = processing && idx === currentIdx;
          const isDone = item.status === 'done';
          const isError = item.status === 'error';
          const isSaved = item.saved;

          // URL短縮表示
          let shortUrl = item.url;
          try { shortUrl = new URL(item.url).hostname + new URL(item.url).pathname.substring(0, 30) + '...'; } catch(e) {}

          return `
            <div class="border rounded-lg ${isDone ? (isSaved ? 'border-green-300 bg-green-50/50' : 'border-blue-200 bg-blue-50/30') : isError ? 'border-red-200 bg-red-50/30' : isProcessing ? 'border-amber-200 bg-amber-50/30' : 'border-gray-200'} p-3">
              <div class="flex items-center gap-2">
                <span class="text-sm">${isProcessing ? '⏳' : isDone ? (isSaved ? '✅' : '📋') : isError ? '❌' : '⏸️'}</span>
                <span class="text-xs text-gray-500 truncate flex-1" title="${item.url}">${shortUrl}</span>
                ${isProcessing ? '<span class="text-xs text-amber-600 animate-pulse">AI解析中...</span>' : ''}
              </div>

              ${isDone && item.parsed ? `
                <div class="mt-2 pl-6">
                  <div class="grid grid-cols-2 gap-x-3 gap-y-0.5 text-xs">
                    <span class="text-gray-400">価格:</span><span class="font-medium">${item.parsed.price ? item.parsed.price.toLocaleString() + '万円' : '—'}</span>
                    <span class="text-gray-400">面積:</span><span class="font-medium">${item.parsed.land_area ? (item.parsed.land_area/3.305785).toFixed(1) + '坪' : '—'}</span>
                    <span class="text-gray-400">住所:</span><span class="font-medium col-span-1 truncate">${item.parsed.address || '—'}</span>
                  </div>
                  ${renderDupWarning(item.parsed)}
                  ${!isSaved ? `
                    <div class="flex gap-2 mt-2">
                      <button onclick="handleSaveBatchItem(${idx})" class="px-3 py-1 bg-green-600 text-white rounded text-xs font-medium hover:bg-green-700 transition-colors">💾 保存</button>
                      <button onclick="skipBatchItem(${idx})" class="px-3 py-1 bg-gray-100 text-gray-500 rounded text-xs hover:bg-gray-200 transition-colors">スキップ</button>
                    </div>
                  ` : `<p class="text-xs text-green-600 mt-1">✅ 保存済み</p>`}
                </div>
              ` : ''}

              ${isError ? `<p class="text-xs text-red-500 mt-1 pl-6">${item.error || '取得失敗'}</p>` : ''}
            </div>
          `;
        }).join('')}
      </div>

      ${allDone && successCount > 0 ? `
        <div class="flex gap-2">
          ${successCount - savedCount > 0 ? `
            <button onclick="handleSaveBatchAll()" class="flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
              💾 未保存をまとめて保存（${successCount - savedCount}件）
            </button>
          ` : `
            <button onclick="closeBatchModal()" class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
              ✅ 完了 — モーダルを閉じる
            </button>
          `}
        </div>
      ` : ''}
    </div>
  `;
}

// ============================================================
// Event Handlers
// ============================================================
function openImportModal(areaId) {
  const urlInput = document.getElementById('url-import-property') || document.getElementById('url-import-detail');
  const initialUrl = urlInput ? urlInput.value.trim() : '';
  state._importUrl = initialUrl;
  state._aiParsedProperty = null;
  state._batchUrls = initialUrl ? [initialUrl] : [''];
  state._batchResults = [];
  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  state.soSearchAreaId = areaId || null;
  state.soModalOpen = true;
  state.soModalType = 'import';
  render();
}

function closeSOModal(event) {
  if (event.target === event.currentTarget) {
    closeBatchModal();
  }
}

// ============================================================
// 一括URL取り込み: URL入力欄の管理
// ============================================================
function addBatchUrlField() {
  state._batchUrls.push('');
  render();
  // 追加後に最後の入力欄にフォーカス
  setTimeout(() => {
    const inputs = document.querySelectorAll('.batch-url-input');
    if (inputs.length > 0) inputs[inputs.length - 1].focus();
  }, 50);
}

function removeBatchUrlField(idx) {
  if (state._batchUrls.length <= 1) return;
  state._batchUrls.splice(idx, 1);
  render();
}

function updateBatchUrlValue(idx, value) {
  state._batchUrls[idx] = value;
  // ボタンの件数表示を更新（renderしない＝入力中のフォーカスを保持）
  const btn = document.getElementById('btn-fetch-url');
  if (btn) {
    const count = state._batchUrls.filter(u => u && u.trim().startsWith('http')).length;
    btn.textContent = count > 1
      ? `🔗 URLから物件情報を取得（${count}件）`
      : '🔗 URLから物件情報を取得';
  }
}

async function fetchSingleUrl(url) {
  const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
  const session = await supabaseClient.auth.getSession();
  const token = session?.data?.session?.access_token;
  if (token) headers['Authorization'] = `Bearer ${token}`;
  else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
  const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-assist`, {
    method: 'POST', headers,
    body: JSON.stringify({ action: 'fetch_url', url, areaId: state.soSearchAreaId })
  });
  if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
  const result = await res.json();
  if (result.error) throw new Error(result.error);
  return result;
}

async function handleBatchFetchUrls() {
  // 入力欄からURL一覧を取得
  const urls = state._batchUrls
    .map(u => (u || '').trim())
    .filter(u => u.startsWith('http'));

  if (urls.length === 0) { alert('物件ページのURLを入力してください'); return; }

  // 一括フローに入る
  state._batchResults = urls.map(url => ({ url, status: 'pending', parsed: null, error: null, saved: false }));
  state._batchProcessing = true;
  state._batchCurrentIndex = 0;
  state._aiParsedProperty = null;
  render();

  // 順次処理（Edge Function 25秒制限対策 + Jina APIレート制限対策）
  for (let i = 0; i < urls.length; i++) {
    state._batchCurrentIndex = i;
    state._batchResults[i].status = 'processing';
    render();

    try {
      const result = await fetchSingleUrl(urls[i]);
      state._batchResults[i].status = 'done';
      state._batchResults[i].parsed = result;
    } catch(e) {
      console.error(`URL Fetch error [${i}]:`, e);
      state._batchResults[i].status = 'error';
      state._batchResults[i].error = e.message;
    }
    render();

    // 次のリクエストまで少し待つ（レートリミット対策）
    if (i < urls.length - 1) {
      await new Promise(r => setTimeout(r, 1000));
    }
  }

  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  render();
}

// 個別保存
async function handleSaveBatchItem(idx) {
  const item = state._batchResults[idx];
  if (!item || !item.parsed || item.saved) return;
  const parsed = item.parsed;

  if (!parsed.price || !parsed.land_area) {
    alert('価格と面積が必要です。この物件はスキップしてください。');
    return;
  }

  const prop = buildPropertyFromParsed(parsed);
  const saved = await saveProperty(prop);
  if (saved) {
    state._batchResults[idx].saved = true;
    render();
  }
}

// 一括保存（未保存の成功分すべて）
async function handleSaveBatchAll() {
  const unsaved = state._batchResults.filter(b => b.status === 'done' && !b.saved && b.parsed);
  let savedCount = 0;
  for (const item of unsaved) {
    if (!item.parsed.price || !item.parsed.land_area) continue;
    // 重複チェック
    if (item.parsed.dedup_hash) {
      const dup = state.savedProperties.find(p => p.dedup_hash === item.parsed.dedup_hash);
      if (dup) continue; // 重複はスキップ
    }
    const prop = buildPropertyFromParsed(item.parsed);
    const saved = await saveProperty(prop);
    if (saved) {
      item.saved = true;
      savedCount++;
    }
  }
  render();
  if (savedCount > 0) {
    // 少し待ってから閉じない（ユーザーに結果を見せる）
  }
}

// スキップ
function skipBatchItem(idx) {
  state._batchResults[idx].saved = true; // saved=trueにしてUIから消す
  state._batchResults[idx].status = 'skipped';
  render();
}

// バッチリセット（URL入力に戻す）
function resetBatch() {
  state._batchUrls = [''];
  state._batchResults = [];
  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  render();
}

function closeBatchModal() {
  state.soModalOpen = false;
  state._aiParsedProperty = null;
  state._batchUrls = [''];
  state._batchResults = [];
  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  render();
}

// parsed → property オブジェクト変換（共通）
function buildPropertyFromParsed(parsed) {
  return {
    area_id: state.soSearchAreaId || null,
    url: parsed.source_url || state._importUrl || null,
    source: parsed.source || null,
    price: parsed.price * 10000, // 万円 → 円
    land_area: parsed.land_area,
    address: parsed.address || null,
    station_distance: parsed.station_distance || null,
    floor_plan: parsed.floor_plan || null,
    building_year: parsed.building_year || null,
    zoning: parsed.zoning || null,
    building_coverage: parsed.building_coverage || null,
    floor_area_ratio: parsed.floor_area_ratio || null,
    road_access: parsed.road_access || null,
    elevation: parsed.elevation || null,
    infrastructure: parsed.infrastructure || null,
    hazard: parsed.hazard || null,
    memo: parsed.memo || null,
    lat: parsed.lat || null,
    lng: parsed.lng || null,
    geo_confidence: parsed.geo_confidence || null,
    geo_source: parsed.geo_source || null,
    dedup_hash: parsed.dedup_hash || null,
  };
}

// 旧互換: 単件URL取得（テキスト貼り付けパネルでは使わない）
async function handleFetchUrl() {
  // 一括フローにリダイレクト
  handleBatchFetchUrls();
}

// テキスト貼り付け → AI解析
async function handleAIParse() {
  const textEl = document.getElementById('ai-import-text');
  const urlEl = document.getElementById('import-url-text');
  const text = textEl ? textEl.value.trim() : '';
  const url = urlEl ? urlEl.value.trim() : '';
  if (!text) { alert('物件情報を貼り付けてください'); return; }

  const btn = document.getElementById('btn-ai-parse');
  if (btn) { btn.textContent = '🤖 AIが解析中...'; btn.disabled = true; }

  try {
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    if (token) headers['Authorization'] = `Bearer ${token}`;
    else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-assist`, {
      method: 'POST', headers,
      body: JSON.stringify({ action: 'parse', text, url, areaId: state.soSearchAreaId })
    });
    if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
    const result = await res.json();
    if (result.error) throw new Error(result.error);
    state._aiParsedProperty = result;
    state._importUrl = url;
    render();
  } catch(e) {
    console.error('AI Parse error:', e);
    alert('AI解析に失敗しました: ' + e.message);
    if (btn) { btn.textContent = '🤖 AIで情報を整理して保存'; btn.disabled = false; }
  }
}

// AI解析結果を保存
async function handleSaveParsed() {
  const parsed = state._aiParsedProperty;
  if (!parsed) return;
  if (!parsed.price || !parsed.land_area) {
    alert('価格と面積が必要です。テキストに含まれているか確認してください。');
    return;
  }

  // 重複チェック（dedup_hash）
  if (parsed.dedup_hash) {
    const existing = state.savedProperties.find(p => p.dedup_hash === parsed.dedup_hash);
    if (existing) {
      const existAddr = existing.address || '住所不明';
      if (!confirm(`⚠️ この物件は既に保存されている可能性があります。\n\n既存: ${existAddr}\n\nそれでも保存しますか？`)) {
        return;
      }
    }
  }

  const prop = buildPropertyFromParsed(parsed);
  const saved = await saveProperty(prop);
  if (saved) {
    state.soModalOpen = false;
    state._importUrl = '';
    state._aiParsedProperty = null;
    render();
  }
}

async function handleToggleComparison(id) {
  await toggleComparison(id);
  render();
}

async function handleDeleteProperty(id) {
  if (!confirm('この物件を削除しますか？')) return;
  await deleteProperty(id);
  render();
}

async function handleGenerateComparison() {
  const btn = event?.target;
  if (btn) { btn.textContent = '生成中...'; btn.disabled = true; }
  const result = await generateComparison();
  if (result) {
    state.soComparison = result;
    state.soView = 'compare';
    backupToLocalStorage();
  }
  render();
}

async function clearAllProperties() {
  if (!confirm('保存した物件をすべて削除しますか？')) return;
  for (const p of [...state.savedProperties]) {
    await deleteProperty(p.id);
  }
  render();
}

// ============================================================
// SEO Content
// ============================================================
function renderSEOContent() {
  return `
    <div class="card p-6 mt-6">
      <h2 class="text-lg font-bold text-gray-800 mb-3">注文住宅の土地探しのポイント</h2>
      <div class="space-y-3 text-sm text-gray-600 leading-relaxed">
        <p>注文住宅を建てるための土地探しでは、価格だけでなく、用途地域・建ぺい率・容積率・接道状況・地盤の状態など、多くの項目を確認する必要があります。これらの情報は不動産サイトごとに記載方法が異なり、複数の土地を比較する際に大きな手間がかかります。</p>
        <p>当ツールは、SUUMO・アットホーム・LIFULL HOME'S等の不動産サイトの物件情報をAIが自動で読み取り、統一フォーマットの比較表として整理します。さらに、AIが各物件の注意点やおすすめポイントを分析してコメントを生成。見落としがちな確認事項もテンプレートとして提示するので、不動産会社への質問準備にも活用できます。</p>
      </div>
      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <a href="area.html" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors">
          📊 三重県エリア別の土地相場を見る →
        </a>
      </div>
    </div>
  `;
}

// ============================================================
// Footer
// ============================================================
function renderFooter() {
  return `
    <footer class="mt-8 py-6 border-t border-gray-200">
      <div class="text-center space-y-2">
        <div class="flex justify-center gap-4 mb-3">
          <a href="area.html" class="text-sm text-blue-600 hover:underline">📊 エリア比較ページ</a>
        </div>
        <p class="text-xs text-gray-400">※ 本ツールは参考情報であり、不動産購入の最終判断は専門家にご相談ください</p>
        <p class="text-xs text-gray-300 mt-3">© 注文相談.com</p>
      </div>
    </footer>
  `;
}

// ============================================================
// Bind Events
// ============================================================
function handleAuthSendOtp() {
  const input = document.getElementById('auth-email-input');
  const email = input ? input.value.trim() : '';
  if (!email || !email.includes('@')) { state.authError = 'メールアドレスを入力してください'; render(); return; }
  handleSendOtp(email);
}

function handleAuthVerify() {
  const input = document.getElementById('auth-otp-input');
  const token = input ? input.value.trim() : '';
  if (!token || token.length !== 6) { state.authError = '6桁のコードを入力してください'; render(); return; }
  handleVerifyOtp(state.authEmail, token);
}

function bindEvents() {
  // 認証モーダルのEnterキー対応
  const emailInput = document.getElementById('auth-email-input');
  if (emailInput) emailInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleAuthSendOtp(); });
  const otpInput = document.getElementById('auth-otp-input');
  if (otpInput) {
    otpInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleAuthVerify(); });
    otpInput.focus();
  }
  if (emailInput && state.authModalOpen && state.authStep === 'email') emailInput.focus();
}

// ============================================================
// Initialize
// ============================================================
restoreFromLocalStorage();
render();

// 認証状態の変更を監視
supabaseClient.auth.onAuthStateChange((event, session) => {
  if (session?.user) {
    updateAuthState(session.user);
  } else {
    state.authUser = null;
  }
  render();
});

ensureAuth().then(user => {
  if (user) updateAuthState(user);
  render();
  loadSavedProperties().then(() => {
    backupToLocalStorage();
    if (state.savedProperties.length > 0) render();
  });
  loadSavedComparisons().then(() => render());
  loadUserProfile().then(() => render());
}).catch(e => console.warn('Auth init skipped:', e.message));
</script>
</body>
</html>
