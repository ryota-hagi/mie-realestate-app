<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸‰é‡çœŒåŒ—éƒ¨ ä¸å‹•ç”£ãŠã™ã™ã‚ã‚¨ãƒªã‚¢è¨ºæ–­ | å¤¢ã®ã™ã¿ã‹</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* === Tailwind CSS v3.4.19 (production build) === */
  *,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sticky{position:sticky}.top-0{top:0}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-1{margin-left:.25rem}.mt-0\.5{margin-top:.125rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.h-6{height:1.5rem}.w-12{width:3rem}.w-16{width:4rem}.w-28{width:7rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-8{width:2rem}.w-full{width:100%}.min-w-0{min-width:0}.max-w-6xl{max-width:72rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity,1))}.border-blue-100{--tw-border-opacity:1;border-color:rgb(219 234 254/var(--tw-border-opacity,1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-50{--tw-border-opacity:1;border-color:rgb(249 250 251/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.bg-amber-500{--tw-bg-opacity:1;background-color:rgb(245 158 11/var(--tw-bg-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgb(156 163 175/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94/var(--tw-bg-opacity,1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity,1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255/var(--tw-bg-opacity,1))}.bg-slate-400{--tw-bg-opacity:1;background-color:rgb(148 163 184/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.p-2{padding:.5rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.leading-relaxed{line-height:1.625}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-amber-800{--tw-text-opacity:1;color:rgb(146 64 14/var(--tw-text-opacity,1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.shadow-md,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.outline{outline-style:solid}.blur{--tw-blur:blur(8px)}.blur,.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-filter{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity,1))}@media (min-width:640px){.sm\:block{display:block}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}@media (min-width:768px){.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  * { font-family: 'Noto Sans JP', sans-serif; }
  body { background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 50%, #f5f0ff 100%); min-height: 100vh; }
  .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); }
  .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; transition: all 0.2s; }
  .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .medal-gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
  .medal-silver { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
  .medal-bronze { background: linear-gradient(135deg, #CD7F32, #B8860B); }
  input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 3px; outline: none; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #3b82f6; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  .tab-active { background: #3b82f6; color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }
  .score-bar { height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; }
  .score-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .pulse-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 500; }
  /* Map styles */
  .map-layout { display: flex; gap: 0; height: 600px; }
  #map-container { flex: 1; border-radius: 12px 0 0 12px; overflow: hidden; z-index: 1; }
  #map-sidebar { width: 340px; background: white; border-left: 1px solid #e5e7eb; border-radius: 0 12px 12px 0; overflow-y: auto; padding: 0; }
  .leaflet-container { font-family: 'Noto Sans JP', sans-serif; }
  .map-marker-icon { transition: transform 0.2s; }
  .map-marker-icon:hover { transform: scale(1.15); }
  .sidebar-header { padding: 16px; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; z-index: 2; }
  .sidebar-body { padding: 16px; }
  .tx-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .tx-table th { background: #f9fafb; padding: 6px 8px; text-align: left; font-weight: 500; color: #6b7280; position: sticky; top: 0; }
  .tx-table td { padding: 6px 8px; border-top: 1px solid #f3f4f6; }
  .tx-table tr[data-tx-idx] { cursor: pointer; transition: background 0.15s; }
  .tx-table tr[data-tx-idx]:hover { background: #dbeafe; }
  .tx-table tr.tx-active { background: #bfdbfe; }
  /* School district toggle */
  .school-toggle { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; user-select: none; transition: all 0.2s; border: 1px solid #d1d5db; background: white; }
  .school-toggle.active { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
  .school-toggle:hover { background: #f3f4f6; }
  .school-toggle.active:hover { background: #bfdbfe; }
  /* School icon markers */
  .school-icon-marker { background: none !important; border: none !important; }
  /* Map loading overlay */
  .map-loading-overlay {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 800;
    background: rgba(0,0,0,0.25); display: flex; flex-direction: column;
    align-items: center; justify-content: center; pointer-events: none;
    transition: opacity 0.3s;
  }
  .map-loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .map-loading-box {
    background: white; border-radius: 12px; padding: 16px 28px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18); text-align: center;
    animation: mapLoadBounce 2s ease-in-out infinite;
  }
  @keyframes mapLoadBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
  .map-loading-spinner {
    width: 32px; height: 32px; border: 3px solid #e5e7eb;
    border-top-color: #3b82f6; border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 0 auto 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .map-loading-progress {
    width: 120px; height: 4px; background: #e5e7eb; border-radius: 2px;
    margin: 8px auto 0; overflow: hidden;
  }
  .map-loading-progress-bar {
    height: 100%; background: #3b82f6; border-radius: 2px;
    transition: width 0.3s ease;
  }
  @media (max-width: 768px) {
    .map-layout { flex-direction: column; height: auto; }
    #map-container { height: 400px; border-radius: 12px 12px 0 0; }
    #map-sidebar { width: 100%; border-left: none; border-top: 1px solid #e5e7eb; border-radius: 0 0 12px 12px; max-height: 350px; }
  }
</style>
</head>
<body>
<div id="app"></div>

<script>
// ============================================================
// è¨­å®š â€” ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã“ã“ã‚’ç·¨é›†
// ============================================================
const CONFIG = {
  // ãƒ—ãƒ­ã‚­ã‚·URLï¼ˆSupabase Edge Functionï¼‰
  PROXY_URL: 'https://jvfmvitknqnmuduyscnl.supabase.co/functions/v1/mcp-proxy',

  // MCPã‚µãƒ¼ãƒãƒ¼URLï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§æ¥ç¶šï¼‰
  MCP_REINFO: 'https://mcp.n-3.ai/mcp?tools=get-time,reinfolib-real-estate-price,reinfolib-city-list',
  MCP_ESTAT: 'https://mcp.n-3.ai/mcp?tools=e-stat-get-stats-list,e-stat-get-meta-info,e-stat-get-data-catalog',
};

// ============================================================
// MCP Streamable HTTP Client (with proxy support)
// ============================================================
class MCPClient {
  constructor(mcpUrl, proxyUrl) {
    this.mcpUrl = mcpUrl;
    this.proxyUrl = proxyUrl;
    this.sessionId = null;
    this.requestId = 0;
    this.connected = false;
    this.tools = [];
    this.useProxy = !!proxyUrl;
  }

  _buildFetchUrl() {
    if (this.useProxy) {
      return `${this.proxyUrl}?url=${encodeURIComponent(this.mcpUrl)}`;
    }
    return this.mcpUrl;
  }

  async initialize() {
    // Try proxy first, then direct
    const attempts = this.useProxy
      ? [true, false]  // proxy â†’ direct
      : [false];       // direct only

    let lastError;
    for (const viaProxy of attempts) {
      try {
        this.useProxy = viaProxy;
        const url = this._buildFetchUrl();

        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/event-stream',
          },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: ++this.requestId,
            method: 'initialize',
            params: {
              protocolVersion: '2025-03-26',
              capabilities: {},
              clientInfo: { name: 'yume-no-sumika-realestate', version: '1.0.0' }
            }
          })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const sid = res.headers.get('Mcp-Session-Id');
        if (sid) this.sessionId = sid;

        const data = await this._parseResponse(res);

        // Send initialized notification
        const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
        if (this.sessionId) headers['Mcp-Session-Id'] = this.sessionId;

        await fetch(this._buildFetchUrl(), {
          method: 'POST',
          headers,
          body: JSON.stringify({ jsonrpc: '2.0', method: 'notifications/initialized' })
        });

        this.connected = true;
        console.log(`MCP connected via ${viaProxy ? 'proxy' : 'direct'}`);
        return data;
      } catch (e) {
        lastError = e;
        console.warn(`MCP ${viaProxy ? 'proxy' : 'direct'} failed:`, e.message);
      }
    }
    this.connected = false;
    throw lastError;
  }

  async listTools() {
    const data = await this._request('tools/list', {});
    if (data && data.tools) this.tools = data.tools;
    return this.tools;
  }

  async callTool(name, args = {}) {
    return this._request('tools/call', { name, arguments: args });
  }

  async _request(method, params) {
    const url = this._buildFetchUrl();
    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json, text/event-stream' };
    if (this.sessionId) headers['Mcp-Session-Id'] = this.sessionId;

    const res = await fetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify({ jsonrpc: '2.0', id: ++this.requestId, method, params })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return this._parseResponse(res);
  }

  async _parseResponse(res) {
    const ct = res.headers.get('Content-Type') || '';
    if (ct.includes('text/event-stream')) {
      const text = await res.text();
      const lines = text.split('\n');
      let lastData = null;
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try { lastData = JSON.parse(line.slice(6)); } catch {}
        }
      }
      return lastData?.result || lastData;
    }
    const json = await res.json();
    return json.result || json;
  }
}

// ============================================================
// Pre-loaded Area Data (fallback + base data)
// ============================================================
const AREAS = [
  {
    id: "yokkaichi", name: "å››æ—¥å¸‚å¸‚", cityCode: "24202", lat: 34.9650, lng: 136.6244,
    landPriceAvg: 57020, residentialPrice: 48385, commercialPrice: 89007, pricePerTsubo: 188498,
    yoyChange: 1.33, population: 311000, popGrowthRate: -0.3, accessToNagoya: 35,
    hospitals: 42, schools: 58, parks: 35, shopping: 120, safetyScore: 78, childcareScore: 82, naturalScore: 55,
    description: "ä¸‰é‡çœŒæœ€å¤§ã®éƒ½å¸‚ã€‚çŸ³æ²¹åŒ–å­¦ã‚³ãƒ³ãƒ“ãƒŠãƒ¼ãƒˆã¨æ¸¯æ¹¾ã‚’æ“ã™ã‚‹ç”£æ¥­éƒ½å¸‚ã€‚è¿‘é‰„ãƒ»JRä¸¡ç·šã§åå¤å±‹ã¸ç›´é€šã€‚å¤§å‹å•†æ¥­æ–½è¨­ãŒå……å®Ÿã—ã€åŒ»ç™‚ãƒ»æ•™è‚²ã‚¤ãƒ³ãƒ•ãƒ©ã‚‚çœŒå†…ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã€‚",
    highlights: ["çœŒå†…æœ€å¤§ã®å•†æ¥­é›†ç©", "åå¤å±‹ã¸35åˆ†", "åŒ»ç™‚æ–½è¨­å……å®Ÿ", "æ±åé˜ªãƒ»æ–°åç¥IC"],
    risks: ["ä¸€éƒ¨åœ°åŸŸã®å¤§æ°—ç’°å¢ƒ", "ä¸­å¿ƒéƒ¨ã®åœ°ä¾¡ä¸Šæ˜‡"],
    trend: [{y:"2020",p:52000},{y:"2021",p:53200},{y:"2022",p:54500},{y:"2023",p:55800},{y:"2024",p:56300},{y:"2025",p:57020}],
    recAreas: ["å¯Œç”°ãƒ»å¯Œæ´²åŸã‚¨ãƒªã‚¢ï¼ˆé§…è¿‘ã§å‰²å®‰ï¼‰","ç¬¹å·ãƒ»æ—¥æ°¸ã‚¨ãƒªã‚¢ï¼ˆä½ç’°å¢ƒè‰¯å¥½ï¼‰","æ°´æ²¢ãƒ»å°å±±ç”°ã‚¨ãƒªã‚¢ï¼ˆè‡ªç„¶è±Šã‹ï¼‰"]
  },
  {
    id: "kuwana", name: "æ¡‘åå¸‚", cityCode: "24205", lat: 35.0585, lng: 136.6834,
    landPriceAvg: 55543, residentialPrice: 53686, commercialPrice: 86714, pricePerTsubo: 183614,
    yoyChange: 0.82, population: 140000, popGrowthRate: -0.5, accessToNagoya: 25,
    hospitals: 18, schools: 28, parks: 22, shopping: 55, safetyScore: 82, childcareScore: 85, naturalScore: 68,
    description: "åå¤å±‹ã¸ã®é€šå‹¤åœã¨ã—ã¦äººæ°—ã€‚æ¡‘åé§…ã‹ã‚‰åå¤å±‹ã¾ã§æœ€çŸ­25åˆ†ã€‚ãƒŠã‚¬ã‚·ãƒã‚¹ãƒ‘ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚„ãªã°ãªã®é‡Œãªã©è¦³å…‰è³‡æºã‚‚è±Šå¯Œã€‚æ­´å²çš„ãªåŸä¸‹ç”ºã®é¢¨æƒ…ãŒæ®‹ã‚‹ã€‚",
    highlights: ["åå¤å±‹ã¸æœ€çŸ­25åˆ†","å­è‚²ã¦ç’°å¢ƒâ—","è¦³å…‰è³‡æºè±Šå¯Œ","ä½ç’°å¢ƒã®è‰¯ã•"],
    risks: ["æ–æ–å·ãƒ»é•·è‰¯å·ã®æ´ªæ°´ãƒªã‚¹ã‚¯","äººå£æ¸›å°‘å‚¾å‘"],
    trend: [{y:"2020",p:52500},{y:"2021",p:53000},{y:"2022",p:53800},{y:"2023",p:54500},{y:"2024",p:55100},{y:"2025",p:55543}],
    recAreas: ["æ¡‘åé§…å‘¨è¾ºï¼ˆåˆ©ä¾¿æ€§é‡è¦–ï¼‰","å¤šåº¦ã‚¨ãƒªã‚¢ï¼ˆè‡ªç„¶ã¨ä¾¡æ ¼ãƒãƒ©ãƒ³ã‚¹ï¼‰","é•·å³¶ã‚¨ãƒªã‚¢ï¼ˆã‚†ã£ãŸã‚Šå±…ä½ï¼‰"]
  },
  {
    id: "suzuka", name: "éˆ´é¹¿å¸‚", cityCode: "24207", lat: 34.8824, lng: 136.5842,
    landPriceAvg: 41015, residentialPrice: 38000, commercialPrice: 62000, pricePerTsubo: 135587,
    yoyChange: 1.11, population: 195000, popGrowthRate: -0.2, accessToNagoya: 55,
    hospitals: 25, schools: 42, parks: 28, shopping: 72, safetyScore: 80, childcareScore: 80, naturalScore: 65,
    description: "éˆ´é¹¿ã‚µãƒ¼ã‚­ãƒƒãƒˆã¨HondaæŠ€ç ”ã®ä¼æ¥­åŸä¸‹ç”ºã€‚åå¤å±‹åœã¨æ¯”ã¹åœ°ä¾¡ãŒæ‰‹é ƒã§ã€åºƒã„åœŸåœ°ã‚’ç¢ºä¿ã—ã‚„ã™ã„ã€‚æ–°åç¥éˆ´é¹¿ã‚¹ãƒãƒ¼ãƒˆICã®é–‹é€šã§äº¤é€šåˆ©ä¾¿æ€§ãŒå‘ä¸Šã€‚",
    highlights: ["åœ°ä¾¡ãŒæ‰‹é ƒã§åºƒã„å®¶ãŒå»ºã¦ã‚„ã™ã„","Hondaé–¢é€£ã®é›‡ç”¨å®‰å®š","æ–°åç¥ã‚¹ãƒãƒ¼ãƒˆIC","ä¸­å‹¢ãƒã‚¤ãƒ‘ã‚¹æ•´å‚™"],
    risks: ["åå¤å±‹é€šå‹¤ã«ã¯ã‚„ã‚„é ã„","æ²¿å²¸éƒ¨ã®æ´¥æ³¢ãƒªã‚¹ã‚¯"],
    trend: [{y:"2020",p:38500},{y:"2021",p:39000},{y:"2022",p:39600},{y:"2023",p:40200},{y:"2024",p:40600},{y:"2025",p:41015}],
    recAreas: ["ç™½å­é§…å‘¨è¾ºï¼ˆåˆ©ä¾¿æ€§â—ï¼‰","å¹³ç”°ãƒ»ç®—æ‰€ã‚¨ãƒªã‚¢ï¼ˆè½ã¡ç€ã„ãŸä½å®…åœ°ï¼‰","åº„é‡ãƒ»åŠ ä½ç™»ã‚¨ãƒªã‚¢ï¼ˆæ–°èˆˆä½å®…åœ°ï¼‰"]
  },
  {
    id: "inabe", name: "ã„ãªã¹å¸‚", cityCode: "24212", lat: 35.1146, lng: 136.5612,
    landPriceAvg: 24500, residentialPrice: 22000, commercialPrice: 35000, pricePerTsubo: 81000,
    yoyChange: 0.45, population: 44000, popGrowthRate: -0.8, accessToNagoya: 65,
    hospitals: 6, schools: 14, parks: 18, shopping: 15, safetyScore: 88, childcareScore: 75, naturalScore: 95,
    description: "éˆ´é¹¿å±±è„ˆã®éº“ã«åºƒãŒã‚‹è‡ªç„¶è±Šã‹ãªã¾ã¡ã€‚ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ãƒ¬ã‚¸ãƒ£ãƒ¼ãŒå……å®Ÿã—ã€ç§»ä½å…ˆã¨ã—ã¦æ³¨ç›®åº¦ä¸Šæ˜‡ä¸­ã€‚åœ°ä¾¡ã¯çœŒåŒ—éƒ¨ã§æœ€ã‚‚æ‰‹é ƒãªæ°´æº–ã€‚",
    highlights: ["åœ§å€’çš„ãªè‡ªç„¶ç’°å¢ƒ","åœ°ä¾¡ãŒéå¸¸ã«æ‰‹é ƒ","ç§»ä½æ”¯æ´åˆ¶åº¦å……å®Ÿ","ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢å¤©å›½"],
    risks: ["å•†æ¥­æ–½è¨­ãŒå°‘ãªã„","å…¬å…±äº¤é€šãŒä¸ä¾¿","äººå£æ¸›å°‘"],
    trend: [{y:"2020",p:23500},{y:"2021",p:23700},{y:"2022",p:23900},{y:"2023",p:24100},{y:"2024",p:24300},{y:"2025",p:24500}],
    recAreas: ["åŒ—å‹¢ã‚¨ãƒªã‚¢ï¼ˆé§…è¿‘ãƒ»åˆ©ä¾¿æ€§ï¼‰","å“¡å¼ã‚¨ãƒªã‚¢ï¼ˆé–‘é™ãªä½å®…åœ°ï¼‰","è—¤åŸã‚¨ãƒªã‚¢ï¼ˆå±±é–“éƒ¨ãƒ»æ ¼å®‰ï¼‰"]
  },
  {
    id: "kameyama", name: "äº€å±±å¸‚", cityCode: "24210", lat: 34.8540, lng: 136.4520,
    landPriceAvg: 29500, residentialPrice: 27000, commercialPrice: 42000, pricePerTsubo: 97500,
    yoyChange: 0.68, population: 49000, popGrowthRate: -0.6, accessToNagoya: 60,
    hospitals: 8, schools: 16, parks: 15, shopping: 22, safetyScore: 85, childcareScore: 76, naturalScore: 80,
    description: "æ±åé˜ªã¨æ–°åç¥ãŒäº¤å·®ã™ã‚‹äº¤é€šã®è¦è¡ã€‚æ—§æ±æµ·é“ã®å®¿å ´ç”ºã®æ­´å²ã‚’æŒã¤ã€‚Sharpäº€å±±å·¥å ´ã‚’ã¯ã˜ã‚è£½é€ æ¥­ãŒé›†ç©ã€‚",
    highlights: ["é«˜é€Ÿé“è·¯ã®çµç¯€ç‚¹","è£½é€ æ¥­ã®é›‡ç”¨","æ­´å²çš„ãªè¡—ä¸¦ã¿","å‰²å®‰ãªåœ°ä¾¡"],
    risks: ["JRã®æœ¬æ•°ãŒå°‘ãªã„","å•†æ¥­æ–½è¨­ãŒé™å®šçš„"],
    trend: [{y:"2020",p:28000},{y:"2021",p:28300},{y:"2022",p:28700},{y:"2023",p:29000},{y:"2024",p:29200},{y:"2025",p:29500}],
    recAreas: ["äº€å±±é§…å‘¨è¾ºï¼ˆJRã‚¢ã‚¯ã‚»ã‚¹ï¼‰","é–¢ã‚¨ãƒªã‚¢ï¼ˆå®¿å ´ç”ºã®é¢¨æƒ…ï¼‰","é‡æ‘ã‚¨ãƒªã‚¢ï¼ˆæ–°èˆˆä½å®…åœ°ï¼‰"]
  },
  {
    id: "komono", name: "è°é‡ç”º", cityCode: "24341", lat: 35.0244, lng: 136.5090,
    landPriceAvg: 31000, residentialPrice: 29000, commercialPrice: 45000, pricePerTsubo: 102500,
    yoyChange: 0.55, population: 41000, popGrowthRate: -0.1, accessToNagoya: 50,
    hospitals: 7, schools: 12, parks: 20, shopping: 25, safetyScore: 86, childcareScore: 83, naturalScore: 92,
    description: "å¾¡åœ¨æ‰€å²³ã¨æ¹¯ã®å±±æ¸©æ³‰ã‚’æŠ±ãˆã‚‹è¦³å…‰ã¨è‡ªç„¶ã®ã¾ã¡ã€‚è¿‘é‰„æ¹¯ã®å±±ç·šã§å››æ—¥å¸‚ã¸ç›´é€šã€‚äººå£æ¸›å°‘ç‡ãŒä½ãã€ç§»ä½å…ˆã¨ã—ã¦äººæ°—ãŒé«˜ã„ã€‚",
    highlights: ["æ¸©æ³‰ã¨è‡ªç„¶ç’°å¢ƒ","äººå£æ¸›å°‘ç‡ãŒä½ã„","å››æ—¥å¸‚ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è‰¯å¥½","ç§»ä½äººæ°—ä¸Šæ˜‡ä¸­"],
    risks: ["é‰„é“ã¯æ¹¯ã®å±±ç·šã®ã¿","å¤§å‹å•†æ¥­æ–½è¨­ãŒå°‘ãªã„"],
    trend: [{y:"2020",p:29500},{y:"2021",p:29800},{y:"2022",p:30200},{y:"2023",p:30500},{y:"2024",p:30800},{y:"2025",p:31000}],
    recAreas: ["è°é‡é§…å‘¨è¾ºï¼ˆåˆ©ä¾¿æ€§é‡è¦–ï¼‰","æ¹¯ã®å±±ã‚¨ãƒªã‚¢ï¼ˆæ¸©æ³‰ãƒ»è‡ªç„¶ï¼‰","ç«¹æˆãƒ»åƒè‰ã‚¨ãƒªã‚¢ï¼ˆé–‘é™ï¼‰"]
  },
  {
    id: "toin", name: "æ±å“¡ç”º", cityCode: "24343", lat: 35.0690, lng: 136.6030,
    landPriceAvg: 35500, residentialPrice: 33000, commercialPrice: 48000, pricePerTsubo: 117400,
    yoyChange: 0.72, population: 26000, popGrowthRate: 0.1, accessToNagoya: 40,
    hospitals: 5, schools: 8, parks: 12, shopping: 18, safetyScore: 87, childcareScore: 88, naturalScore: 72,
    description: "ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«æ±å“¡ã‚’ä¸­å¿ƒã«å•†æ¥­æ–½è¨­ãŒå……å®Ÿã—ãŸã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚·ãƒ†ã‚£ã€‚äººå£ãŒå¾®å¢—å‚¾å‘ã§ãƒ•ã‚¡ãƒŸãƒªãƒ¼å±¤ã«äººæ°—ã€‚",
    highlights: ["äººå£å¢—åŠ å‚¾å‘","ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«æ±å“¡","å­è‚²ã¦ä¸–ä»£ã«äººæ°—","ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã§ä½ã¿ã‚„ã™ã„"],
    risks: ["é‰„é“ã‚¢ã‚¯ã‚»ã‚¹ãŒé™å®šçš„","ç”ºåŸŸãŒç‹­ã„"],
    trend: [{y:"2020",p:33500},{y:"2021",p:34000},{y:"2022",p:34500},{y:"2023",p:35000},{y:"2024",p:35200},{y:"2025",p:35500}],
    recAreas: ["æ±å“¡é§…å‘¨è¾ºï¼ˆé§…è¿‘ï¼‰","ç¬¹å°¾ã‚¨ãƒªã‚¢ï¼ˆãƒ•ã‚¡ãƒŸãƒªãƒ¼å‘ã‘ï¼‰","åŸå±±ã‚¨ãƒªã‚¢ï¼ˆæ–°èˆˆä½å®…åœ°ï¼‰"]
  }
];

const COLORS = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4'];

// ============================================================
// App State
// ============================================================
const state = {
  view: 'ranking',
  selectedAreaId: null,
  mapSelectedAreaId: null,
  mcpStatus: 'disconnected', // disconnected | connecting | connected | error
  mcpMessage: '',
  mcpLiveData: null,
  weights: { price: 25, access: 20, growth: 15, living: 15, family: 15, nature: 10 },
  charts: {}
};

// Map globals (persistent across renders)
let mapInstance = null;
let mapMarkers = {};
let txMarkerLayer = null; // LayerGroup for transaction markers
let schoolDistrictLayer = null; // GeoJSON layer for school district polygons
let schoolMarkerLayer = null; // LayerGroup for school icon markers
let schoolDistrictData = null; // cached GeoJSON data
let showSchoolDistricts = false; // toggle state

// ============================================================
// Score Calculation
// ============================================================
function calcScores(area, w) {
  const priceScore = 100 - ((area.residentialPrice - 20000) / 40000) * 100;
  const accessScore = ((70 - area.accessToNagoya) / 70) * 100;
  const growthScore = Math.min(100, Math.max(0, (area.yoyChange / 2) * 100));
  const livingScore = (area.hospitals/45)*25 + (area.schools/60)*25 + (area.shopping/120)*25 + (area.safetyScore/100)*25;
  const familyScore = (area.childcareScore + area.safetyScore + Math.min(100,(area.parks/35)*100)) / 3;
  const natureScore = area.naturalScore;
  const total = priceScore*(w.price/100) + accessScore*(w.access/100) + growthScore*(w.growth/100) + livingScore*(w.living/100) + familyScore*(w.family/100) + natureScore*(w.nature/100);
  return { price: Math.round(priceScore), access: Math.round(accessScore), growth: Math.round(growthScore), living: Math.round(livingScore), family: Math.round(familyScore), nature: Math.round(natureScore), total: Math.round(total) };
}

function getRankedAreas() {
  return AREAS.map(a => ({ ...a, scores: calcScores(a, state.weights) })).sort((a,b) => b.scores.total - a.scores.total);
}

// ============================================================
// MCP Connection
// ============================================================
let mcpReinfo = null;

async function connectMCP() {
  state.mcpStatus = 'connecting';
  state.mcpMessage = 'MCPã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­ï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§è©¦è¡Œï¼‰...';
  render();

  try {
    mcpReinfo = new MCPClient(CONFIG.MCP_REINFO, CONFIG.PROXY_URL);
    await mcpReinfo.initialize();
    const tools = await mcpReinfo.listTools();
    state.mcpStatus = 'connected';
    state.mcpMessage = `æ¥ç¶šå®Œäº† â€” ${tools.length}å€‹ã®ãƒ„ãƒ¼ãƒ«ãŒåˆ©ç”¨å¯èƒ½`;
    render();

    // Fetch live data
    await fetchLiveData();
  } catch(e) {
    state.mcpStatus = 'error';
    state.mcpMessage = `æ¥ç¶šå¤±æ•—: ${e.message}ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­ï¼‰`;
    render();
  }
}

// Lightweight status text update (no full re-render)
function updateStatusText(msg) {
  state.mcpMessage = msg;
  const el = document.getElementById('mcp-status-text');
  if (el) el.textContent = msg;
}

// ------------------------------------------------------------
// Phase 1: Quick overview fetch (latest year only, all areas)
// ------------------------------------------------------------
async function fetchLiveData() {
  if (!mcpReinfo || !mcpReinfo.connected) return;

  try {
    updateStatusText('æ¦‚è¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');

    const cityResult = await mcpReinfo.callTool('reinfolib-city-list', { area: '24' });

    // Fetch only latest year for quick overview (7 requests)
    const priceResults = [];
    for (const area of AREAS) {
      try {
        updateStatusText(`${area.name} ã®æ¦‚è¦ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...`);
        const priceData = await mcpReinfo.callTool('reinfolib-real-estate-price', {
          year: '2024', area: '24', city: area.cityCode
        });
        priceResults.push({ cityCode: area.cityCode, quarters: [priceData] });
      } catch(e) {
        console.warn(`Overview fetch failed for ${area.name}:`, e);
        priceResults.push({ cityCode: area.cityCode, quarters: [] });
      }
    }

    state.mcpLiveData = { cities: cityResult, prices: priceResults };
    updateAreasWithLiveData(priceResults);

    let totalTx = 0;
    AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
    state.mcpMessage = `æ¦‚è¦ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼ˆè¨ˆ${totalTx}ä»¶ï¼‰ â€” ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™`;

    render();
  } catch(e) {
    state.mcpMessage = `ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­ï¼‰`;
    render();
  }
}

// ------------------------------------------------------------
// Phase 2: Deep fetch for a single area (5 years Ã— 4 quarters)
// ------------------------------------------------------------
const AREA_FULL_LOADED = new Set();
let _currentFetchAreaId = null;

async function fetchAreaFullData(areaId) {
  if (!mcpReinfo || !mcpReinfo.connected) return;
  if (AREA_FULL_LOADED.has(areaId)) return; // already loaded
  if (_currentFetchAreaId === areaId) return; // already fetching

  const area = AREAS.find(a => a.id === areaId);
  if (!area) return;

  _currentFetchAreaId = areaId;

  // Show map loading overlay
  showMapLoading(area.name, 0);

  const yearQuarters = [
    { year: '2024', quarter: '4' }, { year: '2024', quarter: '3' },
    { year: '2024', quarter: '2' }, { year: '2024', quarter: '1' },
    { year: '2023', quarter: '4' }, { year: '2023', quarter: '3' },
    { year: '2023', quarter: '2' }, { year: '2023', quarter: '1' },
    { year: '2022', quarter: '4' }, { year: '2022', quarter: '3' },
    { year: '2022', quarter: '2' }, { year: '2022', quarter: '1' },
    { year: '2021', quarter: '4' }, { year: '2021', quarter: '3' },
    { year: '2021', quarter: '2' }, { year: '2021', quarter: '1' },
    { year: '2020', quarter: '4' }, { year: '2020', quarter: '3' },
    { year: '2020', quarter: '2' }, { year: '2020', quarter: '1' },
  ];

  const allData = [];
  let done = 0;
  const total = yearQuarters.length;

  for (const yq of yearQuarters) {
    try {
      done++;
      const pct = Math.round(done / total * 100);
      updateMapLoading(`${area.name} ${yq.year}å¹´Q${yq.quarter}`, pct);
      updateStatusText(`${area.name} è©³ç´°å–å¾—ä¸­... (${done}/${total})`);
      const priceData = await mcpReinfo.callTool('reinfolib-real-estate-price', {
        year: yq.year, quarter: yq.quarter, area: '24', city: area.cityCode
      });
      allData.push(priceData);
    } catch(e) {
      console.warn(`Detail fetch failed for ${area.name} ${yq.year}Q${yq.quarter}:`, e);
    }
  }

  // Merge with existing overview data
  updateAreasWithLiveData([{ cityCode: area.cityCode, quarters: allData }]);

  AREA_FULL_LOADED.add(areaId);
  _currentFetchAreaId = null;

  // Hide map loading overlay
  hideMapLoading();

  const txCount = area._liveTransactions ? area._liveTransactions.length : 0;
  updateStatusText(`${area.name}: è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼ˆ${txCount}ä»¶ï¼‰`);

  // Refresh map pins for this area
  if (state.view === 'map' && txMarkerLayer) {
    if (state.mapSelectedAreaId === areaId) {
      showTransactionPins(area);
    }
    // Update sidebar if showing this area
    const ranked = getRankedAreas();
    if (state.mapSelectedAreaId === areaId) {
      updateMapSidebar(area, ranked);
    }
  }

  // Background geocode new districts
  geocodeDistrictsBackground().catch(e => console.warn('Geocoding error:', e));
}

function extractTransactionsFromMCPResponse(data) {
  let content = data;
  if (content && content.content) content = content.content;
  if (!Array.isArray(content)) return [];
  const textContent = content.find(c => c.type === 'text');
  if (!textContent) return [];
  try {
    const parsed = JSON.parse(textContent.text);
    if (parsed.data && Array.isArray(parsed.data)) return parsed.data;
  } catch {}
  return [];
}

function updateAreasWithLiveData(priceResults) {
  for (const result of priceResults) {
    const area = AREAS.find(a => a.cityCode === result.cityCode);
    if (!area) continue;

    // Merge transactions from all quarters
    const allRecords = [];
    const sources = result.quarters || (result.data ? [result.data] : []);
    for (const src of sources) {
      if (!src) continue;
      const records = extractTransactionsFromMCPResponse(src);
      allRecords.push(...records);
    }

    if (allRecords.length === 0) continue;

    // Deduplicate by TradePrice + District + Area combo
    const seen = new Set();
    const uniqueRecords = allRecords.filter(d => {
      const key = `${d.TradePrice}-${d.DistrictName||d.Region||''}-${d.Area||''}`;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    // Store full transaction records for map display
    area._liveTransactions = uniqueRecords.map(d => ({
      TradePrice: d.TradePrice ? parseInt(d.TradePrice) : null,
      Type: d.Type || d.TradeType || '',
      Area: d.Area ? parseFloat(d.Area) : null,
      FloorPlan: d.FloorPlan || '',
      BuildingYear: d.BuildingYear || '',
      NearestStation: d.NearestStation || '',
      DistanceToStation: d.TimeToNearestStation || d.DistanceToStation || '',
      Use: d.Use || d.Purpose || '',
      District: d.DistrictName || d.Region || '',
      Structure: d.Structure || '',
      CityPlanning: d.CityPlanning || '',
    }));

    // Calculate average trade price from live data
    const prices = uniqueRecords.filter(d => d.TradePrice).map(d => parseInt(d.TradePrice));
    if (prices.length > 0) {
      area._liveAvgTradePrice = Math.round(prices.reduce((a,b) => a+b, 0) / prices.length);
      area._liveTransactionCount = uniqueRecords.length;
    }
  }
}

// ============================================================
// Render Functions
// ============================================================
function render() {
  const app = document.getElementById('app');
  const ranked = getRankedAreas();
  const selected = state.selectedAreaId ? ranked.find(a => a.id === state.selectedAreaId) : ranked[0];

  app.innerHTML = `
    ${renderHeader()}
    <div class="max-w-6xl mx-auto px-4 py-6">
      ${renderMCPStatus()}
      ${renderWeights()}
      ${state.view === 'ranking' ? renderRanking(ranked) : ''}
      ${state.view === 'compare' ? renderCompare(ranked) : ''}
      ${state.view === 'detail' ? renderDetail(selected, ranked) : ''}
      ${state.view === 'map' ? renderMap(ranked) : ''}
      ${renderFooter()}
    </div>
  `;

  // Re-bindã‚¤ãƒ™ãƒ³ãƒˆ
  bindEvents(ranked);

  // ãƒãƒ£ãƒ¼ãƒˆæç”»ãƒ»ãƒãƒƒãƒ—åˆæœŸåŒ–ï¼ˆDOMãŒå­˜åœ¨ã—ã¦ã‹ã‚‰ï¼‰
  requestAnimationFrame(() => {
    if (state.view === 'compare') drawCompareCharts(ranked);
    if (state.view === 'detail' && selected) drawDetailCharts(selected);
    if (state.view === 'map') {
      initializeMap(ranked);
      if (state.mapSelectedAreaId) {
        const selArea = ranked.find(a => a.id === state.mapSelectedAreaId);
        if (selArea) updateMapSidebar(selArea, ranked);
      }
    }
  });
}

function renderHeader() {
  const tabs = [
    { id: 'ranking', label: 'ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°' },
    { id: 'compare', label: 'ğŸ“Š æ¯”è¼ƒ' },
    { id: 'detail', label: 'ğŸ” è©³ç´°' },
    { id: 'map', label: 'ğŸ—ºï¸ åœ°å›³' }
  ];
  return `
    <header class="glass sticky top-0 z-50 border-b border-gray-200 shadow-sm">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">ğŸ  ä¸‰é‡çœŒåŒ—éƒ¨ ä¸å‹•ç”£ãŠã™ã™ã‚ã‚¨ãƒªã‚¢è¨ºæ–­</h1>
            <p class="text-sm text-gray-500 mt-1">å›½åœŸäº¤é€šçœ ä¸å‹•ç”£æƒ…å ±ãƒ©ã‚¤ãƒ–ãƒ©ãƒª MCP + e-Stat ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨</p>
          </div>
          <div class="flex gap-2">
            ${tabs.map(t => `
              <button data-tab="${t.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-all ${state.view === t.id ? 'tab-active' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                ${t.label}
              </button>
            `).join('')}
          </div>
        </div>
      </div>
    </header>
  `;
}

function renderMCPStatus() {
  const statusColors = {
    disconnected: { bg: 'bg-gray-100', text: 'text-gray-600', dot: 'bg-gray-400' },
    connecting: { bg: 'bg-blue-50', text: 'text-blue-700', dot: 'bg-blue-500' },
    connected: { bg: 'bg-green-50', text: 'text-green-700', dot: 'bg-green-500' },
    error: { bg: 'bg-amber-50', text: 'text-amber-700', dot: 'bg-amber-500' }
  };
  const s = statusColors[state.mcpStatus];
  const statusLabel = { disconnected: 'æœªæ¥ç¶š', connecting: 'æ¥ç¶šä¸­', connected: 'ãƒ©ã‚¤ãƒ–æ¥ç¶š', error: 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯' }[state.mcpStatus];

  return `
    <div class="card p-4 mb-4 flex items-center justify-between flex-wrap gap-3">
      <div class="flex items-center gap-3">
        <div class="status-badge ${s.bg} ${s.text}">
          <span class="pulse-dot ${s.dot}"></span>
          MCP: ${statusLabel}
        </div>
        <span id="mcp-status-text" class="text-sm text-gray-500">${state.mcpMessage || 'MCPã‚µãƒ¼ãƒãƒ¼æœªæ¥ç¶š â€” ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­'}</span>
      </div>
      <div class="flex gap-2">
        ${state.mcpStatus !== 'connected' ? `
          <button id="btn-connect-mcp" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
            ğŸ”Œ MCPã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ï¼‰
          </button>
        ` : `
          <span class="text-xs text-green-600 self-center mr-2">${mcpReinfo?.useProxy ? 'ğŸ”€ ãƒ—ãƒ­ã‚­ã‚·çµŒç”±' : 'ğŸ“¡ ç›´æ¥æ¥ç¶š'}</span>
          <button id="btn-refresh-mcp" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
            ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°
          </button>
        `}
      </div>
    </div>
  `;
}

function renderWeights() {
  const items = [
    { key: 'price', label: 'ä¾¡æ ¼ã®æ‰‹é ƒã•', icon: 'ğŸ’°' },
    { key: 'access', label: 'åå¤å±‹ã‚¢ã‚¯ã‚»ã‚¹', icon: 'ğŸšƒ' },
    { key: 'growth', label: 'è³‡ç”£ä¾¡å€¤ä¸Šæ˜‡', icon: 'ğŸ“ˆ' },
    { key: 'living', label: 'ç”Ÿæ´»åˆ©ä¾¿æ€§', icon: 'ğŸª' },
    { key: 'family', label: 'å­è‚²ã¦ç’°å¢ƒ', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦' },
    { key: 'nature', label: 'è‡ªç„¶ç’°å¢ƒ', icon: 'ğŸŒ¿' }
  ];
  return `
    <div class="card p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ¯ ã‚ãªãŸã®å„ªå…ˆåº¦ã‚’è¨­å®š</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        ${items.map(i => `
          <div class="flex items-center gap-3">
            <span class="text-xl w-8 text-center">${i.icon}</span>
            <div class="flex-1">
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">${i.label}</span>
                <span class="text-sm font-bold text-blue-600" id="wv-${i.key}">${state.weights[i.key]}</span>
              </div>
              <input type="range" min="0" max="50" value="${state.weights[i.key]}" data-weight="${i.key}"
                class="w-full cursor-pointer" style="background: linear-gradient(to right, #3b82f6 0%, #3b82f6 ${state.weights[i.key]*2}%, #e5e7eb ${state.weights[i.key]*2}%, #e5e7eb 100%);">
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderRanking(ranked) {
  const medals = ['medal-gold','medal-silver','medal-bronze'];
  const scoreKeys = [
    { key: 'price', label: 'ä¾¡æ ¼' },
    { key: 'access', label: 'äº¤é€š' },
    { key: 'growth', label: 'æˆé•·' },
    { key: 'living', label: 'åˆ©ä¾¿' },
    { key: 'family', label: 'å­è‚²' },
    { key: 'nature', label: 'è‡ªç„¶' }
  ];

  return `
    <div class="space-y-4 fade-in">
      <h2 class="text-lg font-bold text-gray-800">ğŸ† ãŠã™ã™ã‚ã‚¨ãƒªã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      ${ranked.map((a, idx) => `
        <div class="card p-5 cursor-pointer" data-area-detail="${a.id}">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 flex flex-col items-center w-16">
              <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg ${idx < 3 ? medals[idx] : 'bg-slate-400'}">
                ${idx + 1}
              </div>
              <div class="text-2xl font-bold text-blue-600 mt-1">${a.scores.total}<span class="text-xs text-gray-400 font-normal">pt</span></div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="text-xl font-bold text-gray-900">${a.name}</h3>
                ${a.popGrowthRate > 0 ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">äººå£å¢—åŠ ä¸­</span>' : ''}
                ${a._liveTransactionCount ? `<span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">LIVE ${a._liveTransactionCount}ä»¶</span>` : ''}
              </div>
              <p class="text-sm text-gray-600 mb-3">${a.description}</p>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                  <div class="text-xs text-gray-500">ä½å®…åœ°ä¾¡æ ¼</div>
                  <div class="text-sm font-bold text-blue-700">${(a.residentialPrice/10000).toFixed(1)}ä¸‡/mÂ²</div>
                </div>
                <div class="text-center p-2 bg-green-50 rounded-lg">
                  <div class="text-xs text-gray-500">åå¤å±‹ã¾ã§</div>
                  <div class="text-sm font-bold text-green-700">${a.accessToNagoya}åˆ†</div>
                </div>
                <div class="text-center p-2 bg-amber-50 rounded-lg">
                  <div class="text-xs text-gray-500">åœ°ä¾¡å¤‰å‹•</div>
                  <div class="text-sm font-bold text-amber-700">+${a.yoyChange}%</div>
                </div>
                <div class="text-center p-2 bg-purple-50 rounded-lg">
                  <div class="text-xs text-gray-500">äººå£</div>
                  <div class="text-sm font-bold text-purple-700">${(a.population/10000).toFixed(1)}ä¸‡äºº</div>
                </div>
              </div>
            </div>
            <div class="flex-shrink-0 w-28 space-y-1 hidden sm:block">
              ${scoreKeys.map(s => `
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-400 w-8 text-right">${s.label}</span>
                  <div class="score-bar flex-1"><div class="score-bar-fill bg-blue-500" style="width:${a.scores[s.key]}%"></div></div>
                  <span class="text-xs text-gray-500 w-5 text-right">${a.scores[s.key]}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderCompare(ranked) {
  return `
    <div class="space-y-6 fade-in">
      <h2 class="text-lg font-bold text-gray-800">ğŸ“Š ã‚¨ãƒªã‚¢æ¯”è¼ƒ</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">ä½å®…åœ°ä¾¡æ ¼ Ã— ç·åˆã‚¹ã‚³ã‚¢</h3>
          <canvas id="chart-bar" height="260"></canvas>
        </div>
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">åœ°ä¾¡æ¨ç§»ï¼ˆ2020-2025å¹´ï¼‰</h3>
          <canvas id="chart-trend" height="260"></canvas>
        </div>
      </div>
      <div class="card p-6 overflow-x-auto">
        <h3 class="text-base font-bold text-gray-700 mb-4">å…¨ã‚¨ãƒªã‚¢æ¯”è¼ƒä¸€è¦§</h3>
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-left py-2 px-3 font-medium text-gray-600">ã‚¨ãƒªã‚¢</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">ä½å®…åœ°(å††/mÂ²)</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">åªå˜ä¾¡</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">å¤‰å‹•ç‡</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">åå¤å±‹</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">äººå£</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">ã‚¹ã‚³ã‚¢</th>
            </tr>
          </thead>
          <tbody>
            ${ranked.map((a,i) => `
              <tr class="border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-area-detail="${a.id}">
                <td class="py-3 px-3 font-medium text-gray-900">
                  <span class="inline-flex items-center gap-2">
                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold" style="background:${i<3?'#3b82f6':'#94a3b8'}">${i+1}</span>
                    ${a.name}
                  </span>
                </td>
                <td class="py-3 px-3 text-right">${a.residentialPrice.toLocaleString()}</td>
                <td class="py-3 px-3 text-right">${a.pricePerTsubo.toLocaleString()}</td>
                <td class="py-3 px-3 text-right text-green-600 font-medium">+${a.yoyChange}%</td>
                <td class="py-3 px-3 text-right">${a.accessToNagoya}åˆ†</td>
                <td class="py-3 px-3 text-right">${(a.population/10000).toFixed(1)}ä¸‡</td>
                <td class="py-3 px-3 text-right">
                  <span class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-bold text-xs">${a.scores.total}pt</span>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderDetail(area, ranked) {
  if (!area) return '<p>ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
  const scoreItems = [
    { key: 'price', label: 'ä¾¡æ ¼ã®æ‰‹é ƒã•', color: '#3b82f6' },
    { key: 'access', label: 'åå¤å±‹ã‚¢ã‚¯ã‚»ã‚¹', color: '#10b981' },
    { key: 'growth', label: 'è³‡ç”£ä¾¡å€¤ä¸Šæ˜‡', color: '#f59e0b' },
    { key: 'living', label: 'ç”Ÿæ´»åˆ©ä¾¿æ€§', color: '#ef4444' },
    { key: 'family', label: 'å­è‚²ã¦ç’°å¢ƒ', color: '#8b5cf6' },
    { key: 'nature', label: 'è‡ªç„¶ç’°å¢ƒ', color: '#06b6d4' }
  ];

  return `
    <div class="space-y-6 fade-in">
      <div class="flex items-center gap-3 flex-wrap">
        <button id="btn-back" class="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors">â† æˆ»ã‚‹</button>
        <h2 class="text-lg font-bold text-gray-800">ğŸ” ${area.name} ã®è©³ç´°åˆ†æ</h2>
        <button id="btn-to-map" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-50 transition-colors ml-auto">ğŸ—ºï¸ ãƒãƒƒãƒ—ã§è¡¨ç¤º</button>
      </div>

      <div class="flex flex-wrap gap-2">
        ${ranked.map(a => `
          <button data-area-switch="${a.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-all ${area.id===a.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}">
            ${a.name}
          </button>
        `).join('')}
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ -->
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">ç·åˆè©•ä¾¡</h3>
          <canvas id="chart-radar" height="280"></canvas>
          <div class="text-center mt-4">
            <span class="text-4xl font-bold text-blue-600">${area.scores.total}</span>
            <span class="text-sm text-gray-400 ml-1">/ 100ç‚¹</span>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-4">
            ${scoreItems.map(s => `
              <div class="text-center">
                <div class="text-xs text-gray-500">${s.label}</div>
                <div class="text-lg font-bold" style="color:${s.color}">${area.scores[s.key]}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- åŸºæœ¬æƒ…å ± -->
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">åŸºæœ¬ãƒ‡ãƒ¼ã‚¿</h3>
          <div class="space-y-3">
            ${[
              ['ğŸ  ä½å®…åœ°å¹³å‡', `${area.residentialPrice.toLocaleString()}å††/mÂ²`],
              ['ğŸ’´ åªå˜ä¾¡', `${area.pricePerTsubo.toLocaleString()}å††/åª`],
              ['ğŸ“ˆ å‰å¹´æ¯”å¤‰å‹•', `+${area.yoyChange}%`],
              ['ğŸ‘¥ äººå£', `${area.population.toLocaleString()}äºº`],
              ['ğŸšƒ åå¤å±‹ã¾ã§', `ç´„${area.accessToNagoya}åˆ†`],
              ['ğŸ¥ åŒ»ç™‚æ–½è¨­', `${area.hospitals}æ–½è¨­`],
              ['ğŸ« æ•™è‚²æ–½è¨­', `${area.schools}æ–½è¨­`],
              ['ğŸ› å•†æ¥­æ–½è¨­', `${area.shopping}æ–½è¨­`],
            ].map(([l,v]) => `
              <div class="flex justify-between items-center py-2 border-b border-gray-50">
                <span class="text-sm text-gray-600">${l}</span>
                <span class="text-sm font-bold text-gray-900">${v}</span>
              </div>
            `).join('')}
            ${area._liveAvgTradePrice ? `
              <div class="flex justify-between items-center py-2 border-b border-blue-100 bg-blue-50 rounded px-2 mt-2">
                <span class="text-sm text-blue-600 font-medium">ğŸ”´ LIVE å¹³å‡å–å¼•ä¾¡æ ¼</span>
                <span class="text-sm font-bold text-blue-700">${area._liveAvgTradePrice.toLocaleString()}å††</span>
              </div>
            ` : ''}
          </div>
        </div>
      </div>

      <!-- åœ°ä¾¡æ¨ç§» -->
      <div class="card p-6">
        <h3 class="text-base font-bold text-gray-700 mb-4">åœ°ä¾¡æ¨ç§»</h3>
        <canvas id="chart-detail-trend" height="200"></canvas>
      </div>

      <!-- æ¦‚è¦ãƒ»ãƒã‚¤ãƒ³ãƒˆãƒ»æ³¨æ„ç‚¹ -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-5">
          <h3 class="text-base font-bold text-gray-700 mb-3">ğŸ“ æ¦‚è¦</h3>
          <p class="text-sm text-gray-600 leading-relaxed">${area.description}</p>
        </div>
        <div class="rounded-xl p-5 bg-green-50 border border-green-200">
          <h3 class="text-base font-bold text-green-700 mb-3">âœ… ãƒã‚¤ãƒ³ãƒˆ</h3>
          <ul class="space-y-2">
            ${area.highlights.map(h => `<li class="text-sm text-green-800 flex items-start gap-2"><span class="mt-0.5">â€¢</span>${h}</li>`).join('')}
          </ul>
        </div>
        <div class="rounded-xl p-5 bg-amber-50 border border-amber-200">
          <h3 class="text-base font-bold text-amber-700 mb-3">âš ï¸ æ³¨æ„ç‚¹</h3>
          <ul class="space-y-2">
            ${area.risks.map(r => `<li class="text-sm text-amber-800 flex items-start gap-2"><span class="mt-0.5">â€¢</span>${r}</li>`).join('')}
          </ul>
        </div>
      </div>

      <!-- ãŠã™ã™ã‚ã‚¨ãƒªã‚¢ -->
      <div class="rounded-xl p-6 bg-blue-50 border border-blue-200">
        <h3 class="text-base font-bold text-blue-700 mb-3">ğŸ¯ ${area.name}ã®ãŠã™ã™ã‚ç‰©ä»¶ã‚¨ãƒªã‚¢</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          ${area.recAreas.map((r,i) => `
            <div class="bg-white rounded-lg p-4 border border-blue-100">
              <div class="text-xs text-blue-500 font-medium mb-1">ãŠã™ã™ã‚ ${i+1}</div>
              <div class="text-sm font-medium text-gray-800">${r}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Map View
// ============================================================
function renderMap(ranked) {
  const selArea = state.mapSelectedAreaId ? ranked.find(a => a.id === state.mapSelectedAreaId) : null;
  return `
    <div class="space-y-4 fade-in">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-800">ğŸ—ºï¸ ã‚¨ãƒªã‚¢ãƒãƒƒãƒ—</h2>
        <button id="btn-school-toggle" class="school-toggle ${showSchoolDistricts ? 'active' : ''}" onclick="toggleSchoolDistricts()">
          <span>${showSchoolDistricts ? 'ğŸ« å­¦åŒº ON' : 'ğŸ« å­¦åŒº'}</span>
        </button>
      </div>
      <div class="card overflow-hidden">
        <div class="map-layout" style="position:relative;">
          <div id="map-container"></div>
          <div id="map-loading-overlay" class="map-loading-overlay hidden">
            <div class="map-loading-box">
              <div class="map-loading-spinner"></div>
              <div id="map-loading-text" style="font-size:13px;font-weight:600;color:#1e40af;">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>
              <div class="map-loading-progress"><div id="map-loading-bar" class="map-loading-progress-bar" style="width:0%"></div></div>
            </div>
          </div>
          <div id="map-sidebar">
            ${selArea ? '' : `
              <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="text-4xl mb-3">ğŸ“</div>
                <p class="text-sm font-medium text-gray-700 mb-1">ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                <p class="text-xs text-gray-400">ãƒãƒƒãƒ—ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>åœŸåœ°æƒ…å ±ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
              </div>
            `}
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// School District Layer
// ============================================================
const SCHOOL_DISTRICT_COLORS = [
  '#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316',
  '#14b8a6','#6366f1','#84cc16','#e11d48','#0ea5e9','#a855f7','#10b981','#f43f5e'
];

async function loadSchoolDistrictData() {
  if (schoolDistrictData) return schoolDistrictData;
  try {
    const resp = await fetch('school-districts.geojson');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    schoolDistrictData = await resp.json();
    console.log(`School districts loaded: ${schoolDistrictData.features.length} zones`);
    return schoolDistrictData;
  } catch(e) {
    console.warn('School district data load failed:', e);
    return null;
  }
}

function toggleSchoolDistricts() {
  showSchoolDistricts = !showSchoolDistricts;
  const btn = document.getElementById('btn-school-toggle');
  if (btn) {
    btn.classList.toggle('active', showSchoolDistricts);
    btn.querySelector('span').textContent = showSchoolDistricts ? 'ğŸ« å­¦åŒº ON' : 'ğŸ« å­¦åŒº';
  }
  if (showSchoolDistricts) {
    renderSchoolDistricts();
  } else {
    if (schoolDistrictLayer && mapInstance) {
      mapInstance.removeLayer(schoolDistrictLayer);
      schoolDistrictLayer = null;
    }
    if (schoolMarkerLayer && mapInstance) {
      mapInstance.removeLayer(schoolMarkerLayer);
      schoolMarkerLayer = null;
    }
  }
}

async function renderSchoolDistricts() {
  if (!mapInstance) return;
  const data = await loadSchoolDistrictData();
  if (!data) return;

  // Remove existing layers
  if (schoolDistrictLayer) { mapInstance.removeLayer(schoolDistrictLayer); }
  if (schoolMarkerLayer) { mapInstance.removeLayer(schoolMarkerLayer); }

  // Separate polygons and points
  const polygonFeatures = { type: 'FeatureCollection', features: data.features.filter(f => f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon') };
  const pointFeatures = data.features.filter(f => f.geometry.type === 'Point' && f.properties.type === 'school');

  // Render polygon overlays (school district boundaries)
  let colorIdx = 0;
  schoolDistrictLayer = L.geoJSON(polygonFeatures, {
    style: (feature) => {
      const color = SCHOOL_DISTRICT_COLORS[colorIdx++ % SCHOOL_DISTRICT_COLORS.length];
      return { color, weight: 2, opacity: 0.7, fillColor: color, fillOpacity: 0.08, dashArray: '4 3' };
    },
    onEachFeature: (feature, layer) => {
      const p = feature.properties;
      layer.bindPopup(`
        <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
          <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">ğŸ« ${p.name}</div>
          <table style="font-size:11px;">
            <tr><td style="color:#6b7280;padding-right:8px;">è¨­ç½®è€…</td><td>${p.org}</td></tr>
            <tr><td style="color:#6b7280;padding-right:8px;">æ‰€åœ¨åœ°</td><td>${p.address}</td></tr>
          </table>
        </div>
      `, { maxWidth: 240 });
      layer.on('mouseover', function() { this.setStyle({ fillOpacity: 0.25, weight: 3 }); });
      layer.on('mouseout', function() { this.setStyle({ fillOpacity: 0.08, weight: 2 }); });
    }
  }).addTo(mapInstance);
  schoolDistrictLayer.bringToBack();

  // Render school icon markers
  const schoolIcon = L.divIcon({
    html: '<div style="font-size:20px;text-align:center;line-height:1;filter:drop-shadow(1px 1px 1px rgba(0,0,0,0.3));">ğŸ«</div>',
    className: 'school-icon-marker',
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -14]
  });

  schoolMarkerLayer = L.layerGroup();
  pointFeatures.forEach(f => {
    const p = f.properties;
    const coords = f.geometry.coordinates;
    const marker = L.marker([coords[1], coords[0]], { icon: schoolIcon, zIndexOffset: 500 });
    marker.bindPopup(`
      <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
        <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">ğŸ« ${p.name}</div>
        <table style="font-size:11px;">
          <tr><td style="color:#6b7280;padding-right:8px;">è¨­ç½®è€…</td><td>${p.org}</td></tr>
          <tr><td style="color:#6b7280;padding-right:8px;">æ‰€åœ¨åœ°</td><td>${p.address}</td></tr>
        </table>
      </div>
    `, { maxWidth: 240 });
    schoolMarkerLayer.addLayer(marker);
  });
  schoolMarkerLayer.addTo(mapInstance);
}

function initializeMap(ranked) {
  const container = document.getElementById('map-container');
  if (!container || !window.L) return;

  // Destroy existing map if present (container re-created by render)
  if (mapInstance) {
    try { mapInstance.remove(); } catch {}
    mapInstance = null;
    mapMarkers = {};
    txMarkerLayer = null;
  }

  // Create map centered on northern Mie
  mapInstance = L.map('map-container', { zoomControl: true }).setView([34.98, 136.56], 10);

  // OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>',
    maxZoom: 18
  }).addTo(mapInstance);

  // Transaction marker layer
  txMarkerLayer = L.layerGroup().addTo(mapInstance);

  // Create city markers
  ranked.forEach((area, idx) => {
    const color = COLORS[AREAS.findIndex(a => a.id === area.id) % COLORS.length];
    const rank = idx + 1;
    const icon = createMapIcon(color, rank, area.scores.total, area.id === state.mapSelectedAreaId);

    const marker = L.marker([area.lat, area.lng], { icon, zIndexOffset: 1000 })
      .addTo(mapInstance);

    marker.bindTooltip(`${area.name} (${area.scores.total}pt)`, {
      direction: 'top', offset: [0, -20], className: 'map-tooltip'
    });

    marker.on('click', () => {
      state.mapSelectedAreaId = area.id;
      ranked.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, a.id === area.id));
      });
      updateMapSidebar(area, ranked);
      showTransactionPins(area);
      mapInstance.flyTo([area.lat, area.lng], 13, { duration: 0.8 });

      // Auto-fetch full data for this area if not yet loaded
      if (!AREA_FULL_LOADED.has(area.id) && mcpReinfo && mcpReinfo.connected) {
        fetchAreaFullData(area.id);
      }
    });

    mapMarkers[area.id] = marker;
  });

  // Show all transaction pins at overview
  showAllTransactionPins(ranked);

  // Restore school district layer if enabled
  if (showSchoolDistricts) {
    renderSchoolDistricts();
  }

  // If area already selected, zoom to it and auto-fetch full data
  if (state.mapSelectedAreaId) {
    const sel = ranked.find(a => a.id === state.mapSelectedAreaId);
    if (sel) {
      showTransactionPins(sel);
      mapInstance.setView([sel.lat, sel.lng], 13);
      if (!AREA_FULL_LOADED.has(sel.id) && mcpReinfo && mcpReinfo.connected) {
        fetchAreaFullData(sel.id);
      }
    }
  }
}

// ============================================================
// Station Coordinate Database (Northern Mie Prefecture)
// ============================================================
const STATION_COORDS = {
  // å››æ—¥å¸‚å¸‚
  'è¿‘é‰„å››æ—¥å¸‚':[34.9665,136.6142],'å››æ—¥å¸‚':[34.9667,136.6186],'å¯Œç”°':[34.989,136.6266],
  'å¯Œæ´²åŸ':[34.997,136.631],'é˜¿å€‰å·':[34.976,136.6175],'å·åŸç”º':[34.972,136.6153],
  'æ–°æ­£':[34.962,136.6154],'èµ¤å €':[34.958,136.6156],'æ—¥æ°¸':[34.944,136.6088],
  'å—æ—¥æ°¸':[34.952,136.612],'æ³Š':[34.938,136.611],'è¿½åˆ†':[34.934,136.605],
  'å†…éƒ¨':[34.928,136.5925],'å°å¤æ›½':[34.936,136.599],'æ²³åŸç”°':[34.912,136.5814],
  'å¡©æµœ':[34.938,136.6217],'æµ·å±±é“':[34.956,136.6238],'éœãƒ¶æµ¦':[34.957,136.6262],
  'å¤§çŸ¢çŸ¥':[34.997,136.628],'å¹³æ´¥':[34.996,136.618],'æšå­¦åœ’å‰':[34.993,136.608],
  'å±±åŸ':[34.981,136.5936],'ä¿ã€…':[34.991,136.582],'åŒ—æ¥ ':[34.918,136.61],
  'æ¥ ':[34.912,136.615],'å—å››æ—¥å¸‚':[34.947,136.62],'ä¸­å·åŸ':[34.961,136.607],
  'ä¼Šå‹¢æ¾æœ¬':[34.969,136.601],'è¥¿æ—¥é‡':[34.95,136.597],'è¿‘é‰„å¯Œç”°':[34.988,136.622],
  // æ¡‘åå¸‚
  'æ¡‘å':[35.0614,136.6918],'æ’­ç£¨':[35.046,136.677],'ç›Šç”Ÿ':[35.066,136.6785],
  'é¦¬é“':[35.06,136.686],'è¥¿æ¡‘å':[35.062,136.686],'åœ¨è‰¯':[35.073,136.676],
  'æ˜Ÿå·':[35.081,136.671],'ä¸ƒå’Œ':[35.087,136.659],'ç©´å¤ª':[35.091,136.65],
  'å¤šåº¦':[35.117,136.629],'é•·å³¶':[35.076,136.715],'è“®èŠ±å¯º':[35.078,136.665],
  'ä¸‹æ·±è°·':[35.039,136.669],'ä¼Šå‹¢æœæ—¥':[35.032,136.669],
  // éˆ´é¹¿å¸‚
  'ç™½å­':[34.843,136.611],'éˆ´é¹¿':[34.871,136.543],'éˆ´é¹¿å¸‚':[34.881,136.581],
  'ä¸‰æ—¥å¸‚':[34.874,136.577],'å¹³ç”°ç”º':[34.876,136.559],'åŠ ä½ç™»':[34.886,136.523],
  'ç‰å£':[34.855,136.601],'æŸ³':[34.848,136.599],'ç£¯å±±':[34.836,136.615],
  'åƒä»£å´':[34.831,136.617],'ç®•ç”°':[34.863,136.593],'é¼“ãƒ¶æµ¦':[34.838,136.613],
  'å¾³ç”°':[34.884,136.559],'ä¼Šå‹¢è‹¥æ¾':[34.856,136.608],'åƒé‡Œ':[34.887,136.506],
  'ä¸­ç€¬å¤':[34.866,136.571],
  // ã„ãªã¹å¸‚
  'ä¸‰é‡Œ':[35.093,136.554],'åŒ—å‹¢ä¸­å¤®å…¬åœ’å£':[35.087,136.548],'éº»ç”Ÿç”°':[35.099,136.548],
  'é˜¿ä¸‹å–œ':[35.126,136.549],'æ¥šåŸ':[35.116,136.549],'å¤§æ³‰':[35.108,136.554],
  'æ¢…æˆ¸äº•':[35.084,136.551],
  // äº€å±±å¸‚
  'äº€å±±':[34.855,136.449],'é–¢':[34.855,136.397],'åŠ å¤ª':[34.85,136.355],
  'äº•ç”°å·':[34.874,136.489],
  // è°é‡ç”º
  'è°é‡':[35.017,136.516],'ä¸­è°é‡':[35.024,136.509],'å¤§ç¾½æ ¹åœ’':[35.029,136.502],
  'æ¹¯ã®å±±æ¸©æ³‰':[35.036,136.486],'æ¡œ':[35.009,136.528],
  // æ±å“¡ç”º
  'æ±å“¡':[35.06,136.595],'å¤§é•·':[35.066,136.589],'åŒ—å¤§ç¤¾':[35.073,136.592],
};

function findStationCoords(stationName) {
  if (!stationName) return null;
  if (STATION_COORDS[stationName]) return STATION_COORDS[stationName];
  const cleaned = stationName.replace(/é§…$/, '').replace(/\(.*\)/, '').trim();
  if (STATION_COORDS[cleaned]) return STATION_COORDS[cleaned];
  for (const [key, coords] of Object.entries(STATION_COORDS)) {
    if (cleaned.includes(key) || key.includes(cleaned)) return coords;
  }
  return null;
}

// ============================================================
// District Geocoding (Nominatim + localStorage cache)
// ============================================================
const DISTRICT_CACHE = new Map();
const DISTRICT_CACHE_KEY = 'mie-realestate-district-coords-v2';

// Load cached coords from localStorage on startup
function loadDistrictCache() {
  try {
    const stored = localStorage.getItem(DISTRICT_CACHE_KEY);
    if (!stored) return;
    const obj = JSON.parse(stored);
    for (const [k, v] of Object.entries(obj)) {
      DISTRICT_CACHE.set(k, v);
    }
    console.log(`District cache loaded: ${DISTRICT_CACHE.size} entries`);
  } catch(e) { console.warn('Cache load failed:', e); }
}

function saveDistrictCache() {
  try {
    const obj = {};
    for (const [k, v] of DISTRICT_CACHE.entries()) obj[k] = v;
    localStorage.setItem(DISTRICT_CACHE_KEY, JSON.stringify(obj));
  } catch(e) { console.warn('Cache save failed:', e); }
}

async function geocodeDistrict(district, cityName) {
  const cacheKey = `${cityName}-${district}`;
  if (DISTRICT_CACHE.has(cacheKey)) return DISTRICT_CACHE.get(cacheKey);

  // Try GSI (å›½åœŸåœ°ç†é™¢) API first, then Nominatim as fallback
  const queries = [
    `ä¸‰é‡çœŒ${cityName}${district}`,
    `${cityName}${district}`,
  ];

  // GSI API (more reliable for Japanese addresses)
  for (const q of queries) {
    try {
      const url = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(q)}`;
      const resp = await fetch(url);
      if (!resp.ok) continue;
      const results = await resp.json();
      if (results.length > 0) {
        const coords_arr = results[0].geometry.coordinates; // [lng, lat]
        const lat = parseFloat(coords_arr[1]);
        const lng = parseFloat(coords_arr[0]);
        if (lat >= 34.2 && lat <= 35.5 && lng >= 135.8 && lng <= 137.0) {
          const coords = [lat, lng];
          DISTRICT_CACHE.set(cacheKey, coords);
          return coords;
        }
      }
    } catch(e) { /* skip */ }
  }

  // Nominatim fallback
  const nomQueries = [`${district}, ${cityName}, ä¸‰é‡çœŒ`, `${district}, ${cityName}`];
  for (const q of nomQueries) {
    try {
      const url = `https://nominatim.openstreetmap.org/search?` +
        `q=${encodeURIComponent(q)}&format=json&limit=1&countrycodes=jp`;
      const resp = await fetch(url, {
        headers: { 'User-Agent': 'MieRealEstateApp/1.0' }
      });
      if (!resp.ok) continue;
      const results = await resp.json();
      if (results.length > 0) {
        const lat = parseFloat(results[0].lat);
        const lng = parseFloat(results[0].lon);
        if (lat >= 34.2 && lat <= 35.5 && lng >= 135.8 && lng <= 137.0) {
          const coords = [lat, lng];
          DISTRICT_CACHE.set(cacheKey, coords);
          return coords;
        }
      }
    } catch(e) { /* skip */ }
  }

  // Mark as not found so we don't retry
  DISTRICT_CACHE.set(cacheKey, null);
  return null;
}

// Background geocoding - doesn't block UI
async function geocodeDistrictsBackground() {
  // Collect uncached district+city pairs
  const uncached = [];
  for (const area of AREAS) {
    if (!area._liveTransactions) continue;
    for (const tx of area._liveTransactions) {
      if (!tx.District) continue;
      const key = `${area.name}-${tx.District}`;
      if (!DISTRICT_CACHE.has(key) && !uncached.find(u => u.key === key)) {
        uncached.push({ key, district: tx.District, cityName: area.name });
      }
    }
  }

  if (uncached.length === 0) return;

  const total = uncached.length;
  let done = 0;

  for (const { district, cityName } of uncached) {
    done++;
    updateStatusText(`åœ°åŒºã®ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­... (${done}/${total})`);
    await geocodeDistrict(district, cityName);
    // Save every 5 results
    if (done % 5 === 0) saveDistrictCache();
    // Rate limit: 300ms between requests (GSI API is less restrictive than Nominatim)
    if (done < total) await new Promise(r => setTimeout(r, 300));
  }

  saveDistrictCache();

  // Refresh map pins with newly geocoded positions
  updateStatusText(`ä½ç½®æƒ…å ±å–å¾—å®Œäº† (${done}ä»¶) â€” ãƒ”ãƒ³ã‚’æ›´æ–°ä¸­...`);
  if (state.view === 'map' && txMarkerLayer) {
    const ranked = getRankedAreas();
    if (state.mapSelectedAreaId) {
      const sel = ranked.find(a => a.id === state.mapSelectedAreaId);
      if (sel) showTransactionPins(sel);
    } else {
      showAllTransactionPins(ranked);
    }
  }

  const cached = Array.from(DISTRICT_CACHE.values()).filter(v => v !== null).length;
  updateStatusText(`ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº† â€” åœ°åŒºä½ç½®: ${cached}ä»¶è§£æ±ºæ¸ˆã¿`);
}

function findDistrictCoords(district, cityName) {
  if (!district || !cityName) return null;
  const key = `${cityName}-${district}`;
  return DISTRICT_CACHE.get(key) || null;
}

function hashStr(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) {
    h = ((h << 5) - h + s.charCodeAt(i)) | 0;
  }
  return Math.abs(h);
}

function estimateTxPosition(area, tx, idx) {
  // Priority 1: District geocoded coords (most accurate for this data)
  const districtCoords = findDistrictCoords(tx.District, area.name);
  if (districtCoords) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.001 + (idx % 7) * 0.0005;
    return {
      lat: districtCoords[0] + Math.cos(jitterAngle) * jitter,
      lng: districtCoords[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 2: Station coordinates (from NearestStation field)
  const stationCoords = findStationCoords(tx.NearestStation);
  if (stationCoords) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.0008 + (idx % 5) * 0.0004;
    return {
      lat: stationCoords[0] + Math.cos(jitterAngle) * jitter,
      lng: stationCoords[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 3: District name â†’ fuzzy match against station names
  const stationFromDistrict = findStationCoords(tx.District);
  if (stationFromDistrict) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.0015 + (idx % 7) * 0.0005;
    return {
      lat: stationFromDistrict[0] + Math.cos(jitterAngle) * jitter,
      lng: stationFromDistrict[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 4: Fallback - bias inland from city center
  const districtKey = tx.District || tx.NearestStation || `tx-${idx}`;
  const hash = hashStr(districtKey + area.id);
  const baseAngle = 150 + (hash % 200);
  const angle = baseAngle * (Math.PI / 180);
  const spread = 0.004 + (hash % 40) / 40 * 0.012;
  const baseLat = area.lat + Math.cos(angle) * spread;
  const baseLng = area.lng + Math.sin(angle) * spread;

  const jitterAngle = (idx * 137.508) * (Math.PI / 180);
  const jitter = 0.0008 + (idx % 5) * 0.0004;

  return {
    lat: baseLat + Math.cos(jitterAngle) * jitter,
    lng: baseLng + Math.sin(jitterAngle) * jitter
  };
}

// Get color based on price (green=cheap, yellow=mid, red=expensive)
function priceColor(price) {
  if (!price) return '#9ca3af';
  if (price < 5000000) return '#22c55e';    // green: <500ä¸‡
  if (price < 15000000) return '#3b82f6';   // blue: 500-1500ä¸‡
  if (price < 30000000) return '#f59e0b';   // amber: 1500-3000ä¸‡
  if (price < 50000000) return '#ef4444';   // red: 3000-5000ä¸‡
  return '#7c3aed';                          // purple: >5000ä¸‡
}

function showAllTransactionPins(ranked) {
  if (!txMarkerLayer) return;
  txMarkerLayer.clearLayers();

  ranked.forEach(area => {
    if (!area._liveTransactions) return;
    const color = COLORS[AREAS.findIndex(a => a.id === area.id) % COLORS.length];
    area._liveTransactions.forEach((tx, i) => {
      if (!tx.TradePrice) return;
      const pos = estimateTxPosition(area, tx, i);
      const cm = L.circleMarker([pos.lat, pos.lng], {
        radius: 5,
        fillColor: priceColor(tx.TradePrice),
        color: '#fff',
        weight: 1,
        opacity: 0.8,
        fillOpacity: 0.6
      });
      cm.bindPopup(buildTxPopup(tx, area.name), { maxWidth: 220 });
      txMarkerLayer.addLayer(cm);
    });
  });
}

// Map loading overlay controls
function showMapLoading(areaName, pct) {
  const overlay = document.getElementById('map-loading-overlay');
  if (!overlay) return;
  overlay.classList.remove('hidden');
  updateMapLoading(areaName, pct);
}

function updateMapLoading(label, pct) {
  const textEl = document.getElementById('map-loading-text');
  const barEl = document.getElementById('map-loading-bar');
  if (textEl) textEl.textContent = label;
  if (barEl) barEl.style.width = pct + '%';
}

function hideMapLoading() {
  const overlay = document.getElementById('map-loading-overlay');
  if (overlay) overlay.classList.add('hidden');
}

// Transaction pin index for sidebar click â†’ map navigation
let txMarkersByIdx = {};

function showTransactionPins(area) {
  if (!txMarkerLayer) return;
  txMarkerLayer.clearLayers();
  txMarkersByIdx = {};

  if (!area._liveTransactions) return;

  area._liveTransactions.forEach((tx, i) => {
    if (!tx.TradePrice) return;
    const pos = estimateTxPosition(area, tx, i);
    const cm = L.circleMarker([pos.lat, pos.lng], {
      radius: 7,
      fillColor: priceColor(tx.TradePrice),
      color: '#fff',
      weight: 1.5,
      opacity: 0.9,
      fillOpacity: 0.7
    });
    cm.bindPopup(buildTxPopup(tx, area.name), { maxWidth: 240 });
    txMarkerLayer.addLayer(cm);
    txMarkersByIdx[i] = { marker: cm, pos };
  });
}

// Navigate map to a specific transaction pin and open popup
function flyToTransaction(idx) {
  const entry = txMarkersByIdx[idx];
  if (!entry || !mapInstance) return;
  mapInstance.flyTo([entry.pos.lat, entry.pos.lng], 16, { duration: 0.6 });
  setTimeout(() => {
    entry.marker.setRadius(12);
    entry.marker.openPopup();
    setTimeout(() => entry.marker.setRadius(7), 2000);
  }, 650);
}

function buildTxPopup(tx, cityName) {
  const priceStr = tx.TradePrice >= 10000
    ? `${(tx.TradePrice/10000).toFixed(0)}ä¸‡å††`
    : `${tx.TradePrice.toLocaleString()}å††`;
  return `
    <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
      <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">${priceStr}</div>
      <table style="font-size:11px;">
        ${tx.District ? `<tr><td style="color:#6b7280;padding-right:8px;">åœ°åŒº</td><td>${tx.District}</td></tr>` : ''}
        ${tx.Area ? `<tr><td style="color:#6b7280;padding-right:8px;">é¢ç©</td><td>${tx.Area}mÂ²</td></tr>` : ''}
        ${tx.Type || tx.Use ? `<tr><td style="color:#6b7280;padding-right:8px;">ç¨®åˆ¥</td><td>${tx.Type || tx.Use}</td></tr>` : ''}
        ${tx.NearestStation ? `<tr><td style="color:#6b7280;padding-right:8px;">æœ€å¯„é§…</td><td>${tx.NearestStation}${tx.DistanceToStation ? ` (${tx.DistanceToStation})` : ''}</td></tr>` : ''}
        ${tx.BuildingYear ? `<tr><td style="color:#6b7280;padding-right:8px;">ç¯‰å¹´</td><td>${tx.BuildingYear}</td></tr>` : ''}
        ${tx.Structure ? `<tr><td style="color:#6b7280;padding-right:8px;">æ§‹é€ </td><td>${tx.Structure}</td></tr>` : ''}
      </table>
      <div style="font-size:10px;color:#9ca3af;margin-top:4px;">${cityName}</div>
    </div>`;
}

function createMapIcon(color, rank, score, isSelected) {
  const size = isSelected ? 48 : 40;
  const borderWidth = isSelected ? 3 : 2;
  const shadow = isSelected ? 'filter: drop-shadow(0 2px 6px rgba(0,0,0,0.3));' : 'filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));';
  const svgString = `
    <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg" style="${shadow}">
      <circle cx="${size/2}" cy="${size/2}" r="${size/2-2}" fill="${color}" opacity="0.9" stroke="white" stroke-width="${borderWidth}"/>
      <text x="${size/2}" y="${size/2-2}" text-anchor="middle" fill="white" font-size="${isSelected ? 11 : 10}" font-weight="500" font-family="sans-serif">${rank}ä½</text>
      <text x="${size/2}" y="${size/2+10}" text-anchor="middle" fill="white" font-size="${isSelected ? 13 : 11}" font-weight="700" font-family="sans-serif">${score}</text>
    </svg>`;
  return L.icon({
    iconUrl: 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString))),
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2],
    tooltipAnchor: [0, -size/2]
  });
}

function updateMapSidebar(area, ranked) {
  const sidebar = document.getElementById('map-sidebar');
  if (!sidebar) return;

  const rank = ranked.findIndex(a => a.id === area.id) + 1;
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const medalStr = rank <= 3 ? medals[rank-1] : `${rank}ä½`;

  const isFullLoaded = AREA_FULL_LOADED.has(area.id);
  const isFetching = _currentFetchAreaId === area.id;
  const txCount = area._liveTransactions ? area._liveTransactions.length : 0;

  const loadingBadge = isFetching
    ? '<span class="inline-flex items-center gap-1 text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full mb-2"><span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</span>'
    : isFullLoaded
      ? `<span class="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded-full mb-2">âœ… å…¨æœŸé–“ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆã¿ï¼ˆ${txCount}ä»¶ï¼‰</span>`
      : `<span class="text-xs text-gray-400 mb-2">æ¦‚è¦ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼ˆ${txCount}ä»¶ï¼‰</span>`;

  const txSection = txCount > 0
    ? renderTransactionList(area._liveTransactions)
    : (state.mcpStatus === 'connected'
      ? '<p class="text-xs text-gray-400 mt-2">å–å¼•ãƒ‡ãƒ¼ã‚¿ãªã—</p>'
      : '<p class="text-xs text-gray-400 mt-2">MCPã«æ¥ç¶šã™ã‚‹ã¨å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>');

  sidebar.innerHTML = `
    <div class="sidebar-header">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-xl">${medalStr}</span>
          <h3 class="text-lg font-bold text-gray-900">${area.name}</h3>
        </div>
        <span class="text-2xl font-bold text-blue-600">${area.scores.total}<span class="text-xs font-normal text-gray-400">pt</span></span>
      </div>
    </div>
    <div class="sidebar-body space-y-4">
      ${loadingBadge}
      <!-- Key metrics -->
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-blue-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">ä½å®…åœ°ä¾¡æ ¼</div>
          <div class="text-sm font-bold text-blue-700">${(area.residentialPrice/10000).toFixed(1)}ä¸‡/mÂ²</div>
        </div>
        <div class="bg-green-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">åå¤å±‹ã¾ã§</div>
          <div class="text-sm font-bold text-green-700">${area.accessToNagoya}åˆ†</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">åœ°ä¾¡å¤‰å‹•</div>
          <div class="text-sm font-bold text-amber-700">+${area.yoyChange}%</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">äººå£</div>
          <div class="text-sm font-bold text-purple-700">${(area.population/10000).toFixed(1)}ä¸‡äºº</div>
        </div>
      </div>

      <!-- Live average price -->
      ${area._liveAvgTradePrice ? `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center gap-2 mb-1">
            <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
            <span class="text-xs font-medium text-blue-700">LIVE å¹³å‡å–å¼•ä¾¡æ ¼</span>
          </div>
          <div class="text-lg font-bold text-blue-800">${(area._liveAvgTradePrice / 10000).toFixed(0)}ä¸‡å††</div>
          <div class="text-xs text-blue-500">${area._liveTransactionCount}ä»¶ã®å–å¼•ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç®—å‡º</div>
        </div>
      ` : ''}

      <!-- Description -->
      <div>
        <p class="text-xs text-gray-600 leading-relaxed">${area.description}</p>
      </div>

      <!-- Highlights -->
      <div class="bg-green-50 rounded-lg p-3">
        <div class="text-xs font-bold text-green-700 mb-2">âœ… ãƒã‚¤ãƒ³ãƒˆ</div>
        ${area.highlights.map(h => `<div class="text-xs text-green-800 mb-1">â€¢ ${h}</div>`).join('')}
      </div>

      <!-- Transaction data -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs font-bold text-gray-700">ğŸ“Š å–å¼•ãƒ‡ãƒ¼ã‚¿</div>
          <div class="text-xs text-gray-400">${area._liveTransactions ? area._liveTransactions.length + 'ä»¶' : ''}</div>
        </div>
        ${txSection}
        ${area._liveTransactions && area._liveTransactions.length > 0 ? `
          <div class="mt-2 flex flex-wrap gap-1 items-center">
            <span class="text-xs text-gray-400">å‡¡ä¾‹:</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#22c55e;display:inline-block;"></span>~500ä¸‡</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#3b82f6;display:inline-block;"></span>~1500ä¸‡</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#f59e0b;display:inline-block;"></span>~3000ä¸‡</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;"></span>~5000ä¸‡</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#7c3aed;display:inline-block;"></span>5000ä¸‡~</span>
          </div>
        ` : ''}
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2">
        <button data-map-to-detail="${area.id}" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors text-center">
          ğŸ” è©³ç´°ã‚’è¦‹ã‚‹
        </button>
        <button data-map-zoom-out class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors">
          ğŸ—ºï¸ å…¨ä½“è¡¨ç¤º
        </button>
      </div>
    </div>
  `;

  // Bind sidebar buttons
  const detailBtn = sidebar.querySelector('[data-map-to-detail]');
  if (detailBtn) {
    detailBtn.addEventListener('click', () => {
      state.selectedAreaId = area.id;
      state.view = 'detail';
      render();
    });
  }

  const zoomOutBtn = sidebar.querySelector('[data-map-zoom-out]');
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = null;
      if (mapInstance) mapInstance.flyTo([34.98, 136.56], 10, { duration: 0.8 });
      // Reset marker icons
      const ranked2 = getRankedAreas();
      ranked2.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        if (mapMarkers[a.id]) mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, false));
      });
      // Show all transaction pins again
      showAllTransactionPins(ranked2);
      // Reset sidebar
      sidebar.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full text-center p-8">
          <div class="text-4xl mb-3">ğŸ“</div>
          <p class="text-sm font-medium text-gray-700 mb-1">ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
          <p class="text-xs text-gray-400">ãƒãƒƒãƒ—ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>åœŸåœ°æƒ…å ±ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>`;
    });
  }

  // Bind transaction row clicks â†’ fly to map pin
  sidebar.querySelectorAll('tr[data-tx-idx]').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.txIdx);
      // Highlight active row
      sidebar.querySelectorAll('tr.tx-active').forEach(r => r.classList.remove('tx-active'));
      row.classList.add('tx-active');
      // Fly to pin
      flyToTransaction(idx);
    });
  });
}

function renderTransactionList(transactions) {
  if (!transactions || transactions.length === 0) return '';

  // Keep original index for map pin reference
  const indexed = transactions.map((t, i) => ({ ...t, _origIdx: i }));
  const validTx = indexed.filter(t => t.TradePrice);
  if (validTx.length === 0) return '<p class="text-xs text-gray-400">ä¾¡æ ¼æƒ…å ±ãªã—</p>';

  // Sort by price descending
  validTx.sort((a, b) => (b.TradePrice || 0) - (a.TradePrice || 0));

  return `
    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
      <table class="tx-table">
        <thead>
          <tr>
            <th>ä¾¡æ ¼</th>
            <th>é¢ç©</th>
            <th>åœ°åŒº</th>
            <th>æœ€å¯„é§…</th>
          </tr>
        </thead>
        <tbody>
          ${validTx.map(t => `
            <tr data-tx-idx="${t._origIdx}" title="ã‚¯ãƒªãƒƒã‚¯ã§åœ°å›³ä¸Šã®ãƒ”ãƒ³ã¸ç§»å‹•">
              <td class="font-medium" style="color:${priceColor(t.TradePrice)}">${t.TradePrice >= 10000 ? (t.TradePrice/10000).toFixed(0) + 'ä¸‡' : t.TradePrice.toLocaleString() + 'å††'}</td>
              <td>${t.Area ? t.Area + 'mÂ²' : '-'}</td>
              <td class="text-gray-500" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.District || '-'}</td>
              <td class="text-gray-500" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.NearestStation || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function renderFooter() {
  return `
    <footer class="mt-8 py-6 border-t border-gray-200">
      <div class="text-center space-y-2">
        <p class="text-xs text-gray-400">
          ãƒ‡ãƒ¼ã‚¿å‡ºå…¸: å›½åœŸäº¤é€šçœ ä¸å‹•ç”£æƒ…å ±ãƒ©ã‚¤ãƒ–ãƒ©ãƒªAPI / ç·å‹™çœ e-Stat APIï¼ˆ2025å¹´å…¬ç¤ºåœ°ä¾¡ãƒ™ãƒ¼ã‚¹ï¼‰
        </p>
        <p class="text-xs text-gray-400">
          MCPæ¥ç¶šå…ˆ: <code class="bg-gray-100 px-1 rounded">mcp.n-3.ai</code> (reinfolib-real-estate-price, reinfolib-city-list)
        </p>
        <p class="text-xs text-gray-400">
          â€» æœ¬ãƒ„ãƒ¼ãƒ«ã¯å‚è€ƒæƒ…å ±ã§ã‚ã‚Šã€ä¸å‹•ç”£è³¼å…¥ã®æœ€çµ‚åˆ¤æ–­ã¯å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„
        </p>
        <p class="text-xs text-gray-300 mt-3">Â© å¤¢ã®ã™ã¿ã‹ â€” Powered by MCP + è¡Œæ”¿ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿</p>
      </div>
    </footer>
  `;
}

// ============================================================
// Chart Drawing (Chart.js)
// ============================================================
function destroyCharts() {
  Object.values(state.charts).forEach(c => { try { c.destroy(); } catch {} });
  state.charts = {};
}

function drawCompareCharts(ranked) {
  destroyCharts();

  // Bar chart: price vs score
  const barCtx = document.getElementById('chart-bar');
  if (barCtx) {
    state.charts.bar = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: ranked.map(a => a.name),
        datasets: [
          {
            label: 'ä½å®…åœ°ä¾¡æ ¼ (å††/mÂ²)',
            data: ranked.map(a => a.residentialPrice),
            backgroundColor: ranked.map((_,i) => COLORS[i % COLORS.length] + '88'),
            borderColor: ranked.map((_,i) => COLORS[i % COLORS.length]),
            borderWidth: 1,
            yAxisID: 'y',
            borderRadius: 6,
          },
          {
            label: 'ç·åˆã‚¹ã‚³ã‚¢',
            data: ranked.map(a => a.scores.total),
            backgroundColor: '#94a3b8' + '66',
            borderColor: '#94a3b8',
            borderWidth: 1,
            yAxisID: 'y1',
            borderRadius: 6,
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
        scales: {
          y: { position: 'left', title: { display: true, text: 'å††/mÂ²', font: { size: 11 } }, ticks: { font: { size: 10 } } },
          y1: { position: 'right', title: { display: true, text: 'ã‚¹ã‚³ã‚¢', font: { size: 11 } }, grid: { drawOnChartArea: false }, ticks: { font: { size: 10 } } }
        }
      }
    });
  }

  // Line chart: trends
  const trendCtx = document.getElementById('chart-trend');
  if (trendCtx) {
    state.charts.trend = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: ['2020','2021','2022','2023','2024','2025'],
        datasets: AREAS.map((a,i) => ({
          label: a.name,
          data: a.trend.map(t => t.p),
          borderColor: COLORS[i % COLORS.length],
          backgroundColor: COLORS[i % COLORS.length] + '15',
          borderWidth: 2,
          pointRadius: 3,
          tension: 0.3,
          fill: false
        }))
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
        scales: {
          y: { title: { display: true, text: 'å††/mÂ²', font: { size: 11 } }, ticks: { font: { size: 10 } } }
        }
      }
    });
  }
}

function drawDetailCharts(area) {
  destroyCharts();

  // Radar chart
  const radarCtx = document.getElementById('chart-radar');
  if (radarCtx) {
    state.charts.radar = new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: ['ä¾¡æ ¼', 'äº¤é€š', 'æˆé•·æ€§', 'åˆ©ä¾¿æ€§', 'å­è‚²ã¦', 'è‡ªç„¶'],
        datasets: [{
          label: area.name,
          data: [area.scores.price, area.scores.access, area.scores.growth, area.scores.living, area.scores.family, area.scores.nature],
          backgroundColor: '#3b82f6' + '30',
          borderColor: '#3b82f6',
          borderWidth: 2,
          pointBackgroundColor: '#3b82f6',
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          r: {
            beginAtZero: true, max: 100,
            ticks: { font: { size: 10 }, stepSize: 20 },
            pointLabels: { font: { size: 12 } }
          }
        }
      }
    });
  }

  // Detail trend line
  const trendCtx = document.getElementById('chart-detail-trend');
  if (trendCtx) {
    state.charts.detailTrend = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: area.trend.map(t => t.y),
        datasets: [{
          label: `${area.name} åœ°ä¾¡æ¨ç§»`,
          data: area.trend.map(t => t.p),
          borderColor: '#3b82f6',
          backgroundColor: '#3b82f6' + '15',
          borderWidth: 3,
          pointRadius: 5,
          pointBackgroundColor: '#3b82f6',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { title: { display: true, text: 'å††/mÂ²', font: { size: 11 } } }
        }
      }
    });
  }
}

// ============================================================
// Event Binding
// ============================================================
function bindEvents(ranked) {
  // Tab switches
  document.querySelectorAll('[data-tab]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.view = btn.dataset.tab;
      if (state.view === 'detail' && !state.selectedAreaId) {
        state.selectedAreaId = ranked[0]?.id;
      }
      render();
    });
  });

  // Weight sliders
  document.querySelectorAll('input[data-weight]').forEach(slider => {
    slider.addEventListener('input', (e) => {
      const key = e.target.dataset.weight;
      const val = parseInt(e.target.value);
      state.weights[key] = val;
      const vEl = document.getElementById(`wv-${key}`);
      if (vEl) vEl.textContent = val;
      e.target.style.background = `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${val*2}%, #e5e7eb ${val*2}%, #e5e7eb 100%)`;
      // Debounced re-render for ranking
      clearTimeout(state._renderTimeout);
      state._renderTimeout = setTimeout(() => render(), 150);
    });
  });

  // Area detail click
  document.querySelectorAll('[data-area-detail]').forEach(el => {
    el.addEventListener('click', () => {
      state.selectedAreaId = el.dataset.areaDetail;
      state.view = 'detail';
      render();
    });
  });

  // Area switch buttons
  document.querySelectorAll('[data-area-switch]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.selectedAreaId = btn.dataset.areaSwitch;
      render();
    });
  });

  // Back button
  const backBtn = document.getElementById('btn-back');
  if (backBtn) backBtn.addEventListener('click', () => { state.view = 'ranking'; render(); });

  // MCP connect button
  const connectBtn = document.getElementById('btn-connect-mcp');
  if (connectBtn) connectBtn.addEventListener('click', connectMCP);

  // MCP refresh button
  const refreshBtn = document.getElementById('btn-refresh-mcp');
  if (refreshBtn) refreshBtn.addEventListener('click', fetchLiveData);

  // Detail â†’ Map button
  const toMapBtn = document.getElementById('btn-to-map');
  if (toMapBtn) {
    toMapBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = state.selectedAreaId;
      state.view = 'map';
      render();
    });
  }
}

// ============================================================
// Initialize
// ============================================================
loadDistrictCache();
render();
</script>
</body>
</html>
