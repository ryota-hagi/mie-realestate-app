<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="VBmM5Mikm2LrkY9dXa30MUHtT9KD2SpZFsoGHBuFPWM" />
<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SZV3XF0W0G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SZV3XF0W0G');
</script>
<title>Ê≥®Êñá‰ΩèÂÆÖ„ÅÆÁâ©‰ª∂ÊØîËºÉ„ÉÑ„Éº„É´ÔΩúAI„ÅßÁ∞°ÂçòÊØîËºÉ | Ê≥®ÊñáÁõ∏Ë´á.com</title>
<meta name="description" content="Ê≥®Êñá‰ΩèÂÆÖ„ÅÆÂúüÂú∞Êé¢„Åó„Å´„ÄÇÊ∞ó„Å´„Å™„ÇãÁâ©‰ª∂„ÅÆURL„ÇíË≤º„Çã„Å†„Åë„ÅßAI„ÅåËá™ÂãïÊï¥ÁêÜ„ÄÇË§áÊï∞Áâ©‰ª∂„Çí‰∏¶„Åπ„Å¶ÊØîËºÉË°®„Çí‰ΩúÊàê„ÄÇSUUMO„Éª„Ç¢„ÉÉ„Éà„Éõ„Éº„É†Á≠â„ÅÆÁâ©‰ª∂„ÇíÁµ±‰∏Ä„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅßÊØîËºÉ„Åß„Åç„ÇãÁÑ°Êñô„ÉÑ„Éº„É´„ÄÇ">
<meta name="keywords" content="Ê≥®Êñá‰ΩèÂÆÖ,Áâ©‰ª∂ÊØîËºÉ,ÂúüÂú∞ÊØîËºÉ,AI,ÂúüÂú∞Êé¢„Åó,SUUMO,„Ç¢„ÉÉ„Éà„Éõ„Éº„É†,‰∏çÂãïÁî£ÊØîËºÉ,ÊØîËºÉË°®">
<link rel="canonical" href="https://research.chuumon-soudan.com/">
<!-- OGP -->
<meta property="og:title" content="Ê≥®Êñá‰ΩèÂÆÖ„ÅÆÁâ©‰ª∂ÊØîËºÉ„ÉÑ„Éº„É´ÔΩúAI„ÅßÁ∞°ÂçòÊØîËºÉ">
<meta property="og:description" content="Ê≥®Êñá‰ΩèÂÆÖ„ÅÆÂúüÂú∞Êé¢„Åó„Å´„ÄÇÊ∞ó„Å´„Å™„ÇãÁâ©‰ª∂„ÅÆURL„ÇíË≤º„Çã„Å†„Åë„ÅßAI„ÅåËá™ÂãïÊï¥ÁêÜ„ÄÇË§áÊï∞Áâ©‰ª∂„Çí‰∏¶„Åπ„Å¶ÊØîËºÉË°®„Çí‰ΩúÊàê„ÄÇSUUMO„Éª„Ç¢„ÉÉ„Éà„Éõ„Éº„É†Á≠â„ÅÆÁâ©‰ª∂„ÇíÁµ±‰∏Ä„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅßÊØîËºÉ„Åß„Åç„ÇãÁÑ°Êñô„ÉÑ„Éº„É´„ÄÇ">
<meta property="og:type" content="website">
<meta property="og:url" content="https://research.chuumon-soudan.com/">
<meta property="og:site_name" content="Ê≥®ÊñáÁõ∏Ë´á.com">
<meta property="og:locale" content="ja_JP">
<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Ê≥®Êñá‰ΩèÂÆÖ„ÅÆÁâ©‰ª∂ÊØîËºÉ„ÉÑ„Éº„É´ÔΩúAI„ÅßÁ∞°ÂçòÊØîËºÉ">
<meta name="twitter:description" content="Ê≥®Êñá‰ΩèÂÆÖ„ÅÆÂúüÂú∞Êé¢„Åó„Å´„ÄÇÊ∞ó„Å´„Å™„ÇãÁâ©‰ª∂„ÅÆURL„ÇíË≤º„Çã„Å†„Åë„ÅßAI„ÅåËá™ÂãïÊï¥ÁêÜ„ÄÇË§áÊï∞Áâ©‰ª∂„Çí‰∏¶„Åπ„Å¶ÊØîËºÉË°®„Çí‰ΩúÊàê„ÄÇ">
<!-- ÊßãÈÄ†Âåñ„Éá„Éº„Çø (JSON-LD) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Ê≥®Êñá‰ΩèÂÆÖ Áâ©‰ª∂ÊØîËºÉ„ÉÑ„Éº„É´",
  "description": "Ê≥®Êñá‰ΩèÂÆÖ„ÅÆÂúüÂú∞Êé¢„Åó„Å´„ÄÇAI„ÅåÁâ©‰ª∂ÊÉÖÂ†±„ÇíËá™ÂãïÊï¥ÁêÜ„Åó„ÄÅË§áÊï∞Áâ©‰ª∂„ÇíÊØîËºÉË°®„Åß‰∏ÄË¶ßÊØîËºÉ„Åß„Åç„ÇãÁÑ°Êñô„ÉÑ„Éº„É´",
  "url": "https://research.chuumon-soudan.com/",
  "applicationCategory": "RealEstate",
  "operatingSystem": "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "JPY" },
  "author": { "@type": "Organization", "name": "Ê≥®ÊñáÁõ∏Ë´á.com" },
  "about": [
    { "@type": "Thing", "name": "Ê≥®Êñá‰ΩèÂÆÖ" },
    { "@type": "Thing", "name": "Áâ©‰ª∂ÊØîËºÉ" },
    { "@type": "Thing", "name": "ÂúüÂú∞Êé¢„Åó" }
  ]
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* === Tailwind CSS v3.4.19 (production build) === */
  *,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sticky{position:sticky}.top-0{top:0}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-1{margin-left:.25rem}.mt-0\.5{margin-top:.125rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.h-6{height:1.5rem}.w-12{width:3rem}.w-16{width:4rem}.w-28{width:7rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-8{width:2rem}.w-full{width:100%}.min-w-0{min-width:0}.max-w-6xl{max-width:72rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity,1))}.border-blue-100{--tw-border-opacity:1;border-color:rgb(219 234 254/var(--tw-border-opacity,1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-50{--tw-border-opacity:1;border-color:rgb(249 250 251/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.bg-amber-500{--tw-bg-opacity:1;background-color:rgb(245 158 11/var(--tw-bg-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgb(156 163 175/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94/var(--tw-bg-opacity,1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity,1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255/var(--tw-bg-opacity,1))}.bg-slate-400{--tw-bg-opacity:1;background-color:rgb(148 163 184/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.p-2{padding:.5rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.leading-relaxed{line-height:1.625}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-amber-800{--tw-text-opacity:1;color:rgb(146 64 14/var(--tw-text-opacity,1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.shadow-md,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.outline{outline-style:solid}.blur{--tw-blur:blur(8px)}.blur,.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-filter{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-100:hover{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:bg-green-100:hover{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity,1))}@media (min-width:640px){.sm\:block{display:block}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.sm\:flex-row{flex-direction:row}}@media (min-width:768px){.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  * { font-family: 'Noto Sans JP', sans-serif; }
  body { background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 50%, #f5f0ff 100%); min-height: 100vh; }
  .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); }
  .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; transition: all 0.2s; }
  .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  /* === Second Opinion Feature === */
  .so-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; }
  .so-modal { background: white; border-radius: 16px; max-width: 560px; width: 90%; max-height: 85vh; overflow-y: auto; padding: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
  .so-badge-yellow { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-red { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-none { background: #f0fdf4; color: #166534; border: 1px solid #86efac; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-compare-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .so-compare-table th, .so-compare-table td { padding: 8px 12px; border: 1px solid #e5e7eb; text-align: left; }
  .so-compare-table th { background: #f9fafb; font-weight: 600; white-space: nowrap; }
  .so-compare-table .missing { color: #d97706; font-style: italic; }
  .so-radio-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .so-radio-group label { padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
  .so-radio-group label:hover { border-color: #3b82f6; background: #eff6ff; }
  .so-radio-group input:checked + span { color: #1d4ed8; }
  .so-radio-group label:has(input:checked) { border-color: #3b82f6; background: #dbeafe; }
  /* === „Çµ„Ç§„Éâ„Éê„Éº Desktop/Mobile Âàá„ÇäÊõø„Åà === */
  .comp-sidebar-desktop { display: block; }
  .comp-sidebar-mobile { display: none; }
  @media (max-width: 768px) {
    .comp-layout-sidebar { flex-direction: column !important; gap: 0 !important; }
    .comp-layout-sidebar > div:first-child { width: 100% !important; }
    .comp-sidebar-desktop { display: none !important; }
    .comp-sidebar-mobile { display: flex !important; }
  }
  .comp-sidebar-mobile {
    align-items:center; gap:8px; padding:8px 12px;
    background:rgba(255,255,255,0.92); backdrop-filter:blur(8px);
    border:1px solid #e5e7eb; border-radius:12px;
    box-shadow:0 1px 3px rgba(0,0,0,0.06),0 2px 8px rgba(0,0,0,0.03);
    margin-bottom:8px; position:sticky; top:0; z-index:40;
  }
  .comp-sidebar-mobile select {
    flex:1; min-width:0; padding:7px 10px; border:1px solid #e5e7eb; border-radius:8px;
    font-size:12px; font-weight:500; color:#374151; background:#f9fafb; outline:none; appearance:auto; transition:border-color 0.2s;
  }
  .comp-sidebar-mobile select:focus { border-color:#93c5fd; box-shadow:0 0 0 2px rgba(59,130,246,0.08); }
  .comp-mobile-back-btn {
    flex-shrink:0; width:32px; height:32px; border-radius:8px; border:1px solid #e5e7eb;
    background:#f9fafb; cursor:pointer; font-size:14px; display:flex; align-items:center;
    justify-content:center; color:#6b7280; transition:all 0.2s;
  }
  .comp-mobile-back-btn:hover { background:#eff6ff; border-color:#bfdbfe; color:#2563eb; }
  .comp-mobile-count {
    flex-shrink:0; font-size:10px; font-weight:600; color:#fff; background:#2563eb;
    padding:2px 8px; border-radius:999px; white-space:nowrap;
  }

  /* === „Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„Çµ„Ç§„Éâ„Éê„Éº „É™„Éá„Ç∂„Ç§„É≥ === */
  .comp-sidebar-card {
    background:rgba(255,255,255,0.92); backdrop-filter:blur(8px);
    border-radius:16px; border:1px solid #e5e7eb;
    box-shadow:0 1px 3px rgba(0,0,0,0.06),0 1px 2px rgba(0,0,0,0.04);
    overflow:hidden; position:sticky; top:1rem;
  }
  .comp-sidebar-header {
    background:linear-gradient(135deg,#2563eb 0%,#3b82f6 100%);
    padding:14px 14px 12px; display:flex; align-items:center; justify-content:space-between;
  }
  .comp-sidebar-header-title {
    display:flex; align-items:center; gap:7px;
    font-size:12px; font-weight:700; color:#fff; letter-spacing:0.04em;
  }
  .comp-sidebar-header-icon { width:16px; height:16px; opacity:0.9; }
  .comp-sidebar-count-badge {
    font-size:10px; font-weight:700; color:#2563eb; background:rgba(255,255,255,0.95);
    padding:2px 8px; border-radius:999px; line-height:1.4;
  }
  .comp-sidebar-back-btn {
    display:flex; align-items:center; gap:6px; width:100%; padding:9px 12px; margin:0;
    font-size:12px; font-weight:500; color:#6b7280; background:#f9fafb;
    border:none; border-bottom:1px solid #f3f4f6; cursor:pointer; transition:all 0.2s; text-align:left;
  }
  .comp-sidebar-back-btn:hover { background:#f3f4f6; color:#374151; }
  .comp-sidebar-back-btn svg { width:14px; height:14px; flex-shrink:0; }
  .comp-sidebar-list { padding:6px 8px 8px; max-height:380px; overflow-y:auto; }
  .comp-sidebar-list::-webkit-scrollbar { width:4px; }
  .comp-sidebar-list::-webkit-scrollbar-track { background:transparent; }
  .comp-sidebar-list::-webkit-scrollbar-thumb { background:#d1d5db; border-radius:4px; }
  .comp-sidebar-item {
    display:flex; align-items:flex-start; justify-content:space-between; gap:4px;
    padding:9px 10px; border-radius:10px; cursor:pointer; transition:all 0.2s;
    border:1px solid transparent; position:relative;
  }
  .comp-sidebar-item:hover { background:#f9fafb; border-color:#f3f4f6; }
  .comp-sidebar-item.active {
    background:linear-gradient(135deg,#eff6ff 0%,#f0f4ff 100%);
    border-color:#bfdbfe; box-shadow:0 1px 4px rgba(37,99,235,0.08);
  }
  .comp-sidebar-item.active::before {
    content:''; position:absolute; left:0; top:8px; bottom:8px; width:3px;
    border-radius:0 3px 3px 0; background:#2563eb;
  }
  .comp-sidebar-item-name {
    font-size:12px; font-weight:600; color:#374151;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .comp-sidebar-item.active .comp-sidebar-item-name { color:#1d4ed8; }
  .comp-sidebar-item-meta {
    display:flex; align-items:center; gap:6px; margin-top:2px; font-size:11px; color:#9ca3af;
  }
  .comp-sidebar-item-meta-dot {
    width:3px; height:3px; border-radius:50%; background:#d1d5db; flex-shrink:0;
  }
  .comp-sidebar-item-count {
    display:inline-flex; align-items:center; justify-content:center;
    font-size:10px; font-weight:600; color:#6b7280; background:#f3f4f6;
    padding:1px 6px; border-radius:4px; line-height:1.4;
  }
  .comp-sidebar-item.active .comp-sidebar-item-count { color:#2563eb; background:#dbeafe; }
  .comp-sidebar-delete-btn {
    opacity:0; flex-shrink:0; width:22px; height:22px; display:flex; align-items:center;
    justify-content:center; border-radius:6px; border:none; background:transparent;
    color:#d1d5db; cursor:pointer; transition:all 0.15s; font-size:11px; margin-top:1px;
  }
  .comp-sidebar-item:hover .comp-sidebar-delete-btn { opacity:1; }
  .comp-sidebar-delete-btn:hover { background:#fee2e2; color:#ef4444; }
  .comp-sidebar-empty {
    padding:20px 12px; text-align:center; color:#9ca3af; font-size:11px; line-height:1.6;
  }
  .comp-sidebar-empty-icon { display:block; margin:0 auto 8px; width:28px; height:28px; color:#d1d5db; }

  /* === ÊØîËºÉË°® B+A„Éè„Ç§„Éñ„É™„ÉÉ„Éâ CSS === */
  .so-comp-summary-bar { display:flex; gap:10px; overflow-x:auto; padding-top:14px; padding-bottom:4px; margin-bottom:12px; }
  .so-comp-summary-card { flex:1; min-width:145px; background:#fff; border-radius:12px; border:2px solid #e5e7eb; padding:14px 12px; text-align:center; cursor:pointer; transition:all 0.2s; position:relative; scroll-snap-align:start; }
  .so-comp-summary-card:hover { border-color:#93c5fd; box-shadow:0 4px 12px rgba(59,130,246,0.1); transform:translateY(-2px); }
  .so-comp-summary-card.best { border-color:#22c55e; }
  .so-comp-summary-card.best::after { content:'üëë „Åä„Åô„Åô„ÇÅ'; position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:#fef3c7; color:#b45309; font-size:10px; font-weight:700; padding:2px 10px; border-radius:999px; white-space:nowrap; }
  .so-comp-label-chip { display:inline-flex; align-items:center; justify-content:center; width:30px; height:30px; border-radius:8px; font-weight:800; font-size:14px; color:#fff; margin-bottom:6px; }
  .so-comp-summary-name { font-size:11px; font-weight:600; color:#374151; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .so-comp-summary-score { font-size:28px; font-weight:900; line-height:1.1; }
  .so-comp-summary-score-label { font-size:10px; color:#9ca3af; }
  .so-comp-summary-price { font-size:14px; font-weight:700; color:#1e40af; margin-top:4px; }
  .so-comp-summary-sub { font-size:10px; color:#9ca3af; }
  /* „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ */
  .so-comp-acc-section { background:#fff; border-radius:12px; border:1px solid #e5e7eb; margin-bottom:10px; overflow:hidden; }
  .so-comp-acc-header { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; cursor:pointer; user-select:none; transition:background 0.15s; }
  .so-comp-acc-header:hover { background:#f9fafb; }
  .so-comp-acc-header h3 { font-size:13px; font-weight:700; display:flex; align-items:center; gap:6px; margin:0; }
  .so-comp-acc-header .so-comp-count { font-size:11px; color:#9ca3af; font-weight:400; }
  .so-comp-acc-header .so-comp-chev { font-size:10px; color:#9ca3af; transition:transform 0.3s; }
  .so-comp-acc-section.open .so-comp-acc-header .so-comp-chev { transform:rotate(180deg); }
  .so-comp-acc-body { display:none; border-top:1px solid #e5e7eb; }
  .so-comp-acc-section.open .so-comp-acc-body { display:block; }
  /* „ÉÜ„Éº„Éñ„É´ */
  .so-comp-t-table { width:100%; border-collapse:collapse; }
  .so-comp-t-table th, .so-comp-t-table td { padding:8px 10px; border-bottom:1px solid #f3f4f6; text-align:left; font-size:12px; vertical-align:top; }
  .so-comp-t-table th { background:#f9fafb; font-weight:600; color:#6b7280; white-space:nowrap; min-width:80px; width:90px; }
  .so-comp-t-table td { color:#1f2937; min-width:120px; }
  .so-comp-t-table tr:last-child td, .so-comp-t-table tr:last-child th { border-bottom:none; }
  /* „Çπ„Ç≥„Ç¢„Éê„Éº */
  .so-comp-score-bar { display:inline-flex; align-items:center; gap:5px; }
  .so-comp-score-bar-track { width:50px; height:6px; background:#e5e7eb; border-radius:99px; overflow:hidden; }
  .so-comp-score-bar-fill { height:100%; border-radius:99px; }
  .so-comp-score-val { font-size:13px; font-weight:700; }
  .so-comp-highlight-cell { background:#fefce8; }
  /* „Éè„Ç∂„Éº„Éâ„Éê„ÉÉ„Ç∏ */
  .so-comp-hz-badge { display:inline-flex; align-items:center; gap:3px; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; cursor:pointer; transition:background 0.2s; }
  .so-comp-hz-low { background:#dcfce7; color:#15803d; }
  .so-comp-hz-mid { background:#fef3c7; color:#b45309; }
  .so-comp-hz-high { background:#fee2e2; color:#dc2626; }
  .so-comp-hz-badge:hover { opacity:0.8; }
  .so-comp-hz-detail { display:none; margin-top:6px; padding:8px 10px; background:#f8fafc; border-radius:6px; border-left:3px solid #94a3b8; font-size:11px; color:#475569; line-height:1.6; }
  .so-comp-hz-detail.open { display:block; }
  /* B„Éó„É©„É≥È¢®„Ç∞„É™„ÉÉ„ÉâË°å */
  .so-comp-cpt-grid { overflow-x:auto; }
  .so-comp-cpt-row { display:grid; grid-template-columns:90px repeat(var(--cols,5), 1fr); border-bottom:1px solid #f3f4f6; }
  .so-comp-cpt-row:last-child { border-bottom:none; }
  .so-comp-cpt-row-label { padding:9px 10px; font-size:11px; font-weight:600; color:#6b7280; background:#f9fafb; display:flex; align-items:center; white-space:nowrap; }
  .so-comp-cpt-row-cell { padding:9px 10px; font-size:12px; text-align:center; display:flex; align-items:center; justify-content:center; word-break:break-all; }
  .so-comp-cpt-row-cell.highlight { background:#fefce8; font-weight:700; }
  .so-comp-cpt-expand-btn { grid-column:1/-1; padding:6px 10px; font-size:11px; color:#6b7280; cursor:pointer; text-align:center; background:#f9fafb; border-top:1px solid #f3f4f6; transition:background 0.15s; }
  .so-comp-cpt-expand-btn:hover { background:#f3f4f6; color:#374151; }
  .so-comp-cpt-hidden { display:none; }
  .so-comp-cpt-hidden.open { display:grid; grid-template-columns:90px repeat(var(--cols,5), 1fr); }
  /* Áâ©‰ª∂„É™„É≥„ÇØ */
  .so-comp-prop-link { display:inline-block; padding:3px 10px; background:#eff6ff; color:#2563eb; border-radius:4px; font-size:11px; font-weight:600; text-decoration:none; transition:background 0.15s; }
  .so-comp-prop-link:hover { background:#dbeafe; }
  /* „É°„É¢ */
  .so-comp-memo-area { width:100%; padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px; font-size:12px; resize:vertical; outline:none; font-family:inherit; }
  .so-comp-memo-area:focus { border-color:#93c5fd; box-shadow:0 0 0 2px rgba(59,130,246,0.1); }
  /* „É¢„Éº„ÉÄ„É´ */
  .so-comp-modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9998; justify-content:center; align-items:flex-start; padding:20px 16px; overflow-y:auto; }
  .so-comp-modal-overlay.open { display:flex; }
  .so-comp-modal-box { background:#fff; border-radius:16px; max-width:560px; width:100%; margin:auto; padding:20px; max-height:90vh; overflow-y:auto; }
  .so-comp-modal-close { width:32px; height:32px; border-radius:50%; background:#f3f4f6; border:none; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; color:#6b7280; }
  .so-comp-modal-close:hover { background:#e5e7eb; }
  .so-comp-fold-header { display:flex; align-items:center; justify-content:space-between; cursor:pointer; padding:8px 0; border-top:1px solid #f3f4f6; margin-top:8px; }
  .so-comp-fold-header h4 { font-size:12px; font-weight:700; color:#6b7280; display:flex; align-items:center; gap:4px; margin:0; }
  .so-comp-fold-body { display:none; padding-top:6px; }
  .so-comp-fold-body.open { display:block; }
  .so-comp-kv-row { display:flex; justify-content:space-between; align-items:baseline; padding:7px 0; border-bottom:1px solid #f3f4f6; }
  .so-comp-kv-row:last-child { border-bottom:none; }
  .so-comp-kv-label { font-size:11px; color:#6b7280; }
  .so-comp-kv-value { font-size:12px; font-weight:600; text-align:right; max-width:60%; }
  .so-comp-info-grid { display:grid; grid-template-columns:1fr 1fr; gap:1px; background:#e5e7eb; border-radius:8px; overflow:hidden; }
  .so-comp-info-cell { background:#fff; padding:8px 10px; }
  .so-comp-info-cell-label { font-size:10px; color:#9ca3af; margin-bottom:1px; }
  .so-comp-info-cell-value { font-size:12px; font-weight:600; }
  .so-comp-m-score-row { display:flex; align-items:center; gap:6px; padding:6px 8px; background:#f9fafb; border-radius:6px; margin-bottom:4px; }
  .so-comp-m-score-label { font-size:11px; color:#6b7280; width:50px; }
  .so-comp-m-score-bar { flex:1; height:5px; background:#e5e7eb; border-radius:99px; overflow:hidden; }
  .so-comp-m-score-fill { height:100%; border-radius:99px; }
  .so-comp-m-score-val { font-size:12px; font-weight:700; width:28px; text-align:right; }
  .so-comp-editable-cell { cursor:pointer; border-bottom:1px dashed #cbd5e1; transition:background 0.15s; }
  .so-comp-editable-cell:hover { background:#eff6ff; }
  @media (max-width:640px) {
    .so-comp-summary-card { min-width:130px; }
    .so-comp-t-table td { min-width:100px; }
    .so-comp-cpt-row { grid-template-columns:80px repeat(var(--cols,5), 1fr); }
    .so-comp-cpt-row-cell { font-size:11px; padding:8px 6px; }
  }
</style>
</head>
<body>
<div id="app"></div>

<script>
// ============================================================
// Ë®≠ÂÆö
// ============================================================
const CONFIG = {
  SUPABASE_URL: 'https://jvfmvitknqnmuduyscnl.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2Zm12aXRrbnFubXVkdXlzY25sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4ODE5NTQsImV4cCI6MjA4NjQ1Nzk1NH0.dDsHJXxFW4R-8ts-sKfGHtE-P0Ge9mPYEtpl-30dAdg',
};

// ============================================================
// Supabase Client + Anonymous Auth
// ============================================================
const supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

async function ensureAuth() {
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) return session.user;
    const { data, error } = await supabaseClient.auth.signInAnonymously();
    if (error) { console.warn('Anonymous auth failed:', error.message); return null; }
    return data.user;
  } catch(e) { console.warn('Auth error:', e.message); return null; }
}

// ============================================================
// Auth Helpers
// ============================================================
function isAnonymousUser() {
  return !state.authUser || state.authUser.is_anonymous;
}

function updateAuthState(user) {
  if (user) {
    state.authUser = {
      id: user.id,
      email: user.email || null,
      is_anonymous: user.is_anonymous || !user.email,
    };
  } else {
    state.authUser = null;
  }
}

async function handleSendOtp(email) {
  state.authLoading = true;
  state.authError = '';
  render();
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    const currentUser = session?.user;
    if (currentUser && currentUser.is_anonymous) {
      // ÂåøÂêç‚ÜíÊ≠£Âºè„Ç¢„Ç´„Ç¶„É≥„Éà„Å∏„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÔºàÁ¢∫Ë™ç„É°„Éº„É´ÈÄÅ‰ø°Ôºâ
      const { error } = await supabaseClient.auth.updateUser({ email });
      if (error) throw error;
      state.authEmail = email;
      state.authStep = 'link_sent'; // „É™„É≥„ÇØ„ÇØ„É™„ÉÉ„ÇØÂæÖ„Å°
    } else {
      // ÈÄöÂ∏∏„É≠„Ç∞„Ç§„É≥ÔºàOTPÈÄÅ‰ø°Ôºâ
      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: { shouldCreateUser: true },
      });
      if (error) throw error;
      state.authEmail = email;
      state.authStep = 'otp';
    }
  } catch(e) {
    state.authError = e.message || 'ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
  }
  state.authLoading = false;
  render();
}

async function handleVerifyOtp(email, token) {
  state.authLoading = true;
  state.authError = '';
  render();
  try {
    const { data, error } = await supabaseClient.auth.verifyOtp({
      email,
      token,
      type: 'email',
    });
    if (error) throw error;
    updateAuthState(data.user);
    state.authModalOpen = false;
    state.authStep = 'email';
    state.authEmail = '';
    // „Éá„Éº„ÇøÂÜçË™≠„ÅøËæº„Åø
    await loadSavedProperties();
    await loadSavedComparisons();
    // Êú™‰øùÂ≠ò„ÅÆÊØîËºÉË°®„Åå„ÅÇ„Çå„Å∞DB„Å´‰øùÂ≠ò
    await saveUnsavedComparisons();
    // „Éû„Ç§„Éö„Éº„Ç∏„Éó„É≠„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
    await loadUserProfile();
  } catch(e) {
    state.authError = e.message || 'Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
  }
  state.authLoading = false;
  render();
}

async function handleLogout() {
  await supabaseClient.auth.signOut();
  state.authUser = null;
  state.userProfile = null;
  state.savedProperties = [];
  state.savedComparisons = [];
  state.soComparison = null;
  state.soView = null;
  try {
    localStorage.removeItem('mie_saved_properties');
    localStorage.removeItem('mie_comparison');
    localStorage.removeItem('mie_saved_comparisons');
  } catch(e) {}
  // Êñ∞„Åó„ÅÑÂåøÂêç„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈñãÂßã
  const user = await ensureAuth();
  if (user) updateAuthState(user);
  render();
}

function openAuthModal() {
  state.authModalOpen = true;
  state.authStep = 'email';
  state.authEmail = '';
  state.authError = '';
  state.authLoading = false;
  render();
}

async function saveUnsavedComparisons() {
  const user = state.authUser;
  if (!user || user.is_anonymous) return;
  const unsaved = state.savedComparisons.filter(c => c._unsaved);
  for (const comp of unsaved) {
    try {
      const { data } = await supabaseClient.from('comparisons').insert({
        user_id: user.id, name: comp.name, property_ids: comp.property_ids,
        ai_summary: comp.summary, ai_questions: comp.questions,
      }).select().single();
      if (data) {
        comp.id = data.id;
        comp.created_at = data.created_at;
        delete comp._unsaved;
        // soComparison„ÇÇÊõ¥Êñ∞
        if (state.soComparison && state.soComparison._unsaved) {
          state.soComparison.id = data.id;
          delete state.soComparison._unsaved;
        }
      }
    } catch(e) { console.warn('Failed to save comparison:', e.message); }
  }
  backupComparisonsToLS();
}

// ============================================================
// User Profile („Éû„Ç§„Éö„Éº„Ç∏)
// ============================================================
const PRIORITY_OPTIONS = [
  { key: 'garden', label: 'Â∫≠„ÅåÂ∫É„ÅÑ' },
  { key: 'sunlight', label: 'Êó•ÂΩì„Åü„Çä„ÅåËâØ„ÅÑ' },
  { key: 'quiet', label: 'Èùô„Åã„Å™Áí∞Â¢É' },
  { key: 'childcare', label: 'Â≠êËÇ≤„Å¶„Åó„ÇÑ„Åô„ÅÑ' },
  { key: 'park_nearby', label: 'Ëøë„Åè„Å´ÂÖ¨Âúí„Åå„ÅÇ„Çã' },
  { key: 'shopping_nearby', label: 'ÂïÜÊ•≠ÊñΩË®≠„ÅåËøë„ÅÑ' },
  { key: 'residential', label: 'ÈñëÈùô„Å™‰ΩèÂÆÖË°ó' },
  { key: 'station_near', label: 'ÈßÖ„ÅåËøë„ÅÑ' },
  { key: 'large_lot', label: 'ÂúüÂú∞„ÅåÂ∫É„ÅÑ' },
  { key: 'nature', label: 'Ëá™ÁÑ∂Áí∞Â¢É„ÅåË±ä„Åã' },
];

async function loadUserProfile() {
  const user = state.authUser;
  if (!user || user.is_anonymous) return;
  try {
    const { data } = await supabaseClient
      .from('user_profiles')
      .select('*')
      .eq('user_id', user.id)
      .maybeSingle();
    state.userProfile = data || null;
  } catch(e) { console.warn('Failed to load profile:', e.message); }
}

async function geocodeAddress(address) {
  if (!address || !address.trim()) return null;
  try {
    const res = await fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`);
    if (!res.ok) return null;
    const data = await res.json();
    if (data && data.length > 0 && data[0].geometry && data[0].geometry.coordinates) {
      const [lng, lat] = data[0].geometry.coordinates;
      return { lat, lng };
    }
  } catch(e) { console.warn('Geocode failed:', e.message); }
  return null;
}

async function saveUserProfile(profileData) {
  const user = state.authUser;
  if (!user || user.is_anonymous) return;
  state._profileLoading = true;
  state._profileSaved = false;
  // „Éï„Ç©„Éº„É†ÂÄ§„Çí‰∏ÄÊôÇ‰øùÊåÅÔºàrender()„Åß„É™„Çª„ÉÉ„Éà„Åï„Çå„Å™„ÅÑ„Çà„ÅÜÔºâ
  state.userProfile = { ...state.userProfile, ...profileData };
  render();

  // Âã§ÂãôÂÖà‰ΩèÊâÄ„ÅÆ„Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞
  if (profileData.spouse1_workplace) {
    const geo = await geocodeAddress(profileData.spouse1_workplace);
    if (geo) { profileData.spouse1_lat = geo.lat; profileData.spouse1_lng = geo.lng; }
    else { profileData.spouse1_lat = null; profileData.spouse1_lng = null; }
  } else {
    profileData.spouse1_lat = null; profileData.spouse1_lng = null;
  }
  if (profileData.spouse2_workplace) {
    const geo = await geocodeAddress(profileData.spouse2_workplace);
    if (geo) { profileData.spouse2_lat = geo.lat; profileData.spouse2_lng = geo.lng; }
    else { profileData.spouse2_lat = null; profileData.spouse2_lng = null; }
  } else {
    profileData.spouse2_lat = null; profileData.spouse2_lng = null;
  }

  const row = { ...profileData, user_id: user.id, updated_at: new Date().toISOString() };

  try {
    const { error } = await supabaseClient
      .from('user_profiles')
      .upsert(row, { onConflict: 'user_id' });
    if (error) throw error;
    state.userProfile = row;
    state._profileSaved = true;
    setTimeout(() => { state._profileSaved = false; render(); }, 3000);
  } catch(e) { console.warn('Failed to save profile:', e.message); alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message); }

  state._profileLoading = false;
  render();
}

// ============================================================
// Area Data (used by calculateBadge and generateComparison)
// ============================================================
const AREAS = [
  { id: "yokkaichi", name: "ÂõõÊó•Â∏ÇÂ∏Ç", pricePerTsubo: 188498 },
  { id: "kuwana", name: "Ê°ëÂêçÂ∏Ç", pricePerTsubo: 183614 },
  { id: "suzuka", name: "Èà¥ÈπøÂ∏Ç", pricePerTsubo: 135587 },
  { id: "inabe", name: "„ÅÑ„Å™„ÅπÂ∏Ç", pricePerTsubo: 81000 },
  { id: "kameyama", name: "‰∫ÄÂ±±Â∏Ç", pricePerTsubo: 97500 },
  { id: "komono", name: "Ëè∞ÈáéÁî∫", pricePerTsubo: 73000 },
  { id: "toin", name: "Êù±Âì°Áî∫", pricePerTsubo: 106000 }
];

// ============================================================
// Property CRUD (Supabase)
// ============================================================
async function loadSavedProperties() {
  const user = await ensureAuth();
  if (!user) return;
  const { data, error } = await supabaseClient.from('saved_properties').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
  if (!error && data) state.savedProperties = data;
}

async function saveProperty(prop) {
  try {
    const user = await ensureAuth();
    if (!user) { alert('Áâ©‰ª∂„ÅÆ‰øùÂ≠ò„Å´„ÅØ„Éö„Éº„Ç∏„ÅÆÂÜçË™≠„ÅøËæº„Åø„ÅåÂøÖË¶Å„Åß„Åô'); return null; }
    let areaData = AREAS.find(a => a.id === prop.area_id);
    if (!areaData && prop.address) areaData = AREAS.find(a => prop.address.includes(a.name));
    const badge = calculateBadge(prop, areaData);
    const row = { ...prop, user_id: user.id, badge };
    const { data, error } = await supabaseClient.from('saved_properties').insert(row).select().single();
    if (error) { alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message); console.error('Save failed:', error); return null; }
    state.savedProperties.unshift(data);
    backupToLocalStorage();
    // ‰ΩçÁΩÆÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßenrichmentÂÆüË°å
    if (data.lat && data.lng) {
      triggerEnrichment(data.id).catch(e => console.warn('Auto-enrichment failed:', e.message));
    }
    return data;
  } catch(e) { alert('‰øùÂ≠ò„Ç®„É©„Éº: ' + e.message); return null; }
}

async function updateProperty(id, updates) {
  const prop = state.savedProperties.find(p => p.id === id);
  if (!prop) return;
  Object.assign(prop, updates);
  backupToLocalStorage();
  try {
    await supabaseClient.from('saved_properties').update(updates).eq('id', id);
  } catch(e) { console.warn('Supabase update failed, saved to localStorage:', e.message); }
}

async function deleteProperty(id) {
  const { error } = await supabaseClient.from('saved_properties').delete().eq('id', id);
  if (!error) state.savedProperties = state.savedProperties.filter(p => p.id !== id);
  backupToLocalStorage();
}

// ============================================================
// Property EnrichmentÔºàË©≥Á¥∞ÊÉÖÂ†±„ÅÆËá™ÂãïÂèñÂæóÔºâ
// ============================================================
async function triggerEnrichment(propertyId) {
  // „É≠„Éº„Ç´„É´„Çπ„ÉÜ„Éº„Éà„Çí„ÄåÂèñÂæó‰∏≠„Äç„Å´Êõ¥Êñ∞
  const prop = state.savedProperties.find(p => p.id === propertyId);
  if (prop) { prop.enrichment_status = 'pending'; render(); }

  try {
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    if (token) headers['Authorization'] = `Bearer ${token}`;
    else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/property-enrich`, {
      method: 'POST', headers,
      body: JSON.stringify({ action: 'enrich', property_id: propertyId })
    });
    if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
    const result = await res.json();
    if (result.error) throw new Error(result.error);

    // „É≠„Éº„Ç´„É´„Çπ„ÉÜ„Éº„Éà„Å´ÁµêÊûú„ÇíÂèçÊò†
    if (prop) {
      Object.assign(prop, result);
      backupToLocalStorage();
      render();
    }
    return result;
  } catch(e) {
    console.warn('Enrichment failed for', propertyId, ':', e.message);
    if (prop) { prop.enrichment_status = 'error'; render(); }
    throw e;
  }
}

async function handleEnrichProperty(propertyId) {
  try {
    await triggerEnrichment(propertyId);
  } catch(e) {
    // silently handled in triggerEnrichment
  }
}

// ============================================================
// Comparisons CRUD
// ============================================================
async function loadSavedComparisons() {
  try {
    const user = await ensureAuth();
    if (!user) return;
    const { data, error } = await supabaseClient.from('comparisons')
      .select('*').eq('user_id', user.id).order('created_at', { ascending: false });
    if (!error && data) {
      state.savedComparisons = data.map(c => ({
        id: c.id,
        name: c.name || 'ÊØîËºÉË°®',
        created_at: c.created_at,
        summary: c.ai_summary,
        questions: c.ai_questions,
        property_ids: c.property_ids,
        properties: null, // lazy load
      }));
      backupComparisonsToLS();
    }
  } catch(e) { console.warn('Load comparisons failed:', e.message); }
}

async function renameComparison(compId, newName) {
  const comp = state.savedComparisons.find(c => c.id === compId);
  if (!comp) return;
  comp.name = newName;
  if (state.soComparison && state.soComparison.id === compId) state.soComparison.name = newName;
  backupComparisonsToLS();
  try {
    await supabaseClient.from('comparisons').update({ name: newName }).eq('id', compId);
  } catch(e) { console.warn('Rename failed:', e.message); }
}

async function deleteComparison(compId) {
  state.savedComparisons = state.savedComparisons.filter(c => c.id !== compId);
  if (state.soComparison?.id === compId) { state.soComparison = null; state.soView = null; }
  backupComparisonsToLS();
  try {
    await supabaseClient.from('comparisons').delete().eq('id', compId);
  } catch(e) { console.warn('Delete comparison failed:', e.message); }
}

async function loadComparisonDetail(compId) {
  const comp = state.savedComparisons.find(c => c.id === compId);
  if (!comp) return;
  // property_ids„Åã„ÇâÁâ©‰ª∂„Éá„Éº„Çø„ÇíÂèñÂæó
  const propIds = comp.property_ids || [];
  let props = state.savedProperties.filter(p => propIds.includes(p.id));
  // Supabase„Åã„Çâ„ÇÇÂèñÂæó„ÇíË©¶„Åø„ÇãÔºàÂâäÈô§Ê∏à„ÅøÁâ©‰ª∂ÂØæÂøúÔºâ
  if (props.length < propIds.length) {
    try {
      const { data } = await supabaseClient.from('saved_properties').select('*').in('id', propIds);
      if (data) props = data;
    } catch(e) {}
  }
  let questions = [];
  try { questions = typeof comp.questions === 'string' ? JSON.parse(comp.questions) : (comp.questions || []); } catch(e) {}

  state.soComparison = {
    id: comp.id,
    name: comp.name,
    summary: comp.summary,
    questions,
    properties: props,
    property_ids: propIds,
    _unsaved: comp._unsaved || false,
  };
  state.soView = 'compare';
  backupToLocalStorage();
  render();
}

// localStorage „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
const LS_PROPS_KEY = 'mie_saved_properties';
const LS_COMP_KEY = 'mie_comparison';
const LS_COMPS_KEY = 'mie_saved_comparisons';

function backupToLocalStorage() {
  try {
    localStorage.setItem(LS_PROPS_KEY, JSON.stringify(state.savedProperties));
    if (state.soComparison) localStorage.setItem(LS_COMP_KEY, JSON.stringify(state.soComparison));
  } catch(e) {}
}

function backupComparisonsToLS() {
  try { localStorage.setItem(LS_COMPS_KEY, JSON.stringify(state.savedComparisons)); } catch(e) {}
}

function restoreFromLocalStorage() {
  try {
    const props = localStorage.getItem(LS_PROPS_KEY);
    if (props) {
      const parsed = JSON.parse(props);
      if (Array.isArray(parsed) && parsed.length > 0 && state.savedProperties.length === 0) {
        state.savedProperties = parsed;
      }
    }
    const comp = localStorage.getItem(LS_COMP_KEY);
    if (comp) state.soComparison = JSON.parse(comp);
    const comps = localStorage.getItem(LS_COMPS_KEY);
    if (comps) {
      const parsed = JSON.parse(comps);
      if (Array.isArray(parsed) && state.savedComparisons.length === 0) state.savedComparisons = parsed;
    }
  } catch(e) {}
}

async function toggleComparison(id) {
  const prop = state.savedProperties.find(p => p.id === id);
  if (!prop) return;
  const newVal = !prop.in_comparison;
  const inCompCount = state.savedProperties.filter(p => p.in_comparison).length;
  if (newVal && inCompCount >= 5) { alert('ÊØîËºÉ„ÅØÊúÄÂ§ß5‰ª∂„Åæ„Åß„Åß„Åô'); return; }
  const { error } = await supabaseClient.from('saved_properties').update({ in_comparison: newVal }).eq('id', id);
  if (!error) prop.in_comparison = newVal;
}

async function generateComparison() {
  const props = state.savedProperties.filter(p => p.in_comparison);
  if (props.length < 2) { alert('ÊØîËºÉ„Åô„Çã„Å´„ÅØ2‰ª∂‰ª•‰∏ä„ÅÆÁâ©‰ª∂„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return null; }
  const areas = {};
  AREAS.forEach(a => { areas[a.id] = { name: a.name, pricePerTsubo: a.pricePerTsubo }; });
  try {
    const user = await ensureAuth();
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    headers['Authorization'] = token ? `Bearer ${token}` : `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-compare`, {
      method: 'POST', headers,
      body: JSON.stringify({ properties: props, areas })
    });
    const result = await res.json();
    const compName = 'ÊØîËºÉË°® ' + new Date().toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

    // ÂåøÂêç„É¶„Éº„Ç∂„Éº„ÅÆÂ†¥Âêà: DB„Å´‰øùÂ≠ò„Åõ„Åö„ÄÅ„É≠„Éº„Ç´„É´„ÅÆ„Åø„ÅßÊØîËºÉË°®„ÇíË°®Á§∫
    if (isAnonymousUser()) {
      const tempComp = {
        id: 'temp_' + Date.now(), name: compName, created_at: new Date().toISOString(),
        summary: result.summary, questions: JSON.stringify(result.questions),
        property_ids: props.map(p => p.id), properties: props, _unsaved: true,
      };
      state.savedComparisons.unshift(tempComp);
      backupComparisonsToLS();
      return { ...result, id: tempComp.id, name: compName, properties: props, _unsaved: true };
    }

    // „É≠„Ç∞„Ç§„É≥Ê∏à„Åø: DB„Å´‰øùÂ≠ò
    const { data } = await supabaseClient.from('comparisons').insert({
      user_id: user.id, name: compName, property_ids: props.map(p => p.id), ai_summary: result.summary, ai_questions: JSON.stringify(result.questions)
    }).select().single();
    if (data) {
      state.savedComparisons.unshift({
        id: data.id, name: compName, created_at: data.created_at,
        summary: result.summary, questions: JSON.stringify(result.questions),
        property_ids: props.map(p => p.id), properties: props,
      });
      backupComparisonsToLS();
    }
    return { ...result, id: data?.id, name: compName, properties: props };
  } catch(e) { console.error('Comparison failed:', e); return null; }
}

function calculateBadge(property, areaData) {
  let yellowReasons = [], redReasons = [];
  if (!property.price) yellowReasons.push('‰æ°Ê†ºÊú™ÂÖ•Âäõ');
  if (!property.land_area) yellowReasons.push('Èù¢Á©çÊú™ÂÖ•Âäõ');
  if (!property.zoning) yellowReasons.push('Áî®ÈÄîÂú∞Âüü‰∏çÊòé');
  if (!property.road_access) yellowReasons.push('Êé•ÈÅìÊÉÖÂ†±‰∏çÊòé');
  if (!property.building_coverage) yellowReasons.push('Âª∫„Å∫„ÅÑÁéá‰∏çÊòé');
  if (property.price && property.land_area && areaData) {
    const tsuboPr = property.price / (property.land_area / 3.305785);
    const areaTsubo = areaData.pricePerTsubo;
    if (areaTsubo && Math.abs(tsuboPr - areaTsubo) / areaTsubo > 0.25) redReasons.push('Âù™Âçò‰æ°„Åå„Ç®„É™„Ç¢Áõ∏Â†¥„Åã„Çâ‰πñÈõ¢');
  }
  const missingCritical = [property.zoning, property.road_access, property.building_coverage, property.elevation, property.infrastructure].filter(v => !v).length;
  if (missingCritical >= 3) redReasons.push('ÈáçË¶ÅÈ†ÖÁõÆ„ÅåË§áÊï∞‰∏çÊòé');
  return redReasons.length > 0 ? 'red' : yellowReasons.length > 0 ? 'yellow' : 'none';
}

// ============================================================
// Auto ScoringÔºàÁâ©‰ª∂„Çπ„Ç≥„Ç¢„É™„É≥„Ç∞Ôºâ
// ============================================================
// HaversineË∑ùÈõ¢Ôºà„É°„Éº„Éà„É´Ôºâ
function haversineDistanceClient(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function calculateLifestyleScore(prop, profile) {
  if (!profile) return null;
  const priorities = profile.priorities || [];
  const hasWorkplace = (profile.spouse1_lat && profile.spouse1_lng) || (profile.spouse2_lat && profile.spouse2_lng);
  if (priorities.length === 0 && !hasWorkplace) return null;

  let score = 50;

  // --- ÈÄöÂã§„Çµ„Éñ„Çπ„Ç≥„Ç¢Ôºà¬±25ptÔºâ ---
  if (hasWorkplace && prop.lat && prop.lng) {
    const distances = [];
    if (profile.spouse1_lat && profile.spouse1_lng) {
      distances.push(haversineDistanceClient(prop.lat, prop.lng, profile.spouse1_lat, profile.spouse1_lng) / 1000);
    }
    if (profile.spouse2_lat && profile.spouse2_lng) {
      distances.push(haversineDistanceClient(prop.lat, prop.lng, profile.spouse2_lat, profile.spouse2_lng) / 1000);
    }
    if (distances.length > 0) {
      const avgKm = distances.reduce((a, b) => a + b, 0) / distances.length;
      if (avgKm < 5) score += 25;
      else if (avgKm < 10) score += 15;
      else if (avgKm < 20) score += 5;
      else if (avgKm < 30) score += 0;
      else score -= 10;
    }
  }

  // --- ÈáçË¶ñÈ†ÖÁõÆ„Çµ„Éñ„Çπ„Ç≥„Ç¢Ôºà¬±25ptÔºâ ---
  if (priorities.length > 0) {
    const extractDist = (str) => {
      if (!str) return null;
      const m = str.match(/(\d+)m/);
      return m ? parseInt(m[1]) : null;
    };

    const checks = {
      garden: () => {
        if (!prop.land_area) return null;
        return prop.land_area >= 200 ? 1 : prop.land_area >= 150 ? 0.5 : 0.2;
      },
      sunlight: () => {
        if (!prop.zoning) return null;
        if (/‰∏Ä‰Ωé‰Ωè|Á¨¨‰∏ÄÁ®Æ‰ΩéÂ±§/.test(prop.zoning)) return 1;
        if (/‰∫å‰Ωé‰Ωè|Á¨¨‰∫åÁ®Æ‰ΩéÂ±§/.test(prop.zoning)) return 0.7;
        if (/ÂïÜÊ•≠|Â∑•Ê•≠/.test(prop.zoning)) return 0.2;
        return 0.5;
      },
      quiet: () => {
        if (!prop.zoning) return null;
        if (/‰ΩéÂ±§|‰Ωé‰Ωè/.test(prop.zoning)) return 1;
        if (/‰ΩèÂ±Ö/.test(prop.zoning)) return 0.6;
        if (/ÂïÜÊ•≠|Â∑•Ê•≠/.test(prop.zoning)) return 0.1;
        return 0.5;
      },
      childcare: () => {
        const nursery = extractDist(prop.nearest_nursery);
        const school = extractDist(prop.school_elementary);
        let val = 0, count = 0;
        if (nursery != null) { val += nursery < 800 ? 1 : nursery < 1500 ? 0.6 : 0.2; count++; }
        if (school != null) { val += school < 800 ? 1 : school < 1500 ? 0.6 : 0.2; count++; }
        return count > 0 ? val / count : null;
      },
      park_nearby: () => {
        const d = extractDist(prop.nearest_park);
        if (d == null) return null;
        return d < 300 ? 1 : d < 600 ? 0.7 : d < 1000 ? 0.4 : 0.1;
      },
      shopping_nearby: () => {
        const d = extractDist(prop.nearest_supermarket);
        if (d == null) return null;
        return d < 500 ? 1 : d < 1000 ? 0.7 : d < 2000 ? 0.4 : 0.1;
      },
      residential: () => {
        if (!prop.zoning) return null;
        if (/‰ΩéÂ±§|‰Ωé‰Ωè/.test(prop.zoning)) return 1;
        if (/‰ΩèÂ±Ö/.test(prop.zoning)) return 0.7;
        if (/ÂïÜÊ•≠|Â∑•Ê•≠/.test(prop.zoning)) return 0.2;
        return 0.5;
      },
      station_near: () => {
        if (!prop.station_distance) return null;
        const m = prop.station_distance.match(/(\d+)\s*ÂàÜ/);
        if (m) {
          const mins = parseInt(m[1]);
          return mins <= 5 ? 1 : mins <= 10 ? 0.7 : mins <= 20 ? 0.4 : 0.1;
        }
        const m2 = prop.station_distance.match(/(\d+)\s*m/);
        if (m2) {
          const mins = Math.round(parseInt(m2[1]) / 80);
          return mins <= 5 ? 1 : mins <= 10 ? 0.7 : mins <= 20 ? 0.4 : 0.1;
        }
        return null;
      },
      large_lot: () => {
        if (!prop.land_area) return null;
        return prop.land_area >= 250 ? 1 : prop.land_area >= 200 ? 0.7 : prop.land_area >= 150 ? 0.5 : 0.2;
      },
      nature: () => {
        const d = extractDist(prop.nearest_park);
        if (d == null) return null;
        return d < 500 ? 1 : d < 1000 ? 0.7 : 0.3;
      },
    };

    let totalVal = 0;
    let count = 0;
    for (const key of priorities) {
      const fn = checks[key];
      if (fn) {
        const result = fn();
        if (result !== null) { totalVal += result; count++; }
      }
    }
    if (count > 0) {
      score += Math.round((totalVal / count) * 25);
    }
  }

  return Math.max(0, Math.min(100, Math.round(score)));
}

function getLifestyleBreakdown(prop, profile) {
  if (!profile) return null;
  const priorities = profile.priorities || [];
  const hasWorkplace = (profile.spouse1_lat && profile.spouse1_lng) || (profile.spouse2_lat && profile.spouse2_lng);
  if (priorities.length === 0 && !hasWorkplace) return null;

  const reasons = [];

  // ÈÄöÂã§Ë∑ùÈõ¢
  if (hasWorkplace && prop.lat && prop.lng) {
    const dists = [];
    if (profile.spouse1_lat && profile.spouse1_lng) {
      const km = haversineDistanceClient(prop.lat, prop.lng, profile.spouse1_lat, profile.spouse1_lng) / 1000;
      dists.push({ name: profile.spouse1_name || 'ÈÖçÂÅ∂ËÄÖ1', km });
    }
    if (profile.spouse2_lat && profile.spouse2_lng) {
      const km = haversineDistanceClient(prop.lat, prop.lng, profile.spouse2_lat, profile.spouse2_lng) / 1000;
      dists.push({ name: profile.spouse2_name || 'ÈÖçÂÅ∂ËÄÖ2', km });
    }
    for (const d of dists) {
      const rating = d.km < 5 ? '‚óé' : d.km < 10 ? '‚óã' : d.km < 20 ? '‚ñ≥' : '√ó';
      reasons.push('üöó ' + d.name + '„ÅÆÈÄöÂã§: Á¥Ñ' + d.km.toFixed(1) + 'km ' + rating);
    }
  }

  // ÈáçË¶ñÈ†ÖÁõÆ
  if (priorities.length > 0) {
    const extractDist = (str) => { if (!str) return null; const m = str.match(/(\d+)m/); return m ? parseInt(m[1]) : null; };
    const labelMap = {};
    PRIORITY_OPTIONS.forEach(o => { labelMap[o.key] = o.label; });

    const evalMap = {
      garden: () => {
        if (!prop.land_area) return 'ÊÉÖÂ†±„Å™„Åó';
        return prop.land_area >= 200 ? '‚óé ' + prop.land_area + '„é°' : prop.land_area >= 150 ? '‚óã ' + prop.land_area + '„é°' : '‚ñ≥ ' + prop.land_area + '„é°';
      },
      sunlight: () => {
        if (!prop.zoning) return 'ÊÉÖÂ†±„Å™„Åó';
        if (/‰∏Ä‰Ωé‰Ωè|Á¨¨‰∏ÄÁ®Æ‰ΩéÂ±§/.test(prop.zoning)) return '‚óé ' + prop.zoning;
        if (/‰∫å‰Ωé‰Ωè|Á¨¨‰∫åÁ®Æ‰ΩéÂ±§/.test(prop.zoning)) return '‚óã ' + prop.zoning;
        if (/ÂïÜÊ•≠|Â∑•Ê•≠/.test(prop.zoning)) return '√ó ' + prop.zoning;
        return '‚ñ≥ ' + prop.zoning;
      },
      quiet: () => {
        if (!prop.zoning) return 'ÊÉÖÂ†±„Å™„Åó';
        if (/‰ΩéÂ±§|‰Ωé‰Ωè/.test(prop.zoning)) return '‚óé ' + prop.zoning;
        if (/‰ΩèÂ±Ö/.test(prop.zoning)) return '‚óã ' + prop.zoning;
        if (/ÂïÜÊ•≠|Â∑•Ê•≠/.test(prop.zoning)) return '√ó ' + prop.zoning;
        return '‚ñ≥ ' + prop.zoning;
      },
      childcare: () => {
        const parts = [];
        const nd = extractDist(prop.nearest_nursery);
        const sd = extractDist(prop.school_elementary);
        if (nd != null) parts.push('‰øùËÇ≤Âúí' + nd + 'm');
        if (sd != null) parts.push('Â∞èÂ≠¶Ê†°' + sd + 'm');
        if (parts.length === 0) return 'ÊÉÖÂ†±„Å™„Åó';
        const avg = ((nd || 9999) + (sd || 9999)) / (parts.length);
        const r = avg < 800 ? '‚óé' : avg < 1500 ? '‚óã' : '‚ñ≥';
        return r + ' ' + parts.join('Ôºè');
      },
      park_nearby: () => {
        const d = extractDist(prop.nearest_park);
        if (d == null) return 'ÊÉÖÂ†±„Å™„Åó';
        const r = d < 300 ? '‚óé' : d < 600 ? '‚óã' : d < 1000 ? '‚ñ≥' : '√ó';
        return r + ' ' + d + 'm';
      },
      shopping_nearby: () => {
        const d = extractDist(prop.nearest_supermarket);
        if (d == null) return 'ÊÉÖÂ†±„Å™„Åó';
        const r = d < 500 ? '‚óé' : d < 1000 ? '‚óã' : d < 2000 ? '‚ñ≥' : '√ó';
        return r + ' ' + d + 'm';
      },
      residential: () => {
        if (!prop.zoning) return 'ÊÉÖÂ†±„Å™„Åó';
        if (/‰ΩéÂ±§|‰Ωé‰Ωè/.test(prop.zoning)) return '‚óé ' + prop.zoning;
        if (/‰ΩèÂ±Ö/.test(prop.zoning)) return '‚óã ' + prop.zoning;
        if (/ÂïÜÊ•≠|Â∑•Ê•≠/.test(prop.zoning)) return '√ó ' + prop.zoning;
        return '‚ñ≥ ' + prop.zoning;
      },
      station_near: () => {
        if (!prop.station_distance) return 'ÊÉÖÂ†±„Å™„Åó';
        return prop.station_distance;
      },
      large_lot: () => {
        if (!prop.land_area) return 'ÊÉÖÂ†±„Å™„Åó';
        return prop.land_area >= 250 ? '‚óé ' + prop.land_area + '„é°' : prop.land_area >= 200 ? '‚óã ' + prop.land_area + '„é°' : prop.land_area >= 150 ? '‚ñ≥ ' + prop.land_area + '„é°' : '√ó ' + prop.land_area + '„é°';
      },
      nature: () => {
        const d = extractDist(prop.nearest_park);
        if (d == null) return 'ÊÉÖÂ†±„Å™„Åó';
        const r = d < 500 ? '‚óé' : d < 1000 ? '‚óã' : '‚ñ≥';
        return r + ' ÂÖ¨Âúí' + d + 'm';
      },
    };

    for (const key of priorities) {
      const fn = evalMap[key];
      const label = labelMap[key] || key;
      if (fn) {
        reasons.push(label + ': ' + fn());
      }
    }
  }

  return reasons;
}

function calculateScores(prop, userProfile) {
  if (!prop) return null;

  // „É™„Çπ„ÇØ„É¨„Éô„É´Âà§ÂÆö„Éò„É´„Éë„Éº
  // AIÂá∫ÂäõÂΩ¢Âºè: „Äå‰ΩéÔºàÁêÜÁî±...Ôºâ„Äç„Äå‰∏≠„ÄÇÁêÜÁî±...„Äç„ÄåÈ´òÔºàÁêÜÁî±...Ôºâ„Äç
  // ‚Üí ÂÖàÈ†≠„ÅÆ„Äå‰Ωé/‰∏≠/È´ò„Äç„ÇíÊúÄÂÑ™ÂÖà„ÅßÂà§ÂÆö„Åô„ÇãÔºàÁêÜÁî±Êñá‰∏≠„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„Å´ÊÉë„Çè„Åï„Çå„Å™„ÅÑÔºâ
  function riskLevel(text) {
    if (!text) return null;
    const t = text.trim();
    // ÂÖàÈ†≠„Åå„ÄåÈ´ò„Äç„Äå‰∏≠„Äç„Äå‰Ωé„Äç„ÅßÂßã„Åæ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„ÇíÊé°Áî®
    if (/^È´ò/.test(t)) return 'high';
    if (/^‰∏≠/.test(t)) return 'medium';
    if (/^‰Ωé/.test(t)) return 'low';
    // ÂÖàÈ†≠„Å´„Å™„ÅÑÂ†¥Âêà: „Äå„ÄÇ„Äç„ÇÑ„ÄåÔºà„Äç„ÅÆÂâç„ÅÆÈÉ®ÂàÜ„ÅßÂà§ÂÆö
    const prefix = t.split(/[„ÄÇÔºà(]/)[0];
    if (prefix.includes('È´ò')) return 'high';
    if (prefix.includes('‰∏≠')) return 'medium';
    if (prefix.includes('‰Ωé')) return 'low';
    return 'unknown';
  }

  // ÂÆâÂÖ®ÊÄß„Çπ„Ç≥„Ç¢ (0-100) ‚Äî „Éô„Éº„Çπ„É©„Ç§„É≥50„ÄÅÂêÑÈ†ÖÁõÆ„ÅßÂä†Ê∏õÁÇπ
  let scoreSafety = 50;

  const floodRisk = riskLevel(prop.hazard_flood);
  if (floodRisk === 'low') scoreSafety += 15;
  else if (floodRisk === 'medium') scoreSafety -= 10;
  else if (floodRisk === 'high') scoreSafety -= 25;

  const sedimentRisk = riskLevel(prop.hazard_sediment);
  if (sedimentRisk === 'low') scoreSafety += 15;
  else if (sedimentRisk === 'medium') scoreSafety -= 15;
  else if (sedimentRisk === 'high') scoreSafety -= 30;

  const tsunamiRisk = riskLevel(prop.hazard_tsunami);
  if (tsunamiRisk === 'low') scoreSafety += 10;
  else if (tsunamiRisk === 'medium') scoreSafety -= 10;
  else if (tsunamiRisk === 'high') scoreSafety -= 20;

  if (prop.ground_type) {
    if (prop.ground_type.includes('Âè∞Âú∞') || prop.ground_type.includes('‰∏òÈôµ')) scoreSafety += 10;
    else if (prop.ground_type.includes('Ê≤ñÁ©ç') || prop.ground_type.includes('ÂüãÁ´ã')) scoreSafety -= 15;
  }

  // Áâ©‰ª∂ÊÉÖÂ†±„ÅÆhazard„Éï„Ç£„Éº„É´„Éâ„Å´ÊòéÁ¢∫„Å™ÊåáÂÆöË®òËºâ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÊ∏õÁÇπ
  // „ÄåÊåáÂÆöÊúâ„Äç„ÄåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄçÁ≠â„ÅÆÁ¢∫ÂÆöË°®Áèæ„ÅÆ„ÅøÂØæË±°Ôºà„ÄåÂèØËÉΩÊÄß„Äç„ÄåÊé®ÂÆö„Äç„ÅØÈô§Â§ñÔºâ
  if (prop.hazard) {
    if (/ÊåáÂÆöÊúâ|ÊåáÂÆö„Åï„Çå„Å¶|Ë©≤ÂΩì„Åó„Å¶|Âå∫ÂüüÂÜÖ/.test(prop.hazard)) scoreSafety -= 15;
  }

  // Âà©‰æøÊÄß„Çπ„Ç≥„Ç¢ (0-100)
  let scoreConvenience = 50;
  const extractDist = (str) => {
    if (!str) return null;
    const m = str.match(/(\d+)m/);
    return m ? parseInt(m[1]) : null;
  };
  const superDist = extractDist(prop.nearest_supermarket);
  if (superDist) { scoreConvenience += superDist < 500 ? 20 : superDist < 1000 ? 10 : superDist < 2000 ? 0 : -10; }
  const hospDist = extractDist(prop.nearest_hospital);
  if (hospDist) { scoreConvenience += hospDist < 1000 ? 10 : hospDist < 2000 ? 5 : 0; }
  const parkDist = extractDist(prop.nearest_park);
  if (parkDist) { scoreConvenience += parkDist < 500 ? 10 : parkDist < 1000 ? 5 : 0; }
  if (prop.school_elementary) {
    const schoolDist = extractDist(prop.school_elementary);
    if (schoolDist) { scoreConvenience += schoolDist < 800 ? 10 : schoolDist < 1500 ? 5 : 0; }
  }

  // „Ç≥„Çπ„Éà„Çπ„Ç≥„Ç¢ (0-100) ‚Äî ËøΩÂä†Ë≤ªÁî®„É™„Çπ„ÇØ„Åå‰∏ªËª∏„ÄÅ„Ç®„É™„Ç¢Áõ∏Â†¥„ÅØÂèÇËÄÉÁ®ãÂ∫¶
  // ËøΩÂä†„Ç≥„Çπ„Éà„ÅåÂ∞ë„Å™„ÅÑÁâ©‰ª∂„Åª„Å©È´ò„Çπ„Ç≥„Ç¢„Å´„Åô„Çã
  let scoreCost = 70; // ËøΩÂä†„Ç≥„Çπ„Éà„Å™„Åó„Å™„Çâ„Éô„Éº„Çπ70

  // AIÂà§ÂÆö„Å´„Çà„ÇãËøΩÂä†„Ç≥„Çπ„ÉàÊ∏õÁÇπÔºà‰∏ªËª∏: 0„Äú-50„ÅÆÁØÑÂõ≤Ôºâ
  if (prop.extra_cost_score != null && typeof prop.extra_cost_score === 'number') {
    scoreCost += prop.extra_cost_score; // Ë≤†„ÅÆÂÄ§„ÅåÂä†ÁÆó„Åï„Çå„ÇãÔºàÊ∏õÁÇπÔºâ
  }

  // „Ç®„É™„Ç¢Áõ∏Â†¥ÊØîËºÉÔºàÂèÇËÄÉ: Êéß„Åà„ÇÅ„Å™Âä†Ê∏õÁÇπÔºâ
  if (prop.price && prop.land_area) {
    const tsuboPrice = prop.price / (prop.land_area / 3.305785) / 10000; // ‰∏áÂÜÜ/Âù™
    let areaData = AREAS.find(a => a.id === prop.area_id);
    if (!areaData && prop.address) areaData = AREAS.find(a => prop.address.includes(a.name));
    if (areaData) {
      const areaAvg = areaData.pricePerTsubo / 10000; // ‰∏áÂÜÜ/Âù™
      const ratio = tsuboPrice / areaAvg;
      if (ratio < 0.7) scoreCost += 15;       // Áõ∏Â†¥„Çà„Çä„Åã„Å™„ÇäÂÆâ„ÅÑ
      else if (ratio < 0.9) scoreCost += 8;   // Áõ∏Â†¥„Çà„Çä„ÇÑ„ÇÑÂÆâ„ÅÑ
      else if (ratio < 1.1) scoreCost += 0;   // Áõ∏Â†¥‰∏¶„Åø
      else if (ratio > 1.3) scoreCost -= 10;  // Áõ∏Â†¥„Çà„Çä„Åã„Å™„ÇäÈ´ò„ÅÑ
      else if (ratio > 1.1) scoreCost -= 5;   // Áõ∏Â†¥„Çà„Çä„ÇÑ„ÇÑÈ´ò„ÅÑ
    }
  }

  // „É©„Ç§„Éï„Çπ„Çø„Ç§„É´„Çπ„Ç≥„Ç¢
  const lifestyle = calculateLifestyleScore(prop, userProfile || null);

  // Á∑èÂêà„Çπ„Ç≥„Ç¢
  let scoreTotal;
  if (lifestyle !== null) {
    scoreTotal = Math.round(scoreSafety * 0.25 + scoreConvenience * 0.25 + scoreCost * 0.25 + lifestyle * 0.25);
  } else {
    scoreTotal = Math.round(scoreSafety * 0.35 + scoreConvenience * 0.35 + scoreCost * 0.3);
  }

  return {
    score_safety: Math.max(0, Math.min(100, Math.round(scoreSafety))),
    score_convenience: Math.max(0, Math.min(100, Math.round(scoreConvenience))),
    score_cost: Math.max(0, Math.min(100, Math.round(scoreCost))),
    score_lifestyle: lifestyle,
    score_total: Math.max(0, Math.min(100, scoreTotal)),
  };
}

function getScoreColor(score) {
  if (score >= 70) return '#16a34a'; // green
  if (score >= 45) return '#d97706'; // amber
  return '#dc2626'; // red
}

function renderScoreBar(label, score) {
  if (score == null) return '';
  const color = getScoreColor(score);
  return `<div class="flex items-center gap-2 text-xs">
    <span class="text-gray-500 w-12">${label}</span>
    <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
      <div class="h-full rounded-full" style="width:${score}%;background:${color};"></div>
    </div>
    <span class="font-medium" style="color:${color};">${score}</span>
  </div>`;
}

// ============================================================
// Âª∫ÁØâË≤ª„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
// ============================================================
function calcBuildingCost(prop) {
  const landArea = prop.land_area;
  const price = prop.price;
  if (!landArea || !price) return null;

  const parsePct = str => {
    if (!str) return null;
    const m = String(str).match(/([\d.]+)/);
    return m ? parseFloat(m[1]) / 100 : null;
  };

  const coverageRate = parsePct(prop.building_coverage);
  const farRate = parsePct(prop.floor_area_ratio);
  if (coverageRate === null || farRate === null) return null;

  const maxBuildingArea = landArea * coverageRate;
  const maxFloorArea = landArea * farRate;
  const maxFloorAreaTsubo = maxFloorArea / 3.305785;

  const costLow = maxFloorAreaTsubo * 500000;
  const costStd = maxFloorAreaTsubo * 650000;
  const costHigh = maxFloorAreaTsubo * 850000;

  const misc = (price + costStd) * 0.08;
  const totalEstimate = price + costStd + misc;

  return { maxBuildingArea, maxFloorArea, maxFloorAreaTsubo, costLow, costStd, costHigh, misc, totalEstimate };
}

// ============================================================
// CSV Export
// ============================================================
function exportComparisonCSV() {
  const comp = state.soComparison;
  if (!comp || !comp.properties || comp.properties.length === 0) { alert('ÊØîËºÉË°®„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
  const props = comp.properties;
  const labels = ['A','B','C','D','E'];

  const allKeys = [
    { label: 'Áâ©‰ª∂', fmt: (p, i) => 'Áâ©‰ª∂' + labels[i] },
    { label: 'ÊâÄÂú®Âú∞', fmt: p => p.address || '' },
    { label: '‰æ°Ê†º(‰∏áÂÜÜ)', fmt: p => p.price ? (p.price / 10000) : '' },
    { label: 'ÂúüÂú∞Èù¢Á©ç(„é°)', fmt: p => p.land_area || '' },
    { label: 'Âù™Âçò‰æ°(‰∏áÂÜÜ)', fmt: p => p.price && p.land_area ? (p.price / (p.land_area / 3.305785) / 10000).toFixed(1) : '' },
    { label: 'ÈßÖË∑ùÈõ¢', fmt: p => p.station_distance || '' },
    { label: 'Áî®ÈÄîÂú∞Âüü', fmt: p => p.zoning || '' },
    { label: 'Âª∫„Å∫„ÅÑÁéá', fmt: p => p.building_coverage || '' },
    { label: 'ÂÆπÁ©çÁéá', fmt: p => p.floor_area_ratio || '' },
    { label: 'Êé•ÈÅì', fmt: p => p.road_access || '' },
    { label: '„Ç§„É≥„Éï„É©', fmt: p => p.infrastructure || '' },
    { label: '„Éè„Ç∂„Éº„Éâ', fmt: p => p.hazard || '' },
    { label: 'Â∞èÂ≠¶Ê†°Âå∫', fmt: p => p.school_elementary || '' },
    { label: '‰∏≠Â≠¶Ê†°Âå∫', fmt: p => p.school_junior_high || '' },
    { label: 'ÊúÄÂØÑ„Çπ„Éº„Éë„Éº', fmt: p => p.nearest_supermarket || '' },
    { label: 'ÊúÄÂØÑÁóÖÈô¢', fmt: p => p.nearest_hospital || '' },
    { label: 'Ê¥™Ê∞¥„É™„Çπ„ÇØ', fmt: p => p.hazard_flood || '' },
    { label: 'ÂúüÁ†ÇÁÅΩÂÆ≥', fmt: p => p.hazard_sediment || '' },
    { label: 'Âú∞Áõ§', fmt: p => p.ground_type || '' },
    { label: 'Âª∫ÁØâË≤ªÁ∑èÈ°çÁõÆÂÆâ(‰∏áÂÜÜ)', fmt: p => { const c = calcBuildingCost(p); return c ? (c.totalEstimate / 10000).toFixed(0) : ''; } },
    { label: 'Âª∫ÁØâË≤ª„É≠„Éº„Ç≥„Çπ„Éà(‰∏áÂÜÜ)', fmt: p => { const c = calcBuildingCost(p); return c ? (c.costLow / 10000).toFixed(0) : ''; } },
    { label: 'Âª∫ÁØâË≤ª„Çπ„Çø„É≥„ÉÄ„Éº„Éâ(‰∏áÂÜÜ)', fmt: p => { const c = calcBuildingCost(p); return c ? (c.costStd / 10000).toFixed(0) : ''; } },
    { label: 'Âª∫ÁØâË≤ª„Éè„Ç§„Ç∞„É¨„Éº„Éâ(‰∏áÂÜÜ)', fmt: p => { const c = calcBuildingCost(p); return c ? (c.costHigh / 10000).toFixed(0) : ''; } },
    { label: 'Ë´∏Ë≤ªÁî®Ê¶ÇÁÆó(‰∏áÂÜÜ)', fmt: p => { const c = calcBuildingCost(p); return c ? (c.misc / 10000).toFixed(0) : ''; } },
    { label: 'AI„Ç≥„É°„É≥„Éà', fmt: p => p.ai_comment || '' },
    { label: '„É°„É¢', fmt: p => p.user_memo || p.memo || '' },
    { label: 'Áâ©‰ª∂URL', fmt: p => p.url || '' },
  ];

  const csvRows = [];
  // „Éò„ÉÉ„ÉÄ„Éº
  csvRows.push(['È†ÖÁõÆ', ...props.map((_, i) => 'Áâ©‰ª∂' + labels[i])].join(','));
  // „Éá„Éº„ÇøË°å
  for (const row of allKeys) {
    const values = props.map((p, i) => {
      const val = row.fmt(p, i);
      // CSV„Ç®„Çπ„Ç±„Éº„Éó
      const str = String(val).replace(/"/g, '""');
      return str.includes(',') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
    });
    csvRows.push([row.label, ...values].join(','));
  }

  const bom = '\uFEFF';
  const blob = new Blob([bom + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (comp.name || 'ÊØîËºÉË°®') + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// SUUMOÊ§úÁ¥¢URLÁîüÊàê
const SUUMO_CITY_CODES = { yokkaichi:'24202', kuwana:'24205', suzuka:'24207', inabe:'24212', kameyama:'24210', komono:'24341', toin:'24343' };
function buildSuumoUrl(areaId, opts = {}) {
  const sc = SUUMO_CITY_CODES[areaId] || '';
  const params = new URLSearchParams({ ar:'060', bs:'030', ta:'24', sc, kb: opts.priceMin || '1', kt: opts.priceMax || '999999', mb: opts.areaMin || '1', mt: opts.areaMax || '999999' });
  if (opts.walkMin) params.set('ek', opts.walkMin);
  return `https://suumo.jp/jj/bukken/ichiran/JJ012FC001/?${params}`;
}
function buildAthomeUrl(areaId, opts = {}) {
  return `https://www.athome.co.jp/tochi/mie/list/?ESSION=true`;
}

// ============================================================
// App State
// ============================================================
const state = {
  savedProperties: [],
  savedComparisons: [],
  soView: null,
  soComparison: null,
  soModalOpen: false,
  soModalType: null,
  soSearchAreaId: null,
  _importUrl: '',
  _aiParsedProperty: null,
  // ‰∏ÄÊã¨Âèñ„ÇäËæº„ÅøÁî®
  _batchUrls: [''],       // URLÂÖ•ÂäõÊ¨Ñ„ÅÆÂÄ§‰∏ÄË¶ß
  _batchResults: [],      // [{url, status, parsed, error, saved}]
  _batchProcessing: false,
  _batchCurrentIndex: -1,
  // Ë™çË®ºUI
  authModalOpen: false,
  authStep: 'email', // 'email' | 'otp'
  authEmail: '',
  authLoading: false,
  authError: '',
  authUser: null, // { id, email, is_anonymous }
  _pendingSaveCompId: null, // „É≠„Ç∞„Ç§„É≥Âæå„Å´‰øùÂ≠ò„Åô„ÇãÊØîËºÉË°®ID
  // „Éû„Ç§„Éö„Éº„Ç∏
  userProfile: null,       // { spouse1_name, spouse1_workplace, ..., priorities[], priorities_freetext }
  _profileLoading: false,
  _profileSaved: false,
};

// ============================================================
// Render
// ============================================================
function render() {
  const app = document.getElementById('app');
  const isMyPage = state.soView === 'mypage';
  app.innerHTML = `
    ${renderHeader()}
    <div class="max-w-6xl mx-auto px-4 py-6">
      ${isMyPage ? '' : renderHeroSection()}
      ${renderPropertyView()}
      ${isMyPage ? '' : renderSEOContent()}
      ${isMyPage ? '' : renderFooter()}
      ${renderSOModal()}
      ${renderAuthModal()}
    </div>
  `;
  bindEvents();
}

function renderHeader() {
  const user = state.authUser;
  const loggedIn = user && !user.is_anonymous && user.email;

  const authHtml = loggedIn
    ? `<div class="flex items-center gap-2">
        <button onclick="state.soView='mypage'; loadUserProfile().then(()=>render());" class="px-2 py-1 text-xs font-medium text-blue-700 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">„Éû„Ç§„Éö„Éº„Ç∏</button>
        <span class="text-xs text-gray-500">${user.email}</span>
        <button onclick="handleLogout()" class="text-xs text-gray-400 hover:text-red-500 transition-colors">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
      </div>`
    : `<button onclick="openAuthModal()" class="px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">„É≠„Ç∞„Ç§„É≥</button>`;

  return `
    <header class="glass border-b border-gray-200">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">üè† Ê≥®Êñá‰ΩèÂÆÖ Áâ©‰ª∂ÊØîËºÉ„ÉÑ„Éº„É´</h1>
            <p class="text-sm text-gray-500 mt-1">Ê∞ó„Å´„Å™„ÇãÁâ©‰ª∂„ÇíAI„ÅßËá™ÂãïÊï¥ÁêÜ„ÄÇË§áÊï∞Áâ©‰ª∂„Çí‰∏¶„Åπ„Å¶ÊØîËºÉ„Åß„Åç„Åæ„Åô</p>
          </div>
          <div class="flex items-center gap-3">
            ${authHtml}
            <a href="/area/mie/" class="hidden sm:block px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors whitespace-nowrap">
              üìä ‰∏âÈáçÁúå„Ç®„É™„Ç¢ÊØîËºÉ ‚Üí
            </a>
          </div>
        </div>
      </div>
    </header>
  `;
}

function renderHeroSection() {
  // Only show when no properties saved yet
  if (state.savedProperties.length > 0) return '';
  return `
    <div class="card p-6 mb-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200">
      <h2 class="text-xl font-bold text-gray-800 mb-3">Ê≥®Êñá‰ΩèÂÆÖ„ÅÆÂúüÂú∞ÈÅ∏„Å≥„ÄÅ„Åì„Çì„Å™„ÅäÊÇ©„Åø„ÅÇ„Çä„Åæ„Åõ„Çì„ÅãÔºü</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
        <div class="bg-white/80 rounded-lg p-3 border border-gray-100">
          <div class="text-lg mb-1">üòµ</div>
          <div class="text-sm text-gray-700">Ë§áÊï∞„Çµ„Ç§„Éà„ÅÆÁâ©‰ª∂ÊÉÖÂ†±„Åå„Éê„É©„Éê„É©„ÅßÊØîËºÉ„Åó„Å´„Åè„ÅÑ</div>
        </div>
        <div class="bg-white/80 rounded-lg p-3 border border-gray-100">
          <div class="text-lg mb-1">üìù</div>
          <div class="text-sm text-gray-700">Excel„Å´„Åæ„Å®„ÇÅ„Çã„ÅÆ„ÅåÈù¢ÂÄí„Åß„ÄÅÁµêÂ±ÄÊÑüË¶ö„ÅßÈÅ∏„Çì„Åß„Åó„Åæ„ÅÜ</div>
        </div>
        <div class="bg-white/80 rounded-lg p-3 border border-gray-100">
          <div class="text-lg mb-1">‚ùì</div>
          <div class="text-sm text-gray-700">Áî®ÈÄîÂú∞Âüü„ÇÑÂª∫„Å∫„ÅÑÁéá„Å™„Å©„ÄÅÁ¢∫Ë™ç„Åô„Åπ„ÅçÈ†ÖÁõÆ„Åå„Çè„Åã„Çâ„Å™„ÅÑ</div>
        </div>
      </div>
      <div class="bg-white rounded-lg p-4 border border-blue-100">
        <h3 class="text-base font-bold text-blue-800 mb-3">„Åì„ÅÆ„ÉÑ„Éº„É´„ÅåËß£Ê±∫„Åó„Åæ„Åô</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="flex items-start gap-2">
            <span class="text-lg">ü§ñ</span>
            <div>
              <div class="text-sm font-medium text-gray-800">AIËá™ÂãïÊï¥ÁêÜ</div>
              <div class="text-xs text-gray-500">URL„ÇíË≤º„Çã„Å†„Åë„ÅßAI„ÅåÁâ©‰ª∂ÊÉÖÂ†±„ÇíËá™ÂãïÊäΩÂá∫</div>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <span class="text-lg">üìã</span>
            <div>
              <div class="text-sm font-medium text-gray-800">‰∏ÄË¶ß„ÅßÊØîËºÉ</div>
              <div class="text-xs text-gray-500">SUUMO„Éª„Ç¢„ÉÉ„Éà„Éõ„Éº„É†Á≠â„ÇíÁµ±‰∏Ä„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅßÊØîËºÉ</div>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <span class="text-lg">üí°</span>
            <div>
              <div class="text-sm font-medium text-gray-800">AIÊ≥®ÊÑèÁÇπÊåáÊëò</div>
              <div class="text-xs text-gray-500">ÊØîËºÉË°®„ÇíAI„ÅåÂàÜÊûê„ÅóÊ≥®ÊÑèÁÇπ„ÇÑ„Åä„Åô„Åô„ÇÅ„ÇíÊåáÊëò</div>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
        <p class="text-sm text-amber-800 font-medium">üìñ ‰Ωø„ÅÑÊñπ„ÅØ„Åã„Çì„Åü„Çì3„Çπ„ÉÜ„ÉÉ„Éó</p>
        <div class="flex flex-col sm:flex-row gap-2 mt-2">
          <div class="flex items-center gap-2 text-sm text-gray-700"><span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">1</span>Áâ©‰ª∂URL„ÇíË≤º„Çä‰ªò„Åë</div>
          <div class="hidden sm:block text-gray-300">‚Üí</div>
          <div class="flex items-center gap-2 text-sm text-gray-700"><span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">2</span>AI„ÅåËá™Âãï„ÅßÊï¥ÁêÜ</div>
          <div class="hidden sm:block text-gray-300">‚Üí</div>
          <div class="flex items-center gap-2 text-sm text-gray-700"><span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">3</span>ÊØîËºÉË°®„Çí‰ΩúÊàê</div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Property View
// ============================================================
function renderMyPage() {
  const p = state.userProfile || {};
  const selectedPriorities = p.priorities || [];
  const loading = state._profileLoading;
  const saved = state._profileSaved;

  const priorityCheckboxes = PRIORITY_OPTIONS.map(opt => {
    const checked = selectedPriorities.includes(opt.key) ? 'checked' : '';
    return `<label class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer select-none">
      <input type="checkbox" name="priority" value="${opt.key}" ${checked} class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="width:18px;height:18px;">
      <span class="text-sm text-gray-700">${opt.label}</span>
    </label>`;
  }).join('');

  return `
    <div class="space-y-6">
      <button onclick="state.soView=null; render();" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
        &larr; Áâ©‰ª∂„É™„Çπ„Éà„Å´Êàª„Çã
      </button>

      <div class="card p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-6">„Éû„Ç§„Éö„Éº„Ç∏</h2>
        <p class="text-sm text-gray-500 mb-6">Âã§ÂãôÂÖà„Å®ÈáçË¶ñÈ†ÖÁõÆ„ÇíÁôªÈå≤„Åô„Çã„Å®„ÄÅÊØîËºÉË°®„Å´„Äå„É©„Ç§„Éï„Çπ„Çø„Ç§„É´„Äç„Çπ„Ç≥„Ç¢„ÅåËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ</p>

        <form id="mypage-form" onsubmit="event.preventDefault(); handleSaveProfile();">
          <!-- ‰∏äÈÉ®‰øùÂ≠ò„Éú„Çø„É≥ -->
          <div class="flex items-center gap-4 mb-6 pb-4 border-b border-gray-200">
            <button type="submit" ${loading ? 'disabled' : ''} style="padding:12px 32px;background:#2563eb;color:#fff;border-radius:8px;font-weight:700;font-size:1rem;border:none;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
              ${loading ? '‚è≥ ‰øùÂ≠ò‰∏≠...' : 'üíæ ‰øùÂ≠ò„Åô„Çã'}
            </button>
            ${saved ? '<span class="text-sm text-green-600 font-medium">‚úÖ ‰øùÂ≠ò„Åó„Åæ„Åó„Åü</span>' : ''}
          </div>
          <!-- Âã§ÂãôÂÖàÊÉÖÂ†± -->
          <div class="mb-8">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold">Âã§ÂãôÂÖàÊÉÖÂ†±</span>
              ÈÄöÂã§Ë∑ùÈõ¢„Åã„Çâ„Çπ„Ç≥„Ç¢„ÇíÁÆóÂá∫„Åó„Åæ„Åô
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-600">ÈÖçÂÅ∂ËÄÖ 1</div>
                <div>
                  <label class="text-xs text-gray-500">„ÅäÂêçÂâçÔºà‰ªªÊÑèÔºâ</label>
                  <input type="text" id="spouse1_name" value="${p.spouse1_name || ''}" placeholder="‰æã: Â§™ÈÉé" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                  <label class="text-xs text-gray-500">Âã§ÂãôÂÖà„ÅÆ‰ΩèÊâÄ</label>
                  <input type="text" id="spouse1_workplace" value="${p.spouse1_workplace || ''}" placeholder="‰æã: ‰∏âÈáçÁúåÂõõÊó•Â∏ÇÂ∏ÇË´èË®™Áî∫1-5" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                ${p.spouse1_lat ? `<div class="text-xs text-green-600">Â∫ßÊ®ôÂèñÂæóÊ∏à„Åø</div>` : ''}
              </div>
              <div class="space-y-3 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-600">ÈÖçÂÅ∂ËÄÖ 2</div>
                <div>
                  <label class="text-xs text-gray-500">„ÅäÂêçÂâçÔºà‰ªªÊÑèÔºâ</label>
                  <input type="text" id="spouse2_name" value="${p.spouse2_name || ''}" placeholder="‰æã: Ëä±Â≠ê" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                  <label class="text-xs text-gray-500">Âã§ÂãôÂÖà„ÅÆ‰ΩèÊâÄ</label>
                  <input type="text" id="spouse2_workplace" value="${p.spouse2_workplace || ''}" placeholder="‰æã: ‰∏âÈáçÁúåÊ¥•Â∏ÇÊ†ÑÁî∫1-891" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                ${p.spouse2_lat ? `<div class="text-xs text-green-600">Â∫ßÊ®ôÂèñÂæóÊ∏à„Åø</div>` : ''}
              </div>
            </div>
          </div>

          <!-- ÈáçË¶ñÈ†ÖÁõÆ -->
          <div class="mb-8">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold">ÈáçË¶ñÈ†ÖÁõÆ</span>
              ÂúüÂú∞„Å´Ê±Ç„ÇÅ„ÇãÊù°‰ª∂„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ
            </h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-1">
              ${priorityCheckboxes}
            </div>
            <div class="mt-4">
              <label class="text-xs text-gray-500">„Åù„ÅÆ‰ªñ„ÉªËá™Áî±Ë®òËø∞</label>
              <textarea id="priorities_freetext" rows="2" placeholder="‰∏äË®ò‰ª•Â§ñ„Å´ÈáçË¶ñ„Åô„Çã„Åì„Å®„Åå„ÅÇ„Çå„Å∞Ë®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${p.priorities_freetext || ''}</textarea>
            </div>
          </div>

          <!-- ‰øùÂ≠ò„Éú„Çø„É≥ -->
          <div class="flex items-center gap-4 pt-4 border-t border-gray-200">
            <button type="submit" ${loading ? 'disabled' : ''} style="padding:12px 32px;background:#2563eb;color:#fff;border-radius:8px;font-weight:700;font-size:1rem;border:none;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
              ${loading ? '‚è≥ ‰øùÂ≠ò‰∏≠...' : 'üíæ ‰øùÂ≠ò„Åô„Çã'}
            </button>
            ${saved ? '<span class="text-sm text-green-600 font-medium animate-pulse">‚úÖ ‰øùÂ≠ò„Åó„Åæ„Åó„Åü</span>' : ''}
          </div>
          <p class="text-xs text-gray-400 mt-3">ÁôªÈå≤„Åó„ÅüÂÜÖÂÆπ„ÅØÊØîËºÉË°®„ÅÆ„Äåüè° „É©„Ç§„Éï„Çπ„Çø„Ç§„É´„Äç„Çπ„Ç≥„Ç¢„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô</p>
        </form>
      </div>
    </div>
  `;
}

function handleSaveProfile() {
  const form = document.getElementById('mypage-form');
  if (!form) return;
  const checkedPriorities = Array.from(form.querySelectorAll('input[name="priority"]:checked')).map(el => el.value);
  const profileData = {
    spouse1_name: document.getElementById('spouse1_name')?.value?.trim() || null,
    spouse1_workplace: document.getElementById('spouse1_workplace')?.value?.trim() || null,
    spouse2_name: document.getElementById('spouse2_name')?.value?.trim() || null,
    spouse2_workplace: document.getElementById('spouse2_workplace')?.value?.trim() || null,
    priorities: checkedPriorities,
    priorities_freetext: document.getElementById('priorities_freetext')?.value?.trim() || null,
  };
  saveUserProfile(profileData);
}

function renderPropertyView() {
  // „Éû„Ç§„Éö„Éº„Ç∏
  if (state.soView === 'mypage') {
    return renderMyPage();
  }

  const savedCount = state.savedProperties.length;
  const compProps = state.savedProperties.filter(p => p.in_comparison);

  // Sub-view: comparison table with sidebar
  if (state.soView === 'compare' && state.soComparison) {
    return renderComparisonWithSidebar();
  }

  const hasSavedComps = state.savedComparisons.length > 0;

  const mainContent = `
    <div class="space-y-4">
      <!-- „Çµ„Ç§„ÉàË™¨Êòé„Çª„ÇØ„Ç∑„Éß„É≥ -->
      <div class="card p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200">
        <h2 class="text-lg font-bold text-gray-800 mb-3">üìä Áâ©‰ª∂ÊØîËºÉ„ÉÑ„Éº„É´„Å®„ÅØÔºü</h2>
        <p class="text-sm text-gray-700 leading-relaxed mb-4">
          Ê∞ó„Å´„Å™„ÇãÁâ©‰ª∂„ÅÆÊÉÖÂ†±„ÇíAI„ÅåËá™Âãï„ÅßÊï¥ÁêÜ„ÉªÊßãÈÄ†Âåñ„ÄÇË§áÊï∞„ÅÆÁâ©‰ª∂„Çí‰∏¶„Åπ„Å¶ÊØîËºÉ„Åó„ÄÅÊúÄÈÅ©„Å™ÂúüÂú∞ÈÅ∏„Å≥„Çí„Çµ„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="bg-white/80 rounded-lg p-3 border border-blue-100">
            <div class="text-lg mb-1">ü§ñ</div>
            <div class="text-sm font-medium text-gray-800 mb-1">AIËá™ÂãïÊï¥ÁêÜ</div>
            <div class="text-xs text-gray-500">Áâ©‰ª∂URL„ÇÑ„ÉÜ„Ç≠„Çπ„Éà„ÇíË≤º„Çã„Å†„Åë„Åß„ÄÅAI„Åå‰æ°Ê†º„ÉªÈù¢Á©ç„ÉªÁ´ãÂú∞„Å™„Å©ÈáçË¶ÅÈ†ÖÁõÆ„ÇíËá™Âãï„ÅßÊäΩÂá∫„ÉªÊï¥ÁêÜ„Åó„Åæ„Åô</div>
          </div>
          <div class="bg-white/80 rounded-lg p-3 border border-blue-100">
            <div class="text-lg mb-1">üìã</div>
            <div class="text-sm font-medium text-gray-800 mb-1">‰∏ÄË¶ß„ÅßÊØîËºÉ</div>
            <div class="text-xs text-gray-500">SUUMO„Éª„Ç¢„ÉÉ„Éà„Éõ„Éº„É†Á≠â„ÅÆË§áÊï∞„Çµ„Ç§„Éà„ÅÆÁâ©‰ª∂„ÇíÁµ±‰∏Ä„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Åß‰∏ÄË¶ßÊØîËºÉ„ÄÇË¶ãËêΩ„Å®„Åó„ÇíÈò≤„Åé„Åæ„Åô</div>
          </div>
          <div class="bg-white/80 rounded-lg p-3 border border-blue-100">
            <div class="text-lg mb-1">üí°</div>
            <div class="text-sm font-medium text-gray-800 mb-1">AI„ÅåÊ≥®ÊÑèÁÇπ„ÇíÊåáÊëò</div>
            <div class="text-xs text-gray-500">ÊØîËºÉË°®„ÇíAI„ÅåÂàÜÊûê„Åó„ÄÅÂêÑÁâ©‰ª∂„ÅÆÊ≥®ÊÑèÁÇπ„ÇÑ„Åä„Åô„Åô„ÇÅ„Éù„Ç§„É≥„Éà„Çí„Ç≥„É°„É≥„Éà„ÄÇÂà§Êñ≠ÊùêÊñô„ÅåÂ¢ó„Åà„Åæ„Åô</div>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-800">üè† ‰øùÂ≠ò„Åó„ÅüÁâ©‰ª∂${savedCount > 0 ? `Ôºà${savedCount}‰ª∂Ôºâ` : ''}</h2>
        ${savedCount > 0 ? `<div class="flex gap-2">
          <button onclick="clearAllProperties()" class="text-xs text-gray-400 hover:text-red-500 transition-colors">ÂÖ®‰ª∂ÂâäÈô§</button>
        </div>` : ''}
      </div>

      <!-- Áâ©‰ª∂Âèñ„ÇäËæº„Åø„Çª„ÇØ„Ç∑„Éß„É≥ÔºàÂ∏∏„Å´Ë°®Á§∫Ôºâ -->
      <div class="card p-5 space-y-3 border-green-200 bg-green-50/30">
        <h3 class="text-sm font-bold text-gray-700">ü§ñ Áâ©‰ª∂ÊÉÖÂ†±„ÇíAI„ÅßÂèñ„ÇäËæº„Åø</h3>
        <p class="text-xs text-gray-500">‰∏çÂãïÁî£„Çµ„Ç§„Éà„ÅÆÁâ©‰ª∂„Éö„Éº„Ç∏URL„ÇíË≤º„Çä‰ªò„Åë„Å¶AIÂèñ„ÇäËæº„Åø„ÄÇ<span class="text-green-600 font-medium">Ë§áÊï∞‰ª∂„Åæ„Å®„ÇÅ„Å¶Âèñ„ÇäËæº„ÅøOKÔºÅ</span></p>
        <div class="flex gap-2">
          <input id="url-import-property" type="url" placeholder="Áâ©‰ª∂URL„ÇíË≤º„Çä‰ªò„ÅëÔºàhttps://suumo.jp/...Ôºâ" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" />
          <button onclick="openImportModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors whitespace-nowrap">
            ü§ñ AIÂèñ„ÇäËæº„Åø
          </button>
        </div>
      </div>

      ${savedCount === 0 ? `
        <div class="card p-8 text-center">
          <div class="text-4xl mb-3">üè†</div>
          <p class="text-gray-600 font-medium mb-2">„Åæ„Å†Áâ©‰ª∂„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
          <p class="text-sm text-gray-400">‰∏ä„ÅÆ„Éï„Ç©„Éº„É†„Åã„ÇâÁâ©‰ª∂URL„ÇÑ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñ„ÇäËæº„Çì„Åß<br>‰øùÂ≠ò„ÉªÊØîËºÉ„Åß„Åç„Åæ„Åô</p>
        </div>
      ` : `
        <div class="grid grid-cols-1 gap-3">
          ${state.savedProperties.map(prop => {
            const badgeClass = prop.badge === 'red' ? 'so-badge-red' : prop.badge === 'yellow' ? 'so-badge-yellow' : 'so-badge-none';
            const badgeLabel = prop.badge === 'red' ? 'üî¥ Ê≥®ÊÑè' : prop.badge === 'yellow' ? 'üü° Ë¶ÅÁ¢∫Ë™ç' : 'üü¢ OK';
            const areaName = AREAS.find(a => a.id === prop.area_id)?.name || (prop.address ? AREAS.find(a => prop.address.includes(a.name))?.name : '') || '';
            const priceStr = prop.price ? `${(prop.price / 10000).toLocaleString()}‰∏áÂÜÜ` : '‰æ°Ê†ºÊú™ÂÖ•Âäõ';
            const tsuboPriceStr = (prop.price && prop.land_area) ? `ÔºàÂù™${(prop.price / (prop.land_area / 3.305785) / 10000).toFixed(1)}‰∏áÔºâ` : '';
            const areaStr = prop.land_area ? `${(prop.land_area / 3.305785).toFixed(1)}Âù™Ôºà${prop.land_area}„é°Ôºâ` : 'Èù¢Á©çÊú™ÂÖ•Âäõ';
            // ‰ΩçÁΩÆÁ≤æÂ∫¶„Éê„ÉÉ„Ç∏
            const geoConf = prop.geo_confidence;
            const geoBadge = geoConf === 'high' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#dcfce7;color:#166534;border:1px solid #86efac;">üìç È´òÁ≤æÂ∫¶</span>'
              : geoConf === 'medium' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fef9c3;color:#854d0e;border:1px solid #fde047;">üìç ‰∏≠Á≤æÂ∫¶</span>'
              : geoConf === 'low' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;">üìç ‰ΩéÁ≤æÂ∫¶</span>'
              : '';
            const mapLink = (prop.lat && prop.lng) ? `<a href="https://www.google.com/maps?q=${prop.lat},${prop.lng}" target="_blank" rel="noopener" class="text-xs text-green-600 hover:underline">üó∫Ô∏è Âú∞Âõ≥„ÅßÁ¢∫Ë™ç</a>` : '';
            // enrichment„Çπ„ÉÜ„Éº„Çø„Çπ
            const enrichBadge = prop.enrichment_status === 'done' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#dbeafe;color:#1e40af;border:1px solid #93c5fd;">‚úÖ Ë©≥Á¥∞ÊÉÖÂ†±„ÅÇ„Çä</span>'
              : prop.enrichment_status === 'pending' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fef3c7;color:#92400e;border:1px solid #fbbf24;">‚è≥ Ë©≥Á¥∞ÂèñÂæó‰∏≠</span>'
              : prop.enrichment_status === 'error' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;">‚ùå ÂèñÂæóÂ§±Êïó</span>'
              : '';
            // enrichment„Éú„Çø„É≥Ë°®Á§∫Êù°‰ª∂
            const canEnrich = prop.lat && prop.lng && !prop.enrichment_status;
            const canRetryEnrich = prop.lat && prop.lng && prop.enrichment_status === 'error';
            // enrichmentË©≥Á¥∞Ë°®Á§∫ + „Çπ„Ç≥„Ç¢
            const enrichDetails = prop.enrichment_status === 'done' ? (() => {
              const scores = calculateScores(prop, state.userProfile);
              const lifestyleBar = scores && scores.score_lifestyle != null ? renderScoreBar('„É©„Ç§„Éï', scores.score_lifestyle) : '';
              const scoreSection = scores ? '<div class="grid grid-cols-2 gap-1 mb-2">' +
                renderScoreBar('ÂÆâÂÖ®', scores.score_safety) +
                renderScoreBar('Âà©‰æø', scores.score_convenience) +
                renderScoreBar('„Ç≥„Çπ„Éà', scores.score_cost) +
                lifestyleBar +
                '<div class="flex items-center gap-2 text-xs"><span class="text-gray-500 w-12">Á∑èÂêà</span><div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden"><div class="h-full rounded-full" style="width:' + scores.score_total + '%;background:' + getScoreColor(scores.score_total) + ';"></div></div><span class="font-bold" style="color:' + getScoreColor(scores.score_total) + ';">' + scores.score_total + '</span></div>' +
                '</div>' : '';
              const items = [];
              if (prop.school_elementary) items.push('üè´ ' + prop.school_elementary);
              if (prop.school_junior_high) items.push('üè´ ' + prop.school_junior_high);
              if (prop.nearest_supermarket) items.push('üõí ' + prop.nearest_supermarket);
              if (prop.nearest_hospital) items.push('üè• ' + prop.nearest_hospital);
              if (prop.nearest_park) items.push('üå≥ ' + prop.nearest_park);
              if (prop.hazard_flood) items.push('üåä Ê¥™Ê∞¥: ' + prop.hazard_flood);
              if (prop.hazard_sediment) items.push('‚õ∞Ô∏è ÂúüÁ†Ç: ' + prop.hazard_sediment);
              if (prop.ground_type) items.push('ü™® Âú∞Áõ§: ' + prop.ground_type);
              if (prop.ai_comment) items.push('üí¨ ' + prop.ai_comment);
              // ËøΩÂä†„Ç≥„Çπ„ÉàË¶ÅÂõ†„ÅÆË°®Á§∫
              const costReasonHtml = (prop.extra_cost_reasons && prop.extra_cost_score != null && prop.extra_cost_score < 0)
                ? '<div class="mt-1 p-1.5 bg-amber-50 rounded border border-amber-200">' +
                  '<div class="text-xs font-medium text-amber-800 mb-0.5">üí∞ ËøΩÂä†„Ç≥„Çπ„ÉàË¶ÅÂõ†Ôºà' + Math.abs(prop.extra_cost_score) + 'ÁÇπÊ∏õÁÇπÔºâ</div>' +
                  '<div class="text-xs text-amber-700">' + prop.extra_cost_reasons.split('„ÄÅ').map(r => '„Éª' + r.trim()).join('<br>') + '</div>' +
                  '</div>' : '';
              // „É©„Ç§„Éï„Çπ„Çø„Ç§„É´„Çπ„Ç≥„Ç¢Ê†πÊã†
              const lifestyleReasons = getLifestyleBreakdown(prop, state.userProfile);
              const lifestyleReasonHtml = (lifestyleReasons && lifestyleReasons.length > 0)
                ? '<div class="mt-1 p-1.5 bg-blue-50 rounded border border-blue-200">' +
                  '<div class="text-xs font-medium text-blue-800 mb-0.5">üè° „É©„Ç§„Éï„Çπ„Çø„Ç§„É´Ê†πÊã†Ôºà„Çπ„Ç≥„Ç¢ ' + (scores ? scores.score_lifestyle : '-') + 'Ôºâ</div>' +
                  '<div class="text-xs text-blue-700">' + lifestyleReasons.map(r => '„Éª' + r).join('<br>') + '</div>' +
                  '</div>' : '';
              return (scoreSection || items.length > 0 || costReasonHtml || lifestyleReasonHtml) ? '<div class="mt-2 p-2 bg-blue-50 rounded border border-blue-100 space-y-1">' +
                scoreSection +
                items.map(i => '<div class="text-xs text-gray-600">' + i + '</div>').join('') +
                costReasonHtml +
                lifestyleReasonHtml +
                '</div>' : '';
            })() : '';
            return `
              <div class="card p-4">
                <div class="flex items-start justify-between">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                      <span class="${badgeClass}" style="font-size:11px;padding:2px 8px;border-radius:9999px;">${badgeLabel}</span>
                      ${geoBadge}
                      ${enrichBadge}
                      ${areaName ? `<span class="text-xs text-gray-400">${areaName}</span>` : ''}
                    </div>
                    <div class="text-sm font-medium text-gray-800">${prop.address || '‰ΩèÊâÄÊú™ÂÖ•Âäõ'}</div>
                    <div class="flex items-center gap-3 mt-1 text-sm">
                      <span class="font-bold text-blue-700">${priceStr}</span><span class="text-xs text-gray-400">${tsuboPriceStr}</span>
                      <span class="text-gray-500">${areaStr}</span>
                    </div>
                    ${prop.station_distance ? `<div class="text-xs text-gray-400 mt-1">üöÉ ${prop.station_distance}</div>` : ''}
                    ${prop.user_memo ? `<div class="text-xs text-gray-500 mt-1 bg-green-50 rounded px-2 py-1">üìù ${prop.user_memo}</div>` : (prop.memo ? `<div class="text-xs text-gray-500 mt-1 bg-gray-50 rounded px-2 py-1">üí° ${prop.memo}</div>` : '')}
                    <div class="flex items-center gap-3 mt-1">
                      ${prop.url ? `<a href="${prop.url}" target="_blank" rel="noopener" class="text-xs text-blue-500 hover:underline">üîó Áâ©‰ª∂„Éö„Éº„Ç∏</a>` : ''}
                      ${mapLink}
                    </div>
                    ${enrichDetails}
                  </div>
                  <div class="flex flex-col gap-1 ml-3">
                    <button onclick="handleToggleComparison('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border transition-colors ${prop.in_comparison ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-600 border-gray-300 hover:bg-blue-50'}">
                      ${prop.in_comparison ? '‚úì ÊØîËºÉ‰∏≠' : 'ÊØîËºÉ„Å´ËøΩÂä†'}
                    </button>
                    ${canEnrich || canRetryEnrich ? `<button onclick="handleEnrichProperty('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border border-purple-200 text-purple-600 hover:bg-purple-50 transition-colors">üîç Ë©≥Á¥∞ÂèñÂæó</button>` : ''}
                    <button onclick="handleDeleteProperty('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border border-gray-200 text-gray-400 hover:text-red-500 hover:border-red-300 transition-colors">ÂâäÈô§</button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        ${compProps.length > 0 ? `
          <div class="card p-4 bg-blue-50 border-blue-200">
            <div class="flex items-center justify-between">
              <div>
                <span class="text-sm font-medium text-blue-800">üìä ÊØîËºÉ„Å´ËøΩÂä†: ${compProps.length}‰ª∂</span>
                <span class="text-xs text-blue-500 ml-2">${compProps.length < 2 ? 'Ôºà2‰ª∂‰ª•‰∏ä„ÅßÊØîËºÉÂèØËÉΩÔºâ' : ''}</span>
              </div>
              <button onclick="handleGenerateComparison()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors ${compProps.length < 2 ? 'opacity-50 cursor-not-allowed' : ''}" ${compProps.length < 2 ? 'disabled' : ''}>
                ÊØîËºÉË°®„Çí‰ΩúÊàê
              </button>
            </div>
          </div>
        ` : ''}
      `}
    </div>
  `;

  // „Çµ„Ç§„Éâ„Éê„Éº„ÅÇ„ÇäÔºàÈÅéÂéª„ÅÆÊØîËºÉË°®„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
  if (hasSavedComps) {
    return `
      <div class="flex gap-4 fade-in comp-layout-sidebar">
        ${renderComparisonSidebar()}
        <div class="flex-1 min-w-0">${mainContent}</div>
      </div>
    `;
  }
  // „Çµ„Ç§„Éâ„Éê„Éº„Å™„Åó
  return `<div class="fade-in">${mainContent}</div>`;
}

// ============================================================
// Second Opinion: Comparison Table
// ============================================================
function renderComparisonSidebar() {
  const comps = state.savedComparisons;
  const currentId = state.soComparison?.id;
  const isCompareView = state.soView === 'compare' && state.soComparison;

  const headerIcon = `<svg class="comp-sidebar-header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="5" rx="1"/><rect x="2" y="10" width="20" height="5" rx="1"/><rect x="2" y="17" width="20" height="5" rx="1"/></svg>`;
  const backArrow = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>`;
  const emptyIcon = `<svg class="comp-sidebar-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`;

  return `
    <div class="flex-shrink-0" style="width:220px;">
      <!-- „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÁâà„Çµ„Ç§„Éâ„Éê„Éº -->
      <div class="comp-sidebar-desktop">
        <div class="comp-sidebar-card">
          <div class="comp-sidebar-header">
            <div class="comp-sidebar-header-title">${headerIcon} ÊØîËºÉË°®‰∏ÄË¶ß</div>
            ${comps.length > 0 ? `<span class="comp-sidebar-count-badge">${comps.length}</span>` : ''}
          </div>
          ${isCompareView ? `
            <button onclick="state.soView=null; state.soComparison=null; render();" class="comp-sidebar-back-btn">
              ${backArrow} Áâ©‰ª∂„É™„Çπ„Éà„Å´Êàª„Çã
            </button>
          ` : ''}
          <div class="comp-sidebar-list">
            ${comps.length === 0 ? `
              <div class="comp-sidebar-empty">
                ${emptyIcon}
                ÊØîËºÉË°®„Çí‰ΩúÊàê„Åô„Çã„Å®<br>„Åì„Åì„Å´‰∏ÄË¶ßË°®Á§∫„Åï„Çå„Åæ„Åô
              </div>
            ` : ''}
            ${comps.map(c => {
              const isActive = isCompareView && c.id === currentId;
              const dateStr = c.created_at ? new Date(c.created_at).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }) : '';
              const count = (c.property_ids || []).length;
              return `
                <div class="comp-sidebar-item ${isActive ? 'active' : ''}" onclick="loadComparisonDetail('${c.id}')">
                  <div class="flex-1 min-w-0">
                    <div class="comp-sidebar-item-name">${c.name || 'ÊØîËºÉË°®'}</div>
                    <div class="comp-sidebar-item-meta">
                      <span>${dateStr}</span>
                      <span class="comp-sidebar-item-meta-dot"></span>
                      <span class="comp-sidebar-item-count">${count}‰ª∂</span>
                    </div>
                  </div>
                  <button onclick="event.stopPropagation(); handleDeleteComparison('${c.id}')" class="comp-sidebar-delete-btn" title="ÂâäÈô§">‚úï</button>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
      <!-- „É¢„Éê„Ç§„É´Áâà„Ç≥„É≥„Éë„ÇØ„Éà„Éê„Éº -->
      <div class="comp-sidebar-mobile">
        <button class="comp-mobile-back-btn" onclick="state.soView=null; state.soComparison=null; render();" title="Áâ©‰ª∂„É™„Çπ„Éà„Å∏Êàª„Çã">‚Üê</button>
        <select onchange="if(this.value) loadComparisonDetail(this.value);">
          ${comps.length === 0 ? `<option value="">ÊØîËºÉË°®„Å™„Åó</option>` : ''}
          ${comps.map(c => {
            const dateStr = c.created_at ? new Date(c.created_at).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }) : '';
            const n = (c.property_ids||[]).length;
            return `<option value="${c.id}" ${c.id === currentId ? 'selected' : ''}>${c.name || 'ÊØîËºÉË°®'} (${dateStr} ${n}‰ª∂)</option>`;
          }).join('')}
        </select>
        <span class="comp-mobile-count">${comps.length}Ë°®</span>
      </div>
    </div>
  `;
}

function renderComparisonWithSidebar() {
  return `
    <div class="flex gap-4 fade-in comp-layout-sidebar" style="min-height:60vh;">
      ${renderComparisonSidebar()}
      <div class="flex-1 min-w-0">
        ${renderComparisonTable()}
      </div>
    </div>
  `;
}

function renderComparisonTable() {
  const comp = state.soComparison;
  if (!comp) return '';
  const props = comp.properties || [];
  if (props.length === 0) return '';

  const labels = ['A','B','C','D','E'];
  const COLORS = ['#2563eb','#16a34a','#9333ea','#f59e0b','#ef4444'];

  // ===== „Çπ„Ç≥„Ç¢Ë®àÁÆó =====
  const allScores = props.map(p => calculateScores(p, state.userProfile));
  const hasScores = allScores.some(s => s);
  const maxTotal = Math.max(...allScores.map(s => s ? s.score_total : 0));
  const bestIdx = hasScores ? allScores.findIndex(s => s && s.score_total === maxTotal && maxTotal > 0) : -1;
  const hasLifestyle = allScores.some(s => s && s.score_lifestyle !== null);

  // ===== „Çπ„Ç≥„Ç¢Ëâ≤ =====
  function sc(v) { return v >= 80 ? '#16a34a' : v >= 60 ? '#2563eb' : v >= 40 ? '#f59e0b' : '#dc2626'; }

  // ===== Âª∫ÁØâË≤ª =====
  const costs = props.map(p => calcBuildingCost(p));
  const fmtYen = v => v >= 100000000 ? (v/100000000).toFixed(2) + 'ÂÑÑÂÜÜ' : (v/10000).toLocaleString() + '‰∏áÂÜÜ';

  // ===== „Éè„Ç∂„Éº„Éâ„É™„Çπ„ÇØ„É¨„Éô„É´ =====
  function compRiskLevel(text) {
    if (!text) return 'unknown';
    const first = text.split(/[„ÄÇÔºà(]/)[0].trim();
    if (/^È´ò/.test(first)) return 'high';
    if (/^‰∏≠/.test(first)) return 'mid';
    if (/^‰Ωé/.test(first)) return 'low';
    if (first.includes('È´ò')) return 'high';
    if (first.includes('‰∏≠')) return 'mid';
    return 'low';
  }
  function compRiskBadgeHtml(text, id) {
    if (!text) return '<span style="color:#9ca3af;">‚Äî</span>';
    const level = compRiskLevel(text);
    const cls = level === 'high' ? 'so-comp-hz-high' : level === 'mid' ? 'so-comp-hz-mid' : 'so-comp-hz-low';
    const lbl = level === 'high' ? 'È´ò' : level === 'mid' ? '‰∏≠' : '‰Ωé';
    return '<div>' +
      '<span class="so-comp-hz-badge ' + cls + '" onclick="event.stopPropagation();toggleCompHzDetail(\'' + id + '\')">' +
      (lbl === '‰Ωé' ? '‚úì' : '‚ö†') + ' ' + lbl + '„É™„Çπ„ÇØ <span style="font-size:9px;opacity:0.7;">‚ñº</span></span>' +
      '<div class="so-comp-hz-detail" id="' + id + '">' + text + '</div></div>';
  }

  // ===== questions =====
  let questions = [];
  try { questions = typeof comp.questions === 'string' ? JSON.parse(comp.questions) : (comp.questions || []); } catch(e) { questions = []; }
  if (typeof questions === 'string') questions = questions.split('\n').filter(q => q.trim());

  // ===== Á∑®ÈõÜÂèØËÉΩ„Çª„É´Ôºà„ÉÜ„Éº„Éñ„É´Áî®Ôºâ =====
  function editTd(prop, key, displayVal, editType) {
    if (!editType) return '<td style="padding:8px 10px;font-size:12px;color:#1f2937;min-width:120px;border-bottom:1px solid #f3f4f6;vertical-align:top;">' + displayVal + '</td>';
    return '<td class="so-comp-editable-cell" style="padding:8px 10px;font-size:12px;color:#1f2937;min-width:120px;border-bottom:1px solid #f3f4f6;vertical-align:top;" onclick="startCellEdit(this, \'' + prop.id + '\', \'' + key + '\', \'' + editType + '\')" title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Á∑®ÈõÜ">' + displayVal + '<span style="color:#d1d5db;font-size:10px;margin-left:3px;">‚úèÔ∏è</span></td>';
  }

  // ===== „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ =====
  const summaryCards = `<div class="so-comp-summary-bar">
    ${props.map((p, i) => {
      const s = allScores[i];
      const isBest = i === bestIdx;
      const score = s ? s.score_total : '‚Äî';
      const priceStr = p.price ? (p.price/10000).toLocaleString() + '‰∏áÂÜÜ' : '‚Äî';
      const tsubo = p.land_area ? (p.land_area / 3.305785).toFixed(1) : '';
      const tsuboPrice = p.price && p.land_area ? (p.price / (p.land_area / 3.305785) / 10000).toFixed(1) + '‰∏á/Âù™' : '';
      const subStr = [tsubo ? tsubo + 'Âù™' : '', tsuboPrice].filter(Boolean).join(' ¬∑ ');
      return '<div class="so-comp-summary-card' + (isBest ? ' best' : '') + '" onclick="openPropertyDetailModal(' + i + ')">' +
        '<div class="so-comp-label-chip" style="background:' + COLORS[i] + ';">' + labels[i] + '</div>' +
        '<div class="so-comp-summary-name">' + (p.address || AREAS.find(a=>a.id===p.area_id)?.name || 'Áâ©‰ª∂' + labels[i]) + '</div>' +
        '<div class="so-comp-summary-score" style="color:' + (s ? sc(s.score_total) : '#9ca3af') + ';">' + score + '</div>' +
        '<div class="so-comp-summary-score-label">Á∑èÂêà„Çπ„Ç≥„Ç¢</div>' +
        '<div class="so-comp-summary-price">' + priceStr + '</div>' +
        '<div class="so-comp-summary-sub">' + subStr + '</div>' +
      '</div>';
    }).join('')}
  </div>`;

  // ===== „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„Éò„É´„Éë„Éº =====
  function accSection(id, icon, title, count, isOpen, bodyHtml) {
    return '<div class="so-comp-acc-section' + (isOpen ? ' open' : '') + '" id="so-comp-acc-' + id + '">' +
      '<div class="so-comp-acc-header" onclick="toggleCompAccordion(\'so-comp-acc-' + id + '\')">' +
      '<h3>' + icon + ' ' + title + (count ? ' <span class="so-comp-count">Ôºà' + count + 'Ôºâ</span>' : '') + '</h3>' +
      '<span class="so-comp-chev">‚ñº</span></div>' +
      '<div class="so-comp-acc-body">' + bodyHtml + '</div></div>';
  }

  // ===== „Çª„ÇØ„Ç∑„Éß„É≥: „Çπ„Ç≥„Ç¢ÊØîËºÉ =====
  function renderScoreSection() {
    if (!hasScores) return '<div style="padding:14px;font-size:12px;color:#9ca3af;">„Çπ„Ç≥„Ç¢„Éá„Éº„Çø„Å™„ÅóÔºàAIÂàÜÊûêÂæå„Å´Ë°®Á§∫Ôºâ</div>';
    const scoreKeys = ['score_safety','score_convenience','score_cost'];
    if (hasLifestyle) scoreKeys.push('score_lifestyle');
    const labelMap = {score_safety:'üõ°Ô∏è ÂÆâÂÖ®', score_convenience:'üè™ Âà©‰æø', score_cost:'üí∞ „Ç≥„Çπ„Éà', score_lifestyle:'üè° „É©„Ç§„Éï'};
    let html = '<div style="overflow-x:auto;"><table class="so-comp-t-table">';
    // Á∑èÂêà
    html += '<tr><th>Á∑èÂêà</th>' + props.map((p,i) => {
      const s = allScores[i];
      if (!s) return '<td style="text-align:center;color:#d1d5db;">‚Äî</td>';
      const isBest = s.score_total === maxTotal && maxTotal > 0;
      return '<td class="' + (isBest ? 'so-comp-highlight-cell' : '') + '" style="text-align:center;">' +
        '<span style="font-size:20px;font-weight:900;color:' + sc(s.score_total) + ';">' + s.score_total + '</span>' +
        (isBest ? ' üëë' : '') + '</td>';
    }).join('') + '</tr>';
    // „Ç´„ÉÜ„Ç¥„É™
    scoreKeys.forEach(key => {
      const vals = allScores.map(s => s && s[key] != null ? s[key] : 0);
      const maxCat = Math.max(...vals);
      html += '<tr><th>' + labelMap[key] + '</th>' + props.map((p,i) => {
        const s = allScores[i];
        if (!s || s[key] == null) return '<td style="text-align:center;color:#d1d5db;">‚Äî</td>';
        const v = s[key];
        const best = v === maxCat && maxCat > 0;
        return '<td class="' + (best ? 'so-comp-highlight-cell' : '') + '">' +
          '<div class="so-comp-score-bar"><div class="so-comp-score-bar-track"><div class="so-comp-score-bar-fill" style="width:' + v + '%;background:' + sc(v) + ';"></div></div>' +
          '<span class="so-comp-score-val" style="color:' + sc(v) + ';">' + v + '</span>' +
          (best ? '<span style="font-size:9px;">‚òÖ</span>' : '') + '</div></td>';
      }).join('') + '</tr>';
    });
    html += '</table></div>';
    return html;
  }

  // ===== „Çª„ÇØ„Ç∑„Éß„É≥: Âü∫Êú¨ÊÉÖÂ†± =====
  function renderBasicSection() {
    const basicRows = [
      { label: '‰æ°Ê†º', key: 'price', fmt: v => v ? (v/10000).toLocaleString() + '‰∏áÂÜÜ' : '‚Äî', edit: 'price' },
      { label: 'ÂúüÂú∞Èù¢Á©ç', key: 'land_area', fmt: v => v ? (v/3.305785).toFixed(1) + 'Âù™Ôºà' + v + '„é°Ôºâ' : '‚Äî', edit: 'area' },
      { label: 'Âù™Âçò‰æ°', key: '_tsubo', fmt: (v,p) => p.price && p.land_area ? (p.price/(p.land_area/3.305785)/10000).toFixed(1) + '‰∏áÂÜÜ/Âù™' : '‚Äî' },
      { label: 'ÊâÄÂú®Âú∞', key: 'address', fmt: v => v || '‚Äî', edit: true },
      { label: 'ÈßÖË∑ùÈõ¢', key: 'station_distance', fmt: v => v || '‚Äî', edit: true },
    ];
    let html = '<div style="overflow-x:auto;"><table class="so-comp-t-table">';
    basicRows.forEach(r => {
      html += '<tr><th>' + r.label + '</th>' +
        props.map(p => editTd(p, r.key, r.fmt(p[r.key], p), r.edit)).join('') + '</tr>';
    });
    // Áâ©‰ª∂„Éö„Éº„Ç∏„É™„É≥„ÇØ
    html += '<tr><th>Áâ©‰ª∂„Éö„Éº„Ç∏</th>' + props.map(p =>
      '<td style="padding:8px 10px;border-bottom:1px solid #f3f4f6;">' +
      (p.url ? '<a href="' + p.url + '" target="_blank" rel="noopener" class="so-comp-prop-link">üîó Áâ©‰ª∂„Éö„Éº„Ç∏</a>' : '<span style="color:#d1d5db;">‚Äî</span>') +
      '</td>'
    ).join('') + '</tr>';
    html += '</table></div>';
    return html;
  }

  // ===== „Çª„ÇØ„Ç∑„Éß„É≥: ÈáçË¶ÅÁ¢∫Ë™çÈ†ÖÁõÆÔºà„Ç≥„É≥„Éë„ÇØ„Éà+Â±ïÈñãÔºâ =====
  function renderCheckSection() {
    const items = [
      { label: 'Áî®ÈÄîÂú∞Âüü', key: 'zoning' },
      { label: 'Âª∫„Å∫„ÅÑÁéá/ÂÆπÁ©çÁéá', key: '_cov_far', fmt: p => [p.building_coverage, p.floor_area_ratio].filter(Boolean).join(' / ') || '' },
      { label: 'Êé•ÈÅì', key: 'road_access' },
      { label: 'È´ò‰ΩéÂ∑Æ/ÈÄ†Êàê', key: 'elevation' },
      { label: '„Ç§„É≥„Éï„É©', key: 'infrastructure' },
      { label: '„Éè„Ç∂„Éº„Éâ', key: 'hazard' },
    ];
    const cols = props.length;
    const visible = items.slice(0, 3);
    const hidden = items.slice(3);
    let html = '<div class="so-comp-cpt-grid">';
    visible.forEach(r => {
      html += '<div class="so-comp-cpt-row" style="--cols:' + cols + '">' +
        '<div class="so-comp-cpt-row-label">' + r.label + '</div>' +
        props.map(p => {
          const val = r.fmt ? r.fmt(p) : p[r.key];
          return '<div class="so-comp-cpt-row-cell so-comp-editable-cell" onclick="startCellEdit(this,\'' + p.id + '\',\'' + (r.key.startsWith('_') ? 'building_coverage' : r.key) + '\',true)">' + (val || '<span style="color:#d97706;">üü° ‰∏çÊòé</span>') + '</div>';
        }).join('') + '</div>';
    });
    if (hidden.length > 0) {
      html += '<div class="so-comp-cpt-expand-btn" onclick="toggleCompExpandRows(\'so-comp-check-extra\');this.textContent=this.textContent.includes(\'‚ñº\')?\'‚ñ≤ Èñâ„Åò„Çã\':\'‚ñº ‰ªñ' + hidden.length + 'È†ÖÁõÆ„ÇíË¶ã„Çã\';">‚ñº ‰ªñ' + hidden.length + 'È†ÖÁõÆ„ÇíË¶ã„Çã</div>';
      hidden.forEach(r => {
        html += '<div class="so-comp-cpt-hidden so-comp-check-extra" style="--cols:' + cols + '">' +
          '<div class="so-comp-cpt-row-label">' + r.label + '</div>' +
          props.map(p => {
            const val = r.fmt ? r.fmt(p) : p[r.key];
            const display = val || '<span style="color:#d97706;">üü° ‰∏çÊòé</span>';
            const hazardStyle = r.key === 'hazard' && val ? 'color:#dc2626;font-weight:600;font-size:10px;' : '';
            return '<div class="so-comp-cpt-row-cell so-comp-editable-cell" style="' + hazardStyle + '" onclick="startCellEdit(this,\'' + p.id + '\',\'' + r.key + '\',true)">' + (r.key === 'hazard' && !val ? '<span style="color:#16a34a;">Ë®òËºâ„Å™„Åó</span>' : display) + '</div>';
          }).join('') + '</div>';
      });
    }
    html += '</div>';
    return html;
  }

  // ===== „Çª„ÇØ„Ç∑„Éß„É≥: Âª∫ÁØâË≤ª„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ =====
  function renderBuildSection() {
    const buildRows = [
      { label: 'ÊúÄÂ§ßÂª∫ÁØâÈù¢Á©ç', fmt: c => c ? c.maxBuildingArea.toFixed(1) + ' „é°' : '‚Äî' },
      { label: 'ÊúÄÂ§ßÂª∂Â∫äÈù¢Á©ç', fmt: c => c ? c.maxFloorArea.toFixed(1) + ' „é°Ôºà' + c.maxFloorAreaTsubo.toFixed(1) + 'Âù™Ôºâ' : '‚Äî' },
      { label: '„É≠„Éº„Ç≥„Çπ„Éà', fmt: c => c ? fmtYen(c.costLow) : '‚Äî' },
      { label: '„Çπ„Çø„É≥„ÉÄ„Éº„Éâ', fmt: c => c ? '<strong style="color:#1e40af;">' + fmtYen(c.costStd) + '</strong>' : '‚Äî' },
      { label: '„Éè„Ç§„Ç∞„É¨„Éº„Éâ', fmt: c => c ? fmtYen(c.costHigh) : '‚Äî' },
      { label: 'Ë´∏Ë≤ªÁî®(8%)', fmt: c => c ? fmtYen(c.misc) : '‚Äî' },
    ];
    let html = '<div style="overflow-x:auto;"><table class="so-comp-t-table">';
    buildRows.forEach(r => {
      html += '<tr><th>' + r.label + '</th>' + props.map((p,i) => {
        const c = costs[i];
        if (c) return '<td>' + r.fmt(c) + '</td>';
        return '<td class="so-comp-editable-cell" onclick="startCellEdit(this,\'' + p.id + '\',\'building_coverage\',true)" title="Âª∫ËîΩÁéá„ÉªÂÆπÁ©çÁéá„ÇíÂÖ•Âäõ„Åô„Çã„Å®ÁÆóÂá∫"><span style="color:#d1d5db;">‚Äî</span> <span style="color:#d1d5db;font-size:10px;">‚úèÔ∏è</span></td>';
      }).join('') + '</tr>';
    });
    html += '<tr style="border-top:2px solid #fed7aa;background:#fff7ed;"><th style="color:#c2410c;font-weight:700;">üí∞ Á∑èÈ°çÁõÆÂÆâ</th>' +
      props.map((p,i) => {
        const c = costs[i];
        return c ? '<td style="font-weight:900;color:#c2410c;font-size:13px;">' + fmtYen(c.totalEstimate) + '<br><span style="font-size:10px;font-weight:400;color:#9ca3af;">ÔºàÂúüÂú∞‰ª£+Âª∫ÁØâË≤ªstd+Ë´∏Ë≤ªÁî®Ôºâ</span></td>' : '<td style="color:#d1d5db;">‚Äî</td>';
      }).join('') + '</tr></table></div>';
    return html;
  }

  // ===== „Çª„ÇØ„Ç∑„Éß„É≥: Âë®Ëæ∫Áí∞Â¢ÉÔºà„Ç≥„É≥„Éë„ÇØ„Éà+Â±ïÈñãÔºâ =====
  function renderEnvSection() {
    const hasEnrich = props.some(p => p.enrichment_status === 'done');
    if (!hasEnrich && !props.some(p => p.lat && p.lng)) return '<div style="padding:14px;font-size:12px;color:#9ca3af;">AIÂàÜÊûêÂæå„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>';
    const envItems = [
      { label: 'Â∞èÂ≠¶Ê†°Âå∫', key: 'school_elementary' },
      { label: 'ÊúÄÂØÑ„Çπ„Éº„Éë„Éº', key: 'nearest_supermarket' },
      { label: 'ÊúÄÂØÑÁóÖÈô¢', key: 'nearest_hospital' },
      { label: '‰∏≠Â≠¶Ê†°Âå∫', key: 'school_junior_high' },
      { label: 'ÊúÄÂØÑÂÖ¨Âúí', key: 'nearest_park' },
      { label: 'ÊúÄÂØÑ‰øùËÇ≤Âúí', key: 'nearest_nursery' },
    ];
    const cols = props.length;
    const visible = envItems.slice(0, 3);
    const hidden = envItems.slice(3);

    function envCell(p, key) {
      if (p.enrichment_status === 'done') return p[key] || '<span style="color:#d1d5db;">‚Äî</span>';
      if (p.enrichment_status === 'pending') return '<span style="color:#f59e0b;">‚è≥ ÂèñÂæó‰∏≠...</span>';
      if (p.lat && p.lng) return '<button onclick="handleEnrichProperty(\'' + p.id + '\')" style="color:#2563eb;font-size:11px;cursor:pointer;background:none;border:none;text-decoration:underline;">üîç ÂèñÂæó„Åô„Çã</button>';
      return '<span style="color:#d1d5db;">‰ΩçÁΩÆÊÉÖÂ†±„Å™„Åó</span>';
    }

    let html = '<div class="so-comp-cpt-grid">';
    visible.forEach(r => {
      html += '<div class="so-comp-cpt-row" style="--cols:' + cols + '">' +
        '<div class="so-comp-cpt-row-label">' + r.label + '</div>' +
        props.map(p => '<div class="so-comp-cpt-row-cell">' + envCell(p, r.key) + '</div>').join('') + '</div>';
    });
    if (hidden.length > 0) {
      html += '<div class="so-comp-cpt-expand-btn" onclick="toggleCompExpandRows(\'so-comp-env-extra\');this.textContent=this.textContent.includes(\'‚ñº\')?\'‚ñ≤ Èñâ„Åò„Çã\':\'‚ñº ‰ªñ' + hidden.length + 'ÊñΩË®≠„ÇíË¶ã„Çã\';">‚ñº ‰ªñ' + hidden.length + 'ÊñΩË®≠„ÇíË¶ã„Çã</div>';
      hidden.forEach(r => {
        html += '<div class="so-comp-cpt-hidden so-comp-env-extra" style="--cols:' + cols + '">' +
          '<div class="so-comp-cpt-row-label">' + r.label + '</div>' +
          props.map(p => '<div class="so-comp-cpt-row-cell">' + envCell(p, r.key) + '</div>').join('') + '</div>';
      });
    }
    html += '</div>';
    return html;
  }

  // ===== „Çª„ÇØ„Ç∑„Éß„É≥: „Éè„Ç∂„Éº„Éâ„ÉªÂú∞Áõ§ =====
  function renderHazardSection() {
    const hasEnrich = props.some(p => p.enrichment_status === 'done');
    if (!hasEnrich && !props.some(p => p.lat && p.lng)) return '<div style="padding:14px;font-size:12px;color:#9ca3af;">AIÂàÜÊûêÂæå„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>';
    const hazardItems = [
      { label: 'Ê¥™Ê∞¥„É™„Çπ„ÇØ', key: 'hazard_flood' },
      { label: 'ÂúüÁ†ÇÁÅΩÂÆ≥', key: 'hazard_sediment' },
      { label: 'Ê¥•Ê≥¢„É™„Çπ„ÇØ', key: 'hazard_tsunami' },
      { label: 'Âú∞Áõ§', key: 'ground_type' },
    ];
    let html = '<div style="overflow-x:auto;"><table class="so-comp-t-table">';
    hazardItems.forEach(r => {
      html += '<tr><th>' + r.label + '</th>' + props.map((p,i) => {
        if (p.enrichment_status === 'done') {
          return '<td>' + compRiskBadgeHtml(p[r.key], 'so-hz-' + r.key + '-' + i) + '</td>';
        } else if (p.enrichment_status === 'pending') {
          return '<td style="color:#f59e0b;font-size:11px;">‚è≥ ÂèñÂæó‰∏≠...</td>';
        } else if (p.lat && p.lng) {
          return '<td><button onclick="handleEnrichProperty(\'' + p.id + '\')" style="color:#2563eb;font-size:11px;cursor:pointer;background:none;border:none;text-decoration:underline;">üîç ÂèñÂæó„Åô„Çã</button></td>';
        }
        return '<td style="color:#d1d5db;font-size:11px;">‰ΩçÁΩÆÊÉÖÂ†±„Å™„Åó</td>';
      }).join('') + '</tr>';
    });
    html += '</table></div>';
    return html;
  }

  // ===== „Çª„ÇØ„Ç∑„Éß„É≥: AI„Ç≥„É°„É≥„Éà =====
  function renderAICommentSection() {
    if (!props.some(p => p.ai_comment)) return '<div style="padding:14px;font-size:12px;color:#9ca3af;">AI„Ç≥„É°„É≥„Éà„Å™„Åó</div>';
    let html = '<div style="overflow-x:auto;"><table class="so-comp-t-table"><tr><th>AI„Ç≥„É°„É≥„Éà</th>';
    html += props.map(p => '<td style="font-size:11px;line-height:1.6;">' + (p.ai_comment || '<span style="color:#d1d5db;">‚Äî</span>') + '</td>').join('');
    html += '</tr></table></div>';
    return html;
  }

  // ===== „Çª„ÇØ„Ç∑„Éß„É≥: „É°„É¢ =====
  function renderMemoSection() {
    let html = '<div style="overflow-x:auto;"><table class="so-comp-t-table"><tr><th>„É°„É¢</th>';
    html += props.map(p => '<td style="padding:6px;"><textarea class="so-comp-memo-area" rows="2" placeholder="Ëá™Áî±„Å´„É°„É¢„ÇíÂÖ•Âäõ..." onblur="handleMemoEdit(\'' + p.id + '\', this.value)">' + (p.user_memo || p.memo || '') + '</textarea></td>').join('');
    html += '</tr></table></div>';
    return html;
  }

  // ===== „É°„Ç§„É≥HTMLÁµÑ„ÅøÁ´ã„Å¶ =====
  const accSections = [
    accSection('scores', 'üìä', '„Çπ„Ç≥„Ç¢ÊØîËºÉ', '', true, renderScoreSection()),
    accSection('basic', 'üìç', 'Âü∫Êú¨ÊÉÖÂ†±', '5È†ÖÁõÆ', false, renderBasicSection()),
    accSection('check', '‚ö†Ô∏è', 'ÈáçË¶ÅÁ¢∫Ë™çÈ†ÖÁõÆ', '6È†ÖÁõÆ', false, renderCheckSection()),
    accSection('build', 'üèóÔ∏è', 'Âª∫ÁØâË≤ª„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥', 'Á∑èÈ°çÊØîËºÉ', false, renderBuildSection()),
    accSection('env', 'üîç', 'Âë®Ëæ∫Áí∞Â¢É', '6ÊñΩË®≠', false, renderEnvSection()),
    accSection('hazard', 'üõ°Ô∏è', '„Éè„Ç∂„Éº„Éâ„ÉªÂú∞Áõ§', '4È†ÖÁõÆ', false, renderHazardSection()),
    accSection('aicomment', 'üí¨', 'AI„Ç≥„É°„É≥„Éà', '', false, renderAICommentSection()),
    accSection('memo', 'üìù', '„É°„É¢', '', false, renderMemoSection()),
  ].join('');

  return `
    <div class="space-y-3 fade-in">
      <div class="flex items-center gap-3 flex-wrap">
        <h2 class="text-lg font-bold text-gray-800">üìä</h2>
        <span id="comp-name-display" class="text-lg font-bold text-gray-800 cursor-pointer hover:text-blue-600 border-b border-dashed border-gray-300" onclick="startCompNameEdit()" title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂêçÂâç„ÇíÂ§âÊõ¥">${comp.name || 'ÊØîËºÉË°®'}</span>
        <span class="text-xs text-gray-400">Ôºà„Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ„ÅßË©≥Á¥∞Ë°®Á§∫Ôºâ</span>
        <button onclick="exportComparisonCSV()" class="ml-auto px-3 py-1 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 transition-colors">üì• CSVÂá∫Âäõ</button>
      </div>

      ${comp.summary ? `
        <div style="padding:14px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;">
          <div style="font-size:12px;font-weight:700;color:#1d4ed8;margin-bottom:4px;">üí° AI„Çµ„Éû„É™</div>
          <div style="font-size:13px;color:#374151;line-height:1.7;">${comp.summary}</div>
        </div>
      ` : ''}

      ${comp._unsaved ? `
        <div class="card p-4 bg-green-50 border-green-200" style="border:1px solid #86efac;">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <span class="text-sm font-bold text-green-800">„Åì„ÅÆÊØîËºÉË°®„Çí‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü</span>
              <p class="text-xs text-green-600 mt-0.5">„É¶„Éº„Ç∂„ÉºÁôªÈå≤„Åô„Çã„Å®„ÄÅÊ¨°Âõû‰ª•Èôç„ÇÇ„Åì„ÅÆÊØîËºÉË°®„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô</p>
            </div>
            <button onclick="openAuthModal(); state._pendingSaveCompId='${comp.id}';" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
              „É¶„Éº„Ç∂„ÉºÁôªÈå≤„Åó„Å¶‰øùÂ≠ò
            </button>
          </div>
        </div>
      ` : ''}

      ${summaryCards}
      ${accSections}

      ${questions.length > 0 ? `
        <div class="card" style="padding:14px;">
          <h3 style="font-size:13px;font-weight:700;margin-bottom:8px;">üìã Á¢∫Ë™çË≥™Âïè„ÉÜ„É≥„Éó„É¨„Éº„Éà</h3>
          <div class="space-y-2">
            ${questions.map((q,i) => `
              <label class="flex items-start gap-2 text-sm text-gray-700">
                <input type="checkbox" class="mt-1 so-question-check" />
                <span>${typeof q === 'object' ? q.text || q.question || JSON.stringify(q) : q}</span>
              </label>
            `).join('')}
          </div>
          <button onclick="copyQuestions()" class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition-colors">üìã Ë≥™Âïè„Çí„Ç≥„Éî„Éº</button>
        </div>
      ` : ''}
    </div>

    <!-- Áâ©‰ª∂Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
    <div class="so-comp-modal-overlay" id="so-comp-prop-modal" onclick="if(event.target===this) closePropertyDetailModal();">
      <div class="so-comp-modal-box" id="so-comp-prop-modal-body" onclick="event.stopPropagation()"></div>
    </div>
  `;
}

// ===== ÊØîËºÉË°®„Éè„Ç§„Éñ„É™„ÉÉ„ÉâUI „Éò„É´„Éë„ÉºÈñ¢Êï∞ =====
function toggleCompAccordion(id) {
  document.getElementById(id)?.classList.toggle('open');
}
function toggleCompHzDetail(id) {
  document.getElementById(id)?.classList.toggle('open');
}
function toggleCompExpandRows(cls) {
  document.querySelectorAll('.' + cls).forEach(e => e.classList.toggle('open'));
}
function openPropertyDetailModal(index) {
  const comp = state.soComparison;
  if (!comp) return;
  const props = comp.properties || [];
  if (index < 0 || index >= props.length) return;
  const p = props[index];
  const labels = ['A','B','C','D','E'];
  const COLORS = ['#2563eb','#16a34a','#9333ea','#f59e0b','#ef4444'];
  const s = calculateScores(p, state.userProfile);
  const allScores = props.map(pp => calculateScores(pp, state.userProfile));
  const maxTotal = Math.max(...allScores.map(ss => ss ? ss.score_total : 0));
  const isBest = s && s.score_total === maxTotal && maxTotal > 0;
  const cost = calcBuildingCost(p);
  const fmtYen = v => v >= 100000000 ? (v/100000000).toFixed(2) + 'ÂÑÑÂÜÜ' : (v/10000).toLocaleString() + '‰∏áÂÜÜ';
  function sc(v) { return v >= 80 ? '#16a34a' : v >= 60 ? '#2563eb' : v >= 40 ? '#f59e0b' : '#dc2626'; }
  function mRiskLevel(text) {
    if (!text) return 'unknown';
    const first = text.split(/[„ÄÇÔºà(]/)[0].trim();
    if (/^È´ò/.test(first)) return 'high'; if (/^‰∏≠/.test(first)) return 'mid'; if (/^‰Ωé/.test(first)) return 'low';
    if (first.includes('È´ò')) return 'high'; if (first.includes('‰∏≠')) return 'mid'; return 'low';
  }

  const areaName = AREAS.find(a=>a.id===p.area_id)?.name || (p.address ? AREAS.find(a=>p.address.includes(a.name))?.name : '') || '';
  const priceStr = p.price ? (p.price/10000).toLocaleString() + '‰∏áÂÜÜ' : '‚Äî';
  const tsubo = p.land_area ? (p.land_area / 3.305785).toFixed(1) : '';
  const tsuboPrice = p.price && p.land_area ? (p.price/(p.land_area/3.305785)/10000).toFixed(1) + '‰∏á/Âù™' : '';

  const body = document.getElementById('so-comp-prop-modal-body');
  let html = '';
  // „Éò„ÉÉ„ÉÄ„Éº
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">' +
    '<div style="display:flex;align-items:center;gap:10px;">' +
    '<div class="so-comp-label-chip" style="background:' + COLORS[index] + ';width:36px;height:36px;font-size:16px;">' + labels[index] + '</div>' +
    '<div><div style="font-size:16px;font-weight:700;">' + (p.address || 'Áâ©‰ª∂' + labels[index]) + '</div>' +
    '<div style="font-size:11px;color:#6b7280;">' + [areaName, p.station_distance].filter(Boolean).join(' | ') + '</div></div></div>' +
    '<button class="so-comp-modal-close" onclick="closePropertyDetailModal()">&times;</button></div>';

  // Áâ©‰ª∂„Éö„Éº„Ç∏„É™„É≥„ÇØ
  if (p.url) {
    html += '<div style="margin-bottom:12px;"><a href="' + p.url + '" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:4px;padding:5px 14px;background:#eff6ff;color:#2563eb;border-radius:6px;font-size:12px;font-weight:600;text-decoration:none;border:1px solid #bfdbfe;">üîó Áâ©‰ª∂„Éö„Éº„Ç∏„ÇíË¶ã„Çã</a></div>';
  }

  // „Çπ„Ç≥„Ç¢
  if (s) {
    html += '<div style="text-align:center;margin-bottom:12px;">' +
      '<div style="font-size:40px;font-weight:900;color:' + sc(s.score_total) + ';">' + s.score_total + '<span style="font-size:14px;font-weight:400;color:#9ca3af;">/100</span></div>' +
      (isBest ? '<div style="margin-top:2px;"><span style="display:inline-block;padding:2px 10px;background:#dcfce7;color:#15803d;border-radius:999px;font-size:11px;font-weight:600;">üëë Á∑èÂêà1‰Ωç</span></div>' : '') + '</div>';
    const scoreItems = [['üõ°Ô∏è ÂÆâÂÖ®', s.score_safety], ['üè™ Âà©‰æø', s.score_convenience], ['üí∞ „Ç≥„Çπ„Éà', s.score_cost]];
    if (s.score_lifestyle !== null) scoreItems.push(['üè° „É©„Ç§„Éï', s.score_lifestyle]);
    scoreItems.forEach(([l,v]) => {
      if (v == null) return;
      html += '<div class="so-comp-m-score-row"><span class="so-comp-m-score-label">' + l + '</span>' +
        '<div class="so-comp-m-score-bar"><div class="so-comp-m-score-fill" style="width:' + v + '%;background:' + sc(v) + ';"></div></div>' +
        '<span class="so-comp-m-score-val" style="color:' + sc(v) + ';">' + v + '</span></div>';
    });
  }

  // Âü∫Êú¨ÊÉÖÂ†±
  html += '<div class="so-comp-info-grid" style="margin-top:12px;">' +
    '<div class="so-comp-info-cell"><div class="so-comp-info-cell-label">‰æ°Ê†º</div><div class="so-comp-info-cell-value" style="color:#1e40af;">' + priceStr + '</div></div>' +
    '<div class="so-comp-info-cell"><div class="so-comp-info-cell-label">ÂúüÂú∞Èù¢Á©ç</div><div class="so-comp-info-cell-value">' + (tsubo ? tsubo + 'Âù™' + (p.land_area ? 'Ôºà' + p.land_area + '„é°Ôºâ' : '') : '‚Äî') + '</div></div>' +
    '<div class="so-comp-info-cell"><div class="so-comp-info-cell-label">Âù™Âçò‰æ°</div><div class="so-comp-info-cell-value">' + (tsuboPrice || '‚Äî') + '</div></div>' +
    '<div class="so-comp-info-cell"><div class="so-comp-info-cell-label">ÈßÖË∑ùÈõ¢</div><div class="so-comp-info-cell-value">' + (p.station_distance || '‚Äî') + '</div></div></div>';

  // ÈáçË¶ÅÁ¢∫Ë™çÈ†ÖÁõÆ
  html += '<div style="margin-top:14px;"><div style="font-size:12px;font-weight:700;color:#b45309;margin-bottom:6px;">‚ö†Ô∏è ÈáçË¶ÅÁ¢∫Ë™çÈ†ÖÁõÆ</div><div class="so-comp-info-grid">';
  [['Áî®ÈÄîÂú∞Âüü', p.zoning], ['Âª∫„Å∫„ÅÑÁéá/ÂÆπÁ©çÁéá', [p.building_coverage, p.floor_area_ratio].filter(Boolean).join(' / ')], ['Êé•ÈÅì', p.road_access], ['È´ò‰ΩéÂ∑Æ/ÈÄ†Êàê', p.elevation || '‰∏çÊòé'], ['„Ç§„É≥„Éï„É©', p.infrastructure], ['„Éè„Ç∂„Éº„Éâ(Áâ©‰ª∂ÊÉÖÂ†±)', p.hazard || 'Ë®òËºâ„Å™„Åó']].forEach(([l,v]) => {
    html += '<div class="so-comp-info-cell"><div class="so-comp-info-cell-label">' + l + '</div><div class="so-comp-info-cell-value" style="font-size:11px;">' + (v || '‚Äî') + '</div></div>';
  });
  html += '</div></div>';

  // „Éè„Ç∂„Éº„ÉâÂà§ÂÆöË©≥Á¥∞
  if (p.enrichment_status === 'done') {
    html += '<div class="so-comp-fold-header" onclick="toggleCompModalFold(\'so-comp-modal-hz-' + index + '\')"><h4>üõ°Ô∏è „Éè„Ç∂„Éº„ÉâÂà§ÂÆöË©≥Á¥∞</h4><span style="font-size:10px;color:#9ca3af;">‚ñº</span></div>' +
      '<div class="so-comp-fold-body" id="so-comp-modal-hz-' + index + '">';
    [['Ê¥™Ê∞¥„É™„Çπ„ÇØ', p.hazard_flood], ['ÂúüÁ†ÇÁÅΩÂÆ≥', p.hazard_sediment], ['Ê¥•Ê≥¢„É™„Çπ„ÇØ', p.hazard_tsunami], ['Âú∞Áõ§', p.ground_type]].forEach(([l,v]) => {
      const rl = mRiskLevel(v);
      const borderColor = rl === 'high' ? '#dc2626' : rl === 'mid' ? '#f59e0b' : '#16a34a';
      html += '<div style="margin-bottom:8px;"><div style="font-size:11px;font-weight:600;color:#475569;margin-bottom:2px;">' + l + '</div>' +
        '<div style="font-size:11px;color:#64748b;line-height:1.6;padding:6px 8px;background:#f8fafc;border-radius:6px;border-left:3px solid ' + borderColor + ';">' + (v || 'ÊÉÖÂ†±„Å™„Åó') + '</div></div>';
    });
    html += '</div>';
  }

  // Âª∫ÁØâË≤ª
  if (cost) {
    html += '<div class="so-comp-fold-header" onclick="toggleCompModalFold(\'so-comp-modal-build-' + index + '\')"><h4>üèóÔ∏è Âª∫ÁØâË≤ª„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥</h4><span style="font-size:10px;color:#9ca3af;">‚ñº</span></div>' +
      '<div class="so-comp-fold-body" id="so-comp-modal-build-' + index + '">' +
      '<div class="so-comp-info-grid" style="grid-template-columns:1fr 1fr 1fr;">' +
      '<div class="so-comp-info-cell" style="text-align:center;"><div class="so-comp-info-cell-label">„É≠„Éº„Ç≥„Çπ„Éà</div><div class="so-comp-info-cell-value">' + fmtYen(cost.costLow) + '</div></div>' +
      '<div class="so-comp-info-cell" style="text-align:center;"><div class="so-comp-info-cell-label">„Çπ„Çø„É≥„ÉÄ„Éº„Éâ</div><div class="so-comp-info-cell-value" style="color:#1e40af;">' + fmtYen(cost.costStd) + '</div></div>' +
      '<div class="so-comp-info-cell" style="text-align:center;"><div class="so-comp-info-cell-label">„Éè„Ç§„Ç∞„É¨„Éº„Éâ</div><div class="so-comp-info-cell-value">' + fmtYen(cost.costHigh) + '</div></div></div>' +
      '<div style="margin-top:8px;padding:10px;background:#fff7ed;border-radius:8px;text-align:center;">' +
      '<div style="font-size:10px;color:#9ca3af;">üí∞ Á∑èÈ°çÁõÆÂÆâ</div>' +
      '<div style="font-size:20px;font-weight:900;color:#c2410c;">' + fmtYen(cost.totalEstimate) + '</div></div></div>';
  }

  // Âë®Ëæ∫Áí∞Â¢É
  if (p.enrichment_status === 'done') {
    html += '<div class="so-comp-fold-header" onclick="toggleCompModalFold(\'so-comp-modal-env-' + index + '\')"><h4>üîç Âë®Ëæ∫Áí∞Â¢É</h4><span style="font-size:10px;color:#9ca3af;">‚ñº</span></div>' +
      '<div class="so-comp-fold-body" id="so-comp-modal-env-' + index + '">';
    [['Â∞èÂ≠¶Ê†°Âå∫', p.school_elementary], ['‰∏≠Â≠¶Ê†°Âå∫', p.school_junior_high], ['„Çπ„Éº„Éë„Éº', p.nearest_supermarket], ['ÁóÖÈô¢', p.nearest_hospital], ['ÂÖ¨Âúí', p.nearest_park], ['‰øùËÇ≤Âúí', p.nearest_nursery]].forEach(([l,v]) => {
      html += '<div class="so-comp-kv-row"><span class="so-comp-kv-label">' + l + '</span><span class="so-comp-kv-value">' + (v || '‚Äî') + '</span></div>';
    });
    html += '</div>';
  }

  // AI„Ç≥„É°„É≥„Éà
  if (p.ai_comment) {
    html += '<div style="margin-top:12px;padding:10px;background:#f0fdf4;border-radius:8px;">' +
      '<div style="font-size:11px;font-weight:700;color:#15803d;margin-bottom:3px;">üí¨ AI„Ç≥„É°„É≥„Éà</div>' +
      '<div style="font-size:12px;color:#374151;">' + p.ai_comment + '</div></div>';
  }

  // „É°„É¢
  html += '<div style="margin-top:12px;"><div style="font-size:11px;font-weight:700;color:#15803d;margin-bottom:4px;">üìù „É°„É¢</div>' +
    '<textarea class="so-comp-memo-area" rows="2" placeholder="„É°„É¢..." onblur="handleMemoEdit(\'' + p.id + '\',this.value)">' + (p.user_memo || p.memo || '') + '</textarea></div>';

  // Êàª„Çã„Éú„Çø„É≥
  html += '<div style="margin-top:16px;text-align:center;"><button onclick="closePropertyDetailModal()" style="display:inline-block;padding:8px 24px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;">‚Üê Áâ©‰ª∂ÊØîËºÉË°®„Å∏Êàª„Çã</button></div>';

  body.innerHTML = html;
  document.getElementById('so-comp-prop-modal').classList.add('open');
}
function closePropertyDetailModal() {
  document.getElementById('so-comp-prop-modal')?.classList.remove('open');
}
function toggleCompModalFold(id) {
  document.getElementById(id)?.classList.toggle('open');
}

function copyQuestions() {
  const checks = document.querySelectorAll('.so-question-check');
  const texts = [];
  checks.forEach((cb, i) => {
    const label = cb.parentElement?.querySelector('span')?.textContent;
    if (label) texts.push(`${cb.checked ? '‚úÖ' : '‚ñ°'} ${label}`);
  });
  if (texts.length === 0) return;
  navigator.clipboard.writeText(texts.join('\n')).then(() => alert('Ë≥™Âïè„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'));
}

// ÊØîËºÉË°®„ÅÆÂêçÂâçÁ∑®ÈõÜ
function startCompNameEdit() {
  const el = document.getElementById('comp-name-display');
  if (!el || !state.soComparison) return;
  const current = state.soComparison.name || 'ÊØîËºÉË°®';
  el.outerHTML = `<input id="comp-name-input" type="text" value="${current.replace(/"/g, '&quot;')}" class="text-lg font-bold text-gray-800 border border-blue-300 rounded px-2 py-0.5 focus:ring-2 focus:ring-blue-200 outline-none" style="max-width:250px;" />`;
  const input = document.getElementById('comp-name-input');
  if (input) {
    input.focus();
    input.select();
    input.onblur = () => finishCompNameEdit(input.value);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') render(); };
  }
}

async function finishCompNameEdit(newName) {
  const trimmed = (newName || '').trim() || 'ÊØîËºÉË°®';
  if (state.soComparison) {
    state.soComparison.name = trimmed;
    if (state.soComparison.id) await renameComparison(state.soComparison.id, trimmed);
  }
  render();
}

async function handleDeleteComparison(compId) {
  if (!confirm('„Åì„ÅÆÊØîËºÉË°®„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
  await deleteComparison(compId);
  render();
}

// „Çª„É´Á∑®ÈõÜ: „ÇØ„É™„ÉÉ„ÇØ ‚Üí inline input
function startCellEdit(td, propId, key, editType) {
  if (td.querySelector('input,textarea')) return; // Êó¢„Å´Á∑®ÈõÜ‰∏≠
  const prop = state.savedProperties.find(p => p.id === propId);
  if (!prop) return;

  const currentVal = prop[key];
  td.innerHTML = '';

  if (editType === 'price') {
    // ‰∏áÂÜÜ ‚Üí ÂÜÜ„Åß‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß‰∏áÂÜÜ„ÅßË°®Á§∫„ÉªÂÖ•Âäõ
    const input = document.createElement('input');
    input.type = 'number';
    input.className = 'w-full px-2 py-1 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none';
    input.value = currentVal ? currentVal / 10000 : '';
    input.placeholder = '‰∏áÂÜÜ';
    input.focus();
    input.onblur = () => finishCellEdit(propId, key, input.value ? Number(input.value) * 10000 : null);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { render(); } };
    td.appendChild(input);
    setTimeout(() => input.focus(), 0);
  } else if (editType === 'area') {
    // „é°„Åß‰øùÂ≠ò
    const input = document.createElement('input');
    input.type = 'number';
    input.step = '0.1';
    input.className = 'w-full px-2 py-1 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none';
    input.value = currentVal || '';
    input.placeholder = '„é°';
    input.onblur = () => finishCellEdit(propId, key, input.value ? Number(input.value) : null);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { render(); } };
    td.appendChild(input);
    setTimeout(() => input.focus(), 0);
  } else {
    // „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'w-full px-2 py-1 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none';
    input.value = currentVal || '';
    input.onblur = () => finishCellEdit(propId, key, input.value.trim() || null);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { render(); } };
    td.appendChild(input);
    setTimeout(() => input.focus(), 0);
  }
}

async function finishCellEdit(propId, key, newVal) {
  const prop = state.savedProperties.find(p => p.id === propId);
  if (!prop) return;
  if (prop[key] === newVal) { render(); return; }
  // comparisonÂÜÖ„ÅÆprops„ÇÇÂêåÊúü
  if (state.soComparison?.properties) {
    const cp = state.soComparison.properties.find(p => p.id === propId);
    if (cp) cp[key] = newVal;
  }
  await updateProperty(propId, { [key]: newVal });
  render();
}

async function handleMemoEdit(propId, value) {
  const trimmed = value.trim();
  const prop = state.savedProperties.find(p => p.id === propId);
  if (!prop) return;
  if ((prop.user_memo || '') === trimmed) return;
  if (state.soComparison?.properties) {
    const cp = state.soComparison.properties.find(p => p.id === propId);
    if (cp) cp.user_memo = trimmed;
  }
  await updateProperty(propId, { user_memo: trimmed });
}

// ============================================================
// Modals (Import)
// ============================================================
function renderAuthModal() {
  if (!state.authModalOpen) return '';

  const isOtpStep = state.authStep === 'otp';
  const isLinkSent = state.authStep === 'link_sent';
  const loading = state.authLoading;

  return `
    <div class="so-modal-overlay" onclick="if(event.target===this){state.authModalOpen=false;render();}">
      <div class="so-modal" style="max-width:400px;">
        ${isLinkSent ? `
          <h2 class="text-lg font-bold text-gray-900 mb-1">Á¢∫Ë™ç„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü</h2>
          <p class="text-sm text-gray-500 mb-4"><span class="font-medium text-gray-700">${state.authEmail}</span> „Å´Á¢∫Ë™ç„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ</p>
          <div class="p-4 bg-blue-50 rounded-lg mb-4">
            <p class="text-sm text-blue-800">„É°„Éº„É´ÂÜÖ„ÅÆ„É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÄÅ„Ç¢„Ç´„Ç¶„É≥„ÉàÁôªÈå≤„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            <p class="text-xs text-blue-600 mt-2">„ÇØ„É™„ÉÉ„ÇØÂæå„ÄÅ„Åì„ÅÆ„Éö„Éº„Ç∏„Å´Êàª„Çã„Å®„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„Å´„Å™„Çä„Åæ„Åô„ÄÇ</p>
          </div>
          <button onclick="state.authModalOpen=false;render();" class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
            Èñâ„Åò„Çã
          </button>
        ` : isOtpStep ? `
          <h2 class="text-lg font-bold text-gray-900 mb-1">Ë™çË®º„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ</h2>
          <p class="text-sm text-gray-500 mb-4"><span class="font-medium text-gray-700">${state.authEmail}</span> „Å´6Ê°Å„ÅÆ„Ç≥„Éº„Éâ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü</p>
          ${state.authError ? `<p class="text-sm text-red-600 mb-3">${state.authError}</p>` : ''}
          <input id="auth-otp-input" type="text" inputmode="numeric" maxlength="6" placeholder="000000"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-2xl font-bold tracking-widest focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
            ${loading ? 'disabled' : ''}>
          <button onclick="handleAuthVerify()" class="w-full mt-4 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors ${loading ? 'opacity-50 cursor-not-allowed' : ''}" ${loading ? 'disabled' : ''}>
            ${loading ? 'Á¢∫Ë™ç‰∏≠...' : '„É≠„Ç∞„Ç§„É≥'}
          </button>
          <button onclick="state.authStep='email';state.authError='';render();" class="w-full mt-2 px-4 py-2 text-sm text-gray-500 hover:text-gray-700 transition-colors">
            ‚Üê „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂ§âÊõ¥
          </button>
        ` : `
          <h2 class="text-lg font-bold text-gray-900 mb-1">„É≠„Ç∞„Ç§„É≥ / „Ç¢„Ç´„Ç¶„É≥„ÉàÁôªÈå≤</h2>
          <p class="text-sm text-gray-500 mb-4">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ</p>
          ${state.authError ? `<p class="text-sm text-red-600 mb-3">${state.authError}</p>` : ''}
          <input id="auth-email-input" type="email" placeholder="example@mail.com"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
            value="${state.authEmail}" ${loading ? 'disabled' : ''}>
          <button onclick="handleAuthSendOtp()" class="w-full mt-4 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors ${loading ? 'opacity-50 cursor-not-allowed' : ''}" ${loading ? 'disabled' : ''}>
            ${loading ? 'ÈÄÅ‰ø°‰∏≠...' : 'Ë™çË®º„Ç≥„Éº„Éâ„ÇíÈÄÅ‰ø°'}
          </button>
          <p class="text-xs text-gray-400 mt-3 text-center">6Ê°Å„ÅÆË™çË®º„Ç≥„Éº„Éâ„Åå„É°„Éº„É´„Å´Â±ä„Åç„Åæ„Åô</p>
        `}
      </div>
    </div>
  `;
}

function renderSOModal() {
  if (!state.soModalOpen) return '';

  if (state.soModalType === 'import') {
    return renderImportModal();
  }
  return '';
}

function renderImportModal() {
  const areaId = state.soSearchAreaId;
  const area = AREAS.find(a => a.id === areaId);
  const areaName = area ? area.name : '';
  const parsed = state._aiParsedProperty;
  const batch = state._batchResults;
  const batchProcessing = state._batchProcessing;
  const batchUrls = state._batchUrls;

  return `
    <div class="so-modal-overlay" onclick="closeSOModal(event)">
      <div class="so-modal" onclick="event.stopPropagation()" style="max-height:90vh; overflow-y:auto;">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">ü§ñ Áâ©‰ª∂ÊÉÖÂ†±„ÇíAI„ÅßÂèñ„ÇäËæº„Åø${areaName ? `Ôºà${areaName}Ôºâ` : ''}</h3>
          <button onclick="closeBatchModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>

        <div class="space-y-4">
          <!-- „Çø„ÉñÂàáÊõø: URL / „ÉÜ„Ç≠„Çπ„Éà -->
          <div class="flex border-b border-gray-200">
            <button id="tab-url" onclick="document.getElementById('panel-url').style.display='block'; document.getElementById('panel-text').style.display='none'; document.getElementById('tab-url').className='flex-1 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600'; document.getElementById('tab-text').className='flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent';" class="flex-1 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
              üîó Áâ©‰ª∂URL„Åã„ÇâÁôªÈå≤
            </button>
            <button id="tab-text" onclick="document.getElementById('panel-text').style.display='block'; document.getElementById('panel-url').style.display='none'; document.getElementById('tab-text').className='flex-1 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600'; document.getElementById('tab-url').className='flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent';" class="flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent">
              üìã „ÉÜ„Ç≠„Çπ„ÉàË≤º„Çä‰ªò„Åë
            </button>
          </div>

          <!-- URLÂÖ•Âäõ„Éë„Éç„É´ÔºàË§áÊï∞URLÂÖ•ÂäõÊ¨ÑÔºâ -->
          <div id="panel-url">
            ${batch.length === 0 && !batchProcessing ? `
              <label class="text-sm font-medium text-gray-700">Áâ©‰ª∂„Éö„Éº„Ç∏„ÅÆURL</label>
              <div class="space-y-2 mt-1" id="url-fields-container">
                ${batchUrls.map((url, i) => `
                  <div class="flex gap-2 items-center">
                    <span class="text-xs text-gray-400 w-5 text-right shrink-0">${i + 1}</span>
                    <input type="url" value="${(url || '').replace(/"/g, '&quot;')}" placeholder="https://suumo.jp/tochi/... „ÇÑ athome.co.jp/..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm batch-url-input" data-idx="${i}" oninput="updateBatchUrlValue(${i}, this.value)" />
                    ${batchUrls.length > 1 ? `<button onclick="removeBatchUrlField(${i})" class="text-gray-300 hover:text-red-400 text-lg leading-none shrink-0" title="ÂâäÈô§">√ó</button>` : '<div class="w-5"></div>'}
                  </div>
                `).join('')}
              </div>
              <button onclick="addBatchUrlField()" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                Ôºã URL„ÇíËøΩÂä†
              </button>
              <p class="text-xs text-gray-400 mt-1">SUUMO„Éª„Ç¢„ÉÉ„Éà„Éõ„Éº„É†„ÉªHOMESÁ≠â„ÅÆÂÄãÂà•Áâ©‰ª∂„Éö„Éº„Ç∏URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
              <button id="btn-fetch-url" onclick="handleBatchFetchUrls()" class="w-full mt-3 px-4 py-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                üîó URL„Åã„ÇâÁâ©‰ª∂ÊÉÖÂ†±„ÇíÂèñÂæó${batchUrls.filter(u => u && u.startsWith('http')).length > 1 ? `Ôºà${batchUrls.filter(u => u && u.startsWith('http')).length}‰ª∂Ôºâ` : ''}
              </button>
            ` : ''}

            ${batchProcessing || batch.length > 0 ? renderBatchProgress() : ''}
          </div>

          <!-- „ÉÜ„Ç≠„Çπ„ÉàË≤º„Çä‰ªò„Åë„Éë„Éç„É´ -->
          <div id="panel-text" style="display:none;">
            <div>
              <label class="text-sm font-medium text-gray-700">Áâ©‰ª∂URLÔºà‰ªªÊÑèÔºâ</label>
              <input id="import-url-text" type="url" placeholder="https://suumo.jp/... Ôºà‰ªªÊÑèÔºâ" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div class="mt-3">
              <label class="text-sm font-medium text-gray-700">Áâ©‰ª∂ÊÉÖÂ†±„ÇíË≤º„Çä‰ªò„Åë <span class="text-red-500">*</span></label>
              <textarea id="ai-import-text" rows="5" placeholder="Áâ©‰ª∂„Çµ„Ç§„Éà„ÅÆÊÉÖÂ†±„Çí„Ç≥„Éî„Éö„Åó„Å¶„Åè„Å†„Åï„ÅÑ&#10;&#10;‰æã:&#10;‰æ°Ê†º 2,580‰∏áÂÜÜ&#10;ÂúüÂú∞Èù¢Á©ç 182.5„é°Ôºà55.2Âù™Ôºâ&#10;ÊâÄÂú®Âú∞ ÂõõÊó•Â∏ÇÂ∏ÇÂØåÁî∞ÊµúÁî∫&#10;ÊúÄÂØÑ„ÇäÈßÖ ÂØåÁî∞ÊµúÈßÖ ÂæíÊ≠©5ÂàÜ&#10;Áî®ÈÄîÂú∞Âüü Á¨¨‰∏ÄÁ®Æ‰ΩèÂ±ÖÂú∞Âüü" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" style="resize:vertical;"></textarea>
            </div>
            <button id="btn-ai-parse" onclick="handleAIParse()" class="w-full mt-3 px-4 py-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
              ü§ñ AI„ÅßÊÉÖÂ†±„ÇíÊï¥ÁêÜ„Åó„Å¶‰øùÂ≠ò
            </button>
          </div>

          ${parsed && batch.length === 0 ? renderSingleParsedPreview(parsed) : ''}
        </div>
      </div>
    </div>
  `;
}

// Âçò‰ª∂„Éó„É¨„Éì„É•„ÉºË°®Á§∫Ôºà„ÉÜ„Ç≠„Çπ„ÉàË≤º„Çä‰ªò„ÅëÁî®Ôºâ
function renderSingleParsedPreview(parsed) {
  return `
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 space-y-2">
      <p class="text-sm font-bold text-green-800">‚úÖ AI„ÅåÊï¥ÁêÜ„Åó„ÅüÁâ©‰ª∂ÊÉÖÂ†±</p>
      ${renderParsedPropertyGrid(parsed)}
      ${renderGeoInfo(parsed)}
      ${renderDupWarning(parsed)}
      ${parsed.memo ? `<p class="text-xs text-amber-700 mt-2">üí° ${parsed.memo}</p>` : ''}
      ${parsed.source_url ? `<p class="text-xs mt-1"><a href="${parsed.source_url}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">üîó ${parsed.source_url}</a></p>` : ''}
      <div class="flex gap-2 mt-3">
        <button onclick="handleSaveParsed()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">üíæ „Åì„ÅÆÂÜÖÂÆπ„Åß‰øùÂ≠ò</button>
        <button onclick="state._aiParsedProperty=null; render();" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors">„ÇÑ„ÇäÁõ¥„Åô</button>
      </div>
    </div>
  `;
}

// Áâ©‰ª∂ÊÉÖÂ†±„Ç∞„É™„ÉÉ„ÉâÔºàÂÖ±ÈÄö„Éë„Éº„ÉÑÔºâ
function renderParsedPropertyGrid(parsed) {
  return `<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
    <span class="text-gray-500">‰æ°Ê†º:</span><span class="font-medium">${parsed.price ? parsed.price.toLocaleString() + '‰∏áÂÜÜ' : '‚Äî'}</span>
    <span class="text-gray-500">Èù¢Á©ç:</span><span class="font-medium">${parsed.land_area ? (parsed.land_area/3.305785).toFixed(1) + 'Âù™Ôºà' + parsed.land_area + '„é°Ôºâ' : '‚Äî'}</span>
    <span class="text-gray-500">‰ΩèÊâÄ:</span><span class="font-medium">${parsed.address || '‚Äî'}</span>
    <span class="text-gray-500">ÈßÖ:</span><span class="font-medium">${parsed.station_distance || '‚Äî'}</span>
    ${parsed.zoning ? `<span class="text-gray-500">Áî®ÈÄîÂú∞Âüü:</span><span class="font-medium">${parsed.zoning}</span>` : ''}
    ${parsed.building_coverage ? `<span class="text-gray-500">Âª∫„Å∫„ÅÑÁéá:</span><span class="font-medium">${parsed.building_coverage}</span>` : ''}
    ${parsed.road_access ? `<span class="text-gray-500">Êé•ÈÅì:</span><span class="font-medium">${parsed.road_access}</span>` : ''}
  </div>`;
}

// ‰ΩçÁΩÆÊÉÖÂ†±Ë°®Á§∫ÔºàÂÖ±ÈÄö„Éë„Éº„ÉÑÔºâ
function renderGeoInfo(parsed) {
  const geoConf = parsed.geo_confidence;
  if (!parsed.lat || !parsed.lng) return '';
  const confLabel = geoConf === 'high' ? 'üü¢ È´òÁ≤æÂ∫¶Ôºà„Éö„Éº„Ç∏ÂÜÖÂ∫ßÊ®ôÔºâ'
    : geoConf === 'medium' ? 'üü° ‰∏≠Á≤æÂ∫¶Ôºà‰ΩèÊâÄ„Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞Ôºâ'
    : 'üî¥ ‰ΩéÁ≤æÂ∫¶ÔºàAIÊé®ÂÆöÔºâ';
  const confClass = geoConf === 'high' ? 'text-green-700 bg-green-50'
    : geoConf === 'medium' ? 'text-amber-700 bg-amber-50'
    : 'text-red-700 bg-red-50';
  return '<div class="mt-2 p-2 rounded ' + confClass + ' border">' +
    '<div class="flex items-center gap-2 text-xs font-medium">' +
    '<span>üìç ‰ΩçÁΩÆÊÉÖÂ†±: ' + confLabel + '</span>' +
    '<a href="https://www.google.com/maps?q=' + parsed.lat + ',' + parsed.lng + '" target="_blank" rel="noopener" class="text-blue-600 hover:underline ml-auto">üó∫Ô∏è Âú∞Âõ≥„ÅßÁ¢∫Ë™ç</a>' +
    '</div>' +
    (geoConf !== 'high' ? '<p class="text-xs mt-1 opacity-75">‚Äª ‰øùÂ≠òÂæå„ÄÅÂú∞Âõ≥„É™„É≥„ÇØ„Åã„Çâ‰ΩçÁΩÆ„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ</p>' : '') +
    '</div>';
}

// ÈáçË§áË≠¶ÂëäÔºàÂÖ±ÈÄö„Éë„Éº„ÉÑÔºâ
function renderDupWarning(parsed) {
  if (!parsed.dedup_hash) return '';
  const dup = state.savedProperties.find(p => p.dedup_hash === parsed.dedup_hash);
  if (!dup) return '';
  return '<div class="mt-2 p-2 rounded bg-red-50 border border-red-200 text-xs text-red-700">' +
    '‚ö†Ô∏è <strong>ÈáçË§á„ÅÆÂèØËÉΩÊÄß:</strong> Âêå„Åò‰ΩèÊâÄ„ÉªÈù¢Á©ç„Éª‰æ°Ê†º„ÅÆÁâ©‰ª∂„ÅåÊó¢„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºà' + (dup.address || '‰ΩèÊâÄ‰∏çÊòé') + 'Ôºâ' +
    '</div>';
}

// ‰∏ÄÊã¨Âèñ„ÇäËæº„Åø„ÅÆÈÄ≤ÊçóË°®Á§∫
function renderBatchProgress() {
  const batch = state._batchResults;
  const processing = state._batchProcessing;
  const currentIdx = state._batchCurrentIndex;
  const total = batch.length;
  const doneCount = batch.filter(b => b.status === 'done' || b.status === 'error').length;
  const successCount = batch.filter(b => b.status === 'done').length;
  const errorCount = batch.filter(b => b.status === 'error').length;
  const savedCount = batch.filter(b => b.saved).length;

  // ÂÖ®ÂÆå‰∫Ü„Åó„Åü„Åã
  const allDone = !processing && doneCount === total;

  return `
    <div class="space-y-3">
      <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
      <div>
        <div class="flex items-center justify-between text-sm mb-1">
          <span class="font-medium text-gray-700">${processing ? `‚è≥ ÂèñÂæó‰∏≠... (${doneCount}/${total})` : allDone ? `‚úÖ ÂèñÂæóÂÆå‰∫Ü (${successCount}‰ª∂ÊàêÂäü${errorCount > 0 ? '„ÄÅ' + errorCount + '‰ª∂Â§±Êïó' : ''})` : ''}</span>
          ${allDone ? `<button onclick="resetBatch()" class="text-xs text-gray-400 hover:text-gray-600">‚úï Èñâ„Åò„Çã</button>` : ''}
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: ${total > 0 ? (doneCount / total * 100) : 0}%"></div>
        </div>
      </div>

      <!-- ÂêÑURLÁµêÊûú‰∏ÄË¶ß -->
      <div class="space-y-2 max-h-96 overflow-y-auto">
        ${batch.map((item, idx) => {
          const isProcessing = processing && idx === currentIdx;
          const isDone = item.status === 'done';
          const isError = item.status === 'error';
          const isSaved = item.saved;

          // URLÁü≠Á∏ÆË°®Á§∫
          let shortUrl = item.url;
          try { shortUrl = new URL(item.url).hostname + new URL(item.url).pathname.substring(0, 30) + '...'; } catch(e) {}

          return `
            <div class="border rounded-lg ${isDone ? (isSaved ? 'border-green-300 bg-green-50/50' : 'border-blue-200 bg-blue-50/30') : isError ? 'border-red-200 bg-red-50/30' : isProcessing ? 'border-amber-200 bg-amber-50/30' : 'border-gray-200'} p-3">
              <div class="flex items-center gap-2">
                <span class="text-sm">${isProcessing ? '‚è≥' : isDone ? (isSaved ? '‚úÖ' : 'üìã') : isError ? '‚ùå' : '‚è∏Ô∏è'}</span>
                <span class="text-xs text-gray-500 truncate flex-1" title="${item.url}">${shortUrl}</span>
                ${isProcessing ? '<span class="text-xs text-amber-600 animate-pulse">AIËß£Êûê‰∏≠...</span>' : ''}
              </div>

              ${isDone && item.parsed ? `
                <div class="mt-2 pl-6">
                  <div class="grid grid-cols-2 gap-x-3 gap-y-0.5 text-xs">
                    <span class="text-gray-400">‰æ°Ê†º:</span><span class="font-medium">${item.parsed.price ? item.parsed.price.toLocaleString() + '‰∏áÂÜÜ' : '‚Äî'}</span>
                    <span class="text-gray-400">Èù¢Á©ç:</span><span class="font-medium">${item.parsed.land_area ? (item.parsed.land_area/3.305785).toFixed(1) + 'Âù™' : '‚Äî'}</span>
                    <span class="text-gray-400">‰ΩèÊâÄ:</span><span class="font-medium col-span-1 truncate">${item.parsed.address || '‚Äî'}</span>
                  </div>
                  ${renderDupWarning(item.parsed)}
                  ${!isSaved ? `
                    <div class="flex gap-2 mt-2">
                      <button onclick="handleSaveBatchItem(${idx})" class="px-3 py-1 bg-green-600 text-white rounded text-xs font-medium hover:bg-green-700 transition-colors">üíæ ‰øùÂ≠ò</button>
                      <button onclick="skipBatchItem(${idx})" class="px-3 py-1 bg-gray-100 text-gray-500 rounded text-xs hover:bg-gray-200 transition-colors">„Çπ„Ç≠„ÉÉ„Éó</button>
                    </div>
                  ` : `<p class="text-xs text-green-600 mt-1">‚úÖ ‰øùÂ≠òÊ∏à„Åø</p>`}
                </div>
              ` : ''}

              ${isError ? `<p class="text-xs text-red-500 mt-1 pl-6">${item.error || 'ÂèñÂæóÂ§±Êïó'}</p>` : ''}
            </div>
          `;
        }).join('')}
      </div>

      ${allDone && successCount > 0 ? `
        <div class="flex gap-2">
          ${successCount - savedCount > 0 ? `
            <button onclick="handleSaveBatchAll()" class="flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
              üíæ Êú™‰øùÂ≠ò„Çí„Åæ„Å®„ÇÅ„Å¶‰øùÂ≠òÔºà${successCount - savedCount}‰ª∂Ôºâ
            </button>
          ` : `
            <button onclick="closeBatchModal()" class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
              ‚úÖ ÂÆå‰∫Ü ‚Äî „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            </button>
          `}
        </div>
      ` : ''}
    </div>
  `;
}

// ============================================================
// Event Handlers
// ============================================================
function openImportModal(areaId) {
  const urlInput = document.getElementById('url-import-property') || document.getElementById('url-import-detail');
  const initialUrl = urlInput ? urlInput.value.trim() : '';
  state._importUrl = initialUrl;
  state._aiParsedProperty = null;
  state._batchUrls = initialUrl ? [initialUrl] : [''];
  state._batchResults = [];
  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  state.soSearchAreaId = areaId || null;
  state.soModalOpen = true;
  state.soModalType = 'import';
  render();
}

function closeSOModal(event) {
  if (event.target === event.currentTarget) {
    closeBatchModal();
  }
}

// ============================================================
// ‰∏ÄÊã¨URLÂèñ„ÇäËæº„Åø: URLÂÖ•ÂäõÊ¨Ñ„ÅÆÁÆ°ÁêÜ
// ============================================================
function addBatchUrlField() {
  state._batchUrls.push('');
  render();
  // ËøΩÂä†Âæå„Å´ÊúÄÂæå„ÅÆÂÖ•ÂäõÊ¨Ñ„Å´„Éï„Ç©„Éº„Ç´„Çπ
  setTimeout(() => {
    const inputs = document.querySelectorAll('.batch-url-input');
    if (inputs.length > 0) inputs[inputs.length - 1].focus();
  }, 50);
}

function removeBatchUrlField(idx) {
  if (state._batchUrls.length <= 1) return;
  state._batchUrls.splice(idx, 1);
  render();
}

function updateBatchUrlValue(idx, value) {
  state._batchUrls[idx] = value;
  // „Éú„Çø„É≥„ÅÆ‰ª∂Êï∞Ë°®Á§∫„ÇíÊõ¥Êñ∞Ôºàrender„Åó„Å™„ÅÑÔºùÂÖ•Âäõ‰∏≠„ÅÆ„Éï„Ç©„Éº„Ç´„Çπ„Çí‰øùÊåÅÔºâ
  const btn = document.getElementById('btn-fetch-url');
  if (btn) {
    const count = state._batchUrls.filter(u => u && u.trim().startsWith('http')).length;
    btn.textContent = count > 1
      ? `üîó URL„Åã„ÇâÁâ©‰ª∂ÊÉÖÂ†±„ÇíÂèñÂæóÔºà${count}‰ª∂Ôºâ`
      : 'üîó URL„Åã„ÇâÁâ©‰ª∂ÊÉÖÂ†±„ÇíÂèñÂæó';
  }
}

async function fetchSingleUrl(url) {
  const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
  const session = await supabaseClient.auth.getSession();
  const token = session?.data?.session?.access_token;
  if (token) headers['Authorization'] = `Bearer ${token}`;
  else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
  const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-assist`, {
    method: 'POST', headers,
    body: JSON.stringify({ action: 'fetch_url', url, areaId: state.soSearchAreaId })
  });
  if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
  const result = await res.json();
  if (result.error) throw new Error(result.error);
  return result;
}

async function handleBatchFetchUrls() {
  // ÂÖ•ÂäõÊ¨Ñ„Åã„ÇâURL‰∏ÄË¶ß„ÇíÂèñÂæó
  const urls = state._batchUrls
    .map(u => (u || '').trim())
    .filter(u => u.startsWith('http'));

  if (urls.length === 0) { alert('Áâ©‰ª∂„Éö„Éº„Ç∏„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

  // ‰∏ÄÊã¨„Éï„É≠„Éº„Å´ÂÖ•„Çã
  state._batchResults = urls.map(url => ({ url, status: 'pending', parsed: null, error: null, saved: false }));
  state._batchProcessing = true;
  state._batchCurrentIndex = 0;
  state._aiParsedProperty = null;
  render();

  // È†ÜÊ¨°Âá¶ÁêÜÔºàEdge Function 25ÁßíÂà∂ÈôêÂØæÁ≠ñ + Jina API„É¨„Éº„ÉàÂà∂ÈôêÂØæÁ≠ñÔºâ
  for (let i = 0; i < urls.length; i++) {
    state._batchCurrentIndex = i;
    state._batchResults[i].status = 'processing';
    render();

    try {
      const result = await fetchSingleUrl(urls[i]);
      state._batchResults[i].status = 'done';
      state._batchResults[i].parsed = result;
    } catch(e) {
      console.error(`URL Fetch error [${i}]:`, e);
      state._batchResults[i].status = 'error';
      state._batchResults[i].error = e.message;
    }
    render();

    // Ê¨°„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„Åæ„ÅßÂ∞ë„ÅóÂæÖ„Å§Ôºà„É¨„Éº„Éà„É™„Éü„ÉÉ„ÉàÂØæÁ≠ñÔºâ
    if (i < urls.length - 1) {
      await new Promise(r => setTimeout(r, 1000));
    }
  }

  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  render();
}

// ÂÄãÂà•‰øùÂ≠ò
async function handleSaveBatchItem(idx) {
  const item = state._batchResults[idx];
  if (!item || !item.parsed || item.saved) return;
  const parsed = item.parsed;

  if (!parsed.price || !parsed.land_area) {
    alert('‰æ°Ê†º„Å®Èù¢Á©ç„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„Åì„ÅÆÁâ©‰ª∂„ÅØ„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    return;
  }

  const prop = buildPropertyFromParsed(parsed);
  const saved = await saveProperty(prop);
  if (saved) {
    state._batchResults[idx].saved = true;
    render();
  }
}

// ‰∏ÄÊã¨‰øùÂ≠òÔºàÊú™‰øùÂ≠ò„ÅÆÊàêÂäüÂàÜ„Åô„Åπ„Å¶Ôºâ
async function handleSaveBatchAll() {
  const unsaved = state._batchResults.filter(b => b.status === 'done' && !b.saved && b.parsed);
  let savedCount = 0;
  for (const item of unsaved) {
    if (!item.parsed.price || !item.parsed.land_area) continue;
    // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
    if (item.parsed.dedup_hash) {
      const dup = state.savedProperties.find(p => p.dedup_hash === item.parsed.dedup_hash);
      if (dup) continue; // ÈáçË§á„ÅØ„Çπ„Ç≠„ÉÉ„Éó
    }
    const prop = buildPropertyFromParsed(item.parsed);
    const saved = await saveProperty(prop);
    if (saved) {
      item.saved = true;
      savedCount++;
    }
  }
  render();
  if (savedCount > 0) {
    // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÈñâ„Åò„Å™„ÅÑÔºà„É¶„Éº„Ç∂„Éº„Å´ÁµêÊûú„ÇíË¶ã„Åõ„ÇãÔºâ
  }
}

// „Çπ„Ç≠„ÉÉ„Éó
function skipBatchItem(idx) {
  state._batchResults[idx].saved = true; // saved=true„Å´„Åó„Å¶UI„Åã„ÇâÊ∂à„Åô
  state._batchResults[idx].status = 'skipped';
  render();
}

// „Éê„ÉÉ„ÉÅ„É™„Çª„ÉÉ„ÉàÔºàURLÂÖ•Âäõ„Å´Êàª„ÅôÔºâ
function resetBatch() {
  state._batchUrls = [''];
  state._batchResults = [];
  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  render();
}

function closeBatchModal() {
  state.soModalOpen = false;
  state._aiParsedProperty = null;
  state._batchUrls = [''];
  state._batchResults = [];
  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  render();
}

// parsed ‚Üí property „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂ§âÊèõÔºàÂÖ±ÈÄöÔºâ
function buildPropertyFromParsed(parsed) {
  return {
    area_id: state.soSearchAreaId || null,
    url: parsed.source_url || state._importUrl || null,
    source: parsed.source || null,
    price: parsed.price * 10000, // ‰∏áÂÜÜ ‚Üí ÂÜÜ
    land_area: parsed.land_area,
    address: parsed.address || null,
    station_distance: parsed.station_distance || null,
    floor_plan: parsed.floor_plan || null,
    building_year: parsed.building_year || null,
    zoning: parsed.zoning || null,
    building_coverage: parsed.building_coverage || null,
    floor_area_ratio: parsed.floor_area_ratio || null,
    road_access: parsed.road_access || null,
    elevation: parsed.elevation || null,
    infrastructure: parsed.infrastructure || null,
    hazard: parsed.hazard || null,
    memo: parsed.memo || null,
    lat: parsed.lat || null,
    lng: parsed.lng || null,
    geo_confidence: parsed.geo_confidence || null,
    geo_source: parsed.geo_source || null,
    dedup_hash: parsed.dedup_hash || null,
  };
}

// Êóß‰∫íÊèõ: Âçò‰ª∂URLÂèñÂæóÔºà„ÉÜ„Ç≠„Çπ„ÉàË≤º„Çä‰ªò„Åë„Éë„Éç„É´„Åß„ÅØ‰Ωø„Çè„Å™„ÅÑÔºâ
async function handleFetchUrl() {
  // ‰∏ÄÊã¨„Éï„É≠„Éº„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
  handleBatchFetchUrls();
}

// „ÉÜ„Ç≠„Çπ„ÉàË≤º„Çä‰ªò„Åë ‚Üí AIËß£Êûê
async function handleAIParse() {
  const textEl = document.getElementById('ai-import-text');
  const urlEl = document.getElementById('import-url-text');
  const text = textEl ? textEl.value.trim() : '';
  const url = urlEl ? urlEl.value.trim() : '';
  if (!text) { alert('Áâ©‰ª∂ÊÉÖÂ†±„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

  const btn = document.getElementById('btn-ai-parse');
  if (btn) { btn.textContent = 'ü§ñ AI„ÅåËß£Êûê‰∏≠...'; btn.disabled = true; }

  try {
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    if (token) headers['Authorization'] = `Bearer ${token}`;
    else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-assist`, {
      method: 'POST', headers,
      body: JSON.stringify({ action: 'parse', text, url, areaId: state.soSearchAreaId })
    });
    if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
    const result = await res.json();
    if (result.error) throw new Error(result.error);
    state._aiParsedProperty = result;
    state._importUrl = url;
    render();
  } catch(e) {
    console.error('AI Parse error:', e);
    alert('AIËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message);
    if (btn) { btn.textContent = 'ü§ñ AI„ÅßÊÉÖÂ†±„ÇíÊï¥ÁêÜ„Åó„Å¶‰øùÂ≠ò'; btn.disabled = false; }
  }
}

// AIËß£ÊûêÁµêÊûú„Çí‰øùÂ≠ò
async function handleSaveParsed() {
  const parsed = state._aiParsedProperty;
  if (!parsed) return;
  if (!parsed.price || !parsed.land_area) {
    alert('‰æ°Ê†º„Å®Èù¢Á©ç„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„ÉÜ„Ç≠„Çπ„Éà„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    return;
  }

  // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÔºàdedup_hashÔºâ
  if (parsed.dedup_hash) {
    const existing = state.savedProperties.find(p => p.dedup_hash === parsed.dedup_hash);
    if (existing) {
      const existAddr = existing.address || '‰ΩèÊâÄ‰∏çÊòé';
      if (!confirm(`‚ö†Ô∏è „Åì„ÅÆÁâ©‰ª∂„ÅØÊó¢„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n\nÊó¢Â≠ò: ${existAddr}\n\n„Åù„Çå„Åß„ÇÇ‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü`)) {
        return;
      }
    }
  }

  const prop = buildPropertyFromParsed(parsed);
  const saved = await saveProperty(prop);
  if (saved) {
    state.soModalOpen = false;
    state._importUrl = '';
    state._aiParsedProperty = null;
    render();
  }
}

async function handleToggleComparison(id) {
  await toggleComparison(id);
  render();
}

async function handleDeleteProperty(id) {
  if (!confirm('„Åì„ÅÆÁâ©‰ª∂„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
  await deleteProperty(id);
  render();
}

async function handleGenerateComparison() {
  const btn = event?.target;
  if (btn) { btn.textContent = 'ÁîüÊàê‰∏≠...'; btn.disabled = true; }
  const result = await generateComparison();
  if (result) {
    state.soComparison = result;
    state.soView = 'compare';
    backupToLocalStorage();
  }
  render();
}

async function clearAllProperties() {
  if (!confirm('‰øùÂ≠ò„Åó„ÅüÁâ©‰ª∂„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
  for (const p of [...state.savedProperties]) {
    await deleteProperty(p.id);
  }
  render();
}

// ============================================================
// SEO Content
// ============================================================
function renderSEOContent() {
  return `
    <div class="card p-6 mt-6">
      <h2 class="text-lg font-bold text-gray-800 mb-3">Ê≥®Êñá‰ΩèÂÆÖ„ÅÆÂúüÂú∞Êé¢„Åó„ÅÆ„Éù„Ç§„É≥„Éà</h2>
      <div class="space-y-3 text-sm text-gray-600 leading-relaxed">
        <p>Ê≥®Êñá‰ΩèÂÆÖ„ÇíÂª∫„Å¶„Çã„Åü„ÇÅ„ÅÆÂúüÂú∞Êé¢„Åó„Åß„ÅØ„ÄÅ‰æ°Ê†º„Å†„Åë„Åß„Å™„Åè„ÄÅÁî®ÈÄîÂú∞Âüü„ÉªÂª∫„Å∫„ÅÑÁéá„ÉªÂÆπÁ©çÁéá„ÉªÊé•ÈÅìÁä∂Ê≥Å„ÉªÂú∞Áõ§„ÅÆÁä∂ÊÖã„Å™„Å©„ÄÅÂ§ö„Åè„ÅÆÈ†ÖÁõÆ„ÇíÁ¢∫Ë™ç„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Åì„Çå„Çâ„ÅÆÊÉÖÂ†±„ÅØ‰∏çÂãïÁî£„Çµ„Ç§„Éà„Åî„Å®„Å´Ë®òËºâÊñπÊ≥ï„ÅåÁï∞„Å™„Çä„ÄÅË§áÊï∞„ÅÆÂúüÂú∞„ÇíÊØîËºÉ„Åô„ÇãÈöõ„Å´Â§ß„Åç„Å™ÊâãÈñì„Åå„Åã„Åã„Çä„Åæ„Åô„ÄÇ</p>
        <p>ÂΩì„ÉÑ„Éº„É´„ÅØ„ÄÅSUUMO„Éª„Ç¢„ÉÉ„Éà„Éõ„Éº„É†„ÉªLIFULL HOME'SÁ≠â„ÅÆ‰∏çÂãïÁî£„Çµ„Ç§„Éà„ÅÆÁâ©‰ª∂ÊÉÖÂ†±„ÇíAI„ÅåËá™Âãï„ÅßË™≠„ÅøÂèñ„Çä„ÄÅÁµ±‰∏Ä„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅÆÊØîËºÉË°®„Å®„Åó„Å¶Êï¥ÁêÜ„Åó„Åæ„Åô„ÄÇ„Åï„Çâ„Å´„ÄÅAI„ÅåÂêÑÁâ©‰ª∂„ÅÆÊ≥®ÊÑèÁÇπ„ÇÑ„Åä„Åô„Åô„ÇÅ„Éù„Ç§„É≥„Éà„ÇíÂàÜÊûê„Åó„Å¶„Ç≥„É°„É≥„Éà„ÇíÁîüÊàê„ÄÇË¶ãËêΩ„Å®„Åó„Åå„Å°„Å™Á¢∫Ë™ç‰∫ãÈ†Ö„ÇÇ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®„Åó„Å¶ÊèêÁ§∫„Åô„Çã„ÅÆ„Åß„ÄÅ‰∏çÂãïÁî£‰ºöÁ§æ„Å∏„ÅÆË≥™ÂïèÊ∫ñÂÇô„Å´„ÇÇÊ¥ªÁî®„Åß„Åç„Åæ„Åô„ÄÇ</p>
      </div>
      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <a href="/area/mie/" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors">
          üìä ‰∏âÈáçÁúå„Ç®„É™„Ç¢Âà•„ÅÆÂúüÂú∞Áõ∏Â†¥„ÇíË¶ã„Çã ‚Üí
        </a>
      </div>
      <div class="mt-4 pt-4 border-t border-gray-100">
        <h3 class="text-sm font-bold text-gray-700 mb-2">„Ç®„É™„Ç¢Âà• Ê≥®Êñá‰ΩèÂÆÖ„Ç¨„Ç§„Éâ</h3>
        <div class="flex flex-wrap gap-2">
          <a href="/area/mie/yokkaichi/" class="text-xs text-blue-600 hover:underline">ÂõõÊó•Â∏ÇÂ∏Ç</a>
          <a href="/area/mie/kuwana/" class="text-xs text-blue-600 hover:underline">Ê°ëÂêçÂ∏Ç</a>
          <a href="/area/mie/suzuka/" class="text-xs text-blue-600 hover:underline">Èà¥ÈπøÂ∏Ç</a>
          <a href="/area/mie/inabe/" class="text-xs text-blue-600 hover:underline">„ÅÑ„Å™„ÅπÂ∏Ç</a>
          <a href="/area/mie/kameyama/" class="text-xs text-blue-600 hover:underline">‰∫ÄÂ±±Â∏Ç</a>
          <a href="/area/mie/komono/" class="text-xs text-blue-600 hover:underline">Ëè∞ÈáéÁî∫</a>
          <a href="/area/mie/toin/" class="text-xs text-blue-600 hover:underline">Êù±Âì°Áî∫</a>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Footer
// ============================================================
function renderFooter() {
  return `
    <footer class="mt-8 py-6 border-t border-gray-200">
      <div class="text-center space-y-2">
        <div class="flex justify-center gap-4 mb-3">
          <a href="/area/mie/" class="text-sm text-blue-600 hover:underline">üìä ‰∏âÈáçÁúå„Ç®„É™„Ç¢ÊØîËºÉ</a>
        </div>
        <div class="flex justify-center flex-wrap gap-2 mb-3">
          <a href="/area/mie/yokkaichi/" class="text-xs text-blue-600 hover:underline">ÂõõÊó•Â∏ÇÂ∏Ç</a> |
          <a href="/area/mie/kuwana/" class="text-xs text-blue-600 hover:underline">Ê°ëÂêçÂ∏Ç</a> |
          <a href="/area/mie/suzuka/" class="text-xs text-blue-600 hover:underline">Èà¥ÈπøÂ∏Ç</a> |
          <a href="/area/mie/inabe/" class="text-xs text-blue-600 hover:underline">„ÅÑ„Å™„ÅπÂ∏Ç</a> |
          <a href="/area/mie/kameyama/" class="text-xs text-blue-600 hover:underline">‰∫ÄÂ±±Â∏Ç</a> |
          <a href="/area/mie/komono/" class="text-xs text-blue-600 hover:underline">Ëè∞ÈáéÁî∫</a> |
          <a href="/area/mie/toin/" class="text-xs text-blue-600 hover:underline">Êù±Âì°Áî∫</a>
        </div>
        <p class="text-xs text-gray-400">\u203B Êú¨„ÉÑ„Éº„É´„ÅØÂèÇËÄÉÊÉÖÂ†±„Åß„ÅÇ„Çä„ÄÅ‰∏çÂãïÁî£Ë≥ºÂÖ•„ÅÆÊúÄÁµÇÂà§Êñ≠„ÅØÂ∞ÇÈñÄÂÆ∂„Å´„ÅîÁõ∏Ë´á„Åè„Å†„Åï„ÅÑ</p>
        <p class="text-xs text-gray-300 mt-3">\u00A9 Ê≥®ÊñáÁõ∏Ë´á.com</p>
      </div>
    </footer>
  `;
}

// ============================================================
// Bind Events
// ============================================================
function handleAuthSendOtp() {
  const input = document.getElementById('auth-email-input');
  const email = input ? input.value.trim() : '';
  if (!email || !email.includes('@')) { state.authError = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; render(); return; }
  handleSendOtp(email);
}

function handleAuthVerify() {
  const input = document.getElementById('auth-otp-input');
  const token = input ? input.value.trim() : '';
  if (!token || token.length !== 6) { state.authError = '6Ê°Å„ÅÆ„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; render(); return; }
  handleVerifyOtp(state.authEmail, token);
}

function bindEvents() {
  // Ë™çË®º„É¢„Éº„ÉÄ„É´„ÅÆEnter„Ç≠„ÉºÂØæÂøú
  const emailInput = document.getElementById('auth-email-input');
  if (emailInput) emailInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleAuthSendOtp(); });
  const otpInput = document.getElementById('auth-otp-input');
  if (otpInput) {
    otpInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleAuthVerify(); });
    otpInput.focus();
  }
  if (emailInput && state.authModalOpen && state.authStep === 'email') emailInput.focus();
}

// ============================================================
// Initialize
// ============================================================
restoreFromLocalStorage();
render();

// Ë™çË®ºÁä∂ÊÖã„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
supabaseClient.auth.onAuthStateChange((event, session) => {
  if (session?.user) {
    updateAuthState(session.user);
  } else {
    state.authUser = null;
  }
  render();
});

ensureAuth().then(user => {
  if (user) updateAuthState(user);
  render();
  loadSavedProperties().then(() => {
    backupToLocalStorage();
    if (state.savedProperties.length > 0) render();
  });
  loadSavedComparisons().then(() => render());
  loadUserProfile().then(() => render());
}).catch(e => console.warn('Auth init skipped:', e.message));
</script>
</body>
</html>
