<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‰∏âÈáçÁúåÂåóÈÉ® ‰∏çÂãïÁî£„Åä„Åô„Åô„ÇÅ„Ç®„É™„Ç¢Ë®∫Êñ≠ | Â§¢„ÅÆ„Åô„Åø„Åã</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* === Tailwind CSS v3.4.19 (production build) === */
  *,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sticky{position:sticky}.top-0{top:0}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-1{margin-left:.25rem}.mt-0\.5{margin-top:.125rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.h-6{height:1.5rem}.w-12{width:3rem}.w-16{width:4rem}.w-28{width:7rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-8{width:2rem}.w-full{width:100%}.min-w-0{min-width:0}.max-w-6xl{max-width:72rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity,1))}.border-blue-100{--tw-border-opacity:1;border-color:rgb(219 234 254/var(--tw-border-opacity,1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-50{--tw-border-opacity:1;border-color:rgb(249 250 251/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.bg-amber-500{--tw-bg-opacity:1;background-color:rgb(245 158 11/var(--tw-bg-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgb(156 163 175/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94/var(--tw-bg-opacity,1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity,1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255/var(--tw-bg-opacity,1))}.bg-slate-400{--tw-bg-opacity:1;background-color:rgb(148 163 184/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.p-2{padding:.5rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.leading-relaxed{line-height:1.625}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-amber-800{--tw-text-opacity:1;color:rgb(146 64 14/var(--tw-text-opacity,1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.shadow-md,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.outline{outline-style:solid}.blur{--tw-blur:blur(8px)}.blur,.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-filter{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity,1))}@media (min-width:640px){.sm\:block{display:block}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}@media (min-width:768px){.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  * { font-family: 'Noto Sans JP', sans-serif; }
  body { background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 50%, #f5f0ff 100%); min-height: 100vh; }
  .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); }
  .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; transition: all 0.2s; }
  .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .medal-gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
  .medal-silver { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
  .medal-bronze { background: linear-gradient(135deg, #CD7F32, #B8860B); }
  input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 3px; outline: none; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #3b82f6; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  .tab-active { background: #3b82f6; color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }
  .score-bar { height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; }
  .score-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .pulse-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 500; }
  /* Map styles */
  .map-layout { display: flex; gap: 0; height: 600px; }
  #map-container { flex: 1; border-radius: 12px 0 0 12px; overflow: hidden; z-index: 1; }
  #map-sidebar { width: 340px; background: white; border-left: 1px solid #e5e7eb; border-radius: 0 12px 12px 0; overflow-y: auto; padding: 0; }
  .leaflet-container { font-family: 'Noto Sans JP', sans-serif; }
  .map-marker-icon { transition: transform 0.2s; }
  .map-marker-icon:hover { transform: scale(1.15); }
  .sidebar-header { padding: 16px; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; z-index: 2; }
  .sidebar-body { padding: 16px; }
  .tx-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .tx-table th { background: #f9fafb; padding: 6px 8px; text-align: left; font-weight: 500; color: #6b7280; position: sticky; top: 0; }
  .tx-table td { padding: 6px 8px; border-top: 1px solid #f3f4f6; }
  .tx-table tr[data-tx-idx] { cursor: pointer; transition: background 0.15s; }
  .tx-table tr[data-tx-idx]:hover { background: #dbeafe; }
  .tx-table tr.tx-active { background: #bfdbfe; }
  /* School district toggle */
  .school-toggle { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; user-select: none; transition: all 0.2s; border: 1px solid #d1d5db; background: white; }
  .school-toggle.active { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
  .school-toggle:hover { background: #f3f4f6; }
  .school-toggle.active:hover { background: #bfdbfe; }
  /* School icon markers */
  .school-icon-marker { background: none !important; border: none !important; }
  /* Map loading overlay */
  .map-loading-overlay {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 800;
    background: rgba(0,0,0,0.25); display: flex; flex-direction: column;
    align-items: center; justify-content: center; pointer-events: none;
    transition: opacity 0.3s;
  }
  .map-loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .map-loading-box {
    background: white; border-radius: 12px; padding: 16px 28px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18); text-align: center;
    animation: mapLoadBounce 2s ease-in-out infinite;
  }
  @keyframes mapLoadBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
  .map-loading-spinner {
    width: 32px; height: 32px; border: 3px solid #e5e7eb;
    border-top-color: #3b82f6; border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 0 auto 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .map-loading-progress {
    width: 120px; height: 4px; background: #e5e7eb; border-radius: 2px;
    margin: 8px auto 0; overflow: hidden;
  }
  .map-loading-progress-bar {
    height: 100%; background: #3b82f6; border-radius: 2px;
    transition: width 0.3s ease;
  }
  /* Fullscreen map */
  .map-fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; border-radius: 0 !important; margin: 0;
  }
  .map-fullscreen #map-container { border-radius: 0; height: 100vh; }
  .map-fullscreen #map-sidebar { border-radius: 0; height: 100vh; }
  .map-fullscreen-controls {
    position: fixed; top: 12px; left: 12px; z-index: 10001;
    background: rgba(255,255,255,0.92); backdrop-filter: blur(8px);
    padding: 8px 12px; border-radius: 10px; display: none;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    gap: 8px; align-items: center;
  }
  .map-fullscreen-controls.visible { display: flex; }
  .map-fullscreen-btn {
    display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px;
    border-radius: 6px; font-size: 12px; cursor: pointer; user-select: none;
    transition: all 0.2s; border: 1px solid #d1d5db; background: white; color: #374151;
  }
  .map-fullscreen-btn:hover { background: #f3f4f6; }
  .map-fullscreen-btn.active { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
  @media (max-width: 768px) {
    .map-layout { flex-direction: column; height: auto; }
    #map-container { height: 400px; border-radius: 12px 12px 0 0; }
    #map-sidebar { width: 100%; border-left: none; border-top: 1px solid #e5e7eb; border-radius: 0 0 12px 12px; max-height: 350px; }
    .map-fullscreen #map-sidebar { height: auto; max-height: 40vh; }
  }
</style>
</head>
<body>
<div id="app"></div>

<script>
// ============================================================
// Ë®≠ÂÆö ‚Äî „Éá„Éó„É≠„Ç§ÊôÇ„Å´„Åì„Åì„ÇíÁ∑®ÈõÜ
// ============================================================
const CONFIG = {
  // „Éó„É≠„Ç≠„Ç∑URLÔºàSupabase Edge FunctionÔºâ
  PROXY_URL: 'https://jvfmvitknqnmuduyscnl.supabase.co/functions/v1/mcp-proxy',

  // MCP„Çµ„Éº„Éê„ÉºURLÔºà„Éó„É≠„Ç≠„Ç∑ÁµåÁî±„ÅßÊé•Á∂öÔºâ
  MCP_REINFO: 'https://mcp.n-3.ai/mcp?tools=get-time,reinfolib-real-estate-price,reinfolib-city-list',
  MCP_ESTAT: 'https://mcp.n-3.ai/mcp?tools=e-stat-get-stats-list,e-stat-get-meta-info,e-stat-get-data-catalog',
};

// ============================================================
// MCP Streamable HTTP Client (with proxy support)
// ============================================================
class MCPClient {
  constructor(mcpUrl, proxyUrl) {
    this.mcpUrl = mcpUrl;
    this.proxyUrl = proxyUrl;
    this.sessionId = null;
    this.requestId = 0;
    this.connected = false;
    this.tools = [];
    this.useProxy = !!proxyUrl;
  }

  _buildFetchUrl() {
    if (this.useProxy) {
      return `${this.proxyUrl}?url=${encodeURIComponent(this.mcpUrl)}`;
    }
    return this.mcpUrl;
  }

  async initialize() {
    // Try proxy first, then direct
    const attempts = this.useProxy
      ? [true, false]  // proxy ‚Üí direct
      : [false];       // direct only

    let lastError;
    for (const viaProxy of attempts) {
      try {
        this.useProxy = viaProxy;
        const url = this._buildFetchUrl();

        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/event-stream',
          },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: ++this.requestId,
            method: 'initialize',
            params: {
              protocolVersion: '2025-03-26',
              capabilities: {},
              clientInfo: { name: 'yume-no-sumika-realestate', version: '1.0.0' }
            }
          })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const sid = res.headers.get('Mcp-Session-Id');
        if (sid) this.sessionId = sid;

        const data = await this._parseResponse(res);

        // Send initialized notification
        const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
        if (this.sessionId) headers['Mcp-Session-Id'] = this.sessionId;

        await fetch(this._buildFetchUrl(), {
          method: 'POST',
          headers,
          body: JSON.stringify({ jsonrpc: '2.0', method: 'notifications/initialized' })
        });

        this.connected = true;
        console.log(`MCP connected via ${viaProxy ? 'proxy' : 'direct'}`);
        return data;
      } catch (e) {
        lastError = e;
        console.warn(`MCP ${viaProxy ? 'proxy' : 'direct'} failed:`, e.message);
      }
    }
    this.connected = false;
    throw lastError;
  }

  async listTools() {
    const data = await this._request('tools/list', {});
    if (data && data.tools) this.tools = data.tools;
    return this.tools;
  }

  async callTool(name, args = {}) {
    return this._request('tools/call', { name, arguments: args });
  }

  async _request(method, params) {
    const url = this._buildFetchUrl();
    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json, text/event-stream' };
    if (this.sessionId) headers['Mcp-Session-Id'] = this.sessionId;

    const res = await fetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify({ jsonrpc: '2.0', id: ++this.requestId, method, params })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return this._parseResponse(res);
  }

  async _parseResponse(res) {
    const ct = res.headers.get('Content-Type') || '';
    if (ct.includes('text/event-stream')) {
      const text = await res.text();
      const lines = text.split('\n');
      let lastData = null;
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try { lastData = JSON.parse(line.slice(6)); } catch {}
        }
      }
      return lastData?.result || lastData;
    }
    const json = await res.json();
    return json.result || json;
  }
}

// ============================================================
// Pre-loaded Area Data (fallback + base data)
// ============================================================
const AREAS = [
  {
    id: "yokkaichi", name: "ÂõõÊó•Â∏ÇÂ∏Ç", cityCode: "24202", lat: 34.9650, lng: 136.6244,
    landPriceAvg: 57020, residentialPrice: 48385, commercialPrice: 89007, pricePerTsubo: 188498,
    yoyChange: 1.33, population: 311000, popGrowthRate: -0.3, accessToNagoya: 35,
    hospitals: 42, schools: 58, parks: 35, shopping: 120, safetyScore: 78, childcareScore: 82, naturalScore: 55,
    description: "‰∏âÈáçÁúåÊúÄÂ§ß„ÅÆÈÉΩÂ∏Ç„ÄÇÁü≥Ê≤πÂåñÂ≠¶„Ç≥„É≥„Éì„Éä„Éº„Éà„Å®Ê∏ØÊπæ„ÇíÊìÅ„Åô„ÇãÁî£Ê•≠ÈÉΩÂ∏Ç„ÄÇËøëÈâÑ„ÉªJR‰∏°Á∑ö„ÅßÂêçÂè§Â±ã„Å∏Áõ¥ÈÄö„ÄÇÂ§ßÂûãÂïÜÊ•≠ÊñΩË®≠„ÅåÂÖÖÂÆü„Åó„ÄÅÂåªÁôÇ„ÉªÊïôËÇ≤„Ç§„É≥„Éï„É©„ÇÇÁúåÂÜÖ„Éà„ÉÉ„Éó„ÇØ„É©„Çπ„ÄÇ",
    highlights: ["ÁúåÂÜÖÊúÄÂ§ß„ÅÆÂïÜÊ•≠ÈõÜÁ©ç", "ÂêçÂè§Â±ã„Å∏35ÂàÜ", "ÂåªÁôÇÊñΩË®≠ÂÖÖÂÆü", "Êù±ÂêçÈò™„ÉªÊñ∞ÂêçÁ•ûIC"],
    risks: ["‰∏ÄÈÉ®Âú∞Âüü„ÅÆÂ§ßÊ∞óÁí∞Â¢É", "‰∏≠ÂøÉÈÉ®„ÅÆÂú∞‰æ°‰∏äÊòá"],
    trend: [{y:"2020",p:52000},{y:"2021",p:53200},{y:"2022",p:54500},{y:"2023",p:55800},{y:"2024",p:56300},{y:"2025",p:57020}],
    recAreas: ["ÂØåÁî∞„ÉªÂØåÊ¥≤Âéü„Ç®„É™„Ç¢ÔºàÈßÖËøë„ÅßÂâ≤ÂÆâÔºâ","Á¨πÂ∑ù„ÉªÊó•Ê∞∏„Ç®„É™„Ç¢Ôºà‰ΩèÁí∞Â¢ÉËâØÂ•ΩÔºâ","Ê∞¥Ê≤¢„ÉªÂ∞èÂ±±Áî∞„Ç®„É™„Ç¢ÔºàËá™ÁÑ∂Ë±ä„ÅãÔºâ"]
  },
  {
    id: "kuwana", name: "Ê°ëÂêçÂ∏Ç", cityCode: "24205", lat: 35.0585, lng: 136.6834,
    landPriceAvg: 55543, residentialPrice: 53686, commercialPrice: 86714, pricePerTsubo: 183614,
    yoyChange: 0.82, population: 140000, popGrowthRate: -0.5, accessToNagoya: 25,
    hospitals: 18, schools: 28, parks: 22, shopping: 55, safetyScore: 82, childcareScore: 85, naturalScore: 68,
    description: "ÂêçÂè§Â±ã„Å∏„ÅÆÈÄöÂã§Âúè„Å®„Åó„Å¶‰∫∫Ê∞ó„ÄÇÊ°ëÂêçÈßÖ„Åã„ÇâÂêçÂè§Â±ã„Åæ„ÅßÊúÄÁü≠25ÂàÜ„ÄÇ„Éä„Ç¨„Ç∑„Éû„Çπ„Éë„Éº„É©„É≥„Éâ„ÇÑ„Å™„Å∞„Å™„ÅÆÈáå„Å™„Å©Ë¶≥ÂÖâË≥áÊ∫ê„ÇÇË±äÂØå„ÄÇÊ≠¥Âè≤ÁöÑ„Å™Âüé‰∏ãÁî∫„ÅÆÈ¢®ÊÉÖ„ÅåÊÆã„Çã„ÄÇ",
    highlights: ["ÂêçÂè§Â±ã„Å∏ÊúÄÁü≠25ÂàÜ","Â≠êËÇ≤„Å¶Áí∞Â¢É‚óé","Ë¶≥ÂÖâË≥áÊ∫êË±äÂØå","‰ΩèÁí∞Â¢É„ÅÆËâØ„Åï"],
    risks: ["ÊèñÊñêÂ∑ù„ÉªÈï∑ËâØÂ∑ù„ÅÆÊ¥™Ê∞¥„É™„Çπ„ÇØ","‰∫∫Âè£Ê∏õÂ∞ëÂÇæÂêë"],
    trend: [{y:"2020",p:52500},{y:"2021",p:53000},{y:"2022",p:53800},{y:"2023",p:54500},{y:"2024",p:55100},{y:"2025",p:55543}],
    recAreas: ["Ê°ëÂêçÈßÖÂë®Ëæ∫ÔºàÂà©‰æøÊÄßÈáçË¶ñÔºâ","Â§öÂ∫¶„Ç®„É™„Ç¢ÔºàËá™ÁÑ∂„Å®‰æ°Ê†º„Éê„É©„É≥„ÇπÔºâ","Èï∑Â≥∂„Ç®„É™„Ç¢Ôºà„ÇÜ„Å£„Åü„ÇäÂ±Ö‰ΩèÔºâ"]
  },
  {
    id: "suzuka", name: "Èà¥ÈπøÂ∏Ç", cityCode: "24207", lat: 34.8824, lng: 136.5842,
    landPriceAvg: 41015, residentialPrice: 38000, commercialPrice: 62000, pricePerTsubo: 135587,
    yoyChange: 1.11, population: 195000, popGrowthRate: -0.2, accessToNagoya: 55,
    hospitals: 25, schools: 42, parks: 28, shopping: 72, safetyScore: 80, childcareScore: 80, naturalScore: 65,
    description: "Èà¥Èπø„Çµ„Éº„Ç≠„ÉÉ„Éà„Å®HondaÊäÄÁ†î„ÅÆ‰ºÅÊ•≠Âüé‰∏ãÁî∫„ÄÇÂêçÂè§Â±ãÂúè„Å®ÊØî„ÅπÂú∞‰æ°„ÅåÊâãÈ†É„Åß„ÄÅÂ∫É„ÅÑÂúüÂú∞„ÇíÁ¢∫‰øù„Åó„ÇÑ„Åô„ÅÑ„ÄÇÊñ∞ÂêçÁ•ûÈà¥Èπø„Çπ„Éû„Éº„ÉàIC„ÅÆÈñãÈÄö„Åß‰∫§ÈÄöÂà©‰æøÊÄß„ÅåÂêë‰∏ä„ÄÇ",
    highlights: ["Âú∞‰æ°„ÅåÊâãÈ†É„ÅßÂ∫É„ÅÑÂÆ∂„ÅåÂª∫„Å¶„ÇÑ„Åô„ÅÑ","HondaÈñ¢ÈÄ£„ÅÆÈõáÁî®ÂÆâÂÆö","Êñ∞ÂêçÁ•û„Çπ„Éû„Éº„ÉàIC","‰∏≠Âã¢„Éê„Ç§„Éë„ÇπÊï¥ÂÇô"],
    risks: ["ÂêçÂè§Â±ãÈÄöÂã§„Å´„ÅØ„ÇÑ„ÇÑÈÅ†„ÅÑ","Ê≤øÂ≤∏ÈÉ®„ÅÆÊ¥•Ê≥¢„É™„Çπ„ÇØ"],
    trend: [{y:"2020",p:38500},{y:"2021",p:39000},{y:"2022",p:39600},{y:"2023",p:40200},{y:"2024",p:40600},{y:"2025",p:41015}],
    recAreas: ["ÁôΩÂ≠êÈßÖÂë®Ëæ∫ÔºàÂà©‰æøÊÄß‚óéÔºâ","Âπ≥Áî∞„ÉªÁÆóÊâÄ„Ç®„É™„Ç¢ÔºàËêΩ„Å°ÁùÄ„ÅÑ„Åü‰ΩèÂÆÖÂú∞Ôºâ","Â∫ÑÈáé„ÉªÂä†‰ΩêÁôª„Ç®„É™„Ç¢ÔºàÊñ∞Ëàà‰ΩèÂÆÖÂú∞Ôºâ"]
  },
  {
    id: "inabe", name: "„ÅÑ„Å™„ÅπÂ∏Ç", cityCode: "24212", lat: 35.1146, lng: 136.5612,
    landPriceAvg: 24500, residentialPrice: 22000, commercialPrice: 35000, pricePerTsubo: 81000,
    yoyChange: 0.45, population: 44000, popGrowthRate: -0.8, accessToNagoya: 65,
    hospitals: 6, schools: 14, parks: 18, shopping: 15, safetyScore: 88, childcareScore: 75, naturalScore: 95,
    description: "Èà¥ÈπøÂ±±ËÑà„ÅÆÈ∫ì„Å´Â∫É„Åå„ÇãËá™ÁÑ∂Ë±ä„Åã„Å™„Åæ„Å°„ÄÇ„Ç¢„Ç¶„Éà„Éâ„Ç¢„É¨„Ç∏„É£„Éº„ÅåÂÖÖÂÆü„Åó„ÄÅÁßª‰ΩèÂÖà„Å®„Åó„Å¶Ê≥®ÁõÆÂ∫¶‰∏äÊòá‰∏≠„ÄÇÂú∞‰æ°„ÅØÁúåÂåóÈÉ®„ÅßÊúÄ„ÇÇÊâãÈ†É„Å™Ê∞¥Ê∫ñ„ÄÇ",
    highlights: ["ÂúßÂÄíÁöÑ„Å™Ëá™ÁÑ∂Áí∞Â¢É","Âú∞‰æ°„ÅåÈùûÂ∏∏„Å´ÊâãÈ†É","Áßª‰ΩèÊîØÊè¥Âà∂Â∫¶ÂÖÖÂÆü","„Ç¢„Ç¶„Éà„Éâ„Ç¢Â§©ÂõΩ"],
    risks: ["ÂïÜÊ•≠ÊñΩË®≠„ÅåÂ∞ë„Å™„ÅÑ","ÂÖ¨ÂÖ±‰∫§ÈÄö„Åå‰∏ç‰æø","‰∫∫Âè£Ê∏õÂ∞ë"],
    trend: [{y:"2020",p:23500},{y:"2021",p:23700},{y:"2022",p:23900},{y:"2023",p:24100},{y:"2024",p:24300},{y:"2025",p:24500}],
    recAreas: ["ÂåóÂã¢„Ç®„É™„Ç¢ÔºàÈßÖËøë„ÉªÂà©‰æøÊÄßÔºâ","Âì°ÂºÅ„Ç®„É™„Ç¢ÔºàÈñëÈùô„Å™‰ΩèÂÆÖÂú∞Ôºâ","Ëó§Âéü„Ç®„É™„Ç¢ÔºàÂ±±ÈñìÈÉ®„ÉªÊ†ºÂÆâÔºâ"]
  },
  {
    id: "kameyama", name: "‰∫ÄÂ±±Â∏Ç", cityCode: "24210", lat: 34.8540, lng: 136.4520,
    landPriceAvg: 29500, residentialPrice: 27000, commercialPrice: 42000, pricePerTsubo: 97500,
    yoyChange: 0.68, population: 49000, popGrowthRate: -0.6, accessToNagoya: 60,
    hospitals: 8, schools: 16, parks: 15, shopping: 22, safetyScore: 85, childcareScore: 76, naturalScore: 80,
    description: "Êù±ÂêçÈò™„Å®Êñ∞ÂêçÁ•û„Åå‰∫§Â∑Æ„Åô„Çã‰∫§ÈÄö„ÅÆË¶ÅË°ù„ÄÇÊóßÊù±Êµ∑ÈÅì„ÅÆÂÆøÂ†¥Áî∫„ÅÆÊ≠¥Âè≤„ÇíÊåÅ„Å§„ÄÇSharp‰∫ÄÂ±±Â∑•Â†¥„Çí„ÅØ„Åò„ÇÅË£ΩÈÄ†Ê•≠„ÅåÈõÜÁ©ç„ÄÇ",
    highlights: ["È´òÈÄüÈÅìË∑Ø„ÅÆÁµêÁØÄÁÇπ","Ë£ΩÈÄ†Ê•≠„ÅÆÈõáÁî®","Ê≠¥Âè≤ÁöÑ„Å™Ë°ó‰∏¶„Åø","Ââ≤ÂÆâ„Å™Âú∞‰æ°"],
    risks: ["JR„ÅÆÊú¨Êï∞„ÅåÂ∞ë„Å™„ÅÑ","ÂïÜÊ•≠ÊñΩË®≠„ÅåÈôêÂÆöÁöÑ"],
    trend: [{y:"2020",p:28000},{y:"2021",p:28300},{y:"2022",p:28700},{y:"2023",p:29000},{y:"2024",p:29200},{y:"2025",p:29500}],
    recAreas: ["‰∫ÄÂ±±ÈßÖÂë®Ëæ∫ÔºàJR„Ç¢„ÇØ„Çª„ÇπÔºâ","Èñ¢„Ç®„É™„Ç¢ÔºàÂÆøÂ†¥Áî∫„ÅÆÈ¢®ÊÉÖÔºâ","ÈáéÊùë„Ç®„É™„Ç¢ÔºàÊñ∞Ëàà‰ΩèÂÆÖÂú∞Ôºâ"]
  },
  {
    id: "komono", name: "Ëè∞ÈáéÁî∫", cityCode: "24341", lat: 35.0244, lng: 136.5090,
    landPriceAvg: 31000, residentialPrice: 29000, commercialPrice: 45000, pricePerTsubo: 102500,
    yoyChange: 0.55, population: 41000, popGrowthRate: -0.1, accessToNagoya: 50,
    hospitals: 7, schools: 12, parks: 20, shopping: 25, safetyScore: 86, childcareScore: 83, naturalScore: 92,
    description: "Âæ°Âú®ÊâÄÂ≤≥„Å®ÊπØ„ÅÆÂ±±Ê∏©Ê≥â„ÇíÊä±„Åà„ÇãË¶≥ÂÖâ„Å®Ëá™ÁÑ∂„ÅÆ„Åæ„Å°„ÄÇËøëÈâÑÊπØ„ÅÆÂ±±Á∑ö„ÅßÂõõÊó•Â∏Ç„Å∏Áõ¥ÈÄö„ÄÇ‰∫∫Âè£Ê∏õÂ∞ëÁéá„Åå‰Ωé„Åè„ÄÅÁßª‰ΩèÂÖà„Å®„Åó„Å¶‰∫∫Ê∞ó„ÅåÈ´ò„ÅÑ„ÄÇ",
    highlights: ["Ê∏©Ê≥â„Å®Ëá™ÁÑ∂Áí∞Â¢É","‰∫∫Âè£Ê∏õÂ∞ëÁéá„Åå‰Ωé„ÅÑ","ÂõõÊó•Â∏Ç„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπËâØÂ•Ω","Áßª‰Ωè‰∫∫Ê∞ó‰∏äÊòá‰∏≠"],
    risks: ["ÈâÑÈÅì„ÅØÊπØ„ÅÆÂ±±Á∑ö„ÅÆ„Åø","Â§ßÂûãÂïÜÊ•≠ÊñΩË®≠„ÅåÂ∞ë„Å™„ÅÑ"],
    trend: [{y:"2020",p:29500},{y:"2021",p:29800},{y:"2022",p:30200},{y:"2023",p:30500},{y:"2024",p:30800},{y:"2025",p:31000}],
    recAreas: ["Ëè∞ÈáéÈßÖÂë®Ëæ∫ÔºàÂà©‰æøÊÄßÈáçË¶ñÔºâ","ÊπØ„ÅÆÂ±±„Ç®„É™„Ç¢ÔºàÊ∏©Ê≥â„ÉªËá™ÁÑ∂Ôºâ","Á´πÊàê„ÉªÂçÉËçâ„Ç®„É™„Ç¢ÔºàÈñëÈùôÔºâ"]
  },
  {
    id: "toin", name: "Êù±Âì°Áî∫", cityCode: "24343", lat: 35.0690, lng: 136.6030,
    landPriceAvg: 35500, residentialPrice: 33000, commercialPrice: 48000, pricePerTsubo: 117400,
    yoyChange: 0.72, population: 26000, popGrowthRate: 0.1, accessToNagoya: 40,
    hospitals: 5, schools: 8, parks: 12, shopping: 18, safetyScore: 87, childcareScore: 88, naturalScore: 72,
    description: "„Ç§„Ç™„É≥„É¢„Éº„É´Êù±Âì°„Çí‰∏≠ÂøÉ„Å´ÂïÜÊ•≠ÊñΩË®≠„ÅåÂÖÖÂÆü„Åó„Åü„Ç≥„É≥„Éë„ÇØ„Éà„Ç∑„ÉÜ„Ç£„ÄÇ‰∫∫Âè£„ÅåÂæÆÂ¢óÂÇæÂêë„Åß„Éï„Ç°„Éü„É™„ÉºÂ±§„Å´‰∫∫Ê∞ó„ÄÇ",
    highlights: ["‰∫∫Âè£Â¢óÂä†ÂÇæÂêë","„Ç§„Ç™„É≥„É¢„Éº„É´Êù±Âì°","Â≠êËÇ≤„Å¶‰∏ñ‰ª£„Å´‰∫∫Ê∞ó","„Ç≥„É≥„Éë„ÇØ„Éà„Åß‰Ωè„Åø„ÇÑ„Åô„ÅÑ"],
    risks: ["ÈâÑÈÅì„Ç¢„ÇØ„Çª„Çπ„ÅåÈôêÂÆöÁöÑ","Áî∫Âüü„ÅåÁã≠„ÅÑ"],
    trend: [{y:"2020",p:33500},{y:"2021",p:34000},{y:"2022",p:34500},{y:"2023",p:35000},{y:"2024",p:35200},{y:"2025",p:35500}],
    recAreas: ["Êù±Âì°ÈßÖÂë®Ëæ∫ÔºàÈßÖËøëÔºâ","Á¨πÂ∞æ„Ç®„É™„Ç¢Ôºà„Éï„Ç°„Éü„É™„ÉºÂêë„ÅëÔºâ","ÂüéÂ±±„Ç®„É™„Ç¢ÔºàÊñ∞Ëàà‰ΩèÂÆÖÂú∞Ôºâ"]
  }
];

const COLORS = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4'];

// ============================================================
// App State
// ============================================================
const state = {
  view: 'ranking',
  selectedAreaId: null,
  mapSelectedAreaId: null,
  mcpStatus: 'disconnected', // disconnected | connecting | connected | error
  mcpMessage: '',
  mcpLiveData: null,
  weights: { price: 25, access: 20, growth: 15, living: 15, family: 15, nature: 10 },
  charts: {},
  mapSelectedDistrict: null  // { cityId, districtName } or null
};

// Map globals (persistent across renders)
let mapInstance = null;
let mapMarkers = {};
let txMarkerLayer = null; // LayerGroup for transaction markers
let schoolDistrictLayer = null; // GeoJSON layer for school district polygons
let schoolMarkerLayer = null; // LayerGroup for school icon markers
let schoolDistrictData = null; // cached GeoJSON data
let showSchoolDistricts = false; // toggle state
let districtAreaLayer = null; // LayerGroup for district area circles
let showDistrictAreas = false; // toggle state

// ============================================================
// Score Calculation
// ============================================================
function calcScores(area, w) {
  const priceScore = 100 - ((area.residentialPrice - 20000) / 40000) * 100;
  const accessScore = ((70 - area.accessToNagoya) / 70) * 100;
  const growthScore = Math.min(100, Math.max(0, (area.yoyChange / 2) * 100));
  const livingScore = (area.hospitals/45)*25 + (area.schools/60)*25 + (area.shopping/120)*25 + (area.safetyScore/100)*25;
  const familyScore = (area.childcareScore + area.safetyScore + Math.min(100,(area.parks/35)*100)) / 3;
  const natureScore = area.naturalScore;
  const total = priceScore*(w.price/100) + accessScore*(w.access/100) + growthScore*(w.growth/100) + livingScore*(w.living/100) + familyScore*(w.family/100) + natureScore*(w.nature/100);
  return { price: Math.round(priceScore), access: Math.round(accessScore), growth: Math.round(growthScore), living: Math.round(livingScore), family: Math.round(familyScore), nature: Math.round(natureScore), total: Math.round(total) };
}

function getRankedAreas() {
  return AREAS.map(a => ({ ...a, scores: calcScores(a, state.weights) })).sort((a,b) => b.scores.total - a.scores.total);
}

// ============================================================
// MCP Connection
// ============================================================
let mcpReinfo = null;

async function connectMCP() {
  state.mcpStatus = 'connecting';
  state.mcpMessage = 'MCP„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö‰∏≠Ôºà„Éó„É≠„Ç≠„Ç∑ÁµåÁî±„ÅßË©¶Ë°åÔºâ...';
  render();

  try {
    mcpReinfo = new MCPClient(CONFIG.MCP_REINFO, CONFIG.PROXY_URL);
    await mcpReinfo.initialize();
    const tools = await mcpReinfo.listTools();
    state.mcpStatus = 'connected';
    state.mcpMessage = `Êé•Á∂öÂÆå‰∫Ü ‚Äî ${tools.length}ÂÄã„ÅÆ„ÉÑ„Éº„É´„ÅåÂà©Áî®ÂèØËÉΩ`;
    render();

    // Phase 1: Ê¶ÇË¶ÅÂèñÂæó ‚Üí Phase 2: ÂÖ®„Ç®„É™„Ç¢Ë©≥Á¥∞„ÇíËá™ÂãïÂèñÂæó
    await fetchLiveData();
    fetchAllAreasData();  // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßÂÖ®„Ç®„É™„Ç¢ÂèñÂæóÈñãÂßãÔºàawait„Åó„Å™„ÅÑÔºâ
  } catch(e) {
    state.mcpStatus = 'error';
    state.mcpMessage = `Êé•Á∂öÂ§±Êïó: ${e.message}Ôºà„Ç≠„É£„ÉÉ„Ç∑„É•„Éá„Éº„Çø„Çí‰ΩøÁî®‰∏≠Ôºâ`;
    render();
  }
}

// Lightweight status text update (no full re-render)
function updateStatusText(msg) {
  state.mcpMessage = msg;
  const el = document.getElementById('mcp-status-text');
  if (el) el.textContent = msg;
}

// ------------------------------------------------------------
// Phase 1: Quick overview fetch (latest year only, all areas)
// ------------------------------------------------------------
async function fetchLiveData() {
  if (!mcpReinfo || !mcpReinfo.connected) return;

  try {
    updateStatusText('Ê¶ÇË¶Å„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...');

    const cityResult = await mcpReinfo.callTool('reinfolib-city-list', { area: '24' });

    // Fetch only latest year for quick overview (7 requests)
    const priceResults = [];
    for (const area of AREAS) {
      try {
        updateStatusText(`${area.name} „ÅÆÊ¶ÇË¶Å„Éá„Éº„ÇøÂèñÂæó‰∏≠...`);
        const priceData = await mcpReinfo.callTool('reinfolib-real-estate-price', {
          year: '2024', area: '24', city: area.cityCode
        });
        priceResults.push({ cityCode: area.cityCode, quarters: [priceData] });
      } catch(e) {
        console.warn(`Overview fetch failed for ${area.name}:`, e);
        priceResults.push({ cityCode: area.cityCode, quarters: [] });
      }
    }

    state.mcpLiveData = { cities: cityResult, prices: priceResults };
    updateAreasWithLiveData(priceResults);

    let totalTx = 0;
    AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
    state.mcpMessage = `Ê¶ÇË¶Å„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫ÜÔºàË®à${totalTx}‰ª∂Ôºâ ‚Äî Ë©≥Á¥∞„Éá„Éº„Çø„ÇíËá™ÂãïÂèñÂæó‰∏≠...`;

    render();
  } catch(e) {
    state.mcpMessage = `„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº: ${e.message}Ôºà„Ç≠„É£„ÉÉ„Ç∑„É•„Éá„Éº„Çø„Çí‰ΩøÁî®‰∏≠Ôºâ`;
    render();
  }
}

// ------------------------------------------------------------
// Phase 2: Deep fetch for a single area (5 years √ó 4 quarters)
// ------------------------------------------------------------
const AREA_FULL_LOADED = new Set();
let _currentFetchAreaId = null;
let _fetchPriorityAreaId = null;  // „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Å´„Çà„ÇãÂÑ™ÂÖàÂèñÂæó„Ç®„É™„Ç¢
let _autoFetchRunning = false;    // ÂÖ®„Ç®„É™„Ç¢Ëá™ÂãïÂèñÂæó„ÅÆÂÆüË°å‰∏≠„Éï„É©„Ç∞

async function fetchAreaFullData(areaId, options = {}) {
  if (!mcpReinfo || !mcpReinfo.connected) return;
  if (AREA_FULL_LOADED.has(areaId)) return; // already loaded
  if (_currentFetchAreaId === areaId) return; // already fetching

  const area = AREAS.find(a => a.id === areaId);
  if (!area) return;

  _currentFetchAreaId = areaId;

  // ÈÅ∏Êäû‰∏≠„Ç®„É™„Ç¢„ÅÆ„Åø„Ç™„Éº„Éê„Éº„É¨„Ç§Ë°®Á§∫Ôºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂèñÂæóÊôÇ„ÅØÈùûË°®Á§∫Ôºâ
  const isSelected = state.mapSelectedAreaId === areaId;
  const showOverlay = options.showOverlay !== undefined ? options.showOverlay : isSelected;
  if (showOverlay) showMapLoading(area.name, 0);

  const yearQuarters = [
    { year: '2024', quarter: '4' }, { year: '2024', quarter: '3' },
    { year: '2024', quarter: '2' }, { year: '2024', quarter: '1' },
    { year: '2023', quarter: '4' }, { year: '2023', quarter: '3' },
    { year: '2023', quarter: '2' }, { year: '2023', quarter: '1' },
    { year: '2022', quarter: '4' }, { year: '2022', quarter: '3' },
    { year: '2022', quarter: '2' }, { year: '2022', quarter: '1' },
    { year: '2021', quarter: '4' }, { year: '2021', quarter: '3' },
    { year: '2021', quarter: '2' }, { year: '2021', quarter: '1' },
    { year: '2020', quarter: '4' }, { year: '2020', quarter: '3' },
    { year: '2020', quarter: '2' }, { year: '2020', quarter: '1' },
  ];

  const allData = [];
  let done = 0;
  const total = yearQuarters.length;

  for (const yq of yearQuarters) {
    try {
      done++;
      const pct = Math.round(done / total * 100);
      if (showOverlay) updateMapLoading(`${area.name} ${yq.year}Âπ¥Q${yq.quarter}`, pct);
      updateStatusText(`${area.name} Ë©≥Á¥∞ÂèñÂæó‰∏≠... (${done}/${total})`);
      const priceData = await mcpReinfo.callTool('reinfolib-real-estate-price', {
        year: yq.year, quarter: yq.quarter, area: '24', city: area.cityCode
      });
      allData.push(priceData);
    } catch(e) {
      console.warn(`Detail fetch failed for ${area.name} ${yq.year}Q${yq.quarter}:`, e);
    }
  }

  // Merge with existing overview data
  updateAreasWithLiveData([{ cityCode: area.cityCode, quarters: allData }]);

  AREA_FULL_LOADED.add(areaId);
  _currentFetchAreaId = null;

  // „Ç™„Éº„Éê„Éº„É¨„Ç§ÈùûË°®Á§∫
  if (showOverlay) hideMapLoading();

  const txCount = area._liveTransactions ? area._liveTransactions.length : 0;
  updateStatusText(`${area.name}: Ë©≥Á¥∞„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫ÜÔºà${txCount}‰ª∂Ôºâ`);

  // Update sidebar and pins with fetched data
  if (state.view === 'map') {
    const ranked = getRankedAreas();
    const rankedArea = ranked.find(a => a.id === areaId);
    if (state.mapSelectedAreaId === areaId && rankedArea) {
      updateMapSidebar(rankedArea, ranked);
    }

    // Geocode districts THEN show pins at correct positions
    if (txMarkerLayer) {
      await geocodeAreaDistricts(area, { showOverlay });
      if (state.mapSelectedAreaId === areaId) {
        showTransactionPins(area);
      }
    }
  }

  // Background geocode remaining areas' districts
  geocodeDistrictsBackground().catch(e => console.warn('Geocoding error:', e));
}

// ------------------------------------------------------------
// Auto-fetch: ÂÖ®„Ç®„É™„Ç¢„ÅÆPhase2„Éá„Éº„Çø„ÇíÈ†ÜÊ¨°ÂèñÂæóÔºàÂÑ™ÂÖà„Ç®„É™„Ç¢ÂØæÂøúÔºâ
// ------------------------------------------------------------
async function fetchAllAreasData() {
  if (_autoFetchRunning) return;
  if (!mcpReinfo || !mcpReinfo.connected) return;

  _autoFetchRunning = true;
  const areaIds = AREAS.map(a => a.id);
  let completedCount = AREA_FULL_LOADED.size;

  while (true) {
    // Ê¨°„Å´ÂèñÂæó„Åô„Çã„Ç®„É™„Ç¢„ÇíÊ±∫ÂÆö
    let nextId = null;

    // 1. ÂÑ™ÂÖà„Ç®„É™„Ç¢„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇíÂÖà„Å´
    if (_fetchPriorityAreaId && !AREA_FULL_LOADED.has(_fetchPriorityAreaId)) {
      nextId = _fetchPriorityAreaId;
      _fetchPriorityAreaId = null;
    }

    // 2. „Å™„Åë„Çå„Å∞Êú™ÂèñÂæó„ÅÆ„Ç®„É™„Ç¢„ÇíÈ†Ü„Å´
    if (!nextId) {
      nextId = areaIds.find(id => !AREA_FULL_LOADED.has(id));
    }

    // ÂÖ®„Ç®„É™„Ç¢ÂèñÂæóÊ∏à„Åø„Å™„ÇâÁµÇ‰∫Ü
    if (!nextId) break;

    const remaining = AREAS.length - AREA_FULL_LOADED.size;
    const areaName = AREAS.find(a => a.id === nextId)?.name || nextId;
    updateStatusText(`${areaName} Ë©≥Á¥∞ÂèñÂæó‰∏≠... ÔºàÊÆã„Çä${remaining}„Ç®„É™„Ç¢Ôºâ`);

    await fetchAreaFullData(nextId);

    completedCount = AREA_FULL_LOADED.size;
  }

  _autoFetchRunning = false;

  // ÂÖ®ÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏
  let totalTx = 0;
  AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
  state.mcpMessage = `ÂÖ®„Ç®„É™„Ç¢„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫ÜÔºàË®à${totalTx.toLocaleString()}‰ª∂Ôºâ`;
  updateStatusText(`ÂÖ®„Ç®„É™„Ç¢„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫ÜÔºàË®à${totalTx.toLocaleString()}‰ª∂Ôºâ`);

  // „Éû„ÉÉ„ÉóË°®Á§∫‰∏≠„Å™„ÇâÂÖ®„Éî„É≥Êõ¥Êñ∞
  if (state.view === 'map' && txMarkerLayer && !state.mapSelectedAreaId) {
    const ranked = getRankedAreas();
    showAllTransactionPins(ranked);
  }
}

function extractTransactionsFromMCPResponse(data) {
  let content = data;
  if (content && content.content) content = content.content;
  if (!Array.isArray(content)) {
    // Try alternative structures
    if (content && content.data && Array.isArray(content.data)) {
      console.log('[TX] Direct data array found:', content.data.length, 'records');
      return content.data;
    }
    if (content && typeof content === 'string') {
      try {
        const p = JSON.parse(content);
        if (p.data && Array.isArray(p.data)) {
          console.log('[TX] Parsed string data:', p.data.length, 'records');
          return p.data;
        }
      } catch {}
    }
    console.warn('[TX] Content is not array:', typeof content, content ? Object.keys(content) : 'null');
    return [];
  }
  const textContent = content.find(c => c.type === 'text');
  if (!textContent) {
    console.warn('[TX] No text content found in array of', content.length, 'elements');
    return [];
  }
  try {
    const parsed = JSON.parse(textContent.text);
    if (parsed.data && Array.isArray(parsed.data)) {
      console.log('[TX] Extracted', parsed.data.length, 'records from text content');
      return parsed.data;
    }
    // Try other keys
    for (const key of Object.keys(parsed)) {
      if (Array.isArray(parsed[key]) && parsed[key].length > 0) {
        console.log('[TX] Found array in key', key, ':', parsed[key].length, 'records');
        return parsed[key];
      }
    }
    console.warn('[TX] No data array found. Keys:', Object.keys(parsed));
  } catch(e) {
    console.warn('[TX] JSON parse error:', e.message, 'text:', textContent.text?.substring(0, 200));
  }
  return [];
}

function updateAreasWithLiveData(priceResults) {
  for (const result of priceResults) {
    const area = AREAS.find(a => a.cityCode === result.cityCode);
    if (!area) continue;

    // Merge transactions from all quarters
    const allRecords = [];
    const sources = result.quarters || (result.data ? [result.data] : []);
    console.log(`[DATA] ${area.name}: ${sources.length} sources to process`);
    for (const src of sources) {
      if (!src) continue;
      const records = extractTransactionsFromMCPResponse(src);
      allRecords.push(...records);
    }
    console.log(`[DATA] ${area.name}: ${allRecords.length} total records from all sources`);

    if (allRecords.length === 0) continue;

    // Deduplicate by comprehensive key to avoid removing distinct transactions
    const seen = new Set();
    const uniqueRecords = allRecords.filter(d => {
      const key = [
        d.TradePrice || '',
        d.DistrictName || d.Region || '',
        d.Area || '',
        d.Period || '',
        d.Type || d.TradeType || '',
        d.BuildingYear || '',
        d.NearestStation || '',
        d.FloorPlan || '',
        d.Structure || ''
      ].join('|');
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    console.log(`[DATA] ${area.name}: ${uniqueRecords.length} unique records after dedup (removed ${allRecords.length - uniqueRecords.length})`);
    if (uniqueRecords.length > 0) {
      console.log(`[DATA] ${area.name}: Sample record keys:`, Object.keys(uniqueRecords[0]));
    }

    // Store full transaction records for map display
    area._liveTransactions = uniqueRecords.map(d => ({
      TradePrice: (d.TradePrice != null && d.TradePrice !== '') ? parseInt(d.TradePrice) : null,
      Type: d.Type || d.TradeType || '',
      Area: d.Area ? parseFloat(d.Area) : null,
      FloorPlan: d.FloorPlan || '',
      BuildingYear: d.BuildingYear || '',
      NearestStation: d.NearestStation || '',
      DistanceToStation: d.TimeToNearestStation || d.DistanceToStation || '',
      Use: d.Use || d.Purpose || '',
      District: d.DistrictName || d.Region || '',
      Structure: d.Structure || '',
      CityPlanning: d.CityPlanning || '',
      Period: d.Period || '',
    }));
    console.log(`[DATA] ${area.name}: Final _liveTransactions count = ${area._liveTransactions.length}`);

    // Calculate average trade price from live data
    const prices = uniqueRecords.filter(d => d.TradePrice != null && d.TradePrice !== '').map(d => parseInt(d.TradePrice)).filter(p => !isNaN(p));
    if (prices.length > 0) {
      area._liveAvgTradePrice = Math.round(prices.reduce((a,b) => a+b, 0) / prices.length);
      area._liveTransactionCount = uniqueRecords.length;
    }
  }
}

// ============================================================
// Render Functions
// ============================================================
function render() {
  const app = document.getElementById('app');
  const ranked = getRankedAreas();
  const selected = state.selectedAreaId ? ranked.find(a => a.id === state.selectedAreaId) : ranked[0];

  app.innerHTML = `
    ${renderHeader()}
    <div class="max-w-6xl mx-auto px-4 py-6">
      ${renderMCPStatus()}
      ${renderWeights()}
      ${state.view === 'ranking' ? renderRanking(ranked) : ''}
      ${state.view === 'compare' ? renderCompare(ranked) : ''}
      ${state.view === 'detail' ? renderDetail(selected, ranked) : ''}
      ${state.view === 'map' ? renderMap(ranked) : ''}
      ${renderFooter()}
    </div>
  `;

  // Re-bind„Ç§„Éô„É≥„Éà
  bindEvents(ranked);

  // „ÉÅ„É£„Éº„ÉàÊèèÁîª„Éª„Éû„ÉÉ„ÉóÂàùÊúüÂåñÔºàDOM„ÅåÂ≠òÂú®„Åó„Å¶„Åã„ÇâÔºâ
  requestAnimationFrame(() => {
    if (state.view === 'compare') drawCompareCharts(ranked);
    if (state.view === 'detail' && selected) drawDetailCharts(selected);
    if (state.view === 'map') {
      initializeMap(ranked);
      if (state.mapSelectedAreaId) {
        const selArea = ranked.find(a => a.id === state.mapSelectedAreaId);
        if (selArea) updateMapSidebar(selArea, ranked);
      }
    }
  });
}

function renderHeader() {
  const tabs = [
    { id: 'ranking', label: 'üèÜ „É©„É≥„Ç≠„É≥„Ç∞' },
    { id: 'compare', label: 'üìä ÊØîËºÉ' },
    { id: 'detail', label: 'üîç Ë©≥Á¥∞' },
    { id: 'map', label: 'üó∫Ô∏è Âú∞Âõ≥' }
  ];
  return `
    <header class="glass sticky top-0 z-50 border-b border-gray-200 shadow-sm">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">üè† ‰∏âÈáçÁúåÂåóÈÉ® ‰∏çÂãïÁî£„Åä„Åô„Åô„ÇÅ„Ç®„É™„Ç¢Ë®∫Êñ≠</h1>
            <p class="text-sm text-gray-500 mt-1">ÂõΩÂúü‰∫§ÈÄöÁúÅ ‰∏çÂãïÁî£ÊÉÖÂ†±„É©„Ç§„Éñ„É©„É™ MCP + e-Stat „ÅÆ„Éá„Éº„Çø„ÇíÊ¥ªÁî®</p>
          </div>
          <div class="flex gap-2">
            ${tabs.map(t => `
              <button data-tab="${t.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-all ${state.view === t.id ? 'tab-active' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                ${t.label}
              </button>
            `).join('')}
          </div>
        </div>
      </div>
    </header>
  `;
}

function renderMCPStatus() {
  const statusColors = {
    disconnected: { bg: 'bg-gray-100', text: 'text-gray-600', dot: 'bg-gray-400' },
    connecting: { bg: 'bg-blue-50', text: 'text-blue-700', dot: 'bg-blue-500' },
    connected: { bg: 'bg-green-50', text: 'text-green-700', dot: 'bg-green-500' },
    error: { bg: 'bg-amber-50', text: 'text-amber-700', dot: 'bg-amber-500' }
  };
  const s = statusColors[state.mcpStatus];
  const statusLabel = { disconnected: 'Êú™Êé•Á∂ö', connecting: 'Êé•Á∂ö‰∏≠', connected: '„É©„Ç§„ÉñÊé•Á∂ö', error: '„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ' }[state.mcpStatus];

  return `
    <div class="card p-4 mb-4 flex items-center justify-between flex-wrap gap-3">
      <div class="flex items-center gap-3">
        <div class="status-badge ${s.bg} ${s.text}">
          <span class="pulse-dot ${s.dot}"></span>
          MCP: ${statusLabel}
        </div>
        <span id="mcp-status-text" class="text-sm text-gray-500">${state.mcpMessage || 'MCP„Çµ„Éº„Éê„ÉºÊú™Êé•Á∂ö ‚Äî „Ç≠„É£„ÉÉ„Ç∑„É•„Éá„Éº„Çø„Çí‰ΩøÁî®‰∏≠'}</span>
      </div>
      <div class="flex gap-2">
        ${state.mcpStatus !== 'connected' ? `
          <button id="btn-connect-mcp" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
            üîå MCP„Çµ„Éº„Éê„Éº„Å´Êé•Á∂öÔºà„Éó„É≠„Ç≠„Ç∑ÁµåÁî±Ôºâ
          </button>
        ` : `
          <span class="text-xs text-green-600 self-center mr-2">${mcpReinfo?.useProxy ? 'üîÄ „Éó„É≠„Ç≠„Ç∑ÁµåÁî±' : 'üì° Áõ¥Êé•Êé•Á∂ö'}</span>
          <button id="btn-refresh-mcp" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
            üîÑ „Éá„Éº„ÇøÊõ¥Êñ∞
          </button>
        `}
      </div>
    </div>
  `;
}

function renderWeights() {
  const items = [
    { key: 'price', label: '‰æ°Ê†º„ÅÆÊâãÈ†É„Åï', icon: 'üí∞' },
    { key: 'access', label: 'ÂêçÂè§Â±ã„Ç¢„ÇØ„Çª„Çπ', icon: 'üöÉ' },
    { key: 'growth', label: 'Ë≥áÁî£‰æ°ÂÄ§‰∏äÊòá', icon: 'üìà' },
    { key: 'living', label: 'ÁîüÊ¥ªÂà©‰æøÊÄß', icon: 'üè™' },
    { key: 'family', label: 'Â≠êËÇ≤„Å¶Áí∞Â¢É', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
    { key: 'nature', label: 'Ëá™ÁÑ∂Áí∞Â¢É', icon: 'üåø' }
  ];
  return `
    <div class="card p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">üéØ „ÅÇ„Å™„Åü„ÅÆÂÑ™ÂÖàÂ∫¶„ÇíË®≠ÂÆö</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        ${items.map(i => `
          <div class="flex items-center gap-3">
            <span class="text-xl w-8 text-center">${i.icon}</span>
            <div class="flex-1">
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">${i.label}</span>
                <span class="text-sm font-bold text-blue-600" id="wv-${i.key}">${state.weights[i.key]}</span>
              </div>
              <input type="range" min="0" max="50" value="${state.weights[i.key]}" data-weight="${i.key}"
                class="w-full cursor-pointer" style="background: linear-gradient(to right, #3b82f6 0%, #3b82f6 ${state.weights[i.key]*2}%, #e5e7eb ${state.weights[i.key]*2}%, #e5e7eb 100%);">
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderRanking(ranked) {
  const medals = ['medal-gold','medal-silver','medal-bronze'];
  const scoreKeys = [
    { key: 'price', label: '‰æ°Ê†º' },
    { key: 'access', label: '‰∫§ÈÄö' },
    { key: 'growth', label: 'ÊàêÈï∑' },
    { key: 'living', label: 'Âà©‰æø' },
    { key: 'family', label: 'Â≠êËÇ≤' },
    { key: 'nature', label: 'Ëá™ÁÑ∂' }
  ];

  return `
    <div class="space-y-4 fade-in">
      <h2 class="text-lg font-bold text-gray-800">üèÜ „Åä„Åô„Åô„ÇÅ„Ç®„É™„Ç¢„É©„É≥„Ç≠„É≥„Ç∞</h2>
      ${ranked.map((a, idx) => `
        <div class="card p-5 cursor-pointer" data-area-detail="${a.id}">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 flex flex-col items-center w-16">
              <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg ${idx < 3 ? medals[idx] : 'bg-slate-400'}">
                ${idx + 1}
              </div>
              <div class="text-2xl font-bold text-blue-600 mt-1">${a.scores.total}<span class="text-xs text-gray-400 font-normal">pt</span></div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="text-xl font-bold text-gray-900">${a.name}</h3>
                ${a.popGrowthRate > 0 ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">‰∫∫Âè£Â¢óÂä†‰∏≠</span>' : ''}
                ${a._liveTransactionCount ? `<span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">LIVE ${a._liveTransactionCount}‰ª∂</span>` : ''}
              </div>
              <p class="text-sm text-gray-600 mb-3">${a.description}</p>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                  <div class="text-xs text-gray-500">‰ΩèÂÆÖÂú∞‰æ°Ê†º</div>
                  <div class="text-sm font-bold text-blue-700">${(a.residentialPrice/10000).toFixed(1)}‰∏á/m¬≤</div>
                </div>
                <div class="text-center p-2 bg-green-50 rounded-lg">
                  <div class="text-xs text-gray-500">ÂêçÂè§Â±ã„Åæ„Åß</div>
                  <div class="text-sm font-bold text-green-700">${a.accessToNagoya}ÂàÜ</div>
                </div>
                <div class="text-center p-2 bg-amber-50 rounded-lg">
                  <div class="text-xs text-gray-500">Âú∞‰æ°Â§âÂãï</div>
                  <div class="text-sm font-bold text-amber-700">+${a.yoyChange}%</div>
                </div>
                <div class="text-center p-2 bg-purple-50 rounded-lg">
                  <div class="text-xs text-gray-500">‰∫∫Âè£</div>
                  <div class="text-sm font-bold text-purple-700">${(a.population/10000).toFixed(1)}‰∏á‰∫∫</div>
                </div>
              </div>
            </div>
            <div class="flex-shrink-0 w-28 space-y-1 hidden sm:block">
              ${scoreKeys.map(s => `
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-400 w-8 text-right">${s.label}</span>
                  <div class="score-bar flex-1"><div class="score-bar-fill bg-blue-500" style="width:${a.scores[s.key]}%"></div></div>
                  <span class="text-xs text-gray-500 w-5 text-right">${a.scores[s.key]}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderCompare(ranked) {
  return `
    <div class="space-y-6 fade-in">
      <h2 class="text-lg font-bold text-gray-800">üìä „Ç®„É™„Ç¢ÊØîËºÉ</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">‰ΩèÂÆÖÂú∞‰æ°Ê†º √ó Á∑èÂêà„Çπ„Ç≥„Ç¢</h3>
          <canvas id="chart-bar" height="260"></canvas>
        </div>
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">Âú∞‰æ°Êé®ÁßªÔºà2020-2025Âπ¥Ôºâ</h3>
          <canvas id="chart-trend" height="260"></canvas>
        </div>
      </div>
      <div class="card p-6 overflow-x-auto">
        <h3 class="text-base font-bold text-gray-700 mb-4">ÂÖ®„Ç®„É™„Ç¢ÊØîËºÉ‰∏ÄË¶ß</h3>
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-left py-2 px-3 font-medium text-gray-600">„Ç®„É™„Ç¢</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">‰ΩèÂÆÖÂú∞(ÂÜÜ/m¬≤)</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">Âù™Âçò‰æ°</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">Â§âÂãïÁéá</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">ÂêçÂè§Â±ã</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">‰∫∫Âè£</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">„Çπ„Ç≥„Ç¢</th>
            </tr>
          </thead>
          <tbody>
            ${ranked.map((a,i) => `
              <tr class="border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-area-detail="${a.id}">
                <td class="py-3 px-3 font-medium text-gray-900">
                  <span class="inline-flex items-center gap-2">
                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold" style="background:${i<3?'#3b82f6':'#94a3b8'}">${i+1}</span>
                    ${a.name}
                  </span>
                </td>
                <td class="py-3 px-3 text-right">${a.residentialPrice.toLocaleString()}</td>
                <td class="py-3 px-3 text-right">${a.pricePerTsubo.toLocaleString()}</td>
                <td class="py-3 px-3 text-right text-green-600 font-medium">+${a.yoyChange}%</td>
                <td class="py-3 px-3 text-right">${a.accessToNagoya}ÂàÜ</td>
                <td class="py-3 px-3 text-right">${(a.population/10000).toFixed(1)}‰∏á</td>
                <td class="py-3 px-3 text-right">
                  <span class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-bold text-xs">${a.scores.total}pt</span>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderDetail(area, ranked) {
  if (!area) return '<p>„Ç®„É™„Ç¢„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
  const scoreItems = [
    { key: 'price', label: '‰æ°Ê†º„ÅÆÊâãÈ†É„Åï', color: '#3b82f6' },
    { key: 'access', label: 'ÂêçÂè§Â±ã„Ç¢„ÇØ„Çª„Çπ', color: '#10b981' },
    { key: 'growth', label: 'Ë≥áÁî£‰æ°ÂÄ§‰∏äÊòá', color: '#f59e0b' },
    { key: 'living', label: 'ÁîüÊ¥ªÂà©‰æøÊÄß', color: '#ef4444' },
    { key: 'family', label: 'Â≠êËÇ≤„Å¶Áí∞Â¢É', color: '#8b5cf6' },
    { key: 'nature', label: 'Ëá™ÁÑ∂Áí∞Â¢É', color: '#06b6d4' }
  ];

  return `
    <div class="space-y-6 fade-in">
      <div class="flex items-center gap-3 flex-wrap">
        <button id="btn-back" class="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors">‚Üê Êàª„Çã</button>
        <h2 class="text-lg font-bold text-gray-800">üîç ${area.name} „ÅÆË©≥Á¥∞ÂàÜÊûê</h2>
        <button id="btn-to-map" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-50 transition-colors ml-auto">üó∫Ô∏è „Éû„ÉÉ„Éó„ÅßË°®Á§∫</button>
      </div>

      <div class="flex flex-wrap gap-2">
        ${ranked.map(a => `
          <button data-area-switch="${a.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-all ${area.id===a.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}">
            ${a.name}
          </button>
        `).join('')}
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà -->
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">Á∑èÂêàË©ï‰æ°</h3>
          <canvas id="chart-radar" height="280"></canvas>
          <div class="text-center mt-4">
            <span class="text-4xl font-bold text-blue-600">${area.scores.total}</span>
            <span class="text-sm text-gray-400 ml-1">/ 100ÁÇπ</span>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-4">
            ${scoreItems.map(s => `
              <div class="text-center">
                <div class="text-xs text-gray-500">${s.label}</div>
                <div class="text-lg font-bold" style="color:${s.color}">${area.scores[s.key]}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Âü∫Êú¨ÊÉÖÂ†± -->
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">Âü∫Êú¨„Éá„Éº„Çø</h3>
          <div class="space-y-3">
            ${[
              ['üè† ‰ΩèÂÆÖÂú∞Âπ≥Âùá', `${area.residentialPrice.toLocaleString()}ÂÜÜ/m¬≤`],
              ['üí¥ Âù™Âçò‰æ°', `${area.pricePerTsubo.toLocaleString()}ÂÜÜ/Âù™`],
              ['üìà ÂâçÂπ¥ÊØîÂ§âÂãï', `+${area.yoyChange}%`],
              ['üë• ‰∫∫Âè£', `${area.population.toLocaleString()}‰∫∫`],
              ['üöÉ ÂêçÂè§Â±ã„Åæ„Åß', `Á¥Ñ${area.accessToNagoya}ÂàÜ`],
              ['üè• ÂåªÁôÇÊñΩË®≠', `${area.hospitals}ÊñΩË®≠`],
              ['üè´ ÊïôËÇ≤ÊñΩË®≠', `${area.schools}ÊñΩË®≠`],
              ['üõç ÂïÜÊ•≠ÊñΩË®≠', `${area.shopping}ÊñΩË®≠`],
            ].map(([l,v]) => `
              <div class="flex justify-between items-center py-2 border-b border-gray-50">
                <span class="text-sm text-gray-600">${l}</span>
                <span class="text-sm font-bold text-gray-900">${v}</span>
              </div>
            `).join('')}
            ${area._liveAvgTradePrice ? `
              <div class="flex justify-between items-center py-2 border-b border-blue-100 bg-blue-50 rounded px-2 mt-2">
                <span class="text-sm text-blue-600 font-medium">üî¥ LIVE Âπ≥ÂùáÂèñÂºï‰æ°Ê†º</span>
                <span class="text-sm font-bold text-blue-700">${area._liveAvgTradePrice.toLocaleString()}ÂÜÜ</span>
              </div>
            ` : ''}
          </div>
        </div>
      </div>

      <!-- Âú∞‰æ°Êé®Áßª -->
      <div class="card p-6">
        <h3 class="text-base font-bold text-gray-700 mb-4">Âú∞‰æ°Êé®Áßª</h3>
        <canvas id="chart-detail-trend" height="200"></canvas>
      </div>

      <!-- Ê¶ÇË¶Å„Éª„Éù„Ç§„É≥„Éà„ÉªÊ≥®ÊÑèÁÇπ -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-5">
          <h3 class="text-base font-bold text-gray-700 mb-3">üìù Ê¶ÇË¶Å</h3>
          <p class="text-sm text-gray-600 leading-relaxed">${area.description}</p>
        </div>
        <div class="rounded-xl p-5 bg-green-50 border border-green-200">
          <h3 class="text-base font-bold text-green-700 mb-3">‚úÖ „Éù„Ç§„É≥„Éà</h3>
          <ul class="space-y-2">
            ${area.highlights.map(h => `<li class="text-sm text-green-800 flex items-start gap-2"><span class="mt-0.5">‚Ä¢</span>${h}</li>`).join('')}
          </ul>
        </div>
        <div class="rounded-xl p-5 bg-amber-50 border border-amber-200">
          <h3 class="text-base font-bold text-amber-700 mb-3">‚ö†Ô∏è Ê≥®ÊÑèÁÇπ</h3>
          <ul class="space-y-2">
            ${area.risks.map(r => `<li class="text-sm text-amber-800 flex items-start gap-2"><span class="mt-0.5">‚Ä¢</span>${r}</li>`).join('')}
          </ul>
        </div>
      </div>

      <!-- „Åä„Åô„Åô„ÇÅ„Ç®„É™„Ç¢ -->
      <div class="rounded-xl p-6 bg-blue-50 border border-blue-200">
        <h3 class="text-base font-bold text-blue-700 mb-3">üéØ ${area.name}„ÅÆ„Åä„Åô„Åô„ÇÅÁâ©‰ª∂„Ç®„É™„Ç¢</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          ${area.recAreas.map((r,i) => `
            <div class="bg-white rounded-lg p-4 border border-blue-100">
              <div class="text-xs text-blue-500 font-medium mb-1">„Åä„Åô„Åô„ÇÅ ${i+1}</div>
              <div class="text-sm font-medium text-gray-800">${r}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Map View
// ============================================================
function renderMap(ranked) {
  const selArea = state.mapSelectedAreaId ? ranked.find(a => a.id === state.mapSelectedAreaId) : null;
  return `
    <div class="space-y-4 fade-in">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-800">üó∫Ô∏è „Ç®„É™„Ç¢„Éû„ÉÉ„Éó</h2>
        <div class="flex gap-2">
          <button id="btn-district-area-toggle" class="school-toggle ${showDistrictAreas ? 'active' : ''}" onclick="toggleDistrictAreas()">
            <span>${showDistrictAreas ? 'üìä „Ç®„É™„Ç¢ ON' : 'üìä „Ç®„É™„Ç¢'}</span>
          </button>
          <button id="btn-school-toggle" class="school-toggle ${showSchoolDistricts ? 'active' : ''}" onclick="toggleSchoolDistricts()">
            <span>${showSchoolDistricts ? 'üè´ Â≠¶Âå∫ ON' : 'üè´ Â≠¶Âå∫'}</span>
          </button>
          <button id="btn-fullscreen-toggle" class="map-fullscreen-btn" onclick="toggleMapFullscreen()">
            <span id="fullscreen-icon">‚õ∂</span> <span id="fullscreen-label">Êã°Â§ß</span>
          </button>
        </div>
      </div>
      <!-- Fullscreen floating controls -->
      <div id="map-fullscreen-controls" class="map-fullscreen-controls">
        <span style="font-weight:600;font-size:13px;color:#1e40af;">üó∫Ô∏è „Ç®„É™„Ç¢„Éû„ÉÉ„Éó</span>
        <button class="school-toggle ${showDistrictAreas ? 'active' : ''}" onclick="toggleDistrictAreas()">
          <span>${showDistrictAreas ? 'üìä „Ç®„É™„Ç¢ ON' : 'üìä „Ç®„É™„Ç¢'}</span>
        </button>
        <button class="school-toggle ${showSchoolDistricts ? 'active' : ''}" onclick="toggleSchoolDistricts()">
          <span>${showSchoolDistricts ? 'üè´ Â≠¶Âå∫ ON' : 'üè´ Â≠¶Âå∫'}</span>
        </button>
        <button class="map-fullscreen-btn active" onclick="toggleMapFullscreen()">
          <span>‚úï</span> <span>Èñâ„Åò„Çã</span>
        </button>
      </div>
      <div class="card overflow-hidden">
        <div class="map-layout" style="position:relative;">
          <div id="map-container"></div>
          <div id="map-loading-overlay" class="map-loading-overlay hidden">
            <div class="map-loading-box">
              <div class="map-loading-spinner"></div>
              <div id="map-loading-text" style="font-size:13px;font-weight:600;color:#1e40af;">„Éá„Éº„ÇøÂèñÂæó‰∏≠...</div>
              <div class="map-loading-progress"><div id="map-loading-bar" class="map-loading-progress-bar" style="width:0%"></div></div>
            </div>
          </div>
          <div id="map-sidebar">
            ${selArea ? '' : `
              <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="text-4xl mb-3">üìç</div>
                <p class="text-sm font-medium text-gray-700 mb-1">„Ç®„É™„Ç¢„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                <p class="text-xs text-gray-400">„Éû„ÉÉ„Éó‰∏ä„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®<br>ÂúüÂú∞ÊÉÖÂ†±„ÉªÂèñÂºï„Éá„Éº„Çø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
              </div>
            `}
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Map Fullscreen Toggle
// ============================================================
let _mapFullscreen = false;

function toggleMapFullscreen() {
  _mapFullscreen = !_mapFullscreen;
  const layout = document.querySelector('.map-layout');
  const btn = document.getElementById('btn-fullscreen-toggle');
  const icon = document.getElementById('fullscreen-icon');
  const label = document.getElementById('fullscreen-label');
  const floatingCtrl = document.getElementById('map-fullscreen-controls');
  if (!layout) return;

  if (_mapFullscreen) {
    layout.classList.add('map-fullscreen');
    if (btn) btn.classList.add('active');
    if (icon) icon.textContent = '‚úï';
    if (label) label.textContent = 'Èñâ„Åò„Çã';
    // „Ç´„Éº„Éâ„ÅÆËßí‰∏∏„ÇíÁÑ°ÂäπÂåñ
    const card = layout.closest('.card');
    if (card) card.style.borderRadius = '0';
    // „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç≥„É≥„Éà„É≠„Éº„É´Ë°®Á§∫
    if (floatingCtrl) floatingCtrl.classList.add('visible');
    // „Çπ„ÇØ„É≠„Éº„É´ÁÑ°ÂäπÂåñ
    document.body.style.overflow = 'hidden';
  } else {
    layout.classList.remove('map-fullscreen');
    if (btn) btn.classList.remove('active');
    if (icon) icon.textContent = '‚õ∂';
    if (label) label.textContent = 'Êã°Â§ß';
    const card = layout.closest('.card');
    if (card) card.style.borderRadius = '';
    // „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç≥„É≥„Éà„É≠„Éº„É´ÈùûË°®Á§∫
    if (floatingCtrl) floatingCtrl.classList.remove('visible');
    // „Çπ„ÇØ„É≠„Éº„É´Âæ©Ê¥ª
    document.body.style.overflow = '';
  }

  // LeafletÂú∞Âõ≥„Çµ„Ç§„Ç∫ÂÜçË®àÁÆó
  if (mapInstance) {
    setTimeout(() => { mapInstance.invalidateSize(); }, 200);
  }
}

// ESC„Ç≠„Éº„ÅßÂÖ®ÁîªÈù¢Ëß£Èô§
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && _mapFullscreen) {
    toggleMapFullscreen();
  }
});

// ============================================================
// School District Layer
// ============================================================
const SCHOOL_DISTRICT_COLORS = [
  '#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316',
  '#14b8a6','#6366f1','#84cc16','#e11d48','#0ea5e9','#a855f7','#10b981','#f43f5e'
];

// ============================================================
// District Area Layer (toggleable, like school districts)
// ============================================================
const DISTRICT_AREA_COLORS = [
  '#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316',
  '#14b8a6','#6366f1','#84cc16','#e11d48','#0ea5e9','#a855f7','#10b981','#f43f5e'
];

function toggleDistrictAreas() {
  showDistrictAreas = !showDistrictAreas;
  const btn = document.getElementById('btn-district-area-toggle');
  if (btn) {
    btn.classList.toggle('active', showDistrictAreas);
    btn.querySelector('span').textContent = showDistrictAreas ? 'üìä „Ç®„É™„Ç¢ ON' : 'üìä „Ç®„É™„Ç¢';
  }
  if (showDistrictAreas) {
    renderDistrictAreas();
  } else {
    if (districtAreaLayer && mapInstance) {
      mapInstance.removeLayer(districtAreaLayer);
      districtAreaLayer = null;
    }
    // Clear district sidebar if showing
    state.mapSelectedDistrict = null;
  }
}

function renderDistrictAreas() {
  if (!mapInstance) return;
  if (districtAreaLayer) { mapInstance.removeLayer(districtAreaLayer); }
  districtAreaLayer = L.layerGroup();

  // Collect all districts with coordinates from all areas that have transactions
  const districtEntries = [];
  AREAS.forEach(area => {
    if (!area._liveTransactions) return;
    const districtMap = {};
    area._liveTransactions.forEach(tx => {
      if (!tx.District) return;
      if (!districtMap[tx.District]) districtMap[tx.District] = 0;
      districtMap[tx.District]++;
    });
    Object.entries(districtMap).forEach(([districtName, count]) => {
      const coords = findDistrictCoords(districtName, area.name);
      if (coords) {
        districtEntries.push({ districtName, cityName: area.name, cityId: area.id, coords, count, area });
      }
    });
  });

  let colorIdx = 0;
  districtEntries.forEach(entry => {
    const color = DISTRICT_AREA_COLORS[colorIdx++ % DISTRICT_AREA_COLORS.length];
    const radius = Math.max(200, Math.min(600, entry.count * 80));

    const circle = L.circle([entry.coords[0], entry.coords[1]], {
      radius: radius,
      color: color,
      weight: 2,
      opacity: 0.8,
      fillColor: color,
      fillOpacity: 0.15,
      dashArray: '4 3'
    });

    // Tooltip with district name
    circle.bindTooltip(`${entry.districtName} (${entry.count}‰ª∂)`, {
      permanent: false, direction: 'top', className: 'map-tooltip'
    });

    // Click ‚Üí show district info in sidebar
    circle.on('click', () => {
      state.mapSelectedDistrict = { cityId: entry.cityId, districtName: entry.districtName };
      state.mapSelectedAreaId = entry.cityId;
      const ranked = getRankedAreas();
      updateDistrictSidebar(entry.area, entry.districtName, ranked);
      // Highlight this district circle
      renderDistrictAreas();
    });

    // Highlight selected district
    if (state.mapSelectedDistrict &&
        state.mapSelectedDistrict.cityId === entry.cityId &&
        state.mapSelectedDistrict.districtName === entry.districtName) {
      circle.setStyle({ fillOpacity: 0.35, weight: 3, opacity: 1, dashArray: null });
    }

    circle.on('mouseover', function() { this.setStyle({ fillOpacity: 0.3, weight: 3 }); });
    circle.on('mouseout', function() {
      const isSelected = state.mapSelectedDistrict &&
        state.mapSelectedDistrict.cityId === entry.cityId &&
        state.mapSelectedDistrict.districtName === entry.districtName;
      this.setStyle({
        fillOpacity: isSelected ? 0.35 : 0.15,
        weight: isSelected ? 3 : 2
      });
    });

    districtAreaLayer.addLayer(circle);

    // Add label marker
    const label = L.marker([entry.coords[0], entry.coords[1]], {
      icon: L.divIcon({
        html: `<div style="font-size:10px;font-weight:600;color:${color};text-shadow:1px 1px 2px white,-1px -1px 2px white,1px -1px 2px white,-1px 1px 2px white;white-space:nowrap;text-align:center;pointer-events:none;">${entry.districtName}</div>`,
        className: 'school-icon-marker',
        iconSize: [80, 16],
        iconAnchor: [40, 8]
      }),
      interactive: false
    });
    districtAreaLayer.addLayer(label);
  });

  districtAreaLayer.addTo(mapInstance);
}

// ============================================================
// School District Layer
// ============================================================
async function loadSchoolDistrictData() {
  if (schoolDistrictData) return schoolDistrictData;
  try {
    const resp = await fetch('school-districts.geojson');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    schoolDistrictData = await resp.json();
    console.log(`School districts loaded: ${schoolDistrictData.features.length} zones`);
    return schoolDistrictData;
  } catch(e) {
    console.warn('School district data load failed:', e);
    return null;
  }
}

function toggleSchoolDistricts() {
  showSchoolDistricts = !showSchoolDistricts;
  const btn = document.getElementById('btn-school-toggle');
  if (btn) {
    btn.classList.toggle('active', showSchoolDistricts);
    btn.querySelector('span').textContent = showSchoolDistricts ? 'üè´ Â≠¶Âå∫ ON' : 'üè´ Â≠¶Âå∫';
  }
  if (showSchoolDistricts) {
    renderSchoolDistricts();
  } else {
    if (schoolDistrictLayer && mapInstance) {
      mapInstance.removeLayer(schoolDistrictLayer);
      schoolDistrictLayer = null;
    }
    if (schoolMarkerLayer && mapInstance) {
      mapInstance.removeLayer(schoolMarkerLayer);
      schoolMarkerLayer = null;
    }
  }
}

async function renderSchoolDistricts() {
  if (!mapInstance) return;
  const data = await loadSchoolDistrictData();
  if (!data) return;

  // Remove existing layers
  if (schoolDistrictLayer) { mapInstance.removeLayer(schoolDistrictLayer); }
  if (schoolMarkerLayer) { mapInstance.removeLayer(schoolMarkerLayer); }

  // Separate polygons and points
  const polygonFeatures = { type: 'FeatureCollection', features: data.features.filter(f => f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon') };
  const pointFeatures = data.features.filter(f => f.geometry.type === 'Point' && f.properties.type === 'school');

  // Render polygon overlays (school district boundaries)
  let colorIdx = 0;
  schoolDistrictLayer = L.geoJSON(polygonFeatures, {
    style: (feature) => {
      const color = SCHOOL_DISTRICT_COLORS[colorIdx++ % SCHOOL_DISTRICT_COLORS.length];
      return { color, weight: 2, opacity: 0.7, fillColor: color, fillOpacity: 0.08, dashArray: '4 3' };
    },
    onEachFeature: (feature, layer) => {
      const p = feature.properties;
      layer.bindPopup(`
        <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
          <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">üè´ ${p.name}</div>
          <table style="font-size:11px;">
            <tr><td style="color:#6b7280;padding-right:8px;">Ë®≠ÁΩÆËÄÖ</td><td>${p.org}</td></tr>
            <tr><td style="color:#6b7280;padding-right:8px;">ÊâÄÂú®Âú∞</td><td>${p.address}</td></tr>
          </table>
        </div>
      `, { maxWidth: 240 });
      layer.on('mouseover', function() { this.setStyle({ fillOpacity: 0.25, weight: 3 }); });
      layer.on('mouseout', function() { this.setStyle({ fillOpacity: 0.08, weight: 2 }); });
    }
  }).addTo(mapInstance);
  schoolDistrictLayer.bringToBack();

  // Render school icon markers
  const schoolIcon = L.divIcon({
    html: '<div style="font-size:20px;text-align:center;line-height:1;filter:drop-shadow(1px 1px 1px rgba(0,0,0,0.3));">üè´</div>',
    className: 'school-icon-marker',
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -14]
  });

  schoolMarkerLayer = L.layerGroup();
  pointFeatures.forEach(f => {
    const p = f.properties;
    const coords = f.geometry.coordinates;
    const marker = L.marker([coords[1], coords[0]], { icon: schoolIcon, zIndexOffset: 500 });
    marker.bindPopup(`
      <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
        <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">üè´ ${p.name}</div>
        <table style="font-size:11px;">
          <tr><td style="color:#6b7280;padding-right:8px;">Ë®≠ÁΩÆËÄÖ</td><td>${p.org}</td></tr>
          <tr><td style="color:#6b7280;padding-right:8px;">ÊâÄÂú®Âú∞</td><td>${p.address}</td></tr>
        </table>
      </div>
    `, { maxWidth: 240 });
    schoolMarkerLayer.addLayer(marker);
  });
  schoolMarkerLayer.addTo(mapInstance);
}

function initializeMap(ranked) {
  const container = document.getElementById('map-container');
  if (!container || !window.L) return;

  // Destroy existing map if present (container re-created by render)
  if (mapInstance) {
    try { mapInstance.remove(); } catch {}
    mapInstance = null;
    mapMarkers = {};
    txMarkerLayer = null;
  }

  // Create map centered on northern Mie
  mapInstance = L.map('map-container', { zoomControl: true }).setView([34.98, 136.56], 10);

  // OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>',
    maxZoom: 18
  }).addTo(mapInstance);

  // Transaction marker layer
  txMarkerLayer = L.layerGroup().addTo(mapInstance);

  // Create city markers
  ranked.forEach((area, idx) => {
    const color = COLORS[AREAS.findIndex(a => a.id === area.id) % COLORS.length];
    const rank = idx + 1;
    const icon = createMapIcon(color, rank, area.scores.total, area.id === state.mapSelectedAreaId);

    const marker = L.marker([area.lat, area.lng], { icon, zIndexOffset: 1000 })
      .addTo(mapInstance);

    marker.bindTooltip(`${area.name} (${area.scores.total}pt)`, {
      direction: 'top', offset: [0, -20], className: 'map-tooltip'
    });

    marker.on('click', async () => {
      state.mapSelectedAreaId = area.id;
      state.mapSelectedDistrict = null; // Reset district selection
      ranked.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, a.id === area.id));
      });
      updateMapSidebar(area, ranked);
      // Geocode districts before showing pins
      await geocodeAreaDistricts(area);
      showTransactionPins(area);
      mapInstance.flyTo([area.lat, area.lng], 13, { duration: 0.8 });

      // Êú™ÂèñÂæó„Ç®„É™„Ç¢„Å™„ÇâÂÑ™ÂÖàÊåáÂÆöÔºàËá™ÂãïÂèñÂæó‰∏≠‚ÜíÊ¨°„Å´Âá¶ÁêÜ„ÄÅÂÅúÊ≠¢‰∏≠‚ÜíÁõ¥Êé•ÂèñÂæóÔºâ
      if (!AREA_FULL_LOADED.has(area.id)) {
        _fetchPriorityAreaId = area.id;
        if (!_autoFetchRunning && mcpReinfo && mcpReinfo.connected) {
          fetchAreaFullData(area.id);
        }
      }
    });

    mapMarkers[area.id] = marker;
  });

  // Show all transaction pins at overview
  showAllTransactionPins(ranked);

  // Restore layers if enabled
  if (showSchoolDistricts) {
    renderSchoolDistricts();
  }
  if (showDistrictAreas) {
    renderDistrictAreas();
  }

  // If area already selected, zoom to it and auto-fetch full data
  if (state.mapSelectedAreaId) {
    const sel = ranked.find(a => a.id === state.mapSelectedAreaId);
    if (sel) {
      showTransactionPins(sel);
      mapInstance.setView([sel.lat, sel.lng], 13);
      if (!AREA_FULL_LOADED.has(sel.id)) {
        _fetchPriorityAreaId = sel.id;
        if (!_autoFetchRunning && mcpReinfo && mcpReinfo.connected) {
          fetchAreaFullData(sel.id);
        }
      }
    }
  }
}

// ============================================================
// Station Coordinate Database (Northern Mie Prefecture)
// ============================================================
const STATION_COORDS = {
  // ÂõõÊó•Â∏ÇÂ∏Ç
  'ËøëÈâÑÂõõÊó•Â∏Ç':[34.9665,136.6142],'ÂõõÊó•Â∏Ç':[34.9667,136.6186],'ÂØåÁî∞':[34.989,136.6266],
  'ÂØåÊ¥≤Âéü':[34.997,136.631],'ÈòøÂÄâÂ∑ù':[34.976,136.6175],'Â∑ùÂéüÁî∫':[34.972,136.6153],
  'Êñ∞Ê≠£':[34.962,136.6154],'Ëµ§Â†Ä':[34.958,136.6156],'Êó•Ê∞∏':[34.944,136.6088],
  'ÂçóÊó•Ê∞∏':[34.952,136.612],'Ê≥ä':[34.938,136.611],'ËøΩÂàÜ':[34.934,136.605],
  'ÂÜÖÈÉ®':[34.928,136.5925],'Â∞èÂè§ÊõΩ':[34.936,136.599],'Ê≤≥ÂéüÁî∞':[34.912,136.5814],
  'Â°©Êµú':[34.938,136.6217],'Êµ∑Â±±ÈÅì':[34.956,136.6238],'Èúû„É∂Êµ¶':[34.957,136.6262],
  'Â§ßÁü¢Áü•':[34.997,136.628],'Âπ≥Ê¥•':[34.996,136.618],'ÊöÅÂ≠¶ÂúíÂâç':[34.993,136.608],
  'Â±±Âüé':[34.981,136.5936],'‰øù„ÄÖ':[34.991,136.582],'ÂåóÊ•†':[34.918,136.61],
  'Ê•†':[34.912,136.615],'ÂçóÂõõÊó•Â∏Ç':[34.947,136.62],'‰∏≠Â∑ùÂéü':[34.961,136.607],
  '‰ºäÂã¢ÊùæÊú¨':[34.969,136.601],'Ë•øÊó•Èáé':[34.95,136.597],'ËøëÈâÑÂØåÁî∞':[34.988,136.622],
  // Ê°ëÂêçÂ∏Ç
  'Ê°ëÂêç':[35.0614,136.6918],'Êí≠Á£®':[35.046,136.677],'ÁõäÁîü':[35.066,136.6785],
  'È¶¨ÈÅì':[35.06,136.686],'Ë•øÊ°ëÂêç':[35.062,136.686],'Âú®ËâØ':[35.073,136.676],
  'ÊòüÂ∑ù':[35.081,136.671],'‰∏ÉÂíå':[35.087,136.659],'Á©¥Â§™':[35.091,136.65],
  'Â§öÂ∫¶':[35.117,136.629],'Èï∑Â≥∂':[35.076,136.715],'ËìÆËä±ÂØ∫':[35.078,136.665],
  '‰∏ãÊ∑±Ë∞∑':[35.039,136.669],'‰ºäÂã¢ÊúùÊó•':[35.032,136.669],
  // Èà¥ÈπøÂ∏Ç
  'ÁôΩÂ≠ê':[34.843,136.611],'Èà¥Èπø':[34.871,136.543],'Èà¥ÈπøÂ∏Ç':[34.881,136.581],
  '‰∏âÊó•Â∏Ç':[34.874,136.577],'Âπ≥Áî∞Áî∫':[34.876,136.559],'Âä†‰ΩêÁôª':[34.886,136.523],
  'ÁéâÂû£':[34.855,136.601],'Êü≥':[34.848,136.599],'Á£ØÂ±±':[34.836,136.615],
  'ÂçÉ‰ª£Â¥é':[34.831,136.617],'ÁÆïÁî∞':[34.863,136.593],'Èºì„É∂Êµ¶':[34.838,136.613],
  'Âæ≥Áî∞':[34.884,136.559],'‰ºäÂã¢Ëã•Êùæ':[34.856,136.608],'ÂçÉÈáå':[34.887,136.506],
  '‰∏≠ÁÄ¨Âè§':[34.866,136.571],
  // „ÅÑ„Å™„ÅπÂ∏Ç
  '‰∏âÈáå':[35.093,136.554],'ÂåóÂã¢‰∏≠Â§ÆÂÖ¨ÂúíÂè£':[35.087,136.548],'È∫ªÁîüÁî∞':[35.099,136.548],
  'Èòø‰∏ãÂñú':[35.126,136.549],'Ê•öÂéü':[35.116,136.549],'Â§ßÊ≥â':[35.108,136.554],
  'Ê¢ÖÊà∏‰∫ï':[35.084,136.551],
  // ‰∫ÄÂ±±Â∏Ç
  '‰∫ÄÂ±±':[34.855,136.449],'Èñ¢':[34.855,136.397],'Âä†Â§™':[34.85,136.355],
  '‰∫ïÁî∞Â∑ù':[34.874,136.489],
  // Ëè∞ÈáéÁî∫
  'Ëè∞Èáé':[35.017,136.516],'‰∏≠Ëè∞Èáé':[35.024,136.509],'Â§ßÁæΩÊ†πÂúí':[35.029,136.502],
  'ÊπØ„ÅÆÂ±±Ê∏©Ê≥â':[35.036,136.486],'Ê°ú':[35.009,136.528],
  // Êù±Âì°Áî∫
  'Êù±Âì°':[35.06,136.595],'Â§ßÈï∑':[35.066,136.589],'ÂåóÂ§ßÁ§æ':[35.073,136.592],
};

// Station ‚Üí Nagoya commute time (minutes, approximate)
const STATION_TO_NAGOYA_MIN = {
  // ÂõõÊó•Â∏ÇÂ∏Ç
  'ËøëÈâÑÂõõÊó•Â∏Ç':35,'ÂõõÊó•Â∏Ç':50,'ÂØåÁî∞':38,'ÂØåÊ¥≤Âéü':40,'ÈòøÂÄâÂ∑ù':37,'Â∑ùÂéüÁî∫':36,
  'Êñ∞Ê≠£':36,'Ëµ§Â†Ä':37,'Êó•Ê∞∏':40,'ÂçóÊó•Ê∞∏':39,'Ê≥ä':42,'ËøΩÂàÜ':43,
  'ÂÜÖÈÉ®':45,'Â∞èÂè§ÊõΩ':44,'Ê≤≥ÂéüÁî∞':48,'Â°©Êµú':42,'Êµ∑Â±±ÈÅì':38,'Èúû„É∂Êµ¶':37,
  'Â§ßÁü¢Áü•':40,'Âπ≥Ê¥•':42,'ÊöÅÂ≠¶ÂúíÂâç':44,'Â±±Âüé':46,'‰øù„ÄÖ':48,'ÂåóÊ•†':48,
  'Ê•†':50,'ÂçóÂõõÊó•Â∏Ç':40,'‰∏≠Â∑ùÂéü':38,'‰ºäÂã¢ÊùæÊú¨':40,'Ë•øÊó•Èáé':42,'ËøëÈâÑÂØåÁî∞':37,
  // Ê°ëÂêçÂ∏Ç
  'Ê°ëÂêç':25,'Êí≠Á£®':30,'ÁõäÁîü':27,'È¶¨ÈÅì':26,'Ë•øÊ°ëÂêç':26,'Âú®ËâØ':28,
  'ÊòüÂ∑ù':30,'‰∏ÉÂíå':32,'Á©¥Â§™':34,'Â§öÂ∫¶':40,'Èï∑Â≥∂':22,'ËìÆËä±ÂØ∫':31,
  '‰∏ãÊ∑±Ë∞∑':32,'‰ºäÂã¢ÊúùÊó•':33,
  // Èà¥ÈπøÂ∏Ç
  'ÁôΩÂ≠ê':55,'Èà¥Èπø':65,'Èà¥ÈπøÂ∏Ç':60,'‰∏âÊó•Â∏Ç':62,'Âπ≥Áî∞Áî∫':63,'Âä†‰ΩêÁôª':68,
  'ÁéâÂû£':57,'Êü≥':58,'Á£ØÂ±±':56,'ÂçÉ‰ª£Â¥é':54,'ÁÆïÁî∞':59,'Èºì„É∂Êµ¶':55,
  'Âæ≥Áî∞':63,'‰ºäÂã¢Ëã•Êùæ':56,'ÂçÉÈáå':70,'‰∏≠ÁÄ¨Âè§':61,
  // „ÅÑ„Å™„ÅπÂ∏Ç
  '‰∏âÈáå':52,'ÂåóÂã¢‰∏≠Â§ÆÂÖ¨ÂúíÂè£':53,'È∫ªÁîüÁî∞':54,'Èòø‰∏ãÂñú':58,'Ê•öÂéü':56,'Â§ßÊ≥â':54,'Ê¢ÖÊà∏‰∫ï':51,
  // ‰∫ÄÂ±±Â∏Ç
  '‰∫ÄÂ±±':70,'Èñ¢':80,'Âä†Â§™':90,'‰∫ïÁî∞Â∑ù':65,
  // Ëè∞ÈáéÁî∫
  'Ëè∞Èáé':50,'‰∏≠Ëè∞Èáé':52,'Â§ßÁæΩÊ†πÂúí':54,'ÊπØ„ÅÆÂ±±Ê∏©Ê≥â':58,'Ê°ú':48,
  // Êù±Âì°Áî∫
  'Êù±Âì°':38,'Â§ßÈï∑':40,'ÂåóÂ§ßÁ§æ':42,
};

function findStationCoords(stationName) {
  if (!stationName) return null;
  if (STATION_COORDS[stationName]) return STATION_COORDS[stationName];
  const cleaned = stationName.replace(/ÈßÖ$/, '').replace(/\(.*\)/, '').trim();
  if (STATION_COORDS[cleaned]) return STATION_COORDS[cleaned];
  for (const [key, coords] of Object.entries(STATION_COORDS)) {
    if (cleaned.includes(key) || key.includes(cleaned)) return coords;
  }
  return null;
}

// ============================================================
// District Geocoding (Nominatim + localStorage cache)
// ============================================================
const DISTRICT_CACHE = new Map();
const DISTRICT_CACHE_KEY = 'mie-realestate-district-coords-v2';

// Load cached coords from localStorage on startup
function loadDistrictCache() {
  try {
    const stored = localStorage.getItem(DISTRICT_CACHE_KEY);
    if (!stored) return;
    const obj = JSON.parse(stored);
    for (const [k, v] of Object.entries(obj)) {
      DISTRICT_CACHE.set(k, v);
    }
    console.log(`District cache loaded: ${DISTRICT_CACHE.size} entries`);
  } catch(e) { console.warn('Cache load failed:', e); }
}

function saveDistrictCache() {
  try {
    const obj = {};
    for (const [k, v] of DISTRICT_CACHE.entries()) obj[k] = v;
    localStorage.setItem(DISTRICT_CACHE_KEY, JSON.stringify(obj));
  } catch(e) { console.warn('Cache save failed:', e); }
}

async function geocodeDistrict(district, cityName) {
  const cacheKey = `${cityName}-${district}`;
  if (DISTRICT_CACHE.has(cacheKey)) return DISTRICT_CACHE.get(cacheKey);

  // Try GSI (ÂõΩÂúüÂú∞ÁêÜÈô¢) API first, then Nominatim as fallback
  const queries = [
    `‰∏âÈáçÁúå${cityName}${district}`,
    `${cityName}${district}`,
  ];

  // GSI API (more reliable for Japanese addresses)
  for (const q of queries) {
    try {
      const url = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(q)}`;
      const resp = await fetch(url);
      if (!resp.ok) continue;
      const results = await resp.json();
      if (results.length > 0) {
        const coords_arr = results[0].geometry.coordinates; // [lng, lat]
        const lat = parseFloat(coords_arr[1]);
        const lng = parseFloat(coords_arr[0]);
        if (lat >= 34.2 && lat <= 35.5 && lng >= 135.8 && lng <= 137.0) {
          const coords = [lat, lng];
          DISTRICT_CACHE.set(cacheKey, coords);
          return coords;
        }
      }
    } catch(e) { /* skip */ }
  }

  // Nominatim fallback
  const nomQueries = [`${district}, ${cityName}, ‰∏âÈáçÁúå`, `${district}, ${cityName}`];
  for (const q of nomQueries) {
    try {
      const url = `https://nominatim.openstreetmap.org/search?` +
        `q=${encodeURIComponent(q)}&format=json&limit=1&countrycodes=jp`;
      const resp = await fetch(url, {
        headers: { 'User-Agent': 'MieRealEstateApp/1.0' }
      });
      if (!resp.ok) continue;
      const results = await resp.json();
      if (results.length > 0) {
        const lat = parseFloat(results[0].lat);
        const lng = parseFloat(results[0].lon);
        if (lat >= 34.2 && lat <= 35.5 && lng >= 135.8 && lng <= 137.0) {
          const coords = [lat, lng];
          DISTRICT_CACHE.set(cacheKey, coords);
          return coords;
        }
      }
    } catch(e) { /* skip */ }
  }

  // Mark as not found so we don't retry
  DISTRICT_CACHE.set(cacheKey, null);
  return null;
}

// Background geocoding - doesn't block UI
async function geocodeDistrictsBackground() {
  // Collect uncached district+city pairs
  const uncached = [];
  for (const area of AREAS) {
    if (!area._liveTransactions) continue;
    for (const tx of area._liveTransactions) {
      if (!tx.District) continue;
      const key = `${area.name}-${tx.District}`;
      if (!DISTRICT_CACHE.has(key) && !uncached.find(u => u.key === key)) {
        uncached.push({ key, district: tx.District, cityName: area.name });
      }
    }
  }

  if (uncached.length === 0) return;

  const total = uncached.length;
  let done = 0;

  for (const { district, cityName } of uncached) {
    done++;
    updateStatusText(`Âú∞Âå∫„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠... (${done}/${total})`);
    await geocodeDistrict(district, cityName);
    // Save every 5 results
    if (done % 5 === 0) saveDistrictCache();
    // Rate limit: 300ms between requests (GSI API is less restrictive than Nominatim)
    if (done < total) await new Promise(r => setTimeout(r, 300));
  }

  saveDistrictCache();

  // Refresh map pins with newly geocoded positions
  updateStatusText(`‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂÆå‰∫Ü (${done}‰ª∂) ‚Äî „Éî„É≥„ÇíÊõ¥Êñ∞‰∏≠...`);
  if (state.view === 'map' && txMarkerLayer) {
    const ranked = getRankedAreas();
    if (state.mapSelectedAreaId) {
      const sel = ranked.find(a => a.id === state.mapSelectedAreaId);
      if (sel) showTransactionPins(sel);
    } else {
      showAllTransactionPins(ranked);
    }
  }

  const cached = Array.from(DISTRICT_CACHE.values()).filter(v => v !== null).length;
  updateStatusText(`„É©„Ç§„Éñ„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü ‚Äî Âú∞Âå∫‰ΩçÁΩÆ: ${cached}‰ª∂Ëß£Ê±∫Ê∏à„Åø`);
}

function findDistrictCoords(district, cityName) {
  if (!district || !cityName) return null;
  const key = `${cityName}-${district}`;
  return DISTRICT_CACHE.get(key) || null;
}

// Aggregate metrics for a single district within an area
function aggregateDistrictMetrics(area, districtName) {
  if (!area._liveTransactions || !districtName) return null;
  // Preserve original index in _liveTransactions for map pin reference
  const txs = area._liveTransactions
    .map((t, i) => ({ ...t, _areaIdx: i }))
    .filter(t => t.District === districtName);
  if (txs.length === 0) return null;

  // Prices
  const prices = txs.filter(t => t.TradePrice != null && !isNaN(t.TradePrice)).map(t => t.TradePrice);
  const avgPrice = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : null;
  const minPrice = prices.length > 0 ? Math.min(...prices) : null;
  const maxPrice = prices.length > 0 ? Math.max(...prices) : null;

  // Price per m¬≤
  const pricePerM2 = txs
    .filter(t => t.TradePrice != null && !isNaN(t.TradePrice) && t.Area && t.Area > 0)
    .map(t => t.TradePrice / t.Area);
  const avgPricePerM2 = pricePerM2.length > 0 ? pricePerM2.reduce((a, b) => a + b, 0) / pricePerM2.length : null;

  // Most frequent station
  const stationCounts = {};
  txs.forEach(t => {
    if (t.NearestStation) {
      const s = t.NearestStation.replace(/\(.*\)/, '').trim();
      stationCounts[s] = (stationCounts[s] || 0) + 1;
    }
  });
  const topStation = Object.entries(stationCounts).sort((a, b) => b[1] - a[1])[0];
  const nearestStation = topStation ? topStation[0] : null;

  // Nagoya commute time
  let nagoyaMin = null;
  if (nearestStation) {
    const cleaned = nearestStation.replace(/ÈßÖ$/, '').trim();
    nagoyaMin = STATION_TO_NAGOYA_MIN[cleaned] || STATION_TO_NAGOYA_MIN[nearestStation] || null;
    if (!nagoyaMin) {
      for (const [key, min] of Object.entries(STATION_TO_NAGOYA_MIN)) {
        if (cleaned.includes(key) || key.includes(cleaned)) { nagoyaMin = min; break; }
      }
    }
  }
  if (!nagoyaMin) nagoyaMin = area.accessToNagoya; // fallback to city level

  // Distance to station (average)
  const distances = txs.filter(t => t.DistanceToStation).map(t => {
    const m = String(t.DistanceToStation).match(/(\d+)/);
    return m ? parseInt(m[1]) : null;
  }).filter(Boolean);
  const avgDistance = distances.length > 0 ? Math.round(distances.reduce((a, b) => a + b, 0) / distances.length) : null;

  // Property type distribution
  const typeCounts = {};
  txs.forEach(t => {
    const type = t.Type || t.Use || '„Åù„ÅÆ‰ªñ';
    typeCounts[type] = (typeCounts[type] || 0) + 1;
  });
  const typeDistribution = Object.entries(typeCounts)
    .map(([name, count]) => ({ name, count, pct: Math.round(count / txs.length * 100) }))
    .sort((a, b) => b.count - a.count);

  // Average building age
  const currentYear = new Date().getFullYear();
  const ages = txs.filter(t => t.BuildingYear).map(t => {
    const yr = String(t.BuildingYear);
    // Handle "‰ª§ÂíåXÂπ¥", "Âπ≥ÊàêXÂπ¥", "Êò≠ÂíåXÂπ¥" or just year number
    let builtYear = parseInt(yr);
    if (yr.includes('‰ª§Âíå')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 2018 + n; }
    else if (yr.includes('Âπ≥Êàê')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 1988 + n; }
    else if (yr.includes('Êò≠Âíå')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 1925 + n; }
    if (builtYear > 1900 && builtYear <= currentYear) return currentYear - builtYear;
    return null;
  }).filter(Boolean);
  const avgBuildingAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : null;

  // District coordinates
  const coords = findDistrictCoords(districtName, area.name);

  return {
    districtName, cityName: area.name, cityId: area.id,
    count: txs.length, transactions: txs,
    avgPrice, minPrice, maxPrice,
    avgPricePerM2,
    nearestStation, nagoyaMin, avgDistance,
    typeDistribution, avgBuildingAge, coords
  };
}

// Geocode all districts for a single area BEFORE showing pins
async function geocodeAreaDistricts(area, options = {}) {
  if (!area._liveTransactions) return;
  const uncached = [];
  for (const tx of area._liveTransactions) {
    if (!tx.District) continue;
    const key = `${area.name}-${tx.District}`;
    if (!DISTRICT_CACHE.has(key) && !uncached.find(u => u.key === key)) {
      uncached.push({ key, district: tx.District, cityName: area.name });
    }
  }
  if (uncached.length === 0) return;

  const showOverlay = options.showOverlay !== undefined ? options.showOverlay : true;
  const total = uncached.length;
  let done = 0;
  if (showOverlay) showMapLoading(`${area.name} Âú∞Âå∫ÊÉÖÂ†±ÂèñÂæó‰∏≠...`, 0);
  for (const { district, cityName } of uncached) {
    done++;
    if (showOverlay) updateMapLoading(`${area.name} Âú∞Âå∫ÊÉÖÂ†±ÂèñÂæó‰∏≠... (${done}/${total})`, (done / total) * 100);
    await geocodeDistrict(district, cityName);
    if (done % 5 === 0) saveDistrictCache();
    if (done < total) await new Promise(r => setTimeout(r, 200));
  }
  saveDistrictCache();
  if (showOverlay) hideMapLoading();
}

function hashStr(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) {
    h = ((h << 5) - h + s.charCodeAt(i)) | 0;
  }
  return Math.abs(h);
}

function estimateTxPosition(area, tx, idx) {
  // Priority 1: District geocoded coords (most accurate for this data)
  const districtCoords = findDistrictCoords(tx.District, area.name);
  if (districtCoords) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.001 + (idx % 7) * 0.0005;
    return {
      lat: districtCoords[0] + Math.cos(jitterAngle) * jitter,
      lng: districtCoords[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 2: Station coordinates (from NearestStation field)
  const stationCoords = findStationCoords(tx.NearestStation);
  if (stationCoords) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.0008 + (idx % 5) * 0.0004;
    return {
      lat: stationCoords[0] + Math.cos(jitterAngle) * jitter,
      lng: stationCoords[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 3: District name ‚Üí fuzzy match against station names
  const stationFromDistrict = findStationCoords(tx.District);
  if (stationFromDistrict) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.0015 + (idx % 7) * 0.0005;
    return {
      lat: stationFromDistrict[0] + Math.cos(jitterAngle) * jitter,
      lng: stationFromDistrict[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 4: Fallback - bias inland from city center
  const districtKey = tx.District || tx.NearestStation || `tx-${idx}`;
  const hash = hashStr(districtKey + area.id);
  const baseAngle = 150 + (hash % 200);
  const angle = baseAngle * (Math.PI / 180);
  const spread = 0.004 + (hash % 40) / 40 * 0.012;
  const baseLat = area.lat + Math.cos(angle) * spread;
  const baseLng = area.lng + Math.sin(angle) * spread;

  const jitterAngle = (idx * 137.508) * (Math.PI / 180);
  const jitter = 0.0008 + (idx % 5) * 0.0004;

  return {
    lat: baseLat + Math.cos(jitterAngle) * jitter,
    lng: baseLng + Math.sin(jitterAngle) * jitter
  };
}

// Get color based on price (green=cheap, yellow=mid, red=expensive)
function priceColor(price) {
  if (!price || isNaN(price)) return '#9ca3af';
  if (price < 5000000) return '#22c55e';    // green: <500‰∏á
  if (price < 15000000) return '#3b82f6';   // blue: 500-1500‰∏á
  if (price < 30000000) return '#f59e0b';   // amber: 1500-3000‰∏á
  if (price < 50000000) return '#ef4444';   // red: 3000-5000‰∏á
  return '#7c3aed';                          // purple: >5000‰∏á
}

async function showAllTransactionPins(ranked) {
  if (!txMarkerLayer) return;
  txMarkerLayer.clearLayers();

  // Geocode districts for all areas with transactions
  for (const area of ranked) {
    if (area._liveTransactions && area._liveTransactions.length > 0) {
      await geocodeAreaDistricts(area, { showOverlay: false });
    }
  }

  let totalPins = 0;
  ranked.forEach(area => {
    if (!area._liveTransactions) return;
    const color = COLORS[AREAS.findIndex(a => a.id === area.id) % COLORS.length];
    area._liveTransactions.forEach((tx, i) => {
      const pos = estimateTxPosition(area, tx, i);
      const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
      totalPins++;
      const cm = L.circleMarker([pos.lat, pos.lng], {
        radius: 5,
        fillColor: hasPrice ? priceColor(tx.TradePrice) : '#9ca3af',
        color: '#fff',
        weight: 1,
        opacity: 0.8,
        fillOpacity: 0.6
      });
      cm.bindPopup(buildTxPopup(tx, area.name), { maxWidth: 220 });
      txMarkerLayer.addLayer(cm);
    });
  });
  console.log(`[PIN] showAllTransactionPins: ${totalPins} total pins created`);
}

// Map loading overlay controls
function showMapLoading(areaName, pct) {
  const overlay = document.getElementById('map-loading-overlay');
  if (!overlay) return;
  overlay.classList.remove('hidden');
  updateMapLoading(areaName, pct);
}

function updateMapLoading(label, pct) {
  const textEl = document.getElementById('map-loading-text');
  const barEl = document.getElementById('map-loading-bar');
  if (textEl) textEl.textContent = label;
  if (barEl) barEl.style.width = pct + '%';
}

function hideMapLoading() {
  const overlay = document.getElementById('map-loading-overlay');
  if (overlay) overlay.classList.add('hidden');
}

// Transaction pin index for sidebar click ‚Üí map navigation
let txMarkersByIdx = {};

function showTransactionPins(area) {
  if (!txMarkerLayer) return;
  txMarkerLayer.clearLayers();
  txMarkersByIdx = {};

  if (!area._liveTransactions) return;

  let pinCount = 0;
  area._liveTransactions.forEach((tx, i) => {
    const pos = estimateTxPosition(area, tx, i);
    const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
    const cm = L.circleMarker([pos.lat, pos.lng], {
      radius: 7,
      fillColor: hasPrice ? priceColor(tx.TradePrice) : '#9ca3af',
      color: '#fff',
      weight: 1.5,
      opacity: 0.9,
      fillOpacity: hasPrice ? 0.7 : 0.4
    });
    cm.bindPopup(buildTxPopup(tx, area.name), { maxWidth: 240 });
    txMarkerLayer.addLayer(cm);
    txMarkersByIdx[i] = { marker: cm, pos };
    pinCount++;
  });
  console.log(`[PIN] showTransactionPins: ${area.name} ‚Äî ${pinCount} pins created from ${area._liveTransactions.length} transactions`);
}

// Navigate map to a specific transaction pin and open popup
function flyToTransaction(idx) {
  const entry = txMarkersByIdx[idx];
  if (!entry || !mapInstance) return;
  mapInstance.flyTo([entry.pos.lat, entry.pos.lng], 16, { duration: 0.6 });
  setTimeout(() => {
    entry.marker.setRadius(12);
    entry.marker.openPopup();
    setTimeout(() => entry.marker.setRadius(7), 2000);
  }, 650);
}

function buildTxPopup(tx, cityName) {
  const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
  const priceStr = hasPrice
    ? (tx.TradePrice >= 10000 ? `${(tx.TradePrice/10000).toFixed(0)}‰∏áÂÜÜ` : `${tx.TradePrice.toLocaleString()}ÂÜÜ`)
    : '‰æ°Ê†º‰∏çÊòé';
  return `
    <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
      <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">${priceStr}</div>
      <table style="font-size:11px;">
        ${tx.District ? `<tr><td style="color:#6b7280;padding-right:8px;">Âú∞Âå∫</td><td>${tx.District}</td></tr>` : ''}
        ${tx.Area ? `<tr><td style="color:#6b7280;padding-right:8px;">Èù¢Á©ç</td><td>${tx.Area}m¬≤</td></tr>` : ''}
        ${tx.Type || tx.Use ? `<tr><td style="color:#6b7280;padding-right:8px;">Á®ÆÂà•</td><td>${tx.Type || tx.Use}</td></tr>` : ''}
        ${tx.NearestStation ? `<tr><td style="color:#6b7280;padding-right:8px;">ÊúÄÂØÑÈßÖ</td><td>${tx.NearestStation}${tx.DistanceToStation ? ` (${tx.DistanceToStation})` : ''}</td></tr>` : ''}
        ${tx.BuildingYear ? `<tr><td style="color:#6b7280;padding-right:8px;">ÁØâÂπ¥</td><td>${tx.BuildingYear}</td></tr>` : ''}
        ${tx.Structure ? `<tr><td style="color:#6b7280;padding-right:8px;">ÊßãÈÄ†</td><td>${tx.Structure}</td></tr>` : ''}
      </table>
      <div style="font-size:10px;color:#9ca3af;margin-top:4px;">${cityName}</div>
    </div>`;
}

function createMapIcon(color, rank, score, isSelected) {
  const size = isSelected ? 48 : 40;
  const borderWidth = isSelected ? 3 : 2;
  const shadow = isSelected ? 'filter: drop-shadow(0 2px 6px rgba(0,0,0,0.3));' : 'filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));';
  const svgString = `
    <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg" style="${shadow}">
      <circle cx="${size/2}" cy="${size/2}" r="${size/2-2}" fill="${color}" opacity="0.9" stroke="white" stroke-width="${borderWidth}"/>
      <text x="${size/2}" y="${size/2-2}" text-anchor="middle" fill="white" font-size="${isSelected ? 11 : 10}" font-weight="500" font-family="sans-serif">${rank}‰Ωç</text>
      <text x="${size/2}" y="${size/2+10}" text-anchor="middle" fill="white" font-size="${isSelected ? 13 : 11}" font-weight="700" font-family="sans-serif">${score}</text>
    </svg>`;
  return L.icon({
    iconUrl: 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString))),
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2],
    tooltipAnchor: [0, -size/2]
  });
}

function updateMapSidebar(area, ranked) {
  const sidebar = document.getElementById('map-sidebar');
  if (!sidebar) return;

  const rank = ranked.findIndex(a => a.id === area.id) + 1;
  const medals = ['ü•á','ü•à','ü•â'];
  const medalStr = rank <= 3 ? medals[rank-1] : `${rank}‰Ωç`;

  const isFullLoaded = AREA_FULL_LOADED.has(area.id);
  const isFetching = _currentFetchAreaId === area.id;
  const txCount = area._liveTransactions ? area._liveTransactions.length : 0;

  const loadingBadge = isFetching
    ? '<span class="inline-flex items-center gap-1 text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full mb-2"><span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>Ë©≥Á¥∞„Éá„Éº„ÇøÂèñÂæó‰∏≠...</span>'
    : isFullLoaded
      ? `<span class="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded-full mb-2">‚úÖ ÂÖ®ÊúüÈñì„Éá„Éº„ÇøÂèñÂæóÊ∏à„ÅøÔºà${txCount}‰ª∂Ôºâ</span>`
      : `<span class="text-xs text-gray-400 mb-2">Ê¶ÇË¶Å„Éá„Éº„Çø„ÅÆ„ÅøÔºà${txCount}‰ª∂Ôºâ</span>`;

  const txSection = txCount > 0
    ? renderTransactionList(area._liveTransactions)
    : (state.mcpStatus === 'connected'
      ? '<p class="text-xs text-gray-400 mt-2">ÂèñÂºï„Éá„Éº„Çø„Å™„Åó</p>'
      : '<p class="text-xs text-gray-400 mt-2">MCP„Å´Êé•Á∂ö„Åô„Çã„Å®ÂèñÂºï„Éá„Éº„Çø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>');

  sidebar.innerHTML = `
    <div class="sidebar-header">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-xl">${medalStr}</span>
          <h3 class="text-lg font-bold text-gray-900">${area.name}</h3>
        </div>
        <span class="text-2xl font-bold text-blue-600">${area.scores.total}<span class="text-xs font-normal text-gray-400">pt</span></span>
      </div>
    </div>
    <div class="sidebar-body space-y-4">
      ${loadingBadge}
      <!-- Key metrics -->
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-blue-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">‰ΩèÂÆÖÂú∞‰æ°Ê†º</div>
          <div class="text-sm font-bold text-blue-700">${(area.residentialPrice/10000).toFixed(1)}‰∏á/m¬≤</div>
        </div>
        <div class="bg-green-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">ÂêçÂè§Â±ã„Åæ„Åß</div>
          <div class="text-sm font-bold text-green-700">${area.accessToNagoya}ÂàÜ</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">Âú∞‰æ°Â§âÂãï</div>
          <div class="text-sm font-bold text-amber-700">+${area.yoyChange}%</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">‰∫∫Âè£</div>
          <div class="text-sm font-bold text-purple-700">${(area.population/10000).toFixed(1)}‰∏á‰∫∫</div>
        </div>
      </div>

      <!-- Live average price -->
      ${area._liveAvgTradePrice ? `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center gap-2 mb-1">
            <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
            <span class="text-xs font-medium text-blue-700">LIVE Âπ≥ÂùáÂèñÂºï‰æ°Ê†º</span>
          </div>
          <div class="text-lg font-bold text-blue-800">${(area._liveAvgTradePrice / 10000).toFixed(0)}‰∏áÂÜÜ</div>
          <div class="text-xs text-blue-500">${area._liveTransactionCount}‰ª∂„ÅÆÂèñÂºï„Éá„Éº„Çø„Åã„ÇâÁÆóÂá∫</div>
        </div>
      ` : ''}

      <!-- Description -->
      <div>
        <p class="text-xs text-gray-600 leading-relaxed">${area.description}</p>
      </div>

      <!-- Highlights -->
      <div class="bg-green-50 rounded-lg p-3">
        <div class="text-xs font-bold text-green-700 mb-2">‚úÖ „Éù„Ç§„É≥„Éà</div>
        ${area.highlights.map(h => `<div class="text-xs text-green-800 mb-1">‚Ä¢ ${h}</div>`).join('')}
      </div>

      <!-- Transaction data -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs font-bold text-gray-700">üìä ÂèñÂºï„Éá„Éº„Çø</div>
          <div class="text-xs text-gray-400">${area._liveTransactions ? area._liveTransactions.length + '‰ª∂' : ''}</div>
        </div>
        ${txSection}
        ${area._liveTransactions && area._liveTransactions.length > 0 ? `
          <div class="mt-2 flex flex-wrap gap-1 items-center">
            <span class="text-xs text-gray-400">Âá°‰æã:</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#22c55e;display:inline-block;"></span>~500‰∏á</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#3b82f6;display:inline-block;"></span>~1500‰∏á</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#f59e0b;display:inline-block;"></span>~3000‰∏á</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;"></span>~5000‰∏á</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#7c3aed;display:inline-block;"></span>5000‰∏á~</span>
          </div>
        ` : ''}
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2">
        <button data-map-to-detail="${area.id}" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors text-center">
          üîç Ë©≥Á¥∞„ÇíË¶ã„Çã
        </button>
        <button data-map-zoom-out class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors">
          üó∫Ô∏è ÂÖ®‰ΩìË°®Á§∫
        </button>
      </div>
    </div>
  `;

  // Bind sidebar buttons
  const detailBtn = sidebar.querySelector('[data-map-to-detail]');
  if (detailBtn) {
    detailBtn.addEventListener('click', () => {
      state.selectedAreaId = area.id;
      state.view = 'detail';
      render();
    });
  }

  const zoomOutBtn = sidebar.querySelector('[data-map-zoom-out]');
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = null;
      if (mapInstance) mapInstance.flyTo([34.98, 136.56], 10, { duration: 0.8 });
      // Reset marker icons
      const ranked2 = getRankedAreas();
      ranked2.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        if (mapMarkers[a.id]) mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, false));
      });
      // Show all transaction pins again
      showAllTransactionPins(ranked2);
      // Reset sidebar
      sidebar.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full text-center p-8">
          <div class="text-4xl mb-3">üìç</div>
          <p class="text-sm font-medium text-gray-700 mb-1">„Ç®„É™„Ç¢„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
          <p class="text-xs text-gray-400">„Éû„ÉÉ„Éó‰∏ä„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®<br>ÂúüÂú∞ÊÉÖÂ†±„ÉªÂèñÂºï„Éá„Éº„Çø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
        </div>`;
    });
  }

  // Bind transaction row clicks ‚Üí fly to map pin
  sidebar.querySelectorAll('tr[data-tx-idx]').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.txIdx);
      // Highlight active row
      sidebar.querySelectorAll('tr.tx-active').forEach(r => r.classList.remove('tx-active'));
      row.classList.add('tx-active');
      // Fly to pin
      flyToTransaction(idx);
    });
  });
}

function updateDistrictSidebar(area, districtName, ranked) {
  const sidebar = document.getElementById('map-sidebar');
  if (!sidebar) return;

  const metrics = aggregateDistrictMetrics(area, districtName);
  if (!metrics) {
    sidebar.innerHTML = `<div class="p-4 text-sm text-gray-500">Âú∞Âå∫„Éá„Éº„Çø„Å™„Åó</div>`;
    return;
  }

  const avgPriceStr = metrics.avgPrice ? `${(metrics.avgPrice / 10000).toFixed(0)}‰∏áÂÜÜ` : '-';
  const priceRange = (metrics.minPrice && metrics.maxPrice)
    ? `${(metrics.minPrice / 10000).toFixed(0)}„Äú${(metrics.maxPrice / 10000).toFixed(0)}‰∏áÂÜÜ`
    : '-';
  const m2PriceStr = metrics.avgPricePerM2 ? `${(metrics.avgPricePerM2 / 10000).toFixed(1)}‰∏á/m¬≤` : '-';
  const stationStr = metrics.nearestStation || '-';
  const nagoyaStr = metrics.nagoyaMin ? `Á¥Ñ${metrics.nagoyaMin}ÂàÜ` : `Á¥Ñ${area.accessToNagoya}ÂàÜ`;
  const distStr = metrics.avgDistance ? `ÂæíÊ≠©${metrics.avgDistance}ÂàÜ` : '-';
  const ageStr = metrics.avgBuildingAge !== null ? `ÁØâ${metrics.avgBuildingAge}Âπ¥` : '-';

  // Type distribution bar
  const typeColors = { 'ÂÆÖÂú∞(ÂúüÂú∞)': '#22c55e', 'ÂÆÖÂú∞(ÂúüÂú∞„Å®Âª∫Áâ©)': '#3b82f6', '‰∏≠Âè§„Éû„É≥„Ç∑„Éß„É≥Á≠â': '#f59e0b', 'Ëæ≤Âú∞': '#84cc16', 'ÊûóÂú∞': '#14b8a6' };
  const typeBar = metrics.typeDistribution.map(t => {
    const color = typeColors[t.name] || '#9ca3af';
    return `<div style="width:${t.pct}%;background:${color};height:100%;display:inline-block;" title="${t.name} ${t.pct}%"></div>`;
  }).join('');
  const typeLegend = metrics.typeDistribution.slice(0, 4).map(t => {
    const color = typeColors[t.name] || '#9ca3af';
    return `<span class="inline-flex items-center gap-1 text-xs"><span style="width:6px;height:6px;border-radius:50%;background:${color};display:inline-block;"></span>${t.name.replace('ÂÆÖÂú∞(','').replace(')','').replace('‰∏≠Âè§„Éû„É≥„Ç∑„Éß„É≥Á≠â','„Éû„É≥„Ç∑„Éß„É≥')} ${t.pct}%</span>`;
  }).join(' ');

  // Transaction list filtered to this district
  const districtTxs = metrics.transactions;
  const txSection = renderTransactionList(districtTxs);

  sidebar.innerHTML = `
    <div class="sidebar-header">
      <button id="btn-back-to-city" class="flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800 mb-2 cursor-pointer" style="background:none;border:none;padding:0;">
        ‚Üê ${area.name}„Å´Êàª„Çã
      </button>
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-900">üìç ${districtName}</h3>
        <span class="text-sm font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">${metrics.count}‰ª∂</span>
      </div>
    </div>
    <div class="sidebar-body space-y-4">
      <!-- Key metrics -->
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-blue-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">Âπ≥ÂùáÂèñÂºï‰æ°Ê†º</div>
          <div class="text-sm font-bold text-blue-700">${avgPriceStr}</div>
        </div>
        <div class="bg-indigo-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">„é°Âçò‰æ°</div>
          <div class="text-sm font-bold text-indigo-700">${m2PriceStr}</div>
        </div>
        <div class="bg-green-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">ÊúÄÂØÑÈßÖ</div>
          <div class="text-sm font-bold text-green-700" style="font-size:11px;">${stationStr}</div>
        </div>
        <div class="bg-emerald-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">ÂêçÂè§Â±ã„Åæ„Åß</div>
          <div class="text-sm font-bold text-emerald-700">${nagoyaStr}</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">ÈßÖË∑ùÈõ¢</div>
          <div class="text-sm font-bold text-amber-700">${distStr}</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">Âπ≥ÂùáÁØâÂπ¥Êï∞</div>
          <div class="text-sm font-bold text-purple-700">${ageStr}</div>
        </div>
      </div>

      <!-- Price range -->
      <div class="bg-gray-50 rounded-lg p-2">
        <div class="text-xs text-gray-500 mb-1">‰æ°Ê†ºÂ∏Ø</div>
        <div class="text-sm font-medium text-gray-700">${priceRange}</div>
      </div>

      <!-- Type distribution -->
      ${metrics.typeDistribution.length > 0 ? `
        <div>
          <div class="text-xs text-gray-500 mb-1">Áî®ÈÄîÂàÜÂ∏É</div>
          <div style="height:8px;border-radius:4px;overflow:hidden;background:#e5e7eb;display:flex;">${typeBar}</div>
          <div class="mt-1 flex flex-wrap gap-2">${typeLegend}</div>
        </div>
      ` : ''}

      <!-- Transaction data -->
      <div>
        <div class="text-xs font-bold text-gray-700 mb-2">üìä ÂèñÂºï„Éá„Éº„ÇøÔºà${districtName}Ôºâ</div>
        ${txSection || '<p class="text-xs text-gray-400">ÂèñÂºï„Éá„Éº„Çø„Å™„Åó</p>'}
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2">
        <button id="btn-district-back" class="flex-1 px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors text-center">
          ‚Ü© ${area.name}„Å∏Êàª„Çã
        </button>
        <button data-map-zoom-out class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors">
          üó∫Ô∏è ÂÖ®‰ΩìË°®Á§∫
        </button>
      </div>
    </div>
  `;

  // Bind back button
  const backBtn = sidebar.querySelector('#btn-back-to-city');
  const backBtn2 = sidebar.querySelector('#btn-district-back');
  const goBack = () => {
    state.mapSelectedDistrict = null;
    updateMapSidebar(area, ranked);
    showTransactionPins(area);
  };
  if (backBtn) backBtn.addEventListener('click', goBack);
  if (backBtn2) backBtn2.addEventListener('click', goBack);

  // Bind zoom out
  const zoomOutBtn = sidebar.querySelector('[data-map-zoom-out]');
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = null;
      state.mapSelectedDistrict = null;
      if (mapInstance) mapInstance.flyTo([34.98, 136.56], 10, { duration: 0.8 });
      const ranked2 = getRankedAreas();
      ranked2.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        if (mapMarkers[a.id]) mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, false));
      });
      showAllTransactionPins(ranked2);
      sidebar.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full text-center p-8">
          <div class="text-4xl mb-3">üìç</div>
          <p class="text-sm font-medium text-gray-700 mb-1">„Ç®„É™„Ç¢„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
          <p class="text-xs text-gray-400">„Éû„ÉÉ„Éó‰∏ä„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®<br>ÂúüÂú∞ÊÉÖÂ†±„ÉªÂèñÂºï„Éá„Éº„Çø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
        </div>`;
    });
  }

  // Bind transaction row clicks
  sidebar.querySelectorAll('tr[data-tx-idx]').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.txIdx);
      sidebar.querySelectorAll('tr.tx-active').forEach(r => r.classList.remove('tx-active'));
      row.classList.add('tx-active');
      flyToTransaction(idx);
    });
  });
}

function renderTransactionList(transactions) {
  if (!transactions || transactions.length === 0) return '';

  // Keep original index for map pin reference
  // Use _areaIdx if present (from district filtering), otherwise use array index
  const indexed = transactions.map((t, i) => ({
    ...t,
    _origIdx: (t._areaIdx !== undefined) ? t._areaIdx : i
  }));
  // Show all transactions (including those without price)
  const validTx = [...indexed];
  if (validTx.length === 0) return '<p class="text-xs text-gray-400">ÂèñÂºï„Éá„Éº„Çø„Å™„Åó</p>';

  // Sort by price descending (null prices at end)
  validTx.sort((a, b) => {
    const pa = (a.TradePrice != null && !isNaN(a.TradePrice)) ? a.TradePrice : -1;
    const pb = (b.TradePrice != null && !isNaN(b.TradePrice)) ? b.TradePrice : -1;
    return pb - pa;
  });

  return `
    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
      <table class="tx-table">
        <thead>
          <tr>
            <th>‰æ°Ê†º</th>
            <th>Èù¢Á©ç</th>
            <th>Âú∞Âå∫</th>
            <th>ÊúÄÂØÑÈßÖ</th>
          </tr>
        </thead>
        <tbody>
          ${validTx.map(t => {
            const hasP = t.TradePrice != null && !isNaN(t.TradePrice);
            const pStr = hasP ? (t.TradePrice >= 10000 ? (t.TradePrice/10000).toFixed(0) + '‰∏á' : t.TradePrice.toLocaleString() + 'ÂÜÜ') : '-';
            return `
            <tr data-tx-idx="${t._origIdx}" title="„ÇØ„É™„ÉÉ„ÇØ„ÅßÂú∞Âõ≥‰∏ä„ÅÆ„Éî„É≥„Å∏ÁßªÂãï">
              <td class="font-medium" style="color:${hasP ? priceColor(t.TradePrice) : '#9ca3af'}">${pStr}</td>
              <td>${t.Area ? t.Area + 'm¬≤' : '-'}</td>
              <td class="text-gray-500" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.District || '-'}</td>
              <td class="text-gray-500" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.NearestStation || '-'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function renderFooter() {
  return `
    <footer class="mt-8 py-6 border-t border-gray-200">
      <div class="text-center space-y-2">
        <p class="text-xs text-gray-400">
          „Éá„Éº„ÇøÂá∫ÂÖ∏: ÂõΩÂúü‰∫§ÈÄöÁúÅ ‰∏çÂãïÁî£ÊÉÖÂ†±„É©„Ç§„Éñ„É©„É™API / Á∑èÂãôÁúÅ e-Stat APIÔºà2025Âπ¥ÂÖ¨Á§∫Âú∞‰æ°„Éô„Éº„ÇπÔºâ
        </p>
        <p class="text-xs text-gray-400">
          MCPÊé•Á∂öÂÖà: <code class="bg-gray-100 px-1 rounded">mcp.n-3.ai</code> (reinfolib-real-estate-price, reinfolib-city-list)
        </p>
        <p class="text-xs text-gray-400">
          ‚Äª Êú¨„ÉÑ„Éº„É´„ÅØÂèÇËÄÉÊÉÖÂ†±„Åß„ÅÇ„Çä„ÄÅ‰∏çÂãïÁî£Ë≥ºÂÖ•„ÅÆÊúÄÁµÇÂà§Êñ≠„ÅØÂ∞ÇÈñÄÂÆ∂„Å´„ÅîÁõ∏Ë´á„Åè„Å†„Åï„ÅÑ
        </p>
        <p class="text-xs text-gray-300 mt-3">¬© Â§¢„ÅÆ„Åô„Åø„Åã ‚Äî Powered by MCP + Ë°åÊîø„Ç™„Éº„Éó„É≥„Éá„Éº„Çø</p>
      </div>
    </footer>
  `;
}

// ============================================================
// Chart Drawing (Chart.js)
// ============================================================
function destroyCharts() {
  Object.values(state.charts).forEach(c => { try { c.destroy(); } catch {} });
  state.charts = {};
}

function drawCompareCharts(ranked) {
  destroyCharts();

  // Bar chart: price vs score
  const barCtx = document.getElementById('chart-bar');
  if (barCtx) {
    state.charts.bar = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: ranked.map(a => a.name),
        datasets: [
          {
            label: '‰ΩèÂÆÖÂú∞‰æ°Ê†º (ÂÜÜ/m¬≤)',
            data: ranked.map(a => a.residentialPrice),
            backgroundColor: ranked.map((_,i) => COLORS[i % COLORS.length] + '88'),
            borderColor: ranked.map((_,i) => COLORS[i % COLORS.length]),
            borderWidth: 1,
            yAxisID: 'y',
            borderRadius: 6,
          },
          {
            label: 'Á∑èÂêà„Çπ„Ç≥„Ç¢',
            data: ranked.map(a => a.scores.total),
            backgroundColor: '#94a3b8' + '66',
            borderColor: '#94a3b8',
            borderWidth: 1,
            yAxisID: 'y1',
            borderRadius: 6,
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
        scales: {
          y: { position: 'left', title: { display: true, text: 'ÂÜÜ/m¬≤', font: { size: 11 } }, ticks: { font: { size: 10 } } },
          y1: { position: 'right', title: { display: true, text: '„Çπ„Ç≥„Ç¢', font: { size: 11 } }, grid: { drawOnChartArea: false }, ticks: { font: { size: 10 } } }
        }
      }
    });
  }

  // Line chart: trends
  const trendCtx = document.getElementById('chart-trend');
  if (trendCtx) {
    state.charts.trend = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: ['2020','2021','2022','2023','2024','2025'],
        datasets: AREAS.map((a,i) => ({
          label: a.name,
          data: a.trend.map(t => t.p),
          borderColor: COLORS[i % COLORS.length],
          backgroundColor: COLORS[i % COLORS.length] + '15',
          borderWidth: 2,
          pointRadius: 3,
          tension: 0.3,
          fill: false
        }))
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
        scales: {
          y: { title: { display: true, text: 'ÂÜÜ/m¬≤', font: { size: 11 } }, ticks: { font: { size: 10 } } }
        }
      }
    });
  }
}

function drawDetailCharts(area) {
  destroyCharts();

  // Radar chart
  const radarCtx = document.getElementById('chart-radar');
  if (radarCtx) {
    state.charts.radar = new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: ['‰æ°Ê†º', '‰∫§ÈÄö', 'ÊàêÈï∑ÊÄß', 'Âà©‰æøÊÄß', 'Â≠êËÇ≤„Å¶', 'Ëá™ÁÑ∂'],
        datasets: [{
          label: area.name,
          data: [area.scores.price, area.scores.access, area.scores.growth, area.scores.living, area.scores.family, area.scores.nature],
          backgroundColor: '#3b82f6' + '30',
          borderColor: '#3b82f6',
          borderWidth: 2,
          pointBackgroundColor: '#3b82f6',
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          r: {
            beginAtZero: true, max: 100,
            ticks: { font: { size: 10 }, stepSize: 20 },
            pointLabels: { font: { size: 12 } }
          }
        }
      }
    });
  }

  // Detail trend line
  const trendCtx = document.getElementById('chart-detail-trend');
  if (trendCtx) {
    state.charts.detailTrend = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: area.trend.map(t => t.y),
        datasets: [{
          label: `${area.name} Âú∞‰æ°Êé®Áßª`,
          data: area.trend.map(t => t.p),
          borderColor: '#3b82f6',
          backgroundColor: '#3b82f6' + '15',
          borderWidth: 3,
          pointRadius: 5,
          pointBackgroundColor: '#3b82f6',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { title: { display: true, text: 'ÂÜÜ/m¬≤', font: { size: 11 } } }
        }
      }
    });
  }
}

// ============================================================
// Event Binding
// ============================================================
function bindEvents(ranked) {
  // Tab switches
  document.querySelectorAll('[data-tab]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.view = btn.dataset.tab;
      if (state.view === 'detail' && !state.selectedAreaId) {
        state.selectedAreaId = ranked[0]?.id;
      }
      render();
    });
  });

  // Weight sliders
  document.querySelectorAll('input[data-weight]').forEach(slider => {
    slider.addEventListener('input', (e) => {
      const key = e.target.dataset.weight;
      const val = parseInt(e.target.value);
      state.weights[key] = val;
      const vEl = document.getElementById(`wv-${key}`);
      if (vEl) vEl.textContent = val;
      e.target.style.background = `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${val*2}%, #e5e7eb ${val*2}%, #e5e7eb 100%)`;
      // Debounced re-render for ranking
      clearTimeout(state._renderTimeout);
      state._renderTimeout = setTimeout(() => render(), 150);
    });
  });

  // Area detail click
  document.querySelectorAll('[data-area-detail]').forEach(el => {
    el.addEventListener('click', () => {
      state.selectedAreaId = el.dataset.areaDetail;
      state.view = 'detail';
      render();
    });
  });

  // Area switch buttons
  document.querySelectorAll('[data-area-switch]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.selectedAreaId = btn.dataset.areaSwitch;
      render();
    });
  });

  // Back button
  const backBtn = document.getElementById('btn-back');
  if (backBtn) backBtn.addEventListener('click', () => { state.view = 'ranking'; render(); });

  // MCP connect button
  const connectBtn = document.getElementById('btn-connect-mcp');
  if (connectBtn) connectBtn.addEventListener('click', connectMCP);

  // MCP refresh button
  const refreshBtn = document.getElementById('btn-refresh-mcp');
  if (refreshBtn) refreshBtn.addEventListener('click', fetchLiveData);

  // Detail ‚Üí Map button
  const toMapBtn = document.getElementById('btn-to-map');
  if (toMapBtn) {
    toMapBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = state.selectedAreaId;
      state.view = 'map';
      render();
    });
  }
}

// ============================================================
// Initialize
// ============================================================
loadDistrictCache();
render();
// „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´MCPËá™ÂãïÊé•Á∂ö‚Üí„Éá„Éº„ÇøÂèñÂæóÈñãÂßã
connectMCP();
</script>
</body>
</html>
