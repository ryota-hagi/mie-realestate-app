<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="VBmM5Mikm2LrkY9dXa30MUHtT9KD2SpZFsoGHBuFPWM" />
<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SZV3XF0W0G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SZV3XF0W0G');
</script>
<title>æ³¨æ–‡ä½å®…ã®ç‰©ä»¶æ¯”è¼ƒãƒ„ãƒ¼ãƒ«ï½œAIã§ç°¡å˜æ¯”è¼ƒ | æ³¨æ–‡ç›¸è«‡.com</title>
<meta name="description" content="æ³¨æ–‡ä½å®…ã®åœŸåœ°æ¢ã—ã«ã€‚æ°—ã«ãªã‚‹ç‰©ä»¶ã®URLã‚’è²¼ã‚‹ã ã‘ã§AIãŒè‡ªå‹•æ•´ç†ã€‚è¤‡æ•°ç‰©ä»¶ã‚’ä¸¦ã¹ã¦æ¯”è¼ƒè¡¨ã‚’ä½œæˆã€‚SUUMOãƒ»ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ç­‰ã®ç‰©ä»¶ã‚’çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§æ¯”è¼ƒã§ãã‚‹ç„¡æ–™ãƒ„ãƒ¼ãƒ«ã€‚">
<meta name="keywords" content="æ³¨æ–‡ä½å®…,ç‰©ä»¶æ¯”è¼ƒ,åœŸåœ°æ¯”è¼ƒ,AI,åœŸåœ°æ¢ã—,SUUMO,ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ,ä¸å‹•ç”£æ¯”è¼ƒ,æ¯”è¼ƒè¡¨">
<link rel="canonical" href="https://research.chuumon-soudan.com/">
<!-- OGP -->
<meta property="og:title" content="æ³¨æ–‡ä½å®…ã®ç‰©ä»¶æ¯”è¼ƒãƒ„ãƒ¼ãƒ«ï½œAIã§ç°¡å˜æ¯”è¼ƒ">
<meta property="og:description" content="æ³¨æ–‡ä½å®…ã®åœŸåœ°æ¢ã—ã«ã€‚æ°—ã«ãªã‚‹ç‰©ä»¶ã®URLã‚’è²¼ã‚‹ã ã‘ã§AIãŒè‡ªå‹•æ•´ç†ã€‚è¤‡æ•°ç‰©ä»¶ã‚’ä¸¦ã¹ã¦æ¯”è¼ƒè¡¨ã‚’ä½œæˆã€‚SUUMOãƒ»ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ç­‰ã®ç‰©ä»¶ã‚’çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§æ¯”è¼ƒã§ãã‚‹ç„¡æ–™ãƒ„ãƒ¼ãƒ«ã€‚">
<meta property="og:image" content="https://research.chuumon-soudan.com/assets/ogp.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://research.chuumon-soudan.com/assets/ogp.png">
<meta property="og:type" content="website">
<meta property="og:url" content="https://research.chuumon-soudan.com/">
<meta property="og:site_name" content="æ³¨æ–‡ç›¸è«‡.com">
<meta property="og:locale" content="ja_JP">
<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="æ³¨æ–‡ä½å®…ã®ç‰©ä»¶æ¯”è¼ƒãƒ„ãƒ¼ãƒ«ï½œAIã§ç°¡å˜æ¯”è¼ƒ">
<meta name="twitter:description" content="æ³¨æ–‡ä½å®…ã®åœŸåœ°æ¢ã—ã«ã€‚æ°—ã«ãªã‚‹ç‰©ä»¶ã®URLã‚’è²¼ã‚‹ã ã‘ã§AIãŒè‡ªå‹•æ•´ç†ã€‚è¤‡æ•°ç‰©ä»¶ã‚’ä¸¦ã¹ã¦æ¯”è¼ƒè¡¨ã‚’ä½œæˆã€‚">
<!-- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ (JSON-LD) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "æ³¨æ–‡ä½å®… ç‰©ä»¶æ¯”è¼ƒãƒ„ãƒ¼ãƒ«",
  "description": "æ³¨æ–‡ä½å®…ã®åœŸåœ°æ¢ã—ã«ã€‚AIãŒç‰©ä»¶æƒ…å ±ã‚’è‡ªå‹•æ•´ç†ã—ã€è¤‡æ•°ç‰©ä»¶ã‚’æ¯”è¼ƒè¡¨ã§ä¸€è¦§æ¯”è¼ƒã§ãã‚‹ç„¡æ–™ãƒ„ãƒ¼ãƒ«",
  "url": "https://research.chuumon-soudan.com/",
  "applicationCategory": "RealEstate",
  "operatingSystem": "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "JPY" },
  "author": { "@type": "Organization", "name": "æ³¨æ–‡ç›¸è«‡.com" },
  "about": [
    { "@type": "Thing", "name": "æ³¨æ–‡ä½å®…" },
    { "@type": "Thing", "name": "ç‰©ä»¶æ¯”è¼ƒ" },
    { "@type": "Thing", "name": "åœŸåœ°æ¢ã—" }
  ]
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* === Tailwind CSS v3.4.19 (production build) === */
  *,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sticky{position:sticky}.top-0{top:0}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-1{margin-left:.25rem}.mt-0\.5{margin-top:.125rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.h-6{height:1.5rem}.w-12{width:3rem}.w-16{width:4rem}.w-28{width:7rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-8{width:2rem}.w-full{width:100%}.min-w-0{min-width:0}.max-w-6xl{max-width:72rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity,1))}.border-blue-100{--tw-border-opacity:1;border-color:rgb(219 234 254/var(--tw-border-opacity,1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-50{--tw-border-opacity:1;border-color:rgb(249 250 251/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.bg-amber-500{--tw-bg-opacity:1;background-color:rgb(245 158 11/var(--tw-bg-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgb(156 163 175/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94/var(--tw-bg-opacity,1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity,1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255/var(--tw-bg-opacity,1))}.bg-slate-400{--tw-bg-opacity:1;background-color:rgb(148 163 184/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.p-2{padding:.5rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.leading-relaxed{line-height:1.625}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-amber-800{--tw-text-opacity:1;color:rgb(146 64 14/var(--tw-text-opacity,1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.shadow-md,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.outline{outline-style:solid}.blur{--tw-blur:blur(8px)}.blur,.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-filter{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-100:hover{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:bg-green-100:hover{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity,1))}@media (min-width:640px){.sm\:block{display:block}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.sm\:flex-row{flex-direction:row}}@media (min-width:768px){.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  * { font-family: 'Noto Sans JP', sans-serif; }
  body { background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 50%, #f5f0ff 100%); min-height: 100vh; }
  .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); }
  .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; transition: all 0.2s; }
  .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  /* === Second Opinion Feature === */
  .so-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; }
  .so-modal { background: white; border-radius: 16px; max-width: 560px; width: 90%; max-height: 85vh; overflow-y: auto; padding: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
  .so-badge-yellow { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-red { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-none { background: #f0fdf4; color: #166534; border: 1px solid #86efac; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-compare-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .so-compare-table th, .so-compare-table td { padding: 8px 12px; border: 1px solid #e5e7eb; text-align: left; }
  .so-compare-table th { background: #f9fafb; font-weight: 600; white-space: nowrap; }
  .so-compare-table .missing { color: #d97706; font-style: italic; }
  .so-radio-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .so-radio-group label { padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
  .so-radio-group label:hover { border-color: #3b82f6; background: #eff6ff; }
  .so-radio-group input:checked + span { color: #1d4ed8; }
  .so-radio-group label:has(input:checked) { border-color: #3b82f6; background: #dbeafe; }
  @media (max-width: 768px) {
    .comp-layout-sidebar { flex-direction: column !important; }
    .comp-layout-sidebar > div:first-child { width: 100% !important; }
    .comp-layout-sidebar > div:first-child .sticky { position: relative !important; top: 0 !important; }
  }
</style>
</head>
<body>
<div id="app"></div>

<script>
// ============================================================
// è¨­å®š
// ============================================================
const CONFIG = {
  SUPABASE_URL: 'https://jvfmvitknqnmuduyscnl.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2Zm12aXRrbnFubXVkdXlzY25sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4ODE5NTQsImV4cCI6MjA4NjQ1Nzk1NH0.dDsHJXxFW4R-8ts-sKfGHtE-P0Ge9mPYEtpl-30dAdg',
};

// ============================================================
// Supabase Client + Anonymous Auth
// ============================================================
const supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

async function ensureAuth() {
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) return session.user;
    const { data, error } = await supabaseClient.auth.signInAnonymously();
    if (error) { console.warn('Anonymous auth failed:', error.message); return null; }
    return data.user;
  } catch(e) { console.warn('Auth error:', e.message); return null; }
}

// ============================================================
// Auth Helpers
// ============================================================
function isAnonymousUser() {
  return !state.authUser || state.authUser.is_anonymous;
}

function updateAuthState(user) {
  if (user) {
    state.authUser = {
      id: user.id,
      email: user.email || null,
      is_anonymous: user.is_anonymous || !user.email,
    };
  } else {
    state.authUser = null;
  }
}

async function handleSendOtp(email) {
  state.authLoading = true;
  state.authError = '';
  render();
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    const currentUser = session?.user;
    if (currentUser && currentUser.is_anonymous) {
      // åŒ¿åâ†’æ­£å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰
      const { error } = await supabaseClient.auth.updateUser({ email });
      if (error) throw error;
      state.authEmail = email;
      state.authStep = 'link_sent'; // ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯å¾…ã¡
    } else {
      // é€šå¸¸ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆOTPé€ä¿¡ï¼‰
      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: { shouldCreateUser: true },
      });
      if (error) throw error;
      state.authEmail = email;
      state.authStep = 'otp';
    }
  } catch(e) {
    state.authError = e.message || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ';
  }
  state.authLoading = false;
  render();
}

async function handleVerifyOtp(email, token) {
  state.authLoading = true;
  state.authError = '';
  render();
  try {
    const { data, error } = await supabaseClient.auth.verifyOtp({
      email,
      token,
      type: 'email',
    });
    if (error) throw error;
    updateAuthState(data.user);
    state.authModalOpen = false;
    state.authStep = 'email';
    state.authEmail = '';
    // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
    await loadSavedProperties();
    await loadSavedComparisons();
    // æœªä¿å­˜ã®æ¯”è¼ƒè¡¨ãŒã‚ã‚Œã°DBã«ä¿å­˜
    await saveUnsavedComparisons();
    // ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    await loadUserProfile();
  } catch(e) {
    state.authError = e.message || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
  }
  state.authLoading = false;
  render();
}

async function handleLogout() {
  await supabaseClient.auth.signOut();
  state.authUser = null;
  state.userProfile = null;
  state.savedProperties = [];
  state.savedComparisons = [];
  state.soComparison = null;
  state.soView = null;
  try {
    localStorage.removeItem('mie_saved_properties');
    localStorage.removeItem('mie_comparison');
    localStorage.removeItem('mie_saved_comparisons');
  } catch(e) {}
  // æ–°ã—ã„åŒ¿åã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
  const user = await ensureAuth();
  if (user) updateAuthState(user);
  render();
}

function openAuthModal() {
  state.authModalOpen = true;
  state.authStep = 'email';
  state.authEmail = '';
  state.authError = '';
  state.authLoading = false;
  render();
}

async function saveUnsavedComparisons() {
  const user = state.authUser;
  if (!user || user.is_anonymous) return;
  const unsaved = state.savedComparisons.filter(c => c._unsaved);
  for (const comp of unsaved) {
    try {
      const { data } = await supabaseClient.from('comparisons').insert({
        user_id: user.id, name: comp.name, property_ids: comp.property_ids,
        ai_summary: comp.summary, ai_questions: comp.questions,
      }).select().single();
      if (data) {
        comp.id = data.id;
        comp.created_at = data.created_at;
        delete comp._unsaved;
        // soComparisonã‚‚æ›´æ–°
        if (state.soComparison && state.soComparison._unsaved) {
          state.soComparison.id = data.id;
          delete state.soComparison._unsaved;
        }
      }
    } catch(e) { console.warn('Failed to save comparison:', e.message); }
  }
  backupComparisonsToLS();
}

// ============================================================
// User Profile (ãƒã‚¤ãƒšãƒ¼ã‚¸)
// ============================================================
const PRIORITY_OPTIONS = [
  { key: 'garden', label: 'åº­ãŒåºƒã„' },
  { key: 'sunlight', label: 'æ—¥å½“ãŸã‚ŠãŒè‰¯ã„' },
  { key: 'quiet', label: 'é™ã‹ãªç’°å¢ƒ' },
  { key: 'childcare', label: 'å­è‚²ã¦ã—ã‚„ã™ã„' },
  { key: 'park_nearby', label: 'è¿‘ãã«å…¬åœ’ãŒã‚ã‚‹' },
  { key: 'shopping_nearby', label: 'å•†æ¥­æ–½è¨­ãŒè¿‘ã„' },
  { key: 'residential', label: 'é–‘é™ãªä½å®…è¡—' },
  { key: 'station_near', label: 'é§…ãŒè¿‘ã„' },
  { key: 'large_lot', label: 'åœŸåœ°ãŒåºƒã„' },
  { key: 'nature', label: 'è‡ªç„¶ç’°å¢ƒãŒè±Šã‹' },
];

async function loadUserProfile() {
  const user = state.authUser;
  if (!user || user.is_anonymous) return;
  try {
    const { data } = await supabaseClient
      .from('user_profiles')
      .select('*')
      .eq('user_id', user.id)
      .maybeSingle();
    state.userProfile = data || null;
  } catch(e) { console.warn('Failed to load profile:', e.message); }
}

async function geocodeAddress(address) {
  if (!address || !address.trim()) return null;
  try {
    const res = await fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`);
    if (!res.ok) return null;
    const data = await res.json();
    if (data && data.length > 0 && data[0].geometry && data[0].geometry.coordinates) {
      const [lng, lat] = data[0].geometry.coordinates;
      return { lat, lng };
    }
  } catch(e) { console.warn('Geocode failed:', e.message); }
  return null;
}

async function saveUserProfile(profileData) {
  const user = state.authUser;
  if (!user || user.is_anonymous) return;
  state._profileLoading = true;
  state._profileSaved = false;
  // ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¸€æ™‚ä¿æŒï¼ˆrender()ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œãªã„ã‚ˆã†ï¼‰
  state.userProfile = { ...state.userProfile, ...profileData };
  render();

  // å‹¤å‹™å…ˆä½æ‰€ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
  if (profileData.spouse1_workplace) {
    const geo = await geocodeAddress(profileData.spouse1_workplace);
    if (geo) { profileData.spouse1_lat = geo.lat; profileData.spouse1_lng = geo.lng; }
    else { profileData.spouse1_lat = null; profileData.spouse1_lng = null; }
  } else {
    profileData.spouse1_lat = null; profileData.spouse1_lng = null;
  }
  if (profileData.spouse2_workplace) {
    const geo = await geocodeAddress(profileData.spouse2_workplace);
    if (geo) { profileData.spouse2_lat = geo.lat; profileData.spouse2_lng = geo.lng; }
    else { profileData.spouse2_lat = null; profileData.spouse2_lng = null; }
  } else {
    profileData.spouse2_lat = null; profileData.spouse2_lng = null;
  }

  const row = { ...profileData, user_id: user.id, updated_at: new Date().toISOString() };

  try {
    const { error } = await supabaseClient
      .from('user_profiles')
      .upsert(row, { onConflict: 'user_id' });
    if (error) throw error;
    state.userProfile = row;
    state._profileSaved = true;
    setTimeout(() => { state._profileSaved = false; render(); }, 3000);
  } catch(e) { console.warn('Failed to save profile:', e.message); alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); }

  state._profileLoading = false;
  render();
}

// ============================================================
// Area Data (used by calculateBadge and generateComparison)
// ============================================================
const AREAS = [
  { id: "yokkaichi", name: "å››æ—¥å¸‚å¸‚", pricePerTsubo: 188498 },
  { id: "kuwana", name: "æ¡‘åå¸‚", pricePerTsubo: 183614 },
  { id: "suzuka", name: "éˆ´é¹¿å¸‚", pricePerTsubo: 135587 },
  { id: "inabe", name: "ã„ãªã¹å¸‚", pricePerTsubo: 81000 },
  { id: "kameyama", name: "äº€å±±å¸‚", pricePerTsubo: 97500 },
  { id: "komono", name: "è°é‡ç”º", pricePerTsubo: 73000 },
  { id: "toin", name: "æ±å“¡ç”º", pricePerTsubo: 106000 }
];

// ============================================================
// Property CRUD (Supabase)
// ============================================================
async function loadSavedProperties() {
  const user = await ensureAuth();
  if (!user) return;
  const { data, error } = await supabaseClient.from('saved_properties').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
  if (!error && data) state.savedProperties = data;
}

async function saveProperty(prop) {
  try {
    const user = await ensureAuth();
    if (!user) { alert('ç‰©ä»¶ã®ä¿å­˜ã«ã¯ãƒšãƒ¼ã‚¸ã®å†èª­ã¿è¾¼ã¿ãŒå¿…è¦ã§ã™'); return null; }
    let areaData = AREAS.find(a => a.id === prop.area_id);
    if (!areaData && prop.address) areaData = AREAS.find(a => prop.address.includes(a.name));
    const badge = calculateBadge(prop, areaData);
    const row = { ...prop, user_id: user.id, badge };
    const { data, error } = await supabaseClient.from('saved_properties').insert(row).select().single();
    if (error) { alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message); console.error('Save failed:', error); return null; }
    state.savedProperties.unshift(data);
    backupToLocalStorage();
    // ä½ç½®æƒ…å ±ãŒã‚ã‚‹å ´åˆã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§enrichmentå®Ÿè¡Œ
    if (data.lat && data.lng) {
      triggerEnrichment(data.id).catch(e => console.warn('Auto-enrichment failed:', e.message));
    }
    return data;
  } catch(e) { alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + e.message); return null; }
}

async function updateProperty(id, updates) {
  const prop = state.savedProperties.find(p => p.id === id);
  if (!prop) return;
  Object.assign(prop, updates);
  backupToLocalStorage();
  try {
    await supabaseClient.from('saved_properties').update(updates).eq('id', id);
  } catch(e) { console.warn('Supabase update failed, saved to localStorage:', e.message); }
}

async function deleteProperty(id) {
  const { error } = await supabaseClient.from('saved_properties').delete().eq('id', id);
  if (!error) state.savedProperties = state.savedProperties.filter(p => p.id !== id);
  backupToLocalStorage();
}

// ============================================================
// Property Enrichmentï¼ˆè©³ç´°æƒ…å ±ã®è‡ªå‹•å–å¾—ï¼‰
// ============================================================
async function triggerEnrichment(propertyId) {
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ã€Œå–å¾—ä¸­ã€ã«æ›´æ–°
  const prop = state.savedProperties.find(p => p.id === propertyId);
  if (prop) { prop.enrichment_status = 'pending'; render(); }

  try {
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    if (token) headers['Authorization'] = `Bearer ${token}`;
    else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/property-enrich`, {
      method: 'POST', headers,
      body: JSON.stringify({ action: 'enrich', property_id: propertyId })
    });
    if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
    const result = await res.json();
    if (result.error) throw new Error(result.error);

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã«çµæœã‚’åæ˜ 
    if (prop) {
      Object.assign(prop, result);
      backupToLocalStorage();
      render();
    }
    return result;
  } catch(e) {
    console.warn('Enrichment failed for', propertyId, ':', e.message);
    if (prop) { prop.enrichment_status = 'error'; render(); }
    throw e;
  }
}

async function handleEnrichProperty(propertyId) {
  try {
    await triggerEnrichment(propertyId);
  } catch(e) {
    // silently handled in triggerEnrichment
  }
}

// ============================================================
// Comparisons CRUD
// ============================================================
async function loadSavedComparisons() {
  try {
    const user = await ensureAuth();
    if (!user) return;
    const { data, error } = await supabaseClient.from('comparisons')
      .select('*').eq('user_id', user.id).order('created_at', { ascending: false });
    if (!error && data) {
      state.savedComparisons = data.map(c => ({
        id: c.id,
        name: c.name || 'æ¯”è¼ƒè¡¨',
        created_at: c.created_at,
        summary: c.ai_summary,
        questions: c.ai_questions,
        property_ids: c.property_ids,
        properties: null, // lazy load
      }));
      backupComparisonsToLS();
    }
  } catch(e) { console.warn('Load comparisons failed:', e.message); }
}

async function renameComparison(compId, newName) {
  const comp = state.savedComparisons.find(c => c.id === compId);
  if (!comp) return;
  comp.name = newName;
  if (state.soComparison && state.soComparison.id === compId) state.soComparison.name = newName;
  backupComparisonsToLS();
  try {
    await supabaseClient.from('comparisons').update({ name: newName }).eq('id', compId);
  } catch(e) { console.warn('Rename failed:', e.message); }
}

async function deleteComparison(compId) {
  state.savedComparisons = state.savedComparisons.filter(c => c.id !== compId);
  if (state.soComparison?.id === compId) { state.soComparison = null; state.soView = null; }
  backupComparisonsToLS();
  try {
    await supabaseClient.from('comparisons').delete().eq('id', compId);
  } catch(e) { console.warn('Delete comparison failed:', e.message); }
}

async function loadComparisonDetail(compId) {
  const comp = state.savedComparisons.find(c => c.id === compId);
  if (!comp) return;
  // property_idsã‹ã‚‰ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const propIds = comp.property_ids || [];
  let props = state.savedProperties.filter(p => propIds.includes(p.id));
  // Supabaseã‹ã‚‰ã‚‚å–å¾—ã‚’è©¦ã¿ã‚‹ï¼ˆå‰Šé™¤æ¸ˆã¿ç‰©ä»¶å¯¾å¿œï¼‰
  if (props.length < propIds.length) {
    try {
      const { data } = await supabaseClient.from('saved_properties').select('*').in('id', propIds);
      if (data) props = data;
    } catch(e) {}
  }
  let questions = [];
  try { questions = typeof comp.questions === 'string' ? JSON.parse(comp.questions) : (comp.questions || []); } catch(e) {}

  state.soComparison = {
    id: comp.id,
    name: comp.name,
    summary: comp.summary,
    questions,
    properties: props,
    property_ids: propIds,
    _unsaved: comp._unsaved || false,
  };
  state.soView = 'compare';
  backupToLocalStorage();
  render();
}

// localStorage ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
const LS_PROPS_KEY = 'mie_saved_properties';
const LS_COMP_KEY = 'mie_comparison';
const LS_COMPS_KEY = 'mie_saved_comparisons';

function backupToLocalStorage() {
  try {
    localStorage.setItem(LS_PROPS_KEY, JSON.stringify(state.savedProperties));
    if (state.soComparison) localStorage.setItem(LS_COMP_KEY, JSON.stringify(state.soComparison));
  } catch(e) {}
}

function backupComparisonsToLS() {
  try { localStorage.setItem(LS_COMPS_KEY, JSON.stringify(state.savedComparisons)); } catch(e) {}
}

function restoreFromLocalStorage() {
  try {
    const props = localStorage.getItem(LS_PROPS_KEY);
    if (props) {
      const parsed = JSON.parse(props);
      if (Array.isArray(parsed) && parsed.length > 0 && state.savedProperties.length === 0) {
        state.savedProperties = parsed;
      }
    }
    const comp = localStorage.getItem(LS_COMP_KEY);
    if (comp) state.soComparison = JSON.parse(comp);
    const comps = localStorage.getItem(LS_COMPS_KEY);
    if (comps) {
      const parsed = JSON.parse(comps);
      if (Array.isArray(parsed) && state.savedComparisons.length === 0) state.savedComparisons = parsed;
    }
  } catch(e) {}
}

async function toggleComparison(id) {
  const prop = state.savedProperties.find(p => p.id === id);
  if (!prop) return;
  const newVal = !prop.in_comparison;
  const inCompCount = state.savedProperties.filter(p => p.in_comparison).length;
  if (newVal && inCompCount >= 5) { alert('æ¯”è¼ƒã¯æœ€å¤§5ä»¶ã¾ã§ã§ã™'); return; }
  const { error } = await supabaseClient.from('saved_properties').update({ in_comparison: newVal }).eq('id', id);
  if (!error) prop.in_comparison = newVal;
}

async function generateComparison() {
  const props = state.savedProperties.filter(p => p.in_comparison);
  if (props.length < 2) { alert('æ¯”è¼ƒã™ã‚‹ã«ã¯2ä»¶ä»¥ä¸Šã®ç‰©ä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„'); return null; }
  const areas = {};
  AREAS.forEach(a => { areas[a.id] = { name: a.name, pricePerTsubo: a.pricePerTsubo }; });
  try {
    const user = await ensureAuth();
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    headers['Authorization'] = token ? `Bearer ${token}` : `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-compare`, {
      method: 'POST', headers,
      body: JSON.stringify({ properties: props, areas })
    });
    const result = await res.json();
    const compName = 'æ¯”è¼ƒè¡¨ ' + new Date().toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

    // åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ: DBã«ä¿å­˜ã›ãšã€ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã§æ¯”è¼ƒè¡¨ã‚’è¡¨ç¤º
    if (isAnonymousUser()) {
      const tempComp = {
        id: 'temp_' + Date.now(), name: compName, created_at: new Date().toISOString(),
        summary: result.summary, questions: JSON.stringify(result.questions),
        property_ids: props.map(p => p.id), properties: props, _unsaved: true,
      };
      state.savedComparisons.unshift(tempComp);
      backupComparisonsToLS();
      return { ...result, id: tempComp.id, name: compName, properties: props, _unsaved: true };
    }

    // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: DBã«ä¿å­˜
    const { data } = await supabaseClient.from('comparisons').insert({
      user_id: user.id, name: compName, property_ids: props.map(p => p.id), ai_summary: result.summary, ai_questions: JSON.stringify(result.questions)
    }).select().single();
    if (data) {
      state.savedComparisons.unshift({
        id: data.id, name: compName, created_at: data.created_at,
        summary: result.summary, questions: JSON.stringify(result.questions),
        property_ids: props.map(p => p.id), properties: props,
      });
      backupComparisonsToLS();
    }
    return { ...result, id: data?.id, name: compName, properties: props };
  } catch(e) { console.error('Comparison failed:', e); return null; }
}

function calculateBadge(property, areaData) {
  let yellowReasons = [], redReasons = [];
  if (!property.price) yellowReasons.push('ä¾¡æ ¼æœªå…¥åŠ›');
  if (!property.land_area) yellowReasons.push('é¢ç©æœªå…¥åŠ›');
  if (!property.zoning) yellowReasons.push('ç”¨é€”åœ°åŸŸä¸æ˜');
  if (!property.road_access) yellowReasons.push('æ¥é“æƒ…å ±ä¸æ˜');
  if (!property.building_coverage) yellowReasons.push('å»ºãºã„ç‡ä¸æ˜');
  if (property.price && property.land_area && areaData) {
    const tsuboPr = property.price / (property.land_area / 3.305785);
    const areaTsubo = areaData.pricePerTsubo;
    if (areaTsubo && Math.abs(tsuboPr - areaTsubo) / areaTsubo > 0.25) redReasons.push('åªå˜ä¾¡ãŒã‚¨ãƒªã‚¢ç›¸å ´ã‹ã‚‰ä¹–é›¢');
  }
  const missingCritical = [property.zoning, property.road_access, property.building_coverage, property.elevation, property.infrastructure].filter(v => !v).length;
  if (missingCritical >= 3) redReasons.push('é‡è¦é …ç›®ãŒè¤‡æ•°ä¸æ˜');
  return redReasons.length > 0 ? 'red' : yellowReasons.length > 0 ? 'yellow' : 'none';
}

// ============================================================
// Auto Scoringï¼ˆç‰©ä»¶ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼‰
// ============================================================
// Haversineè·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
function haversineDistanceClient(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function calculateLifestyleScore(prop, profile) {
  if (!profile) return null;
  const priorities = profile.priorities || [];
  const hasWorkplace = (profile.spouse1_lat && profile.spouse1_lng) || (profile.spouse2_lat && profile.spouse2_lng);
  if (priorities.length === 0 && !hasWorkplace) return null;

  let score = 50;

  // --- é€šå‹¤ã‚µãƒ–ã‚¹ã‚³ã‚¢ï¼ˆÂ±25ptï¼‰ ---
  if (hasWorkplace && prop.lat && prop.lng) {
    const distances = [];
    if (profile.spouse1_lat && profile.spouse1_lng) {
      distances.push(haversineDistanceClient(prop.lat, prop.lng, profile.spouse1_lat, profile.spouse1_lng) / 1000);
    }
    if (profile.spouse2_lat && profile.spouse2_lng) {
      distances.push(haversineDistanceClient(prop.lat, prop.lng, profile.spouse2_lat, profile.spouse2_lng) / 1000);
    }
    if (distances.length > 0) {
      const avgKm = distances.reduce((a, b) => a + b, 0) / distances.length;
      if (avgKm < 5) score += 25;
      else if (avgKm < 10) score += 15;
      else if (avgKm < 20) score += 5;
      else if (avgKm < 30) score += 0;
      else score -= 10;
    }
  }

  // --- é‡è¦–é …ç›®ã‚µãƒ–ã‚¹ã‚³ã‚¢ï¼ˆÂ±25ptï¼‰ ---
  if (priorities.length > 0) {
    const extractDist = (str) => {
      if (!str) return null;
      const m = str.match(/(\d+)m/);
      return m ? parseInt(m[1]) : null;
    };

    const checks = {
      garden: () => {
        if (!prop.land_area) return null;
        return prop.land_area >= 200 ? 1 : prop.land_area >= 150 ? 0.5 : 0.2;
      },
      sunlight: () => {
        if (!prop.zoning) return null;
        if (/ä¸€ä½ä½|ç¬¬ä¸€ç¨®ä½å±¤/.test(prop.zoning)) return 1;
        if (/äºŒä½ä½|ç¬¬äºŒç¨®ä½å±¤/.test(prop.zoning)) return 0.7;
        if (/å•†æ¥­|å·¥æ¥­/.test(prop.zoning)) return 0.2;
        return 0.5;
      },
      quiet: () => {
        if (!prop.zoning) return null;
        if (/ä½å±¤|ä½ä½/.test(prop.zoning)) return 1;
        if (/ä½å±…/.test(prop.zoning)) return 0.6;
        if (/å•†æ¥­|å·¥æ¥­/.test(prop.zoning)) return 0.1;
        return 0.5;
      },
      childcare: () => {
        const nursery = extractDist(prop.nearest_nursery);
        const school = extractDist(prop.school_elementary);
        let val = 0, count = 0;
        if (nursery != null) { val += nursery < 800 ? 1 : nursery < 1500 ? 0.6 : 0.2; count++; }
        if (school != null) { val += school < 800 ? 1 : school < 1500 ? 0.6 : 0.2; count++; }
        return count > 0 ? val / count : null;
      },
      park_nearby: () => {
        const d = extractDist(prop.nearest_park);
        if (d == null) return null;
        return d < 300 ? 1 : d < 600 ? 0.7 : d < 1000 ? 0.4 : 0.1;
      },
      shopping_nearby: () => {
        const d = extractDist(prop.nearest_supermarket);
        if (d == null) return null;
        return d < 500 ? 1 : d < 1000 ? 0.7 : d < 2000 ? 0.4 : 0.1;
      },
      residential: () => {
        if (!prop.zoning) return null;
        if (/ä½å±¤|ä½ä½/.test(prop.zoning)) return 1;
        if (/ä½å±…/.test(prop.zoning)) return 0.7;
        if (/å•†æ¥­|å·¥æ¥­/.test(prop.zoning)) return 0.2;
        return 0.5;
      },
      station_near: () => {
        if (!prop.station_distance) return null;
        const m = prop.station_distance.match(/(\d+)\s*åˆ†/);
        if (m) {
          const mins = parseInt(m[1]);
          return mins <= 5 ? 1 : mins <= 10 ? 0.7 : mins <= 20 ? 0.4 : 0.1;
        }
        const m2 = prop.station_distance.match(/(\d+)\s*m/);
        if (m2) {
          const mins = Math.round(parseInt(m2[1]) / 80);
          return mins <= 5 ? 1 : mins <= 10 ? 0.7 : mins <= 20 ? 0.4 : 0.1;
        }
        return null;
      },
      large_lot: () => {
        if (!prop.land_area) return null;
        return prop.land_area >= 250 ? 1 : prop.land_area >= 200 ? 0.7 : prop.land_area >= 150 ? 0.5 : 0.2;
      },
      nature: () => {
        const d = extractDist(prop.nearest_park);
        if (d == null) return null;
        return d < 500 ? 1 : d < 1000 ? 0.7 : 0.3;
      },
    };

    let totalVal = 0;
    let count = 0;
    for (const key of priorities) {
      const fn = checks[key];
      if (fn) {
        const result = fn();
        if (result !== null) { totalVal += result; count++; }
      }
    }
    if (count > 0) {
      score += Math.round((totalVal / count) * 25);
    }
  }

  return Math.max(0, Math.min(100, Math.round(score)));
}

function getLifestyleBreakdown(prop, profile) {
  if (!profile) return null;
  const priorities = profile.priorities || [];
  const hasWorkplace = (profile.spouse1_lat && profile.spouse1_lng) || (profile.spouse2_lat && profile.spouse2_lng);
  if (priorities.length === 0 && !hasWorkplace) return null;

  const reasons = [];

  // é€šå‹¤è·é›¢
  if (hasWorkplace && prop.lat && prop.lng) {
    const dists = [];
    if (profile.spouse1_lat && profile.spouse1_lng) {
      const km = haversineDistanceClient(prop.lat, prop.lng, profile.spouse1_lat, profile.spouse1_lng) / 1000;
      dists.push({ name: profile.spouse1_name || 'é…å¶è€…1', km });
    }
    if (profile.spouse2_lat && profile.spouse2_lng) {
      const km = haversineDistanceClient(prop.lat, prop.lng, profile.spouse2_lat, profile.spouse2_lng) / 1000;
      dists.push({ name: profile.spouse2_name || 'é…å¶è€…2', km });
    }
    for (const d of dists) {
      const rating = d.km < 5 ? 'â—' : d.km < 10 ? 'â—‹' : d.km < 20 ? 'â–³' : 'Ã—';
      reasons.push('ğŸš— ' + d.name + 'ã®é€šå‹¤: ç´„' + d.km.toFixed(1) + 'km ' + rating);
    }
  }

  // é‡è¦–é …ç›®
  if (priorities.length > 0) {
    const extractDist = (str) => { if (!str) return null; const m = str.match(/(\d+)m/); return m ? parseInt(m[1]) : null; };
    const labelMap = {};
    PRIORITY_OPTIONS.forEach(o => { labelMap[o.key] = o.label; });

    const evalMap = {
      garden: () => {
        if (!prop.land_area) return 'æƒ…å ±ãªã—';
        return prop.land_area >= 200 ? 'â— ' + prop.land_area + 'ã¡' : prop.land_area >= 150 ? 'â—‹ ' + prop.land_area + 'ã¡' : 'â–³ ' + prop.land_area + 'ã¡';
      },
      sunlight: () => {
        if (!prop.zoning) return 'æƒ…å ±ãªã—';
        if (/ä¸€ä½ä½|ç¬¬ä¸€ç¨®ä½å±¤/.test(prop.zoning)) return 'â— ' + prop.zoning;
        if (/äºŒä½ä½|ç¬¬äºŒç¨®ä½å±¤/.test(prop.zoning)) return 'â—‹ ' + prop.zoning;
        if (/å•†æ¥­|å·¥æ¥­/.test(prop.zoning)) return 'Ã— ' + prop.zoning;
        return 'â–³ ' + prop.zoning;
      },
      quiet: () => {
        if (!prop.zoning) return 'æƒ…å ±ãªã—';
        if (/ä½å±¤|ä½ä½/.test(prop.zoning)) return 'â— ' + prop.zoning;
        if (/ä½å±…/.test(prop.zoning)) return 'â—‹ ' + prop.zoning;
        if (/å•†æ¥­|å·¥æ¥­/.test(prop.zoning)) return 'Ã— ' + prop.zoning;
        return 'â–³ ' + prop.zoning;
      },
      childcare: () => {
        const parts = [];
        const nd = extractDist(prop.nearest_nursery);
        const sd = extractDist(prop.school_elementary);
        if (nd != null) parts.push('ä¿è‚²åœ’' + nd + 'm');
        if (sd != null) parts.push('å°å­¦æ ¡' + sd + 'm');
        if (parts.length === 0) return 'æƒ…å ±ãªã—';
        const avg = ((nd || 9999) + (sd || 9999)) / (parts.length);
        const r = avg < 800 ? 'â—' : avg < 1500 ? 'â—‹' : 'â–³';
        return r + ' ' + parts.join('ï¼');
      },
      park_nearby: () => {
        const d = extractDist(prop.nearest_park);
        if (d == null) return 'æƒ…å ±ãªã—';
        const r = d < 300 ? 'â—' : d < 600 ? 'â—‹' : d < 1000 ? 'â–³' : 'Ã—';
        return r + ' ' + d + 'm';
      },
      shopping_nearby: () => {
        const d = extractDist(prop.nearest_supermarket);
        if (d == null) return 'æƒ…å ±ãªã—';
        const r = d < 500 ? 'â—' : d < 1000 ? 'â—‹' : d < 2000 ? 'â–³' : 'Ã—';
        return r + ' ' + d + 'm';
      },
      residential: () => {
        if (!prop.zoning) return 'æƒ…å ±ãªã—';
        if (/ä½å±¤|ä½ä½/.test(prop.zoning)) return 'â— ' + prop.zoning;
        if (/ä½å±…/.test(prop.zoning)) return 'â—‹ ' + prop.zoning;
        if (/å•†æ¥­|å·¥æ¥­/.test(prop.zoning)) return 'Ã— ' + prop.zoning;
        return 'â–³ ' + prop.zoning;
      },
      station_near: () => {
        if (!prop.station_distance) return 'æƒ…å ±ãªã—';
        return prop.station_distance;
      },
      large_lot: () => {
        if (!prop.land_area) return 'æƒ…å ±ãªã—';
        return prop.land_area >= 250 ? 'â— ' + prop.land_area + 'ã¡' : prop.land_area >= 200 ? 'â—‹ ' + prop.land_area + 'ã¡' : prop.land_area >= 150 ? 'â–³ ' + prop.land_area + 'ã¡' : 'Ã— ' + prop.land_area + 'ã¡';
      },
      nature: () => {
        const d = extractDist(prop.nearest_park);
        if (d == null) return 'æƒ…å ±ãªã—';
        const r = d < 500 ? 'â—' : d < 1000 ? 'â—‹' : 'â–³';
        return r + ' å…¬åœ’' + d + 'm';
      },
    };

    for (const key of priorities) {
      const fn = evalMap[key];
      const label = labelMap[key] || key;
      if (fn) {
        reasons.push(label + ': ' + fn());
      }
    }
  }

  return reasons;
}

function calculateScores(prop, userProfile) {
  if (!prop) return null;

  // ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ¤å®šãƒ˜ãƒ«ãƒ‘ãƒ¼
  // AIå‡ºåŠ›å½¢å¼: ã€Œä½ï¼ˆç†ç”±...ï¼‰ã€ã€Œä¸­ã€‚ç†ç”±...ã€ã€Œé«˜ï¼ˆç†ç”±...ï¼‰ã€
  // â†’ å…ˆé ­ã®ã€Œä½/ä¸­/é«˜ã€ã‚’æœ€å„ªå…ˆã§åˆ¤å®šã™ã‚‹ï¼ˆç†ç”±æ–‡ä¸­ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«æƒ‘ã‚ã•ã‚Œãªã„ï¼‰
  function riskLevel(text) {
    if (!text) return null;
    const t = text.trim();
    // å…ˆé ­ãŒã€Œé«˜ã€ã€Œä¸­ã€ã€Œä½ã€ã§å§‹ã¾ã‚‹å ´åˆã¯ãã‚Œã‚’æ¡ç”¨
    if (/^é«˜/.test(t)) return 'high';
    if (/^ä¸­/.test(t)) return 'medium';
    if (/^ä½/.test(t)) return 'low';
    // å…ˆé ­ã«ãªã„å ´åˆ: ã€Œã€‚ã€ã‚„ã€Œï¼ˆã€ã®å‰ã®éƒ¨åˆ†ã§åˆ¤å®š
    const prefix = t.split(/[ã€‚ï¼ˆ(]/)[0];
    if (prefix.includes('é«˜')) return 'high';
    if (prefix.includes('ä¸­')) return 'medium';
    if (prefix.includes('ä½')) return 'low';
    return 'unknown';
  }

  // å®‰å…¨æ€§ã‚¹ã‚³ã‚¢ (0-100) â€” ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³50ã€å„é …ç›®ã§åŠ æ¸›ç‚¹
  let scoreSafety = 50;

  const floodRisk = riskLevel(prop.hazard_flood);
  if (floodRisk === 'low') scoreSafety += 15;
  else if (floodRisk === 'medium') scoreSafety -= 10;
  else if (floodRisk === 'high') scoreSafety -= 25;

  const sedimentRisk = riskLevel(prop.hazard_sediment);
  if (sedimentRisk === 'low') scoreSafety += 15;
  else if (sedimentRisk === 'medium') scoreSafety -= 15;
  else if (sedimentRisk === 'high') scoreSafety -= 30;

  const tsunamiRisk = riskLevel(prop.hazard_tsunami);
  if (tsunamiRisk === 'low') scoreSafety += 10;
  else if (tsunamiRisk === 'medium') scoreSafety -= 10;
  else if (tsunamiRisk === 'high') scoreSafety -= 20;

  if (prop.ground_type) {
    if (prop.ground_type.includes('å°åœ°') || prop.ground_type.includes('ä¸˜é™µ')) scoreSafety += 10;
    else if (prop.ground_type.includes('æ²–ç©') || prop.ground_type.includes('åŸ‹ç«‹')) scoreSafety -= 15;
  }

  // ç‰©ä»¶æƒ…å ±ã®hazardãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ˜ç¢ºãªæŒ‡å®šè¨˜è¼‰ãŒã‚ã‚‹å ´åˆã®ã¿æ¸›ç‚¹
  // ã€ŒæŒ‡å®šæœ‰ã€ã€ŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€ç­‰ã®ç¢ºå®šè¡¨ç¾ã®ã¿å¯¾è±¡ï¼ˆã€Œå¯èƒ½æ€§ã€ã€Œæ¨å®šã€ã¯é™¤å¤–ï¼‰
  if (prop.hazard) {
    if (/æŒ‡å®šæœ‰|æŒ‡å®šã•ã‚Œã¦|è©²å½“ã—ã¦|åŒºåŸŸå†…/.test(prop.hazard)) scoreSafety -= 15;
  }

  // åˆ©ä¾¿æ€§ã‚¹ã‚³ã‚¢ (0-100)
  let scoreConvenience = 50;
  const extractDist = (str) => {
    if (!str) return null;
    const m = str.match(/(\d+)m/);
    return m ? parseInt(m[1]) : null;
  };
  const superDist = extractDist(prop.nearest_supermarket);
  if (superDist) { scoreConvenience += superDist < 500 ? 20 : superDist < 1000 ? 10 : superDist < 2000 ? 0 : -10; }
  const hospDist = extractDist(prop.nearest_hospital);
  if (hospDist) { scoreConvenience += hospDist < 1000 ? 10 : hospDist < 2000 ? 5 : 0; }
  const parkDist = extractDist(prop.nearest_park);
  if (parkDist) { scoreConvenience += parkDist < 500 ? 10 : parkDist < 1000 ? 5 : 0; }
  if (prop.school_elementary) {
    const schoolDist = extractDist(prop.school_elementary);
    if (schoolDist) { scoreConvenience += schoolDist < 800 ? 10 : schoolDist < 1500 ? 5 : 0; }
  }

  // ã‚³ã‚¹ãƒˆã‚¹ã‚³ã‚¢ (0-100) â€” è¿½åŠ è²»ç”¨ãƒªã‚¹ã‚¯ãŒä¸»è»¸ã€ã‚¨ãƒªã‚¢ç›¸å ´ã¯å‚è€ƒç¨‹åº¦
  // è¿½åŠ ã‚³ã‚¹ãƒˆãŒå°‘ãªã„ç‰©ä»¶ã»ã©é«˜ã‚¹ã‚³ã‚¢ã«ã™ã‚‹
  let scoreCost = 70; // è¿½åŠ ã‚³ã‚¹ãƒˆãªã—ãªã‚‰ãƒ™ãƒ¼ã‚¹70

  // AIåˆ¤å®šã«ã‚ˆã‚‹è¿½åŠ ã‚³ã‚¹ãƒˆæ¸›ç‚¹ï¼ˆä¸»è»¸: 0ã€œ-50ã®ç¯„å›²ï¼‰
  if (prop.extra_cost_score != null && typeof prop.extra_cost_score === 'number') {
    scoreCost += prop.extra_cost_score; // è² ã®å€¤ãŒåŠ ç®—ã•ã‚Œã‚‹ï¼ˆæ¸›ç‚¹ï¼‰
  }

  // ã‚¨ãƒªã‚¢ç›¸å ´æ¯”è¼ƒï¼ˆå‚è€ƒ: æ§ãˆã‚ãªåŠ æ¸›ç‚¹ï¼‰
  if (prop.price && prop.land_area) {
    const tsuboPrice = prop.price / (prop.land_area / 3.305785) / 10000; // ä¸‡å††/åª
    let areaData = AREAS.find(a => a.id === prop.area_id);
    if (!areaData && prop.address) areaData = AREAS.find(a => prop.address.includes(a.name));
    if (areaData) {
      const areaAvg = areaData.pricePerTsubo / 10000; // ä¸‡å††/åª
      const ratio = tsuboPrice / areaAvg;
      if (ratio < 0.7) scoreCost += 15;       // ç›¸å ´ã‚ˆã‚Šã‹ãªã‚Šå®‰ã„
      else if (ratio < 0.9) scoreCost += 8;   // ç›¸å ´ã‚ˆã‚Šã‚„ã‚„å®‰ã„
      else if (ratio < 1.1) scoreCost += 0;   // ç›¸å ´ä¸¦ã¿
      else if (ratio > 1.3) scoreCost -= 10;  // ç›¸å ´ã‚ˆã‚Šã‹ãªã‚Šé«˜ã„
      else if (ratio > 1.1) scoreCost -= 5;   // ç›¸å ´ã‚ˆã‚Šã‚„ã‚„é«˜ã„
    }
  }

  // ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã‚¹ã‚³ã‚¢
  const lifestyle = calculateLifestyleScore(prop, userProfile || null);

  // ç·åˆã‚¹ã‚³ã‚¢
  let scoreTotal;
  if (lifestyle !== null) {
    scoreTotal = Math.round(scoreSafety * 0.25 + scoreConvenience * 0.25 + scoreCost * 0.25 + lifestyle * 0.25);
  } else {
    scoreTotal = Math.round(scoreSafety * 0.35 + scoreConvenience * 0.35 + scoreCost * 0.3);
  }

  return {
    score_safety: Math.max(0, Math.min(100, Math.round(scoreSafety))),
    score_convenience: Math.max(0, Math.min(100, Math.round(scoreConvenience))),
    score_cost: Math.max(0, Math.min(100, Math.round(scoreCost))),
    score_lifestyle: lifestyle,
    score_total: Math.max(0, Math.min(100, scoreTotal)),
  };
}

function getScoreColor(score) {
  if (score >= 70) return '#16a34a'; // green
  if (score >= 45) return '#d97706'; // amber
  return '#dc2626'; // red
}

function renderScoreBar(label, score) {
  if (score == null) return '';
  const color = getScoreColor(score);
  return `<div class="flex items-center gap-2 text-xs">
    <span class="text-gray-500 w-12">${label}</span>
    <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
      <div class="h-full rounded-full" style="width:${score}%;background:${color};"></div>
    </div>
    <span class="font-medium" style="color:${color};">${score}</span>
  </div>`;
}

// ============================================================
// CSV Export
// ============================================================
function exportComparisonCSV() {
  const comp = state.soComparison;
  if (!comp || !comp.properties || comp.properties.length === 0) { alert('æ¯”è¼ƒè¡¨ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const props = comp.properties;
  const labels = ['A','B','C','D','E'];

  const allKeys = [
    { label: 'ç‰©ä»¶', fmt: (p, i) => 'ç‰©ä»¶' + labels[i] },
    { label: 'æ‰€åœ¨åœ°', fmt: p => p.address || '' },
    { label: 'ä¾¡æ ¼(ä¸‡å††)', fmt: p => p.price ? (p.price / 10000) : '' },
    { label: 'åœŸåœ°é¢ç©(ã¡)', fmt: p => p.land_area || '' },
    { label: 'åªå˜ä¾¡(ä¸‡å††)', fmt: p => p.price && p.land_area ? (p.price / (p.land_area / 3.305785) / 10000).toFixed(1) : '' },
    { label: 'é§…è·é›¢', fmt: p => p.station_distance || '' },
    { label: 'ç”¨é€”åœ°åŸŸ', fmt: p => p.zoning || '' },
    { label: 'å»ºãºã„ç‡', fmt: p => p.building_coverage || '' },
    { label: 'å®¹ç©ç‡', fmt: p => p.floor_area_ratio || '' },
    { label: 'æ¥é“', fmt: p => p.road_access || '' },
    { label: 'ã‚¤ãƒ³ãƒ•ãƒ©', fmt: p => p.infrastructure || '' },
    { label: 'ãƒã‚¶ãƒ¼ãƒ‰', fmt: p => p.hazard || '' },
    { label: 'å°å­¦æ ¡åŒº', fmt: p => p.school_elementary || '' },
    { label: 'ä¸­å­¦æ ¡åŒº', fmt: p => p.school_junior_high || '' },
    { label: 'æœ€å¯„ã‚¹ãƒ¼ãƒ‘ãƒ¼', fmt: p => p.nearest_supermarket || '' },
    { label: 'æœ€å¯„ç—…é™¢', fmt: p => p.nearest_hospital || '' },
    { label: 'æ´ªæ°´ãƒªã‚¹ã‚¯', fmt: p => p.hazard_flood || '' },
    { label: 'åœŸç ‚ç½å®³', fmt: p => p.hazard_sediment || '' },
    { label: 'åœ°ç›¤', fmt: p => p.ground_type || '' },
    { label: 'AIã‚³ãƒ¡ãƒ³ãƒˆ', fmt: p => p.ai_comment || '' },
    { label: 'ãƒ¡ãƒ¢', fmt: p => p.user_memo || p.memo || '' },
    { label: 'ç‰©ä»¶URL', fmt: p => p.url || '' },
  ];

  const csvRows = [];
  // ãƒ˜ãƒƒãƒ€ãƒ¼
  csvRows.push(['é …ç›®', ...props.map((_, i) => 'ç‰©ä»¶' + labels[i])].join(','));
  // ãƒ‡ãƒ¼ã‚¿è¡Œ
  for (const row of allKeys) {
    const values = props.map((p, i) => {
      const val = row.fmt(p, i);
      // CSVã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      const str = String(val).replace(/"/g, '""');
      return str.includes(',') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
    });
    csvRows.push([row.label, ...values].join(','));
  }

  const bom = '\uFEFF';
  const blob = new Blob([bom + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (comp.name || 'æ¯”è¼ƒè¡¨') + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// SUUMOæ¤œç´¢URLç”Ÿæˆ
const SUUMO_CITY_CODES = { yokkaichi:'24202', kuwana:'24205', suzuka:'24207', inabe:'24212', kameyama:'24210', komono:'24341', toin:'24343' };
function buildSuumoUrl(areaId, opts = {}) {
  const sc = SUUMO_CITY_CODES[areaId] || '';
  const params = new URLSearchParams({ ar:'060', bs:'030', ta:'24', sc, kb: opts.priceMin || '1', kt: opts.priceMax || '999999', mb: opts.areaMin || '1', mt: opts.areaMax || '999999' });
  if (opts.walkMin) params.set('ek', opts.walkMin);
  return `https://suumo.jp/jj/bukken/ichiran/JJ012FC001/?${params}`;
}
function buildAthomeUrl(areaId, opts = {}) {
  return `https://www.athome.co.jp/tochi/mie/list/?ESSION=true`;
}

// ============================================================
// App State
// ============================================================
const state = {
  savedProperties: [],
  savedComparisons: [],
  soView: null,
  soComparison: null,
  soModalOpen: false,
  soModalType: null,
  soSearchAreaId: null,
  _importUrl: '',
  _aiParsedProperty: null,
  // ä¸€æ‹¬å–ã‚Šè¾¼ã¿ç”¨
  _batchUrls: [''],       // URLå…¥åŠ›æ¬„ã®å€¤ä¸€è¦§
  _batchResults: [],      // [{url, status, parsed, error, saved}]
  _batchProcessing: false,
  _batchCurrentIndex: -1,
  // èªè¨¼UI
  authModalOpen: false,
  authStep: 'email', // 'email' | 'otp'
  authEmail: '',
  authLoading: false,
  authError: '',
  authUser: null, // { id, email, is_anonymous }
  _pendingSaveCompId: null, // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ä¿å­˜ã™ã‚‹æ¯”è¼ƒè¡¨ID
  // ãƒã‚¤ãƒšãƒ¼ã‚¸
  userProfile: null,       // { spouse1_name, spouse1_workplace, ..., priorities[], priorities_freetext }
  _profileLoading: false,
  _profileSaved: false,
};

// ============================================================
// Render
// ============================================================
function render() {
  const app = document.getElementById('app');
  const isMyPage = state.soView === 'mypage';
  app.innerHTML = `
    ${renderHeader()}
    <div class="max-w-6xl mx-auto px-4 py-6">
      ${isMyPage ? '' : renderHeroSection()}
      ${renderPropertyView()}
      ${isMyPage ? '' : renderSEOContent()}
      ${isMyPage ? '' : renderFooter()}
      ${renderSOModal()}
      ${renderAuthModal()}
    </div>
  `;
  bindEvents();
}

function renderHeader() {
  const user = state.authUser;
  const loggedIn = user && !user.is_anonymous && user.email;

  const authHtml = loggedIn
    ? `<div class="flex items-center gap-2">
        <button onclick="state.soView='mypage'; loadUserProfile().then(()=>render());" class="px-2 py-1 text-xs font-medium text-blue-700 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">ãƒã‚¤ãƒšãƒ¼ã‚¸</button>
        <span class="text-xs text-gray-500">${user.email}</span>
        <button onclick="handleLogout()" class="text-xs text-gray-400 hover:text-red-500 transition-colors">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>`
    : `<button onclick="openAuthModal()" class="px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">ãƒ­ã‚°ã‚¤ãƒ³</button>`;

  return `
    <header class="glass border-b border-gray-200">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">ğŸ  æ³¨æ–‡ä½å®… ç‰©ä»¶æ¯”è¼ƒãƒ„ãƒ¼ãƒ«</h1>

              <p class="mt-2 text-sm text-gray-600">
                ä¸‰é‡ã§åœŸåœ°æ¢ã—ä¸­ã®äººå‘ã‘ã€‚ç‰©ä»¶URLã‚’è²¼ã‚‹ã ã‘ã§æƒ…å ±ã‚’æ•´ãˆã¦ã€<b>æ¯”è¼ƒè¡¨</b>ã«ã—ã¾ã™ï¼ˆç„¡æ–™ï¼‰ã€‚
              </p>
              <p class="mt-1 text-sm text-gray-600">
                è¿·ã„ã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆï¼ˆä¾¡æ ¼ãƒ»é¢ç©ãƒ»é§…è·é›¢ãƒ»å­¦åŒº/ãƒã‚¶ãƒ¼ãƒ‰ç­‰ï¼‰ã‚’åŒã˜è»¸ã§è¦‹ãˆã‚‹åŒ–ã—ã¦ã€åˆ¤æ–­ã‚’æ—©ãã—ã¾ã™ã€‚
              </p>

              <div class="mt-4 flex flex-wrap gap-2">
                <a href="area.html" class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">ã‚¨ãƒªã‚¢æ¯”è¼ƒã¸</a>
                <a href="#input-section" class="inline-flex items-center rounded-md bg-gray-100 px-3 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-200">ç‰©ä»¶URLã‚’è²¼ã‚‹</a>
              </div>
            <p class="text-sm text-gray-500 mt-1">æ°—ã«ãªã‚‹ç‰©ä»¶ã‚’AIã§è‡ªå‹•æ•´ç†ã€‚è¤‡æ•°ç‰©ä»¶ã‚’ä¸¦ã¹ã¦æ¯”è¼ƒã§ãã¾ã™</p>
          </div>
          <div class="flex items-center gap-3">
            ${authHtml}
            <a href="area.html" class="hidden sm:block px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors whitespace-nowrap">
              ğŸ“Š ä¸‰é‡çœŒã‚¨ãƒªã‚¢æ¯”è¼ƒ â†’
            </a>
          </div>
        </div>
      </div>
    </header>
  `;
}

function renderHeroSection() {
  // Only show when no properties saved yet
  if (state.savedProperties.length > 0) return '';
  return `
    <div class="card p-6 mb-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200">
      <h2 class="text-xl font-bold text-gray-800 mb-3">æ³¨æ–‡ä½å®…ã®åœŸåœ°é¸ã³ã€ã“ã‚“ãªãŠæ‚©ã¿ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
        <div class="bg-white/80 rounded-lg p-3 border border-gray-100">
          <div class="text-lg mb-1">ğŸ˜µ</div>
          <div class="text-sm text-gray-700">è¤‡æ•°ã‚µã‚¤ãƒˆã®ç‰©ä»¶æƒ…å ±ãŒãƒãƒ©ãƒãƒ©ã§æ¯”è¼ƒã—ã«ãã„</div>
        </div>
        <div class="bg-white/80 rounded-lg p-3 border border-gray-100">
          <div class="text-lg mb-1">ğŸ“</div>
          <div class="text-sm text-gray-700">Excelã«ã¾ã¨ã‚ã‚‹ã®ãŒé¢å€’ã§ã€çµå±€æ„Ÿè¦šã§é¸ã‚“ã§ã—ã¾ã†</div>
        </div>
        <div class="bg-white/80 rounded-lg p-3 border border-gray-100">
          <div class="text-lg mb-1">â“</div>
          <div class="text-sm text-gray-700">ç”¨é€”åœ°åŸŸã‚„å»ºãºã„ç‡ãªã©ã€ç¢ºèªã™ã¹ãé …ç›®ãŒã‚ã‹ã‚‰ãªã„</div>
        </div>
      </div>
      <div class="bg-white rounded-lg p-4 border border-blue-100">
        <h3 class="text-base font-bold text-blue-800 mb-3">ã“ã®ãƒ„ãƒ¼ãƒ«ãŒè§£æ±ºã—ã¾ã™</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="flex items-start gap-2">
            <span class="text-lg">ğŸ¤–</span>
            <div>
              <div class="text-sm font-medium text-gray-800">AIè‡ªå‹•æ•´ç†</div>
              <div class="text-xs text-gray-500">URLã‚’è²¼ã‚‹ã ã‘ã§AIãŒç‰©ä»¶æƒ…å ±ã‚’è‡ªå‹•æŠ½å‡º</div>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <span class="text-lg">ğŸ“‹</span>
            <div>
              <div class="text-sm font-medium text-gray-800">ä¸€è¦§ã§æ¯”è¼ƒ</div>
              <div class="text-xs text-gray-500">SUUMOãƒ»ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ç­‰ã‚’çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§æ¯”è¼ƒ</div>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <span class="text-lg">ğŸ’¡</span>
            <div>
              <div class="text-sm font-medium text-gray-800">AIæ³¨æ„ç‚¹æŒ‡æ‘˜</div>
              <div class="text-xs text-gray-500">æ¯”è¼ƒè¡¨ã‚’AIãŒåˆ†æã—æ³¨æ„ç‚¹ã‚„ãŠã™ã™ã‚ã‚’æŒ‡æ‘˜</div>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
        <p class="text-sm text-amber-800 font-medium">ğŸ“– ä½¿ã„æ–¹ã¯ã‹ã‚“ãŸã‚“3ã‚¹ãƒ†ãƒƒãƒ—</p>
        <div class="flex flex-col sm:flex-row gap-2 mt-2">
          <div class="flex items-center gap-2 text-sm text-gray-700"><span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">1</span>ç‰©ä»¶URLã‚’è²¼ã‚Šä»˜ã‘</div>
          <div class="hidden sm:block text-gray-300">â†’</div>
          <div class="flex items-center gap-2 text-sm text-gray-700"><span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">2</span>AIãŒè‡ªå‹•ã§æ•´ç†</div>
          <div class="hidden sm:block text-gray-300">â†’</div>
          <div class="flex items-center gap-2 text-sm text-gray-700"><span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">3</span>æ¯”è¼ƒè¡¨ã‚’ä½œæˆ</div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Property View
// ============================================================
function renderMyPage() {
  const p = state.userProfile || {};
  const selectedPriorities = p.priorities || [];
  const loading = state._profileLoading;
  const saved = state._profileSaved;

  const priorityCheckboxes = PRIORITY_OPTIONS.map(opt => {
    const checked = selectedPriorities.includes(opt.key) ? 'checked' : '';
    return `<label class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer select-none">
      <input type="checkbox" name="priority" value="${opt.key}" ${checked} class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="width:18px;height:18px;">
      <span class="text-sm text-gray-700">${opt.label}</span>
    </label>`;
  }).join('');

  return `
    <div class="space-y-6">
      <button onclick="state.soView=null; render();" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
        &larr; ç‰©ä»¶ãƒªã‚¹ãƒˆã«æˆ»ã‚‹
      </button>

      <div class="card p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-6">ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>
        <p class="text-sm text-gray-500 mb-6">å‹¤å‹™å…ˆã¨é‡è¦–é …ç›®ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€æ¯”è¼ƒè¡¨ã«ã€Œãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã€ã‚¹ã‚³ã‚¢ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚</p>

        <form id="mypage-form" onsubmit="event.preventDefault(); handleSaveProfile();">
          <!-- ä¸Šéƒ¨ä¿å­˜ãƒœã‚¿ãƒ³ -->
          <div class="flex items-center gap-4 mb-6 pb-4 border-b border-gray-200">
            <button type="submit" ${loading ? 'disabled' : ''} style="padding:12px 32px;background:#2563eb;color:#fff;border-radius:8px;font-weight:700;font-size:1rem;border:none;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
              ${loading ? 'â³ ä¿å­˜ä¸­...' : 'ğŸ’¾ ä¿å­˜ã™ã‚‹'}
            </button>
            ${saved ? '<span class="text-sm text-green-600 font-medium">âœ… ä¿å­˜ã—ã¾ã—ãŸ</span>' : ''}
          </div>
          <!-- å‹¤å‹™å…ˆæƒ…å ± -->
          <div class="mb-8">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold">å‹¤å‹™å…ˆæƒ…å ±</span>
              é€šå‹¤è·é›¢ã‹ã‚‰ã‚¹ã‚³ã‚¢ã‚’ç®—å‡ºã—ã¾ã™
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-600">é…å¶è€… 1</div>
                <div>
                  <label class="text-xs text-gray-500">ãŠåå‰ï¼ˆä»»æ„ï¼‰</label>
                  <input type="text" id="spouse1_name" value="${p.spouse1_name || ''}" placeholder="ä¾‹: å¤ªéƒ" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                  <label class="text-xs text-gray-500">å‹¤å‹™å…ˆã®ä½æ‰€</label>
                  <input type="text" id="spouse1_workplace" value="${p.spouse1_workplace || ''}" placeholder="ä¾‹: ä¸‰é‡çœŒå››æ—¥å¸‚å¸‚è«è¨ªç”º1-5" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                ${p.spouse1_lat ? `<div class="text-xs text-green-600">åº§æ¨™å–å¾—æ¸ˆã¿</div>` : ''}
              </div>
              <div class="space-y-3 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-600">é…å¶è€… 2</div>
                <div>
                  <label class="text-xs text-gray-500">ãŠåå‰ï¼ˆä»»æ„ï¼‰</label>
                  <input type="text" id="spouse2_name" value="${p.spouse2_name || ''}" placeholder="ä¾‹: èŠ±å­" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                  <label class="text-xs text-gray-500">å‹¤å‹™å…ˆã®ä½æ‰€</label>
                  <input type="text" id="spouse2_workplace" value="${p.spouse2_workplace || ''}" placeholder="ä¾‹: ä¸‰é‡çœŒæ´¥å¸‚æ „ç”º1-891" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                ${p.spouse2_lat ? `<div class="text-xs text-green-600">åº§æ¨™å–å¾—æ¸ˆã¿</div>` : ''}
              </div>
            </div>
          </div>

          <!-- é‡è¦–é …ç›® -->
          <div class="mb-8">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold">é‡è¦–é …ç›®</span>
              åœŸåœ°ã«æ±‚ã‚ã‚‹æ¡ä»¶ã‚’é¸ã‚“ã§ãã ã•ã„
            </h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-1">
              ${priorityCheckboxes}
            </div>
            <div class="mt-4">
              <label class="text-xs text-gray-500">ãã®ä»–ãƒ»è‡ªç”±è¨˜è¿°</label>
              <textarea id="priorities_freetext" rows="2" placeholder="ä¸Šè¨˜ä»¥å¤–ã«é‡è¦–ã™ã‚‹ã“ã¨ãŒã‚ã‚Œã°è¨˜å…¥ã—ã¦ãã ã•ã„" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${p.priorities_freetext || ''}</textarea>
            </div>
          </div>

          <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
          <div class="flex items-center gap-4 pt-4 border-t border-gray-200">
            <button type="submit" ${loading ? 'disabled' : ''} style="padding:12px 32px;background:#2563eb;color:#fff;border-radius:8px;font-weight:700;font-size:1rem;border:none;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
              ${loading ? 'â³ ä¿å­˜ä¸­...' : 'ğŸ’¾ ä¿å­˜ã™ã‚‹'}
            </button>
            ${saved ? '<span class="text-sm text-green-600 font-medium animate-pulse">âœ… ä¿å­˜ã—ã¾ã—ãŸ</span>' : ''}
          </div>
          <p class="text-xs text-gray-400 mt-3">ç™»éŒ²ã—ãŸå†…å®¹ã¯æ¯”è¼ƒè¡¨ã®ã€ŒğŸ¡ ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã€ã‚¹ã‚³ã‚¢ã«åæ˜ ã•ã‚Œã¾ã™</p>
        </form>
      </div>
    </div>
  `;
}

function handleSaveProfile() {
  const form = document.getElementById('mypage-form');
  if (!form) return;
  const checkedPriorities = Array.from(form.querySelectorAll('input[name="priority"]:checked')).map(el => el.value);
  const profileData = {
    spouse1_name: document.getElementById('spouse1_name')?.value?.trim() || null,
    spouse1_workplace: document.getElementById('spouse1_workplace')?.value?.trim() || null,
    spouse2_name: document.getElementById('spouse2_name')?.value?.trim() || null,
    spouse2_workplace: document.getElementById('spouse2_workplace')?.value?.trim() || null,
    priorities: checkedPriorities,
    priorities_freetext: document.getElementById('priorities_freetext')?.value?.trim() || null,
  };
  saveUserProfile(profileData);
}

function renderPropertyView() {
  // ãƒã‚¤ãƒšãƒ¼ã‚¸
  if (state.soView === 'mypage') {
    return renderMyPage();
  }

  const savedCount = state.savedProperties.length;
  const compProps = state.savedProperties.filter(p => p.in_comparison);

  // Sub-view: comparison table with sidebar
  if (state.soView === 'compare' && state.soComparison) {
    return renderComparisonWithSidebar();
  }

  const hasSavedComps = state.savedComparisons.length > 0;

  const mainContent = `
    <div class="space-y-4">
      <!-- ã‚µã‚¤ãƒˆèª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="card p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200">
        <h2 class="text-lg font-bold text-gray-800 mb-3">ğŸ“Š ç‰©ä»¶æ¯”è¼ƒãƒ„ãƒ¼ãƒ«ã¨ã¯ï¼Ÿ</h2>
        <p class="text-sm text-gray-700 leading-relaxed mb-4">
          æ°—ã«ãªã‚‹ç‰©ä»¶ã®æƒ…å ±ã‚’AIãŒè‡ªå‹•ã§æ•´ç†ãƒ»æ§‹é€ åŒ–ã€‚è¤‡æ•°ã®ç‰©ä»¶ã‚’ä¸¦ã¹ã¦æ¯”è¼ƒã—ã€æœ€é©ãªåœŸåœ°é¸ã³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="bg-white/80 rounded-lg p-3 border border-blue-100">
            <div class="text-lg mb-1">ğŸ¤–</div>
            <div class="text-sm font-medium text-gray-800 mb-1">AIè‡ªå‹•æ•´ç†</div>
            <div class="text-xs text-gray-500">ç‰©ä»¶URLã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚‹ã ã‘ã§ã€AIãŒä¾¡æ ¼ãƒ»é¢ç©ãƒ»ç«‹åœ°ãªã©é‡è¦é …ç›®ã‚’è‡ªå‹•ã§æŠ½å‡ºãƒ»æ•´ç†ã—ã¾ã™</div>
          </div>
          <div class="bg-white/80 rounded-lg p-3 border border-blue-100">
            <div class="text-lg mb-1">ğŸ“‹</div>
            <div class="text-sm font-medium text-gray-800 mb-1">ä¸€è¦§ã§æ¯”è¼ƒ</div>
            <div class="text-xs text-gray-500">SUUMOãƒ»ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ç­‰ã®è¤‡æ•°ã‚µã‚¤ãƒˆã®ç‰©ä»¶ã‚’çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ä¸€è¦§æ¯”è¼ƒã€‚è¦‹è½ã¨ã—ã‚’é˜²ãã¾ã™</div>
          </div>
          <div class="bg-white/80 rounded-lg p-3 border border-blue-100">
            <div class="text-lg mb-1">ğŸ’¡</div>
            <div class="text-sm font-medium text-gray-800 mb-1">AIãŒæ³¨æ„ç‚¹ã‚’æŒ‡æ‘˜</div>
            <div class="text-xs text-gray-500">æ¯”è¼ƒè¡¨ã‚’AIãŒåˆ†æã—ã€å„ç‰©ä»¶ã®æ³¨æ„ç‚¹ã‚„ãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆã€‚åˆ¤æ–­ææ–™ãŒå¢—ãˆã¾ã™</div>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-800">ğŸ  ä¿å­˜ã—ãŸç‰©ä»¶${savedCount > 0 ? `ï¼ˆ${savedCount}ä»¶ï¼‰` : ''}</h2>
        ${savedCount > 0 ? `<div class="flex gap-2">
          <button onclick="clearAllProperties()" class="text-xs text-gray-400 hover:text-red-500 transition-colors">å…¨ä»¶å‰Šé™¤</button>
        </div>` : ''}
      </div>

      <!-- ç‰©ä»¶å–ã‚Šè¾¼ã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
      <div class="card p-5 space-y-3 border-green-200 bg-green-50/30">
        <h3 class="text-sm font-bold text-gray-700">ğŸ¤– ç‰©ä»¶æƒ…å ±ã‚’AIã§å–ã‚Šè¾¼ã¿</h3>
        <p class="text-xs text-gray-500">ä¸å‹•ç”£ã‚µã‚¤ãƒˆã®ç‰©ä»¶ãƒšãƒ¼ã‚¸URLã‚’è²¼ã‚Šä»˜ã‘ã¦AIå–ã‚Šè¾¼ã¿ã€‚<span class="text-green-600 font-medium">è¤‡æ•°ä»¶ã¾ã¨ã‚ã¦å–ã‚Šè¾¼ã¿OKï¼</span></p>
        <div class="flex gap-2">
          <input id="url-import-property" type="url" placeholder="ç‰©ä»¶URLã‚’è²¼ã‚Šä»˜ã‘ï¼ˆhttps://suumo.jp/...ï¼‰" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" />
          <button onclick="openImportModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors whitespace-nowrap">
            ğŸ¤– AIå–ã‚Šè¾¼ã¿
          </button>
        </div>
      </div>

      ${savedCount === 0 ? `
        <div class="card p-8 text-center">
          <div class="text-4xl mb-3">ğŸ </div>
          <p class="text-gray-600 font-medium mb-2">ã¾ã ç‰©ä»¶ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
          <p class="text-sm text-gray-400">ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç‰©ä»¶URLã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚’å–ã‚Šè¾¼ã‚“ã§<br>ä¿å­˜ãƒ»æ¯”è¼ƒã§ãã¾ã™</p>
        </div>
      ` : `
        <div class="grid grid-cols-1 gap-3">
          ${state.savedProperties.map(prop => {
            const badgeClass = prop.badge === 'red' ? 'so-badge-red' : prop.badge === 'yellow' ? 'so-badge-yellow' : 'so-badge-none';
            const badgeLabel = prop.badge === 'red' ? 'ğŸ”´ æ³¨æ„' : prop.badge === 'yellow' ? 'ğŸŸ¡ è¦ç¢ºèª' : 'ğŸŸ¢ OK';
            const areaName = AREAS.find(a => a.id === prop.area_id)?.name || (prop.address ? AREAS.find(a => prop.address.includes(a.name))?.name : '') || '';
            const priceStr = prop.price ? `${(prop.price / 10000).toLocaleString()}ä¸‡å††` : 'ä¾¡æ ¼æœªå…¥åŠ›';
            const tsuboPriceStr = (prop.price && prop.land_area) ? `ï¼ˆåª${(prop.price / (prop.land_area / 3.305785) / 10000).toFixed(1)}ä¸‡ï¼‰` : '';
            const areaStr = prop.land_area ? `${(prop.land_area / 3.305785).toFixed(1)}åªï¼ˆ${prop.land_area}ã¡ï¼‰` : 'é¢ç©æœªå…¥åŠ›';
            // ä½ç½®ç²¾åº¦ãƒãƒƒã‚¸
            const geoConf = prop.geo_confidence;
            const geoBadge = geoConf === 'high' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#dcfce7;color:#166534;border:1px solid #86efac;">ğŸ“ é«˜ç²¾åº¦</span>'
              : geoConf === 'medium' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fef9c3;color:#854d0e;border:1px solid #fde047;">ğŸ“ ä¸­ç²¾åº¦</span>'
              : geoConf === 'low' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;">ğŸ“ ä½ç²¾åº¦</span>'
              : '';
            const mapLink = (prop.lat && prop.lng) ? `<a href="https://www.google.com/maps?q=${prop.lat},${prop.lng}" target="_blank" rel="noopener" class="text-xs text-green-600 hover:underline">ğŸ—ºï¸ åœ°å›³ã§ç¢ºèª</a>` : '';
            // enrichmentã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            const enrichBadge = prop.enrichment_status === 'done' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#dbeafe;color:#1e40af;border:1px solid #93c5fd;">âœ… è©³ç´°æƒ…å ±ã‚ã‚Š</span>'
              : prop.enrichment_status === 'pending' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fef3c7;color:#92400e;border:1px solid #fbbf24;">â³ è©³ç´°å–å¾—ä¸­</span>'
              : prop.enrichment_status === 'error' ? '<span style="font-size:10px;padding:1px 6px;border-radius:9999px;background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;">âŒ å–å¾—å¤±æ•—</span>'
              : '';
            // enrichmentãƒœã‚¿ãƒ³è¡¨ç¤ºæ¡ä»¶
            const canEnrich = prop.lat && prop.lng && !prop.enrichment_status;
            const canRetryEnrich = prop.lat && prop.lng && prop.enrichment_status === 'error';
            // enrichmentè©³ç´°è¡¨ç¤º + ã‚¹ã‚³ã‚¢
            const enrichDetails = prop.enrichment_status === 'done' ? (() => {
              const scores = calculateScores(prop, state.userProfile);
              const lifestyleBar = scores && scores.score_lifestyle != null ? renderScoreBar('ãƒ©ã‚¤ãƒ•', scores.score_lifestyle) : '';
              const scoreSection = scores ? '<div class="grid grid-cols-2 gap-1 mb-2">' +
                renderScoreBar('å®‰å…¨', scores.score_safety) +
                renderScoreBar('åˆ©ä¾¿', scores.score_convenience) +
                renderScoreBar('ã‚³ã‚¹ãƒˆ', scores.score_cost) +
                lifestyleBar +
                '<div class="flex items-center gap-2 text-xs"><span class="text-gray-500 w-12">ç·åˆ</span><div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden"><div class="h-full rounded-full" style="width:' + scores.score_total + '%;background:' + getScoreColor(scores.score_total) + ';"></div></div><span class="font-bold" style="color:' + getScoreColor(scores.score_total) + ';">' + scores.score_total + '</span></div>' +
                '</div>' : '';
              const items = [];
              if (prop.school_elementary) items.push('ğŸ« ' + prop.school_elementary);
              if (prop.school_junior_high) items.push('ğŸ« ' + prop.school_junior_high);
              if (prop.nearest_supermarket) items.push('ğŸ›’ ' + prop.nearest_supermarket);
              if (prop.nearest_hospital) items.push('ğŸ¥ ' + prop.nearest_hospital);
              if (prop.nearest_park) items.push('ğŸŒ³ ' + prop.nearest_park);
              if (prop.hazard_flood) items.push('ğŸŒŠ æ´ªæ°´: ' + prop.hazard_flood);
              if (prop.hazard_sediment) items.push('â›°ï¸ åœŸç ‚: ' + prop.hazard_sediment);
              if (prop.ground_type) items.push('ğŸª¨ åœ°ç›¤: ' + prop.ground_type);
              if (prop.ai_comment) items.push('ğŸ’¬ ' + prop.ai_comment);
              // è¿½åŠ ã‚³ã‚¹ãƒˆè¦å› ã®è¡¨ç¤º
              const costReasonHtml = (prop.extra_cost_reasons && prop.extra_cost_score != null && prop.extra_cost_score < 0)
                ? '<div class="mt-1 p-1.5 bg-amber-50 rounded border border-amber-200">' +
                  '<div class="text-xs font-medium text-amber-800 mb-0.5">ğŸ’° è¿½åŠ ã‚³ã‚¹ãƒˆè¦å› ï¼ˆ' + Math.abs(prop.extra_cost_score) + 'ç‚¹æ¸›ç‚¹ï¼‰</div>' +
                  '<div class="text-xs text-amber-700">' + prop.extra_cost_reasons.split('ã€').map(r => 'ãƒ»' + r.trim()).join('<br>') + '</div>' +
                  '</div>' : '';
              // ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã‚¹ã‚³ã‚¢æ ¹æ‹ 
              const lifestyleReasons = getLifestyleBreakdown(prop, state.userProfile);
              const lifestyleReasonHtml = (lifestyleReasons && lifestyleReasons.length > 0)
                ? '<div class="mt-1 p-1.5 bg-blue-50 rounded border border-blue-200">' +
                  '<div class="text-xs font-medium text-blue-800 mb-0.5">ğŸ¡ ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«æ ¹æ‹ ï¼ˆã‚¹ã‚³ã‚¢ ' + (scores ? scores.score_lifestyle : '-') + 'ï¼‰</div>' +
                  '<div class="text-xs text-blue-700">' + lifestyleReasons.map(r => 'ãƒ»' + r).join('<br>') + '</div>' +
                  '</div>' : '';
              return (scoreSection || items.length > 0 || costReasonHtml || lifestyleReasonHtml) ? '<div class="mt-2 p-2 bg-blue-50 rounded border border-blue-100 space-y-1">' +
                scoreSection +
                items.map(i => '<div class="text-xs text-gray-600">' + i + '</div>').join('') +
                costReasonHtml +
                lifestyleReasonHtml +
                '</div>' : '';
            })() : '';
            return `
              <div class="card p-4">
                <div class="flex items-start justify-between">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                      <span class="${badgeClass}" style="font-size:11px;padding:2px 8px;border-radius:9999px;">${badgeLabel}</span>
                      ${geoBadge}
                      ${enrichBadge}
                      ${areaName ? `<span class="text-xs text-gray-400">${areaName}</span>` : ''}
                    </div>
                    <div class="text-sm font-medium text-gray-800">${prop.address || 'ä½æ‰€æœªå…¥åŠ›'}</div>
                    <div class="flex items-center gap-3 mt-1 text-sm">
                      <span class="font-bold text-blue-700">${priceStr}</span><span class="text-xs text-gray-400">${tsuboPriceStr}</span>
                      <span class="text-gray-500">${areaStr}</span>
                    </div>
                    ${prop.station_distance ? `<div class="text-xs text-gray-400 mt-1">ğŸšƒ ${prop.station_distance}</div>` : ''}
                    ${prop.user_memo ? `<div class="text-xs text-gray-500 mt-1 bg-green-50 rounded px-2 py-1">ğŸ“ ${prop.user_memo}</div>` : (prop.memo ? `<div class="text-xs text-gray-500 mt-1 bg-gray-50 rounded px-2 py-1">ğŸ’¡ ${prop.memo}</div>` : '')}
                    <div class="flex items-center gap-3 mt-1">
                      ${prop.url ? `<a href="${prop.url}" target="_blank" rel="noopener" class="text-xs text-blue-500 hover:underline">ğŸ”— ç‰©ä»¶ãƒšãƒ¼ã‚¸</a>` : ''}
                      ${mapLink}
                    </div>
                    ${enrichDetails}
                  </div>
                  <div class="flex flex-col gap-1 ml-3">
                    <button onclick="handleToggleComparison('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border transition-colors ${prop.in_comparison ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-600 border-gray-300 hover:bg-blue-50'}">
                      ${prop.in_comparison ? 'âœ“ æ¯”è¼ƒä¸­' : 'æ¯”è¼ƒã«è¿½åŠ '}
                    </button>
                    ${canEnrich || canRetryEnrich ? `<button onclick="handleEnrichProperty('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border border-purple-200 text-purple-600 hover:bg-purple-50 transition-colors">ğŸ” è©³ç´°å–å¾—</button>` : ''}
                    <button onclick="handleDeleteProperty('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border border-gray-200 text-gray-400 hover:text-red-500 hover:border-red-300 transition-colors">å‰Šé™¤</button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        ${compProps.length > 0 ? `
          <div class="card p-4 bg-blue-50 border-blue-200">
            <div class="flex items-center justify-between">
              <div>
                <span class="text-sm font-medium text-blue-800">ğŸ“Š æ¯”è¼ƒã«è¿½åŠ : ${compProps.length}ä»¶</span>
                <span class="text-xs text-blue-500 ml-2">${compProps.length < 2 ? 'ï¼ˆ2ä»¶ä»¥ä¸Šã§æ¯”è¼ƒå¯èƒ½ï¼‰' : ''}</span>
              </div>
              <button onclick="handleGenerateComparison()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors ${compProps.length < 2 ? 'opacity-50 cursor-not-allowed' : ''}" ${compProps.length < 2 ? 'disabled' : ''}>
                æ¯”è¼ƒè¡¨ã‚’ä½œæˆ
              </button>
            </div>
          </div>
        ` : ''}
      `}
    </div>
  `;

  // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚ã‚Šï¼ˆéå»ã®æ¯”è¼ƒè¡¨ãŒã‚ã‚‹å ´åˆï¼‰
  if (hasSavedComps) {
    return `
      <div class="flex gap-4 fade-in comp-layout-sidebar">
        ${renderComparisonSidebar()}
        <div class="flex-1 min-w-0">${mainContent}</div>
      </div>
    `;
  }
  // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãªã—
  return `<div class="fade-in">${mainContent}</div>`;
}

// ============================================================
// Second Opinion: Comparison Table
// ============================================================
function renderComparisonSidebar() {
  const comps = state.savedComparisons;
  const currentId = state.soComparison?.id;
  const isCompareView = state.soView === 'compare' && state.soComparison;

  return `
    <div class="flex-shrink-0" style="width:220px;">
      <div class="card p-3 sticky" style="top:1rem;">
        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">ğŸ“‚ æ¯”è¼ƒè¡¨ä¸€è¦§</h3>
        ${isCompareView ? `
          <button onclick="state.soView=null; state.soComparison=null; render();" class="w-full mb-3 px-3 py-2 text-xs bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors text-left">
            â† ç‰©ä»¶ãƒªã‚¹ãƒˆã«æˆ»ã‚‹
          </button>
        ` : ''}
        <div class="space-y-1 max-h-96 overflow-y-auto">
          ${comps.length === 0 ? `<p class="text-xs text-gray-400 py-2">æ¯”è¼ƒè¡¨ã‚’ä½œæˆã™ã‚‹ã¨<br>ã“ã“ã«ä¸€è¦§è¡¨ç¤ºã•ã‚Œã¾ã™</p>` : ''}
          ${comps.map(c => {
            const isActive = isCompareView && c.id === currentId;
            const dateStr = c.created_at ? new Date(c.created_at).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }) : '';
            return `
              <div class="group rounded-lg p-2 cursor-pointer transition-colors ${isActive ? 'bg-blue-50 border border-blue-200' : 'hover:bg-gray-50 border border-transparent'}" onclick="loadComparisonDetail('${c.id}')">
                <div class="flex items-start justify-between gap-1">
                  <div class="flex-1 min-w-0">
                    <div class="text-xs font-medium ${isActive ? 'text-blue-700' : 'text-gray-700'} truncate">${c.name || 'æ¯”è¼ƒè¡¨'}</div>
                    <div class="text-xs text-gray-400">${dateStr} Â· ${(c.property_ids||[]).length}ä»¶</div>
                  </div>
                  <button onclick="event.stopPropagation(); handleDeleteComparison('${c.id}')" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 text-xs transition-opacity" title="å‰Šé™¤">âœ•</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

function renderComparisonWithSidebar() {
  return `
    <div class="flex gap-4 fade-in comp-layout-sidebar" style="min-height:60vh;">
      ${renderComparisonSidebar()}
      <div class="flex-1 min-w-0">
        ${renderComparisonTable()}
      </div>
    </div>
  `;
}

function renderComparisonTable() {
  const comp = state.soComparison;
  if (!comp) return '';
  const props = comp.properties || [];
  if (props.length === 0) return '';

  const labels = ['A','B','C','D','E'];

  // editable=true ã®ã‚»ãƒ«ã¯ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†å¯èƒ½ï¼ˆãƒ†ã‚­ã‚¹ãƒˆå‹ï¼‰
  // editable='number' ã¯ä¸‡å††å˜ä½ã®æ•°å€¤å…¥åŠ›
  const rows = [
    { label: 'ä¾¡æ ¼', key: 'price', fmt: v => v ? `${(v/10000).toLocaleString()}ä¸‡å††` : 'â€”', editable: 'price' },
    { label: 'åœŸåœ°é¢ç©', key: 'land_area', fmt: v => v ? `${(v/3.305785).toFixed(1)}åªï¼ˆ${v}ã¡ï¼‰` : 'â€”', editable: 'area' },
    { label: 'åªå˜ä¾¡', key: '_tsubo', fmt: (v, p) => p.price && p.land_area ? `${(p.price / (p.land_area / 3.305785) / 10000).toFixed(1)}ä¸‡å††/åª` : 'â€”' },
    { label: 'æ‰€åœ¨åœ°', key: 'address', fmt: v => v || 'â€”', editable: true },
    { label: 'é§…è·é›¢', key: 'station_distance', fmt: v => v || 'â€”', editable: true },
  ];
  const checkRows = [
    { label: 'ç”¨é€”åœ°åŸŸ', key: 'zoning', editable: true },
    { label: 'å»ºãºã„ç‡', key: 'building_coverage', editable: true },
    { label: 'å®¹ç©ç‡', key: 'floor_area_ratio', editable: true },
    { label: 'æ¥é“', key: 'road_access', editable: true },
    { label: 'é«˜ä½å·®/é€ æˆ', key: 'elevation', editable: true },
    { label: 'ã‚¤ãƒ³ãƒ•ãƒ©', key: 'infrastructure', editable: true },
    { label: 'ãƒã‚¶ãƒ¼ãƒ‰', key: 'hazard', editable: true },
  ];

  function editableCell(prop, key, displayVal, editType) {
    const propId = prop.id;
    const escaped = (typeof displayVal === 'string' ? displayVal : String(displayVal || '')).replace(/"/g, '&quot;');
    const editHint = editType ? ' title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†" style="cursor:pointer;border-bottom:1px dashed #cbd5e1;"' : '';
    if (!editType) return `<td class="p-3 text-sm text-gray-800">${displayVal}</td>`;
    return `<td class="p-3 text-sm text-gray-800 hover:bg-blue-50 transition-colors" onclick="startCellEdit(this, '${propId}', '${key}', '${editType}')"${editHint}>${displayVal}<span class="text-gray-300 text-xs ml-1">âœï¸</span></td>`;
  }

  let questions = [];
  try { questions = typeof comp.questions === 'string' ? JSON.parse(comp.questions) : (comp.questions || []); } catch(e) { questions = []; }
  if (typeof questions === 'string') questions = questions.split('\n').filter(q => q.trim());

  return `
    <div class="space-y-4 fade-in">
      <div class="flex items-center gap-3 flex-wrap">
        <h2 class="text-lg font-bold text-gray-800">ğŸ“Š</h2>
        <span id="comp-name-display" class="text-lg font-bold text-gray-800 cursor-pointer hover:text-blue-600 border-b border-dashed border-gray-300" onclick="startCompNameEdit()" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦åå‰ã‚’å¤‰æ›´">${comp.name || 'æ¯”è¼ƒè¡¨'}</span>
        <span class="text-xs text-gray-400">ï¼ˆã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†å¯èƒ½ï¼‰</span>
        <button onclick="exportComparisonCSV()" class="ml-auto px-3 py-1 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 transition-colors">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>

      ${comp.summary ? `
        <div class="card p-4 bg-blue-50 border-blue-200">
          <h3 class="text-sm font-bold text-blue-800 mb-2">ğŸ’¡ AIã‚µãƒãƒª</h3>
          <p class="text-sm text-gray-700 leading-relaxed">${comp.summary}</p>
        </div>
      ` : ''}

      ${comp._unsaved ? `
        <div class="card p-4 bg-green-50 border-green-200" style="border:1px solid #86efac;">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <span class="text-sm font-bold text-green-800">ã“ã®æ¯”è¼ƒè¡¨ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ</span>
              <p class="text-xs text-green-600 mt-0.5">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã™ã‚‹ã¨ã€æ¬¡å›ä»¥é™ã‚‚ã“ã®æ¯”è¼ƒè¡¨ã‚’ç¢ºèªã§ãã¾ã™</p>
            </div>
            <button onclick="openAuthModal(); state._pendingSaveCompId='${comp.id}';" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
              ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã—ã¦ä¿å­˜
            </button>
          </div>
        </div>
      ` : ''}

      <div class="card overflow-x-auto">
        <table class="so-compare-table">
          <thead>
            <tr>
              <th class="text-left p-3 bg-gray-50 text-xs text-gray-500 font-medium" style="min-width:80px;"></th>
              ${props.map((p,i) => `
                <th class="p-3 bg-gray-50 text-sm font-bold text-gray-800" style="min-width:140px;">
                  ç‰©ä»¶${labels[i]}<br><span class="text-xs font-normal text-gray-400">${AREAS.find(a=>a.id===p.area_id)?.name || (p.address ? AREAS.find(a=>p.address.includes(a.name))?.name : '') || ''}</span>
                  ${p.url ? `<br><a href="${p.url}" target="_blank" rel="noopener" class="text-xs text-blue-500 font-normal hover:underline">ğŸ”— ç‰©ä»¶ãƒšãƒ¼ã‚¸</a>` : ''}
                </th>
              `).join('')}
            </tr>
          </thead>
          <tbody>
            ${(() => {
              if (!props.some(p => p.enrichment_status === 'done')) return '';
              const allScores = props.map(p => calculateScores(p, state.userProfile));
              const maxTotal = Math.max(...allScores.map(s => s ? s.score_total : 0));
              const hasLifestyle = allScores.some(s => s && s.score_lifestyle !== null);
              const scoreKeys = ['score_safety','score_convenience','score_cost'];
              if (hasLifestyle) scoreKeys.push('score_lifestyle');
              const labelMap = {score_safety:'ğŸ›¡ï¸ å®‰å…¨', score_convenience:'ğŸª åˆ©ä¾¿', score_cost:'ğŸ’° ã‚³ã‚¹ãƒˆ', score_lifestyle:'ğŸ¡ ãƒ©ã‚¤ãƒ•'};
              const scoreRows = scoreKeys.map(key => {
                const maxCat = Math.max(...allScores.map(s => s && s[key] != null ? s[key] : 0));
                return '<tr>' +
                  '<td class="p-2 text-xs font-medium text-gray-500 bg-gray-50">' + labelMap[key] + '</td>' +
                  props.map((p, i) => {
                    const s = allScores[i];
                    if (!s || s[key] == null) return '<td class="p-2 text-center text-xs text-gray-300">â€”</td>';
                    const v = s[key];
                    const color = getScoreColor(v);
                    const isBest = v === maxCat && maxCat > 0;
                    return '<td class="p-2 text-center">' +
                      '<div style="display:inline-flex;align-items:center;gap:4px;">' +
                      '<div style="width:50px;height:6px;background:#e5e7eb;border-radius:9999px;overflow:hidden;"><div style="height:100%;border-radius:9999px;width:' + v + '%;background:' + color + ';"></div></div>' +
                      '<span class="text-xs font-semibold" style="color:' + color + ';">' + v + '</span>' +
                      (isBest ? '<span style="font-size:9px;">â˜…</span>' : '') +
                      '</div></td>';
                  }).join('') + '</tr>';
              }).join('');
              const lifestyleBadge = hasLifestyle ? '<span class="text-xs text-purple-500 ml-2">ğŸ¡ ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã‚¹ã‚³ã‚¢ã‚ã‚Š</span>' : '';
              return '<tr><td colspan="' + (props.length + 1) + '" class="p-2 bg-purple-50"><span class="text-xs font-bold text-purple-700">ğŸ“ˆ ã‚¹ã‚³ã‚¢æ¯”è¼ƒ</span>' + lifestyleBadge + '</td></tr>' +
                '<tr style="border-bottom:2px solid #e5e7eb;">' +
                '<td class="p-2 text-xs font-bold text-gray-600 bg-gray-50">ç·åˆ</td>' +
                props.map((p, i) => {
                  const s = allScores[i];
                  if (!s) return '<td class="p-2 text-center text-xs text-gray-300">â€”</td>';
                  const isBest = s.score_total === maxTotal && maxTotal > 0;
                  return '<td class="p-2 text-center">' +
                    '<div style="text-align:center;font-size:1.5rem;font-weight:900;color:' + getScoreColor(s.score_total) + ';">' + s.score_total +
                    (isBest ? '<span style="font-size:0.75rem;margin-left:2px;">ğŸ‘‘</span>' : '') + '</div></td>';
                }).join('') + '</tr>' + scoreRows;
            })()}
            ${rows.map(r => `
              <tr>
                <td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">${r.label}</td>
                ${props.map(p => editableCell(p, r.key, r.fmt(p[r.key], p), r.editable)).join('')}
              </tr>
            `).join('')}
            ${props.some(p => p.ai_comment) ? `
            <tr>
              <td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">ğŸ’¬ AIã‚³ãƒ¡ãƒ³ãƒˆ</td>
              ${props.map(p => `<td class="p-3 text-xs text-gray-700">${p.ai_comment || '<span class="text-gray-300">â€”</span>'}</td>`).join('')}
            </tr>
            ` : ''}
            <tr><td colspan="${props.length+1}" class="p-2 bg-amber-50"><span class="text-xs font-bold text-amber-700">âš ï¸ é‡è¦ç¢ºèªé …ç›®ï¼ˆä¸å‹•ç”£å±‹ã«ç¢ºèªï¼‰</span></td></tr>
            ${checkRows.map(r => `
              <tr>
                <td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">${r.label}</td>
                ${props.map(p => {
                  const val = p[r.key];
                  const display = val ? val : 'ğŸŸ¡ ä¸æ˜';
                  const cls = val ? 'text-gray-800' : 'text-amber-600';
                  return `<td class="p-3 text-sm ${cls} hover:bg-blue-50 transition-colors" onclick="startCellEdit(this, '${p.id}', '${r.key}', true)" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†" style="cursor:pointer;border-bottom:1px dashed #cbd5e1;">${display}<span class="text-gray-300 text-xs ml-1">âœï¸</span></td>`;
                }).join('')}
              </tr>
            `).join('')}
            <!-- AIè©³ç´°æƒ…å ±ï¼ˆenrichmentï¼‰ -->
            ${props.some(p => p.enrichment_status === 'done') || props.some(p => p.lat && p.lng) ? `
              <tr><td colspan="${props.length+1}" class="p-2 bg-blue-50"><span class="text-xs font-bold text-blue-700">ğŸ” AIè‡ªå‹•å–å¾—æƒ…å ±ï¼ˆå‘¨è¾ºç’°å¢ƒãƒ»ãƒã‚¶ãƒ¼ãƒ‰ï¼‰</span></td></tr>
              ${[
                { label: 'å°å­¦æ ¡åŒº', key: 'school_elementary' },
                { label: 'ä¸­å­¦æ ¡åŒº', key: 'school_junior_high' },
                { label: 'æœ€å¯„ã‚¹ãƒ¼ãƒ‘ãƒ¼', key: 'nearest_supermarket' },
                { label: 'æœ€å¯„ç—…é™¢', key: 'nearest_hospital' },
                { label: 'æœ€å¯„å…¬åœ’', key: 'nearest_park' },
                { label: 'æœ€å¯„ä¿è‚²åœ’', key: 'nearest_nursery' },
                { label: 'æ´ªæ°´ãƒªã‚¹ã‚¯', key: 'hazard_flood' },
                { label: 'åœŸç ‚ç½å®³', key: 'hazard_sediment' },
                { label: 'æ´¥æ³¢ãƒªã‚¹ã‚¯', key: 'hazard_tsunami' },
                { label: 'åœ°ç›¤', key: 'ground_type' },
              ].map(r => {
                return '<tr><td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">' + r.label + '</td>' +
                  props.map(p => {
                    const val = p[r.key];
                    if (p.enrichment_status === 'done') {
                      return '<td class="p-3 text-xs text-gray-700">' + (val || '<span class="text-gray-300">\u2014</span>') + '</td>';
                    } else if (p.enrichment_status === 'pending') {
                      return '<td class="p-3 text-xs text-amber-500">\u23f3 å–å¾—ä¸­...</td>';
                    } else if (p.lat && p.lng) {
                      return '<td class="p-3 text-xs"><button onclick="handleEnrichProperty(' + "'" + p.id + "'" + ')" class="text-blue-500 hover:underline text-xs">\ud83d\udd0d å–å¾—ã™ã‚‹</button></td>';
                    } else {
                      return '<td class="p-3 text-xs text-gray-300">ä½ç½®æƒ…å ±ãªã—</td>';
                    }
                  }).join('') + '</tr>';
              }).join('')}
            ` : ''}
            <!-- ãƒ¡ãƒ¢è¡Œ -->
            <tr><td colspan="${props.length+1}" class="p-2 bg-green-50"><span class="text-xs font-bold text-green-700">ğŸ“ ãƒ¡ãƒ¢ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</span></td></tr>
            <tr>
              <td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">ãƒ¡ãƒ¢</td>
              ${props.map(p => `
                <td class="p-2">
                  <textarea class="w-full px-2 py-1 border border-gray-200 rounded text-sm text-gray-700 focus:border-blue-400 focus:ring-1 focus:ring-blue-200 outline-none" rows="3" placeholder="è‡ªç”±ã«ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." onblur="handleMemoEdit('${p.id}', this.value)" style="resize:vertical;">${p.user_memo || p.memo || ''}</textarea>
                </td>
              `).join('')}
            </tr>
          </tbody>
        </table>
      </div>

      ${questions.length > 0 ? `
        <div class="card p-4">
          <h3 class="text-sm font-bold text-gray-800 mb-3">ğŸ“‹ ç¢ºèªè³ªå•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
          <div class="space-y-2">
            ${questions.map((q,i) => `
              <label class="flex items-start gap-2 text-sm text-gray-700">
                <input type="checkbox" class="mt-1 so-question-check" />
                <span>${typeof q === 'object' ? q.text || q.question || JSON.stringify(q) : q}</span>
              </label>
            `).join('')}
          </div>
          <button onclick="copyQuestions()" class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition-colors">ğŸ“‹ è³ªå•ã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
      ` : ''}
    </div>
  `;
}

function copyQuestions() {
  const checks = document.querySelectorAll('.so-question-check');
  const texts = [];
  checks.forEach((cb, i) => {
    const label = cb.parentElement?.querySelector('span')?.textContent;
    if (label) texts.push(`${cb.checked ? 'âœ…' : 'â–¡'} ${label}`);
  });
  if (texts.length === 0) return;
  navigator.clipboard.writeText(texts.join('\n')).then(() => alert('è³ªå•ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
}

// æ¯”è¼ƒè¡¨ã®åå‰ç·¨é›†
function startCompNameEdit() {
  const el = document.getElementById('comp-name-display');
  if (!el || !state.soComparison) return;
  const current = state.soComparison.name || 'æ¯”è¼ƒè¡¨';
  el.outerHTML = `<input id="comp-name-input" type="text" value="${current.replace(/"/g, '&quot;')}" class="text-lg font-bold text-gray-800 border border-blue-300 rounded px-2 py-0.5 focus:ring-2 focus:ring-blue-200 outline-none" style="max-width:250px;" />`;
  const input = document.getElementById('comp-name-input');
  if (input) {
    input.focus();
    input.select();
    input.onblur = () => finishCompNameEdit(input.value);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') render(); };
  }
}

async function finishCompNameEdit(newName) {
  const trimmed = (newName || '').trim() || 'æ¯”è¼ƒè¡¨';
  if (state.soComparison) {
    state.soComparison.name = trimmed;
    if (state.soComparison.id) await renameComparison(state.soComparison.id, trimmed);
  }
  render();
}

async function handleDeleteComparison(compId) {
  if (!confirm('ã“ã®æ¯”è¼ƒè¡¨ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await deleteComparison(compId);
  render();
}

// ã‚»ãƒ«ç·¨é›†: ã‚¯ãƒªãƒƒã‚¯ â†’ inline input
function startCellEdit(td, propId, key, editType) {
  if (td.querySelector('input,textarea')) return; // æ—¢ã«ç·¨é›†ä¸­
  const prop = state.savedProperties.find(p => p.id === propId);
  if (!prop) return;

  const currentVal = prop[key];
  td.innerHTML = '';

  if (editType === 'price') {
    // ä¸‡å†† â†’ å††ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ä¸‡å††ã§è¡¨ç¤ºãƒ»å…¥åŠ›
    const input = document.createElement('input');
    input.type = 'number';
    input.className = 'w-full px-2 py-1 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none';
    input.value = currentVal ? currentVal / 10000 : '';
    input.placeholder = 'ä¸‡å††';
    input.focus();
    input.onblur = () => finishCellEdit(propId, key, input.value ? Number(input.value) * 10000 : null);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { render(); } };
    td.appendChild(input);
    setTimeout(() => input.focus(), 0);
  } else if (editType === 'area') {
    // ã¡ã§ä¿å­˜
    const input = document.createElement('input');
    input.type = 'number';
    input.step = '0.1';
    input.className = 'w-full px-2 py-1 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none';
    input.value = currentVal || '';
    input.placeholder = 'ã¡';
    input.onblur = () => finishCellEdit(propId, key, input.value ? Number(input.value) : null);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { render(); } };
    td.appendChild(input);
    setTimeout(() => input.focus(), 0);
  } else {
    // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'w-full px-2 py-1 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none';
    input.value = currentVal || '';
    input.onblur = () => finishCellEdit(propId, key, input.value.trim() || null);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { render(); } };
    td.appendChild(input);
    setTimeout(() => input.focus(), 0);
  }
}

async function finishCellEdit(propId, key, newVal) {
  const prop = state.savedProperties.find(p => p.id === propId);
  if (!prop) return;
  if (prop[key] === newVal) { render(); return; }
  // comparisonå†…ã®propsã‚‚åŒæœŸ
  if (state.soComparison?.properties) {
    const cp = state.soComparison.properties.find(p => p.id === propId);
    if (cp) cp[key] = newVal;
  }
  await updateProperty(propId, { [key]: newVal });
  render();
}

async function handleMemoEdit(propId, value) {
  const trimmed = value.trim();
  const prop = state.savedProperties.find(p => p.id === propId);
  if (!prop) return;
  if ((prop.user_memo || '') === trimmed) return;
  if (state.soComparison?.properties) {
    const cp = state.soComparison.properties.find(p => p.id === propId);
    if (cp) cp.user_memo = trimmed;
  }
  await updateProperty(propId, { user_memo: trimmed });
}

// ============================================================
// Modals (Import)
// ============================================================
function renderAuthModal() {
  if (!state.authModalOpen) return '';

  const isOtpStep = state.authStep === 'otp';
  const isLinkSent = state.authStep === 'link_sent';
  const loading = state.authLoading;

  return `
    <div class="so-modal-overlay" onclick="if(event.target===this){state.authModalOpen=false;render();}">
      <div class="so-modal" style="max-width:400px;">
        ${isLinkSent ? `
          <h2 class="text-lg font-bold text-gray-900 mb-1">ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ</h2>
          <p class="text-sm text-gray-500 mb-4"><span class="font-medium text-gray-700">${state.authEmail}</span> ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚</p>
          <div class="p-4 bg-blue-50 rounded-lg mb-4">
            <p class="text-sm text-blue-800">ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
            <p class="text-xs text-blue-600 mt-2">ã‚¯ãƒªãƒƒã‚¯å¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚</p>
          </div>
          <button onclick="state.authModalOpen=false;render();" class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
            é–‰ã˜ã‚‹
          </button>
        ` : isOtpStep ? `
          <h2 class="text-lg font-bold text-gray-900 mb-1">èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</h2>
          <p class="text-sm text-gray-500 mb-4"><span class="font-medium text-gray-700">${state.authEmail}</span> ã«6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ</p>
          ${state.authError ? `<p class="text-sm text-red-600 mb-3">${state.authError}</p>` : ''}
          <input id="auth-otp-input" type="text" inputmode="numeric" maxlength="6" placeholder="000000"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-2xl font-bold tracking-widest focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
            ${loading ? 'disabled' : ''}>
          <button onclick="handleAuthVerify()" class="w-full mt-4 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors ${loading ? 'opacity-50 cursor-not-allowed' : ''}" ${loading ? 'disabled' : ''}>
            ${loading ? 'ç¢ºèªä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
          </button>
          <button onclick="state.authStep='email';state.authError='';render();" class="w-full mt-2 px-4 py-2 text-sm text-gray-500 hover:text-gray-700 transition-colors">
            â† ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´
          </button>
        ` : `
          <h2 class="text-lg font-bold text-gray-900 mb-1">ãƒ­ã‚°ã‚¤ãƒ³ / ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²</h2>
          <p class="text-sm text-gray-500 mb-4">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä¸è¦ã§ã™ã€‚</p>
          ${state.authError ? `<p class="text-sm text-red-600 mb-3">${state.authError}</p>` : ''}
          <input id="auth-email-input" type="email" placeholder="example@mail.com"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
            value="${state.authEmail}" ${loading ? 'disabled' : ''}>
          <button onclick="handleAuthSendOtp()" class="w-full mt-4 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors ${loading ? 'opacity-50 cursor-not-allowed' : ''}" ${loading ? 'disabled' : ''}>
            ${loading ? 'é€ä¿¡ä¸­...' : 'èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡'}
          </button>
          <p class="text-xs text-gray-400 mt-3 text-center">6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒãƒ¡ãƒ¼ãƒ«ã«å±Šãã¾ã™</p>
        `}
      </div>
    </div>
  `;
}

function renderSOModal() {
  if (!state.soModalOpen) return '';

  if (state.soModalType === 'import') {
    return renderImportModal();
  }
  return '';
}

function renderImportModal() {
  const areaId = state.soSearchAreaId;
  const area = AREAS.find(a => a.id === areaId);
  const areaName = area ? area.name : '';
  const parsed = state._aiParsedProperty;
  const batch = state._batchResults;
  const batchProcessing = state._batchProcessing;
  const batchUrls = state._batchUrls;

  return `
    <div class="so-modal-overlay" onclick="closeSOModal(event)">
      <div class="so-modal" onclick="event.stopPropagation()" style="max-height:90vh; overflow-y:auto;">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">ğŸ¤– ç‰©ä»¶æƒ…å ±ã‚’AIã§å–ã‚Šè¾¼ã¿${areaName ? `ï¼ˆ${areaName}ï¼‰` : ''}</h3>
          <button onclick="closeBatchModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>

        <div class="space-y-4">
          <!-- ã‚¿ãƒ–åˆ‡æ›¿: URL / ãƒ†ã‚­ã‚¹ãƒˆ -->
          <div class="flex border-b border-gray-200">
            <button id="tab-url" onclick="document.getElementById('panel-url').style.display='block'; document.getElementById('panel-text').style.display='none'; document.getElementById('tab-url').className='flex-1 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600'; document.getElementById('tab-text').className='flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent';" class="flex-1 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
              ğŸ”— ç‰©ä»¶URLã‹ã‚‰ç™»éŒ²
            </button>
            <button id="tab-text" onclick="document.getElementById('panel-text').style.display='block'; document.getElementById('panel-url').style.display='none'; document.getElementById('tab-text').className='flex-1 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600'; document.getElementById('tab-url').className='flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent';" class="flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent">
              ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆè²¼ã‚Šä»˜ã‘
            </button>
          </div>

          <!-- URLå…¥åŠ›ãƒ‘ãƒãƒ«ï¼ˆè¤‡æ•°URLå…¥åŠ›æ¬„ï¼‰ -->
          <div id="panel-url">
            ${batch.length === 0 && !batchProcessing ? `
              <label class="text-sm font-medium text-gray-700">ç‰©ä»¶ãƒšãƒ¼ã‚¸ã®URL</label>
              <div class="space-y-2 mt-1" id="url-fields-container">
                ${batchUrls.map((url, i) => `
                  <div class="flex gap-2 items-center">
                    <span class="text-xs text-gray-400 w-5 text-right shrink-0">${i + 1}</span>
                    <input type="url" value="${(url || '').replace(/"/g, '&quot;')}" placeholder="https://suumo.jp/tochi/... ã‚„ athome.co.jp/..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm batch-url-input" data-idx="${i}" oninput="updateBatchUrlValue(${i}, this.value)" />
                    ${batchUrls.length > 1 ? `<button onclick="removeBatchUrlField(${i})" class="text-gray-300 hover:text-red-400 text-lg leading-none shrink-0" title="å‰Šé™¤">Ã—</button>` : '<div class="w-5"></div>'}
                  </div>
                `).join('')}
              </div>
              <button onclick="addBatchUrlField()" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                ï¼‹ URLã‚’è¿½åŠ 
              </button>
              <p class="text-xs text-gray-400 mt-1">SUUMOãƒ»ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ãƒ»HOMESç­‰ã®å€‹åˆ¥ç‰©ä»¶ãƒšãƒ¼ã‚¸URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
              <button id="btn-fetch-url" onclick="handleBatchFetchUrls()" class="w-full mt-3 px-4 py-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                ğŸ”— URLã‹ã‚‰ç‰©ä»¶æƒ…å ±ã‚’å–å¾—${batchUrls.filter(u => u && u.startsWith('http')).length > 1 ? `ï¼ˆ${batchUrls.filter(u => u && u.startsWith('http')).length}ä»¶ï¼‰` : ''}
              </button>
            ` : ''}

            ${batchProcessing || batch.length > 0 ? renderBatchProgress() : ''}
          </div>

          <!-- ãƒ†ã‚­ã‚¹ãƒˆè²¼ã‚Šä»˜ã‘ãƒ‘ãƒãƒ« -->
          <div id="panel-text" style="display:none;">
            <div>
              <label class="text-sm font-medium text-gray-700">ç‰©ä»¶URLï¼ˆä»»æ„ï¼‰</label>
              <input id="import-url-text" type="url" placeholder="https://suumo.jp/... ï¼ˆä»»æ„ï¼‰" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div class="mt-3">
              <label class="text-sm font-medium text-gray-700">ç‰©ä»¶æƒ…å ±ã‚’è²¼ã‚Šä»˜ã‘ <span class="text-red-500">*</span></label>
              <textarea id="ai-import-text" rows="5" placeholder="ç‰©ä»¶ã‚µã‚¤ãƒˆã®æƒ…å ±ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„&#10;&#10;ä¾‹:&#10;ä¾¡æ ¼ 2,580ä¸‡å††&#10;åœŸåœ°é¢ç© 182.5ã¡ï¼ˆ55.2åªï¼‰&#10;æ‰€åœ¨åœ° å››æ—¥å¸‚å¸‚å¯Œç”°æµœç”º&#10;æœ€å¯„ã‚Šé§… å¯Œç”°æµœé§… å¾’æ­©5åˆ†&#10;ç”¨é€”åœ°åŸŸ ç¬¬ä¸€ç¨®ä½å±…åœ°åŸŸ" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" style="resize:vertical;"></textarea>
            </div>
            <button id="btn-ai-parse" onclick="handleAIParse()" class="w-full mt-3 px-4 py-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
              ğŸ¤– AIã§æƒ…å ±ã‚’æ•´ç†ã—ã¦ä¿å­˜
            </button>
          </div>

          ${parsed && batch.length === 0 ? renderSingleParsedPreview(parsed) : ''}
        </div>
      </div>
    </div>
  `;
}

// å˜ä»¶ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆè²¼ã‚Šä»˜ã‘ç”¨ï¼‰
function renderSingleParsedPreview(parsed) {
  return `
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 space-y-2">
      <p class="text-sm font-bold text-green-800">âœ… AIãŒæ•´ç†ã—ãŸç‰©ä»¶æƒ…å ±</p>
      ${renderParsedPropertyGrid(parsed)}
      ${renderGeoInfo(parsed)}
      ${renderDupWarning(parsed)}
      ${parsed.memo ? `<p class="text-xs text-amber-700 mt-2">ğŸ’¡ ${parsed.memo}</p>` : ''}
      ${parsed.source_url ? `<p class="text-xs mt-1"><a href="${parsed.source_url}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">ğŸ”— ${parsed.source_url}</a></p>` : ''}
      <div class="flex gap-2 mt-3">
        <button onclick="handleSaveParsed()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">ğŸ’¾ ã“ã®å†…å®¹ã§ä¿å­˜</button>
        <button onclick="state._aiParsedProperty=null; render();" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors">ã‚„ã‚Šç›´ã™</button>
      </div>
    </div>
  `;
}

// ç‰©ä»¶æƒ…å ±ã‚°ãƒªãƒƒãƒ‰ï¼ˆå…±é€šãƒ‘ãƒ¼ãƒ„ï¼‰
function renderParsedPropertyGrid(parsed) {
  return `<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
    <span class="text-gray-500">ä¾¡æ ¼:</span><span class="font-medium">${parsed.price ? parsed.price.toLocaleString() + 'ä¸‡å††' : 'â€”'}</span>
    <span class="text-gray-500">é¢ç©:</span><span class="font-medium">${parsed.land_area ? (parsed.land_area/3.305785).toFixed(1) + 'åªï¼ˆ' + parsed.land_area + 'ã¡ï¼‰' : 'â€”'}</span>
    <span class="text-gray-500">ä½æ‰€:</span><span class="font-medium">${parsed.address || 'â€”'}</span>
    <span class="text-gray-500">é§…:</span><span class="font-medium">${parsed.station_distance || 'â€”'}</span>
    ${parsed.zoning ? `<span class="text-gray-500">ç”¨é€”åœ°åŸŸ:</span><span class="font-medium">${parsed.zoning}</span>` : ''}
    ${parsed.building_coverage ? `<span class="text-gray-500">å»ºãºã„ç‡:</span><span class="font-medium">${parsed.building_coverage}</span>` : ''}
    ${parsed.road_access ? `<span class="text-gray-500">æ¥é“:</span><span class="font-medium">${parsed.road_access}</span>` : ''}
  </div>`;
}

// ä½ç½®æƒ…å ±è¡¨ç¤ºï¼ˆå…±é€šãƒ‘ãƒ¼ãƒ„ï¼‰
function renderGeoInfo(parsed) {
  const geoConf = parsed.geo_confidence;
  if (!parsed.lat || !parsed.lng) return '';
  const confLabel = geoConf === 'high' ? 'ğŸŸ¢ é«˜ç²¾åº¦ï¼ˆãƒšãƒ¼ã‚¸å†…åº§æ¨™ï¼‰'
    : geoConf === 'medium' ? 'ğŸŸ¡ ä¸­ç²¾åº¦ï¼ˆä½æ‰€ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰'
    : 'ğŸ”´ ä½ç²¾åº¦ï¼ˆAIæ¨å®šï¼‰';
  const confClass = geoConf === 'high' ? 'text-green-700 bg-green-50'
    : geoConf === 'medium' ? 'text-amber-700 bg-amber-50'
    : 'text-red-700 bg-red-50';
  return '<div class="mt-2 p-2 rounded ' + confClass + ' border">' +
    '<div class="flex items-center gap-2 text-xs font-medium">' +
    '<span>ğŸ“ ä½ç½®æƒ…å ±: ' + confLabel + '</span>' +
    '<a href="https://www.google.com/maps?q=' + parsed.lat + ',' + parsed.lng + '" target="_blank" rel="noopener" class="text-blue-600 hover:underline ml-auto">ğŸ—ºï¸ åœ°å›³ã§ç¢ºèª</a>' +
    '</div>' +
    (geoConf !== 'high' ? '<p class="text-xs mt-1 opacity-75">â€» ä¿å­˜å¾Œã€åœ°å›³ãƒªãƒ³ã‚¯ã‹ã‚‰ä½ç½®ã‚’ã”ç¢ºèªãã ã•ã„</p>' : '') +
    '</div>';
}

// é‡è¤‡è­¦å‘Šï¼ˆå…±é€šãƒ‘ãƒ¼ãƒ„ï¼‰
function renderDupWarning(parsed) {
  if (!parsed.dedup_hash) return '';
  const dup = state.savedProperties.find(p => p.dedup_hash === parsed.dedup_hash);
  if (!dup) return '';
  return '<div class="mt-2 p-2 rounded bg-red-50 border border-red-200 text-xs text-red-700">' +
    'âš ï¸ <strong>é‡è¤‡ã®å¯èƒ½æ€§:</strong> åŒã˜ä½æ‰€ãƒ»é¢ç©ãƒ»ä¾¡æ ¼ã®ç‰©ä»¶ãŒæ—¢ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ï¼ˆ' + (dup.address || 'ä½æ‰€ä¸æ˜') + 'ï¼‰' +
    '</div>';
}

// ä¸€æ‹¬å–ã‚Šè¾¼ã¿ã®é€²æ—è¡¨ç¤º
function renderBatchProgress() {
  const batch = state._batchResults;
  const processing = state._batchProcessing;
  const currentIdx = state._batchCurrentIndex;
  const total = batch.length;
  const doneCount = batch.filter(b => b.status === 'done' || b.status === 'error').length;
  const successCount = batch.filter(b => b.status === 'done').length;
  const errorCount = batch.filter(b => b.status === 'error').length;
  const savedCount = batch.filter(b => b.saved).length;

  // å…¨å®Œäº†ã—ãŸã‹
  const allDone = !processing && doneCount === total;

  return `
    <div class="space-y-3">
      <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
      <div>
        <div class="flex items-center justify-between text-sm mb-1">
          <span class="font-medium text-gray-700">${processing ? `â³ å–å¾—ä¸­... (${doneCount}/${total})` : allDone ? `âœ… å–å¾—å®Œäº† (${successCount}ä»¶æˆåŠŸ${errorCount > 0 ? 'ã€' + errorCount + 'ä»¶å¤±æ•—' : ''})` : ''}</span>
          ${allDone ? `<button onclick="resetBatch()" class="text-xs text-gray-400 hover:text-gray-600">âœ• é–‰ã˜ã‚‹</button>` : ''}
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: ${total > 0 ? (doneCount / total * 100) : 0}%"></div>
        </div>
      </div>

      <!-- å„URLçµæœä¸€è¦§ -->
      <div class="space-y-2 max-h-96 overflow-y-auto">
        ${batch.map((item, idx) => {
          const isProcessing = processing && idx === currentIdx;
          const isDone = item.status === 'done';
          const isError = item.status === 'error';
          const isSaved = item.saved;

          // URLçŸ­ç¸®è¡¨ç¤º
          let shortUrl = item.url;
          try { shortUrl = new URL(item.url).hostname + new URL(item.url).pathname.substring(0, 30) + '...'; } catch(e) {}

          return `
            <div class="border rounded-lg ${isDone ? (isSaved ? 'border-green-300 bg-green-50/50' : 'border-blue-200 bg-blue-50/30') : isError ? 'border-red-200 bg-red-50/30' : isProcessing ? 'border-amber-200 bg-amber-50/30' : 'border-gray-200'} p-3">
              <div class="flex items-center gap-2">
                <span class="text-sm">${isProcessing ? 'â³' : isDone ? (isSaved ? 'âœ…' : 'ğŸ“‹') : isError ? 'âŒ' : 'â¸ï¸'}</span>
                <span class="text-xs text-gray-500 truncate flex-1" title="${item.url}">${shortUrl}</span>
                ${isProcessing ? '<span class="text-xs text-amber-600 animate-pulse">AIè§£æä¸­...</span>' : ''}
              </div>

              ${isDone && item.parsed ? `
                <div class="mt-2 pl-6">
                  <div class="grid grid-cols-2 gap-x-3 gap-y-0.5 text-xs">
                    <span class="text-gray-400">ä¾¡æ ¼:</span><span class="font-medium">${item.parsed.price ? item.parsed.price.toLocaleString() + 'ä¸‡å††' : 'â€”'}</span>
                    <span class="text-gray-400">é¢ç©:</span><span class="font-medium">${item.parsed.land_area ? (item.parsed.land_area/3.305785).toFixed(1) + 'åª' : 'â€”'}</span>
                    <span class="text-gray-400">ä½æ‰€:</span><span class="font-medium col-span-1 truncate">${item.parsed.address || 'â€”'}</span>
                  </div>
                  ${renderDupWarning(item.parsed)}
                  ${!isSaved ? `
                    <div class="flex gap-2 mt-2">
                      <button onclick="handleSaveBatchItem(${idx})" class="px-3 py-1 bg-green-600 text-white rounded text-xs font-medium hover:bg-green-700 transition-colors">ğŸ’¾ ä¿å­˜</button>
                      <button onclick="skipBatchItem(${idx})" class="px-3 py-1 bg-gray-100 text-gray-500 rounded text-xs hover:bg-gray-200 transition-colors">ã‚¹ã‚­ãƒƒãƒ—</button>
                    </div>
                  ` : `<p class="text-xs text-green-600 mt-1">âœ… ä¿å­˜æ¸ˆã¿</p>`}
                </div>
              ` : ''}

              ${isError ? `<p class="text-xs text-red-500 mt-1 pl-6">${item.error || 'å–å¾—å¤±æ•—'}</p>` : ''}
            </div>
          `;
        }).join('')}
      </div>

      ${allDone && successCount > 0 ? `
        <div class="flex gap-2">
          ${successCount - savedCount > 0 ? `
            <button onclick="handleSaveBatchAll()" class="flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
              ğŸ’¾ æœªä¿å­˜ã‚’ã¾ã¨ã‚ã¦ä¿å­˜ï¼ˆ${successCount - savedCount}ä»¶ï¼‰
            </button>
          ` : `
            <button onclick="closeBatchModal()" class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
              âœ… å®Œäº† â€” ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            </button>
          `}
        </div>
      ` : ''}
    </div>
  `;
}

// ============================================================
// Event Handlers
// ============================================================
function openImportModal(areaId) {
  const urlInput = document.getElementById('url-import-property') || document.getElementById('url-import-detail');
  const initialUrl = urlInput ? urlInput.value.trim() : '';
  state._importUrl = initialUrl;
  state._aiParsedProperty = null;
  state._batchUrls = initialUrl ? [initialUrl] : [''];
  state._batchResults = [];
  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  state.soSearchAreaId = areaId || null;
  state.soModalOpen = true;
  state.soModalType = 'import';
  render();
}

function closeSOModal(event) {
  if (event.target === event.currentTarget) {
    closeBatchModal();
  }
}

// ============================================================
// ä¸€æ‹¬URLå–ã‚Šè¾¼ã¿: URLå…¥åŠ›æ¬„ã®ç®¡ç†
// ============================================================
function addBatchUrlField() {
  state._batchUrls.push('');
  render();
  // è¿½åŠ å¾Œã«æœ€å¾Œã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  setTimeout(() => {
    const inputs = document.querySelectorAll('.batch-url-input');
    if (inputs.length > 0) inputs[inputs.length - 1].focus();
  }, 50);
}

function removeBatchUrlField(idx) {
  if (state._batchUrls.length <= 1) return;
  state._batchUrls.splice(idx, 1);
  render();
}

function updateBatchUrlValue(idx, value) {
  state._batchUrls[idx] = value;
  // ãƒœã‚¿ãƒ³ã®ä»¶æ•°è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆrenderã—ãªã„ï¼å…¥åŠ›ä¸­ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ä¿æŒï¼‰
  const btn = document.getElementById('btn-fetch-url');
  if (btn) {
    const count = state._batchUrls.filter(u => u && u.trim().startsWith('http')).length;
    btn.textContent = count > 1
      ? `ğŸ”— URLã‹ã‚‰ç‰©ä»¶æƒ…å ±ã‚’å–å¾—ï¼ˆ${count}ä»¶ï¼‰`
      : 'ğŸ”— URLã‹ã‚‰ç‰©ä»¶æƒ…å ±ã‚’å–å¾—';
  }
}

async function fetchSingleUrl(url) {
  const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
  const session = await supabaseClient.auth.getSession();
  const token = session?.data?.session?.access_token;
  if (token) headers['Authorization'] = `Bearer ${token}`;
  else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
  const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-assist`, {
    method: 'POST', headers,
    body: JSON.stringify({ action: 'fetch_url', url, areaId: state.soSearchAreaId })
  });
  if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
  const result = await res.json();
  if (result.error) throw new Error(result.error);
  return result;
}

async function handleBatchFetchUrls() {
  // å…¥åŠ›æ¬„ã‹ã‚‰URLä¸€è¦§ã‚’å–å¾—
  const urls = state._batchUrls
    .map(u => (u || '').trim())
    .filter(u => u.startsWith('http'));

  if (urls.length === 0) { alert('ç‰©ä»¶ãƒšãƒ¼ã‚¸ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  // ä¸€æ‹¬ãƒ•ãƒ­ãƒ¼ã«å…¥ã‚‹
  state._batchResults = urls.map(url => ({ url, status: 'pending', parsed: null, error: null, saved: false }));
  state._batchProcessing = true;
  state._batchCurrentIndex = 0;
  state._aiParsedProperty = null;
  render();

  // é †æ¬¡å‡¦ç†ï¼ˆEdge Function 25ç§’åˆ¶é™å¯¾ç­– + Jina APIãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰
  for (let i = 0; i < urls.length; i++) {
    state._batchCurrentIndex = i;
    state._batchResults[i].status = 'processing';
    render();

    try {
      const result = await fetchSingleUrl(urls[i]);
      state._batchResults[i].status = 'done';
      state._batchResults[i].parsed = result;
    } catch(e) {
      console.error(`URL Fetch error [${i}]:`, e);
      state._batchResults[i].status = 'error';
      state._batchResults[i].error = e.message;
    }
    render();

    // æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§å°‘ã—å¾…ã¤ï¼ˆãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆå¯¾ç­–ï¼‰
    if (i < urls.length - 1) {
      await new Promise(r => setTimeout(r, 1000));
    }
  }

  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  render();
}

// å€‹åˆ¥ä¿å­˜
async function handleSaveBatchItem(idx) {
  const item = state._batchResults[idx];
  if (!item || !item.parsed || item.saved) return;
  const parsed = item.parsed;

  if (!parsed.price || !parsed.land_area) {
    alert('ä¾¡æ ¼ã¨é¢ç©ãŒå¿…è¦ã§ã™ã€‚ã“ã®ç‰©ä»¶ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  const prop = buildPropertyFromParsed(parsed);
  const saved = await saveProperty(prop);
  if (saved) {
    state._batchResults[idx].saved = true;
    render();
  }
}

// ä¸€æ‹¬ä¿å­˜ï¼ˆæœªä¿å­˜ã®æˆåŠŸåˆ†ã™ã¹ã¦ï¼‰
async function handleSaveBatchAll() {
  const unsaved = state._batchResults.filter(b => b.status === 'done' && !b.saved && b.parsed);
  let savedCount = 0;
  for (const item of unsaved) {
    if (!item.parsed.price || !item.parsed.land_area) continue;
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
    if (item.parsed.dedup_hash) {
      const dup = state.savedProperties.find(p => p.dedup_hash === item.parsed.dedup_hash);
      if (dup) continue; // é‡è¤‡ã¯ã‚¹ã‚­ãƒƒãƒ—
    }
    const prop = buildPropertyFromParsed(item.parsed);
    const saved = await saveProperty(prop);
    if (saved) {
      item.saved = true;
      savedCount++;
    }
  }
  render();
  if (savedCount > 0) {
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰é–‰ã˜ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çµæœã‚’è¦‹ã›ã‚‹ï¼‰
  }
}

// ã‚¹ã‚­ãƒƒãƒ—
function skipBatchItem(idx) {
  state._batchResults[idx].saved = true; // saved=trueã«ã—ã¦UIã‹ã‚‰æ¶ˆã™
  state._batchResults[idx].status = 'skipped';
  render();
}

// ãƒãƒƒãƒãƒªã‚»ãƒƒãƒˆï¼ˆURLå…¥åŠ›ã«æˆ»ã™ï¼‰
function resetBatch() {
  state._batchUrls = [''];
  state._batchResults = [];
  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  render();
}

function closeBatchModal() {
  state.soModalOpen = false;
  state._aiParsedProperty = null;
  state._batchUrls = [''];
  state._batchResults = [];
  state._batchProcessing = false;
  state._batchCurrentIndex = -1;
  render();
}

// parsed â†’ property ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ›ï¼ˆå…±é€šï¼‰
function buildPropertyFromParsed(parsed) {
  return {
    area_id: state.soSearchAreaId || null,
    url: parsed.source_url || state._importUrl || null,
    source: parsed.source || null,
    price: parsed.price * 10000, // ä¸‡å†† â†’ å††
    land_area: parsed.land_area,
    address: parsed.address || null,
    station_distance: parsed.station_distance || null,
    floor_plan: parsed.floor_plan || null,
    building_year: parsed.building_year || null,
    zoning: parsed.zoning || null,
    building_coverage: parsed.building_coverage || null,
    floor_area_ratio: parsed.floor_area_ratio || null,
    road_access: parsed.road_access || null,
    elevation: parsed.elevation || null,
    infrastructure: parsed.infrastructure || null,
    hazard: parsed.hazard || null,
    memo: parsed.memo || null,
    lat: parsed.lat || null,
    lng: parsed.lng || null,
    geo_confidence: parsed.geo_confidence || null,
    geo_source: parsed.geo_source || null,
    dedup_hash: parsed.dedup_hash || null,
  };
}

// æ—§äº’æ›: å˜ä»¶URLå–å¾—ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè²¼ã‚Šä»˜ã‘ãƒ‘ãƒãƒ«ã§ã¯ä½¿ã‚ãªã„ï¼‰
async function handleFetchUrl() {
  // ä¸€æ‹¬ãƒ•ãƒ­ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  handleBatchFetchUrls();
}

// ãƒ†ã‚­ã‚¹ãƒˆè²¼ã‚Šä»˜ã‘ â†’ AIè§£æ
async function handleAIParse() {
  const textEl = document.getElementById('ai-import-text');
  const urlEl = document.getElementById('import-url-text');
  const text = textEl ? textEl.value.trim() : '';
  const url = urlEl ? urlEl.value.trim() : '';
  if (!text) { alert('ç‰©ä»¶æƒ…å ±ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„'); return; }

  const btn = document.getElementById('btn-ai-parse');
  if (btn) { btn.textContent = 'ğŸ¤– AIãŒè§£æä¸­...'; btn.disabled = true; }

  try {
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    if (token) headers['Authorization'] = `Bearer ${token}`;
    else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-assist`, {
      method: 'POST', headers,
      body: JSON.stringify({ action: 'parse', text, url, areaId: state.soSearchAreaId })
    });
    if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
    const result = await res.json();
    if (result.error) throw new Error(result.error);
    state._aiParsedProperty = result;
    state._importUrl = url;
    render();
  } catch(e) {
    console.error('AI Parse error:', e);
    alert('AIè§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    if (btn) { btn.textContent = 'ğŸ¤– AIã§æƒ…å ±ã‚’æ•´ç†ã—ã¦ä¿å­˜'; btn.disabled = false; }
  }
}

// AIè§£æçµæœã‚’ä¿å­˜
async function handleSaveParsed() {
  const parsed = state._aiParsedProperty;
  if (!parsed) return;
  if (!parsed.price || !parsed.land_area) {
    alert('ä¾¡æ ¼ã¨é¢ç©ãŒå¿…è¦ã§ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆdedup_hashï¼‰
  if (parsed.dedup_hash) {
    const existing = state.savedProperties.find(p => p.dedup_hash === parsed.dedup_hash);
    if (existing) {
      const existAddr = existing.address || 'ä½æ‰€ä¸æ˜';
      if (!confirm(`âš ï¸ ã“ã®ç‰©ä»¶ã¯æ—¢ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\næ—¢å­˜: ${existAddr}\n\nãã‚Œã§ã‚‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }
    }
  }

  const prop = buildPropertyFromParsed(parsed);
  const saved = await saveProperty(prop);
  if (saved) {
    state.soModalOpen = false;
    state._importUrl = '';
    state._aiParsedProperty = null;
    render();
  }
}

async function handleToggleComparison(id) {
  await toggleComparison(id);
  render();
}

async function handleDeleteProperty(id) {
  if (!confirm('ã“ã®ç‰©ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await deleteProperty(id);
  render();
}

async function handleGenerateComparison() {
  const btn = event?.target;
  if (btn) { btn.textContent = 'ç”Ÿæˆä¸­...'; btn.disabled = true; }
  const result = await generateComparison();
  if (result) {
    state.soComparison = result;
    state.soView = 'compare';
    backupToLocalStorage();
  }
  render();
}

async function clearAllProperties() {
  if (!confirm('ä¿å­˜ã—ãŸç‰©ä»¶ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  for (const p of [...state.savedProperties]) {
    await deleteProperty(p.id);
  }
  render();
}

// ============================================================
// SEO Content
// ============================================================
function renderSEOContent() {
  return `
    <div class="card p-6 mt-6">
      <h2 class="text-lg font-bold text-gray-800 mb-3">æ³¨æ–‡ä½å®…ã®åœŸåœ°æ¢ã—ã®ãƒã‚¤ãƒ³ãƒˆ</h2>
      <div class="space-y-3 text-sm text-gray-600 leading-relaxed">
        <p>æ³¨æ–‡ä½å®…ã‚’å»ºã¦ã‚‹ãŸã‚ã®åœŸåœ°æ¢ã—ã§ã¯ã€ä¾¡æ ¼ã ã‘ã§ãªãã€ç”¨é€”åœ°åŸŸãƒ»å»ºãºã„ç‡ãƒ»å®¹ç©ç‡ãƒ»æ¥é“çŠ¶æ³ãƒ»åœ°ç›¤ã®çŠ¶æ…‹ãªã©ã€å¤šãã®é …ç›®ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®æƒ…å ±ã¯ä¸å‹•ç”£ã‚µã‚¤ãƒˆã”ã¨ã«è¨˜è¼‰æ–¹æ³•ãŒç•°ãªã‚Šã€è¤‡æ•°ã®åœŸåœ°ã‚’æ¯”è¼ƒã™ã‚‹éš›ã«å¤§ããªæ‰‹é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚</p>
        <p>å½“ãƒ„ãƒ¼ãƒ«ã¯ã€SUUMOãƒ»ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ãƒ»LIFULL HOME'Sç­‰ã®ä¸å‹•ç”£ã‚µã‚¤ãƒˆã®ç‰©ä»¶æƒ…å ±ã‚’AIãŒè‡ªå‹•ã§èª­ã¿å–ã‚Šã€çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ¯”è¼ƒè¡¨ã¨ã—ã¦æ•´ç†ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€AIãŒå„ç‰©ä»¶ã®æ³¨æ„ç‚¹ã‚„ãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆã‚’åˆ†æã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã€‚è¦‹è½ã¨ã—ãŒã¡ãªç¢ºèªäº‹é …ã‚‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦æç¤ºã™ã‚‹ã®ã§ã€ä¸å‹•ç”£ä¼šç¤¾ã¸ã®è³ªå•æº–å‚™ã«ã‚‚æ´»ç”¨ã§ãã¾ã™ã€‚</p>
      </div>
      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <a href="area.html" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors">
          ğŸ“Š ä¸‰é‡çœŒã‚¨ãƒªã‚¢åˆ¥ã®åœŸåœ°ç›¸å ´ã‚’è¦‹ã‚‹ â†’
        </a>
      </div>
    </div>
  `;
}

// ============================================================
// Footer
// ============================================================
function renderFooter() {
  return `
    <footer class="mt-8 py-6 border-t border-gray-200">
      <div class="text-center space-y-2">
        <div class="flex justify-center gap-4 mb-3">
          <a href="area.html" class="text-sm text-blue-600 hover:underline">ğŸ“Š ã‚¨ãƒªã‚¢æ¯”è¼ƒãƒšãƒ¼ã‚¸</a>
        </div>
        <p class="text-xs text-gray-400">â€» æœ¬ãƒ„ãƒ¼ãƒ«ã¯å‚è€ƒæƒ…å ±ã§ã‚ã‚Šã€ä¸å‹•ç”£è³¼å…¥ã®æœ€çµ‚åˆ¤æ–­ã¯å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„</p>
        <p class="text-xs text-gray-300 mt-3">Â© æ³¨æ–‡ç›¸è«‡.com</p>
      </div>
    </footer>
  `;
}

// ============================================================
// Bind Events
// ============================================================
function handleAuthSendOtp() {
  const input = document.getElementById('auth-email-input');
  const email = input ? input.value.trim() : '';
  if (!email || !email.includes('@')) { state.authError = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; render(); return; }
  handleSendOtp(email);
}

function handleAuthVerify() {
  const input = document.getElementById('auth-otp-input');
  const token = input ? input.value.trim() : '';
  if (!token || token.length !== 6) { state.authError = '6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; render(); return; }
  handleVerifyOtp(state.authEmail, token);
}

function bindEvents() {
  // èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®Enterã‚­ãƒ¼å¯¾å¿œ
  const emailInput = document.getElementById('auth-email-input');
  if (emailInput) emailInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleAuthSendOtp(); });
  const otpInput = document.getElementById('auth-otp-input');
  if (otpInput) {
    otpInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleAuthVerify(); });
    otpInput.focus();
  }
  if (emailInput && state.authModalOpen && state.authStep === 'email') emailInput.focus();
}

// ============================================================
// Initialize
// ============================================================
restoreFromLocalStorage();
render();

// èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
supabaseClient.auth.onAuthStateChange((event, session) => {
  if (session?.user) {
    updateAuthState(session.user);
  } else {
    state.authUser = null;
  }
  render();
});

ensureAuth().then(user => {
  if (user) updateAuthState(user);
  render();
  loadSavedProperties().then(() => {
    backupToLocalStorage();
    if (state.savedProperties.length > 0) render();
  });
  loadSavedComparisons().then(() => render());
  loadUserProfile().then(() => render());
}).catch(e => console.warn('Auth init skipped:', e.message));
</script>
</body>
</html>
