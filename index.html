<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="VBmM5Mikm2LrkY9dXa30MUHtT9KD2SpZFsoGHBuFPWM" />
<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SZV3XF0W0G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SZV3XF0W0G');
</script>
<title>三重県で注文住宅を建てるなら｜エリア別 土地相場・取引データ比較 | 注文相談.com</title>
<meta name="description" content="三重県北部で注文住宅を検討中の方へ。四日市・桑名・鈴鹿・いなべ・亀山・菰野・東員の7エリアの土地価格相場、実際の取引データ、名古屋アクセス、子育て環境をリアルタイムで比較。国土交通省データに基づく信頼性の高い不動産情報で、理想の土地探しをサポートします。">
<meta name="keywords" content="三重県,注文住宅,土地探し,土地相場,四日市,桑名,鈴鹿,いなべ,亀山,菰野,東員,不動産,土地価格,名古屋通勤,子育て,住みやすさ">
<link rel="canonical" href="https://research.chuumon-soudan.com/">
<!-- OGP -->
<meta property="og:title" content="三重県で注文住宅を建てるなら｜エリア別 土地相場・取引データ比較">
<meta property="og:description" content="三重県北部7エリアの土地価格・取引データ・子育て環境をリアルタイム比較。国土交通省の公式データで注文住宅の土地探しをサポート。">
<meta property="og:type" content="website">
<meta property="og:url" content="https://research.chuumon-soudan.com/">
<meta property="og:site_name" content="注文相談.com">
<meta property="og:locale" content="ja_JP">
<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="三重県で注文住宅を建てるなら｜エリア別 土地相場比較">
<meta name="twitter:description" content="三重県北部7エリアの土地価格・取引データをリアルタイム比較。注文住宅の土地探しに。">
<!-- 構造化データ (JSON-LD) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "三重県 注文住宅エリア比較ツール",
  "description": "三重県北部7エリアの土地価格相場・取引データ・子育て環境をリアルタイムで比較できる無料ツール",
  "url": "https://research.chuumon-soudan.com/",
  "applicationCategory": "RealEstate",
  "operatingSystem": "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "JPY" },
  "author": { "@type": "Organization", "name": "注文相談.com", "url": "https://chuumon-soudan.com/" },
  "areaServed": { "@type": "State", "name": "三重県" },
  "about": [
    { "@type": "Thing", "name": "注文住宅" },
    { "@type": "Thing", "name": "土地探し" },
    { "@type": "Thing", "name": "不動産価格" }
  ]
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* === Tailwind CSS v3.4.19 (production build) === */
  *,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sticky{position:sticky}.top-0{top:0}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-1{margin-left:.25rem}.mt-0\.5{margin-top:.125rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.h-6{height:1.5rem}.w-12{width:3rem}.w-16{width:4rem}.w-28{width:7rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-8{width:2rem}.w-full{width:100%}.min-w-0{min-width:0}.max-w-6xl{max-width:72rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity,1))}.border-blue-100{--tw-border-opacity:1;border-color:rgb(219 234 254/var(--tw-border-opacity,1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-50{--tw-border-opacity:1;border-color:rgb(249 250 251/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.bg-amber-500{--tw-bg-opacity:1;background-color:rgb(245 158 11/var(--tw-bg-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgb(156 163 175/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94/var(--tw-bg-opacity,1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity,1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255/var(--tw-bg-opacity,1))}.bg-slate-400{--tw-bg-opacity:1;background-color:rgb(148 163 184/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.p-2{padding:.5rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.leading-relaxed{line-height:1.625}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-amber-800{--tw-text-opacity:1;color:rgb(146 64 14/var(--tw-text-opacity,1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.shadow-md,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.outline{outline-style:solid}.blur{--tw-blur:blur(8px)}.blur,.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-filter{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity,1))}@media (min-width:640px){.sm\:block{display:block}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}@media (min-width:768px){.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  * { font-family: 'Noto Sans JP', sans-serif; }
  body { background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 50%, #f5f0ff 100%); min-height: 100vh; }
  .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); }
  .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; transition: all 0.2s; }
  .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .medal-gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
  .medal-silver { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
  .medal-bronze { background: linear-gradient(135deg, #CD7F32, #B8860B); }
  input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 3px; outline: none; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #3b82f6; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  .tab-active { background: #3b82f6; color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }
  .score-bar { height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; }
  .score-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .pulse-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 500; }
  /* Map styles */
  .map-layout { display: flex; gap: 0; height: 600px; }
  #map-container { flex: 1; border-radius: 12px 0 0 12px; overflow: hidden; z-index: 1; }
  #map-sidebar { width: 340px; background: white; border-left: 1px solid #e5e7eb; border-radius: 0 12px 12px 0; overflow-y: auto; padding: 0; }
  .leaflet-container { font-family: 'Noto Sans JP', sans-serif; }
  .map-marker-icon { transition: transform 0.2s; }
  .map-marker-icon:hover { transform: scale(1.15); }
  .sidebar-header { padding: 16px; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; z-index: 2; }
  .sidebar-body { padding: 16px; }
  .tx-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .tx-table th { background: #f9fafb; padding: 6px 8px; text-align: left; font-weight: 500; color: #6b7280; position: sticky; top: 0; }
  .tx-table td { padding: 6px 8px; border-top: 1px solid #f3f4f6; }
  .tx-table tr[data-tx-idx] { cursor: pointer; transition: background 0.15s; }
  .tx-table tr[data-tx-idx]:hover { background: #dbeafe; }
  .tx-table tr.tx-active { background: #bfdbfe; }
  /* School district toggle */
  .school-toggle { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; user-select: none; transition: all 0.2s; border: 1px solid #d1d5db; background: white; }
  .school-toggle.active { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
  .school-toggle:hover { background: #f3f4f6; }
  .school-toggle.active:hover { background: #bfdbfe; }
  /* School icon markers */
  .school-icon-marker { background: none !important; border: none !important; }
  /* Map loading overlay */
  .map-loading-overlay {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 800;
    background: rgba(0,0,0,0.25); display: flex; flex-direction: column;
    align-items: center; justify-content: center; pointer-events: none;
    transition: opacity 0.3s;
  }
  .map-loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .map-loading-box {
    background: white; border-radius: 12px; padding: 16px 28px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18); text-align: center;
    animation: mapLoadBounce 2s ease-in-out infinite;
  }
  @keyframes mapLoadBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
  .map-loading-spinner {
    width: 32px; height: 32px; border: 3px solid #e5e7eb;
    border-top-color: #3b82f6; border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 0 auto 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .map-loading-progress {
    width: 120px; height: 4px; background: #e5e7eb; border-radius: 2px;
    margin: 8px auto 0; overflow: hidden;
  }
  .map-loading-progress-bar {
    height: 100%; background: #3b82f6; border-radius: 2px;
    transition: width 0.3s ease;
  }
  /* Fullscreen map */
  .map-fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; border-radius: 0 !important; margin: 0;
  }
  .map-fullscreen #map-container { border-radius: 0; height: 100vh; }
  .map-fullscreen #map-sidebar { border-radius: 0; height: 100vh; }
  .map-fullscreen-controls {
    position: fixed; top: 12px; left: 50%; transform: translateX(-50%); z-index: 10001;
    background: rgba(255,255,255,0.92); backdrop-filter: blur(8px);
    padding: 8px 12px; border-radius: 10px; display: none;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    gap: 8px; align-items: center;
  }
  .map-fullscreen-controls.visible { display: flex; }
  .map-fullscreen-btn {
    display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px;
    border-radius: 6px; font-size: 12px; cursor: pointer; user-select: none;
    transition: all 0.2s; border: 1px solid #d1d5db; background: white; color: #374151;
  }
  .map-fullscreen-btn:hover { background: #f3f4f6; }
  .map-fullscreen-btn.active { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
  @media (max-width: 768px) {
    .map-layout { flex-direction: column; height: auto; }
    #map-container { height: 400px; border-radius: 12px 12px 0 0; }
    #map-sidebar { width: 100%; border-left: none; border-top: 1px solid #e5e7eb; border-radius: 0 0 12px 12px; max-height: 350px; }
    .map-fullscreen #map-sidebar { height: auto; max-height: 40vh; }
  }
  /* === Second Opinion Feature === */
  .so-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; }
  .so-modal { background: white; border-radius: 16px; max-width: 560px; width: 90%; max-height: 85vh; overflow-y: auto; padding: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
  .so-fixed-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border-top: 1px solid #e5e7eb; padding: 12px 16px; z-index: 100; display: flex; align-items: center; justify-content: center; gap: 16px; box-shadow: 0 -2px 10px rgba(0,0,0,0.08); }
  .so-badge-yellow { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-red { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-none { background: #f0fdf4; color: #166534; border: 1px solid #86efac; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-compare-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .so-compare-table th, .so-compare-table td { padding: 8px 12px; border: 1px solid #e5e7eb; text-align: left; }
  .so-compare-table th { background: #f9fafb; font-weight: 600; white-space: nowrap; }
  .so-compare-table .missing { color: #d97706; font-style: italic; }
  .so-radio-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .so-radio-group label { padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
  .so-radio-group label:hover { border-color: #3b82f6; background: #eff6ff; }
  .so-radio-group input:checked + span { color: #1d4ed8; }
  .so-radio-group label:has(input:checked) { border-color: #3b82f6; background: #dbeafe; }
</style>
</head>
<body>
<div id="app"></div>

<script>
// ============================================================
// 設定 — デプロイ時にここを編集
// ============================================================
const CONFIG = {
  // プロキシURL（Supabase Edge Function）
  PROXY_URL: 'https://jvfmvitknqnmuduyscnl.supabase.co/functions/v1/mcp-proxy',

  // MCPサーバーURL（プロキシ経由で接続）
  MCP_REINFO: 'https://mcp.n-3.ai/mcp?tools=get-time,reinfolib-real-estate-price,reinfolib-city-list',
  MCP_ESTAT: 'https://mcp.n-3.ai/mcp?tools=e-stat-get-stats-list,e-stat-get-meta-info,e-stat-get-data-catalog',
  // Supabase
  SUPABASE_URL: 'https://jvfmvitknqnmuduyscnl.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2Zm12aXRrbnFubXVkdXlzY25sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4ODE5NTQsImV4cCI6MjA4NjQ1Nzk1NH0.dDsHJXxFW4R-8ts-sKfGHtE-P0Ge9mPYEtpl-30dAdg',
};

// ============================================================
// Supabase Client + Anonymous Auth
// ============================================================
const supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

async function ensureAuth() {
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) return session.user;
    const { data, error } = await supabaseClient.auth.signInAnonymously();
    if (error) { console.warn('Anonymous auth failed:', error.message); return null; }
    return data.user;
  } catch(e) { console.warn('Auth error:', e.message); return null; }
}

// ============================================================
// Property CRUD (Supabase)
// ============================================================
async function loadSavedProperties() {
  const user = await ensureAuth();
  if (!user) return;
  const { data, error } = await supabaseClient.from('saved_properties').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
  if (!error && data) state.savedProperties = data;
}

async function saveProperty(prop) {
  try {
    const user = await ensureAuth();
    if (!user) { alert('物件の保存にはページの再読み込みが必要です'); return null; }
    const areaData = AREAS.find(a => a.id === prop.area_id);
    const badge = calculateBadge(prop, areaData);
    const row = { ...prop, user_id: user.id, badge };
    const { data, error } = await supabaseClient.from('saved_properties').insert(row).select().single();
    if (error) { alert('保存に失敗しました: ' + error.message); console.error('Save failed:', error); return null; }
    state.savedProperties.unshift(data);
    return data;
  } catch(e) { alert('保存エラー: ' + e.message); return null; }
}

async function deleteProperty(id) {
  const { error } = await supabaseClient.from('saved_properties').delete().eq('id', id);
  if (!error) state.savedProperties = state.savedProperties.filter(p => p.id !== id);
}

async function toggleComparison(id) {
  const prop = state.savedProperties.find(p => p.id === id);
  if (!prop) return;
  const newVal = !prop.in_comparison;
  const inCompCount = state.savedProperties.filter(p => p.in_comparison).length;
  if (newVal && inCompCount >= 5) { alert('比較は最大5件までです'); return; }
  const { error } = await supabaseClient.from('saved_properties').update({ in_comparison: newVal }).eq('id', id);
  if (!error) prop.in_comparison = newVal;
}

async function generateComparison() {
  const props = state.savedProperties.filter(p => p.in_comparison);
  if (props.length < 2) { alert('比較するには2件以上の物件を選択してください'); return null; }
  const areas = {};
  AREAS.forEach(a => { areas[a.id] = { name: a.name, pricePerTsubo: a.pricePerTsubo }; });
  try {
    const user = await ensureAuth();
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    headers['Authorization'] = token ? `Bearer ${token}` : `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-compare`, {
      method: 'POST', headers,
      body: JSON.stringify({ properties: props, areas })
    });
    const result = await res.json();
    // Save comparison
    const { data } = await supabaseClient.from('comparisons').insert({
      user_id: user.id, property_ids: props.map(p => p.id), ai_summary: result.summary, ai_questions: JSON.stringify(result.questions)
    }).select().single();
    return { ...result, id: data?.id, properties: props };
  } catch(e) { console.error('Comparison failed:', e); return null; }
}

function calculateBadge(property, areaData) {
  let yellowReasons = [], redReasons = [];
  if (!property.price) yellowReasons.push('価格未入力');
  if (!property.land_area) yellowReasons.push('面積未入力');
  if (!property.zoning) yellowReasons.push('用途地域不明');
  if (!property.road_access) yellowReasons.push('接道情報不明');
  if (!property.building_coverage) yellowReasons.push('建ぺい率不明');
  if (property.price && property.land_area && areaData) {
    const tsuboPr = property.price / (property.land_area / 3.305785);
    const areaTsubo = areaData.pricePerTsubo;
    if (areaTsubo && Math.abs(tsuboPr - areaTsubo) / areaTsubo > 0.25) redReasons.push('坪単価がエリア相場から乖離');
  }
  const missingCritical = [property.zoning, property.road_access, property.building_coverage, property.elevation, property.infrastructure].filter(v => !v).length;
  if (missingCritical >= 3) redReasons.push('重要項目が複数不明');
  return redReasons.length > 0 ? 'red' : yellowReasons.length > 0 ? 'yellow' : 'none';
}

// SUUMO検索URL生成
const SUUMO_CITY_CODES = { yokkaichi:'24202', kuwana:'24205', suzuka:'24207', inabe:'24212', kameyama:'24210', komono:'24341', toin:'24343' };
function buildSuumoUrl(areaId, opts = {}) {
  const sc = SUUMO_CITY_CODES[areaId] || '';
  const params = new URLSearchParams({ ar:'060', bs:'030', ta:'24', sc, kb: opts.priceMin || '1', kt: opts.priceMax || '999999', mb: opts.areaMin || '1', mt: opts.areaMax || '999999' });
  if (opts.walkMin) params.set('ek', opts.walkMin);
  return `https://suumo.jp/jj/bukken/ichiran/JJ012FC001/?${params}`;
}
function buildAthomeUrl(areaId, opts = {}) {
  return `https://www.athome.co.jp/tochi/mie/list/?ESSION=true`;
}

// ============================================================
// MCP Streamable HTTP Client (with proxy support)
// ============================================================
class MCPClient {
  constructor(mcpUrl, proxyUrl) {
    this.mcpUrl = mcpUrl;
    this.proxyUrl = proxyUrl;
    this.sessionId = null;
    this.requestId = 0;
    this.connected = false;
    this.tools = [];
    this.useProxy = !!proxyUrl;
  }

  _buildFetchUrl() {
    if (this.useProxy) {
      return `${this.proxyUrl}?url=${encodeURIComponent(this.mcpUrl)}`;
    }
    return this.mcpUrl;
  }

  async initialize() {
    // Try proxy first, then direct
    const attempts = this.useProxy
      ? [true, false]  // proxy → direct
      : [false];       // direct only

    let lastError;
    for (const viaProxy of attempts) {
      try {
        this.useProxy = viaProxy;
        const url = this._buildFetchUrl();

        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/event-stream',
          },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: ++this.requestId,
            method: 'initialize',
            params: {
              protocolVersion: '2025-03-26',
              capabilities: {},
              clientInfo: { name: 'yume-no-sumika-realestate', version: '1.0.0' }
            }
          })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const sid = res.headers.get('Mcp-Session-Id');
        if (sid) this.sessionId = sid;

        const data = await this._parseResponse(res);

        // Send initialized notification
        const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
        if (this.sessionId) headers['Mcp-Session-Id'] = this.sessionId;

        await fetch(this._buildFetchUrl(), {
          method: 'POST',
          headers,
          body: JSON.stringify({ jsonrpc: '2.0', method: 'notifications/initialized' })
        });

        this.connected = true;
        console.log(`MCP connected via ${viaProxy ? 'proxy' : 'direct'}`);
        return data;
      } catch (e) {
        lastError = e;
        console.warn(`MCP ${viaProxy ? 'proxy' : 'direct'} failed:`, e.message);
      }
    }
    this.connected = false;
    throw lastError;
  }

  async listTools() {
    const data = await this._request('tools/list', {});
    if (data && data.tools) this.tools = data.tools;
    return this.tools;
  }

  async callTool(name, args = {}) {
    return this._request('tools/call', { name, arguments: args });
  }

  async _request(method, params) {
    const url = this._buildFetchUrl();
    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json, text/event-stream' };
    if (this.sessionId) headers['Mcp-Session-Id'] = this.sessionId;

    const res = await fetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify({ jsonrpc: '2.0', id: ++this.requestId, method, params })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return this._parseResponse(res);
  }

  async _parseResponse(res) {
    const ct = res.headers.get('Content-Type') || '';
    if (ct.includes('text/event-stream')) {
      const text = await res.text();
      const lines = text.split('\n');
      let lastData = null;
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try { lastData = JSON.parse(line.slice(6)); } catch {}
        }
      }
      return lastData?.result || lastData;
    }
    const json = await res.json();
    return json.result || json;
  }
}

// ============================================================
// Pre-loaded Area Data (fallback + base data)
// ============================================================
const AREAS = [
  {
    id: "yokkaichi", name: "四日市市", cityCode: "24202", lat: 34.9650, lng: 136.6244,
    landPriceAvg: 57020, residentialPrice: 48385, commercialPrice: 89007, pricePerTsubo: 188498,
    yoyChange: 1.33, population: 311000, popGrowthRate: -0.3, accessToNagoya: 35,
    hospitals: 42, schools: 58, parks: 35, shopping: 120, safetyScore: 78, childcareScore: 82, naturalScore: 55,
    description: "三重県最大の都市。石油化学コンビナートと港湾を擁する産業都市。近鉄・JR両線で名古屋へ直通。大型商業施設が充実し、医療・教育インフラも県内トップクラス。",
    highlights: ["県内最大の商業集積", "名古屋へ35分", "医療施設充実", "東名阪・新名神IC"],
    risks: ["一部地域の大気環境", "中心部の地価上昇"],
    trend: [{y:"2020",p:52000},{y:"2021",p:53200},{y:"2022",p:54500},{y:"2023",p:55800},{y:"2024",p:56300},{y:"2025",p:57020}],
    recAreas: ["富田・富洲原エリア（駅近で割安）","笹川・日永エリア（住環境良好）","水沢・小山田エリア（自然豊か）"]
  },
  {
    id: "kuwana", name: "桑名市", cityCode: "24205", lat: 35.0585, lng: 136.6834,
    landPriceAvg: 55543, residentialPrice: 53686, commercialPrice: 86714, pricePerTsubo: 183614,
    yoyChange: 0.82, population: 140000, popGrowthRate: -0.5, accessToNagoya: 25,
    hospitals: 18, schools: 28, parks: 22, shopping: 55, safetyScore: 82, childcareScore: 85, naturalScore: 68,
    description: "名古屋への通勤圏として人気。桑名駅から名古屋まで最短25分。ナガシマスパーランドやなばなの里など観光資源も豊富。歴史的な城下町の風情が残る。",
    highlights: ["名古屋へ最短25分","子育て環境◎","観光資源豊富","住環境の良さ"],
    risks: ["揖斐川・長良川の洪水リスク","人口減少傾向"],
    trend: [{y:"2020",p:52500},{y:"2021",p:53000},{y:"2022",p:53800},{y:"2023",p:54500},{y:"2024",p:55100},{y:"2025",p:55543}],
    recAreas: ["桑名駅周辺（利便性重視）","多度エリア（自然と価格バランス）","長島エリア（ゆったり居住）"]
  },
  {
    id: "suzuka", name: "鈴鹿市", cityCode: "24207", lat: 34.8824, lng: 136.5842,
    landPriceAvg: 41015, residentialPrice: 38000, commercialPrice: 62000, pricePerTsubo: 135587,
    yoyChange: 1.11, population: 195000, popGrowthRate: -0.2, accessToNagoya: 55,
    hospitals: 25, schools: 42, parks: 28, shopping: 72, safetyScore: 80, childcareScore: 80, naturalScore: 65,
    description: "鈴鹿サーキットとHonda技研の企業城下町。名古屋圏と比べ地価が手頃で、広い土地を確保しやすい。新名神鈴鹿スマートICの開通で交通利便性が向上。",
    highlights: ["地価が手頃で広い家が建てやすい","Honda関連の雇用安定","新名神スマートIC","中勢バイパス整備"],
    risks: ["名古屋通勤にはやや遠い","沿岸部の津波リスク"],
    trend: [{y:"2020",p:38500},{y:"2021",p:39000},{y:"2022",p:39600},{y:"2023",p:40200},{y:"2024",p:40600},{y:"2025",p:41015}],
    recAreas: ["白子駅周辺（利便性◎）","平田・算所エリア（落ち着いた住宅地）","庄野・加佐登エリア（新興住宅地）"]
  },
  {
    id: "inabe", name: "いなべ市", cityCode: "24212", lat: 35.1146, lng: 136.5612,
    landPriceAvg: 24500, residentialPrice: 22000, commercialPrice: 35000, pricePerTsubo: 81000,
    yoyChange: 0.45, population: 44000, popGrowthRate: -0.8, accessToNagoya: 65,
    hospitals: 6, schools: 14, parks: 18, shopping: 15, safetyScore: 88, childcareScore: 75, naturalScore: 95,
    description: "鈴鹿山脈の麓に広がる自然豊かなまち。アウトドアレジャーが充実し、移住先として注目度上昇中。地価は県北部で最も手頃な水準。",
    highlights: ["圧倒的な自然環境","地価が非常に手頃","移住支援制度充実","アウトドア天国"],
    risks: ["商業施設が少ない","公共交通が不便","人口減少"],
    trend: [{y:"2020",p:23500},{y:"2021",p:23700},{y:"2022",p:23900},{y:"2023",p:24100},{y:"2024",p:24300},{y:"2025",p:24500}],
    recAreas: ["北勢エリア（駅近・利便性）","員弁エリア（閑静な住宅地）","藤原エリア（山間部・格安）"]
  },
  {
    id: "kameyama", name: "亀山市", cityCode: "24210", lat: 34.8540, lng: 136.4520,
    landPriceAvg: 29500, residentialPrice: 27000, commercialPrice: 42000, pricePerTsubo: 97500,
    yoyChange: 0.68, population: 49000, popGrowthRate: -0.6, accessToNagoya: 60,
    hospitals: 8, schools: 16, parks: 15, shopping: 22, safetyScore: 85, childcareScore: 76, naturalScore: 80,
    description: "東名阪と新名神が交差する交通の要衝。旧東海道の宿場町の歴史を持つ。Sharp亀山工場をはじめ製造業が集積。",
    highlights: ["高速道路の結節点","製造業の雇用","歴史的な街並み","割安な地価"],
    risks: ["JRの本数が少ない","商業施設が限定的"],
    trend: [{y:"2020",p:28000},{y:"2021",p:28300},{y:"2022",p:28700},{y:"2023",p:29000},{y:"2024",p:29200},{y:"2025",p:29500}],
    recAreas: ["亀山駅周辺（JRアクセス）","関エリア（宿場町の風情）","野村エリア（新興住宅地）"]
  },
  {
    id: "komono", name: "菰野町", cityCode: "24341", lat: 35.0244, lng: 136.5090,
    landPriceAvg: 31000, residentialPrice: 29000, commercialPrice: 45000, pricePerTsubo: 102500,
    yoyChange: 0.55, population: 41000, popGrowthRate: -0.1, accessToNagoya: 50,
    hospitals: 7, schools: 12, parks: 20, shopping: 25, safetyScore: 86, childcareScore: 83, naturalScore: 92,
    description: "御在所岳と湯の山温泉を抱える観光と自然のまち。近鉄湯の山線で四日市へ直通。人口減少率が低く、移住先として人気が高い。",
    highlights: ["温泉と自然環境","人口減少率が低い","四日市へのアクセス良好","移住人気上昇中"],
    risks: ["鉄道は湯の山線のみ","大型商業施設が少ない"],
    trend: [{y:"2020",p:29500},{y:"2021",p:29800},{y:"2022",p:30200},{y:"2023",p:30500},{y:"2024",p:30800},{y:"2025",p:31000}],
    recAreas: ["菰野駅周辺（利便性重視）","湯の山エリア（温泉・自然）","竹成・千草エリア（閑静）"]
  },
  {
    id: "toin", name: "東員町", cityCode: "24343", lat: 35.0690, lng: 136.6030,
    landPriceAvg: 35500, residentialPrice: 33000, commercialPrice: 48000, pricePerTsubo: 117400,
    yoyChange: 0.72, population: 26000, popGrowthRate: 0.1, accessToNagoya: 40,
    hospitals: 5, schools: 8, parks: 12, shopping: 18, safetyScore: 87, childcareScore: 88, naturalScore: 72,
    description: "イオンモール東員を中心に商業施設が充実したコンパクトシティ。人口が微増傾向でファミリー層に人気。",
    highlights: ["人口増加傾向","イオンモール東員","子育て世代に人気","コンパクトで住みやすい"],
    risks: ["鉄道アクセスが限定的","町域が狭い"],
    trend: [{y:"2020",p:33500},{y:"2021",p:34000},{y:"2022",p:34500},{y:"2023",p:35000},{y:"2024",p:35200},{y:"2025",p:35500}],
    recAreas: ["東員駅周辺（駅近）","笹尾エリア（ファミリー向け）","城山エリア（新興住宅地）"]
  }
];

const COLORS = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4'];

// ============================================================
// App State
// ============================================================
const state = {
  view: 'ranking',
  selectedAreaId: null,
  mapSelectedAreaId: null,
  mcpStatus: 'disconnected', // disconnected | connecting | connected | error
  mcpMessage: '',
  mcpLiveData: null,
  weights: { price: 25, access: 20, growth: 15, living: 15, family: 15, nature: 10 },
  charts: {},
  mapSelectedDistrict: null,  // { cityId, districtName } or null
  // Second Opinion
  savedProperties: [],
  soView: null, // null | 'saved' | 'compare'
  soComparison: null, // current comparison result
  soModalOpen: false,
  soModalType: null, // 'search' | 'import'
  soSearchAreaId: null,
};

// Map globals (persistent across renders)
let mapInstance = null;
let mapMarkers = {};
let txMarkerLayer = null; // LayerGroup for transaction markers
let schoolDistrictLayer = null; // GeoJSON layer for school district polygons
let schoolMarkerLayer = null; // LayerGroup for school icon markers
let schoolDistrictData = null; // cached GeoJSON data
let showSchoolDistricts = false; // toggle state
let districtAreaLayer = null; // LayerGroup for district area circles
let showDistrictAreas = false; // toggle state

// ============================================================
// Score Calculation
// ============================================================
function calcScores(area, w) {
  const priceScore = 100 - ((area.residentialPrice - 20000) / 40000) * 100;
  const accessScore = ((70 - area.accessToNagoya) / 70) * 100;
  const growthScore = Math.min(100, Math.max(0, (area.yoyChange / 2) * 100));
  const livingScore = (area.hospitals/45)*25 + (area.schools/60)*25 + (area.shopping/120)*25 + (area.safetyScore/100)*25;
  const familyScore = (area.childcareScore + area.safetyScore + Math.min(100,(area.parks/35)*100)) / 3;
  const natureScore = area.naturalScore;
  const total = priceScore*(w.price/100) + accessScore*(w.access/100) + growthScore*(w.growth/100) + livingScore*(w.living/100) + familyScore*(w.family/100) + natureScore*(w.nature/100);
  return { price: Math.round(priceScore), access: Math.round(accessScore), growth: Math.round(growthScore), living: Math.round(livingScore), family: Math.round(familyScore), nature: Math.round(natureScore), total: Math.round(total) };
}

function getRankedAreas() {
  return AREAS.map(a => ({ ...a, scores: calcScores(a, state.weights) })).sort((a,b) => b.scores.total - a.scores.total);
}

// ============================================================
// Static Data Loading (from pre-fetched JSON)
// ============================================================
async function loadStaticData() {
  try {
    updateStatusText('キャッシュデータ読み込み中...');
    const res = await fetch('data/live-data.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    applyStaticData(data);
    return true;
  } catch (e) {
    console.log('Static data not available:', e.message);
    return false;
  }
}

function applyStaticData(data) {
  for (const area of AREAS) {
    const src = data.areas[area.id];
    if (!src) continue;
    area._liveTransactions = src.transactions;
    area._liveAvgTradePrice = src.avgTradePrice;
    area._liveTransactionCount = src.transactionCount;
    AREA_FULL_LOADED.add(area.id);
  }

  state.mcpStatus = 'connected';
  state.fetchedAt = data.fetchedAt;

  let totalTx = 0;
  AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });

  const fetchDate = new Date(data.fetchedAt).toLocaleDateString('ja-JP');
  state.mcpMessage = `データ読込完了（${fetchDate}取得・計${totalTx.toLocaleString()}件）`;

  render();

  // マップ表示中ならピン表示
  if (state.view === 'map' && txMarkerLayer) {
    showAllTransactionPins();
  }
}

// ============================================================
// MCP Connection
// ============================================================
let mcpReinfo = null;

async function connectMCP() {
  state.mcpStatus = 'connecting';
  state.mcpMessage = 'MCPサーバーに接続中（プロキシ経由で試行）...';
  render();

  try {
    mcpReinfo = new MCPClient(CONFIG.MCP_REINFO, CONFIG.PROXY_URL);
    await mcpReinfo.initialize();
    const tools = await mcpReinfo.listTools();
    state.mcpStatus = 'connected';
    state.mcpMessage = `接続完了 — ${tools.length}個のツールが利用可能`;
    render();

    // Phase 1: 概要取得 → Phase 2: 全エリア詳細を自動取得
    await fetchLiveData();
    fetchAllAreasData();  // バックグラウンドで全エリア取得開始（awaitしない）
  } catch(e) {
    state.mcpStatus = 'error';
    state.mcpMessage = `接続失敗: ${e.message}（キャッシュデータを使用中）`;
    render();
  }
}

// Lightweight status text update (no full re-render)
function updateStatusText(msg) {
  state.mcpMessage = msg;
  const el = document.getElementById('mcp-status-text');
  if (el) el.textContent = msg;
}

// ------------------------------------------------------------
// Phase 1: Quick overview fetch (latest year only, all areas)
// ------------------------------------------------------------
async function fetchLiveData() {
  if (!mcpReinfo || !mcpReinfo.connected) return;

  try {
    updateStatusText('概要データを取得中...');

    const cityResult = await mcpReinfo.callTool('reinfolib-city-list', { area: '24' });

    // Fetch only latest year for quick overview (7 requests)
    const priceResults = [];
    for (const area of AREAS) {
      try {
        updateStatusText(`${area.name} の概要データ取得中...`);
        const priceData = await mcpReinfo.callTool('reinfolib-real-estate-price', {
          year: '2024', area: '24', city: area.cityCode
        });
        priceResults.push({ cityCode: area.cityCode, quarters: [priceData] });
      } catch(e) {
        console.warn(`Overview fetch failed for ${area.name}:`, e);
        priceResults.push({ cityCode: area.cityCode, quarters: [] });
      }
    }

    state.mcpLiveData = { cities: cityResult, prices: priceResults };
    updateAreasWithLiveData(priceResults);

    let totalTx = 0;
    AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
    state.mcpMessage = `概要データ取得完了（計${totalTx}件） — 詳細データを自動取得中...`;

    render();
  } catch(e) {
    state.mcpMessage = `データ取得エラー: ${e.message}（キャッシュデータを使用中）`;
    render();
  }
}

// ------------------------------------------------------------
// Phase 2: Deep fetch for a single area (5 years × 4 quarters)
// ------------------------------------------------------------
const AREA_FULL_LOADED = new Set();
let _currentFetchAreaId = null;
let _fetchPriorityAreaId = null;  // ユーザー選択による優先取得エリア
let _autoFetchRunning = false;    // 全エリア自動取得の実行中フラグ

async function fetchAreaFullData(areaId, options = {}) {
  if (!mcpReinfo || !mcpReinfo.connected) return;
  if (AREA_FULL_LOADED.has(areaId)) return; // already loaded
  if (_currentFetchAreaId === areaId) return; // already fetching

  const area = AREAS.find(a => a.id === areaId);
  if (!area) return;

  _currentFetchAreaId = areaId;

  // 選択中エリアのみオーバーレイ表示（バックグラウンド取得時は非表示）
  const isSelected = state.mapSelectedAreaId === areaId;
  const showOverlay = options.showOverlay !== undefined ? options.showOverlay : isSelected;
  if (showOverlay) showMapLoading(area.name, 0);

  const yearQuarters = [
    { year: '2024', quarter: '4' }, { year: '2024', quarter: '3' },
    { year: '2024', quarter: '2' }, { year: '2024', quarter: '1' },
    { year: '2023', quarter: '4' }, { year: '2023', quarter: '3' },
    { year: '2023', quarter: '2' }, { year: '2023', quarter: '1' },
    { year: '2022', quarter: '4' }, { year: '2022', quarter: '3' },
    { year: '2022', quarter: '2' }, { year: '2022', quarter: '1' },
    { year: '2021', quarter: '4' }, { year: '2021', quarter: '3' },
    { year: '2021', quarter: '2' }, { year: '2021', quarter: '1' },
    { year: '2020', quarter: '4' }, { year: '2020', quarter: '3' },
    { year: '2020', quarter: '2' }, { year: '2020', quarter: '1' },
  ];

  const allData = [];
  let done = 0;
  const total = yearQuarters.length;

  for (const yq of yearQuarters) {
    try {
      done++;
      const pct = Math.round(done / total * 100);
      if (showOverlay) updateMapLoading(`${area.name} ${yq.year}年Q${yq.quarter}`, pct);
      updateStatusText(`${area.name} 詳細取得中... (${done}/${total})`);
      const priceData = await mcpReinfo.callTool('reinfolib-real-estate-price', {
        year: yq.year, quarter: yq.quarter, area: '24', city: area.cityCode
      });
      allData.push(priceData);
    } catch(e) {
      console.warn(`Detail fetch failed for ${area.name} ${yq.year}Q${yq.quarter}:`, e);
    }
  }

  // Merge with existing overview data
  updateAreasWithLiveData([{ cityCode: area.cityCode, quarters: allData }]);

  AREA_FULL_LOADED.add(areaId);
  _currentFetchAreaId = null;

  // オーバーレイ非表示
  if (showOverlay) hideMapLoading();

  const txCount = area._liveTransactions ? area._liveTransactions.length : 0;
  updateStatusText(`${area.name}: 詳細データ取得完了（${txCount}件）`);

  // Update sidebar and pins with fetched data
  if (state.view === 'map') {
    const ranked = getRankedAreas();
    const rankedArea = ranked.find(a => a.id === areaId);
    if (state.mapSelectedAreaId === areaId && rankedArea) {
      updateMapSidebar(rankedArea, ranked);
    }

    // Geocode districts THEN show pins at correct positions
    if (txMarkerLayer) {
      await geocodeAreaDistricts(area, { showOverlay });
      if (state.mapSelectedAreaId === areaId) {
        showTransactionPins(area);
      }
    }
  }

  // Background geocode remaining areas' districts
  geocodeDistrictsBackground().catch(e => console.warn('Geocoding error:', e));
}

// ------------------------------------------------------------
// Auto-fetch: 全エリアのPhase2データを順次取得（優先エリア対応）
// ------------------------------------------------------------
async function fetchAllAreasData() {
  if (_autoFetchRunning) return;
  if (!mcpReinfo || !mcpReinfo.connected) return;

  _autoFetchRunning = true;
  const areaIds = AREAS.map(a => a.id);
  let completedCount = AREA_FULL_LOADED.size;

  while (true) {
    // 次に取得するエリアを決定
    let nextId = null;

    // 1. 優先エリアがあればそれを先に
    if (_fetchPriorityAreaId && !AREA_FULL_LOADED.has(_fetchPriorityAreaId)) {
      nextId = _fetchPriorityAreaId;
      _fetchPriorityAreaId = null;
    }

    // 2. なければ未取得のエリアを順に
    if (!nextId) {
      nextId = areaIds.find(id => !AREA_FULL_LOADED.has(id));
    }

    // 全エリア取得済みなら終了
    if (!nextId) break;

    const remaining = AREAS.length - AREA_FULL_LOADED.size;
    const areaName = AREAS.find(a => a.id === nextId)?.name || nextId;
    updateStatusText(`${areaName} 詳細取得中... （残り${remaining}エリア）`);

    await fetchAreaFullData(nextId);

    completedCount = AREA_FULL_LOADED.size;
  }

  _autoFetchRunning = false;

  // 全完了メッセージ
  let totalTx = 0;
  AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
  state.mcpMessage = `全エリアデータ取得完了（計${totalTx.toLocaleString()}件）`;
  updateStatusText(`全エリアデータ取得完了（計${totalTx.toLocaleString()}件）`);

  // マップ表示中なら全ピン更新
  if (state.view === 'map' && txMarkerLayer && !state.mapSelectedAreaId) {
    const ranked = getRankedAreas();
    showAllTransactionPins(ranked);
  }
}

function extractTransactionsFromMCPResponse(data) {
  let content = data;
  if (content && content.content) content = content.content;
  if (!Array.isArray(content)) {
    // Try alternative structures
    if (content && content.data && Array.isArray(content.data)) {
      console.log('[TX] Direct data array found:', content.data.length, 'records');
      return content.data;
    }
    if (content && typeof content === 'string') {
      try {
        const p = JSON.parse(content);
        if (p.data && Array.isArray(p.data)) {
          console.log('[TX] Parsed string data:', p.data.length, 'records');
          return p.data;
        }
      } catch {}
    }
    console.warn('[TX] Content is not array:', typeof content, content ? Object.keys(content) : 'null');
    return [];
  }
  const textContent = content.find(c => c.type === 'text');
  if (!textContent) {
    console.warn('[TX] No text content found in array of', content.length, 'elements');
    return [];
  }
  try {
    const parsed = JSON.parse(textContent.text);
    if (parsed.data && Array.isArray(parsed.data)) {
      console.log('[TX] Extracted', parsed.data.length, 'records from text content');
      return parsed.data;
    }
    // Try other keys
    for (const key of Object.keys(parsed)) {
      if (Array.isArray(parsed[key]) && parsed[key].length > 0) {
        console.log('[TX] Found array in key', key, ':', parsed[key].length, 'records');
        return parsed[key];
      }
    }
    console.warn('[TX] No data array found. Keys:', Object.keys(parsed));
  } catch(e) {
    console.warn('[TX] JSON parse error:', e.message, 'text:', textContent.text?.substring(0, 200));
  }
  return [];
}

function updateAreasWithLiveData(priceResults) {
  for (const result of priceResults) {
    const area = AREAS.find(a => a.cityCode === result.cityCode);
    if (!area) continue;

    // Merge transactions from all quarters
    const allRecords = [];
    const sources = result.quarters || (result.data ? [result.data] : []);
    console.log(`[DATA] ${area.name}: ${sources.length} sources to process`);
    for (const src of sources) {
      if (!src) continue;
      const records = extractTransactionsFromMCPResponse(src);
      allRecords.push(...records);
    }
    console.log(`[DATA] ${area.name}: ${allRecords.length} total records from all sources`);

    if (allRecords.length === 0) continue;

    // Deduplicate by comprehensive key to avoid removing distinct transactions
    const seen = new Set();
    const uniqueRecords = allRecords.filter(d => {
      const key = [
        d.TradePrice || '',
        d.DistrictName || d.Region || '',
        d.Area || '',
        d.Period || '',
        d.Type || d.TradeType || '',
        d.BuildingYear || '',
        d.NearestStation || '',
        d.FloorPlan || '',
        d.Structure || ''
      ].join('|');
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    console.log(`[DATA] ${area.name}: ${uniqueRecords.length} unique records after dedup (removed ${allRecords.length - uniqueRecords.length})`);
    if (uniqueRecords.length > 0) {
      console.log(`[DATA] ${area.name}: Sample record keys:`, Object.keys(uniqueRecords[0]));
    }

    // Store full transaction records for map display
    area._liveTransactions = uniqueRecords.map(d => ({
      TradePrice: (d.TradePrice != null && d.TradePrice !== '') ? parseInt(d.TradePrice) : null,
      Type: d.Type || d.TradeType || '',
      Area: d.Area ? parseFloat(d.Area) : null,
      FloorPlan: d.FloorPlan || '',
      BuildingYear: d.BuildingYear || '',
      NearestStation: d.NearestStation || '',
      DistanceToStation: d.TimeToNearestStation || d.DistanceToStation || '',
      Use: d.Use || d.Purpose || '',
      District: d.DistrictName || d.Region || '',
      Structure: d.Structure || '',
      CityPlanning: d.CityPlanning || '',
      Period: d.Period || '',
    }));
    console.log(`[DATA] ${area.name}: Final _liveTransactions count = ${area._liveTransactions.length}`);

    // Calculate average trade price from live data
    const prices = uniqueRecords.filter(d => d.TradePrice != null && d.TradePrice !== '').map(d => parseInt(d.TradePrice)).filter(p => !isNaN(p));
    if (prices.length > 0) {
      area._liveAvgTradePrice = Math.round(prices.reduce((a,b) => a+b, 0) / prices.length);
      area._liveTransactionCount = uniqueRecords.length;
    }
  }
}

// ============================================================
// Render Functions
// ============================================================
function render() {
  const app = document.getElementById('app');
  const ranked = getRankedAreas();
  const selected = state.selectedAreaId ? ranked.find(a => a.id === state.selectedAreaId) : ranked[0];

  app.innerHTML = `
    ${renderHeader()}
    <div class="max-w-6xl mx-auto px-4 py-6">
      ${renderWeights()}
      ${state.view === 'ranking' ? renderRanking(ranked) : ''}
      ${state.view === 'compare' ? renderCompare(ranked) : ''}
      ${state.view === 'detail' ? renderDetail(selected, ranked) : ''}
      ${state.view === 'map' ? renderMap(ranked) : ''}
      ${state.view === 'property' ? renderPropertyView() : ''}
      ${renderFooter()}
      ${renderFixedBar()}
      ${renderSOModal()}
    </div>
  `;

  // Re-bindイベント
  bindEvents(ranked);

  // チャート描画・マップ初期化（DOMが存在してから）
  requestAnimationFrame(() => {
    if (state.view === 'compare') drawCompareCharts(ranked);
    if (state.view === 'detail' && selected) drawDetailCharts(selected);
    if (state.view === 'map') {
      initializeMap(ranked);
      if (state.mapSelectedAreaId) {
        const selArea = ranked.find(a => a.id === state.mapSelectedAreaId);
        if (selArea) updateMapSidebar(selArea, ranked);
      }
    }
  });
}

function renderHeader() {
  const tabs = [
    { id: 'ranking', label: '🏆 ランキング' },
    { id: 'compare', label: '📊 比較' },
    { id: 'detail', label: '🔍 詳細' },
    { id: 'map', label: '🗺️ 地図' },
    { id: 'property', label: '🏠 物件比較' }
  ];
  return `
    <header class="glass sticky top-0 z-50 border-b border-gray-200 shadow-sm">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">🏠 三重県 注文住宅エリア比較</h1>
            <p class="text-sm text-gray-500 mt-1">三重県北部の土地相場・取引データを比較して、注文住宅に最適なエリアを見つけよう</p>
            ${state.mcpStatus === 'connected' ? (() => {
              let totalTx = 0;
              AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
              const dateStr = state.fetchedAt ? new Date(state.fetchedAt).toLocaleDateString('ja-JP') : '';
              return `<p class="text-xs text-green-600 mt-1">📊 取引データ ${totalTx.toLocaleString()}件${dateStr ? `（${dateStr} 更新）` : ''}</p>`;
            })() : state.mcpStatus === 'connecting' ? `<p class="text-xs text-blue-500 mt-1">⏳ データ読み込み中...</p>` : ''}
          </div>
          <div class="flex gap-2">
            ${tabs.map(t => `
              <button data-tab="${t.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-all ${state.view === t.id ? 'tab-active' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                ${t.label}
              </button>
            `).join('')}
          </div>
        </div>
      </div>
    </header>
  `;
}

function renderMCPStatus() {
  const statusColors = {
    disconnected: { bg: 'bg-gray-100', text: 'text-gray-600', dot: 'bg-gray-400' },
    connecting: { bg: 'bg-blue-50', text: 'text-blue-700', dot: 'bg-blue-500' },
    connected: { bg: 'bg-green-50', text: 'text-green-700', dot: 'bg-green-500' },
    error: { bg: 'bg-amber-50', text: 'text-amber-700', dot: 'bg-amber-500' }
  };
  const s = statusColors[state.mcpStatus];
  const statusLabel = { disconnected: '未接続', connecting: '取得中', connected: 'データ取得済', error: 'フォールバック' }[state.mcpStatus];

  return `
    <div class="card p-4 mb-4 flex items-center justify-between flex-wrap gap-3">
      <div class="flex items-center gap-3">
        <div class="status-badge ${s.bg} ${s.text}">
          <span class="pulse-dot ${s.dot}"></span>
          ${statusLabel}
        </div>
        <span id="mcp-status-text" class="text-sm text-gray-500">${state.mcpMessage || 'データ読み込み中...'}</span>
      </div>
      <div class="flex gap-2">
        ${state.mcpStatus === 'connected' ? `
          <button id="btn-connect-mcp" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
            🔄 最新データ取得
          </button>
        ` : state.mcpStatus === 'connecting' ? `
          <span class="text-xs text-blue-600 self-center">取得中...</span>
        ` : `
          <button id="btn-connect-mcp" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
            🔌 MCPサーバーに接続
          </button>
        `}
      </div>
    </div>
  `;
}

function renderWeights() {
  const items = [
    { key: 'price', label: '価格の手頃さ', icon: '💰' },
    { key: 'access', label: '名古屋アクセス', icon: '🚃' },
    { key: 'growth', label: '資産価値上昇', icon: '📈' },
    { key: 'living', label: '生活利便性', icon: '🏪' },
    { key: 'family', label: '子育て環境', icon: '👨‍👩‍👧‍👦' },
    { key: 'nature', label: '自然環境', icon: '🌿' }
  ];
  return `
    <div class="card p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">🎯 あなたの優先度を設定</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        ${items.map(i => `
          <div class="flex items-center gap-3">
            <span class="text-xl w-8 text-center">${i.icon}</span>
            <div class="flex-1">
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">${i.label}</span>
                <span class="text-sm font-bold text-blue-600" id="wv-${i.key}">${state.weights[i.key]}</span>
              </div>
              <input type="range" min="0" max="50" value="${state.weights[i.key]}" data-weight="${i.key}"
                class="w-full cursor-pointer" style="background: linear-gradient(to right, #3b82f6 0%, #3b82f6 ${state.weights[i.key]*2}%, #e5e7eb ${state.weights[i.key]*2}%, #e5e7eb 100%);">
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderRanking(ranked) {
  const medals = ['medal-gold','medal-silver','medal-bronze'];
  const scoreKeys = [
    { key: 'price', label: '価格' },
    { key: 'access', label: '交通' },
    { key: 'growth', label: '成長' },
    { key: 'living', label: '利便' },
    { key: 'family', label: '子育' },
    { key: 'nature', label: '自然' }
  ];

  return `
    <div class="space-y-4 fade-in">
      <h2 class="text-lg font-bold text-gray-800">🏆 おすすめエリアランキング</h2>
      ${ranked.map((a, idx) => `
        <div class="card p-5 cursor-pointer" data-area-detail="${a.id}">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 flex flex-col items-center w-16">
              <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg ${idx < 3 ? medals[idx] : 'bg-slate-400'}">
                ${idx + 1}
              </div>
              <div class="text-2xl font-bold text-blue-600 mt-1">${a.scores.total}<span class="text-xs text-gray-400 font-normal">pt</span></div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="text-xl font-bold text-gray-900">${a.name}</h3>
                ${a.popGrowthRate > 0 ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">人口増加中</span>' : ''}
                ${a._liveTransactionCount ? `<span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">LIVE ${a._liveTransactionCount}件</span>` : ''}
              </div>
              <p class="text-sm text-gray-600 mb-3">${a.description}</p>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                  <div class="text-xs text-gray-500">住宅地価格</div>
                  <div class="text-sm font-bold text-blue-700">${(a.residentialPrice/10000).toFixed(1)}万/m²</div>
                </div>
                <div class="text-center p-2 bg-green-50 rounded-lg">
                  <div class="text-xs text-gray-500">名古屋まで</div>
                  <div class="text-sm font-bold text-green-700">${a.accessToNagoya}分</div>
                </div>
                <div class="text-center p-2 bg-amber-50 rounded-lg">
                  <div class="text-xs text-gray-500">地価変動</div>
                  <div class="text-sm font-bold text-amber-700">+${a.yoyChange}%</div>
                </div>
                <div class="text-center p-2 bg-purple-50 rounded-lg">
                  <div class="text-xs text-gray-500">人口</div>
                  <div class="text-sm font-bold text-purple-700">${(a.population/10000).toFixed(1)}万人</div>
                </div>
              </div>
            </div>
            <div class="flex-shrink-0 w-28 space-y-1 hidden sm:block">
              ${scoreKeys.map(s => `
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-400 w-8 text-right">${s.label}</span>
                  <div class="score-bar flex-1"><div class="score-bar-fill bg-blue-500" style="width:${a.scores[s.key]}%"></div></div>
                  <span class="text-xs text-gray-500 w-5 text-right">${a.scores[s.key]}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderCompare(ranked) {
  return `
    <div class="space-y-6 fade-in">
      <h2 class="text-lg font-bold text-gray-800">📊 エリア比較</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">住宅地価格 × 総合スコア</h3>
          <canvas id="chart-bar" height="260"></canvas>
        </div>
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">地価推移（2020-2025年）</h3>
          <canvas id="chart-trend" height="260"></canvas>
        </div>
      </div>
      <div class="card p-6 overflow-x-auto">
        <h3 class="text-base font-bold text-gray-700 mb-4">全エリア比較一覧</h3>
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-left py-2 px-3 font-medium text-gray-600">エリア</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">住宅地(円/m²)</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">坪単価</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">変動率</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">名古屋</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">人口</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">スコア</th>
            </tr>
          </thead>
          <tbody>
            ${ranked.map((a,i) => `
              <tr class="border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-area-detail="${a.id}">
                <td class="py-3 px-3 font-medium text-gray-900">
                  <span class="inline-flex items-center gap-2">
                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold" style="background:${i<3?'#3b82f6':'#94a3b8'}">${i+1}</span>
                    ${a.name}
                  </span>
                </td>
                <td class="py-3 px-3 text-right">${a.residentialPrice.toLocaleString()}</td>
                <td class="py-3 px-3 text-right">${a.pricePerTsubo.toLocaleString()}</td>
                <td class="py-3 px-3 text-right text-green-600 font-medium">+${a.yoyChange}%</td>
                <td class="py-3 px-3 text-right">${a.accessToNagoya}分</td>
                <td class="py-3 px-3 text-right">${(a.population/10000).toFixed(1)}万</td>
                <td class="py-3 px-3 text-right">
                  <span class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-bold text-xs">${a.scores.total}pt</span>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderDetail(area, ranked) {
  if (!area) return '<p>エリアを選択してください</p>';
  const scoreItems = [
    { key: 'price', label: '価格の手頃さ', color: '#3b82f6' },
    { key: 'access', label: '名古屋アクセス', color: '#10b981' },
    { key: 'growth', label: '資産価値上昇', color: '#f59e0b' },
    { key: 'living', label: '生活利便性', color: '#ef4444' },
    { key: 'family', label: '子育て環境', color: '#8b5cf6' },
    { key: 'nature', label: '自然環境', color: '#06b6d4' }
  ];

  return `
    <div class="space-y-6 fade-in">
      <div class="flex items-center gap-3 flex-wrap">
        <button id="btn-back" class="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors">← 戻る</button>
        <h2 class="text-lg font-bold text-gray-800">🔍 ${area.name} の詳細分析</h2>
        <button id="btn-to-map" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-50 transition-colors ml-auto">🗺️ マップで表示</button>
      </div>

      <div class="flex flex-wrap gap-2">
        ${ranked.map(a => `
          <button data-area-switch="${a.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-all ${area.id===a.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}">
            ${a.name}
          </button>
        `).join('')}
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- レーダーチャート -->
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">総合評価</h3>
          <canvas id="chart-radar" height="280"></canvas>
          <div class="text-center mt-4">
            <span class="text-4xl font-bold text-blue-600">${area.scores.total}</span>
            <span class="text-sm text-gray-400 ml-1">/ 100点</span>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-4">
            ${scoreItems.map(s => `
              <div class="text-center">
                <div class="text-xs text-gray-500">${s.label}</div>
                <div class="text-lg font-bold" style="color:${s.color}">${area.scores[s.key]}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- 基本情報 -->
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">基本データ</h3>
          <div class="space-y-3">
            ${[
              ['🏠 住宅地平均', `${area.residentialPrice.toLocaleString()}円/m²`],
              ['💴 坪単価', `${area.pricePerTsubo.toLocaleString()}円/坪`],
              ['📈 前年比変動', `+${area.yoyChange}%`],
              ['👥 人口', `${area.population.toLocaleString()}人`],
              ['🚃 名古屋まで', `約${area.accessToNagoya}分`],
              ['🏥 医療施設', `${area.hospitals}施設`],
              ['🏫 教育施設', `${area.schools}施設`],
              ['🛍 商業施設', `${area.shopping}施設`],
            ].map(([l,v]) => `
              <div class="flex justify-between items-center py-2 border-b border-gray-50">
                <span class="text-sm text-gray-600">${l}</span>
                <span class="text-sm font-bold text-gray-900">${v}</span>
              </div>
            `).join('')}
            ${area._liveAvgTradePrice ? `
              <div class="flex justify-between items-center py-2 border-b border-blue-100 bg-blue-50 rounded px-2 mt-2">
                <span class="text-sm text-blue-600 font-medium">🔴 LIVE 平均取引価格</span>
                <span class="text-sm font-bold text-blue-700">${area._liveAvgTradePrice.toLocaleString()}円</span>
              </div>
            ` : ''}
          </div>
        </div>
      </div>

      <!-- 地価推移 -->
      <div class="card p-6">
        <h3 class="text-base font-bold text-gray-700 mb-4">地価推移</h3>
        <canvas id="chart-detail-trend" height="200"></canvas>
      </div>

      <!-- 概要・ポイント・注意点 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-5">
          <h3 class="text-base font-bold text-gray-700 mb-3">📝 概要</h3>
          <p class="text-sm text-gray-600 leading-relaxed">${area.description}</p>
        </div>
        <div class="rounded-xl p-5 bg-green-50 border border-green-200">
          <h3 class="text-base font-bold text-green-700 mb-3">✅ ポイント</h3>
          <ul class="space-y-2">
            ${area.highlights.map(h => `<li class="text-sm text-green-800 flex items-start gap-2"><span class="mt-0.5">•</span>${h}</li>`).join('')}
          </ul>
        </div>
        <div class="rounded-xl p-5 bg-amber-50 border border-amber-200">
          <h3 class="text-base font-bold text-amber-700 mb-3">⚠️ 注意点</h3>
          <ul class="space-y-2">
            ${area.risks.map(r => `<li class="text-sm text-amber-800 flex items-start gap-2"><span class="mt-0.5">•</span>${r}</li>`).join('')}
          </ul>
        </div>
      </div>

      <!-- おすすめエリア -->
      <div class="rounded-xl p-6 bg-blue-50 border border-blue-200">
        <h3 class="text-base font-bold text-blue-700 mb-3">🎯 ${area.name}のおすすめ物件エリア</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          ${area.recAreas.map((r,i) => `
            <div class="bg-white rounded-lg p-4 border border-blue-100">
              <div class="text-xs text-blue-500 font-medium mb-1">おすすめ ${i+1}</div>
              <div class="text-sm font-medium text-gray-800">${r}</div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- 物件検索/URL取り込みセクション -->
      <div class="card p-6 space-y-4">
        <h3 class="text-base font-bold text-gray-800">🤖 ${area.name}で物件を探す</h3>
        <div class="flex flex-wrap gap-3">
          <button onclick="openSearchModal('${area.id}')" class="px-5 py-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
            🤖 AIで物件を検索
          </button>
          <span class="text-xs text-gray-400 self-center">希望条件を自由に入力 → AIが検索</span>
        </div>
        <div class="border-t border-gray-200 pt-4">
          <p class="text-sm text-gray-600 mb-2">物件情報をAIで取り込み（物件サイトの情報をコピペ）</p>
          <div class="flex gap-2">
            <input id="url-import-detail" type="url" placeholder="物件URL（任意）" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            <button onclick="openImportModal('${area.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
              🤖 AI取り込み
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Map View
// ============================================================
function renderMap(ranked) {
  const selArea = state.mapSelectedAreaId ? ranked.find(a => a.id === state.mapSelectedAreaId) : null;
  return `
    <div class="space-y-4 fade-in">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-800">🗺️ エリアマップ</h2>
        <div class="flex gap-2">
          <button id="btn-district-area-toggle" class="school-toggle ${showDistrictAreas ? 'active' : ''}" onclick="toggleDistrictAreas()">
            <span>${showDistrictAreas ? '📊 エリア ON' : '📊 エリア'}</span>
          </button>
          <button id="btn-school-toggle" class="school-toggle ${showSchoolDistricts ? 'active' : ''}" onclick="toggleSchoolDistricts()">
            <span>${showSchoolDistricts ? '🏫 学区 ON' : '🏫 学区'}</span>
          </button>
          <button id="btn-fullscreen-toggle" class="map-fullscreen-btn" onclick="toggleMapFullscreen()">
            <span id="fullscreen-icon">⛶</span> <span id="fullscreen-label">拡大</span>
          </button>
        </div>
      </div>
      <!-- Fullscreen floating controls -->
      <div id="map-fullscreen-controls" class="map-fullscreen-controls">
        <span style="font-weight:600;font-size:13px;color:#1e40af;">🗺️ エリアマップ</span>
        <button class="school-toggle ${showDistrictAreas ? 'active' : ''}" onclick="toggleDistrictAreas()">
          <span>${showDistrictAreas ? '📊 エリア ON' : '📊 エリア'}</span>
        </button>
        <button class="school-toggle ${showSchoolDistricts ? 'active' : ''}" onclick="toggleSchoolDistricts()">
          <span>${showSchoolDistricts ? '🏫 学区 ON' : '🏫 学区'}</span>
        </button>
        <button class="map-fullscreen-btn active" onclick="toggleMapFullscreen()">
          <span>✕</span> <span>閉じる</span>
        </button>
      </div>
      <div class="card overflow-hidden">
        <div class="map-layout" style="position:relative;">
          <div id="map-container"></div>
          <div id="map-loading-overlay" class="map-loading-overlay hidden">
            <div class="map-loading-box">
              <div class="map-loading-spinner"></div>
              <div id="map-loading-text" style="font-size:13px;font-weight:600;color:#1e40af;">データ取得中...</div>
              <div class="map-loading-progress"><div id="map-loading-bar" class="map-loading-progress-bar" style="width:0%"></div></div>
            </div>
          </div>
          <div id="map-sidebar">
            ${selArea ? '' : `
              <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="text-4xl mb-3">📍</div>
                <p class="text-sm font-medium text-gray-700 mb-1">エリアを選択してください</p>
                <p class="text-xs text-gray-400">マップ上のマーカーをクリックすると<br>土地情報・取引データが表示されます</p>
              </div>
            `}
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Map Fullscreen Toggle
// ============================================================
let _mapFullscreen = false;

function toggleMapFullscreen() {
  _mapFullscreen = !_mapFullscreen;
  const layout = document.querySelector('.map-layout');
  const btn = document.getElementById('btn-fullscreen-toggle');
  const icon = document.getElementById('fullscreen-icon');
  const label = document.getElementById('fullscreen-label');
  const floatingCtrl = document.getElementById('map-fullscreen-controls');
  if (!layout) return;

  if (_mapFullscreen) {
    layout.classList.add('map-fullscreen');
    if (btn) btn.classList.add('active');
    if (icon) icon.textContent = '✕';
    if (label) label.textContent = '閉じる';
    // カードの角丸を無効化
    const card = layout.closest('.card');
    if (card) card.style.borderRadius = '0';
    // フローティングコントロール表示
    if (floatingCtrl) floatingCtrl.classList.add('visible');
    // スクロール無効化
    document.body.style.overflow = 'hidden';
  } else {
    layout.classList.remove('map-fullscreen');
    if (btn) btn.classList.remove('active');
    if (icon) icon.textContent = '⛶';
    if (label) label.textContent = '拡大';
    const card = layout.closest('.card');
    if (card) card.style.borderRadius = '';
    // フローティングコントロール非表示
    if (floatingCtrl) floatingCtrl.classList.remove('visible');
    // スクロール復活
    document.body.style.overflow = '';
  }

  // Leaflet地図サイズ再計算
  if (mapInstance) {
    setTimeout(() => { mapInstance.invalidateSize(); }, 200);
  }
}

// ESCキーで全画面解除
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && _mapFullscreen) {
    toggleMapFullscreen();
  }
});

// ============================================================
// School District Layer
// ============================================================
const SCHOOL_DISTRICT_COLORS = [
  '#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316',
  '#14b8a6','#6366f1','#84cc16','#e11d48','#0ea5e9','#a855f7','#10b981','#f43f5e'
];

// ============================================================
// District Area Layer (toggleable, like school districts)
// ============================================================
const DISTRICT_AREA_COLORS = [
  '#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316',
  '#14b8a6','#6366f1','#84cc16','#e11d48','#0ea5e9','#a855f7','#10b981','#f43f5e'
];

function toggleDistrictAreas() {
  showDistrictAreas = !showDistrictAreas;
  const btn = document.getElementById('btn-district-area-toggle');
  if (btn) {
    btn.classList.toggle('active', showDistrictAreas);
    btn.querySelector('span').textContent = showDistrictAreas ? '📊 エリア ON' : '📊 エリア';
  }
  if (showDistrictAreas) {
    renderDistrictAreas();
  } else {
    if (districtAreaLayer && mapInstance) {
      mapInstance.removeLayer(districtAreaLayer);
      districtAreaLayer = null;
    }
    // Clear district sidebar if showing
    state.mapSelectedDistrict = null;
  }
}

function renderDistrictAreas() {
  if (!mapInstance) return;
  if (districtAreaLayer) { mapInstance.removeLayer(districtAreaLayer); }
  districtAreaLayer = L.layerGroup();

  // Collect all districts with coordinates from all areas that have transactions
  const districtEntries = [];
  AREAS.forEach(area => {
    if (!area._liveTransactions) return;
    const districtMap = {};
    area._liveTransactions.forEach(tx => {
      if (!tx.District) return;
      if (!districtMap[tx.District]) districtMap[tx.District] = 0;
      districtMap[tx.District]++;
    });
    Object.entries(districtMap).forEach(([districtName, count]) => {
      const coords = findDistrictCoords(districtName, area.name);
      if (coords) {
        districtEntries.push({ districtName, cityName: area.name, cityId: area.id, coords, count, area });
      }
    });
  });

  let colorIdx = 0;
  districtEntries.forEach(entry => {
    const color = DISTRICT_AREA_COLORS[colorIdx++ % DISTRICT_AREA_COLORS.length];
    const radius = Math.max(200, Math.min(600, entry.count * 80));

    const circle = L.circle([entry.coords[0], entry.coords[1]], {
      radius: radius,
      color: color,
      weight: 2,
      opacity: 0.8,
      fillColor: color,
      fillOpacity: 0.15,
      dashArray: '4 3'
    });

    // Tooltip with district name
    circle.bindTooltip(`${entry.districtName} (${entry.count}件)`, {
      permanent: false, direction: 'top', className: 'map-tooltip'
    });

    // Click → show district info in sidebar
    circle.on('click', () => {
      state.mapSelectedDistrict = { cityId: entry.cityId, districtName: entry.districtName };
      state.mapSelectedAreaId = entry.cityId;
      const ranked = getRankedAreas();
      updateDistrictSidebar(entry.area, entry.districtName, ranked);
      // Highlight this district circle
      renderDistrictAreas();
    });

    // Highlight selected district
    if (state.mapSelectedDistrict &&
        state.mapSelectedDistrict.cityId === entry.cityId &&
        state.mapSelectedDistrict.districtName === entry.districtName) {
      circle.setStyle({ fillOpacity: 0.35, weight: 3, opacity: 1, dashArray: null });
    }

    circle.on('mouseover', function() { this.setStyle({ fillOpacity: 0.3, weight: 3 }); });
    circle.on('mouseout', function() {
      const isSelected = state.mapSelectedDistrict &&
        state.mapSelectedDistrict.cityId === entry.cityId &&
        state.mapSelectedDistrict.districtName === entry.districtName;
      this.setStyle({
        fillOpacity: isSelected ? 0.35 : 0.15,
        weight: isSelected ? 3 : 2
      });
    });

    districtAreaLayer.addLayer(circle);

    // Add label marker
    const label = L.marker([entry.coords[0], entry.coords[1]], {
      icon: L.divIcon({
        html: `<div style="font-size:10px;font-weight:600;color:${color};text-shadow:1px 1px 2px white,-1px -1px 2px white,1px -1px 2px white,-1px 1px 2px white;white-space:nowrap;text-align:center;pointer-events:none;">${entry.districtName}</div>`,
        className: 'school-icon-marker',
        iconSize: [80, 16],
        iconAnchor: [40, 8]
      }),
      interactive: false
    });
    districtAreaLayer.addLayer(label);
  });

  districtAreaLayer.addTo(mapInstance);
}

// ============================================================
// School District Layer
// ============================================================
async function loadSchoolDistrictData() {
  if (schoolDistrictData) return schoolDistrictData;
  try {
    const resp = await fetch('school-districts.geojson');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    schoolDistrictData = await resp.json();
    console.log(`School districts loaded: ${schoolDistrictData.features.length} zones`);
    return schoolDistrictData;
  } catch(e) {
    console.warn('School district data load failed:', e);
    return null;
  }
}

function toggleSchoolDistricts() {
  showSchoolDistricts = !showSchoolDistricts;
  const btn = document.getElementById('btn-school-toggle');
  if (btn) {
    btn.classList.toggle('active', showSchoolDistricts);
    btn.querySelector('span').textContent = showSchoolDistricts ? '🏫 学区 ON' : '🏫 学区';
  }
  if (showSchoolDistricts) {
    renderSchoolDistricts();
  } else {
    if (schoolDistrictLayer && mapInstance) {
      mapInstance.removeLayer(schoolDistrictLayer);
      schoolDistrictLayer = null;
    }
    if (schoolMarkerLayer && mapInstance) {
      mapInstance.removeLayer(schoolMarkerLayer);
      schoolMarkerLayer = null;
    }
  }
}

async function renderSchoolDistricts() {
  if (!mapInstance) return;
  const data = await loadSchoolDistrictData();
  if (!data) return;

  // Remove existing layers
  if (schoolDistrictLayer) { mapInstance.removeLayer(schoolDistrictLayer); }
  if (schoolMarkerLayer) { mapInstance.removeLayer(schoolMarkerLayer); }

  // Separate polygons and points
  const polygonFeatures = { type: 'FeatureCollection', features: data.features.filter(f => f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon') };
  const pointFeatures = data.features.filter(f => f.geometry.type === 'Point' && f.properties.type === 'school');

  // Render polygon overlays (school district boundaries)
  let colorIdx = 0;
  schoolDistrictLayer = L.geoJSON(polygonFeatures, {
    style: (feature) => {
      const color = SCHOOL_DISTRICT_COLORS[colorIdx++ % SCHOOL_DISTRICT_COLORS.length];
      return { color, weight: 2, opacity: 0.7, fillColor: color, fillOpacity: 0.08, dashArray: '4 3' };
    },
    onEachFeature: (feature, layer) => {
      const p = feature.properties;
      layer.bindPopup(`
        <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
          <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">🏫 ${p.name}</div>
          <table style="font-size:11px;">
            <tr><td style="color:#6b7280;padding-right:8px;">設置者</td><td>${p.org}</td></tr>
            <tr><td style="color:#6b7280;padding-right:8px;">所在地</td><td>${p.address}</td></tr>
          </table>
        </div>
      `, { maxWidth: 240 });
      layer.on('mouseover', function() { this.setStyle({ fillOpacity: 0.25, weight: 3 }); });
      layer.on('mouseout', function() { this.setStyle({ fillOpacity: 0.08, weight: 2 }); });
    }
  }).addTo(mapInstance);
  schoolDistrictLayer.bringToBack();

  // Render school icon markers
  const schoolIcon = L.divIcon({
    html: '<div style="font-size:20px;text-align:center;line-height:1;filter:drop-shadow(1px 1px 1px rgba(0,0,0,0.3));">🏫</div>',
    className: 'school-icon-marker',
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -14]
  });

  schoolMarkerLayer = L.layerGroup();
  pointFeatures.forEach(f => {
    const p = f.properties;
    const coords = f.geometry.coordinates;
    const marker = L.marker([coords[1], coords[0]], { icon: schoolIcon, zIndexOffset: 500 });
    marker.bindPopup(`
      <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
        <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">🏫 ${p.name}</div>
        <table style="font-size:11px;">
          <tr><td style="color:#6b7280;padding-right:8px;">設置者</td><td>${p.org}</td></tr>
          <tr><td style="color:#6b7280;padding-right:8px;">所在地</td><td>${p.address}</td></tr>
        </table>
      </div>
    `, { maxWidth: 240 });
    schoolMarkerLayer.addLayer(marker);
  });
  schoolMarkerLayer.addTo(mapInstance);
}

function initializeMap(ranked) {
  const container = document.getElementById('map-container');
  if (!container || !window.L) return;

  // Destroy existing map if present (container re-created by render)
  if (mapInstance) {
    try { mapInstance.remove(); } catch {}
    mapInstance = null;
    mapMarkers = {};
    txMarkerLayer = null;
  }

  // Create map centered on northern Mie
  mapInstance = L.map('map-container', { zoomControl: true }).setView([34.98, 136.56], 10);

  // OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>',
    maxZoom: 18
  }).addTo(mapInstance);

  // Transaction marker layer
  txMarkerLayer = L.layerGroup().addTo(mapInstance);

  // Create city markers
  ranked.forEach((area, idx) => {
    const color = COLORS[AREAS.findIndex(a => a.id === area.id) % COLORS.length];
    const rank = idx + 1;
    const icon = createMapIcon(color, rank, area.scores.total, area.id === state.mapSelectedAreaId);

    const marker = L.marker([area.lat, area.lng], { icon, zIndexOffset: 1000 })
      .addTo(mapInstance);

    marker.bindTooltip(`${area.name} (${area.scores.total}pt)`, {
      direction: 'top', offset: [0, -20], className: 'map-tooltip'
    });

    marker.on('click', async () => {
      state.mapSelectedAreaId = area.id;
      state.mapSelectedDistrict = null; // Reset district selection
      ranked.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, a.id === area.id));
      });
      updateMapSidebar(area, ranked);
      // Geocode districts before showing pins
      await geocodeAreaDistricts(area);
      showTransactionPins(area);
      mapInstance.flyTo([area.lat, area.lng], 13, { duration: 0.8 });

      // 未取得エリアなら優先指定（自動取得中→次に処理、停止中→直接取得）
      if (!AREA_FULL_LOADED.has(area.id)) {
        _fetchPriorityAreaId = area.id;
        if (!_autoFetchRunning && mcpReinfo && mcpReinfo.connected) {
          fetchAreaFullData(area.id);
        }
      }
    });

    mapMarkers[area.id] = marker;
  });

  // Show all transaction pins at overview
  showAllTransactionPins(ranked);

  // Restore layers if enabled
  if (showSchoolDistricts) {
    renderSchoolDistricts();
  }
  if (showDistrictAreas) {
    renderDistrictAreas();
  }

  // If area already selected, zoom to it and auto-fetch full data
  if (state.mapSelectedAreaId) {
    const sel = ranked.find(a => a.id === state.mapSelectedAreaId);
    if (sel) {
      showTransactionPins(sel);
      mapInstance.setView([sel.lat, sel.lng], 13);
      if (!AREA_FULL_LOADED.has(sel.id)) {
        _fetchPriorityAreaId = sel.id;
        if (!_autoFetchRunning && mcpReinfo && mcpReinfo.connected) {
          fetchAreaFullData(sel.id);
        }
      }
    }
  }
}

// ============================================================
// Station Coordinate Database (Northern Mie Prefecture)
// ============================================================
const STATION_COORDS = {
  // 四日市市
  '近鉄四日市':[34.9665,136.6142],'四日市':[34.9667,136.6186],'富田':[34.989,136.6266],
  '富洲原':[34.997,136.631],'阿倉川':[34.976,136.6175],'川原町':[34.972,136.6153],
  '新正':[34.962,136.6154],'赤堀':[34.958,136.6156],'日永':[34.944,136.6088],
  '南日永':[34.952,136.612],'泊':[34.938,136.611],'追分':[34.934,136.605],
  '内部':[34.928,136.5925],'小古曽':[34.936,136.599],'河原田':[34.912,136.5814],
  '塩浜':[34.938,136.6217],'海山道':[34.956,136.6238],'霞ヶ浦':[34.957,136.6262],
  '大矢知':[34.997,136.628],'平津':[34.996,136.618],'暁学園前':[34.993,136.608],
  '山城':[34.981,136.5936],'保々':[34.991,136.582],'北楠':[34.918,136.61],
  '楠':[34.912,136.615],'南四日市':[34.947,136.62],'中川原':[34.961,136.607],
  '伊勢松本':[34.969,136.601],'西日野':[34.95,136.597],'近鉄富田':[34.988,136.622],
  // 桑名市
  '桑名':[35.0614,136.6918],'播磨':[35.046,136.677],'益生':[35.066,136.6785],
  '馬道':[35.06,136.686],'西桑名':[35.062,136.686],'在良':[35.073,136.676],
  '星川':[35.081,136.671],'七和':[35.087,136.659],'穴太':[35.091,136.65],
  '多度':[35.117,136.629],'長島':[35.076,136.715],'蓮花寺':[35.078,136.665],
  '下深谷':[35.039,136.669],'伊勢朝日':[35.032,136.669],
  // 鈴鹿市
  '白子':[34.843,136.611],'鈴鹿':[34.871,136.543],'鈴鹿市':[34.881,136.581],
  '三日市':[34.874,136.577],'平田町':[34.876,136.559],'加佐登':[34.886,136.523],
  '玉垣':[34.855,136.601],'柳':[34.848,136.599],'磯山':[34.836,136.615],
  '千代崎':[34.831,136.617],'箕田':[34.863,136.593],'鼓ヶ浦':[34.838,136.613],
  '徳田':[34.884,136.559],'伊勢若松':[34.856,136.608],'千里':[34.887,136.506],
  '中瀬古':[34.866,136.571],
  // いなべ市
  '三里':[35.093,136.554],'北勢中央公園口':[35.087,136.548],'麻生田':[35.099,136.548],
  '阿下喜':[35.126,136.549],'楚原':[35.116,136.549],'大泉':[35.108,136.554],
  '梅戸井':[35.084,136.551],
  // 亀山市
  '亀山':[34.855,136.449],'関':[34.855,136.397],'加太':[34.85,136.355],
  '井田川':[34.874,136.489],
  // 菰野町
  '菰野':[35.017,136.516],'中菰野':[35.024,136.509],'大羽根園':[35.029,136.502],
  '湯の山温泉':[35.036,136.486],'桜':[35.009,136.528],
  // 東員町
  '東員':[35.06,136.595],'大長':[35.066,136.589],'北大社':[35.073,136.592],
};

// Station → Nagoya commute time (minutes, approximate)
const STATION_TO_NAGOYA_MIN = {
  // 四日市市
  '近鉄四日市':35,'四日市':50,'富田':38,'富洲原':40,'阿倉川':37,'川原町':36,
  '新正':36,'赤堀':37,'日永':40,'南日永':39,'泊':42,'追分':43,
  '内部':45,'小古曽':44,'河原田':48,'塩浜':42,'海山道':38,'霞ヶ浦':37,
  '大矢知':40,'平津':42,'暁学園前':44,'山城':46,'保々':48,'北楠':48,
  '楠':50,'南四日市':40,'中川原':38,'伊勢松本':40,'西日野':42,'近鉄富田':37,
  // 桑名市
  '桑名':25,'播磨':30,'益生':27,'馬道':26,'西桑名':26,'在良':28,
  '星川':30,'七和':32,'穴太':34,'多度':40,'長島':22,'蓮花寺':31,
  '下深谷':32,'伊勢朝日':33,
  // 鈴鹿市
  '白子':55,'鈴鹿':65,'鈴鹿市':60,'三日市':62,'平田町':63,'加佐登':68,
  '玉垣':57,'柳':58,'磯山':56,'千代崎':54,'箕田':59,'鼓ヶ浦':55,
  '徳田':63,'伊勢若松':56,'千里':70,'中瀬古':61,
  // いなべ市
  '三里':52,'北勢中央公園口':53,'麻生田':54,'阿下喜':58,'楚原':56,'大泉':54,'梅戸井':51,
  // 亀山市
  '亀山':70,'関':80,'加太':90,'井田川':65,
  // 菰野町
  '菰野':50,'中菰野':52,'大羽根園':54,'湯の山温泉':58,'桜':48,
  // 東員町
  '東員':38,'大長':40,'北大社':42,
};

function findStationCoords(stationName) {
  if (!stationName) return null;
  if (STATION_COORDS[stationName]) return STATION_COORDS[stationName];
  const cleaned = stationName.replace(/駅$/, '').replace(/\(.*\)/, '').trim();
  if (STATION_COORDS[cleaned]) return STATION_COORDS[cleaned];
  for (const [key, coords] of Object.entries(STATION_COORDS)) {
    if (cleaned.includes(key) || key.includes(cleaned)) return coords;
  }
  return null;
}

// ============================================================
// District Geocoding (Nominatim + localStorage cache)
// ============================================================
const DISTRICT_CACHE = new Map();
const DISTRICT_CACHE_KEY = 'mie-realestate-district-coords-v2';

// Load cached coords from localStorage on startup
function loadDistrictCache() {
  try {
    const stored = localStorage.getItem(DISTRICT_CACHE_KEY);
    if (!stored) return;
    const obj = JSON.parse(stored);
    for (const [k, v] of Object.entries(obj)) {
      DISTRICT_CACHE.set(k, v);
    }
    console.log(`District cache loaded: ${DISTRICT_CACHE.size} entries`);
  } catch(e) { console.warn('Cache load failed:', e); }
}

function saveDistrictCache() {
  try {
    const obj = {};
    for (const [k, v] of DISTRICT_CACHE.entries()) obj[k] = v;
    localStorage.setItem(DISTRICT_CACHE_KEY, JSON.stringify(obj));
  } catch(e) { console.warn('Cache save failed:', e); }
}

async function geocodeDistrict(district, cityName) {
  const cacheKey = `${cityName}-${district}`;
  if (DISTRICT_CACHE.has(cacheKey)) return DISTRICT_CACHE.get(cacheKey);

  // Try GSI (国土地理院) API first, then Nominatim as fallback
  const queries = [
    `三重県${cityName}${district}`,
    `${cityName}${district}`,
  ];

  // GSI API (more reliable for Japanese addresses)
  for (const q of queries) {
    try {
      const url = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(q)}`;
      const resp = await fetch(url);
      if (!resp.ok) continue;
      const results = await resp.json();
      if (results.length > 0) {
        const coords_arr = results[0].geometry.coordinates; // [lng, lat]
        const lat = parseFloat(coords_arr[1]);
        const lng = parseFloat(coords_arr[0]);
        if (lat >= 34.2 && lat <= 35.5 && lng >= 135.8 && lng <= 137.0) {
          const coords = [lat, lng];
          DISTRICT_CACHE.set(cacheKey, coords);
          return coords;
        }
      }
    } catch(e) { /* skip */ }
  }

  // Nominatim fallback
  const nomQueries = [`${district}, ${cityName}, 三重県`, `${district}, ${cityName}`];
  for (const q of nomQueries) {
    try {
      const url = `https://nominatim.openstreetmap.org/search?` +
        `q=${encodeURIComponent(q)}&format=json&limit=1&countrycodes=jp`;
      const resp = await fetch(url, {
        headers: { 'User-Agent': 'MieRealEstateApp/1.0' }
      });
      if (!resp.ok) continue;
      const results = await resp.json();
      if (results.length > 0) {
        const lat = parseFloat(results[0].lat);
        const lng = parseFloat(results[0].lon);
        if (lat >= 34.2 && lat <= 35.5 && lng >= 135.8 && lng <= 137.0) {
          const coords = [lat, lng];
          DISTRICT_CACHE.set(cacheKey, coords);
          return coords;
        }
      }
    } catch(e) { /* skip */ }
  }

  // Mark as not found so we don't retry
  DISTRICT_CACHE.set(cacheKey, null);
  return null;
}

// Background geocoding - doesn't block UI
async function geocodeDistrictsBackground() {
  // Collect uncached district+city pairs
  const uncached = [];
  for (const area of AREAS) {
    if (!area._liveTransactions) continue;
    for (const tx of area._liveTransactions) {
      if (!tx.District) continue;
      const key = `${area.name}-${tx.District}`;
      if (!DISTRICT_CACHE.has(key) && !uncached.find(u => u.key === key)) {
        uncached.push({ key, district: tx.District, cityName: area.name });
      }
    }
  }

  if (uncached.length === 0) return;

  const total = uncached.length;
  let done = 0;

  for (const { district, cityName } of uncached) {
    done++;
    updateStatusText(`地区の位置情報を取得中... (${done}/${total})`);
    await geocodeDistrict(district, cityName);
    // Save every 5 results
    if (done % 5 === 0) saveDistrictCache();
    // Rate limit: 300ms between requests (GSI API is less restrictive than Nominatim)
    if (done < total) await new Promise(r => setTimeout(r, 300));
  }

  saveDistrictCache();

  // Refresh map pins with newly geocoded positions
  updateStatusText(`位置情報取得完了 (${done}件) — ピンを更新中...`);
  if (state.view === 'map' && txMarkerLayer) {
    const ranked = getRankedAreas();
    if (state.mapSelectedAreaId) {
      const sel = ranked.find(a => a.id === state.mapSelectedAreaId);
      if (sel) showTransactionPins(sel);
    } else {
      showAllTransactionPins(ranked);
    }
  }

  const cached = Array.from(DISTRICT_CACHE.values()).filter(v => v !== null).length;
  updateStatusText(`ライブデータ取得完了 — 地区位置: ${cached}件解決済み`);
}

function findDistrictCoords(district, cityName) {
  if (!district || !cityName) return null;
  const key = `${cityName}-${district}`;
  return DISTRICT_CACHE.get(key) || null;
}

// Aggregate metrics for a single district within an area
function aggregateDistrictMetrics(area, districtName) {
  if (!area._liveTransactions || !districtName) return null;
  // Preserve original index in _liveTransactions for map pin reference
  const txs = area._liveTransactions
    .map((t, i) => ({ ...t, _areaIdx: i }))
    .filter(t => t.District === districtName);
  if (txs.length === 0) return null;

  // Prices
  const prices = txs.filter(t => t.TradePrice != null && !isNaN(t.TradePrice)).map(t => t.TradePrice);
  const avgPrice = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : null;
  const minPrice = prices.length > 0 ? Math.min(...prices) : null;
  const maxPrice = prices.length > 0 ? Math.max(...prices) : null;

  // Price per m²
  const pricePerM2 = txs
    .filter(t => t.TradePrice != null && !isNaN(t.TradePrice) && t.Area && t.Area > 0)
    .map(t => t.TradePrice / t.Area);
  const avgPricePerM2 = pricePerM2.length > 0 ? pricePerM2.reduce((a, b) => a + b, 0) / pricePerM2.length : null;

  // Most frequent station
  const stationCounts = {};
  txs.forEach(t => {
    if (t.NearestStation) {
      const s = t.NearestStation.replace(/\(.*\)/, '').trim();
      stationCounts[s] = (stationCounts[s] || 0) + 1;
    }
  });
  const topStation = Object.entries(stationCounts).sort((a, b) => b[1] - a[1])[0];
  const nearestStation = topStation ? topStation[0] : null;

  // Nagoya commute time
  let nagoyaMin = null;
  if (nearestStation) {
    const cleaned = nearestStation.replace(/駅$/, '').trim();
    nagoyaMin = STATION_TO_NAGOYA_MIN[cleaned] || STATION_TO_NAGOYA_MIN[nearestStation] || null;
    if (!nagoyaMin) {
      for (const [key, min] of Object.entries(STATION_TO_NAGOYA_MIN)) {
        if (cleaned.includes(key) || key.includes(cleaned)) { nagoyaMin = min; break; }
      }
    }
  }
  if (!nagoyaMin) nagoyaMin = area.accessToNagoya; // fallback to city level

  // Distance to station (average)
  const distances = txs.filter(t => t.DistanceToStation).map(t => {
    const m = String(t.DistanceToStation).match(/(\d+)/);
    return m ? parseInt(m[1]) : null;
  }).filter(Boolean);
  const avgDistance = distances.length > 0 ? Math.round(distances.reduce((a, b) => a + b, 0) / distances.length) : null;

  // Property type distribution
  const typeCounts = {};
  txs.forEach(t => {
    const type = t.Type || t.Use || 'その他';
    typeCounts[type] = (typeCounts[type] || 0) + 1;
  });
  const typeDistribution = Object.entries(typeCounts)
    .map(([name, count]) => ({ name, count, pct: Math.round(count / txs.length * 100) }))
    .sort((a, b) => b.count - a.count);

  // Average building age
  const currentYear = new Date().getFullYear();
  const ages = txs.filter(t => t.BuildingYear).map(t => {
    const yr = String(t.BuildingYear);
    // Handle "令和X年", "平成X年", "昭和X年" or just year number
    let builtYear = parseInt(yr);
    if (yr.includes('令和')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 2018 + n; }
    else if (yr.includes('平成')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 1988 + n; }
    else if (yr.includes('昭和')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 1925 + n; }
    if (builtYear > 1900 && builtYear <= currentYear) return currentYear - builtYear;
    return null;
  }).filter(Boolean);
  const avgBuildingAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : null;

  // District coordinates
  const coords = findDistrictCoords(districtName, area.name);

  return {
    districtName, cityName: area.name, cityId: area.id,
    count: txs.length, transactions: txs,
    avgPrice, minPrice, maxPrice,
    avgPricePerM2,
    nearestStation, nagoyaMin, avgDistance,
    typeDistribution, avgBuildingAge, coords
  };
}

// Geocode all districts for a single area BEFORE showing pins
async function geocodeAreaDistricts(area, options = {}) {
  if (!area._liveTransactions) return;
  const uncached = [];
  for (const tx of area._liveTransactions) {
    if (!tx.District) continue;
    const key = `${area.name}-${tx.District}`;
    if (!DISTRICT_CACHE.has(key) && !uncached.find(u => u.key === key)) {
      uncached.push({ key, district: tx.District, cityName: area.name });
    }
  }
  if (uncached.length === 0) return;

  const showOverlay = options.showOverlay !== undefined ? options.showOverlay : true;
  const total = uncached.length;
  let done = 0;
  if (showOverlay) showMapLoading(`${area.name} 地区情報取得中...`, 0);
  for (const { district, cityName } of uncached) {
    done++;
    if (showOverlay) updateMapLoading(`${area.name} 地区情報取得中... (${done}/${total})`, (done / total) * 100);
    await geocodeDistrict(district, cityName);
    if (done % 5 === 0) saveDistrictCache();
    if (done < total) await new Promise(r => setTimeout(r, 200));
  }
  saveDistrictCache();
  if (showOverlay) hideMapLoading();
}

function hashStr(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) {
    h = ((h << 5) - h + s.charCodeAt(i)) | 0;
  }
  return Math.abs(h);
}

function estimateTxPosition(area, tx, idx) {
  // Priority 1: District geocoded coords (most accurate for this data)
  const districtCoords = findDistrictCoords(tx.District, area.name);
  if (districtCoords) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.001 + (idx % 7) * 0.0005;
    return {
      lat: districtCoords[0] + Math.cos(jitterAngle) * jitter,
      lng: districtCoords[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 2: Station coordinates (from NearestStation field)
  const stationCoords = findStationCoords(tx.NearestStation);
  if (stationCoords) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.0008 + (idx % 5) * 0.0004;
    return {
      lat: stationCoords[0] + Math.cos(jitterAngle) * jitter,
      lng: stationCoords[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 3: District name → fuzzy match against station names
  const stationFromDistrict = findStationCoords(tx.District);
  if (stationFromDistrict) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.0015 + (idx % 7) * 0.0005;
    return {
      lat: stationFromDistrict[0] + Math.cos(jitterAngle) * jitter,
      lng: stationFromDistrict[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 4: Fallback - bias inland from city center
  const districtKey = tx.District || tx.NearestStation || `tx-${idx}`;
  const hash = hashStr(districtKey + area.id);
  const baseAngle = 150 + (hash % 200);
  const angle = baseAngle * (Math.PI / 180);
  const spread = 0.004 + (hash % 40) / 40 * 0.012;
  const baseLat = area.lat + Math.cos(angle) * spread;
  const baseLng = area.lng + Math.sin(angle) * spread;

  const jitterAngle = (idx * 137.508) * (Math.PI / 180);
  const jitter = 0.0008 + (idx % 5) * 0.0004;

  return {
    lat: baseLat + Math.cos(jitterAngle) * jitter,
    lng: baseLng + Math.sin(jitterAngle) * jitter
  };
}

// Get color based on price (green=cheap, yellow=mid, red=expensive)
function priceColor(price) {
  if (!price || isNaN(price)) return '#9ca3af';
  if (price < 5000000) return '#22c55e';    // green: <500万
  if (price < 15000000) return '#3b82f6';   // blue: 500-1500万
  if (price < 30000000) return '#f59e0b';   // amber: 1500-3000万
  if (price < 50000000) return '#ef4444';   // red: 3000-5000万
  return '#7c3aed';                          // purple: >5000万
}

async function showAllTransactionPins(ranked) {
  if (!txMarkerLayer) return;
  txMarkerLayer.clearLayers();

  // Geocode districts for all areas with transactions (AREAS本体を参照)
  for (const area of AREAS) {
    if (area._liveTransactions && area._liveTransactions.length > 0) {
      await geocodeAreaDistricts(area, { showOverlay: false });
    }
  }

  let totalPins = 0;
  AREAS.forEach(area => {
    const transactions = area._liveTransactions;
    if (!transactions) return;
    const color = COLORS[AREAS.indexOf(area) % COLORS.length];
    transactions.forEach((tx, i) => {
      const pos = estimateTxPosition(area, tx, i);
      const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
      totalPins++;
      const cm = L.circleMarker([pos.lat, pos.lng], {
        radius: 5,
        fillColor: hasPrice ? priceColor(tx.TradePrice) : '#9ca3af',
        color: '#fff',
        weight: 1,
        opacity: 0.8,
        fillOpacity: 0.6
      });
      cm.bindPopup(buildTxPopup(tx, area.name), { maxWidth: 220 });
      txMarkerLayer.addLayer(cm);
    });
  });
  console.log(`[PIN] showAllTransactionPins: ${totalPins} total pins created`);
}

// Map loading overlay controls
function showMapLoading(areaName, pct) {
  const overlay = document.getElementById('map-loading-overlay');
  if (!overlay) return;
  overlay.classList.remove('hidden');
  updateMapLoading(areaName, pct);
}

function updateMapLoading(label, pct) {
  const textEl = document.getElementById('map-loading-text');
  const barEl = document.getElementById('map-loading-bar');
  if (textEl) textEl.textContent = label;
  if (barEl) barEl.style.width = pct + '%';
}

function hideMapLoading() {
  const overlay = document.getElementById('map-loading-overlay');
  if (overlay) overlay.classList.add('hidden');
}

// Transaction pin index for sidebar click → map navigation
let txMarkersByIdx = {};

function showTransactionPins(area) {
  if (!txMarkerLayer) return;
  txMarkerLayer.clearLayers();
  txMarkersByIdx = {};

  // 常にAREAS本体から最新の_liveTransactionsを取得（rankedコピーは古い場合がある）
  const canonical = AREAS.find(a => a.id === area.id) || area;
  const transactions = canonical._liveTransactions;
  if (!transactions) return;

  let pinCount = 0;
  transactions.forEach((tx, i) => {
    const pos = estimateTxPosition(area, tx, i);
    const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
    const cm = L.circleMarker([pos.lat, pos.lng], {
      radius: 7,
      fillColor: hasPrice ? priceColor(tx.TradePrice) : '#9ca3af',
      color: '#fff',
      weight: 1.5,
      opacity: 0.9,
      fillOpacity: hasPrice ? 0.7 : 0.4
    });
    cm.bindPopup(buildTxPopup(tx, area.name), { maxWidth: 240 });
    txMarkerLayer.addLayer(cm);
    txMarkersByIdx[i] = { marker: cm, pos };
    pinCount++;
  });
  console.log(`[PIN] showTransactionPins: ${area.name} — ${pinCount} pins created from ${transactions.length} transactions`);
}

// Navigate map to a specific transaction pin and open popup
function flyToTransaction(idx) {
  const entry = txMarkersByIdx[idx];
  if (!entry || !mapInstance) return;
  mapInstance.flyTo([entry.pos.lat, entry.pos.lng], 16, { duration: 0.6 });
  setTimeout(() => {
    entry.marker.setRadius(12);
    entry.marker.openPopup();
    setTimeout(() => entry.marker.setRadius(7), 2000);
  }, 650);
}

function buildTxPopup(tx, cityName) {
  const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
  const priceStr = hasPrice
    ? (tx.TradePrice >= 10000 ? `${(tx.TradePrice/10000).toFixed(0)}万円` : `${tx.TradePrice.toLocaleString()}円`)
    : '価格不明';
  return `
    <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
      <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">${priceStr}</div>
      <table style="font-size:11px;">
        ${tx.District ? `<tr><td style="color:#6b7280;padding-right:8px;">地区</td><td>${tx.District}</td></tr>` : ''}
        ${tx.Area ? `<tr><td style="color:#6b7280;padding-right:8px;">面積</td><td>${tx.Area}m²</td></tr>` : ''}
        ${tx.Type || tx.Use ? `<tr><td style="color:#6b7280;padding-right:8px;">種別</td><td>${tx.Type || tx.Use}</td></tr>` : ''}
        ${tx.NearestStation ? `<tr><td style="color:#6b7280;padding-right:8px;">最寄駅</td><td>${tx.NearestStation}${tx.DistanceToStation ? ` (${tx.DistanceToStation})` : ''}</td></tr>` : ''}
        ${tx.BuildingYear ? `<tr><td style="color:#6b7280;padding-right:8px;">築年</td><td>${tx.BuildingYear}</td></tr>` : ''}
        ${tx.Structure ? `<tr><td style="color:#6b7280;padding-right:8px;">構造</td><td>${tx.Structure}</td></tr>` : ''}
      </table>
      <div style="font-size:10px;color:#9ca3af;margin-top:4px;">${cityName}</div>
    </div>`;
}

function createMapIcon(color, rank, score, isSelected) {
  const size = isSelected ? 48 : 40;
  const borderWidth = isSelected ? 3 : 2;
  const shadow = isSelected ? 'filter: drop-shadow(0 2px 6px rgba(0,0,0,0.3));' : 'filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));';
  const svgString = `
    <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg" style="${shadow}">
      <circle cx="${size/2}" cy="${size/2}" r="${size/2-2}" fill="${color}" opacity="0.9" stroke="white" stroke-width="${borderWidth}"/>
      <text x="${size/2}" y="${size/2-2}" text-anchor="middle" fill="white" font-size="${isSelected ? 11 : 10}" font-weight="500" font-family="sans-serif">${rank}位</text>
      <text x="${size/2}" y="${size/2+10}" text-anchor="middle" fill="white" font-size="${isSelected ? 13 : 11}" font-weight="700" font-family="sans-serif">${score}</text>
    </svg>`;
  return L.icon({
    iconUrl: 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString))),
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2],
    tooltipAnchor: [0, -size/2]
  });
}

function updateMapSidebar(area, ranked) {
  const sidebar = document.getElementById('map-sidebar');
  if (!sidebar) return;

  // ranked配列からscores付きオブジェクトを取得（AREAS直参照はscoresが無い）
  const rankedArea = ranked.find(a => a.id === area.id) || area;
  // AREAS本体から最新の_liveTransactionsを取得（rankedコピーは古い場合がある）
  const canonical = AREAS.find(a => a.id === area.id) || area;
  area = rankedArea;

  const rank = ranked.findIndex(a => a.id === area.id) + 1;
  const medals = ['🥇','🥈','🥉'];
  const medalStr = rank <= 3 ? medals[rank-1] : `${rank}位`;

  const isFullLoaded = AREA_FULL_LOADED.has(area.id);
  const isFetching = _currentFetchAreaId === area.id;
  const txCount = canonical._liveTransactions ? canonical._liveTransactions.length : 0;

  const loadingBadge = isFetching
    ? '<span class="inline-flex items-center gap-1 text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full mb-2"><span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>詳細データ取得中...</span>'
    : isFullLoaded
      ? `<span class="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded-full mb-2">✅ 全期間データ取得済み（${txCount}件）</span>`
      : `<span class="text-xs text-gray-400 mb-2">概要データのみ（${txCount}件）</span>`;

  const txSection = txCount > 0
    ? renderTransactionList(canonical._liveTransactions)
    : (state.mcpStatus === 'connected'
      ? '<p class="text-xs text-gray-400 mt-2">取引データなし</p>'
      : '<p class="text-xs text-gray-400 mt-2">MCPに接続すると取引データが表示されます</p>');

  sidebar.innerHTML = `
    <div class="sidebar-header">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-xl">${medalStr}</span>
          <h3 class="text-lg font-bold text-gray-900">${area.name}</h3>
        </div>
        <span class="text-2xl font-bold text-blue-600">${area.scores.total}<span class="text-xs font-normal text-gray-400">pt</span></span>
      </div>
    </div>
    <div class="sidebar-body space-y-4">
      ${loadingBadge}
      <!-- Key metrics -->
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-blue-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">住宅地価格</div>
          <div class="text-sm font-bold text-blue-700">${(area.residentialPrice/10000).toFixed(1)}万/m²</div>
        </div>
        <div class="bg-green-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">名古屋まで</div>
          <div class="text-sm font-bold text-green-700">${area.accessToNagoya}分</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">地価変動</div>
          <div class="text-sm font-bold text-amber-700">+${area.yoyChange}%</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">人口</div>
          <div class="text-sm font-bold text-purple-700">${(area.population/10000).toFixed(1)}万人</div>
        </div>
      </div>

      <!-- Live average price -->
      ${area._liveAvgTradePrice ? `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center gap-2 mb-1">
            <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
            <span class="text-xs font-medium text-blue-700">LIVE 平均取引価格</span>
          </div>
          <div class="text-lg font-bold text-blue-800">${(area._liveAvgTradePrice / 10000).toFixed(0)}万円</div>
          <div class="text-xs text-blue-500">${area._liveTransactionCount}件の取引データから算出</div>
        </div>
      ` : ''}

      <!-- Description -->
      <div>
        <p class="text-xs text-gray-600 leading-relaxed">${area.description}</p>
      </div>

      <!-- Highlights -->
      <div class="bg-green-50 rounded-lg p-3">
        <div class="text-xs font-bold text-green-700 mb-2">✅ ポイント</div>
        ${area.highlights.map(h => `<div class="text-xs text-green-800 mb-1">• ${h}</div>`).join('')}
      </div>

      <!-- Transaction data -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs font-bold text-gray-700">📊 取引データ</div>
          <div class="text-xs text-gray-400">${area._liveTransactions ? area._liveTransactions.length + '件' : ''}</div>
        </div>
        ${txSection}
        ${area._liveTransactions && area._liveTransactions.length > 0 ? `
          <div class="mt-2 flex flex-wrap gap-1 items-center">
            <span class="text-xs text-gray-400">凡例:</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#22c55e;display:inline-block;"></span>~500万</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#3b82f6;display:inline-block;"></span>~1500万</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#f59e0b;display:inline-block;"></span>~3000万</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;"></span>~5000万</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#7c3aed;display:inline-block;"></span>5000万~</span>
          </div>
        ` : ''}
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2">
        <button data-map-to-detail="${area.id}" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors text-center">
          🔍 詳細を見る
        </button>
        <button data-map-zoom-out class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors">
          🗺️ 全体表示
        </button>
      </div>
    </div>
  `;

  // Bind sidebar buttons
  const detailBtn = sidebar.querySelector('[data-map-to-detail]');
  if (detailBtn) {
    detailBtn.addEventListener('click', () => {
      state.selectedAreaId = area.id;
      state.view = 'detail';
      render();
    });
  }

  const zoomOutBtn = sidebar.querySelector('[data-map-zoom-out]');
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = null;
      if (mapInstance) mapInstance.flyTo([34.98, 136.56], 10, { duration: 0.8 });
      // Reset marker icons
      const ranked2 = getRankedAreas();
      ranked2.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        if (mapMarkers[a.id]) mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, false));
      });
      // Show all transaction pins again
      showAllTransactionPins(ranked2);
      // Reset sidebar
      sidebar.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full text-center p-8">
          <div class="text-4xl mb-3">📍</div>
          <p class="text-sm font-medium text-gray-700 mb-1">エリアを選択してください</p>
          <p class="text-xs text-gray-400">マップ上のマーカーをクリックすると<br>土地情報・取引データが表示されます</p>
        </div>`;
    });
  }

  // Bind transaction row clicks → fly to map pin
  sidebar.querySelectorAll('tr[data-tx-idx]').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.txIdx);
      // Highlight active row
      sidebar.querySelectorAll('tr.tx-active').forEach(r => r.classList.remove('tx-active'));
      row.classList.add('tx-active');
      // Fly to pin
      flyToTransaction(idx);
    });
  });
}

function updateDistrictSidebar(area, districtName, ranked) {
  const sidebar = document.getElementById('map-sidebar');
  if (!sidebar) return;

  const metrics = aggregateDistrictMetrics(area, districtName);
  if (!metrics) {
    sidebar.innerHTML = `<div class="p-4 text-sm text-gray-500">地区データなし</div>`;
    return;
  }

  const avgPriceStr = metrics.avgPrice ? `${(metrics.avgPrice / 10000).toFixed(0)}万円` : '-';
  const priceRange = (metrics.minPrice && metrics.maxPrice)
    ? `${(metrics.minPrice / 10000).toFixed(0)}〜${(metrics.maxPrice / 10000).toFixed(0)}万円`
    : '-';
  const m2PriceStr = metrics.avgPricePerM2 ? `${(metrics.avgPricePerM2 / 10000).toFixed(1)}万/m²` : '-';
  const stationStr = metrics.nearestStation || '-';
  const nagoyaStr = metrics.nagoyaMin ? `約${metrics.nagoyaMin}分` : `約${area.accessToNagoya}分`;
  const distStr = metrics.avgDistance ? `徒歩${metrics.avgDistance}分` : '-';
  const ageStr = metrics.avgBuildingAge !== null ? `築${metrics.avgBuildingAge}年` : '-';

  // Type distribution bar
  const typeColors = { '宅地(土地)': '#22c55e', '宅地(土地と建物)': '#3b82f6', '中古マンション等': '#f59e0b', '農地': '#84cc16', '林地': '#14b8a6' };
  const typeBar = metrics.typeDistribution.map(t => {
    const color = typeColors[t.name] || '#9ca3af';
    return `<div style="width:${t.pct}%;background:${color};height:100%;display:inline-block;" title="${t.name} ${t.pct}%"></div>`;
  }).join('');
  const typeLegend = metrics.typeDistribution.slice(0, 4).map(t => {
    const color = typeColors[t.name] || '#9ca3af';
    return `<span class="inline-flex items-center gap-1 text-xs"><span style="width:6px;height:6px;border-radius:50%;background:${color};display:inline-block;"></span>${t.name.replace('宅地(','').replace(')','').replace('中古マンション等','マンション')} ${t.pct}%</span>`;
  }).join(' ');

  // Transaction list filtered to this district
  const districtTxs = metrics.transactions;
  const txSection = renderTransactionList(districtTxs);

  sidebar.innerHTML = `
    <div class="sidebar-header">
      <button id="btn-back-to-city" class="flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800 mb-2 cursor-pointer" style="background:none;border:none;padding:0;">
        ← ${area.name}に戻る
      </button>
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-900">📍 ${districtName}</h3>
        <span class="text-sm font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">${metrics.count}件</span>
      </div>
    </div>
    <div class="sidebar-body space-y-4">
      <!-- Key metrics -->
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-blue-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">平均取引価格</div>
          <div class="text-sm font-bold text-blue-700">${avgPriceStr}</div>
        </div>
        <div class="bg-indigo-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">㎡単価</div>
          <div class="text-sm font-bold text-indigo-700">${m2PriceStr}</div>
        </div>
        <div class="bg-green-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">最寄駅</div>
          <div class="text-sm font-bold text-green-700" style="font-size:11px;">${stationStr}</div>
        </div>
        <div class="bg-emerald-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">名古屋まで</div>
          <div class="text-sm font-bold text-emerald-700">${nagoyaStr}</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">駅距離</div>
          <div class="text-sm font-bold text-amber-700">${distStr}</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">平均築年数</div>
          <div class="text-sm font-bold text-purple-700">${ageStr}</div>
        </div>
      </div>

      <!-- Price range -->
      <div class="bg-gray-50 rounded-lg p-2">
        <div class="text-xs text-gray-500 mb-1">価格帯</div>
        <div class="text-sm font-medium text-gray-700">${priceRange}</div>
      </div>

      <!-- Type distribution -->
      ${metrics.typeDistribution.length > 0 ? `
        <div>
          <div class="text-xs text-gray-500 mb-1">用途分布</div>
          <div style="height:8px;border-radius:4px;overflow:hidden;background:#e5e7eb;display:flex;">${typeBar}</div>
          <div class="mt-1 flex flex-wrap gap-2">${typeLegend}</div>
        </div>
      ` : ''}

      <!-- Transaction data -->
      <div>
        <div class="text-xs font-bold text-gray-700 mb-2">📊 取引データ（${districtName}）</div>
        ${txSection || '<p class="text-xs text-gray-400">取引データなし</p>'}
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2">
        <button id="btn-district-back" class="flex-1 px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors text-center">
          ↩ ${area.name}へ戻る
        </button>
        <button data-map-zoom-out class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors">
          🗺️ 全体表示
        </button>
      </div>
    </div>
  `;

  // Bind back button
  const backBtn = sidebar.querySelector('#btn-back-to-city');
  const backBtn2 = sidebar.querySelector('#btn-district-back');
  const goBack = () => {
    state.mapSelectedDistrict = null;
    updateMapSidebar(area, ranked);
    showTransactionPins(area);
  };
  if (backBtn) backBtn.addEventListener('click', goBack);
  if (backBtn2) backBtn2.addEventListener('click', goBack);

  // Bind zoom out
  const zoomOutBtn = sidebar.querySelector('[data-map-zoom-out]');
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = null;
      state.mapSelectedDistrict = null;
      if (mapInstance) mapInstance.flyTo([34.98, 136.56], 10, { duration: 0.8 });
      const ranked2 = getRankedAreas();
      ranked2.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        if (mapMarkers[a.id]) mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, false));
      });
      showAllTransactionPins(ranked2);
      sidebar.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full text-center p-8">
          <div class="text-4xl mb-3">📍</div>
          <p class="text-sm font-medium text-gray-700 mb-1">エリアを選択してください</p>
          <p class="text-xs text-gray-400">マップ上のマーカーをクリックすると<br>土地情報・取引データが表示されます</p>
        </div>`;
    });
  }

  // Bind transaction row clicks
  sidebar.querySelectorAll('tr[data-tx-idx]').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.txIdx);
      sidebar.querySelectorAll('tr.tx-active').forEach(r => r.classList.remove('tx-active'));
      row.classList.add('tx-active');
      flyToTransaction(idx);
    });
  });
}

function renderTransactionList(transactions) {
  if (!transactions || transactions.length === 0) return '';

  // Keep original index for map pin reference
  // Use _areaIdx if present (from district filtering), otherwise use array index
  const indexed = transactions.map((t, i) => ({
    ...t,
    _origIdx: (t._areaIdx !== undefined) ? t._areaIdx : i
  }));
  // Show all transactions (including those without price)
  const validTx = [...indexed];
  if (validTx.length === 0) return '<p class="text-xs text-gray-400">取引データなし</p>';

  // Sort by price descending (null prices at end)
  validTx.sort((a, b) => {
    const pa = (a.TradePrice != null && !isNaN(a.TradePrice)) ? a.TradePrice : -1;
    const pb = (b.TradePrice != null && !isNaN(b.TradePrice)) ? b.TradePrice : -1;
    return pb - pa;
  });

  return `
    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
      <table class="tx-table">
        <thead>
          <tr>
            <th>価格</th>
            <th>面積</th>
            <th>地区</th>
            <th>最寄駅</th>
          </tr>
        </thead>
        <tbody>
          ${validTx.map(t => {
            const hasP = t.TradePrice != null && !isNaN(t.TradePrice);
            const pStr = hasP ? (t.TradePrice >= 10000 ? (t.TradePrice/10000).toFixed(0) + '万' : t.TradePrice.toLocaleString() + '円') : '-';
            return `
            <tr data-tx-idx="${t._origIdx}" title="クリックで地図上のピンへ移動">
              <td class="font-medium" style="color:${hasP ? priceColor(t.TradePrice) : '#9ca3af'}">${pStr}</td>
              <td>${t.Area ? t.Area + 'm²' : '-'}</td>
              <td class="text-gray-500" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.District || '-'}</td>
              <td class="text-gray-500" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.NearestStation || '-'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function renderFooter() {
  return `
    <footer class="mt-8 py-6 border-t border-gray-200" style="margin-bottom: ${state.savedProperties.length > 0 ? '70px' : '0'}">
      <div class="text-center space-y-2">
        <p class="text-xs text-gray-400">
          データ出典: 国土交通省 不動産情報ライブラリAPI / 総務省 e-Stat API（2025年公示地価ベース）
        </p>
        <p class="text-xs text-gray-400">
          MCP接続先: <code class="bg-gray-100 px-1 rounded">mcp.n-3.ai</code> (reinfolib-real-estate-price, reinfolib-city-list)
        </p>
        <p class="text-xs text-gray-400">
          ※ 本ツールは参考情報であり、不動産購入の最終判断は専門家にご相談ください
        </p>
        <p class="text-xs text-gray-300 mt-3">© <a href="https://chuumon-soudan.com/" style="color:#93c5fd;text-decoration:underline;">注文相談.com</a> — Powered by 国土交通省 不動産情報ライブラリ + 行政オープンデータ</p>
      </div>
    </footer>
  `;
}

// ============================================================
// Second Opinion: Property View (saved list + comparison)
// ============================================================
function renderPropertyView() {
  const savedCount = state.savedProperties.length;
  const compProps = state.savedProperties.filter(p => p.in_comparison);

  // Sub-view: comparison table
  if (state.soView === 'compare' && state.soComparison) {
    return renderComparisonTable();
  }

  return `
    <div class="space-y-4 fade-in">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-800">🏠 保存した物件${savedCount > 0 ? `（${savedCount}件）` : ''}</h2>
        ${savedCount > 0 ? `<div class="flex gap-2">
          <button onclick="clearAllProperties()" class="text-xs text-gray-400 hover:text-red-500 transition-colors">全件削除</button>
        </div>` : ''}
      </div>

      ${savedCount === 0 ? `
        <div class="card p-8 text-center">
          <div class="text-4xl mb-3">🏠</div>
          <p class="text-gray-600 font-medium mb-2">まだ物件が保存されていません</p>
          <p class="text-sm text-gray-400 mb-4">エリア詳細ページの「物件を探す」から<br>物件URLを取り込んで保存・比較できます</p>
          <button onclick="state.view='detail'; render();" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
            エリア詳細を見る →
          </button>
        </div>
      ` : `
        <div class="grid grid-cols-1 gap-3">
          ${state.savedProperties.map(prop => {
            const badgeClass = prop.badge === 'red' ? 'so-badge-red' : prop.badge === 'yellow' ? 'so-badge-yellow' : 'so-badge-none';
            const badgeLabel = prop.badge === 'red' ? '🔴 注意' : prop.badge === 'yellow' ? '🟡 要確認' : '🟢 OK';
            const areaName = AREAS.find(a => a.id === prop.area_id)?.name || prop.area_id || '';
            const priceStr = prop.price ? `${(prop.price / 10000).toLocaleString()}万円` : '価格未入力';
            const areaStr = prop.land_area ? `${(prop.land_area / 3.305785).toFixed(1)}坪（${prop.land_area}㎡）` : '面積未入力';
            return `
              <div class="card p-4">
                <div class="flex items-start justify-between">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="${badgeClass}" style="font-size:11px;padding:2px 8px;border-radius:9999px;">${badgeLabel}</span>
                      ${areaName ? `<span class="text-xs text-gray-400">${areaName}</span>` : ''}
                    </div>
                    <div class="text-sm font-medium text-gray-800">${prop.address || '住所未入力'}</div>
                    <div class="flex items-center gap-3 mt-1 text-sm">
                      <span class="font-bold text-blue-700">${priceStr}</span>
                      <span class="text-gray-500">${areaStr}</span>
                    </div>
                    ${prop.station_distance ? `<div class="text-xs text-gray-400 mt-1">🚃 ${prop.station_distance}</div>` : ''}
                    ${prop.memo ? `<div class="text-xs text-gray-500 mt-1 bg-gray-50 rounded px-2 py-1">📝 ${prop.memo}</div>` : ''}
                    ${prop.url ? `<a href="${prop.url}" target="_blank" rel="noopener" class="text-xs text-blue-500 mt-1 inline-block hover:underline">🔗 物件ページ</a>` : ''}
                  </div>
                  <div class="flex flex-col gap-1 ml-3">
                    <button onclick="handleToggleComparison('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border transition-colors ${prop.in_comparison ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-600 border-gray-300 hover:bg-blue-50'}">
                      ${prop.in_comparison ? '✓ 比較中' : '比較に追加'}
                    </button>
                    <button onclick="handleDeleteProperty('${prop.id}')" class="px-3 py-1 text-xs rounded-lg border border-gray-200 text-gray-400 hover:text-red-500 hover:border-red-300 transition-colors">削除</button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        ${compProps.length > 0 ? `
          <div class="card p-4 bg-blue-50 border-blue-200">
            <div class="flex items-center justify-between">
              <div>
                <span class="text-sm font-medium text-blue-800">📊 比較に追加: ${compProps.length}件</span>
                <span class="text-xs text-blue-500 ml-2">${compProps.length < 2 ? '（2件以上で比較可能）' : ''}</span>
              </div>
              <button onclick="handleGenerateComparison()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors ${compProps.length < 2 ? 'opacity-50 cursor-not-allowed' : ''}" ${compProps.length < 2 ? 'disabled' : ''}>
                比較表を作成
              </button>
            </div>
          </div>
        ` : ''}
      `}
    </div>
  `;
}

// ============================================================
// Second Opinion: Comparison Table
// ============================================================
function renderComparisonTable() {
  const comp = state.soComparison;
  if (!comp) return '';
  const props = comp.properties || [];
  if (props.length === 0) return '';

  const labels = ['A','B','C','D','E'];
  const rows = [
    { label: '価格', key: 'price', fmt: v => v ? `${(v/10000).toLocaleString()}万円` : '—' },
    { label: '土地面積', key: 'land_area', fmt: v => v ? `${(v/3.305785).toFixed(1)}坪（${v}㎡）` : '—' },
    { label: '坪単価', key: '_tsubo', fmt: (v, p) => p.price && p.land_area ? `${(p.price / (p.land_area / 3.305785) / 10000).toFixed(1)}万円/坪` : '—' },
    { label: '所在地', key: 'address', fmt: v => v || '—' },
    { label: '駅距離', key: 'station_distance', fmt: v => v || '—' },
    { label: '間取り', key: 'floor_plan', fmt: v => v || '—' },
    { label: '築年', key: 'building_year', fmt: v => v || '—' },
  ];
  const checkRows = [
    { label: '用途地域', key: 'zoning' },
    { label: '建ぺい率', key: 'building_coverage' },
    { label: '容積率', key: 'floor_area_ratio' },
    { label: '接道', key: 'road_access' },
    { label: '高低差/造成', key: 'elevation' },
    { label: 'インフラ', key: 'infrastructure' },
    { label: 'ハザード', key: 'hazard' },
  ];

  let questions = [];
  try { questions = typeof comp.questions === 'string' ? JSON.parse(comp.questions) : (comp.questions || []); } catch(e) { questions = []; }
  if (typeof questions === 'string') questions = questions.split('\n').filter(q => q.trim());

  return `
    <div class="space-y-4 fade-in">
      <div class="flex items-center gap-3">
        <button onclick="state.soView='saved'; state.soComparison=null; render();" class="text-sm text-blue-600 hover:underline">← 保存リストに戻る</button>
        <h2 class="text-lg font-bold text-gray-800">📊 比較表</h2>
      </div>

      ${comp.summary ? `
        <div class="card p-4 bg-blue-50 border-blue-200">
          <h3 class="text-sm font-bold text-blue-800 mb-2">💡 AIサマリ</h3>
          <p class="text-sm text-gray-700 leading-relaxed">${comp.summary}</p>
        </div>
      ` : ''}

      <div class="card overflow-x-auto">
        <table class="so-compare-table">
          <thead>
            <tr>
              <th class="text-left p-3 bg-gray-50 text-xs text-gray-500 font-medium" style="min-width:80px;"></th>
              ${props.map((p,i) => `
                <th class="p-3 bg-gray-50 text-sm font-bold text-gray-800" style="min-width:120px;">
                  物件${labels[i]}<br><span class="text-xs font-normal text-gray-400">${AREAS.find(a=>a.id===p.area_id)?.name || ''}</span>
                </th>
              `).join('')}
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">${r.label}</td>
                ${props.map(p => `<td class="p-3 text-sm text-gray-800">${r.fmt(p[r.key], p)}</td>`).join('')}
              </tr>
            `).join('')}
            <tr><td colspan="${props.length+1}" class="p-2 bg-amber-50"><span class="text-xs font-bold text-amber-700">⚠️ 重要確認項目（不動産屋に確認）</span></td></tr>
            ${checkRows.map(r => `
              <tr>
                <td class="p-3 text-xs font-medium text-gray-600 bg-gray-50">${r.label}</td>
                ${props.map(p => {
                  const val = p[r.key];
                  return `<td class="p-3 text-sm ${val ? 'text-gray-800' : 'text-amber-600'}">${val || '🟡 不明'}</td>`;
                }).join('')}
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      ${questions.length > 0 ? `
        <div class="card p-4">
          <h3 class="text-sm font-bold text-gray-800 mb-3">📋 確認質問テンプレート</h3>
          <div class="space-y-2">
            ${questions.map((q,i) => `
              <label class="flex items-start gap-2 text-sm text-gray-700">
                <input type="checkbox" class="mt-1 so-question-check" />
                <span>${typeof q === 'object' ? q.text || q.question || JSON.stringify(q) : q}</span>
              </label>
            `).join('')}
          </div>
          <button onclick="copyQuestions()" class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition-colors">📋 質問をコピー</button>
        </div>
      ` : ''}
    </div>
  `;
}

function copyQuestions() {
  const checks = document.querySelectorAll('.so-question-check');
  const texts = [];
  checks.forEach((cb, i) => {
    const label = cb.parentElement?.querySelector('span')?.textContent;
    if (label) texts.push(`${cb.checked ? '✅' : '□'} ${label}`);
  });
  if (texts.length === 0) return;
  navigator.clipboard.writeText(texts.join('\n')).then(() => alert('質問をクリップボードにコピーしました'));
}

// ============================================================
// Second Opinion: Fixed Bottom Bar
// ============================================================
function renderFixedBar() {
  if (state.savedProperties.length === 0) return '';
  if (state.view === 'property') return ''; // Property viewでは不要（既に表示済み）
  const compCount = state.savedProperties.filter(p => p.in_comparison).length;
  return `
    <div class="so-fixed-bar">
      <div class="max-w-6xl mx-auto px-4 flex items-center justify-between">
        <span class="text-sm font-medium text-gray-700">
          📋 保存: ${state.savedProperties.length}件${compCount > 0 ? ` | 比較: ${compCount}件` : ''}
        </span>
        <div class="flex gap-2">
          <button onclick="state.view='property'; render();" class="px-3 py-1.5 bg-white text-blue-600 border border-blue-200 rounded-lg text-sm hover:bg-blue-50 transition-colors">
            一覧を見る
          </button>
          ${compCount >= 2 ? `
            <button onclick="handleGenerateComparison()" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors">
              比較表を作成
            </button>
          ` : ''}
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Second Opinion: Modals (Search & Import)
// ============================================================
function renderSOModal() {
  if (!state.soModalOpen) return '';

  if (state.soModalType === 'search') {
    return renderSearchModal();
  }
  if (state.soModalType === 'import') {
    return renderImportModal();
  }
  return '';
}

function renderSearchModal() {
  const areaId = state.soSearchAreaId;
  const area = AREAS.find(a => a.id === areaId);
  const areaName = area ? area.name : '';
  const result = state._aiSearchResult;

  return `
    <div class="so-modal-overlay" onclick="closeSOModal(event)">
      <div class="so-modal" onclick="event.stopPropagation()" style="max-width:640px;">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">🤖 ${areaName} の物件をAI検索</h3>
          <button onclick="state.soModalOpen=false; state._aiSearchResult=null; render();" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium text-gray-700">どんな土地を探していますか？</label>
            <textarea id="ai-search-query" rows="2" placeholder="例: 2000万以下で50坪くらいの土地。駅から近いほうがいい。" class="w-full mt-2 px-3 py-2 border border-gray-300 rounded-lg text-sm" style="resize:vertical;">${state._aiSearchQuery || ''}</textarea>
            <div class="flex flex-wrap gap-2 mt-2">
              <button onclick="document.getElementById('ai-search-query').value='2000万以下、40坪以上'" class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition-colors">💡 2000万/40坪</button>
              <button onclick="document.getElementById('ai-search-query').value='広い土地（60坪以上）、予算3000万まで'" class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition-colors">💡 広め/3000万</button>
              <button onclick="document.getElementById('ai-search-query').value='駅徒歩15分以内、50坪前後、閑静な住宅街'" class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition-colors">💡 駅近/住宅街</button>
            </div>
          </div>

          <button id="btn-ai-search" onclick="handleAISearch()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
            🔍 AIがWeb検索して物件を探す
          </button>

          ${result ? `
            <div class="space-y-4">
              <p class="text-sm font-bold text-gray-800">📋 検索結果（${result.properties?.length || 0}件）</p>

              ${result.sections && result.sections.length > 0 ? result.sections.map((section, si) => `
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                  <!-- サイトヘッダー + grounding URL -->
                  <div class="bg-gradient-to-r ${section.siteKey === 'suumo' ? 'from-green-600 to-green-700' : section.siteKey === 'athome' ? 'from-red-500 to-red-600' : section.siteKey === 'homes' ? 'from-orange-500 to-orange-600' : 'from-gray-500 to-gray-600'} px-3 py-2">
                    <div class="flex items-center justify-between">
                      <span class="text-white font-bold text-sm">${section.siteName}（${section.properties.length}件）</span>
                    </div>
                    ${section.groundingUrls && section.groundingUrls.length > 0 ? `
                      <div class="mt-1 space-y-0.5">
                        ${section.groundingUrls.map(u => `<a href="${u.url}" target="_blank" rel="noopener" class="block text-xs text-white/90 hover:text-white hover:underline truncate">🔗 ${u.title || u.url}</a>`).join('')}
                      </div>
                    ` : ''}
                  </div>

                  <!-- 物件リスト -->
                  <div class="divide-y divide-gray-100">
                    ${section.properties.map((p, pi) => {
                      const globalIdx = result.sections.slice(0, si).reduce((sum, s) => sum + s.properties.length, 0) + pi;
                      return `
                      <div class="p-3 bg-white space-y-1.5">
                        <div class="flex items-start justify-between">
                          <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-800">${p.title || p.address || '物件' + (pi+1)}</div>
                            ${p.address ? `<div class="text-xs text-gray-500">📍 ${p.address}</div>` : ''}
                          </div>
                          <button onclick="handleSaveSearchResult(${globalIdx})" class="ml-2 px-3 py-1 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700 transition-colors flex-shrink-0">
                            💾 保存
                          </button>
                        </div>
                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
                          ${p.price ? `<span class="font-bold text-blue-700">${Number(p.price).toLocaleString()}万円</span>` : ''}
                          ${p.land_area ? `<span class="text-gray-600">${(p.land_area/3.305785).toFixed(1)}坪（${p.land_area}㎡）</span>` : ''}
                          ${p.station_distance ? `<span class="text-gray-500">🚃 ${p.station_distance}</span>` : ''}
                        </div>
                        ${p.zoning || p.road_access ? `
                          <div class="flex flex-wrap gap-2 text-xs">
                            ${p.zoning ? `<span class="bg-gray-100 px-2 py-0.5 rounded">${p.zoning}</span>` : ''}
                            ${p.road_access ? `<span class="bg-gray-100 px-2 py-0.5 rounded">${p.road_access}</span>` : ''}
                          </div>
                        ` : ''}
                        ${p.memo ? `<div class="text-xs text-amber-700">💡 ${p.memo}</div>` : ''}
                      </div>`;
                    }).join('')}
                  </div>
                </div>
              `).join('') : `
                ${result.properties && result.properties.length > 0 ? result.properties.map((p, i) => `
                  <div class="border border-gray-200 rounded-lg p-3 bg-white space-y-2">
                    <div class="text-sm font-medium text-gray-800">${p.title || p.address || '物件' + (i+1)}</div>
                    ${p.address ? `<div class="text-xs text-gray-500">📍 ${p.address}</div>` : ''}
                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
                      ${p.price ? `<span class="font-bold text-blue-700">${Number(p.price).toLocaleString()}万円</span>` : ''}
                      ${p.land_area ? `<span class="text-gray-600">${(p.land_area/3.305785).toFixed(1)}坪（${p.land_area}㎡）</span>` : ''}
                    </div>
                    <button onclick="handleSaveSearchResult(${i})" class="px-3 py-1 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700">💾 保存</button>
                  </div>
                `).join('') : `
                  <div class="text-sm text-gray-500 bg-gray-50 rounded-lg p-4">
                    <p class="text-center">条件に合う物件が見つかりませんでした。</p>
                    <p class="text-xs mt-1 text-center">条件を変えて再検索してみてください。</p>
                    ${result.rawText ? `<details class="mt-2"><summary class="text-xs text-gray-400 cursor-pointer">AI応答を確認</summary><pre class="text-xs text-gray-400 whitespace-pre-wrap mt-1 max-h-40 overflow-auto">${result.rawText.replace(/</g,'&lt;')}</pre></details>` : ''}
                  </div>
                `}
              `}
            </div>
          ` : ''}
        </div>
        <p class="text-xs text-gray-400 mt-4 text-center">
          ※ AIがGoogle検索で不動産サイトから物件を探します。情報の正確性は物件ページでご確認ください。
        </p>
      </div>
    </div>
  `;
}

function renderImportModal() {
  const areaId = state.soSearchAreaId;
  const area = AREAS.find(a => a.id === areaId);
  const areaName = area ? area.name : '';
  const importUrl = state._importUrl || '';
  const parsed = state._aiParsedProperty;

  return `
    <div class="so-modal-overlay" onclick="closeSOModal(event)">
      <div class="so-modal" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">🤖 物件情報をAIで取り込み${areaName ? `（${areaName}）` : ''}</h3>
          <button onclick="state.soModalOpen=false; state._aiParsedProperty=null; render();" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium text-gray-700">物件URL（任意）</label>
            <input id="import-url" type="url" value="${importUrl}" placeholder="https://suumo.jp/... の物件URL" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" />
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">物件情報を貼り付け <span class="text-red-500">*</span></label>
            <textarea id="ai-import-text" rows="5" placeholder="物件サイトの情報をコピペしてください&#10;&#10;例:&#10;価格 2,580万円&#10;土地面積 182.5㎡（55.2坪）&#10;所在地 四日市市富田浜町&#10;最寄り駅 富田浜駅 徒歩5分&#10;用途地域 第一種住居地域" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" style="resize:vertical;"></textarea>
          </div>

          <button id="btn-ai-parse" onclick="handleAIParse()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
            🤖 AIで情報を整理して保存
          </button>

          ${parsed ? `
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 space-y-2">
              <p class="text-sm font-bold text-green-800">✅ AIが整理した物件情報</p>
              <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                <span class="text-gray-500">価格:</span><span class="font-medium">${parsed.price ? parsed.price.toLocaleString() + '万円' : '—'}</span>
                <span class="text-gray-500">面積:</span><span class="font-medium">${parsed.land_area ? (parsed.land_area/3.305785).toFixed(1) + '坪（' + parsed.land_area + '㎡）' : '—'}</span>
                <span class="text-gray-500">住所:</span><span class="font-medium">${parsed.address || '—'}</span>
                <span class="text-gray-500">駅:</span><span class="font-medium">${parsed.station_distance || '—'}</span>
                ${parsed.zoning ? `<span class="text-gray-500">用途地域:</span><span class="font-medium">${parsed.zoning}</span>` : ''}
                ${parsed.building_coverage ? `<span class="text-gray-500">建ぺい率:</span><span class="font-medium">${parsed.building_coverage}</span>` : ''}
                ${parsed.road_access ? `<span class="text-gray-500">接道:</span><span class="font-medium">${parsed.road_access}</span>` : ''}
              </div>
              ${parsed.memo ? `<p class="text-xs text-amber-700 mt-2">💡 ${parsed.memo}</p>` : ''}
              <div class="flex gap-2 mt-3">
                <button onclick="handleSaveParsed()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">💾 この内容で保存</button>
                <button onclick="state._aiParsedProperty=null; render();" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors">やり直す</button>
              </div>
            </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Second Opinion: Event Handlers
// ============================================================
function openSearchModal(areaId) {
  state.soSearchAreaId = areaId;
  state._aiSearchResult = null;
  state._aiSearchQuery = '';
  state.soModalOpen = true;
  state.soModalType = 'search';
  render();
}

function openImportModal(areaId) {
  const urlInput = document.getElementById('url-import-detail');
  state._importUrl = urlInput ? urlInput.value.trim() : '';
  state._aiParsedProperty = null;
  state.soSearchAreaId = areaId;
  state.soModalOpen = true;
  state.soModalType = 'import';
  render();
}

function closeSOModal(event) {
  if (event.target === event.currentTarget) {
    state.soModalOpen = false;
    state._aiSearchResult = null;
    state._aiParsedProperty = null;
    render();
  }
}

// AI検索: 自然言語 → SUUMO URL生成
async function handleAISearch() {
  const queryEl = document.getElementById('ai-search-query');
  const query = queryEl ? queryEl.value.trim() : '';
  if (!query) { alert('検索条件を入力してください'); return; }

  const btn = document.getElementById('btn-ai-search');
  if (btn) { btn.textContent = '🔍 AIが検索中...（10〜20秒）'; btn.disabled = true; }

  try {
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    if (token) headers['Authorization'] = `Bearer ${token}`;
    else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-assist`, {
      method: 'POST', headers,
      body: JSON.stringify({ action: 'search', query, areaId: state.soSearchAreaId })
    });
    if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
    const result = await res.json();
    if (result.error) throw new Error(result.error);
    state._aiSearchResult = result;
    state._aiSearchQuery = query;
    render();
  } catch(e) {
    console.error('AI Search error:', e);
    alert('AI検索に失敗しました: ' + e.message);
    if (btn) { btn.textContent = '🔍 AIがWeb検索して物件を探す'; btn.disabled = false; }
  }
}

// AIカード作成: テキスト → 構造化 → プレビュー
async function handleAIParse() {
  const textEl = document.getElementById('ai-import-text');
  const urlEl = document.getElementById('import-url');
  const text = textEl ? textEl.value.trim() : '';
  const url = urlEl ? urlEl.value.trim() : '';
  if (!text) { alert('物件情報を貼り付けてください'); return; }

  const btn = document.getElementById('btn-ai-parse');
  if (btn) { btn.textContent = '🤖 AIが解析中...'; btn.disabled = true; }

  try {
    const headers = { 'Content-Type': 'application/json', 'apikey': CONFIG.SUPABASE_ANON_KEY };
    const session = await supabaseClient.auth.getSession();
    const token = session?.data?.session?.access_token;
    if (token) headers['Authorization'] = `Bearer ${token}`;
    else headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
    const res = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/ai-assist`, {
      method: 'POST', headers,
      body: JSON.stringify({ action: 'parse', text, url, areaId: state.soSearchAreaId })
    });
    if (!res.ok) { const errText = await res.text(); throw new Error(`HTTP ${res.status}: ${errText}`); }
    const result = await res.json();
    if (result.error) throw new Error(result.error);
    state._aiParsedProperty = result;
    state._importUrl = url;
    render();
  } catch(e) {
    console.error('AI Parse error:', e);
    alert('AI解析に失敗しました: ' + e.message);
    if (btn) { btn.textContent = '🤖 AIで情報を整理して保存'; btn.disabled = false; }
  }
}

// AI解析結果を保存
async function handleSaveParsed() {
  const parsed = state._aiParsedProperty;
  if (!parsed) return;
  if (!parsed.price || !parsed.land_area) {
    alert('価格と面積が必要です。テキストに含まれているか確認してください。');
    return;
  }

  const prop = {
    area_id: state.soSearchAreaId || null,
    url: state._importUrl || null,
    source: parsed.source || null,
    price: parsed.price * 10000, // 万円 → 円
    land_area: parsed.land_area,
    address: parsed.address || null,
    station_distance: parsed.station_distance || null,
    floor_plan: parsed.floor_plan || null,
    building_year: parsed.building_year || null,
    zoning: parsed.zoning || null,
    building_coverage: parsed.building_coverage || null,
    floor_area_ratio: parsed.floor_area_ratio || null,
    road_access: parsed.road_access || null,
    elevation: parsed.elevation || null,
    infrastructure: parsed.infrastructure || null,
    hazard: parsed.hazard || null,
    memo: parsed.memo || null,
  };

  const saved = await saveProperty(prop);
  if (saved) {
    state.soModalOpen = false;
    state._importUrl = '';
    state._aiParsedProperty = null;
    render();
  }
}

// 検索結果から物件を保存
async function handleSaveSearchResult(index) {
  const result = state._aiSearchResult;
  if (!result || !result.properties || !result.properties[index]) return;
  const p = result.properties[index];

  if (!p.price || !p.land_area) {
    alert('この物件は価格または面積が不明のため保存できません');
    return;
  }

  const prop = {
    area_id: state.soSearchAreaId || null,
    url: p.url || null,
    source: p.source || null,
    price: p.price * 10000, // 万円 → 円
    land_area: p.land_area,
    address: p.address || null,
    station_distance: p.station_distance || null,
    zoning: p.zoning || null,
    building_coverage: p.building_coverage || null,
    floor_area_ratio: p.floor_area_ratio || null,
    road_access: p.road_access || null,
    elevation: p.elevation || null,
    infrastructure: p.infrastructure || null,
    hazard: p.hazard || null,
    memo: p.memo || null,
  };

  const saved = await saveProperty(prop);
  if (saved) {
    // ボタンを「保存済み」に変更
    const btns = document.querySelectorAll(`[onclick="handleSaveSearchResult(${index})"]`);
    btns.forEach(btn => { btn.textContent = '✅ 保存済み'; btn.disabled = true; btn.style.opacity = '0.6'; });
  }
}

async function handleToggleComparison(id) {
  await toggleComparison(id);
  render();
}

async function handleDeleteProperty(id) {
  if (!confirm('この物件を削除しますか？')) return;
  await deleteProperty(id);
  render();
}

async function handleGenerateComparison() {
  const btn = event?.target;
  if (btn) { btn.textContent = '生成中...'; btn.disabled = true; }
  const result = await generateComparison();
  if (result) {
    state.soComparison = result;
    state.soView = 'compare';
    state.view = 'property';
  }
  render();
}

async function clearAllProperties() {
  if (!confirm('保存した物件をすべて削除しますか？')) return;
  for (const p of [...state.savedProperties]) {
    await deleteProperty(p.id);
  }
  render();
}

// ============================================================
// Chart Drawing (Chart.js)
// ============================================================
function destroyCharts() {
  Object.values(state.charts).forEach(c => { try { c.destroy(); } catch {} });
  state.charts = {};
}

function drawCompareCharts(ranked) {
  destroyCharts();

  // Bar chart: price vs score
  const barCtx = document.getElementById('chart-bar');
  if (barCtx) {
    state.charts.bar = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: ranked.map(a => a.name),
        datasets: [
          {
            label: '住宅地価格 (円/m²)',
            data: ranked.map(a => a.residentialPrice),
            backgroundColor: ranked.map((_,i) => COLORS[i % COLORS.length] + '88'),
            borderColor: ranked.map((_,i) => COLORS[i % COLORS.length]),
            borderWidth: 1,
            yAxisID: 'y',
            borderRadius: 6,
          },
          {
            label: '総合スコア',
            data: ranked.map(a => a.scores.total),
            backgroundColor: '#94a3b8' + '66',
            borderColor: '#94a3b8',
            borderWidth: 1,
            yAxisID: 'y1',
            borderRadius: 6,
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
        scales: {
          y: { position: 'left', title: { display: true, text: '円/m²', font: { size: 11 } }, ticks: { font: { size: 10 } } },
          y1: { position: 'right', title: { display: true, text: 'スコア', font: { size: 11 } }, grid: { drawOnChartArea: false }, ticks: { font: { size: 10 } } }
        }
      }
    });
  }

  // Line chart: trends
  const trendCtx = document.getElementById('chart-trend');
  if (trendCtx) {
    state.charts.trend = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: ['2020','2021','2022','2023','2024','2025'],
        datasets: AREAS.map((a,i) => ({
          label: a.name,
          data: a.trend.map(t => t.p),
          borderColor: COLORS[i % COLORS.length],
          backgroundColor: COLORS[i % COLORS.length] + '15',
          borderWidth: 2,
          pointRadius: 3,
          tension: 0.3,
          fill: false
        }))
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
        scales: {
          y: { title: { display: true, text: '円/m²', font: { size: 11 } }, ticks: { font: { size: 10 } } }
        }
      }
    });
  }
}

function drawDetailCharts(area) {
  destroyCharts();

  // Radar chart
  const radarCtx = document.getElementById('chart-radar');
  if (radarCtx) {
    state.charts.radar = new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: ['価格', '交通', '成長性', '利便性', '子育て', '自然'],
        datasets: [{
          label: area.name,
          data: [area.scores.price, area.scores.access, area.scores.growth, area.scores.living, area.scores.family, area.scores.nature],
          backgroundColor: '#3b82f6' + '30',
          borderColor: '#3b82f6',
          borderWidth: 2,
          pointBackgroundColor: '#3b82f6',
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          r: {
            beginAtZero: true, max: 100,
            ticks: { font: { size: 10 }, stepSize: 20 },
            pointLabels: { font: { size: 12 } }
          }
        }
      }
    });
  }

  // Detail trend line
  const trendCtx = document.getElementById('chart-detail-trend');
  if (trendCtx) {
    state.charts.detailTrend = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: area.trend.map(t => t.y),
        datasets: [{
          label: `${area.name} 地価推移`,
          data: area.trend.map(t => t.p),
          borderColor: '#3b82f6',
          backgroundColor: '#3b82f6' + '15',
          borderWidth: 3,
          pointRadius: 5,
          pointBackgroundColor: '#3b82f6',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { title: { display: true, text: '円/m²', font: { size: 11 } } }
        }
      }
    });
  }
}

// ============================================================
// Event Binding
// ============================================================
function bindEvents(ranked) {
  // Tab switches
  document.querySelectorAll('[data-tab]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.view = btn.dataset.tab;
      if (state.view === 'detail' && !state.selectedAreaId) {
        state.selectedAreaId = ranked[0]?.id;
      }
      if (state.view === 'property' && state.savedProperties.length === 0) {
        loadSavedProperties().then(() => render());
      }
      render();
    });
  });

  // Weight sliders
  document.querySelectorAll('input[data-weight]').forEach(slider => {
    slider.addEventListener('input', (e) => {
      const key = e.target.dataset.weight;
      const val = parseInt(e.target.value);
      state.weights[key] = val;
      const vEl = document.getElementById(`wv-${key}`);
      if (vEl) vEl.textContent = val;
      e.target.style.background = `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${val*2}%, #e5e7eb ${val*2}%, #e5e7eb 100%)`;
      // Debounced re-render for ranking
      clearTimeout(state._renderTimeout);
      state._renderTimeout = setTimeout(() => render(), 150);
    });
  });

  // Area detail click
  document.querySelectorAll('[data-area-detail]').forEach(el => {
    el.addEventListener('click', () => {
      state.selectedAreaId = el.dataset.areaDetail;
      state.view = 'detail';
      render();
    });
  });

  // Area switch buttons
  document.querySelectorAll('[data-area-switch]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.selectedAreaId = btn.dataset.areaSwitch;
      render();
    });
  });

  // Back button
  const backBtn = document.getElementById('btn-back');
  if (backBtn) backBtn.addEventListener('click', () => { state.view = 'ranking'; render(); });

  // Detail → Map button
  const toMapBtn = document.getElementById('btn-to-map');
  if (toMapBtn) {
    toMapBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = state.selectedAreaId;
      state.view = 'map';
      render();
    });
  }
}

// ============================================================
// Initialize
// ============================================================
loadDistrictCache();
render();
// ページロード時: まず静的JSONを読み込み、なければMCP接続を案内
loadStaticData();
// Supabase匿名認証を初期化（バックグラウンド）
ensureAuth().then(() => {
  loadSavedProperties().then(() => {
    if (state.savedProperties.length > 0) render();
  });
}).catch(e => console.warn('Auth init skipped:', e.message));
</script>
</body>
</html>
