<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="VBmM5Mikm2LrkY9dXa30MUHtT9KD2SpZFsoGHBuFPWM" />
<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SZV3XF0W0G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SZV3XF0W0G');
</script>
<title>亀山市で注文住宅｜土地相場・費用シミュレーション・取引データ | 注文相談.com</title>
<meta name="description" content="亀山市で注文住宅を検討中の方へ。交通の要衝で車通勤に便利、手頃な土地相場（坪9.8万円〜）、費用シミュレーション・取引データを提供。">
<meta name="keywords" content="亀山市,注文住宅,土地探し,土地相場,費用シミュレーション,三重県,名古屋通勤">
<link rel="canonical" href="https://research.chuumon-soudan.com/area/mie/kameyama/">
<!-- OGP -->
<meta property="og:title" content="亀山市で注文住宅｜土地相場・費用シミュレーション・取引データ">
<meta property="og:description" content="亀山市で注文住宅を検討中の方へ。交通の要衝で車通勤に便利、手頃な土地相場（坪9.8万円〜）、費用シミュレーション・取引データを提供。">
<meta property="og:type" content="website">
<meta property="og:url" content="https://research.chuumon-soudan.com/area/mie/kameyama/">
<meta property="og:site_name" content="注文相談.com">
<meta property="og:locale" content="ja_JP">
<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="亀山市で注文住宅｜土地相場・費用シミュレーション">
<meta name="twitter:description" content="亀山市で注文住宅を検討中の方へ。交通の要衝で車通勤に便利、手頃な土地相場（坪9.8万円〜）、費用シミュレーション・取引データを提供。">
<meta property="og:image" content="https://research.chuumon-soudan.com/og-image-kameyama.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta name="twitter:image" content="https://research.chuumon-soudan.com/og-image-kameyama.png">
<!-- 構造化データ (JSON-LD) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "亀山市 注文住宅 土地相場・費用シミュレーター",
  "description": "三重県北部7エリアの土地価格相場・取引データ・子育て環境をリアルタイムで比較できる無料ツール",
  "url": "https://research.chuumon-soudan.com/area/mie/kameyama/",
  "applicationCategory": "RealEstate",
  "operatingSystem": "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "JPY" },
  "author": { "@type": "Organization", "name": "注文相談.com", "url": "https://research.chuumon-soudan.com/about/", "description": "注文住宅の土地探し・費用比較をサポートする情報サイト" }, "publisher": { "@type": "Organization", "name": "注文相談.com", "url": "https://research.chuumon-soudan.com/about/" }, "dateModified": "2026-02-19",
  "areaServed": { "@type": "State", "name": "三重県" },
  "about": [
    { "@type": "Thing", "name": "注文住宅" },
    { "@type": "Thing", "name": "土地探し" },
    { "@type": "Thing", "name": "不動産価格" }
  ]
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* === Tailwind CSS v3.4.19 (production build) === */
  *,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sticky{position:sticky}.top-0{top:0}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-1{margin-left:.25rem}.mt-0\.5{margin-top:.125rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.h-6{height:1.5rem}.w-12{width:3rem}.w-16{width:4rem}.w-28{width:7rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-8{width:2rem}.w-full{width:100%}.min-w-0{min-width:0}.max-w-6xl{max-width:72rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity,1))}.border-blue-100{--tw-border-opacity:1;border-color:rgb(219 234 254/var(--tw-border-opacity,1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-50{--tw-border-opacity:1;border-color:rgb(249 250 251/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.bg-amber-500{--tw-bg-opacity:1;background-color:rgb(245 158 11/var(--tw-bg-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgb(156 163 175/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94/var(--tw-bg-opacity,1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity,1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255/var(--tw-bg-opacity,1))}.bg-slate-400{--tw-bg-opacity:1;background-color:rgb(148 163 184/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.p-2{padding:.5rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.leading-relaxed{line-height:1.625}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-amber-800{--tw-text-opacity:1;color:rgb(146 64 14/var(--tw-text-opacity,1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.shadow-md,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.outline{outline-style:solid}.blur{--tw-blur:blur(8px)}.blur,.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-filter{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity,1))}@media (min-width:640px){.sm\:block{display:block}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}@media (min-width:768px){.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  * { font-family: 'Noto Sans JP', sans-serif; }
  body { background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 50%, #f5f0ff 100%); min-height: 100vh; }
  .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); }
  .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; transition: all 0.2s; }
  .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .medal-gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
  .medal-silver { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
  .medal-bronze { background: linear-gradient(135deg, #CD7F32, #B8860B); }
  input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 3px; outline: none; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #3b82f6; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  .tab-active { background: #3b82f6; color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }
  .score-bar { height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; }
  .score-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .pulse-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 500; }
  /* Map styles */
  .map-layout { display: flex; gap: 0; height: 600px; }
  #map-container { flex: 1; min-height: 400px; border-radius: 12px 0 0 12px; overflow: hidden; z-index: 1; }
  #map-sidebar { width: 340px; background: white; border-left: 1px solid #e5e7eb; border-radius: 0 12px 12px 0; overflow-y: auto; padding: 0; }
  .leaflet-container { font-family: 'Noto Sans JP', sans-serif; }
  .map-marker-icon { transition: transform 0.2s; }
  .map-marker-icon:hover { transform: scale(1.15); }
  .sidebar-header { padding: 16px; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; z-index: 2; }
  .sidebar-body { padding: 16px; }
  .tx-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .tx-table th { background: #f9fafb; padding: 6px 8px; text-align: left; font-weight: 500; color: #6b7280; position: sticky; top: 0; }
  .tx-table td { padding: 6px 8px; border-top: 1px solid #f3f4f6; }
  .tx-table tr[data-tx-idx] { cursor: pointer; transition: background 0.15s; }
  .tx-table tr[data-tx-idx]:hover { background: #dbeafe; }
  .tx-table tr.tx-active { background: #bfdbfe; }
  /* School district toggle */
  .school-toggle { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; user-select: none; transition: all 0.2s; border: 1px solid #d1d5db; background: white; }
  .school-toggle.active { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
  .school-toggle:hover { background: #f3f4f6; }
  .school-toggle.active:hover { background: #bfdbfe; }
  /* School icon markers */
  .school-icon-marker { background: none !important; border: none !important; }
  /* Map loading overlay */
  .map-loading-overlay {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 800;
    background: rgba(0,0,0,0.25); display: flex; flex-direction: column;
    align-items: center; justify-content: center; pointer-events: none;
    transition: opacity 0.3s;
  }
  .map-loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .map-loading-box {
    background: white; border-radius: 12px; padding: 16px 28px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18); text-align: center;
    animation: mapLoadBounce 2s ease-in-out infinite;
  }
  @keyframes mapLoadBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
  .map-loading-spinner {
    width: 32px; height: 32px; border: 3px solid #e5e7eb;
    border-top-color: #3b82f6; border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 0 auto 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .map-loading-progress {
    width: 120px; height: 4px; background: #e5e7eb; border-radius: 2px;
    margin: 8px auto 0; overflow: hidden;
  }
  .map-loading-progress-bar {
    height: 100%; background: #3b82f6; border-radius: 2px;
    transition: width 0.3s ease;
  }
  /* Fullscreen map */
  .map-fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; border-radius: 0 !important; margin: 0;
  }
  .map-fullscreen #map-container { border-radius: 0; height: 100vh; }
  .map-fullscreen #map-sidebar { border-radius: 0; height: 100vh; }
  .map-fullscreen-controls {
    position: fixed; top: 12px; left: 50%; transform: translateX(-50%); z-index: 10001;
    background: rgba(255,255,255,0.92); backdrop-filter: blur(8px);
    padding: 8px 12px; border-radius: 10px; display: none;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    gap: 8px; align-items: center;
  }
  .map-fullscreen-controls.visible { display: flex; }
  .map-fullscreen-btn {
    display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px;
    border-radius: 6px; font-size: 12px; cursor: pointer; user-select: none;
    transition: all 0.2s; border: 1px solid #d1d5db; background: white; color: #374151;
  }
  .map-fullscreen-btn:hover { background: #f3f4f6; }
  .map-fullscreen-btn.active { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
  @media (max-width: 768px) {
    .map-layout { flex-direction: column; height: auto; min-height: 400px; }
    #map-container { height: 400px; min-height: 400px; border-radius: 12px 12px 0 0; }
    #map-sidebar { width: 100%; border-left: none; border-top: 1px solid #e5e7eb; border-radius: 0 0 12px 12px; max-height: 350px; }
    .map-fullscreen #map-sidebar { height: auto; max-height: 40vh; }
  }
  /* === Second Opinion Feature === */
  .so-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; }
  .so-modal { background: white; border-radius: 16px; max-width: 560px; width: 90%; max-height: 85vh; overflow-y: auto; padding: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
  .so-fixed-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border-top: 1px solid #e5e7eb; padding: 12px 16px; z-index: 100; display: flex; align-items: center; justify-content: center; gap: 16px; box-shadow: 0 -2px 10px rgba(0,0,0,0.08); }
  .so-badge-yellow { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-red { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-none { background: #f0fdf4; color: #166534; border: 1px solid #86efac; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-compare-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .so-compare-table th, .so-compare-table td { padding: 8px 12px; border: 1px solid #e5e7eb; text-align: left; }
  .so-compare-table th { background: #f9fafb; font-weight: 600; white-space: nowrap; }
  .so-compare-table .missing { color: #d97706; font-style: italic; }
  .so-radio-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .so-radio-group label { padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
  .so-radio-group label:hover { border-color: #3b82f6; background: #eff6ff; }
  .so-radio-group input:checked + span { color: #1d4ed8; }
  .so-radio-group label:has(input:checked) { border-color: #3b82f6; background: #dbeafe; }
  @media (max-width: 768px) {
    .comp-layout-sidebar { flex-direction: column !important; }
    .comp-layout-sidebar > div:first-child { width: 100% !important; }
    .comp-layout-sidebar > div:first-child .sticky { position: relative !important; top: 0 !important; }
    .mobile-title-text { font-size: 1.1rem; }
    .mobile-subtitle-text { font-size: 0.75rem; }
    #mobile-menu-fab, #mobile-drawer-overlay, #mobile-drawer-panel { display: block !important; }
    #mobile-menu-fab { display: flex !important; }
    #pc-nav-bar { display: none !important; }
  }

  .tip-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: #dbeafe; color: #2563eb; font-size: 10px; font-weight: 700; cursor: help; position: relative; margin-left: 4px; vertical-align: middle; }
  .tip-icon:hover .tip-body, .tip-icon:focus .tip-body { display: block; }
  .tip-body { display: none; position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%); width: 260px; padding: 8px 12px; background: #1e293b; color: #f1f5f9; font-size: 12px; line-height: 1.5; border-radius: 8px; z-index: 50; font-weight: 400; box-shadow: 0 4px 12px rgba(0,0,0,0.15); pointer-events: none; }
  .tip-body::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 5px solid transparent; border-top-color: #1e293b; }
  /* FAQ accordion */
  .faq-answer { display: none; }
  .faq-open .faq-answer { display: block; }
  .faq-open .faq-chevron { transform: rotate(180deg); }
  
  .seo-static-content { max-width: 800px; margin: 0 auto; padding: 24px 16px; font-family: 'Noto Sans JP', sans-serif; color: #374151; line-height: 1.8; }
  .seo-static-content h1 { font-size: 1.5rem; font-weight: 700; color: #111827; margin-bottom: 16px; }
  .seo-static-content h2 { font-size: 1.2rem; font-weight: 700; color: #1f2937; margin-top: 32px; margin-bottom: 12px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
  .seo-static-content h3 { font-size: 1rem; font-weight: 600; color: #374151; margin-top: 16px; margin-bottom: 8px; }
  .seo-static-content p { margin-bottom: 12px; font-size: 0.95rem; }
  .seo-static-content ul, .seo-static-content ol { margin-bottom: 16px; padding-left: 24px; }
  .seo-static-content li { margin-bottom: 8px; font-size: 0.9rem; }
  .seo-static-content a { color: #2563eb; text-decoration: underline; }
  .seo-static-content footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid #e5e7eb; font-size: 0.8rem; color: #6b7280; }
  .seo-faq-item { margin-bottom: 16px; padding: 12px 16px; background: #f9fafb; border-radius: 8px; }
  .seo-tip { margin-bottom: 12px; padding: 12px 16px; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6; }
  
</style>
<script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"トップ","item":"https://research.chuumon-soudan.com/"},{"@type":"ListItem","position":2,"name":"三重県エリア比較","item":"https://research.chuumon-soudan.com/area/mie/"},{"@type":"ListItem","position":3,"name":"亀山市","item":"https://research.chuumon-soudan.com/area/mie/kameyama/"}]}</script>
<script type="application/ld+json">{"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"亀山市で注文住宅用の土地相場はいくらですか？","acceptedAnswer":{"@type":"Answer","text":"亀山市の住宅地平均地価は約27,000円/m²（坪単価約9.8万円）です。亀山駅周辺で坪12〜18万円、郊外の関エリアでは坪6〜10万円が目安。60坪の土地が400〜1,000万円程度で見つかります。"}},{"@type":"Question","name":"亀山市から名古屋への通勤時間はどのくらいですか？","acceptedAnswer":{"@type":"Answer","text":"JR亀山駅から名古屋駅まで快速みえで約60分。車では東名阪自動車道で約50分〜1時間です。名古屋通勤は可能ですが、週数回のテレワーク併用が理想的です。"}},{"@type":"Question","name":"亀山市で注文住宅を建てる総費用の目安は？","acceptedAnswer":{"@type":"Answer","text":"土地60坪＋建物35坪のスタンダードプランの場合、土地代400〜800万円＋建築費2,275万円＋諸費用250〜350万円で、総額2,900〜3,400万円程度が目安です。"}},{"@type":"Question","name":"亀山市の製造業雇用は安定していますか？","acceptedAnswer":{"@type":"Answer","text":"亀山市にはSharp亀山工場をはじめ、多数の製造業が集積しています。液晶パネル工場の規模は縮小しましたが、代替産業の誘致も進んでおり、雇用基盤は維持されています。"}}]}</script>
</head>
<body>
<div id="app"></div>

<article id="seo-static" class="seo-static-content">
  <h1>亀山市で注文住宅を建てる｜土地相場・費用シミュレーション</h1>

  <section>
    <h2>亀山市の注文住宅事情</h2>
    <p>亀山市は三重県中北部、東名阪自動車道と新名神高速道路が交差する交通の要衝です。人口約5万人のコンパクトな街で、旧東海道の宿場町「関宿」が残る歴史ある街並みが魅力。坪単価は平均9.8万円といなべ市に次いで手頃で、車通勤をメインにする方には特におすすめです。名古屋方面へも大阪方面へも高速道路一本でアクセスでき、車社会の三重県において理想的な立地条件を備えています。Sharp亀山工場をはじめとする製造業の集積により、地元雇用も安定しています。</p>
    <div class="seo-tip"><h3>高速道路の結節点で車通勤に最適</h3><p>亀山市は東名阪自動車道と新名神高速道路が交差する交通の要衝。名古屋方面へも大阪方面へもアクセスが良く、車通勤メインの方には特におすすめ。亀山ICや鈴鹿IC近くの住宅地は坪10〜15万円程度です。</p></div><div class="seo-tip"><h3>旧東海道の歴史ある街並みと新興住宅地の共存</h3><p>関宿をはじめとする歴史的な街並みが残る一方、亀山駅周辺では新興住宅地の開発も進んでいます。野村エリアは区画整理された新興住宅地で、坪12〜15万円程度。学校・公園も近く、ファミリー向けの注文住宅に適しています。</p></div>
  </section>

  <section>
    <h2>亀山市の土地選び実践ガイド</h2>
    <p>亀山市の土地選びは車アクセスを軸に考えましょう。亀山IC・鈴鹿IC・関ICの3つの高速ICが市内にあり、IC車10分圏が最も利便性が高いエリアです。用途地域は住宅地の多くが第一種住居地域と第一種低層住居専用地域。亀山駅周辺の野村地区は区画整理された新興住宅地で、道路幅員6m以上の整形地が多く、注文住宅に最適です。関エリアは古い街並みが残る分、接道条件や建築制限の確認が重要。亀山市は比較的地盤が安定した丘陵地帯ですが、鈴鹿川沿いの低地は浸水リスクがあるため、ハザードマップを必ず確認してください。</p>
  </section>

  <section>
    <h2>亀山市の注文住宅 費用の内訳</h2>
    <p>亀山市は手頃な土地価格が魅力です。60坪の土地が400〜800万円、建築費はスタンダード（65万円/坪×35坪）で2,275万円、諸費用が250〜350万円。総額の目安は2,900〜3,400万円です。鈴鹿市とほぼ同水準ですが、亀山市の方が高速ICに近い土地が安く手に入る傾向があります。また、亀山市は固定資産税の評価額が低いため、住宅取得後のランニングコストも比較的抑えられます。住宅ローンは借入3,000万円・金利0.5%・35年で月々約7.7万円の返済額です。</p>
  </section>

  <section>
    <h2>亀山市のエリア比較</h2>
    <p>亀山市の住宅エリアは2つに大別できます。【亀山駅周辺・野村地区】は坪12〜18万円。区画整理された新興住宅地で、学校・公園・スーパーが計画的に配置。JR亀山駅まで徒歩圏で、名古屋への公共交通通勤も一応可能。ファミリー向けの注文住宅に最適。【関エリア】は坪6〜10万円。旧東海道の歴史ある街で、趣のある住環境。関IC至近で車通勤に便利。土地が広く取れるため、平屋や庭付き住宅に向いている。ただし商業施設は限られ、日用品以外は亀山駅方面か鈴鹿市へ。</p>
  </section>

  <section>
    <h2>亀山市で注文住宅を建てる際のよくある失敗</h2>
    <p>亀山市での失敗事例です。1つ目はJRの本数の確認不足。JR関西本線の亀山駅発着は1時間に1〜2本程度。終電も早いため、公共交通に依存した生活設計はリスクが高いです。車を前提とした土地選びをしましょう。2つ目はSharp関連の地域経済リスク。Sharp亀山工場の規模縮小は地元経済に影響を与えました。特定企業への依存度が高い地域であることを認識した上で、資金計画を立てましょう。3つ目は関エリアの建築制限の見落とし。関宿周辺は景観条例による建築制限（外壁の色彩、屋根の形状等）がある場合があります。事前に亀山市都市計画課で確認を。</p>
  </section>

  <section>
    <h2>土地購入前チェックリスト</h2>
    <p>亀山市はJRの本数が限られるため、車中心の生活を前提にした土地選びがおすすめです。</p>
    <ol><li><strong>用途地域を確認した</strong>: 第一種低層住居専用地域は注文住宅に最も適した用途地域の一つ。建ぺい率・容積率が厳しい分、閑静な住環境が保証されます。</li><li><strong>前面道路の幅員を確認した</strong>: 建築基準法上、幅員4m以上の道路に2m以上接している必要があります（接道義務）。4m未満の場合はセットバック（後退）が必要です。</li><li><strong>ハザードマップを確認した</strong>: 洪水・土砂災害・津波の各ハザードマップを確認。三重県は河川が多く、沿岸部は津波リスクもあるため、必ず事前チェックを。</li><li><strong>上下水道の状況を確認した</strong>: 上水道・下水道が前面道路まで来ているか確認。未整備の場合は引き込み工事費（50〜150万円）が別途必要になります。</li><li><strong>地盤の状態を確認した</strong>: 地盤改良工事が必要な場合、表層改良で30〜50万円、柱状改良で50〜100万円、鋼管杭で100〜200万円程度の追加費用がかかります。</li><li><strong>接道義務を確認した</strong>: 建築基準法第43条により、建築物の敷地は幅員4m以上の道路に2m以上接していなければなりません。私道の場合は権利関係も要確認。</li><li><strong>建築条件の有無を確認した</strong>: 「建築条件付き」の土地は指定の建築会社で建てる必要があります。注文住宅で好きな会社を選びたい場合は「条件なし」を選びましょう。</li><li><strong>周辺の開発計画を確認した</strong>: 近隣に大規模商業施設や道路の建設計画があると、将来の利便性・地価に影響します。市町の都市計画課で確認できます。</li><li><strong>現地を複数回訪問した</strong>: 平日・休日、朝・昼・夜と時間帯を変えて現地を訪問。騒音・交通量・日当たり・近隣の様子を自分の目で確認しましょう。</li><li><strong>複数の建築会社から見積もりを取った</strong>: 最低3社から見積もりを取り、価格だけでなく標準仕様・保証内容・アフターサービスを比較。相見積もりで適正価格を把握できます。</li></ol>
  </section>

  <section>
    <h2>よくある質問（亀山市の注文住宅）</h2>
    <div class="seo-faq-item"><h3>亀山市で注文住宅用の土地相場はいくらですか？</h3><p>亀山市の住宅地平均地価は約27,000円/m²（坪単価約9.8万円）です。亀山駅周辺で坪12〜18万円、郊外の関エリアでは坪6〜10万円が目安。60坪の土地が400〜1,000万円程度で見つかります。</p></div><div class="seo-faq-item"><h3>亀山市から名古屋への通勤時間はどのくらいですか？</h3><p>JR亀山駅から名古屋駅まで快速みえで約60分。車では東名阪自動車道で約50分〜1時間です。名古屋通勤は可能ですが、週数回のテレワーク併用が理想的です。</p></div><div class="seo-faq-item"><h3>亀山市で注文住宅を建てる総費用の目安は？</h3><p>土地60坪＋建物35坪のスタンダードプランの場合、土地代400〜800万円＋建築費2,275万円＋諸費用250〜350万円で、総額2,900〜3,400万円程度が目安です。</p></div><div class="seo-faq-item"><h3>亀山市の製造業雇用は安定していますか？</h3><p>亀山市にはSharp亀山工場をはじめ、多数の製造業が集積しています。液晶パネル工場の規模は縮小しましたが、代替産業の誘致も進んでおり、雇用基盤は維持されています。</p></div>
  </section>

  <section>
    <h2>近隣エリアの注文住宅情報</h2>
    <p><a href="/area/mie/suzuka/">鈴鹿市の注文住宅情報</a></p>
    <p><a href="/area/mie/">三重県エリア比較に戻る</a> | <a href="/">物件比較ツールを使う</a></p>
  </section>

  <footer>
    <p>データ出典: <a href="https://www.reinfolib.mlit.go.jp/" rel="noopener">国土交通省 不動産情報ライブラリ（REINFOLIB）</a>、<a href="https://www.land.mlit.go.jp/landPrice/AriaServlet?MOD=2&TYP=0" rel="noopener">国土交通省 地価公示</a></p>
    <p>最終更新: 2026-02-19 ｜ 監修: <a href="/about/" rel="noopener">注文相談.com</a> 編集部</p>
  </footer>
</article>

<script>
// ============================================================
// 設定 — デプロイ時にここを編集
// ============================================================
const CONFIG = {
  // プロキシURL（Supabase Edge Function）
  PROXY_URL: 'https://jvfmvitknqnmuduyscnl.supabase.co/functions/v1/mcp-proxy',

  // MCPサーバーURL（プロキシ経由で接続）
  MCP_REINFO: 'https://mcp.n-3.ai/mcp?tools=get-time,reinfolib-real-estate-price,reinfolib-city-list',
  MCP_ESTAT: 'https://mcp.n-3.ai/mcp?tools=e-stat-get-stats-list,e-stat-get-meta-info,e-stat-get-data-catalog',
};





// ============================================================
// MCP Streamable HTTP Client (with proxy support)
// ============================================================
class MCPClient {
  constructor(mcpUrl, proxyUrl) {
    this.mcpUrl = mcpUrl;
    this.proxyUrl = proxyUrl;
    this.sessionId = null;
    this.requestId = 0;
    this.connected = false;
    this.tools = [];
    this.useProxy = !!proxyUrl;
  }

  _buildFetchUrl() {
    if (this.useProxy) {
      return `${this.proxyUrl}?url=${encodeURIComponent(this.mcpUrl)}`;
    }
    return this.mcpUrl;
  }

  async initialize() {
    // Try proxy first, then direct
    const attempts = this.useProxy
      ? [true, false]  // proxy → direct
      : [false];       // direct only

    let lastError;
    for (const viaProxy of attempts) {
      try {
        this.useProxy = viaProxy;
        const url = this._buildFetchUrl();

        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/event-stream',
          },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: ++this.requestId,
            method: 'initialize',
            params: {
              protocolVersion: '2025-03-26',
              capabilities: {},
              clientInfo: { name: 'yume-no-sumika-realestate', version: '1.0.0' }
            }
          })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const sid = res.headers.get('Mcp-Session-Id');
        if (sid) this.sessionId = sid;

        const data = await this._parseResponse(res);

        // Send initialized notification
        const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
        if (this.sessionId) headers['Mcp-Session-Id'] = this.sessionId;

        await fetch(this._buildFetchUrl(), {
          method: 'POST',
          headers,
          body: JSON.stringify({ jsonrpc: '2.0', method: 'notifications/initialized' })
        });

        this.connected = true;
        console.log(`MCP connected via ${viaProxy ? 'proxy' : 'direct'}`);
        return data;
      } catch (e) {
        lastError = e;
        console.warn(`MCP ${viaProxy ? 'proxy' : 'direct'} failed:`, e.message);
      }
    }
    this.connected = false;
    throw lastError;
  }

  async listTools() {
    const data = await this._request('tools/list', {});
    if (data && data.tools) this.tools = data.tools;
    return this.tools;
  }

  async callTool(name, args = {}) {
    return this._request('tools/call', { name, arguments: args });
  }

  async _request(method, params) {
    const url = this._buildFetchUrl();
    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json, text/event-stream' };
    if (this.sessionId) headers['Mcp-Session-Id'] = this.sessionId;

    const res = await fetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify({ jsonrpc: '2.0', id: ++this.requestId, method, params })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return this._parseResponse(res);
  }

  async _parseResponse(res) {
    const ct = res.headers.get('Content-Type') || '';
    if (ct.includes('text/event-stream')) {
      const text = await res.text();
      const lines = text.split('\n');
      let lastData = null;
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try { lastData = JSON.parse(line.slice(6)); } catch {}
        }
      }
      return lastData?.result || lastData;
    }
    const json = await res.json();
    return json.result || json;
  }
}

// ============================================================
// Pre-loaded Area Data (fallback + base data)
// ============================================================
const AREAS = [
  {
    id: "yokkaichi", name: "四日市市", cityCode: "24202", lat: 34.9650, lng: 136.6244,
    landPriceAvg: 57020, residentialPrice: 48385, commercialPrice: 89007, pricePerTsubo: 188498,
    yoyChange: 1.33, population: 311000, popGrowthRate: -0.3, accessToNagoya: 35,
    hospitals: 42, schools: 58, parks: 35, shopping: 120, safetyScore: 78, childcareScore: 82, naturalScore: 55,
    description: "三重県最大の都市。石油化学コンビナートと港湾を擁する産業都市。近鉄・JR両線で名古屋へ直通。大型商業施設が充実し、医療・教育インフラも県内トップクラス。",
    highlights: ["県内最大の商業集積", "名古屋へ35分", "医療施設充実", "東名阪・新名神IC"],
    risks: ["一部地域の大気環境", "中心部の地価上昇"],
    trend: [{y:"2020",p:52000},{y:"2021",p:53200},{y:"2022",p:54500},{y:"2023",p:55800},{y:"2024",p:56300},{y:"2025",p:57020}],
    recAreas: ["富田・富洲原エリア（駅近で割安）","笹川・日永エリア（住環境良好）","水沢・小山田エリア（自然豊か）"]
  },
  {
    id: "kuwana", name: "桑名市", cityCode: "24205", lat: 35.0585, lng: 136.6834,
    landPriceAvg: 55543, residentialPrice: 53686, commercialPrice: 86714, pricePerTsubo: 183614,
    yoyChange: 0.82, population: 140000, popGrowthRate: -0.5, accessToNagoya: 25,
    hospitals: 18, schools: 28, parks: 22, shopping: 55, safetyScore: 82, childcareScore: 85, naturalScore: 68,
    description: "名古屋への通勤圏として人気。桑名駅から名古屋まで最短25分。ナガシマスパーランドやなばなの里など観光資源も豊富。歴史的な城下町の風情が残る。",
    highlights: ["名古屋へ最短25分","子育て環境◎","観光資源豊富","住環境の良さ"],
    risks: ["揖斐川・長良川の洪水リスク","人口減少傾向"],
    trend: [{y:"2020",p:52500},{y:"2021",p:53000},{y:"2022",p:53800},{y:"2023",p:54500},{y:"2024",p:55100},{y:"2025",p:55543}],
    recAreas: ["桑名駅周辺（利便性重視）","多度エリア（自然と価格バランス）","長島エリア（ゆったり居住）"]
  },
  {
    id: "suzuka", name: "鈴鹿市", cityCode: "24207", lat: 34.8824, lng: 136.5842,
    landPriceAvg: 41015, residentialPrice: 38000, commercialPrice: 62000, pricePerTsubo: 135587,
    yoyChange: 1.11, population: 195000, popGrowthRate: -0.2, accessToNagoya: 55,
    hospitals: 25, schools: 42, parks: 28, shopping: 72, safetyScore: 80, childcareScore: 80, naturalScore: 65,
    description: "鈴鹿サーキットとHonda技研の企業城下町。名古屋圏と比べ地価が手頃で、広い土地を確保しやすい。新名神鈴鹿スマートICの開通で交通利便性が向上。",
    highlights: ["地価が手頃で広い家が建てやすい","Honda関連の雇用安定","新名神スマートIC","中勢バイパス整備"],
    risks: ["名古屋通勤にはやや遠い","沿岸部の津波リスク"],
    trend: [{y:"2020",p:38500},{y:"2021",p:39000},{y:"2022",p:39600},{y:"2023",p:40200},{y:"2024",p:40600},{y:"2025",p:41015}],
    recAreas: ["白子駅周辺（利便性◎）","平田・算所エリア（落ち着いた住宅地）","庄野・加佐登エリア（新興住宅地）"]
  },
  {
    id: "inabe", name: "いなべ市", cityCode: "24212", lat: 35.1146, lng: 136.5612,
    landPriceAvg: 24500, residentialPrice: 22000, commercialPrice: 35000, pricePerTsubo: 81000,
    yoyChange: 0.45, population: 44000, popGrowthRate: -0.8, accessToNagoya: 65,
    hospitals: 6, schools: 14, parks: 18, shopping: 15, safetyScore: 88, childcareScore: 75, naturalScore: 95,
    description: "鈴鹿山脈の麓に広がる自然豊かなまち。アウトドアレジャーが充実し、移住先として注目度上昇中。地価は県北部で最も手頃な水準。",
    highlights: ["圧倒的な自然環境","地価が非常に手頃","移住支援制度充実","アウトドア天国"],
    risks: ["商業施設が少ない","公共交通が不便","人口減少"],
    trend: [{y:"2020",p:23500},{y:"2021",p:23700},{y:"2022",p:23900},{y:"2023",p:24100},{y:"2024",p:24300},{y:"2025",p:24500}],
    recAreas: ["北勢エリア（駅近・利便性）","員弁エリア（閑静な住宅地）","藤原エリア（山間部・格安）"]
  },
  {
    id: "kameyama", name: "亀山市", cityCode: "24210", lat: 34.8540, lng: 136.4520,
    landPriceAvg: 29500, residentialPrice: 27000, commercialPrice: 42000, pricePerTsubo: 97500,
    yoyChange: 0.68, population: 49000, popGrowthRate: -0.6, accessToNagoya: 60,
    hospitals: 8, schools: 16, parks: 15, shopping: 22, safetyScore: 85, childcareScore: 76, naturalScore: 80,
    description: "東名阪と新名神が交差する交通の要衝。旧東海道の宿場町の歴史を持つ。Sharp亀山工場をはじめ製造業が集積。",
    highlights: ["高速道路の結節点","製造業の雇用","歴史的な街並み","割安な地価"],
    risks: ["JRの本数が少ない","商業施設が限定的"],
    trend: [{y:"2020",p:28000},{y:"2021",p:28300},{y:"2022",p:28700},{y:"2023",p:29000},{y:"2024",p:29200},{y:"2025",p:29500}],
    recAreas: ["亀山駅周辺（JRアクセス）","関エリア（宿場町の風情）","野村エリア（新興住宅地）"]
  },
  {
    id: "komono", name: "菰野町", cityCode: "24341", lat: 35.0244, lng: 136.5090,
    landPriceAvg: 31000, residentialPrice: 29000, commercialPrice: 45000, pricePerTsubo: 102500,
    yoyChange: 0.55, population: 41000, popGrowthRate: -0.1, accessToNagoya: 50,
    hospitals: 7, schools: 12, parks: 20, shopping: 25, safetyScore: 86, childcareScore: 83, naturalScore: 92,
    description: "御在所岳と湯の山温泉を抱える観光と自然のまち。近鉄湯の山線で四日市へ直通。人口減少率が低く、移住先として人気が高い。",
    highlights: ["温泉と自然環境","人口減少率が低い","四日市へのアクセス良好","移住人気上昇中"],
    risks: ["鉄道は湯の山線のみ","大型商業施設が少ない"],
    trend: [{y:"2020",p:29500},{y:"2021",p:29800},{y:"2022",p:30200},{y:"2023",p:30500},{y:"2024",p:30800},{y:"2025",p:31000}],
    recAreas: ["菰野駅周辺（利便性重視）","湯の山エリア（温泉・自然）","竹成・千草エリア（閑静）"]
  },
  {
    id: "toin", name: "東員町", cityCode: "24343", lat: 35.0690, lng: 136.6030,
    landPriceAvg: 35500, residentialPrice: 33000, commercialPrice: 48000, pricePerTsubo: 117400,
    yoyChange: 0.72, population: 26000, popGrowthRate: 0.1, accessToNagoya: 40,
    hospitals: 5, schools: 8, parks: 12, shopping: 18, safetyScore: 87, childcareScore: 88, naturalScore: 72,
    description: "イオンモール東員を中心に商業施設が充実したコンパクトシティ。人口が微増傾向でファミリー層に人気。",
    highlights: ["人口増加傾向","イオンモール東員","子育て世代に人気","コンパクトで住みやすい"],
    risks: ["鉄道アクセスが限定的","町域が狭い"],
    trend: [{y:"2020",p:33500},{y:"2021",p:34000},{y:"2022",p:34500},{y:"2023",p:35000},{y:"2024",p:35200},{y:"2025",p:35500}],
    recAreas: ["東員駅周辺（駅近）","笹尾エリア（ファミリー向け）","城山エリア（新興住宅地）"]
  }
];

const COLORS = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4'];

// ============================================================
// App State
// ============================================================
const state = {
  view: 'detail',
  selectedAreaId: 'kameyama',
  mapSelectedAreaId: null,
  mcpStatus: 'disconnected', // disconnected | connecting | connected | error
  mcpMessage: '',
  mcpLiveData: null,
  weights: { price: 25, access: 20, growth: 15, living: 15, family: 15, nature: 10 },
  charts: {},
  mapSelectedDistrict: null,  // { cityId, districtName } or null
};

// Map globals (persistent across renders)
let mapInstance = null;
let mapMarkers = {};
let txMarkerLayer = null; // LayerGroup for transaction markers
let schoolDistrictLayer = null; // GeoJSON layer for school district polygons
let schoolMarkerLayer = null; // LayerGroup for school icon markers
let schoolDistrictData = null; // cached GeoJSON data
let showSchoolDistricts = false; // toggle state
let districtAreaLayer = null; // LayerGroup for district area circles
let showDistrictAreas = false; // toggle state

// ============================================================
// Score Calculation
// ============================================================
function calcScores(area, w) {
  const priceScore = 100 - ((area.residentialPrice - 20000) / 40000) * 100;
  const accessScore = ((70 - area.accessToNagoya) / 70) * 100;
  const growthScore = Math.min(100, Math.max(0, (area.yoyChange / 2) * 100));
  const livingScore = (area.hospitals/45)*25 + (area.schools/60)*25 + (area.shopping/120)*25 + (area.safetyScore/100)*25;
  const familyScore = (area.childcareScore + area.safetyScore + Math.min(100,(area.parks/35)*100)) / 3;
  const natureScore = area.naturalScore;
  const total = priceScore*(w.price/100) + accessScore*(w.access/100) + growthScore*(w.growth/100) + livingScore*(w.living/100) + familyScore*(w.family/100) + natureScore*(w.nature/100);
  return { price: Math.round(priceScore), access: Math.round(accessScore), growth: Math.round(growthScore), living: Math.round(livingScore), family: Math.round(familyScore), nature: Math.round(natureScore), total: Math.round(total) };
}

function getRankedAreas() {
  return AREAS.map(a => ({ ...a, scores: calcScores(a, state.weights) })).sort((a,b) => b.scores.total - a.scores.total);
}

// ============================================================
// Static Data Loading (from pre-fetched JSON)
// ============================================================
async function loadStaticData() {
  try {
    updateStatusText('キャッシュデータ読み込み中...');
    const res = await fetch('/data/live-data.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    applyStaticData(data);
    return true;
  } catch (e) {
    console.log('Static data not available:', e.message);
    return false;
  }
}

function applyStaticData(data) {
  for (const area of AREAS) {
    const src = data.areas[area.id];
    if (!src) continue;
    area._liveTransactions = src.transactions;
    area._liveAvgTradePrice = src.avgTradePrice;
    area._liveTransactionCount = src.transactionCount;
    AREA_FULL_LOADED.add(area.id);
  }

  state.mcpStatus = 'connected';
  state.fetchedAt = data.fetchedAt;

  let totalTx = 0;
  AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });

  const fetchDate = new Date(data.fetchedAt).toLocaleDateString('ja-JP');
  state.mcpMessage = `データ読込完了（${fetchDate}取得・計${totalTx.toLocaleString()}件）`;

  render();

  // マップ表示中ならピン表示
  if (state.view === 'map' && txMarkerLayer) {
    showAllTransactionPins();
  }
}

// ============================================================
// MCP Connection
// ============================================================
let mcpReinfo = null;

async function connectMCP() {
  state.mcpStatus = 'connecting';
  state.mcpMessage = 'MCPサーバーに接続中（プロキシ経由で試行）...';
  render();

  try {
    mcpReinfo = new MCPClient(CONFIG.MCP_REINFO, CONFIG.PROXY_URL);
    await mcpReinfo.initialize();
    const tools = await mcpReinfo.listTools();
    state.mcpStatus = 'connected';
    state.mcpMessage = `接続完了 — ${tools.length}個のツールが利用可能`;
    render();

    // Phase 1: 概要取得 → Phase 2: 全エリア詳細を自動取得
    await fetchLiveData();
    fetchAllAreasData();  // バックグラウンドで全エリア取得開始（awaitしない）
  } catch(e) {
    state.mcpStatus = 'error';
    state.mcpMessage = `接続失敗: ${e.message}（キャッシュデータを使用中）`;
    render();
  }
}

// Lightweight status text update (no full re-render)
function updateStatusText(msg) {
  state.mcpMessage = msg;
  const el = document.getElementById('mcp-status-text');
  if (el) el.textContent = msg;
}

// ------------------------------------------------------------
// Phase 1: Quick overview fetch (latest year only, all areas)
// ------------------------------------------------------------
async function fetchLiveData() {
  if (!mcpReinfo || !mcpReinfo.connected) return;

  try {
    updateStatusText('概要データを取得中...');

    const cityResult = await mcpReinfo.callTool('reinfolib-city-list', { area: '24' });

    // Fetch only latest year for quick overview (7 requests)
    const priceResults = [];
    for (const area of AREAS) {
      try {
        updateStatusText(`${area.name} の概要データ取得中...`);
        const priceData = await mcpReinfo.callTool('reinfolib-real-estate-price', {
          year: '2024', area: '24', city: area.cityCode
        });
        priceResults.push({ cityCode: area.cityCode, quarters: [priceData] });
      } catch(e) {
        console.warn(`Overview fetch failed for ${area.name}:`, e);
        priceResults.push({ cityCode: area.cityCode, quarters: [] });
      }
    }

    state.mcpLiveData = { cities: cityResult, prices: priceResults };
    updateAreasWithLiveData(priceResults);

    let totalTx = 0;
    AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
    state.mcpMessage = `概要データ取得完了（計${totalTx}件） — 詳細データを自動取得中...`;

    render();
  } catch(e) {
    state.mcpMessage = `データ取得エラー: ${e.message}（キャッシュデータを使用中）`;
    render();
  }
}

// ------------------------------------------------------------
// Phase 2: Deep fetch for a single area (5 years × 4 quarters)
// ------------------------------------------------------------
const AREA_FULL_LOADED = new Set();
let _currentFetchAreaId = null;
let _fetchPriorityAreaId = null;  // ユーザー選択による優先取得エリア
let _autoFetchRunning = false;    // 全エリア自動取得の実行中フラグ

async function fetchAreaFullData(areaId, options = {}) {
  if (!mcpReinfo || !mcpReinfo.connected) return;
  if (AREA_FULL_LOADED.has(areaId)) return; // already loaded
  if (_currentFetchAreaId === areaId) return; // already fetching

  const area = AREAS.find(a => a.id === areaId);
  if (!area) return;

  _currentFetchAreaId = areaId;

  // 選択中エリアのみオーバーレイ表示（バックグラウンド取得時は非表示）
  const isSelected = state.mapSelectedAreaId === areaId;
  const showOverlay = options.showOverlay !== undefined ? options.showOverlay : isSelected;
  if (showOverlay) showMapLoading(area.name, 0);

  const yearQuarters = [
    { year: '2024', quarter: '4' }, { year: '2024', quarter: '3' },
    { year: '2024', quarter: '2' }, { year: '2024', quarter: '1' },
    { year: '2023', quarter: '4' }, { year: '2023', quarter: '3' },
    { year: '2023', quarter: '2' }, { year: '2023', quarter: '1' },
    { year: '2022', quarter: '4' }, { year: '2022', quarter: '3' },
    { year: '2022', quarter: '2' }, { year: '2022', quarter: '1' },
    { year: '2021', quarter: '4' }, { year: '2021', quarter: '3' },
    { year: '2021', quarter: '2' }, { year: '2021', quarter: '1' },
    { year: '2020', quarter: '4' }, { year: '2020', quarter: '3' },
    { year: '2020', quarter: '2' }, { year: '2020', quarter: '1' },
  ];

  const allData = [];
  let done = 0;
  const total = yearQuarters.length;

  for (const yq of yearQuarters) {
    try {
      done++;
      const pct = Math.round(done / total * 100);
      if (showOverlay) updateMapLoading(`${area.name} ${yq.year}年Q${yq.quarter}`, pct);
      updateStatusText(`${area.name} 詳細取得中... (${done}/${total})`);
      const priceData = await mcpReinfo.callTool('reinfolib-real-estate-price', {
        year: yq.year, quarter: yq.quarter, area: '24', city: area.cityCode
      });
      allData.push(priceData);
    } catch(e) {
      console.warn(`Detail fetch failed for ${area.name} ${yq.year}Q${yq.quarter}:`, e);
    }
  }

  // Merge with existing overview data
  updateAreasWithLiveData([{ cityCode: area.cityCode, quarters: allData }]);

  AREA_FULL_LOADED.add(areaId);
  _currentFetchAreaId = null;

  // オーバーレイ非表示
  if (showOverlay) hideMapLoading();

  const txCount = area._liveTransactions ? area._liveTransactions.length : 0;
  updateStatusText(`${area.name}: 詳細データ取得完了（${txCount}件）`);

  // Update sidebar and pins with fetched data
  if (state.view === 'map') {
    const ranked = getRankedAreas();
    const rankedArea = ranked.find(a => a.id === areaId);
    if (state.mapSelectedAreaId === areaId && rankedArea) {
      updateMapSidebar(rankedArea, ranked);
    }

    // Geocode districts THEN show pins at correct positions
    if (txMarkerLayer) {
      await geocodeAreaDistricts(area, { showOverlay });
      if (state.mapSelectedAreaId === areaId) {
        showTransactionPins(area);
      }
    }
  }

  // Background geocode remaining areas' districts
  geocodeDistrictsBackground().catch(e => console.warn('Geocoding error:', e));
}

// ------------------------------------------------------------
// Auto-fetch: 全エリアのPhase2データを順次取得（優先エリア対応）
// ------------------------------------------------------------
async function fetchAllAreasData() {
  if (_autoFetchRunning) return;
  if (!mcpReinfo || !mcpReinfo.connected) return;

  _autoFetchRunning = true;
  const areaIds = AREAS.map(a => a.id);
  let completedCount = AREA_FULL_LOADED.size;

  while (true) {
    // 次に取得するエリアを決定
    let nextId = null;

    // 1. 優先エリアがあればそれを先に
    if (_fetchPriorityAreaId && !AREA_FULL_LOADED.has(_fetchPriorityAreaId)) {
      nextId = _fetchPriorityAreaId;
      _fetchPriorityAreaId = null;
    }

    // 2. なければ未取得のエリアを順に
    if (!nextId) {
      nextId = areaIds.find(id => !AREA_FULL_LOADED.has(id));
    }

    // 全エリア取得済みなら終了
    if (!nextId) break;

    const remaining = AREAS.length - AREA_FULL_LOADED.size;
    const areaName = AREAS.find(a => a.id === nextId)?.name || nextId;
    updateStatusText(`${areaName} 詳細取得中... （残り${remaining}エリア）`);

    await fetchAreaFullData(nextId);

    completedCount = AREA_FULL_LOADED.size;
  }

  _autoFetchRunning = false;

  // 全完了メッセージ
  let totalTx = 0;
  AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
  state.mcpMessage = `全エリアデータ取得完了（計${totalTx.toLocaleString()}件）`;
  updateStatusText(`全エリアデータ取得完了（計${totalTx.toLocaleString()}件）`);

  // マップ表示中なら全ピン更新
  if (state.view === 'map' && txMarkerLayer && !state.mapSelectedAreaId) {
    const ranked = getRankedAreas();
    showAllTransactionPins(ranked);
  }
}

function extractTransactionsFromMCPResponse(data) {
  let content = data;
  if (content && content.content) content = content.content;
  if (!Array.isArray(content)) {
    // Try alternative structures
    if (content && content.data && Array.isArray(content.data)) {
      console.log('[TX] Direct data array found:', content.data.length, 'records');
      return content.data;
    }
    if (content && typeof content === 'string') {
      try {
        const p = JSON.parse(content);
        if (p.data && Array.isArray(p.data)) {
          console.log('[TX] Parsed string data:', p.data.length, 'records');
          return p.data;
        }
      } catch {}
    }
    console.warn('[TX] Content is not array:', typeof content, content ? Object.keys(content) : 'null');
    return [];
  }
  const textContent = content.find(c => c.type === 'text');
  if (!textContent) {
    console.warn('[TX] No text content found in array of', content.length, 'elements');
    return [];
  }
  try {
    const parsed = JSON.parse(textContent.text);
    if (parsed.data && Array.isArray(parsed.data)) {
      console.log('[TX] Extracted', parsed.data.length, 'records from text content');
      return parsed.data;
    }
    // Try other keys
    for (const key of Object.keys(parsed)) {
      if (Array.isArray(parsed[key]) && parsed[key].length > 0) {
        console.log('[TX] Found array in key', key, ':', parsed[key].length, 'records');
        return parsed[key];
      }
    }
    console.warn('[TX] No data array found. Keys:', Object.keys(parsed));
  } catch(e) {
    console.warn('[TX] JSON parse error:', e.message, 'text:', textContent.text?.substring(0, 200));
  }
  return [];
}

function updateAreasWithLiveData(priceResults) {
  for (const result of priceResults) {
    const area = AREAS.find(a => a.cityCode === result.cityCode);
    if (!area) continue;

    // Merge transactions from all quarters
    const allRecords = [];
    const sources = result.quarters || (result.data ? [result.data] : []);
    console.log(`[DATA] ${area.name}: ${sources.length} sources to process`);
    for (const src of sources) {
      if (!src) continue;
      const records = extractTransactionsFromMCPResponse(src);
      allRecords.push(...records);
    }
    console.log(`[DATA] ${area.name}: ${allRecords.length} total records from all sources`);

    if (allRecords.length === 0) continue;

    // Deduplicate by comprehensive key to avoid removing distinct transactions
    const seen = new Set();
    const uniqueRecords = allRecords.filter(d => {
      const key = [
        d.TradePrice || '',
        d.DistrictName || d.Region || '',
        d.Area || '',
        d.Period || '',
        d.Type || d.TradeType || '',
        d.BuildingYear || '',
        d.NearestStation || '',
        d.FloorPlan || '',
        d.Structure || ''
      ].join('|');
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    console.log(`[DATA] ${area.name}: ${uniqueRecords.length} unique records after dedup (removed ${allRecords.length - uniqueRecords.length})`);
    if (uniqueRecords.length > 0) {
      console.log(`[DATA] ${area.name}: Sample record keys:`, Object.keys(uniqueRecords[0]));
    }

    // Store full transaction records for map display
    area._liveTransactions = uniqueRecords.map(d => ({
      TradePrice: (d.TradePrice != null && d.TradePrice !== '') ? parseInt(d.TradePrice) : null,
      Type: d.Type || d.TradeType || '',
      Area: d.Area ? parseFloat(d.Area) : null,
      FloorPlan: d.FloorPlan || '',
      BuildingYear: d.BuildingYear || '',
      NearestStation: d.NearestStation || '',
      DistanceToStation: d.TimeToNearestStation || d.DistanceToStation || '',
      Use: d.Use || d.Purpose || '',
      District: d.DistrictName || d.Region || '',
      Structure: d.Structure || '',
      CityPlanning: d.CityPlanning || '',
      Period: d.Period || '',
    }));
    console.log(`[DATA] ${area.name}: Final _liveTransactions count = ${area._liveTransactions.length}`);

    // Calculate average trade price from live data
    const prices = uniqueRecords.filter(d => d.TradePrice != null && d.TradePrice !== '').map(d => parseInt(d.TradePrice)).filter(p => !isNaN(p));
    if (prices.length > 0) {
      area._liveAvgTradePrice = Math.round(prices.reduce((a,b) => a+b, 0) / prices.length);
      area._liveTransactionCount = uniqueRecords.length;
    }
  }
}

// ============================================================
// Render Functions
// ============================================================
function render() {
  const app = document.getElementById('app');
  const ranked = getRankedAreas();
  const selected = state.selectedAreaId ? ranked.find(a => a.id === state.selectedAreaId) : ranked[0];

  app.innerHTML = `
    ${renderHeader()}
    <div class="max-w-6xl mx-auto px-4 py-6">
      ${renderWeights()}
      ${state.view === 'ranking' ? renderRanking(ranked) : ''}
      ${state.view === 'compare' ? renderCompare(ranked) : ''}
      ${state.view === 'detail' ? renderDetail(selected, ranked) : ''}
      ${state.view === 'map' ? renderMap(ranked) : ''}
      
      
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-4">
      <h3 class="text-sm font-bold text-blue-700 mb-2">🏠 注文住宅ワンポイント: 高速道路の結節点で車通勤に最適</h3>
      <p class="text-sm text-blue-900 leading-relaxed">亀山市は東名阪自動車道と新名神高速道路が交差する交通の要衝。名古屋方面へも大阪方面へもアクセスが良く、車通勤メインの方には特におすすめ。亀山ICや鈴鹿IC近くの住宅地は坪10〜15万円程度です。</p>
    </div>
  
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-4">
      <h3 class="text-sm font-bold text-blue-700 mb-2">🏠 注文住宅ワンポイント: 旧東海道の歴史ある街並みと新興住宅地の共存</h3>
      <p class="text-sm text-blue-900 leading-relaxed">関宿をはじめとする歴史的な街並みが残る一方、亀山駅周辺では新興住宅地の開発も進んでいます。野村エリアは区画整理された新興住宅地で、坪12〜15万円程度。学校・公園も近く、ファミリー向けの注文住宅に適しています。</p>
    </div>
  
      
    <div class="card p-6 mb-6" id="cost-simulator">
      <h2 class="text-lg font-bold text-gray-800 mb-1">💰 注文住宅 費用シミュレーター</h2>
      <p class="text-xs text-gray-500 mb-4">スライダーを動かすと即時に再計算されます。土地価格は国土交通省の実取引データに基づく坪単価を使用しています。</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
        <input type="hidden" id="cs-area" value="kameyama">
        <div>
          <label class="text-sm font-medium text-gray-700">土地面積: <span id="cs-land-val">50</span>坪</label>
          <input type="range" id="cs-land" min="30" max="100" value="50" step="5" class="w-full cursor-pointer mt-1" oninput="csCalc()" style="background:linear-gradient(to right,#3b82f6 0%,#3b82f6 29%,#e5e7eb 29%,#e5e7eb 100%)">
          <div class="flex justify-between text-xs text-gray-400"><span>30坪</span><span>100坪</span></div>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">建物延床面積: <span id="cs-building-val">35</span>坪</label>
          <input type="range" id="cs-building" min="20" max="60" value="35" step="1" class="w-full cursor-pointer mt-1" oninput="csCalc()" style="background:linear-gradient(to right,#3b82f6 0%,#3b82f6 38%,#e5e7eb 38%,#e5e7eb 100%)">
          <div class="flex justify-between text-xs text-gray-400"><span>20坪</span><span>60坪</span></div>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">建築グレード</label>
          <div class="flex gap-2 mt-1">
            <label class="flex-1 text-center px-2 py-2 border rounded-lg cursor-pointer text-xs transition-all" id="cs-grade-low-label">
              <input type="radio" name="cs-grade" value="50" class="hidden" onchange="csCalc()"> ローコスト<br><span class="font-bold">50万/坪</span>
            </label>
            <label class="flex-1 text-center px-2 py-2 border rounded-lg cursor-pointer text-xs transition-all border-blue-500 bg-blue-50" id="cs-grade-std-label">
              <input type="radio" name="cs-grade" value="65" class="hidden" checked onchange="csCalc()"> スタンダード<br><span class="font-bold">65万/坪</span>
            </label>
            <label class="flex-1 text-center px-2 py-2 border rounded-lg cursor-pointer text-xs transition-all" id="cs-grade-hi-label">
              <input type="radio" name="cs-grade" value="85" class="hidden" onchange="csCalc()"> ハイグレード<br><span class="font-bold">85万/坪</span>
            </label>
          </div>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">頭金: <span id="cs-down-val">300</span>万円</label>
          <input type="range" id="cs-down" min="0" max="2000" value="300" step="50" class="w-full cursor-pointer mt-1" oninput="csCalc()" style="background:linear-gradient(to right,#10b981 0%,#10b981 15%,#e5e7eb 15%,#e5e7eb 100%)">
          <div class="flex justify-between text-xs text-gray-400"><span>0万</span><span>2,000万</span></div>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">金利: <span id="cs-rate-val">0.80</span>%</label>
          <input type="range" id="cs-rate" min="0.3" max="3.0" value="0.8" step="0.05" class="w-full cursor-pointer mt-1" oninput="csCalc()">
          <div class="flex justify-between text-xs text-gray-400"><span>0.3%</span><span>3.0%</span></div>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">ローン期間: <span id="cs-years-val">35</span>年</label>
          <input type="range" id="cs-years" min="20" max="40" value="35" step="1" class="w-full cursor-pointer mt-1" oninput="csCalc()">
          <div class="flex justify-between text-xs text-gray-400"><span>20年</span><span>40年</span></div>
        </div>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3" id="cs-results">
        <div class="bg-blue-50 rounded-lg p-3 text-center">
          <div class="text-xs text-gray-500">土地購入費</div>
          <div class="text-lg font-bold text-blue-700" id="cs-land-cost">-</div>
        </div>
        <div class="bg-green-50 rounded-lg p-3 text-center">
          <div class="text-xs text-gray-500">建築費</div>
          <div class="text-lg font-bold text-green-700" id="cs-build-cost">-</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-3 text-center">
          <div class="text-xs text-gray-500">諸費用</div>
          <div class="text-lg font-bold text-amber-700" id="cs-misc-cost">-</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-3 text-center">
          <div class="text-xs text-gray-500 font-medium">総額</div>
          <div class="text-xl font-bold text-gray-900" id="cs-total">-</div>
        </div>
      </div>
      <div class="bg-gray-50 rounded-lg p-3 text-center">
        <span class="text-xs text-gray-500">月々返済額（元利均等）</span>
        <span class="text-lg font-bold text-blue-600 ml-2" id="cs-monthly">-</span>
      </div>
    </div>
      
    <div class="card p-6 mb-6" id="land-checklist">
      <h2 class="text-lg font-bold text-gray-800 mb-1">✅ 土地購入前チェックリスト</h2>
      <p class="text-xs text-gray-500 mb-2">チェック状態はブラウザに自動保存されます</p>
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-3 text-sm text-amber-800">💡 亀山市はJRの本数が限られるため、車中心の生活を前提にした土地選びがおすすめです。</div>
      <div class="text-sm font-medium text-blue-600 mb-3" id="cl-progress">0/10 完了</div>
      <div class="space-y-2" id="cl-items">
        
          <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-cl-id="1">
            <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 cursor-pointer" data-cl-check="1" onchange="clUpdate('kameyama')">
            <div>
              <div class="text-sm font-medium text-gray-800">用途地域を確認した</div>
              <div class="text-xs text-gray-500 mt-0.5">第一種低層住居専用地域は注文住宅に最も適した用途地域の一つ。建ぺい率・容積率が厳しい分、閑静な住環境が保証されます。</div>
            </div>
          </label>
        
          <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-cl-id="2">
            <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 cursor-pointer" data-cl-check="2" onchange="clUpdate('kameyama')">
            <div>
              <div class="text-sm font-medium text-gray-800">前面道路の幅員を確認した</div>
              <div class="text-xs text-gray-500 mt-0.5">建築基準法上、幅員4m以上の道路に2m以上接している必要があります（接道義務）。4m未満の場合はセットバック（後退）が必要です。</div>
            </div>
          </label>
        
          <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-cl-id="3">
            <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 cursor-pointer" data-cl-check="3" onchange="clUpdate('kameyama')">
            <div>
              <div class="text-sm font-medium text-gray-800">ハザードマップを確認した</div>
              <div class="text-xs text-gray-500 mt-0.5">洪水・土砂災害・津波の各ハザードマップを確認。三重県は河川が多く、沿岸部は津波リスクもあるため、必ず事前チェックを。</div>
            </div>
          </label>
        
          <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-cl-id="4">
            <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 cursor-pointer" data-cl-check="4" onchange="clUpdate('kameyama')">
            <div>
              <div class="text-sm font-medium text-gray-800">上下水道の状況を確認した</div>
              <div class="text-xs text-gray-500 mt-0.5">上水道・下水道が前面道路まで来ているか確認。未整備の場合は引き込み工事費（50〜150万円）が別途必要になります。</div>
            </div>
          </label>
        
          <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-cl-id="5">
            <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 cursor-pointer" data-cl-check="5" onchange="clUpdate('kameyama')">
            <div>
              <div class="text-sm font-medium text-gray-800">地盤の状態を確認した</div>
              <div class="text-xs text-gray-500 mt-0.5">地盤改良工事が必要な場合、表層改良で30〜50万円、柱状改良で50〜100万円、鋼管杭で100〜200万円程度の追加費用がかかります。</div>
            </div>
          </label>
        
          <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-cl-id="6">
            <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 cursor-pointer" data-cl-check="6" onchange="clUpdate('kameyama')">
            <div>
              <div class="text-sm font-medium text-gray-800">接道義務を確認した</div>
              <div class="text-xs text-gray-500 mt-0.5">建築基準法第43条により、建築物の敷地は幅員4m以上の道路に2m以上接していなければなりません。私道の場合は権利関係も要確認。</div>
            </div>
          </label>
        
          <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-cl-id="7">
            <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 cursor-pointer" data-cl-check="7" onchange="clUpdate('kameyama')">
            <div>
              <div class="text-sm font-medium text-gray-800">建築条件の有無を確認した</div>
              <div class="text-xs text-gray-500 mt-0.5">「建築条件付き」の土地は指定の建築会社で建てる必要があります。注文住宅で好きな会社を選びたい場合は「条件なし」を選びましょう。</div>
            </div>
          </label>
        
          <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-cl-id="8">
            <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 cursor-pointer" data-cl-check="8" onchange="clUpdate('kameyama')">
            <div>
              <div class="text-sm font-medium text-gray-800">周辺の開発計画を確認した</div>
              <div class="text-xs text-gray-500 mt-0.5">近隣に大規模商業施設や道路の建設計画があると、将来の利便性・地価に影響します。市町の都市計画課で確認できます。</div>
            </div>
          </label>
        
          <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-cl-id="9">
            <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 cursor-pointer" data-cl-check="9" onchange="clUpdate('kameyama')">
            <div>
              <div class="text-sm font-medium text-gray-800">現地を複数回訪問した</div>
              <div class="text-xs text-gray-500 mt-0.5">平日・休日、朝・昼・夜と時間帯を変えて現地を訪問。騒音・交通量・日当たり・近隣の様子を自分の目で確認しましょう。</div>
            </div>
          </label>
        
          <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-cl-id="10">
            <input type="checkbox" class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 cursor-pointer" data-cl-check="10" onchange="clUpdate('kameyama')">
            <div>
              <div class="text-sm font-medium text-gray-800">複数の建築会社から見積もりを取った</div>
              <div class="text-xs text-gray-500 mt-0.5">最低3社から見積もりを取り、価格だけでなく標準仕様・保証内容・アフターサービスを比較。相見積もりで適正価格を把握できます。</div>
            </div>
          </label>
        
      </div>
    </div>
      
    <div class="card p-6 mb-6" id="faq-section">
      <h2 class="text-lg font-bold text-gray-800 mb-4">❓ よくある質問（亀山市の注文住宅）</h2>
      <div class="space-y-2">
    <div class="border border-gray-200 rounded-lg overflow-hidden">
      <button class="w-full text-left px-4 py-3 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition-colors" onclick="this.parentElement.classList.toggle('faq-open')">
        <span class="text-sm font-medium text-gray-800">亀山市で注文住宅用の土地相場はいくらですか？</span>
        <svg class="w-5 h-5 text-gray-400 faq-chevron transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </button>
      <div class="faq-answer px-4 py-3 text-sm text-gray-600 leading-relaxed border-t border-gray-100">亀山市の住宅地平均地価は約27,000円/m²（坪単価約9.8万円）です。亀山駅周辺で坪12〜18万円、郊外の関エリアでは坪6〜10万円が目安。60坪の土地が400〜1,000万円程度で見つかります。</div>
    </div>
  
    <div class="border border-gray-200 rounded-lg overflow-hidden">
      <button class="w-full text-left px-4 py-3 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition-colors" onclick="this.parentElement.classList.toggle('faq-open')">
        <span class="text-sm font-medium text-gray-800">亀山市から名古屋への通勤時間はどのくらいですか？</span>
        <svg class="w-5 h-5 text-gray-400 faq-chevron transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </button>
      <div class="faq-answer px-4 py-3 text-sm text-gray-600 leading-relaxed border-t border-gray-100">JR亀山駅から名古屋駅まで快速みえで約60分。車では東名阪自動車道で約50分〜1時間です。名古屋通勤は可能ですが、週数回のテレワーク併用が理想的です。</div>
    </div>
  
    <div class="border border-gray-200 rounded-lg overflow-hidden">
      <button class="w-full text-left px-4 py-3 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition-colors" onclick="this.parentElement.classList.toggle('faq-open')">
        <span class="text-sm font-medium text-gray-800">亀山市で注文住宅を建てる総費用の目安は？</span>
        <svg class="w-5 h-5 text-gray-400 faq-chevron transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </button>
      <div class="faq-answer px-4 py-3 text-sm text-gray-600 leading-relaxed border-t border-gray-100">土地60坪＋建物35坪のスタンダードプランの場合、土地代400〜800万円＋建築費2,275万円＋諸費用250〜350万円で、総額2,900〜3,400万円程度が目安です。</div>
    </div>
  
    <div class="border border-gray-200 rounded-lg overflow-hidden">
      <button class="w-full text-left px-4 py-3 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition-colors" onclick="this.parentElement.classList.toggle('faq-open')">
        <span class="text-sm font-medium text-gray-800">亀山市の製造業雇用は安定していますか？</span>
        <svg class="w-5 h-5 text-gray-400 faq-chevron transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </button>
      <div class="faq-answer px-4 py-3 text-sm text-gray-600 leading-relaxed border-t border-gray-100">亀山市にはSharp亀山工場をはじめ、多数の製造業が集積しています。液晶パネル工場の規模は縮小しましたが、代替産業の誘致も進んでおり、雇用基盤は維持されています。</div>
    </div>
  </div>
    </div>
      
    <div class="card p-6 mb-6">
      <h2 class="text-base font-bold text-gray-800 mb-3">🔗 近隣エリアの注文住宅情報</h2>
      <div class="flex flex-wrap gap-2"><a href="/area/mie/suzuka/" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 hover:border-blue-300 transition-colors">鈴鹿市の注文住宅情報 →</a></div>
    </div>
      
    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 mb-6 text-center">
      <h3 class="text-base font-bold text-gray-800 mb-2">具体的な物件が見つかったら...</h3>
      <p class="text-sm text-gray-600 mb-4">AIが複数物件を自動比較。SUUMO・ホームズ等のURLを貼るだけで、見やすい比較表を作成します。</p>
      <a href="/" class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
        🏠 物件比較ツールを使う →
      </a>
    </div>
      
    <div class="card p-4 mb-6">
      <div class="flex items-center justify-center gap-3 flex-wrap">
        <span class="text-xs text-gray-500">このページをシェア:</span>
        <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fresearch.chuumon-soudan.com%2Farea%2Fmie%2Fkameyama%2F&text=%E4%BA%80%E5%B1%B1%E5%B8%82%E3%81%A7%E6%B3%A8%E6%96%87%E4%BD%8F%E5%AE%85%EF%BD%9C%E5%9C%9F%E5%9C%B0%E7%9B%B8%E5%A0%B4%E3%83%BB%E8%B2%BB%E7%94%A8%E3%82%B7%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:4px;padding:6px 14px;background:#000;color:white;border-radius:6px;font-size:12px;font-weight:500;text-decoration:none;">𝕏 ポスト</a>
        <a href="https://social-plugins.line.me/lineit/share?url=https%3A%2F%2Fresearch.chuumon-soudan.com%2Farea%2Fmie%2Fkameyama%2F" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:4px;padding:6px 14px;background:#06c755;color:white;border-radius:6px;font-size:12px;font-weight:500;text-decoration:none;">LINE 送る</a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fresearch.chuumon-soudan.com%2Farea%2Fmie%2Fkameyama%2F" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:4px;padding:6px 14px;background:#1877f2;color:white;border-radius:6px;font-size:12px;font-weight:500;text-decoration:none;">Facebook</a>
      </div>
    </div>
      ${renderFooter()}
    </div>
  `;

  // Re-bindイベント
  bindEvents(ranked);

  // チャート描画・マップ初期化（DOMが存在してから）
  requestAnimationFrame(() => {
    if (state.view === 'compare') drawCompareCharts(ranked);
    if (state.view === 'detail' && selected) drawDetailCharts(selected);
    if (state.view === 'map') {
      // モバイルではDOMレイアウト確定に時間がかかる場合がある
      setTimeout(() => {
        initializeMap(ranked);
        if (state.mapSelectedAreaId) {
          const selArea = ranked.find(a => a.id === state.mapSelectedAreaId);
          if (selArea) updateMapSidebar(selArea, ranked);
        }
      }, 50);
    }
  });
}

function renderHeader() {
  const tabs = [
    { id: 'ranking', label: '🏆 ランキング' },
    { id: 'compare', label: '📊 比較' },
    { id: 'detail', label: '🔍 詳細' },
    { id: 'map', label: '🗺️ 地図' }
  ];
  const currentTab = tabs.find(t => t.id === state.view) || tabs[0];
  return `
    <nav class="flex items-center gap-1 flex-wrap px-4 py-2 text-xs text-gray-400" aria-label="パンくずリスト"><a href="/" class="text-sm text-blue-600 hover:underline">トップ</a> <span class="mx-1">/</span> <a href="/area/mie/" class="text-sm text-blue-600 hover:underline">三重県エリア比較</a> <span class="mx-1">/</span> <span class="text-sm text-gray-600">亀山市</span></nav>
    <!-- タイトル（スクロールで消える） -->
    <header class="glass border-b border-gray-200">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 mobile-title-text">🏠 亀山市で注文住宅を建てる</h1>
            <p class="text-sm text-gray-500 mt-1 mobile-subtitle-text">土地相場・費用シミュレーション・取引データで亀山市の注文住宅をサポート</p>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">
          <span style="font-size:11px;color:#6b7280;background:#f3f4f6;padding:2px 8px;border-radius:4px;">📊 データ出典: <a href="https://www.reinfolib.mlit.go.jp/" style="color:#3b82f6;text-decoration:none;" rel="noopener">国土交通省 不動産情報ライブラリ</a></span>
          <span style="font-size:11px;color:#6b7280;background:#f3f4f6;padding:2px 8px;border-radius:4px;">✏️ 監修: <a href="/about/" style="color:#3b82f6;text-decoration:none;" rel="noopener">注文相談.com</a> 編集部</span>
          <span style="font-size:11px;color:#6b7280;background:#f3f4f6;padding:2px 8px;border-radius:4px;">🕐 最終更新: 2026-02-19</span>
        </div>
            <a href="/area/mie/" style="display:inline-block;margin-top:6px;font-size:13px;color:#3b82f6;font-weight:500;text-decoration:none;">← 三重県エリア比較に戻る</a>
            ${state.mcpStatus === 'connected' ? (() => {
              let totalTx = 0;
              AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
              const dateStr = state.fetchedAt ? new Date(state.fetchedAt).toLocaleDateString('ja-JP') : '';
              return `<p class="text-xs text-green-600 mt-1">📊 取引データ ${totalTx.toLocaleString()}件${dateStr ? `（${dateStr} 更新）` : ''}</p>`;
            })() : state.mcpStatus === 'connecting' ? `<p class="text-xs text-blue-500 mt-1">⏳ データ読み込み中...</p>` : ''}
          </div>
        </div>
      </div>
    </header>
    <!-- タブバー（PCのみ表示） -->
    <nav id="pc-nav-bar" class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-gray-200 shadow-sm">
      <div class="max-w-6xl mx-auto px-4 py-2">
        <div class="flex gap-2">
          ${tabs.map(t => `
            <button data-tab="${t.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-all ${state.view === t.id ? 'tab-active' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
              ${t.label}
            </button>
          `).join('')}
        </div>
      </div>
    </nav>
    <!-- モバイル: 右上固定ハンバーガーボタン -->
    <button id="mobile-menu-fab" onclick="openMobileDrawer()" style="display:none;position:fixed;top:12px;right:12px;z-index:60;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.92);backdrop-filter:blur(8px);box-shadow:0 2px 8px rgba(0,0,0,0.15);border:1px solid #e5e7eb;font-size:18px;color:#374151;cursor:pointer;" aria-label="メニューを開く">
      ☰
    </button>
    <!-- モバイル: 右サイドドロワー -->
    <div id="mobile-drawer-overlay" style="display:none;position:fixed;inset:0;z-index:70;background:rgba(0,0,0,0.4);opacity:0;transition:opacity 0.3s;" onclick="closeMobileDrawer()"></div>
    <div id="mobile-drawer-panel" style="display:none;position:fixed;top:0;right:0;z-index:80;height:100%;width:260px;background:#fff;box-shadow:-4px 0 20px rgba(0,0,0,0.15);transform:translateX(100%);transition:transform 0.3s ease-out;">
      <div style="padding:16px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:14px;font-weight:700;color:#1f2937;">メニュー</span>
        <button onclick="closeMobileDrawer()" style="width:32px;height:32px;border-radius:50%;background:#f3f4f6;border:none;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:20px;cursor:pointer;">&times;</button>
      </div>
      <div style="padding:16px;display:flex;flex-direction:column;gap:8px;">
        ${tabs.map(t => `
          <button data-tab="${t.id}" onclick="closeMobileDrawer()" class="${state.view === t.id ? 'tab-active' : ''}" style="width:100%;text-align:left;padding:12px 16px;border-radius:8px;font-size:14px;font-weight:500;border:none;cursor:pointer;transition:background 0.2s;${state.view === t.id ? '' : 'background:#f9fafb;color:#4b5563;'}">
            ${t.label}
          </button>
        `).join('')}
      <div style="border-top:1px solid #e5e7eb;padding-top:8px;margin-top:8px;">
          <div style="font-size:11px;color:#9ca3af;padding:0 16px 4px;">エリア別ガイド</div>
          <a href="/area/mie/yokkaichi/" style="width:100%;text-align:left;padding:8px 16px;border-radius:8px;font-size:13px;background:#f0f9ff;color:#1e40af;border:none;text-decoration:none;display:block;">四日市市</a>
          <a href="/area/mie/kuwana/" style="width:100%;text-align:left;padding:8px 16px;border-radius:8px;font-size:13px;background:#f0f9ff;color:#1e40af;border:none;text-decoration:none;display:block;">桑名市</a>
          <a href="/area/mie/suzuka/" style="width:100%;text-align:left;padding:8px 16px;border-radius:8px;font-size:13px;background:#f0f9ff;color:#1e40af;border:none;text-decoration:none;display:block;">鈴鹿市</a>
          <a href="/area/mie/inabe/" style="width:100%;text-align:left;padding:8px 16px;border-radius:8px;font-size:13px;background:#f0f9ff;color:#1e40af;border:none;text-decoration:none;display:block;">いなべ市</a>
          <a href="/area/mie/kameyama/" style="width:100%;text-align:left;padding:8px 16px;border-radius:8px;font-size:13px;background:#dbeafe;color:#1e40af;font-weight:600;border:none;text-decoration:none;display:block;">亀山市</a>
          <a href="/area/mie/komono/" style="width:100%;text-align:left;padding:8px 16px;border-radius:8px;font-size:13px;background:#f0f9ff;color:#1e40af;border:none;text-decoration:none;display:block;">菰野町</a>
          <a href="/area/mie/toin/" style="width:100%;text-align:left;padding:8px 16px;border-radius:8px;font-size:13px;background:#f0f9ff;color:#1e40af;border:none;text-decoration:none;display:block;">東員町</a>
          <a href="/area/mie/" style="width:100%;text-align:left;padding:8px 16px;border-radius:8px;font-size:13px;background:#f9fafb;color:#6b7280;border:none;text-decoration:none;display:block;margin-top:4px;">← エリア比較に戻る</a>
        </div>
      </div>
    </div>
  `;
}

function openMobileDrawer() {
  const overlay = document.getElementById('mobile-drawer-overlay');
  const panel = document.getElementById('mobile-drawer-panel');
  if (!overlay || !panel) return;
  overlay.style.opacity = '1';
  overlay.style.pointerEvents = 'auto';
  panel.style.transform = 'translateX(0)';
  document.body.style.overflow = 'hidden';
}
function closeMobileDrawer() {
  const overlay = document.getElementById('mobile-drawer-overlay');
  const panel = document.getElementById('mobile-drawer-panel');
  if (!overlay || !panel) return;
  overlay.style.opacity = '0';
  overlay.style.pointerEvents = 'none';
  panel.style.transform = 'translateX(100%)';
  document.body.style.overflow = '';
}

function renderMCPStatus() {
  const statusColors = {
    disconnected: { bg: 'bg-gray-100', text: 'text-gray-600', dot: 'bg-gray-400' },
    connecting: { bg: 'bg-blue-50', text: 'text-blue-700', dot: 'bg-blue-500' },
    connected: { bg: 'bg-green-50', text: 'text-green-700', dot: 'bg-green-500' },
    error: { bg: 'bg-amber-50', text: 'text-amber-700', dot: 'bg-amber-500' }
  };
  const s = statusColors[state.mcpStatus];
  const statusLabel = { disconnected: '未接続', connecting: '取得中', connected: 'データ取得済', error: 'フォールバック' }[state.mcpStatus];

  return `
    <div class="card p-4 mb-4 flex items-center justify-between flex-wrap gap-3">
      <div class="flex items-center gap-3">
        <div class="status-badge ${s.bg} ${s.text}">
          <span class="pulse-dot ${s.dot}"></span>
          ${statusLabel}
        </div>
        <span id="mcp-status-text" class="text-sm text-gray-500">${state.mcpMessage || 'データ読み込み中...'}</span>
      </div>
      <div class="flex gap-2">
        ${state.mcpStatus === 'connected' ? `
          <button id="btn-connect-mcp" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
            🔄 最新データ取得
          </button>
        ` : state.mcpStatus === 'connecting' ? `
          <span class="text-xs text-blue-600 self-center">取得中...</span>
        ` : `
          <button id="btn-connect-mcp" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
            🔌 MCPサーバーに接続
          </button>
        `}
      </div>
    </div>
  `;
}

function renderWeights() {
  const items = [
    { key: 'price', label: '価格の手頃さ', icon: '💰' },
    { key: 'access', label: '名古屋アクセス', icon: '🚃' },
    { key: 'growth', label: '資産価値上昇', icon: '📈' },
    { key: 'living', label: '生活利便性', icon: '🏪' },
    { key: 'family', label: '子育て環境', icon: '👨‍👩‍👧‍👦' },
    { key: 'nature', label: '自然環境', icon: '🌿' }
  ];
  return `
    <div class="card p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">🎯 あなたの優先度を設定</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        ${items.map(i => `
          <div class="flex items-center gap-3">
            <span class="text-xl w-8 text-center">${i.icon}</span>
            <div class="flex-1">
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">${i.label}</span>
                <span class="text-sm font-bold text-blue-600" id="wv-${i.key}">${state.weights[i.key]}</span>
              </div>
              <input type="range" min="0" max="50" value="${state.weights[i.key]}" data-weight="${i.key}"
                class="w-full cursor-pointer" style="background: linear-gradient(to right, #3b82f6 0%, #3b82f6 ${state.weights[i.key]*2}%, #e5e7eb ${state.weights[i.key]*2}%, #e5e7eb 100%);">
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderRanking(ranked) {
  const medals = ['medal-gold','medal-silver','medal-bronze'];
  const scoreKeys = [
    { key: 'price', label: '価格' },
    { key: 'access', label: '交通' },
    { key: 'growth', label: '成長' },
    { key: 'living', label: '利便' },
    { key: 'family', label: '子育' },
    { key: 'nature', label: '自然' }
  ];

  return `
    <div class="space-y-4 fade-in">
      <h2 class="text-lg font-bold text-gray-800">🏆 おすすめエリアランキング</h2>
      ${ranked.map((a, idx) => `
        <div class="card p-5 cursor-pointer" data-area-detail="${a.id}">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 flex flex-col items-center w-16">
              <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg ${idx < 3 ? medals[idx] : 'bg-slate-400'}">
                ${idx + 1}
              </div>
              <div class="text-2xl font-bold text-blue-600 mt-1">${a.scores.total}<span class="text-xs text-gray-400 font-normal">pt</span></div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="text-xl font-bold text-gray-900">${a.name}</h3>
                ${a.popGrowthRate > 0 ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">人口増加中</span>' : ''}
                ${a._liveTransactionCount ? `<span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">LIVE ${a._liveTransactionCount}件</span>` : ''}
              </div>
              <p class="text-sm text-gray-600 mb-3">${a.description}</p>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                  <div class="text-xs text-gray-500">住宅地価格</div>
                  <div class="text-sm font-bold text-blue-700">${(a.residentialPrice/10000).toFixed(1)}万/m²</div>
                </div>
                <div class="text-center p-2 bg-green-50 rounded-lg">
                  <div class="text-xs text-gray-500">名古屋まで</div>
                  <div class="text-sm font-bold text-green-700">${a.accessToNagoya}分</div>
                </div>
                <div class="text-center p-2 bg-amber-50 rounded-lg">
                  <div class="text-xs text-gray-500">地価変動</div>
                  <div class="text-sm font-bold text-amber-700">+${a.yoyChange}%</div>
                </div>
                <div class="text-center p-2 bg-purple-50 rounded-lg">
                  <div class="text-xs text-gray-500">人口</div>
                  <div class="text-sm font-bold text-purple-700">${(a.population/10000).toFixed(1)}万人</div>
                </div>
              </div>
            </div>
            <div class="flex-shrink-0 w-28 space-y-1 hidden sm:block">
              ${scoreKeys.map(s => `
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-400 w-8 text-right">${s.label}</span>
                  <div class="score-bar flex-1"><div class="score-bar-fill bg-blue-500" style="width:${a.scores[s.key]}%"></div></div>
                  <span class="text-xs text-gray-500 w-5 text-right">${a.scores[s.key]}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderCompare(ranked) {
  return `
    <div class="space-y-6 fade-in">
      <h2 class="text-lg font-bold text-gray-800">📊 エリア比較</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">住宅地価格 × 総合スコア</h3>
          <canvas id="chart-bar" height="260"></canvas>
        </div>
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">地価推移（2020-2025年）</h3>
          <canvas id="chart-trend" height="260"></canvas>
        </div>
      </div>
      <div class="card p-6 overflow-x-auto">
        <h3 class="text-base font-bold text-gray-700 mb-4">全エリア比較一覧</h3>
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-left py-2 px-3 font-medium text-gray-600">エリア</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">住宅地(円/m²)</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">坪単価</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">変動率</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">名古屋</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">人口</th>
              <th class="text-right py-2 px-3 font-medium text-gray-600">スコア</th>
            </tr>
          </thead>
          <tbody>
            ${ranked.map((a,i) => `
              <tr class="border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors" data-area-detail="${a.id}">
                <td class="py-3 px-3 font-medium text-gray-900">
                  <span class="inline-flex items-center gap-2">
                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold" style="background:${i<3?'#3b82f6':'#94a3b8'}">${i+1}</span>
                    ${a.name}
                  </span>
                </td>
                <td class="py-3 px-3 text-right">${a.residentialPrice.toLocaleString()}</td>
                <td class="py-3 px-3 text-right">${a.pricePerTsubo.toLocaleString()}</td>
                <td class="py-3 px-3 text-right text-green-600 font-medium">+${a.yoyChange}%</td>
                <td class="py-3 px-3 text-right">${a.accessToNagoya}分</td>
                <td class="py-3 px-3 text-right">${(a.population/10000).toFixed(1)}万</td>
                <td class="py-3 px-3 text-right">
                  <span class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-bold text-xs">${a.scores.total}pt</span>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderDetail(area, ranked) {
  if (!area) return '<p>エリアを選択してください</p>';
  const scoreItems = [
    { key: 'price', label: '価格の手頃さ', color: '#3b82f6' },
    { key: 'access', label: '名古屋アクセス', color: '#10b981' },
    { key: 'growth', label: '資産価値上昇', color: '#f59e0b' },
    { key: 'living', label: '生活利便性', color: '#ef4444' },
    { key: 'family', label: '子育て環境', color: '#8b5cf6' },
    { key: 'nature', label: '自然環境', color: '#06b6d4' }
  ];

  return `
    <div class="space-y-6 fade-in">
      <div class="flex items-center gap-3 flex-wrap">
        <button id="btn-back" class="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors">← 戻る</button>
        <h2 class="text-lg font-bold text-gray-800">🔍 ${area.name} の詳細分析</h2>
        <button id="btn-to-map" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-50 transition-colors ml-auto">🗺️ マップで表示</button>
      </div>

      <div class="flex flex-wrap gap-2">
        ${ranked.map(a => `
          <button data-area-switch="${a.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-all ${area.id===a.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}">
            ${a.name}
          </button>
        `).join('')}
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- レーダーチャート -->
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">総合評価</h3>
          <canvas id="chart-radar" height="280"></canvas>
          <div class="text-center mt-4">
            <span class="text-4xl font-bold text-blue-600">${area.scores.total}</span>
            <span class="text-sm text-gray-400 ml-1">/ 100点</span>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-4">
            ${scoreItems.map(s => `
              <div class="text-center">
                <div class="text-xs text-gray-500">${s.label}</div>
                <div class="text-lg font-bold" style="color:${s.color}">${area.scores[s.key]}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- 基本情報 -->
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">基本データ</h3>
          <div class="space-y-3">
            ${[
              ['🏠 住宅地平均', `${area.residentialPrice.toLocaleString()}円/m²`],
              ['💴 坪単価', `${area.pricePerTsubo.toLocaleString()}円/坪`],
              ['📈 前年比変動', `+${area.yoyChange}%`],
              ['👥 人口', `${area.population.toLocaleString()}人`],
              ['🚃 名古屋まで', `約${area.accessToNagoya}分`],
              ['🏥 医療施設', `${area.hospitals}施設`],
              ['🏫 教育施設', `${area.schools}施設`],
              ['🛍 商業施設', `${area.shopping}施設`],
            ].map(([l,v]) => `
              <div class="flex justify-between items-center py-2 border-b border-gray-50">
                <span class="text-sm text-gray-600">${l}</span>
                <span class="text-sm font-bold text-gray-900">${v}</span>
              </div>
            `).join('')}
            ${area._liveAvgTradePrice ? `
              <div class="flex justify-between items-center py-2 border-b border-blue-100 bg-blue-50 rounded px-2 mt-2">
                <span class="text-sm text-blue-600 font-medium">🔴 LIVE 平均取引価格</span>
                <span class="text-sm font-bold text-blue-700">${area._liveAvgTradePrice.toLocaleString()}円</span>
              </div>
            ` : ''}
          </div>
        </div>
      </div>

      <!-- 地価推移 -->
      <div class="card p-6">
        <h3 class="text-base font-bold text-gray-700 mb-4">地価推移</h3>
        <canvas id="chart-detail-trend" height="200"></canvas>
      </div>

      <!-- 概要・ポイント・注意点 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-5">
          <h3 class="text-base font-bold text-gray-700 mb-3">📝 概要</h3>
          <p class="text-sm text-gray-600 leading-relaxed">${area.description}</p>
        </div>
        <div class="rounded-xl p-5 bg-green-50 border border-green-200">
          <h3 class="text-base font-bold text-green-700 mb-3">✅ ポイント</h3>
          <ul class="space-y-2">
            ${area.highlights.map(h => `<li class="text-sm text-green-800 flex items-start gap-2"><span class="mt-0.5">•</span>${h}</li>`).join('')}
          </ul>
        </div>
        <div class="rounded-xl p-5 bg-amber-50 border border-amber-200">
          <h3 class="text-base font-bold text-amber-700 mb-3">⚠️ 注意点</h3>
          <ul class="space-y-2">
            ${area.risks.map(r => `<li class="text-sm text-amber-800 flex items-start gap-2"><span class="mt-0.5">•</span>${r}</li>`).join('')}
          </ul>
        </div>
      </div>

      <!-- おすすめエリア -->
      <div class="rounded-xl p-6 bg-blue-50 border border-blue-200">
        <h3 class="text-base font-bold text-blue-700 mb-3">🎯 ${area.name}のおすすめ物件エリア</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          ${area.recAreas.map((r,i) => `
            <div class="bg-white rounded-lg p-4 border border-blue-100">
              <div class="text-xs text-blue-500 font-medium mb-1">おすすめ ${i+1}</div>
              <div class="text-sm font-medium text-gray-800">${r}</div>
            </div>
          `).join('')}
        </div>
      </div>

    </div>
  `;
}

// ============================================================
// Map View
// ============================================================
function renderMap(ranked) {
  const selArea = state.mapSelectedAreaId ? ranked.find(a => a.id === state.mapSelectedAreaId) : null;
  return `
    <div class="space-y-4 fade-in">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-800">🗺️ エリアマップ</h2>
        <div class="flex gap-2">
          <button id="btn-district-area-toggle" class="school-toggle ${showDistrictAreas ? 'active' : ''}" onclick="toggleDistrictAreas()">
            <span>${showDistrictAreas ? '📊 エリア ON' : '📊 エリア'}</span>
          </button>
          <button id="btn-school-toggle" class="school-toggle ${showSchoolDistricts ? 'active' : ''}" onclick="toggleSchoolDistricts()">
            <span>${showSchoolDistricts ? '🏫 学区 ON' : '🏫 学区'}</span>
          </button>
          <button id="btn-fullscreen-toggle" class="map-fullscreen-btn" onclick="toggleMapFullscreen()">
            <span id="fullscreen-icon">⛶</span> <span id="fullscreen-label">拡大</span>
          </button>
        </div>
      </div>
      <!-- Fullscreen floating controls -->
      <div id="map-fullscreen-controls" class="map-fullscreen-controls">
        <span style="font-weight:600;font-size:13px;color:#1e40af;">🗺️ エリアマップ</span>
        <button class="school-toggle ${showDistrictAreas ? 'active' : ''}" onclick="toggleDistrictAreas()">
          <span>${showDistrictAreas ? '📊 エリア ON' : '📊 エリア'}</span>
        </button>
        <button class="school-toggle ${showSchoolDistricts ? 'active' : ''}" onclick="toggleSchoolDistricts()">
          <span>${showSchoolDistricts ? '🏫 学区 ON' : '🏫 学区'}</span>
        </button>
        <button class="map-fullscreen-btn active" onclick="toggleMapFullscreen()">
          <span>✕</span> <span>閉じる</span>
        </button>
      </div>
      <div class="card overflow-hidden">
        <div class="map-layout" style="position:relative;">
          <div id="map-container"></div>
          <div id="map-loading-overlay" class="map-loading-overlay hidden">
            <div class="map-loading-box">
              <div class="map-loading-spinner"></div>
              <div id="map-loading-text" style="font-size:13px;font-weight:600;color:#1e40af;">データ取得中...</div>
              <div class="map-loading-progress"><div id="map-loading-bar" class="map-loading-progress-bar" style="width:0%"></div></div>
            </div>
          </div>
          <div id="map-sidebar">
            ${selArea ? '' : `
              <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="text-4xl mb-3">📍</div>
                <p class="text-sm font-medium text-gray-700 mb-1">エリアを選択してください</p>
                <p class="text-xs text-gray-400">マップ上のマーカーをクリックすると<br>土地情報・取引データが表示されます</p>
              </div>
            `}
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Map Fullscreen Toggle
// ============================================================
let _mapFullscreen = false;

function toggleMapFullscreen() {
  _mapFullscreen = !_mapFullscreen;
  const layout = document.querySelector('.map-layout');
  const btn = document.getElementById('btn-fullscreen-toggle');
  const icon = document.getElementById('fullscreen-icon');
  const label = document.getElementById('fullscreen-label');
  const floatingCtrl = document.getElementById('map-fullscreen-controls');
  if (!layout) return;

  if (_mapFullscreen) {
    layout.classList.add('map-fullscreen');
    if (btn) btn.classList.add('active');
    if (icon) icon.textContent = '✕';
    if (label) label.textContent = '閉じる';
    // カードの角丸を無効化
    const card = layout.closest('.card');
    if (card) card.style.borderRadius = '0';
    // フローティングコントロール表示
    if (floatingCtrl) floatingCtrl.classList.add('visible');
    // スクロール無効化
    document.body.style.overflow = 'hidden';
  } else {
    layout.classList.remove('map-fullscreen');
    if (btn) btn.classList.remove('active');
    if (icon) icon.textContent = '⛶';
    if (label) label.textContent = '拡大';
    const card = layout.closest('.card');
    if (card) card.style.borderRadius = '';
    // フローティングコントロール非表示
    if (floatingCtrl) floatingCtrl.classList.remove('visible');
    // スクロール復活
    document.body.style.overflow = '';
  }

  // Leaflet地図サイズ再計算
  if (mapInstance) {
    setTimeout(() => { mapInstance.invalidateSize(); }, 200);
  }
}

// ESCキーで全画面解除
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && _mapFullscreen) {
    toggleMapFullscreen();
  }
});

// ============================================================
// School District Layer
// ============================================================
const SCHOOL_DISTRICT_COLORS = [
  '#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316',
  '#14b8a6','#6366f1','#84cc16','#e11d48','#0ea5e9','#a855f7','#10b981','#f43f5e'
];

// ============================================================
// District Area Layer (toggleable, like school districts)
// ============================================================
const DISTRICT_AREA_COLORS = [
  '#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316',
  '#14b8a6','#6366f1','#84cc16','#e11d48','#0ea5e9','#a855f7','#10b981','#f43f5e'
];

function toggleDistrictAreas() {
  showDistrictAreas = !showDistrictAreas;
  const btn = document.getElementById('btn-district-area-toggle');
  if (btn) {
    btn.classList.toggle('active', showDistrictAreas);
    btn.querySelector('span').textContent = showDistrictAreas ? '📊 エリア ON' : '📊 エリア';
  }
  if (showDistrictAreas) {
    renderDistrictAreas();
  } else {
    if (districtAreaLayer && mapInstance) {
      mapInstance.removeLayer(districtAreaLayer);
      districtAreaLayer = null;
    }
    // Clear district sidebar if showing
    state.mapSelectedDistrict = null;
  }
}

function renderDistrictAreas() {
  if (!mapInstance) return;
  if (districtAreaLayer) { mapInstance.removeLayer(districtAreaLayer); }
  districtAreaLayer = L.layerGroup();

  // Collect all districts with coordinates from all areas that have transactions
  const districtEntries = [];
  AREAS.forEach(area => {
    if (!area._liveTransactions) return;
    const districtMap = {};
    area._liveTransactions.forEach(tx => {
      if (!tx.District) return;
      if (!districtMap[tx.District]) districtMap[tx.District] = 0;
      districtMap[tx.District]++;
    });
    Object.entries(districtMap).forEach(([districtName, count]) => {
      const coords = findDistrictCoords(districtName, area.name);
      if (coords) {
        districtEntries.push({ districtName, cityName: area.name, cityId: area.id, coords, count, area });
      }
    });
  });

  let colorIdx = 0;
  districtEntries.forEach(entry => {
    const color = DISTRICT_AREA_COLORS[colorIdx++ % DISTRICT_AREA_COLORS.length];
    const radius = Math.max(200, Math.min(600, entry.count * 80));

    const circle = L.circle([entry.coords[0], entry.coords[1]], {
      radius: radius,
      color: color,
      weight: 2,
      opacity: 0.8,
      fillColor: color,
      fillOpacity: 0.15,
      dashArray: '4 3'
    });

    // Tooltip with district name
    circle.bindTooltip(`${entry.districtName} (${entry.count}件)`, {
      permanent: false, direction: 'top', className: 'map-tooltip'
    });

    // Click → show district info in sidebar
    circle.on('click', () => {
      state.mapSelectedDistrict = { cityId: entry.cityId, districtName: entry.districtName };
      state.mapSelectedAreaId = entry.cityId;
      const ranked = getRankedAreas();
      updateDistrictSidebar(entry.area, entry.districtName, ranked);
      // Highlight this district circle
      renderDistrictAreas();
    });

    // Highlight selected district
    if (state.mapSelectedDistrict &&
        state.mapSelectedDistrict.cityId === entry.cityId &&
        state.mapSelectedDistrict.districtName === entry.districtName) {
      circle.setStyle({ fillOpacity: 0.35, weight: 3, opacity: 1, dashArray: null });
    }

    circle.on('mouseover', function() { this.setStyle({ fillOpacity: 0.3, weight: 3 }); });
    circle.on('mouseout', function() {
      const isSelected = state.mapSelectedDistrict &&
        state.mapSelectedDistrict.cityId === entry.cityId &&
        state.mapSelectedDistrict.districtName === entry.districtName;
      this.setStyle({
        fillOpacity: isSelected ? 0.35 : 0.15,
        weight: isSelected ? 3 : 2
      });
    });

    districtAreaLayer.addLayer(circle);

    // Add label marker
    const label = L.marker([entry.coords[0], entry.coords[1]], {
      icon: L.divIcon({
        html: `<div style="font-size:10px;font-weight:600;color:${color};text-shadow:1px 1px 2px white,-1px -1px 2px white,1px -1px 2px white,-1px 1px 2px white;white-space:nowrap;text-align:center;pointer-events:none;">${entry.districtName}</div>`,
        className: 'school-icon-marker',
        iconSize: [80, 16],
        iconAnchor: [40, 8]
      }),
      interactive: false
    });
    districtAreaLayer.addLayer(label);
  });

  districtAreaLayer.addTo(mapInstance);
}

// ============================================================
// School District Layer
// ============================================================
async function loadSchoolDistrictData() {
  if (schoolDistrictData) return schoolDistrictData;
  try {
    const resp = await fetch('/school-districts.geojson');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    schoolDistrictData = await resp.json();
    console.log(`School districts loaded: ${schoolDistrictData.features.length} zones`);
    return schoolDistrictData;
  } catch(e) {
    console.warn('School district data load failed:', e);
    return null;
  }
}

function toggleSchoolDistricts() {
  showSchoolDistricts = !showSchoolDistricts;
  const btn = document.getElementById('btn-school-toggle');
  if (btn) {
    btn.classList.toggle('active', showSchoolDistricts);
    btn.querySelector('span').textContent = showSchoolDistricts ? '🏫 学区 ON' : '🏫 学区';
  }
  if (showSchoolDistricts) {
    renderSchoolDistricts();
  } else {
    if (schoolDistrictLayer && mapInstance) {
      mapInstance.removeLayer(schoolDistrictLayer);
      schoolDistrictLayer = null;
    }
    if (schoolMarkerLayer && mapInstance) {
      mapInstance.removeLayer(schoolMarkerLayer);
      schoolMarkerLayer = null;
    }
  }
}

async function renderSchoolDistricts() {
  if (!mapInstance) return;
  const data = await loadSchoolDistrictData();
  if (!data) return;

  // Remove existing layers
  if (schoolDistrictLayer) { mapInstance.removeLayer(schoolDistrictLayer); }
  if (schoolMarkerLayer) { mapInstance.removeLayer(schoolMarkerLayer); }

  // Separate polygons and points
  const polygonFeatures = { type: 'FeatureCollection', features: data.features.filter(f => f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon') };
  const pointFeatures = data.features.filter(f => f.geometry.type === 'Point' && f.properties.type === 'school');

  // Render polygon overlays (school district boundaries)
  let colorIdx = 0;
  schoolDistrictLayer = L.geoJSON(polygonFeatures, {
    style: (feature) => {
      const color = SCHOOL_DISTRICT_COLORS[colorIdx++ % SCHOOL_DISTRICT_COLORS.length];
      return { color, weight: 2, opacity: 0.7, fillColor: color, fillOpacity: 0.08, dashArray: '4 3' };
    },
    onEachFeature: (feature, layer) => {
      const p = feature.properties;
      layer.bindPopup(`
        <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
          <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">🏫 ${p.name}</div>
          <table style="font-size:11px;">
            <tr><td style="color:#6b7280;padding-right:8px;">設置者</td><td>${p.org}</td></tr>
            <tr><td style="color:#6b7280;padding-right:8px;">所在地</td><td>${p.address}</td></tr>
          </table>
        </div>
      `, { maxWidth: 240 });
      layer.on('mouseover', function() { this.setStyle({ fillOpacity: 0.25, weight: 3 }); });
      layer.on('mouseout', function() { this.setStyle({ fillOpacity: 0.08, weight: 2 }); });
    }
  }).addTo(mapInstance);
  schoolDistrictLayer.bringToBack();

  // Render school icon markers
  const schoolIcon = L.divIcon({
    html: '<div style="font-size:20px;text-align:center;line-height:1;filter:drop-shadow(1px 1px 1px rgba(0,0,0,0.3));">🏫</div>',
    className: 'school-icon-marker',
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -14]
  });

  schoolMarkerLayer = L.layerGroup();
  pointFeatures.forEach(f => {
    const p = f.properties;
    const coords = f.geometry.coordinates;
    const marker = L.marker([coords[1], coords[0]], { icon: schoolIcon, zIndexOffset: 500 });
    marker.bindPopup(`
      <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
        <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">🏫 ${p.name}</div>
        <table style="font-size:11px;">
          <tr><td style="color:#6b7280;padding-right:8px;">設置者</td><td>${p.org}</td></tr>
          <tr><td style="color:#6b7280;padding-right:8px;">所在地</td><td>${p.address}</td></tr>
        </table>
      </div>
    `, { maxWidth: 240 });
    schoolMarkerLayer.addLayer(marker);
  });
  schoolMarkerLayer.addTo(mapInstance);
}

function initializeMap(ranked) {
  const container = document.getElementById('map-container');
  if (!container || !window.L) return;

  // Destroy existing map if present (container re-created by render)
  if (mapInstance) {
    try { mapInstance.remove(); } catch {}
    mapInstance = null;
    mapMarkers = {};
    txMarkerLayer = null;
  }

  // Create map centered on northern Mie
  mapInstance = L.map('map-container', { zoomControl: true }).setView([34.98, 136.56], 10);

  // OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>',
    maxZoom: 18
  }).addTo(mapInstance);

  // Transaction marker layer
  txMarkerLayer = L.layerGroup().addTo(mapInstance);

  // Create city markers
  ranked.forEach((area, idx) => {
    const color = COLORS[AREAS.findIndex(a => a.id === area.id) % COLORS.length];
    const rank = idx + 1;
    const icon = createMapIcon(color, rank, area.scores.total, area.id === state.mapSelectedAreaId);

    const marker = L.marker([area.lat, area.lng], { icon, zIndexOffset: 1000 })
      .addTo(mapInstance);

    marker.bindTooltip(`${area.name} (${area.scores.total}pt)`, {
      direction: 'top', offset: [0, -20], className: 'map-tooltip'
    });

    marker.on('click', async () => {
      state.mapSelectedAreaId = area.id;
      state.mapSelectedDistrict = null; // Reset district selection
      ranked.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, a.id === area.id));
      });
      updateMapSidebar(area, ranked);
      // Geocode districts before showing pins
      await geocodeAreaDistricts(area);
      showTransactionPins(area);
      mapInstance.flyTo([area.lat, area.lng], 13, { duration: 0.8 });

      // 未取得エリアなら優先指定（自動取得中→次に処理、停止中→直接取得）
      if (!AREA_FULL_LOADED.has(area.id)) {
        _fetchPriorityAreaId = area.id;
        if (!_autoFetchRunning && mcpReinfo && mcpReinfo.connected) {
          fetchAreaFullData(area.id);
        }
      }
    });

    mapMarkers[area.id] = marker;
  });

  // Ensure map renders correctly (especially on mobile)
  setTimeout(() => { if (mapInstance) mapInstance.invalidateSize(); }, 100);
  setTimeout(() => { if (mapInstance) mapInstance.invalidateSize(); }, 500);

  // Show all transaction pins at overview
  showAllTransactionPins(ranked);

  // Restore layers if enabled
  if (showSchoolDistricts) {
    renderSchoolDistricts();
  }
  if (showDistrictAreas) {
    renderDistrictAreas();
  }

  // If area already selected, zoom to it and auto-fetch full data
  if (state.mapSelectedAreaId) {
    const sel = ranked.find(a => a.id === state.mapSelectedAreaId);
    if (sel) {
      showTransactionPins(sel);
      mapInstance.setView([sel.lat, sel.lng], 13);
      if (!AREA_FULL_LOADED.has(sel.id)) {
        _fetchPriorityAreaId = sel.id;
        if (!_autoFetchRunning && mcpReinfo && mcpReinfo.connected) {
          fetchAreaFullData(sel.id);
        }
      }
    }
  }
}

// ============================================================
// Station Coordinate Database (Northern Mie Prefecture)
// ============================================================
const STATION_COORDS = {
  // 四日市市
  '近鉄四日市':[34.9665,136.6142],'四日市':[34.9667,136.6186],'富田':[34.989,136.6266],
  '富洲原':[34.997,136.631],'阿倉川':[34.976,136.6175],'川原町':[34.972,136.6153],
  '新正':[34.962,136.6154],'赤堀':[34.958,136.6156],'日永':[34.944,136.6088],
  '南日永':[34.952,136.612],'泊':[34.938,136.611],'追分':[34.934,136.605],
  '内部':[34.928,136.5925],'小古曽':[34.936,136.599],'河原田':[34.912,136.5814],
  '塩浜':[34.938,136.6217],'海山道':[34.956,136.6238],'霞ヶ浦':[34.957,136.6262],
  '大矢知':[34.997,136.628],'平津':[34.996,136.618],'暁学園前':[34.993,136.608],
  '山城':[34.981,136.5936],'保々':[34.991,136.582],'北楠':[34.918,136.61],
  '楠':[34.912,136.615],'南四日市':[34.947,136.62],'中川原':[34.961,136.607],
  '伊勢松本':[34.969,136.601],'西日野':[34.95,136.597],'近鉄富田':[34.988,136.622],
  // 桑名市
  '桑名':[35.0614,136.6918],'播磨':[35.046,136.677],'益生':[35.066,136.6785],
  '馬道':[35.06,136.686],'西桑名':[35.062,136.686],'在良':[35.073,136.676],
  '星川':[35.081,136.671],'七和':[35.087,136.659],'穴太':[35.091,136.65],
  '多度':[35.117,136.629],'長島':[35.076,136.715],'蓮花寺':[35.078,136.665],
  '下深谷':[35.039,136.669],'伊勢朝日':[35.032,136.669],
  // 鈴鹿市
  '白子':[34.843,136.611],'鈴鹿':[34.871,136.543],'鈴鹿市':[34.881,136.581],
  '三日市':[34.874,136.577],'平田町':[34.876,136.559],'加佐登':[34.886,136.523],
  '玉垣':[34.855,136.601],'柳':[34.848,136.599],'磯山':[34.836,136.615],
  '千代崎':[34.831,136.617],'箕田':[34.863,136.593],'鼓ヶ浦':[34.838,136.613],
  '徳田':[34.884,136.559],'伊勢若松':[34.856,136.608],'千里':[34.887,136.506],
  '中瀬古':[34.866,136.571],
  // いなべ市
  '三里':[35.093,136.554],'北勢中央公園口':[35.087,136.548],'麻生田':[35.099,136.548],
  '阿下喜':[35.126,136.549],'楚原':[35.116,136.549],'大泉':[35.108,136.554],
  '梅戸井':[35.084,136.551],
  // 亀山市
  '亀山':[34.855,136.449],'関':[34.855,136.397],'加太':[34.85,136.355],
  '井田川':[34.874,136.489],
  // 菰野町
  '菰野':[35.017,136.516],'中菰野':[35.024,136.509],'大羽根園':[35.029,136.502],
  '湯の山温泉':[35.036,136.486],'桜':[35.009,136.528],
  // 東員町
  '東員':[35.06,136.595],'大長':[35.066,136.589],'北大社':[35.073,136.592],
};

// Station → Nagoya commute time (minutes, approximate)
const STATION_TO_NAGOYA_MIN = {
  // 四日市市
  '近鉄四日市':35,'四日市':50,'富田':38,'富洲原':40,'阿倉川':37,'川原町':36,
  '新正':36,'赤堀':37,'日永':40,'南日永':39,'泊':42,'追分':43,
  '内部':45,'小古曽':44,'河原田':48,'塩浜':42,'海山道':38,'霞ヶ浦':37,
  '大矢知':40,'平津':42,'暁学園前':44,'山城':46,'保々':48,'北楠':48,
  '楠':50,'南四日市':40,'中川原':38,'伊勢松本':40,'西日野':42,'近鉄富田':37,
  // 桑名市
  '桑名':25,'播磨':30,'益生':27,'馬道':26,'西桑名':26,'在良':28,
  '星川':30,'七和':32,'穴太':34,'多度':40,'長島':22,'蓮花寺':31,
  '下深谷':32,'伊勢朝日':33,
  // 鈴鹿市
  '白子':55,'鈴鹿':65,'鈴鹿市':60,'三日市':62,'平田町':63,'加佐登':68,
  '玉垣':57,'柳':58,'磯山':56,'千代崎':54,'箕田':59,'鼓ヶ浦':55,
  '徳田':63,'伊勢若松':56,'千里':70,'中瀬古':61,
  // いなべ市
  '三里':52,'北勢中央公園口':53,'麻生田':54,'阿下喜':58,'楚原':56,'大泉':54,'梅戸井':51,
  // 亀山市
  '亀山':70,'関':80,'加太':90,'井田川':65,
  // 菰野町
  '菰野':50,'中菰野':52,'大羽根園':54,'湯の山温泉':58,'桜':48,
  // 東員町
  '東員':38,'大長':40,'北大社':42,
};

function findStationCoords(stationName) {
  if (!stationName) return null;
  if (STATION_COORDS[stationName]) return STATION_COORDS[stationName];
  const cleaned = stationName.replace(/駅$/, '').replace(/\(.*\)/, '').trim();
  if (STATION_COORDS[cleaned]) return STATION_COORDS[cleaned];
  for (const [key, coords] of Object.entries(STATION_COORDS)) {
    if (cleaned.includes(key) || key.includes(cleaned)) return coords;
  }
  return null;
}

// ============================================================
// District Geocoding (Nominatim + localStorage cache)
// ============================================================
const DISTRICT_CACHE = new Map();
const DISTRICT_CACHE_KEY = 'mie-realestate-district-coords-v2';

// Load cached coords from localStorage on startup
function loadDistrictCache() {
  try {
    const stored = localStorage.getItem(DISTRICT_CACHE_KEY);
    if (!stored) return;
    const obj = JSON.parse(stored);
    for (const [k, v] of Object.entries(obj)) {
      DISTRICT_CACHE.set(k, v);
    }
    console.log(`District cache loaded: ${DISTRICT_CACHE.size} entries`);
  } catch(e) { console.warn('Cache load failed:', e); }
}

function saveDistrictCache() {
  try {
    const obj = {};
    for (const [k, v] of DISTRICT_CACHE.entries()) obj[k] = v;
    localStorage.setItem(DISTRICT_CACHE_KEY, JSON.stringify(obj));
  } catch(e) { console.warn('Cache save failed:', e); }
}

async function geocodeDistrict(district, cityName) {
  const cacheKey = `${cityName}-${district}`;
  if (DISTRICT_CACHE.has(cacheKey)) return DISTRICT_CACHE.get(cacheKey);

  // Try GSI (国土地理院) API first, then Nominatim as fallback
  const queries = [
    `三重県${cityName}${district}`,
    `${cityName}${district}`,
  ];

  // GSI API (more reliable for Japanese addresses)
  for (const q of queries) {
    try {
      const url = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(q)}`;
      const resp = await fetch(url);
      if (!resp.ok) continue;
      const results = await resp.json();
      if (results.length > 0) {
        const coords_arr = results[0].geometry.coordinates; // [lng, lat]
        const lat = parseFloat(coords_arr[1]);
        const lng = parseFloat(coords_arr[0]);
        if (lat >= 34.2 && lat <= 35.5 && lng >= 135.8 && lng <= 137.0) {
          const coords = [lat, lng];
          DISTRICT_CACHE.set(cacheKey, coords);
          return coords;
        }
      }
    } catch(e) { /* skip */ }
  }

  // Nominatim fallback
  const nomQueries = [`${district}, ${cityName}, 三重県`, `${district}, ${cityName}`];
  for (const q of nomQueries) {
    try {
      const url = `https://nominatim.openstreetmap.org/search?` +
        `q=${encodeURIComponent(q)}&format=json&limit=1&countrycodes=jp`;
      const resp = await fetch(url, {
        headers: { 'User-Agent': 'MieRealEstateApp/1.0' }
      });
      if (!resp.ok) continue;
      const results = await resp.json();
      if (results.length > 0) {
        const lat = parseFloat(results[0].lat);
        const lng = parseFloat(results[0].lon);
        if (lat >= 34.2 && lat <= 35.5 && lng >= 135.8 && lng <= 137.0) {
          const coords = [lat, lng];
          DISTRICT_CACHE.set(cacheKey, coords);
          return coords;
        }
      }
    } catch(e) { /* skip */ }
  }

  // Mark as not found so we don't retry
  DISTRICT_CACHE.set(cacheKey, null);
  return null;
}

// Background geocoding - doesn't block UI
async function geocodeDistrictsBackground() {
  // Collect uncached district+city pairs
  const uncached = [];
  for (const area of AREAS) {
    if (!area._liveTransactions) continue;
    for (const tx of area._liveTransactions) {
      if (!tx.District) continue;
      const key = `${area.name}-${tx.District}`;
      if (!DISTRICT_CACHE.has(key) && !uncached.find(u => u.key === key)) {
        uncached.push({ key, district: tx.District, cityName: area.name });
      }
    }
  }

  if (uncached.length === 0) return;

  const total = uncached.length;
  let done = 0;

  for (const { district, cityName } of uncached) {
    done++;
    updateStatusText(`地区の位置情報を取得中... (${done}/${total})`);
    await geocodeDistrict(district, cityName);
    // Save every 5 results
    if (done % 5 === 0) saveDistrictCache();
    // Rate limit: 300ms between requests (GSI API is less restrictive than Nominatim)
    if (done < total) await new Promise(r => setTimeout(r, 300));
  }

  saveDistrictCache();

  // Refresh map pins with newly geocoded positions
  updateStatusText(`位置情報取得完了 (${done}件) — ピンを更新中...`);
  if (state.view === 'map' && txMarkerLayer) {
    const ranked = getRankedAreas();
    if (state.mapSelectedAreaId) {
      const sel = ranked.find(a => a.id === state.mapSelectedAreaId);
      if (sel) showTransactionPins(sel);
    } else {
      showAllTransactionPins(ranked);
    }
  }

  const cached = Array.from(DISTRICT_CACHE.values()).filter(v => v !== null).length;
  updateStatusText(`ライブデータ取得完了 — 地区位置: ${cached}件解決済み`);
}

function findDistrictCoords(district, cityName) {
  if (!district || !cityName) return null;
  const key = `${cityName}-${district}`;
  return DISTRICT_CACHE.get(key) || null;
}

// Aggregate metrics for a single district within an area
function aggregateDistrictMetrics(area, districtName) {
  if (!area._liveTransactions || !districtName) return null;
  // Preserve original index in _liveTransactions for map pin reference
  const txs = area._liveTransactions
    .map((t, i) => ({ ...t, _areaIdx: i }))
    .filter(t => t.District === districtName);
  if (txs.length === 0) return null;

  // Prices
  const prices = txs.filter(t => t.TradePrice != null && !isNaN(t.TradePrice)).map(t => t.TradePrice);
  const avgPrice = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : null;
  const minPrice = prices.length > 0 ? Math.min(...prices) : null;
  const maxPrice = prices.length > 0 ? Math.max(...prices) : null;

  // Price per m²
  const pricePerM2 = txs
    .filter(t => t.TradePrice != null && !isNaN(t.TradePrice) && t.Area && t.Area > 0)
    .map(t => t.TradePrice / t.Area);
  const avgPricePerM2 = pricePerM2.length > 0 ? pricePerM2.reduce((a, b) => a + b, 0) / pricePerM2.length : null;

  // Most frequent station
  const stationCounts = {};
  txs.forEach(t => {
    if (t.NearestStation) {
      const s = t.NearestStation.replace(/\(.*\)/, '').trim();
      stationCounts[s] = (stationCounts[s] || 0) + 1;
    }
  });
  const topStation = Object.entries(stationCounts).sort((a, b) => b[1] - a[1])[0];
  const nearestStation = topStation ? topStation[0] : null;

  // Nagoya commute time
  let nagoyaMin = null;
  if (nearestStation) {
    const cleaned = nearestStation.replace(/駅$/, '').trim();
    nagoyaMin = STATION_TO_NAGOYA_MIN[cleaned] || STATION_TO_NAGOYA_MIN[nearestStation] || null;
    if (!nagoyaMin) {
      for (const [key, min] of Object.entries(STATION_TO_NAGOYA_MIN)) {
        if (cleaned.includes(key) || key.includes(cleaned)) { nagoyaMin = min; break; }
      }
    }
  }
  if (!nagoyaMin) nagoyaMin = area.accessToNagoya; // fallback to city level

  // Distance to station (average)
  const distances = txs.filter(t => t.DistanceToStation).map(t => {
    const m = String(t.DistanceToStation).match(/(\d+)/);
    return m ? parseInt(m[1]) : null;
  }).filter(Boolean);
  const avgDistance = distances.length > 0 ? Math.round(distances.reduce((a, b) => a + b, 0) / distances.length) : null;

  // Property type distribution
  const typeCounts = {};
  txs.forEach(t => {
    const type = t.Type || t.Use || 'その他';
    typeCounts[type] = (typeCounts[type] || 0) + 1;
  });
  const typeDistribution = Object.entries(typeCounts)
    .map(([name, count]) => ({ name, count, pct: Math.round(count / txs.length * 100) }))
    .sort((a, b) => b.count - a.count);

  // Average building age
  const currentYear = new Date().getFullYear();
  const ages = txs.filter(t => t.BuildingYear).map(t => {
    const yr = String(t.BuildingYear);
    // Handle "令和X年", "平成X年", "昭和X年" or just year number
    let builtYear = parseInt(yr);
    if (yr.includes('令和')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 2018 + n; }
    else if (yr.includes('平成')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 1988 + n; }
    else if (yr.includes('昭和')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 1925 + n; }
    if (builtYear > 1900 && builtYear <= currentYear) return currentYear - builtYear;
    return null;
  }).filter(Boolean);
  const avgBuildingAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : null;

  // District coordinates
  const coords = findDistrictCoords(districtName, area.name);

  return {
    districtName, cityName: area.name, cityId: area.id,
    count: txs.length, transactions: txs,
    avgPrice, minPrice, maxPrice,
    avgPricePerM2,
    nearestStation, nagoyaMin, avgDistance,
    typeDistribution, avgBuildingAge, coords
  };
}

// Geocode all districts for a single area BEFORE showing pins
async function geocodeAreaDistricts(area, options = {}) {
  if (!area._liveTransactions) return;
  const uncached = [];
  for (const tx of area._liveTransactions) {
    if (!tx.District) continue;
    const key = `${area.name}-${tx.District}`;
    if (!DISTRICT_CACHE.has(key) && !uncached.find(u => u.key === key)) {
      uncached.push({ key, district: tx.District, cityName: area.name });
    }
  }
  if (uncached.length === 0) return;

  const showOverlay = options.showOverlay !== undefined ? options.showOverlay : true;
  const total = uncached.length;
  let done = 0;
  if (showOverlay) showMapLoading(`${area.name} 地区情報取得中...`, 0);
  for (const { district, cityName } of uncached) {
    done++;
    if (showOverlay) updateMapLoading(`${area.name} 地区情報取得中... (${done}/${total})`, (done / total) * 100);
    await geocodeDistrict(district, cityName);
    if (done % 5 === 0) saveDistrictCache();
    if (done < total) await new Promise(r => setTimeout(r, 200));
  }
  saveDistrictCache();
  if (showOverlay) hideMapLoading();
}

function hashStr(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) {
    h = ((h << 5) - h + s.charCodeAt(i)) | 0;
  }
  return Math.abs(h);
}

function estimateTxPosition(area, tx, idx) {
  // Priority 1: District geocoded coords (most accurate for this data)
  const districtCoords = findDistrictCoords(tx.District, area.name);
  if (districtCoords) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.001 + (idx % 7) * 0.0005;
    return {
      lat: districtCoords[0] + Math.cos(jitterAngle) * jitter,
      lng: districtCoords[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 2: Station coordinates (from NearestStation field)
  const stationCoords = findStationCoords(tx.NearestStation);
  if (stationCoords) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.0008 + (idx % 5) * 0.0004;
    return {
      lat: stationCoords[0] + Math.cos(jitterAngle) * jitter,
      lng: stationCoords[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 3: District name → fuzzy match against station names
  const stationFromDistrict = findStationCoords(tx.District);
  if (stationFromDistrict) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.0015 + (idx % 7) * 0.0005;
    return {
      lat: stationFromDistrict[0] + Math.cos(jitterAngle) * jitter,
      lng: stationFromDistrict[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 4: Fallback - bias inland from city center
  const districtKey = tx.District || tx.NearestStation || `tx-${idx}`;
  const hash = hashStr(districtKey + area.id);
  const baseAngle = 150 + (hash % 200);
  const angle = baseAngle * (Math.PI / 180);
  const spread = 0.004 + (hash % 40) / 40 * 0.012;
  const baseLat = area.lat + Math.cos(angle) * spread;
  const baseLng = area.lng + Math.sin(angle) * spread;

  const jitterAngle = (idx * 137.508) * (Math.PI / 180);
  const jitter = 0.0008 + (idx % 5) * 0.0004;

  return {
    lat: baseLat + Math.cos(jitterAngle) * jitter,
    lng: baseLng + Math.sin(jitterAngle) * jitter
  };
}

// Get color based on price (green=cheap, yellow=mid, red=expensive)
function priceColor(price) {
  if (!price || isNaN(price)) return '#9ca3af';
  if (price < 5000000) return '#22c55e';    // green: <500万
  if (price < 15000000) return '#3b82f6';   // blue: 500-1500万
  if (price < 30000000) return '#f59e0b';   // amber: 1500-3000万
  if (price < 50000000) return '#ef4444';   // red: 3000-5000万
  return '#7c3aed';                          // purple: >5000万
}

async function showAllTransactionPins(ranked) {
  if (!txMarkerLayer) return;
  txMarkerLayer.clearLayers();

  // Geocode districts for all areas with transactions (AREAS本体を参照)
  for (const area of AREAS) {
    if (area._liveTransactions && area._liveTransactions.length > 0) {
      await geocodeAreaDistricts(area, { showOverlay: false });
    }
  }

  let totalPins = 0;
  AREAS.forEach(area => {
    const transactions = area._liveTransactions;
    if (!transactions) return;
    const color = COLORS[AREAS.indexOf(area) % COLORS.length];
    transactions.forEach((tx, i) => {
      const pos = estimateTxPosition(area, tx, i);
      const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
      totalPins++;
      const cm = L.circleMarker([pos.lat, pos.lng], {
        radius: 5,
        fillColor: hasPrice ? priceColor(tx.TradePrice) : '#9ca3af',
        color: '#fff',
        weight: 1,
        opacity: 0.8,
        fillOpacity: 0.6
      });
      cm.bindPopup(buildTxPopup(tx, area.name), { maxWidth: 220 });
      txMarkerLayer.addLayer(cm);
    });
  });
  console.log(`[PIN] showAllTransactionPins: ${totalPins} total pins created`);
}

// Map loading overlay controls
function showMapLoading(areaName, pct) {
  const overlay = document.getElementById('map-loading-overlay');
  if (!overlay) return;
  overlay.classList.remove('hidden');
  updateMapLoading(areaName, pct);
}

function updateMapLoading(label, pct) {
  const textEl = document.getElementById('map-loading-text');
  const barEl = document.getElementById('map-loading-bar');
  if (textEl) textEl.textContent = label;
  if (barEl) barEl.style.width = pct + '%';
}

function hideMapLoading() {
  const overlay = document.getElementById('map-loading-overlay');
  if (overlay) overlay.classList.add('hidden');
}

// Transaction pin index for sidebar click → map navigation
let txMarkersByIdx = {};

function showTransactionPins(area) {
  if (!txMarkerLayer) return;
  txMarkerLayer.clearLayers();
  txMarkersByIdx = {};

  // 常にAREAS本体から最新の_liveTransactionsを取得（rankedコピーは古い場合がある）
  const canonical = AREAS.find(a => a.id === area.id) || area;
  const transactions = canonical._liveTransactions;
  if (!transactions) return;

  let pinCount = 0;
  transactions.forEach((tx, i) => {
    const pos = estimateTxPosition(area, tx, i);
    const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
    const cm = L.circleMarker([pos.lat, pos.lng], {
      radius: 7,
      fillColor: hasPrice ? priceColor(tx.TradePrice) : '#9ca3af',
      color: '#fff',
      weight: 1.5,
      opacity: 0.9,
      fillOpacity: hasPrice ? 0.7 : 0.4
    });
    cm.bindPopup(buildTxPopup(tx, area.name), { maxWidth: 240 });
    txMarkerLayer.addLayer(cm);
    txMarkersByIdx[i] = { marker: cm, pos };
    pinCount++;
  });
  console.log(`[PIN] showTransactionPins: ${area.name} — ${pinCount} pins created from ${transactions.length} transactions`);
}

// Navigate map to a specific transaction pin and open popup
function flyToTransaction(idx) {
  const entry = txMarkersByIdx[idx];
  if (!entry || !mapInstance) return;
  mapInstance.flyTo([entry.pos.lat, entry.pos.lng], 16, { duration: 0.6 });
  setTimeout(() => {
    entry.marker.setRadius(12);
    entry.marker.openPopup();
    setTimeout(() => entry.marker.setRadius(7), 2000);
  }, 650);
}

function buildTxPopup(tx, cityName) {
  const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
  const priceStr = hasPrice
    ? (tx.TradePrice >= 10000 ? `${(tx.TradePrice/10000).toFixed(0)}万円` : `${tx.TradePrice.toLocaleString()}円`)
    : '価格不明';
  return `
    <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
      <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">${priceStr}</div>
      <table style="font-size:11px;">
        ${tx.District ? `<tr><td style="color:#6b7280;padding-right:8px;">地区</td><td>${tx.District}</td></tr>` : ''}
        ${tx.Area ? `<tr><td style="color:#6b7280;padding-right:8px;">面積</td><td>${tx.Area}m²</td></tr>` : ''}
        ${tx.Type || tx.Use ? `<tr><td style="color:#6b7280;padding-right:8px;">種別</td><td>${tx.Type || tx.Use}</td></tr>` : ''}
        ${tx.NearestStation ? `<tr><td style="color:#6b7280;padding-right:8px;">最寄駅</td><td>${tx.NearestStation}${tx.DistanceToStation ? ` (${tx.DistanceToStation})` : ''}</td></tr>` : ''}
        ${tx.BuildingYear ? `<tr><td style="color:#6b7280;padding-right:8px;">築年</td><td>${tx.BuildingYear}</td></tr>` : ''}
        ${tx.Structure ? `<tr><td style="color:#6b7280;padding-right:8px;">構造</td><td>${tx.Structure}</td></tr>` : ''}
      </table>
      <div style="font-size:10px;color:#9ca3af;margin-top:4px;">${cityName}</div>
    </div>`;
}

function createMapIcon(color, rank, score, isSelected) {
  const size = isSelected ? 48 : 40;
  const borderWidth = isSelected ? 3 : 2;
  const shadow = isSelected ? 'filter: drop-shadow(0 2px 6px rgba(0,0,0,0.3));' : 'filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));';
  const svgString = `
    <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg" style="${shadow}">
      <circle cx="${size/2}" cy="${size/2}" r="${size/2-2}" fill="${color}" opacity="0.9" stroke="white" stroke-width="${borderWidth}"/>
      <text x="${size/2}" y="${size/2-2}" text-anchor="middle" fill="white" font-size="${isSelected ? 11 : 10}" font-weight="500" font-family="sans-serif">${rank}位</text>
      <text x="${size/2}" y="${size/2+10}" text-anchor="middle" fill="white" font-size="${isSelected ? 13 : 11}" font-weight="700" font-family="sans-serif">${score}</text>
    </svg>`;
  return L.icon({
    iconUrl: 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString))),
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2],
    tooltipAnchor: [0, -size/2]
  });
}

function updateMapSidebar(area, ranked) {
  const sidebar = document.getElementById('map-sidebar');
  if (!sidebar) return;

  // ranked配列からscores付きオブジェクトを取得（AREAS直参照はscoresが無い）
  const rankedArea = ranked.find(a => a.id === area.id) || area;
  // AREAS本体から最新の_liveTransactionsを取得（rankedコピーは古い場合がある）
  const canonical = AREAS.find(a => a.id === area.id) || area;
  area = rankedArea;

  const rank = ranked.findIndex(a => a.id === area.id) + 1;
  const medals = ['🥇','🥈','🥉'];
  const medalStr = rank <= 3 ? medals[rank-1] : `${rank}位`;

  const isFullLoaded = AREA_FULL_LOADED.has(area.id);
  const isFetching = _currentFetchAreaId === area.id;
  const txCount = canonical._liveTransactions ? canonical._liveTransactions.length : 0;

  const loadingBadge = isFetching
    ? '<span class="inline-flex items-center gap-1 text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full mb-2"><span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>詳細データ取得中...</span>'
    : isFullLoaded
      ? `<span class="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded-full mb-2">✅ 全期間データ取得済み（${txCount}件）</span>`
      : `<span class="text-xs text-gray-400 mb-2">概要データのみ（${txCount}件）</span>`;

  const txSection = txCount > 0
    ? renderTransactionList(canonical._liveTransactions)
    : (state.mcpStatus === 'connected'
      ? '<p class="text-xs text-gray-400 mt-2">取引データなし</p>'
      : '<p class="text-xs text-gray-400 mt-2">MCPに接続すると取引データが表示されます</p>');

  sidebar.innerHTML = `
    <div class="sidebar-header">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-xl">${medalStr}</span>
          <h3 class="text-lg font-bold text-gray-900">${area.name}</h3>
        </div>
        <span class="text-2xl font-bold text-blue-600">${area.scores.total}<span class="text-xs font-normal text-gray-400">pt</span></span>
      </div>
    </div>
    <div class="sidebar-body space-y-4">
      ${loadingBadge}
      <!-- Key metrics -->
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-blue-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">住宅地価格</div>
          <div class="text-sm font-bold text-blue-700">${(area.residentialPrice/10000).toFixed(1)}万/m²</div>
        </div>
        <div class="bg-green-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">名古屋まで</div>
          <div class="text-sm font-bold text-green-700">${area.accessToNagoya}分</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">地価変動</div>
          <div class="text-sm font-bold text-amber-700">+${area.yoyChange}%</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">人口</div>
          <div class="text-sm font-bold text-purple-700">${(area.population/10000).toFixed(1)}万人</div>
        </div>
      </div>

      <!-- Live average price -->
      ${area._liveAvgTradePrice ? `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center gap-2 mb-1">
            <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
            <span class="text-xs font-medium text-blue-700">LIVE 平均取引価格</span>
          </div>
          <div class="text-lg font-bold text-blue-800">${(area._liveAvgTradePrice / 10000).toFixed(0)}万円</div>
          <div class="text-xs text-blue-500">${area._liveTransactionCount}件の取引データから算出</div>
        </div>
      ` : ''}

      <!-- Description -->
      <div>
        <p class="text-xs text-gray-600 leading-relaxed">${area.description}</p>
      </div>

      <!-- Highlights -->
      <div class="bg-green-50 rounded-lg p-3">
        <div class="text-xs font-bold text-green-700 mb-2">✅ ポイント</div>
        ${area.highlights.map(h => `<div class="text-xs text-green-800 mb-1">• ${h}</div>`).join('')}
      </div>

      <!-- Transaction data -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs font-bold text-gray-700">📊 取引データ</div>
          <div class="text-xs text-gray-400">${area._liveTransactions ? area._liveTransactions.length + '件' : ''}</div>
        </div>
        ${txSection}
        ${area._liveTransactions && area._liveTransactions.length > 0 ? `
          <div class="mt-2 flex flex-wrap gap-1 items-center">
            <span class="text-xs text-gray-400">凡例:</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#22c55e;display:inline-block;"></span>~500万</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#3b82f6;display:inline-block;"></span>~1500万</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#f59e0b;display:inline-block;"></span>~3000万</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;"></span>~5000万</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#7c3aed;display:inline-block;"></span>5000万~</span>
          </div>
        ` : ''}
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2">
        <button data-map-to-detail="${area.id}" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors text-center">
          🔍 詳細を見る
        </button>
        <button data-map-zoom-out class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors">
          🗺️ 全体表示
        </button>
      </div>
    </div>
  `;

  // Bind sidebar buttons
  const detailBtn = sidebar.querySelector('[data-map-to-detail]');
  if (detailBtn) {
    detailBtn.addEventListener('click', () => {
      state.selectedAreaId = area.id;
      state.view = 'detail';
      render();
    });
  }

  const zoomOutBtn = sidebar.querySelector('[data-map-zoom-out]');
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = null;
      if (mapInstance) mapInstance.flyTo([34.98, 136.56], 10, { duration: 0.8 });
      // Reset marker icons
      const ranked2 = getRankedAreas();
      ranked2.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        if (mapMarkers[a.id]) mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, false));
      });
      // Show all transaction pins again
      showAllTransactionPins(ranked2);
      // Reset sidebar
      sidebar.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full text-center p-8">
          <div class="text-4xl mb-3">📍</div>
          <p class="text-sm font-medium text-gray-700 mb-1">エリアを選択してください</p>
          <p class="text-xs text-gray-400">マップ上のマーカーをクリックすると<br>土地情報・取引データが表示されます</p>
        </div>`;
    });
  }

  // Bind transaction row clicks → fly to map pin
  sidebar.querySelectorAll('tr[data-tx-idx]').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.txIdx);
      // Highlight active row
      sidebar.querySelectorAll('tr.tx-active').forEach(r => r.classList.remove('tx-active'));
      row.classList.add('tx-active');
      // Fly to pin
      flyToTransaction(idx);
    });
  });
}

function updateDistrictSidebar(area, districtName, ranked) {
  const sidebar = document.getElementById('map-sidebar');
  if (!sidebar) return;

  const metrics = aggregateDistrictMetrics(area, districtName);
  if (!metrics) {
    sidebar.innerHTML = `<div class="p-4 text-sm text-gray-500">地区データなし</div>`;
    return;
  }

  const avgPriceStr = metrics.avgPrice ? `${(metrics.avgPrice / 10000).toFixed(0)}万円` : '-';
  const priceRange = (metrics.minPrice && metrics.maxPrice)
    ? `${(metrics.minPrice / 10000).toFixed(0)}〜${(metrics.maxPrice / 10000).toFixed(0)}万円`
    : '-';
  const m2PriceStr = metrics.avgPricePerM2 ? `${(metrics.avgPricePerM2 / 10000).toFixed(1)}万/m²` : '-';
  const stationStr = metrics.nearestStation || '-';
  const nagoyaStr = metrics.nagoyaMin ? `約${metrics.nagoyaMin}分` : `約${area.accessToNagoya}分`;
  const distStr = metrics.avgDistance ? `徒歩${metrics.avgDistance}分` : '-';
  const ageStr = metrics.avgBuildingAge !== null ? `築${metrics.avgBuildingAge}年` : '-';

  // Type distribution bar
  const typeColors = { '宅地(土地)': '#22c55e', '宅地(土地と建物)': '#3b82f6', '中古マンション等': '#f59e0b', '農地': '#84cc16', '林地': '#14b8a6' };
  const typeBar = metrics.typeDistribution.map(t => {
    const color = typeColors[t.name] || '#9ca3af';
    return `<div style="width:${t.pct}%;background:${color};height:100%;display:inline-block;" title="${t.name} ${t.pct}%"></div>`;
  }).join('');
  const typeLegend = metrics.typeDistribution.slice(0, 4).map(t => {
    const color = typeColors[t.name] || '#9ca3af';
    return `<span class="inline-flex items-center gap-1 text-xs"><span style="width:6px;height:6px;border-radius:50%;background:${color};display:inline-block;"></span>${t.name.replace('宅地(','').replace(')','').replace('中古マンション等','マンション')} ${t.pct}%</span>`;
  }).join(' ');

  // Transaction list filtered to this district
  const districtTxs = metrics.transactions;
  const txSection = renderTransactionList(districtTxs);

  sidebar.innerHTML = `
    <div class="sidebar-header">
      <button id="btn-back-to-city" class="flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800 mb-2 cursor-pointer" style="background:none;border:none;padding:0;">
        ← ${area.name}に戻る
      </button>
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-900">📍 ${districtName}</h3>
        <span class="text-sm font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">${metrics.count}件</span>
      </div>
    </div>
    <div class="sidebar-body space-y-4">
      <!-- Key metrics -->
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-blue-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">平均取引価格</div>
          <div class="text-sm font-bold text-blue-700">${avgPriceStr}</div>
        </div>
        <div class="bg-indigo-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">㎡単価</div>
          <div class="text-sm font-bold text-indigo-700">${m2PriceStr}</div>
        </div>
        <div class="bg-green-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">最寄駅</div>
          <div class="text-sm font-bold text-green-700" style="font-size:11px;">${stationStr}</div>
        </div>
        <div class="bg-emerald-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">名古屋まで</div>
          <div class="text-sm font-bold text-emerald-700">${nagoyaStr}</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">駅距離</div>
          <div class="text-sm font-bold text-amber-700">${distStr}</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">平均築年数</div>
          <div class="text-sm font-bold text-purple-700">${ageStr}</div>
        </div>
      </div>

      <!-- Price range -->
      <div class="bg-gray-50 rounded-lg p-2">
        <div class="text-xs text-gray-500 mb-1">価格帯</div>
        <div class="text-sm font-medium text-gray-700">${priceRange}</div>
      </div>

      <!-- Type distribution -->
      ${metrics.typeDistribution.length > 0 ? `
        <div>
          <div class="text-xs text-gray-500 mb-1">用途分布</div>
          <div style="height:8px;border-radius:4px;overflow:hidden;background:#e5e7eb;display:flex;">${typeBar}</div>
          <div class="mt-1 flex flex-wrap gap-2">${typeLegend}</div>
        </div>
      ` : ''}

      <!-- Transaction data -->
      <div>
        <div class="text-xs font-bold text-gray-700 mb-2">📊 取引データ（${districtName}）</div>
        ${txSection || '<p class="text-xs text-gray-400">取引データなし</p>'}
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2">
        <button id="btn-district-back" class="flex-1 px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors text-center">
          ↩ ${area.name}へ戻る
        </button>
        <button data-map-zoom-out class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors">
          🗺️ 全体表示
        </button>
      </div>
    </div>
  `;

  // Bind back button
  const backBtn = sidebar.querySelector('#btn-back-to-city');
  const backBtn2 = sidebar.querySelector('#btn-district-back');
  const goBack = () => {
    state.mapSelectedDistrict = null;
    updateMapSidebar(area, ranked);
    showTransactionPins(area);
  };
  if (backBtn) backBtn.addEventListener('click', goBack);
  if (backBtn2) backBtn2.addEventListener('click', goBack);

  // Bind zoom out
  const zoomOutBtn = sidebar.querySelector('[data-map-zoom-out]');
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = null;
      state.mapSelectedDistrict = null;
      if (mapInstance) mapInstance.flyTo([34.98, 136.56], 10, { duration: 0.8 });
      const ranked2 = getRankedAreas();
      ranked2.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        if (mapMarkers[a.id]) mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, false));
      });
      showAllTransactionPins(ranked2);
      sidebar.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full text-center p-8">
          <div class="text-4xl mb-3">📍</div>
          <p class="text-sm font-medium text-gray-700 mb-1">エリアを選択してください</p>
          <p class="text-xs text-gray-400">マップ上のマーカーをクリックすると<br>土地情報・取引データが表示されます</p>
        </div>`;
    });
  }

  // Bind transaction row clicks
  sidebar.querySelectorAll('tr[data-tx-idx]').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.txIdx);
      sidebar.querySelectorAll('tr.tx-active').forEach(r => r.classList.remove('tx-active'));
      row.classList.add('tx-active');
      flyToTransaction(idx);
    });
  });
}

function renderTransactionList(transactions) {
  if (!transactions || transactions.length === 0) return '';

  // Keep original index for map pin reference
  // Use _areaIdx if present (from district filtering), otherwise use array index
  const indexed = transactions.map((t, i) => ({
    ...t,
    _origIdx: (t._areaIdx !== undefined) ? t._areaIdx : i
  }));
  // Show all transactions (including those without price)
  const validTx = [...indexed];
  if (validTx.length === 0) return '<p class="text-xs text-gray-400">取引データなし</p>';

  // Sort by price descending (null prices at end)
  validTx.sort((a, b) => {
    const pa = (a.TradePrice != null && !isNaN(a.TradePrice)) ? a.TradePrice : -1;
    const pb = (b.TradePrice != null && !isNaN(b.TradePrice)) ? b.TradePrice : -1;
    return pb - pa;
  });

  return `
    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
      <table class="tx-table">
        <thead>
          <tr>
            <th>価格</th>
            <th>面積</th>
            <th>地区</th>
            <th>最寄駅</th>
          </tr>
        </thead>
        <tbody>
          ${validTx.map(t => {
            const hasP = t.TradePrice != null && !isNaN(t.TradePrice);
            const pStr = hasP ? (t.TradePrice >= 10000 ? (t.TradePrice/10000).toFixed(0) + '万' : t.TradePrice.toLocaleString() + '円') : '-';
            return `
            <tr data-tx-idx="${t._origIdx}" title="クリックで地図上のピンへ移動">
              <td class="font-medium" style="color:${hasP ? priceColor(t.TradePrice) : '#9ca3af'}">${pStr}</td>
              <td>${t.Area ? t.Area + 'm²' : '-'}</td>
              <td class="text-gray-500" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.District || '-'}</td>
              <td class="text-gray-500" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.NearestStation || '-'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function renderFooter() {
  return `
    <footer class="mt-8 py-6 border-t border-gray-200">
      <div class="text-center space-y-2">
        <div class="flex justify-center flex-wrap gap-2 mb-3"><a href="/area/mie/" class="text-xs text-blue-600 hover:underline">三重県エリア比較</a> | <a href="/area/mie/suzuka/" class="text-xs text-blue-600 hover:underline">鈴鹿市</a> | <a href="/" class="text-xs text-blue-600 hover:underline">物件比較ツール</a></div>
        <div class="flex justify-center flex-wrap gap-2 mb-3"><a href="/knowledge/cost/" class="text-xs text-blue-600 hover:underline">注文住宅の費用内訳ガイド</a> | <a href="/knowledge/flow/" class="text-xs text-blue-600 hover:underline">注文住宅の流れ・スケジュール</a> | <a href="/knowledge/land-selection/" class="text-xs text-blue-600 hover:underline">土地探しで失敗しない10のポイント</a> | <a href="/knowledge/coverage-ratio/" class="text-xs text-blue-600 hover:underline">建蔽率・容積率とは？</a> | <a href="/knowledge/mie-livability/" class="text-xs text-blue-600 hover:underline">三重県の住みやすい街ランキング</a></div>
        <p class="text-xs text-gray-400">
          データ出典: 国土交通省 不動産情報ライブラリAPI / 総務省 e-Stat API（2025年公示地価ベース）
        </p>
        <p class="text-xs text-gray-400">
          MCP接続先: <code class="bg-gray-100 px-1 rounded">mcp.n-3.ai</code> (reinfolib-real-estate-price, reinfolib-city-list)
        </p>
        <p class="text-xs text-gray-400">
          ※ 本ツールは参考情報であり、不動産購入の最終判断は専門家にご相談ください
        </p>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f3f4f6;">
          <p class="text-xs text-gray-400" style="margin-bottom:4px;"><strong>運営</strong>: <a href="/about/" style="color:#6b7280;text-decoration:underline;" rel="noopener">注文相談.com</a>（注文住宅の土地探し・費用比較をサポート）</p>
          <p class="text-xs text-gray-400" style="margin-bottom:4px;"><strong>データ更新</strong>: 2026-02-19 ｜ 国土交通省 不動産情報ライブラリAPI・地価公示データを定期取得</p>
          <p class="text-xs text-gray-300">© 注文相談.com — 本ツールの利用は無料です。不動産購入の最終判断は専門家にご相談ください。</p>
        </div>
      </div>
    </footer>
  `;
}







// ============================================================
// Chart Drawing (Chart.js)
// ============================================================
function destroyCharts() {
  Object.values(state.charts).forEach(c => { try { c.destroy(); } catch {} });
  state.charts = {};
}

function drawCompareCharts(ranked) {
  destroyCharts();

  // Bar chart: price vs score
  const barCtx = document.getElementById('chart-bar');
  if (barCtx) {
    state.charts.bar = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: ranked.map(a => a.name),
        datasets: [
          {
            label: '住宅地価格 (円/m²)',
            data: ranked.map(a => a.residentialPrice),
            backgroundColor: ranked.map((_,i) => COLORS[i % COLORS.length] + '88'),
            borderColor: ranked.map((_,i) => COLORS[i % COLORS.length]),
            borderWidth: 1,
            yAxisID: 'y',
            borderRadius: 6,
          },
          {
            label: '総合スコア',
            data: ranked.map(a => a.scores.total),
            backgroundColor: '#94a3b8' + '66',
            borderColor: '#94a3b8',
            borderWidth: 1,
            yAxisID: 'y1',
            borderRadius: 6,
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
        scales: {
          y: { position: 'left', title: { display: true, text: '円/m²', font: { size: 11 } }, ticks: { font: { size: 10 } } },
          y1: { position: 'right', title: { display: true, text: 'スコア', font: { size: 11 } }, grid: { drawOnChartArea: false }, ticks: { font: { size: 10 } } }
        }
      }
    });
  }

  // Line chart: trends
  const trendCtx = document.getElementById('chart-trend');
  if (trendCtx) {
    state.charts.trend = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: ['2020','2021','2022','2023','2024','2025'],
        datasets: AREAS.map((a,i) => ({
          label: a.name,
          data: a.trend.map(t => t.p),
          borderColor: COLORS[i % COLORS.length],
          backgroundColor: COLORS[i % COLORS.length] + '15',
          borderWidth: 2,
          pointRadius: 3,
          tension: 0.3,
          fill: false
        }))
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
        scales: {
          y: { title: { display: true, text: '円/m²', font: { size: 11 } }, ticks: { font: { size: 10 } } }
        }
      }
    });
  }
}

function drawDetailCharts(area) {
  destroyCharts();

  // Radar chart
  const radarCtx = document.getElementById('chart-radar');
  if (radarCtx) {
    state.charts.radar = new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: ['価格', '交通', '成長性', '利便性', '子育て', '自然'],
        datasets: [{
          label: area.name,
          data: [area.scores.price, area.scores.access, area.scores.growth, area.scores.living, area.scores.family, area.scores.nature],
          backgroundColor: '#3b82f6' + '30',
          borderColor: '#3b82f6',
          borderWidth: 2,
          pointBackgroundColor: '#3b82f6',
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          r: {
            beginAtZero: true, max: 100,
            ticks: { font: { size: 10 }, stepSize: 20 },
            pointLabels: { font: { size: 12 } }
          }
        }
      }
    });
  }

  // Detail trend line
  const trendCtx = document.getElementById('chart-detail-trend');
  if (trendCtx) {
    state.charts.detailTrend = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: area.trend.map(t => t.y),
        datasets: [{
          label: `${area.name} 地価推移`,
          data: area.trend.map(t => t.p),
          borderColor: '#3b82f6',
          backgroundColor: '#3b82f6' + '15',
          borderWidth: 3,
          pointRadius: 5,
          pointBackgroundColor: '#3b82f6',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { title: { display: true, text: '円/m²', font: { size: 11 } } }
        }
      }
    });
  }
}

// ============================================================
// Event Binding
// ============================================================
function bindEvents(ranked) {
  // Tab switches
  document.querySelectorAll('[data-tab]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.view = btn.dataset.tab;
      // モバイルドロワーを閉じる
      closeMobileDrawer();
      if (state.view === 'detail' && !state.selectedAreaId) {
        state.selectedAreaId = ranked[0]?.id;
      }
      render();
    });
  });

  // Weight sliders
  document.querySelectorAll('input[data-weight]').forEach(slider => {
    slider.addEventListener('input', (e) => {
      const key = e.target.dataset.weight;
      const val = parseInt(e.target.value);
      state.weights[key] = val;
      const vEl = document.getElementById(`wv-${key}`);
      if (vEl) vEl.textContent = val;
      e.target.style.background = `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${val*2}%, #e5e7eb ${val*2}%, #e5e7eb 100%)`;
      // Debounced re-render for ranking
      clearTimeout(state._renderTimeout);
      state._renderTimeout = setTimeout(() => render(), 150);
    });
  });

  // Area detail click
  document.querySelectorAll('[data-area-detail]').forEach(el => {
    el.addEventListener('click', () => {
      state.selectedAreaId = el.dataset.areaDetail;
      state.view = 'detail';
      render();
    });
  });

  // Area switch buttons
  document.querySelectorAll('[data-area-switch]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.selectedAreaId = btn.dataset.areaSwitch;
      render();
    });
  });

  // Back button
  const backBtn = document.getElementById('btn-back');
  if (backBtn) backBtn.addEventListener('click', () => { state.view = 'ranking'; render(); });

  // Detail → Map button
  const toMapBtn = document.getElementById('btn-to-map');
  if (toMapBtn) {
    toMapBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = state.selectedAreaId;
      state.view = 'map';
      render();
    });
  }
}

// ============================================================
// Initialize
// ============================================================
loadDistrictCache();
render();
// ページロード時: まず静的JSONを読み込み、なければMCP接続を案内
loadStaticData();


// === Cost Simulator ===
function csCalc() {
  const areaEl = document.getElementById('cs-area');
  if (!areaEl) return;
  const areaId = areaEl.value;
  const area = AREAS.find(a => a.id === areaId);
  if (!area) return;

  const landTsubo = parseInt(document.getElementById('cs-land').value);
  const buildTsubo = parseInt(document.getElementById('cs-building').value);
  const gradeEl = document.querySelector('input[name="cs-grade"]:checked');
  const grade = gradeEl ? parseInt(gradeEl.value) : 65;
  const downPayment = parseInt(document.getElementById('cs-down').value);
  const rate = parseFloat(document.getElementById('cs-rate').value);
  const years = parseInt(document.getElementById('cs-years').value);

  // Update display values
  document.getElementById('cs-land-val').textContent = landTsubo;
  document.getElementById('cs-building-val').textContent = buildTsubo;
  document.getElementById('cs-down-val').textContent = downPayment;
  document.getElementById('cs-rate-val').textContent = rate.toFixed(2);
  document.getElementById('cs-years-val').textContent = years;

  // Slider backgrounds
  const landPct = ((landTsubo - 30) / 70 * 100);
  document.getElementById('cs-land').style.background = 'linear-gradient(to right,#3b82f6 0%,#3b82f6 ' + landPct + '%,#e5e7eb ' + landPct + '%,#e5e7eb 100%)';
  const buildPct = ((buildTsubo - 20) / 40 * 100);
  document.getElementById('cs-building').style.background = 'linear-gradient(to right,#3b82f6 0%,#3b82f6 ' + buildPct + '%,#e5e7eb ' + buildPct + '%,#e5e7eb 100%)';
  const downPct = (downPayment / 2000 * 100);
  document.getElementById('cs-down').style.background = 'linear-gradient(to right,#10b981 0%,#10b981 ' + downPct + '%,#e5e7eb ' + downPct + '%,#e5e7eb 100%)';

  // Grade radio styling
  document.querySelectorAll('[id^="cs-grade-"]').forEach(el => { el.className = el.className.replace(/border-blue-500 bg-blue-50/g, '').trim(); });
  const gradeMap = { '50': 'cs-grade-low-label', '65': 'cs-grade-std-label', '85': 'cs-grade-hi-label' };
  const activeLabel = document.getElementById(gradeMap[String(grade)]);
  if (activeLabel) activeLabel.className += ' border-blue-500 bg-blue-50';

  // Calculations
  const tsuboPrice = area.pricePerTsubo; // yen per tsubo
  const landCost = landTsubo * tsuboPrice;
  const buildCost = buildTsubo * grade * 10000;
  const miscCost = Math.round((landCost + buildCost) * 0.08); // 8% misc costs
  const total = landCost + buildCost + miscCost;
  const loanAmount = Math.max(0, total - downPayment * 10000);

  // Monthly payment (equal principal and interest)
  let monthly = 0;
  if (loanAmount > 0 && rate > 0) {
    const r = rate / 100 / 12;
    const n = years * 12;
    monthly = Math.round(loanAmount * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1));
  } else if (loanAmount > 0) {
    monthly = Math.round(loanAmount / (years * 12));
  }

  function fmtMan(yen) {
    const man = Math.round(yen / 10000);
    if (man >= 10000) return (man / 10000).toFixed(1) + '億';
    return man.toLocaleString() + '万円';
  }

  document.getElementById('cs-land-cost').textContent = fmtMan(landCost);
  document.getElementById('cs-build-cost').textContent = fmtMan(buildCost);
  document.getElementById('cs-misc-cost').textContent = fmtMan(miscCost);
  document.getElementById('cs-total').textContent = fmtMan(total);
  document.getElementById('cs-monthly').textContent = monthly > 0 ? monthly.toLocaleString() + '円' : '-';
}
// Run on load
document.addEventListener('DOMContentLoaded', function() { setTimeout(csCalc, 100); });


// === Checklist (localStorage) ===
function clUpdate(cityId) {
  const checks = {};
  document.querySelectorAll('[data-cl-check]').forEach(cb => { checks[cb.dataset.clCheck] = cb.checked; });
  localStorage.setItem('cl_' + cityId, JSON.stringify(checks));
  const done = Object.values(checks).filter(Boolean).length;
  const total = Object.keys(checks).length;
  const el = document.getElementById('cl-progress');
  if (el) el.textContent = done + '/' + total + ' 完了';
}
function clRestore(cityId) {
  try {
    const saved = JSON.parse(localStorage.getItem('cl_' + cityId) || '{}');
    let done = 0, total = 0;
    document.querySelectorAll('[data-cl-check]').forEach(cb => {
      total++;
      if (saved[cb.dataset.clCheck]) { cb.checked = true; done++; }
    });
    const el = document.getElementById('cl-progress');
    if (el) el.textContent = done + '/' + total + ' 完了';
  } catch {}
}

// Restore checklist on load
document.addEventListener('DOMContentLoaded', function() { setTimeout(function() { clRestore('kameyama'); }, 200); });
// Hide static SEO content after JS renders
document.addEventListener('DOMContentLoaded', function() { var el = document.getElementById('seo-static'); if (el) el.style.display = 'none'; });
</script>
</body>
</html>
