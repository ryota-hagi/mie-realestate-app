<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="VBmM5Mikm2LrkY9dXa30MUHtT9KD2SpZFsoGHBuFPWM" />
<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SZV3XF0W0G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SZV3XF0W0G');
</script>
<title>ä¸‰é‡çœŒã§æ³¨æ–‡ä½å®…ã‚’å»ºã¦ã‚‹ãªã‚‰ï½œã‚¨ãƒªã‚¢åˆ¥ åœŸåœ°ç›¸å ´ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒ | æ³¨æ–‡ä½å®…æ¯”è¼ƒ.com</title>
<meta name="description" content="ä¸‰é‡çœŒåŒ—éƒ¨ã§æ³¨æ–‡ä½å®…ã‚’æ¤œè¨ä¸­ã®æ–¹ã¸ã€‚å››æ—¥å¸‚ãƒ»æ¡‘åãƒ»éˆ´é¹¿ãƒ»ã„ãªã¹ãƒ»äº€å±±ãƒ»è°é‡ãƒ»æ±å“¡ã®7ã‚¨ãƒªã‚¢ã®åœŸåœ°ä¾¡æ ¼ç›¸å ´ã€å®Ÿéš›ã®å–å¼•ãƒ‡ãƒ¼ã‚¿ã€åå¤å±‹ã‚¢ã‚¯ã‚»ã‚¹ã€å­è‚²ã¦ç’°å¢ƒã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ¯”è¼ƒã€‚å›½åœŸäº¤é€šçœãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãä¿¡é ¼æ€§ã®é«˜ã„ä¸å‹•ç”£æƒ…å ±ã§ã€ç†æƒ³ã®åœŸåœ°æ¢ã—ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚">
<meta name="keywords" content="ä¸‰é‡çœŒ,æ³¨æ–‡ä½å®…,åœŸåœ°æ¢ã—,åœŸåœ°ç›¸å ´,å››æ—¥å¸‚,æ¡‘å,éˆ´é¹¿,ã„ãªã¹,äº€å±±,è°é‡,æ±å“¡,ä¸å‹•ç”£,åœŸåœ°ä¾¡æ ¼,åå¤å±‹é€šå‹¤,å­è‚²ã¦,ä½ã¿ã‚„ã™ã•,ã‚¨ãƒªã‚¢æ¯”è¼ƒ">
<link rel="canonical" href="https://research.chuumon-soudan.com/area.html">
<!-- OGP -->
<meta property="og:title" content="ä¸‰é‡çœŒã§æ³¨æ–‡ä½å®…ã‚’å»ºã¦ã‚‹ãªã‚‰ï½œã‚¨ãƒªã‚¢åˆ¥ åœŸåœ°ç›¸å ´ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒ">
<meta property="og:description" content="ä¸‰é‡çœŒåŒ—éƒ¨7ã‚¨ãƒªã‚¢ã®åœŸåœ°ä¾¡æ ¼ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿ãƒ»å­è‚²ã¦ç’°å¢ƒã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¯”è¼ƒã€‚å›½åœŸäº¤é€šçœã®å…¬å¼ãƒ‡ãƒ¼ã‚¿ã§æ³¨æ–‡ä½å®…ã®åœŸåœ°æ¢ã—ã‚’ã‚µãƒãƒ¼ãƒˆã€‚">
<meta property="og:type" content="website">
<meta property="og:url" content="https://research.chuumon-soudan.com/area.html">
<meta property="og:site_name" content="æ³¨æ–‡ä½å®…æ¯”è¼ƒ.com">
<meta property="og:locale" content="ja_JP">
<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="ä¸‰é‡çœŒã§æ³¨æ–‡ä½å®…ã‚’å»ºã¦ã‚‹ãªã‚‰ï½œã‚¨ãƒªã‚¢åˆ¥ åœŸåœ°ç›¸å ´æ¯”è¼ƒ">
<meta name="twitter:description" content="ä¸‰é‡çœŒåŒ—éƒ¨7ã‚¨ãƒªã‚¢ã®åœŸåœ°ä¾¡æ ¼ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¯”è¼ƒã€‚æ³¨æ–‡ä½å®…ã®åœŸåœ°æ¢ã—ã«ã€‚">
<!-- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ (JSON-LD) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "ä¸‰é‡çœŒ æ³¨æ–‡ä½å®…ã‚¨ãƒªã‚¢æ¯”è¼ƒãƒ„ãƒ¼ãƒ«",
  "description": "ä¸‰é‡çœŒåŒ—éƒ¨7ã‚¨ãƒªã‚¢ã®åœŸåœ°ä¾¡æ ¼ç›¸å ´ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿ãƒ»å­è‚²ã¦ç’°å¢ƒã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ¯”è¼ƒã§ãã‚‹ç„¡æ–™ãƒ„ãƒ¼ãƒ«",
  "url": "https://research.chuumon-soudan.com/area.html",
  "applicationCategory": "RealEstate",
  "operatingSystem": "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "JPY" },
  "author": { "@type": "Organization", "name": "æ³¨æ–‡ä½å®…æ¯”è¼ƒ.com" },
  "areaServed": { "@type": "State", "name": "ä¸‰é‡çœŒ" },
  "about": [
    { "@type": "Thing", "name": "æ³¨æ–‡ä½å®…" },
    { "@type": "Thing", "name": "åœŸåœ°æ¢ã—" },
    { "@type": "Thing", "name": "ä¸å‹•ç”£ä¾¡æ ¼" }
  ]
}
</script>
<link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" as="script">
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" as="script">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* === Tailwind CSS v3.4.19 (production build) === */
  *,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sticky{position:sticky}.top-0{top:0}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-1{margin-left:.25rem}.mt-0\.5{margin-top:.125rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.h-6{height:1.5rem}.w-12{width:3rem}.w-16{width:4rem}.w-28{width:7rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-8{width:2rem}.w-full{width:100%}.min-w-0{min-width:0}.max-w-6xl{max-width:72rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity,1))}.border-blue-100{--tw-border-opacity:1;border-color:rgb(219 234 254/var(--tw-border-opacity,1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-50{--tw-border-opacity:1;border-color:rgb(249 250 251/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.bg-amber-500{--tw-bg-opacity:1;background-color:rgb(245 158 11/var(--tw-bg-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgb(156 163 175/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94/var(--tw-bg-opacity,1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity,1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255/var(--tw-bg-opacity,1))}.bg-slate-400{--tw-bg-opacity:1;background-color:rgb(148 163 184/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.p-2{padding:.5rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.leading-relaxed{line-height:1.625}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-amber-800{--tw-text-opacity:1;color:rgb(146 64 14/var(--tw-text-opacity,1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.shadow-md,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.outline{outline-style:solid}.blur{--tw-blur:blur(8px)}.blur,.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-filter{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity,1))}@media (min-width:640px){.sm\:block{display:block}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}@media (min-width:768px){.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  * { font-family: 'Noto Sans JP', sans-serif; }
  body { background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 50%, #f5f0ff 100%); min-height: 100vh; }
  .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); }
  .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; transition: all 0.2s; }
  .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .medal-gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
  .medal-silver { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
  .medal-bronze { background: linear-gradient(135deg, #CD7F32, #B8860B); }
  input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 3px; outline: none; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #3b82f6; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  .tab-active { background: #3b82f6; color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }
  .score-bar { height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; }
  .score-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .pulse-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 500; }
  /* Map styles */
  .map-layout { display: flex; gap: 0; height: 600px; }
  #map-container { flex: 1; min-height: 400px; border-radius: 12px 0 0 12px; overflow: hidden; z-index: 1; }
  #map-sidebar { width: 340px; background: white; border-left: 1px solid #e5e7eb; border-radius: 0 12px 12px 0; overflow-y: auto; padding: 0; }
  .leaflet-container { font-family: 'Noto Sans JP', sans-serif; }
  .map-marker-icon { transition: transform 0.2s; }
  .map-marker-icon:hover { transform: scale(1.15); }
  .sidebar-header { padding: 16px; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; z-index: 2; }
  .sidebar-body { padding: 16px; }
  .tx-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .tx-table th { background: #f9fafb; padding: 6px 8px; text-align: left; font-weight: 500; color: #6b7280; position: sticky; top: 0; }
  .tx-table td { padding: 6px 8px; border-top: 1px solid #f3f4f6; }
  .tx-table tr[data-tx-idx] { cursor: pointer; transition: background 0.15s; }
  .tx-table tr[data-tx-idx]:hover { background: #dbeafe; }
  .tx-table tr.tx-active { background: #bfdbfe; }
  /* School district toggle */
  .school-toggle { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; user-select: none; transition: all 0.2s; border: 1px solid #d1d5db; background: white; }
  .school-toggle.active { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
  .school-toggle:hover { background: #f3f4f6; }
  .school-toggle.active:hover { background: #bfdbfe; }
  /* School icon markers */
  .school-icon-marker { background: none !important; border: none !important; }
  /* Map loading overlay */
  .map-loading-overlay {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 800;
    background: rgba(0,0,0,0.25); display: flex; flex-direction: column;
    align-items: center; justify-content: center; pointer-events: none;
    transition: opacity 0.3s;
  }
  .map-loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .map-loading-box {
    background: white; border-radius: 12px; padding: 16px 28px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18); text-align: center;
    animation: mapLoadBounce 2s ease-in-out infinite;
  }
  @keyframes mapLoadBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
  .map-loading-spinner {
    width: 32px; height: 32px; border: 3px solid #e5e7eb;
    border-top-color: #3b82f6; border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 0 auto 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .map-loading-progress {
    width: 120px; height: 4px; background: #e5e7eb; border-radius: 2px;
    margin: 8px auto 0; overflow: hidden;
  }
  .map-loading-progress-bar {
    height: 100%; background: #3b82f6; border-radius: 2px;
    transition: width 0.3s ease;
  }
  /* Fullscreen map */
  .map-fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; border-radius: 0 !important; margin: 0;
  }
  .map-fullscreen #map-container { border-radius: 0; height: 100vh; }
  .map-fullscreen #map-sidebar { border-radius: 0; height: 100vh; }
  .map-fullscreen-controls {
    position: fixed; top: 12px; left: 50%; transform: translateX(-50%); z-index: 10001;
    background: rgba(255,255,255,0.92); backdrop-filter: blur(8px);
    padding: 8px 12px; border-radius: 10px; display: none;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    gap: 8px; align-items: center;
  }
  .map-fullscreen-controls.visible { display: flex; }
  .map-fullscreen-btn {
    display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px;
    border-radius: 6px; font-size: 12px; cursor: pointer; user-select: none;
    transition: all 0.2s; border: 1px solid #d1d5db; background: white; color: #374151;
  }
  .map-fullscreen-btn:hover { background: #f3f4f6; }
  .map-fullscreen-btn.active { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
  @media (max-width: 768px) {
    .map-layout { flex-direction: column; height: auto; min-height: 400px; }
    #map-container { height: 400px; min-height: 400px; border-radius: 12px 12px 0 0; }
    #map-sidebar { width: 100%; border-left: none; border-top: 1px solid #e5e7eb; border-radius: 0 0 12px 12px; max-height: 350px; }
    .map-fullscreen #map-sidebar { height: auto; max-height: 40vh; }
  }
  /* === Second Opinion Feature === */
  .so-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; }
  .so-modal { background: white; border-radius: 16px; max-width: 560px; width: 90%; max-height: 85vh; overflow-y: auto; padding: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
  .so-fixed-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border-top: 1px solid #e5e7eb; padding: 12px 16px; z-index: 100; display: flex; align-items: center; justify-content: center; gap: 16px; box-shadow: 0 -2px 10px rgba(0,0,0,0.08); }
  .so-badge-yellow { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-red { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-badge-none { background: #f0fdf4; color: #166534; border: 1px solid #86efac; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .so-compare-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .so-compare-table th, .so-compare-table td { padding: 8px 12px; border: 1px solid #e5e7eb; text-align: left; }
  .so-compare-table th { background: #f9fafb; font-weight: 600; white-space: nowrap; }
  .so-compare-table .missing { color: #d97706; font-style: italic; }
  .so-radio-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .so-radio-group label { padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
  .so-radio-group label:hover { border-color: #3b82f6; background: #eff6ff; }
  .so-radio-group input:checked + span { color: #1d4ed8; }
  .so-radio-group label:has(input:checked) { border-color: #3b82f6; background: #dbeafe; }
  /* === Compare Filter UI (Pattern C) === */
  .cmp-filter-tag { display: inline-flex; align-items: center; gap: 4px; padding: 7px 13px; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: 1.5px solid #e5e7eb; background: white; color: #6b7280; user-select: none; }
  .cmp-filter-tag:hover { border-color: #93c5fd; color: #3b82f6; }
  .cmp-filter-tag.active { background: #3b82f6; color: white; border-color: #3b82f6; }
  .cmp-filter-tag .cmp-tag-x { margin-left: 4px; opacity: 0.7; cursor: pointer; }
  .cmp-filter-tag .cmp-tag-x:hover { opacity: 1; }
  .cmp-add-col-btn { display: inline-flex; align-items: center; gap: 4px; padding: 7px 13px; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: 1.5px dashed #d1d5db; background: transparent; color: #9ca3af; }
  .cmp-add-col-btn:hover { border-color: #3b82f6; color: #3b82f6; }
  .cmp-preset-btn { padding: 5px 13px; border-radius: 16px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: 1px solid #e5e7eb; background: white; color: #6b7280; }
  .cmp-preset-btn:hover { border-color: #3b82f6; color: #3b82f6; background: #eff6ff; }
  .cmp-row { background: white; border-radius: 10px; padding: 13px 14px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; border: 1px solid #f3f4f6; display: flex; align-items: center; gap: 10px; }
  .cmp-row:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); border-color: #bfdbfe; }
  .cmp-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
  .cmp-modal-overlay.open { opacity: 1; pointer-events: auto; }
  .cmp-modal-body { background: white; border-radius: 20px; max-width: 560px; width: 92%; max-height: 85vh; overflow-y: auto; padding: 24px; box-shadow: 0 25px 60px rgba(0,0,0,0.15); transform: translateY(20px); transition: transform 0.3s; }
  .cmp-modal-overlay.open .cmp-modal-body { transform: translateY(0); }
  .cmp-score-bar { height: 5px; border-radius: 3px; background: #e5e7eb; overflow: hidden; }
  .cmp-score-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  @media (max-width: 768px) {
    .comp-layout-sidebar { flex-direction: column !important; }
    .comp-layout-sidebar > div:first-child { width: 100% !important; }
    .comp-layout-sidebar > div:first-child .sticky { position: relative !important; top: 0 !important; }
    .mobile-title-text { font-size: 1.1rem; }
    .mobile-subtitle-text { font-size: 0.75rem; }
    #mobile-menu-fab, #mobile-drawer-overlay, #mobile-drawer-panel { display: block !important; }
    #mobile-menu-fab { display: flex !important; }
    #pc-nav-bar { display: none !important; }
    #global-nav-links { display: none !important; }
    .cmp-modal-body { max-width: 100%; width: 100%; max-height: 100vh; border-radius: 16px 16px 0 0; height: auto; position: fixed; bottom: 0; left: 0; right: 0; max-height: 90vh; }
  }
</style>
</head>
<body>
<div id="app"></div>

<!-- Compare Detail Modal -->
<div id="cmp-detail-modal" class="cmp-modal-overlay">
  <div class="cmp-modal-body" id="cmp-detail-modal-body"></div>
</div>
<!-- Compare Column Selector Modal -->
<div id="cmp-col-modal" class="cmp-modal-overlay">
  <div class="cmp-modal-body" id="cmp-col-modal-body"></div>
</div>

<script>
// ============================================================
// è¨­å®š â€” ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã“ã“ã‚’ç·¨é›†
// ============================================================
const CONFIG = {
  // ãƒ—ãƒ­ã‚­ã‚·URLï¼ˆSupabase Edge Functionï¼‰
  PROXY_URL: 'https://jvfmvitknqnmuduyscnl.supabase.co/functions/v1/mcp-proxy',

  // MCPã‚µãƒ¼ãƒãƒ¼URLï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§æ¥ç¶šï¼‰
  MCP_REINFO: 'https://mcp.n-3.ai/mcp?tools=get-time,reinfolib-real-estate-price,reinfolib-city-list',
  MCP_ESTAT: 'https://mcp.n-3.ai/mcp?tools=e-stat-get-stats-list,e-stat-get-meta-info,e-stat-get-data-catalog',
};





// ============================================================
// MCP Streamable HTTP Client (with proxy support)
// ============================================================
class MCPClient {
  constructor(mcpUrl, proxyUrl) {
    this.mcpUrl = mcpUrl;
    this.proxyUrl = proxyUrl;
    this.sessionId = null;
    this.requestId = 0;
    this.connected = false;
    this.tools = [];
    this.useProxy = !!proxyUrl;
  }

  _buildFetchUrl() {
    if (this.useProxy) {
      return `${this.proxyUrl}?url=${encodeURIComponent(this.mcpUrl)}`;
    }
    return this.mcpUrl;
  }

  async initialize() {
    // Try proxy first, then direct
    const attempts = this.useProxy
      ? [true, false]  // proxy â†’ direct
      : [false];       // direct only

    let lastError;
    for (const viaProxy of attempts) {
      try {
        this.useProxy = viaProxy;
        const url = this._buildFetchUrl();

        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/event-stream',
          },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: ++this.requestId,
            method: 'initialize',
            params: {
              protocolVersion: '2025-03-26',
              capabilities: {},
              clientInfo: { name: 'yume-no-sumika-realestate', version: '1.0.0' }
            }
          })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const sid = res.headers.get('Mcp-Session-Id');
        if (sid) this.sessionId = sid;

        const data = await this._parseResponse(res);

        // Send initialized notification
        const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
        if (this.sessionId) headers['Mcp-Session-Id'] = this.sessionId;

        await fetch(this._buildFetchUrl(), {
          method: 'POST',
          headers,
          body: JSON.stringify({ jsonrpc: '2.0', method: 'notifications/initialized' })
        });

        this.connected = true;
        console.log(`MCP connected via ${viaProxy ? 'proxy' : 'direct'}`);
        return data;
      } catch (e) {
        lastError = e;
        console.warn(`MCP ${viaProxy ? 'proxy' : 'direct'} failed:`, e.message);
      }
    }
    this.connected = false;
    throw lastError;
  }

  async listTools() {
    const data = await this._request('tools/list', {});
    if (data && data.tools) this.tools = data.tools;
    return this.tools;
  }

  async callTool(name, args = {}) {
    return this._request('tools/call', { name, arguments: args });
  }

  async _request(method, params) {
    const url = this._buildFetchUrl();
    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json, text/event-stream' };
    if (this.sessionId) headers['Mcp-Session-Id'] = this.sessionId;

    const res = await fetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify({ jsonrpc: '2.0', id: ++this.requestId, method, params })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return this._parseResponse(res);
  }

  async _parseResponse(res) {
    const ct = res.headers.get('Content-Type') || '';
    if (ct.includes('text/event-stream')) {
      const text = await res.text();
      const lines = text.split('\n');
      let lastData = null;
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try { lastData = JSON.parse(line.slice(6)); } catch {}
        }
      }
      return lastData?.result || lastData;
    }
    const json = await res.json();
    return json.result || json;
  }
}

// ============================================================
// Pre-loaded Area Data (fallback + base data)
// ============================================================
const AREAS = [
  {
    id: "yokkaichi", name: "å››æ—¥å¸‚å¸‚", cityCode: "24202", lat: 34.9650, lng: 136.6244,
    landPriceAvg: 57020, residentialPrice: 48385, commercialPrice: 89007, pricePerTsubo: 188498,
    yoyChange: 1.33, population: 311000, popGrowthRate: -0.3, accessToNagoya: 35,
    hospitals: 42, schools: 58, parks: 35, shopping: 120, safetyScore: 78, childcareScore: 82, naturalScore: 55,
    description: "ä¸‰é‡çœŒæœ€å¤§ã®éƒ½å¸‚ã€‚çŸ³æ²¹åŒ–å­¦ã‚³ãƒ³ãƒ“ãƒŠãƒ¼ãƒˆã¨æ¸¯æ¹¾ã‚’æ“ã™ã‚‹ç”£æ¥­éƒ½å¸‚ã€‚è¿‘é‰„ãƒ»JRä¸¡ç·šã§åå¤å±‹ã¸ç›´é€šã€‚å¤§å‹å•†æ¥­æ–½è¨­ãŒå……å®Ÿã—ã€åŒ»ç™‚ãƒ»æ•™è‚²ã‚¤ãƒ³ãƒ•ãƒ©ã‚‚çœŒå†…ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã€‚",
    highlights: ["çœŒå†…æœ€å¤§ã®å•†æ¥­é›†ç©", "åå¤å±‹ã¸35åˆ†", "åŒ»ç™‚æ–½è¨­å……å®Ÿ", "æ±åé˜ªãƒ»æ–°åç¥IC"],
    risks: ["ä¸€éƒ¨åœ°åŸŸã®å¤§æ°—ç’°å¢ƒ", "ä¸­å¿ƒéƒ¨ã®åœ°ä¾¡ä¸Šæ˜‡"],
    trend: [{y:"2020",p:52000},{y:"2021",p:53200},{y:"2022",p:54500},{y:"2023",p:55800},{y:"2024",p:56300},{y:"2025",p:57020}],
    recAreas: ["å¯Œç”°ãƒ»å¯Œæ´²åŸã‚¨ãƒªã‚¢ï¼ˆé§…è¿‘ã§å‰²å®‰ï¼‰","ç¬¹å·ãƒ»æ—¥æ°¸ã‚¨ãƒªã‚¢ï¼ˆä½ç’°å¢ƒè‰¯å¥½ï¼‰","æ°´æ²¢ãƒ»å°å±±ç”°ã‚¨ãƒªã‚¢ï¼ˆè‡ªç„¶è±Šã‹ï¼‰"]
  },
  {
    id: "kuwana", name: "æ¡‘åå¸‚", cityCode: "24205", lat: 35.0585, lng: 136.6834,
    landPriceAvg: 55543, residentialPrice: 53686, commercialPrice: 86714, pricePerTsubo: 183614,
    yoyChange: 0.82, population: 140000, popGrowthRate: -0.5, accessToNagoya: 25,
    hospitals: 18, schools: 28, parks: 22, shopping: 55, safetyScore: 82, childcareScore: 85, naturalScore: 68,
    description: "åå¤å±‹ã¸ã®é€šå‹¤åœã¨ã—ã¦äººæ°—ã€‚æ¡‘åé§…ã‹ã‚‰åå¤å±‹ã¾ã§æœ€çŸ­25åˆ†ã€‚ãƒŠã‚¬ã‚·ãƒã‚¹ãƒ‘ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚„ãªã°ãªã®é‡Œãªã©è¦³å…‰è³‡æºã‚‚è±Šå¯Œã€‚æ­´å²çš„ãªåŸä¸‹ç”ºã®é¢¨æƒ…ãŒæ®‹ã‚‹ã€‚",
    highlights: ["åå¤å±‹ã¸æœ€çŸ­25åˆ†","å­è‚²ã¦ç’°å¢ƒâ—","è¦³å…‰è³‡æºè±Šå¯Œ","ä½ç’°å¢ƒã®è‰¯ã•"],
    risks: ["æ–æ–å·ãƒ»é•·è‰¯å·ã®æ´ªæ°´ãƒªã‚¹ã‚¯","äººå£æ¸›å°‘å‚¾å‘"],
    trend: [{y:"2020",p:52500},{y:"2021",p:53000},{y:"2022",p:53800},{y:"2023",p:54500},{y:"2024",p:55100},{y:"2025",p:55543}],
    recAreas: ["æ¡‘åé§…å‘¨è¾ºï¼ˆåˆ©ä¾¿æ€§é‡è¦–ï¼‰","å¤šåº¦ã‚¨ãƒªã‚¢ï¼ˆè‡ªç„¶ã¨ä¾¡æ ¼ãƒãƒ©ãƒ³ã‚¹ï¼‰","é•·å³¶ã‚¨ãƒªã‚¢ï¼ˆã‚†ã£ãŸã‚Šå±…ä½ï¼‰"]
  },
  {
    id: "suzuka", name: "éˆ´é¹¿å¸‚", cityCode: "24207", lat: 34.8824, lng: 136.5842,
    landPriceAvg: 41015, residentialPrice: 38000, commercialPrice: 62000, pricePerTsubo: 135587,
    yoyChange: 1.11, population: 195000, popGrowthRate: -0.2, accessToNagoya: 55,
    hospitals: 25, schools: 42, parks: 28, shopping: 72, safetyScore: 80, childcareScore: 80, naturalScore: 65,
    description: "éˆ´é¹¿ã‚µãƒ¼ã‚­ãƒƒãƒˆã¨HondaæŠ€ç ”ã®ä¼æ¥­åŸä¸‹ç”ºã€‚åå¤å±‹åœã¨æ¯”ã¹åœ°ä¾¡ãŒæ‰‹é ƒã§ã€åºƒã„åœŸåœ°ã‚’ç¢ºä¿ã—ã‚„ã™ã„ã€‚æ–°åç¥éˆ´é¹¿ã‚¹ãƒãƒ¼ãƒˆICã®é–‹é€šã§äº¤é€šåˆ©ä¾¿æ€§ãŒå‘ä¸Šã€‚",
    highlights: ["åœ°ä¾¡ãŒæ‰‹é ƒã§åºƒã„å®¶ãŒå»ºã¦ã‚„ã™ã„","Hondaé–¢é€£ã®é›‡ç”¨å®‰å®š","æ–°åç¥ã‚¹ãƒãƒ¼ãƒˆIC","ä¸­å‹¢ãƒã‚¤ãƒ‘ã‚¹æ•´å‚™"],
    risks: ["åå¤å±‹é€šå‹¤ã«ã¯ã‚„ã‚„é ã„","æ²¿å²¸éƒ¨ã®æ´¥æ³¢ãƒªã‚¹ã‚¯"],
    trend: [{y:"2020",p:38500},{y:"2021",p:39000},{y:"2022",p:39600},{y:"2023",p:40200},{y:"2024",p:40600},{y:"2025",p:41015}],
    recAreas: ["ç™½å­é§…å‘¨è¾ºï¼ˆåˆ©ä¾¿æ€§â—ï¼‰","å¹³ç”°ãƒ»ç®—æ‰€ã‚¨ãƒªã‚¢ï¼ˆè½ã¡ç€ã„ãŸä½å®…åœ°ï¼‰","åº„é‡ãƒ»åŠ ä½ç™»ã‚¨ãƒªã‚¢ï¼ˆæ–°èˆˆä½å®…åœ°ï¼‰"]
  },
  {
    id: "inabe", name: "ã„ãªã¹å¸‚", cityCode: "24212", lat: 35.1146, lng: 136.5612,
    landPriceAvg: 24500, residentialPrice: 22000, commercialPrice: 35000, pricePerTsubo: 81000,
    yoyChange: 0.45, population: 44000, popGrowthRate: -0.8, accessToNagoya: 65,
    hospitals: 6, schools: 14, parks: 18, shopping: 15, safetyScore: 88, childcareScore: 75, naturalScore: 95,
    description: "éˆ´é¹¿å±±è„ˆã®éº“ã«åºƒãŒã‚‹è‡ªç„¶è±Šã‹ãªã¾ã¡ã€‚ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ãƒ¬ã‚¸ãƒ£ãƒ¼ãŒå……å®Ÿã—ã€ç§»ä½å…ˆã¨ã—ã¦æ³¨ç›®åº¦ä¸Šæ˜‡ä¸­ã€‚åœ°ä¾¡ã¯çœŒåŒ—éƒ¨ã§æœ€ã‚‚æ‰‹é ƒãªæ°´æº–ã€‚",
    highlights: ["åœ§å€’çš„ãªè‡ªç„¶ç’°å¢ƒ","åœ°ä¾¡ãŒéå¸¸ã«æ‰‹é ƒ","ç§»ä½æ”¯æ´åˆ¶åº¦å……å®Ÿ","ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢å¤©å›½"],
    risks: ["å•†æ¥­æ–½è¨­ãŒå°‘ãªã„","å…¬å…±äº¤é€šãŒä¸ä¾¿","äººå£æ¸›å°‘"],
    trend: [{y:"2020",p:23500},{y:"2021",p:23700},{y:"2022",p:23900},{y:"2023",p:24100},{y:"2024",p:24300},{y:"2025",p:24500}],
    recAreas: ["åŒ—å‹¢ã‚¨ãƒªã‚¢ï¼ˆé§…è¿‘ãƒ»åˆ©ä¾¿æ€§ï¼‰","å“¡å¼ã‚¨ãƒªã‚¢ï¼ˆé–‘é™ãªä½å®…åœ°ï¼‰","è—¤åŸã‚¨ãƒªã‚¢ï¼ˆå±±é–“éƒ¨ãƒ»æ ¼å®‰ï¼‰"]
  },
  {
    id: "kameyama", name: "äº€å±±å¸‚", cityCode: "24210", lat: 34.8540, lng: 136.4520,
    landPriceAvg: 29500, residentialPrice: 27000, commercialPrice: 42000, pricePerTsubo: 97500,
    yoyChange: 0.68, population: 49000, popGrowthRate: -0.6, accessToNagoya: 60,
    hospitals: 8, schools: 16, parks: 15, shopping: 22, safetyScore: 85, childcareScore: 76, naturalScore: 80,
    description: "æ±åé˜ªã¨æ–°åç¥ãŒäº¤å·®ã™ã‚‹äº¤é€šã®è¦è¡ã€‚æ—§æ±æµ·é“ã®å®¿å ´ç”ºã®æ­´å²ã‚’æŒã¤ã€‚Sharpäº€å±±å·¥å ´ã‚’ã¯ã˜ã‚è£½é€ æ¥­ãŒé›†ç©ã€‚",
    highlights: ["é«˜é€Ÿé“è·¯ã®çµç¯€ç‚¹","è£½é€ æ¥­ã®é›‡ç”¨","æ­´å²çš„ãªè¡—ä¸¦ã¿","å‰²å®‰ãªåœ°ä¾¡"],
    risks: ["JRã®æœ¬æ•°ãŒå°‘ãªã„","å•†æ¥­æ–½è¨­ãŒé™å®šçš„"],
    trend: [{y:"2020",p:28000},{y:"2021",p:28300},{y:"2022",p:28700},{y:"2023",p:29000},{y:"2024",p:29200},{y:"2025",p:29500}],
    recAreas: ["äº€å±±é§…å‘¨è¾ºï¼ˆJRã‚¢ã‚¯ã‚»ã‚¹ï¼‰","é–¢ã‚¨ãƒªã‚¢ï¼ˆå®¿å ´ç”ºã®é¢¨æƒ…ï¼‰","é‡æ‘ã‚¨ãƒªã‚¢ï¼ˆæ–°èˆˆä½å®…åœ°ï¼‰"]
  },
  {
    id: "komono", name: "è°é‡ç”º", cityCode: "24341", lat: 35.0244, lng: 136.5090,
    landPriceAvg: 31000, residentialPrice: 29000, commercialPrice: 45000, pricePerTsubo: 102500,
    yoyChange: 0.55, population: 41000, popGrowthRate: -0.1, accessToNagoya: 50,
    hospitals: 7, schools: 12, parks: 20, shopping: 25, safetyScore: 86, childcareScore: 83, naturalScore: 92,
    description: "å¾¡åœ¨æ‰€å²³ã¨æ¹¯ã®å±±æ¸©æ³‰ã‚’æŠ±ãˆã‚‹è¦³å…‰ã¨è‡ªç„¶ã®ã¾ã¡ã€‚è¿‘é‰„æ¹¯ã®å±±ç·šã§å››æ—¥å¸‚ã¸ç›´é€šã€‚äººå£æ¸›å°‘ç‡ãŒä½ãã€ç§»ä½å…ˆã¨ã—ã¦äººæ°—ãŒé«˜ã„ã€‚",
    highlights: ["æ¸©æ³‰ã¨è‡ªç„¶ç’°å¢ƒ","äººå£æ¸›å°‘ç‡ãŒä½ã„","å››æ—¥å¸‚ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è‰¯å¥½","ç§»ä½äººæ°—ä¸Šæ˜‡ä¸­"],
    risks: ["é‰„é“ã¯æ¹¯ã®å±±ç·šã®ã¿","å¤§å‹å•†æ¥­æ–½è¨­ãŒå°‘ãªã„"],
    trend: [{y:"2020",p:29500},{y:"2021",p:29800},{y:"2022",p:30200},{y:"2023",p:30500},{y:"2024",p:30800},{y:"2025",p:31000}],
    recAreas: ["è°é‡é§…å‘¨è¾ºï¼ˆåˆ©ä¾¿æ€§é‡è¦–ï¼‰","æ¹¯ã®å±±ã‚¨ãƒªã‚¢ï¼ˆæ¸©æ³‰ãƒ»è‡ªç„¶ï¼‰","ç«¹æˆãƒ»åƒè‰ã‚¨ãƒªã‚¢ï¼ˆé–‘é™ï¼‰"]
  },
  {
    id: "toin", name: "æ±å“¡ç”º", cityCode: "24343", lat: 35.0690, lng: 136.6030,
    landPriceAvg: 35500, residentialPrice: 33000, commercialPrice: 48000, pricePerTsubo: 117400,
    yoyChange: 0.72, population: 26000, popGrowthRate: 0.1, accessToNagoya: 40,
    hospitals: 5, schools: 8, parks: 12, shopping: 18, safetyScore: 87, childcareScore: 88, naturalScore: 72,
    description: "ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«æ±å“¡ã‚’ä¸­å¿ƒã«å•†æ¥­æ–½è¨­ãŒå……å®Ÿã—ãŸã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚·ãƒ†ã‚£ã€‚äººå£ãŒå¾®å¢—å‚¾å‘ã§ãƒ•ã‚¡ãƒŸãƒªãƒ¼å±¤ã«äººæ°—ã€‚",
    highlights: ["äººå£å¢—åŠ å‚¾å‘","ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«æ±å“¡","å­è‚²ã¦ä¸–ä»£ã«äººæ°—","ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã§ä½ã¿ã‚„ã™ã„"],
    risks: ["é‰„é“ã‚¢ã‚¯ã‚»ã‚¹ãŒé™å®šçš„","ç”ºåŸŸãŒç‹­ã„"],
    trend: [{y:"2020",p:33500},{y:"2021",p:34000},{y:"2022",p:34500},{y:"2023",p:35000},{y:"2024",p:35200},{y:"2025",p:35500}],
    recAreas: ["æ±å“¡é§…å‘¨è¾ºï¼ˆé§…è¿‘ï¼‰","ç¬¹å°¾ã‚¨ãƒªã‚¢ï¼ˆãƒ•ã‚¡ãƒŸãƒªãƒ¼å‘ã‘ï¼‰","åŸå±±ã‚¨ãƒªã‚¢ï¼ˆæ–°èˆˆä½å®…åœ°ï¼‰"]
  }
];

const COLORS = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4'];

// ============================================================
// App State
// ============================================================
const state = {
  view: 'ranking',
  selectedAreaId: null,
  mapSelectedAreaId: null,
  mcpStatus: 'disconnected', // disconnected | connecting | connected | error
  mcpMessage: '',
  mcpLiveData: null,
  weights: { price: 25, access: 20, growth: 15, living: 15, family: 15, nature: 10 },
  charts: {},
  mapSelectedDistrict: null,  // { cityId, districtName } or null
  cmpSelectedColumns: ['pricePerTsubo','accessToNagoya','total'],
  cmpCharts: {},
  weightsExpanded: false, // collapsed by default
};

// ============================================================
// Weight Presets (for collapsible weights box)
// ============================================================
const WEIGHT_PRESETS = {
  kosodate: { label: 'ğŸ¼ å­è‚²ã¦é‡è¦–', weights: { price: 10, access: 10, growth: 5, living: 20, family: 35, nature: 20 } },
  tsuukin:  { label: 'ğŸšƒ é€šå‹¤é‡è¦–',  weights: { price: 15, access: 35, growth: 20, living: 15, family: 10, nature: 5 } },
  kakaku:   { label: 'ğŸ’° ä¾¡æ ¼é‡è¦–',  weights: { price: 35, access: 10, growth: 25, living: 15, family: 10, nature: 5 } },
};

// ============================================================
// Compare Columns & Presets (Pattern C)
// ============================================================
const CMP_COLUMNS = [
  { key: 'pricePerTsubo', label: 'åªå˜ä¾¡', icon: 'ğŸ’°', format: v => `${(v/10000).toFixed(1)}ä¸‡å††` },
  { key: 'accessToNagoya', label: 'åå¤å±‹è·é›¢', icon: 'ğŸšƒ', format: v => `${v}åˆ†` },
  { key: 'total', label: 'ç·åˆã‚¹ã‚³ã‚¢', icon: 'ğŸ“Š', format: v => `${v}pt`, isScore: true },
  { key: 'residentialPrice', label: 'ä½å®…åœ°ä¾¡æ ¼', icon: 'ğŸ ', format: v => `${(v/10000).toFixed(1)}ä¸‡/mÂ²` },
  { key: 'population', label: 'äººå£', icon: 'ğŸ‘¥', format: v => `${(v/10000).toFixed(1)}ä¸‡äºº` },
  { key: 'popGrowthRate', label: 'äººå£å¢—æ¸›ç‡', icon: 'ğŸ“ˆ', format: v => `${v > 0 ? '+' : ''}${v}%` },
  { key: 'yoyChange', label: 'åœ°ä¾¡å¤‰å‹•ç‡', icon: 'ğŸ“‰', format: v => `+${v}%` },
  { key: 'hospitals', label: 'åŒ»ç™‚æ–½è¨­', icon: 'ğŸ¥', format: v => `${v}ä»¶` },
  { key: 'schools', label: 'å­¦æ ¡æ•°', icon: 'ğŸ«', format: v => `${v}æ ¡` },
  { key: 'parks', label: 'å…¬åœ’æ•°', icon: 'ğŸŒ³', format: v => `${v}ç®‡æ‰€` },
  { key: 'shopping', label: 'å•†æ¥­æ–½è¨­', icon: 'ğŸ›’', format: v => `${v}ä»¶` },
  { key: 'price', label: 'ä¾¡æ ¼ã‚¹ã‚³ã‚¢', icon: 'ğŸ’', format: v => `${v}pt`, isScore: true },
  { key: 'access', label: 'äº¤é€šã‚¹ã‚³ã‚¢', icon: 'ğŸš„', format: v => `${v}pt`, isScore: true },
  { key: 'growth', label: 'æˆé•·ã‚¹ã‚³ã‚¢', icon: 'ğŸŒ±', format: v => `${v}pt`, isScore: true },
  { key: 'living', label: 'åˆ©ä¾¿ã‚¹ã‚³ã‚¢', icon: 'ğŸª', format: v => `${v}pt`, isScore: true },
  { key: 'family', label: 'å­è‚²ã‚¹ã‚³ã‚¢', icon: 'ğŸ‘¶', format: v => `${v}pt`, isScore: true },
  { key: 'nature', label: 'è‡ªç„¶ã‚¹ã‚³ã‚¢', icon: 'ğŸƒ', format: v => `${v}pt`, isScore: true },
];
const CMP_PRESETS = {
  kosodate: { label: 'ğŸ¼ å­è‚²ã¦é‡è¦–', cols: ['pricePerTsubo','family','schools','parks','hospitals'] },
  tsuukin: { label: 'ğŸšƒ é€šå‹¤é‡è¦–', cols: ['accessToNagoya','access','pricePerTsubo','total'] },
  kakaku: { label: 'ğŸ’° ä¾¡æ ¼é‡è¦–', cols: ['pricePerTsubo','residentialPrice','yoyChange','price'] },
};
function getCmpVal(area, key) {
  if (['price','access','growth','living','family','nature','total'].includes(key)) return area.scores[key];
  return area[key];
}

// Map globals (persistent across renders)
let mapInstance = null;
let mapMarkers = {};
let txMarkerLayer = null; // LayerGroup for transaction markers
let schoolDistrictLayer = null; // GeoJSON layer for school district polygons
let schoolMarkerLayer = null; // LayerGroup for school icon markers
let schoolDistrictData = null; // cached GeoJSON data
let showSchoolDistricts = false; // toggle state
let districtAreaLayer = null; // LayerGroup for district area circles
let showDistrictAreas = false; // toggle state

// ============================================================
// Score Calculation
// ============================================================
function calcScores(area, w) {
  const priceScore = 100 - ((area.residentialPrice - 20000) / 40000) * 100;
  const accessScore = ((70 - area.accessToNagoya) / 70) * 100;
  const growthScore = Math.min(100, Math.max(0, (area.yoyChange / 2) * 100));
  const livingScore = (area.hospitals/45)*25 + (area.schools/60)*25 + (area.shopping/120)*25 + (area.safetyScore/100)*25;
  const familyScore = (area.childcareScore + area.safetyScore + Math.min(100,(area.parks/35)*100)) / 3;
  const natureScore = area.naturalScore;
  const total = priceScore*(w.price/100) + accessScore*(w.access/100) + growthScore*(w.growth/100) + livingScore*(w.living/100) + familyScore*(w.family/100) + natureScore*(w.nature/100);
  return { price: Math.round(priceScore), access: Math.round(accessScore), growth: Math.round(growthScore), living: Math.round(livingScore), family: Math.round(familyScore), nature: Math.round(natureScore), total: Math.round(total) };
}

function getRankedAreas() {
  return AREAS.map(a => ({ ...a, scores: calcScores(a, state.weights) })).sort((a,b) => b.scores.total - a.scores.total);
}

// ============================================================
// Static Data Loading (from pre-fetched JSON)
// ============================================================
async function loadStaticData() {
  try {
    updateStatusText('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
    const res = await fetch('data/live-data.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    applyStaticData(data);
    return true;
  } catch (e) {
    console.log('Static data not available:', e.message);
    return false;
  }
}

function applyStaticData(data) {
  for (const area of AREAS) {
    const src = data.areas[area.id];
    if (!src) continue;
    area._liveTransactions = src.transactions;
    area._liveAvgTradePrice = src.avgTradePrice;
    area._liveTransactionCount = src.transactionCount;
    AREA_FULL_LOADED.add(area.id);
  }

  state.mcpStatus = 'connected';
  state.fetchedAt = data.fetchedAt;

  let totalTx = 0;
  AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });

  const fetchDate = new Date(data.fetchedAt).toLocaleDateString('ja-JP');
  state.mcpMessage = `ãƒ‡ãƒ¼ã‚¿èª­è¾¼å®Œäº†ï¼ˆ${fetchDate}å–å¾—ãƒ»è¨ˆ${totalTx.toLocaleString()}ä»¶ï¼‰`;

  render();

  // ãƒãƒƒãƒ—è¡¨ç¤ºä¸­ãªã‚‰ãƒ”ãƒ³è¡¨ç¤º
  if (state.view === 'map' && txMarkerLayer) {
    showAllTransactionPins();
  }
}

// ============================================================
// MCP Connection
// ============================================================
let mcpReinfo = null;

async function connectMCP() {
  state.mcpStatus = 'connecting';
  state.mcpMessage = 'MCPã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­ï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§è©¦è¡Œï¼‰...';
  render();

  try {
    mcpReinfo = new MCPClient(CONFIG.MCP_REINFO, CONFIG.PROXY_URL);
    await mcpReinfo.initialize();
    const tools = await mcpReinfo.listTools();
    state.mcpStatus = 'connected';
    state.mcpMessage = `æ¥ç¶šå®Œäº† â€” ${tools.length}å€‹ã®ãƒ„ãƒ¼ãƒ«ãŒåˆ©ç”¨å¯èƒ½`;
    render();

    // Phase 1: æ¦‚è¦å–å¾— â†’ Phase 2: å…¨ã‚¨ãƒªã‚¢è©³ç´°ã‚’è‡ªå‹•å–å¾—
    await fetchLiveData();
    fetchAllAreasData();  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å…¨ã‚¨ãƒªã‚¢å–å¾—é–‹å§‹ï¼ˆawaitã—ãªã„ï¼‰
  } catch(e) {
    state.mcpStatus = 'error';
    state.mcpMessage = `æ¥ç¶šå¤±æ•—: ${e.message}ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­ï¼‰`;
    render();
  }
}

// Lightweight status text update (no full re-render)
function updateStatusText(msg) {
  state.mcpMessage = msg;
  const el = document.getElementById('mcp-status-text');
  if (el) el.textContent = msg;
}

// ------------------------------------------------------------
// Phase 1: Quick overview fetch (latest year only, all areas)
// ------------------------------------------------------------
async function fetchLiveData() {
  if (!mcpReinfo || !mcpReinfo.connected) return;

  try {
    updateStatusText('æ¦‚è¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');

    const cityResult = await mcpReinfo.callTool('reinfolib-city-list', { area: '24' });

    // Fetch only latest year for quick overview (7 requests)
    const priceResults = [];
    for (const area of AREAS) {
      try {
        updateStatusText(`${area.name} ã®æ¦‚è¦ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...`);
        const priceData = await mcpReinfo.callTool('reinfolib-real-estate-price', {
          year: '2024', area: '24', city: area.cityCode
        });
        priceResults.push({ cityCode: area.cityCode, quarters: [priceData] });
      } catch(e) {
        console.warn(`Overview fetch failed for ${area.name}:`, e);
        priceResults.push({ cityCode: area.cityCode, quarters: [] });
      }
    }

    state.mcpLiveData = { cities: cityResult, prices: priceResults };
    updateAreasWithLiveData(priceResults);

    let totalTx = 0;
    AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
    state.mcpMessage = `æ¦‚è¦ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼ˆè¨ˆ${totalTx}ä»¶ï¼‰ â€” è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å–å¾—ä¸­...`;

    render();
  } catch(e) {
    state.mcpMessage = `ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­ï¼‰`;
    render();
  }
}

// ------------------------------------------------------------
// Phase 2: Deep fetch for a single area (5 years Ã— 4 quarters)
// ------------------------------------------------------------
const AREA_FULL_LOADED = new Set();
let _currentFetchAreaId = null;
let _fetchPriorityAreaId = null;  // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã«ã‚ˆã‚‹å„ªå…ˆå–å¾—ã‚¨ãƒªã‚¢
let _autoFetchRunning = false;    // å…¨ã‚¨ãƒªã‚¢è‡ªå‹•å–å¾—ã®å®Ÿè¡Œä¸­ãƒ•ãƒ©ã‚°

async function fetchAreaFullData(areaId, options = {}) {
  if (!mcpReinfo || !mcpReinfo.connected) return;
  if (AREA_FULL_LOADED.has(areaId)) return; // already loaded
  if (_currentFetchAreaId === areaId) return; // already fetching

  const area = AREAS.find(a => a.id === areaId);
  if (!area) return;

  _currentFetchAreaId = areaId;

  // é¸æŠä¸­ã‚¨ãƒªã‚¢ã®ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å–å¾—æ™‚ã¯éè¡¨ç¤ºï¼‰
  const isSelected = state.mapSelectedAreaId === areaId;
  const showOverlay = options.showOverlay !== undefined ? options.showOverlay : isSelected;
  if (showOverlay) showMapLoading(area.name, 0);

  const yearQuarters = [
    { year: '2024', quarter: '4' }, { year: '2024', quarter: '3' },
    { year: '2024', quarter: '2' }, { year: '2024', quarter: '1' },
    { year: '2023', quarter: '4' }, { year: '2023', quarter: '3' },
    { year: '2023', quarter: '2' }, { year: '2023', quarter: '1' },
    { year: '2022', quarter: '4' }, { year: '2022', quarter: '3' },
    { year: '2022', quarter: '2' }, { year: '2022', quarter: '1' },
    { year: '2021', quarter: '4' }, { year: '2021', quarter: '3' },
    { year: '2021', quarter: '2' }, { year: '2021', quarter: '1' },
    { year: '2020', quarter: '4' }, { year: '2020', quarter: '3' },
    { year: '2020', quarter: '2' }, { year: '2020', quarter: '1' },
  ];

  const allData = [];
  let done = 0;
  const total = yearQuarters.length;

  for (const yq of yearQuarters) {
    try {
      done++;
      const pct = Math.round(done / total * 100);
      if (showOverlay) updateMapLoading(`${area.name} ${yq.year}å¹´Q${yq.quarter}`, pct);
      updateStatusText(`${area.name} è©³ç´°å–å¾—ä¸­... (${done}/${total})`);
      const priceData = await mcpReinfo.callTool('reinfolib-real-estate-price', {
        year: yq.year, quarter: yq.quarter, area: '24', city: area.cityCode
      });
      allData.push(priceData);
    } catch(e) {
      console.warn(`Detail fetch failed for ${area.name} ${yq.year}Q${yq.quarter}:`, e);
    }
  }

  // Merge with existing overview data
  updateAreasWithLiveData([{ cityCode: area.cityCode, quarters: allData }]);

  AREA_FULL_LOADED.add(areaId);
  _currentFetchAreaId = null;

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤éè¡¨ç¤º
  if (showOverlay) hideMapLoading();

  const txCount = area._liveTransactions ? area._liveTransactions.length : 0;
  updateStatusText(`${area.name}: è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼ˆ${txCount}ä»¶ï¼‰`);

  // Update sidebar and pins with fetched data
  if (state.view === 'map') {
    const ranked = getRankedAreas();
    const rankedArea = ranked.find(a => a.id === areaId);
    if (state.mapSelectedAreaId === areaId && rankedArea) {
      updateMapSidebar(rankedArea, ranked);
    }

    // Geocode districts THEN show pins at correct positions
    if (txMarkerLayer) {
      await geocodeAreaDistricts(area, { showOverlay });
      if (state.mapSelectedAreaId === areaId) {
        showTransactionPins(area);
      }
    }
  }

  // Background geocode remaining areas' districts
  geocodeDistrictsBackground().catch(e => console.warn('Geocoding error:', e));
}

// ------------------------------------------------------------
// Auto-fetch: å…¨ã‚¨ãƒªã‚¢ã®Phase2ãƒ‡ãƒ¼ã‚¿ã‚’é †æ¬¡å–å¾—ï¼ˆå„ªå…ˆã‚¨ãƒªã‚¢å¯¾å¿œï¼‰
// ------------------------------------------------------------
async function fetchAllAreasData() {
  if (_autoFetchRunning) return;
  if (!mcpReinfo || !mcpReinfo.connected) return;

  _autoFetchRunning = true;
  const areaIds = AREAS.map(a => a.id);
  let completedCount = AREA_FULL_LOADED.size;

  while (true) {
    // æ¬¡ã«å–å¾—ã™ã‚‹ã‚¨ãƒªã‚¢ã‚’æ±ºå®š
    let nextId = null;

    // 1. å„ªå…ˆã‚¨ãƒªã‚¢ãŒã‚ã‚Œã°ãã‚Œã‚’å…ˆã«
    if (_fetchPriorityAreaId && !AREA_FULL_LOADED.has(_fetchPriorityAreaId)) {
      nextId = _fetchPriorityAreaId;
      _fetchPriorityAreaId = null;
    }

    // 2. ãªã‘ã‚Œã°æœªå–å¾—ã®ã‚¨ãƒªã‚¢ã‚’é †ã«
    if (!nextId) {
      nextId = areaIds.find(id => !AREA_FULL_LOADED.has(id));
    }

    // å…¨ã‚¨ãƒªã‚¢å–å¾—æ¸ˆã¿ãªã‚‰çµ‚äº†
    if (!nextId) break;

    const remaining = AREAS.length - AREA_FULL_LOADED.size;
    const areaName = AREAS.find(a => a.id === nextId)?.name || nextId;
    updateStatusText(`${areaName} è©³ç´°å–å¾—ä¸­... ï¼ˆæ®‹ã‚Š${remaining}ã‚¨ãƒªã‚¢ï¼‰`);

    await fetchAreaFullData(nextId);

    completedCount = AREA_FULL_LOADED.size;
  }

  _autoFetchRunning = false;

  // å…¨å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  let totalTx = 0;
  AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
  state.mcpMessage = `å…¨ã‚¨ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼ˆè¨ˆ${totalTx.toLocaleString()}ä»¶ï¼‰`;
  updateStatusText(`å…¨ã‚¨ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼ˆè¨ˆ${totalTx.toLocaleString()}ä»¶ï¼‰`);

  // ãƒãƒƒãƒ—è¡¨ç¤ºä¸­ãªã‚‰å…¨ãƒ”ãƒ³æ›´æ–°
  if (state.view === 'map' && txMarkerLayer && !state.mapSelectedAreaId) {
    const ranked = getRankedAreas();
    showAllTransactionPins(ranked);
  }
}

function extractTransactionsFromMCPResponse(data) {
  let content = data;
  if (content && content.content) content = content.content;
  if (!Array.isArray(content)) {
    // Try alternative structures
    if (content && content.data && Array.isArray(content.data)) {
      console.log('[TX] Direct data array found:', content.data.length, 'records');
      return content.data;
    }
    if (content && typeof content === 'string') {
      try {
        const p = JSON.parse(content);
        if (p.data && Array.isArray(p.data)) {
          console.log('[TX] Parsed string data:', p.data.length, 'records');
          return p.data;
        }
      } catch {}
    }
    console.warn('[TX] Content is not array:', typeof content, content ? Object.keys(content) : 'null');
    return [];
  }
  const textContent = content.find(c => c.type === 'text');
  if (!textContent) {
    console.warn('[TX] No text content found in array of', content.length, 'elements');
    return [];
  }
  try {
    const parsed = JSON.parse(textContent.text);
    if (parsed.data && Array.isArray(parsed.data)) {
      console.log('[TX] Extracted', parsed.data.length, 'records from text content');
      return parsed.data;
    }
    // Try other keys
    for (const key of Object.keys(parsed)) {
      if (Array.isArray(parsed[key]) && parsed[key].length > 0) {
        console.log('[TX] Found array in key', key, ':', parsed[key].length, 'records');
        return parsed[key];
      }
    }
    console.warn('[TX] No data array found. Keys:', Object.keys(parsed));
  } catch(e) {
    console.warn('[TX] JSON parse error:', e.message, 'text:', textContent.text?.substring(0, 200));
  }
  return [];
}

function updateAreasWithLiveData(priceResults) {
  for (const result of priceResults) {
    const area = AREAS.find(a => a.cityCode === result.cityCode);
    if (!area) continue;

    // Merge transactions from all quarters
    const allRecords = [];
    const sources = result.quarters || (result.data ? [result.data] : []);
    console.log(`[DATA] ${area.name}: ${sources.length} sources to process`);
    for (const src of sources) {
      if (!src) continue;
      const records = extractTransactionsFromMCPResponse(src);
      allRecords.push(...records);
    }
    console.log(`[DATA] ${area.name}: ${allRecords.length} total records from all sources`);

    if (allRecords.length === 0) continue;

    // Deduplicate by comprehensive key to avoid removing distinct transactions
    const seen = new Set();
    const uniqueRecords = allRecords.filter(d => {
      const key = [
        d.TradePrice || '',
        d.DistrictName || d.Region || '',
        d.Area || '',
        d.Period || '',
        d.Type || d.TradeType || '',
        d.BuildingYear || '',
        d.NearestStation || '',
        d.FloorPlan || '',
        d.Structure || ''
      ].join('|');
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    console.log(`[DATA] ${area.name}: ${uniqueRecords.length} unique records after dedup (removed ${allRecords.length - uniqueRecords.length})`);
    if (uniqueRecords.length > 0) {
      console.log(`[DATA] ${area.name}: Sample record keys:`, Object.keys(uniqueRecords[0]));
    }

    // Store full transaction records for map display
    area._liveTransactions = uniqueRecords.map(d => ({
      TradePrice: (d.TradePrice != null && d.TradePrice !== '') ? parseInt(d.TradePrice) : null,
      Type: d.Type || d.TradeType || '',
      Area: d.Area ? parseFloat(d.Area) : null,
      FloorPlan: d.FloorPlan || '',
      BuildingYear: d.BuildingYear || '',
      NearestStation: d.NearestStation || '',
      DistanceToStation: d.TimeToNearestStation || d.DistanceToStation || '',
      Use: d.Use || d.Purpose || '',
      District: d.DistrictName || d.Region || '',
      Structure: d.Structure || '',
      CityPlanning: d.CityPlanning || '',
      Period: d.Period || '',
    }));
    console.log(`[DATA] ${area.name}: Final _liveTransactions count = ${area._liveTransactions.length}`);

    // Calculate average trade price from live data
    const prices = uniqueRecords.filter(d => d.TradePrice != null && d.TradePrice !== '').map(d => parseInt(d.TradePrice)).filter(p => !isNaN(p));
    if (prices.length > 0) {
      area._liveAvgTradePrice = Math.round(prices.reduce((a,b) => a+b, 0) / prices.length);
      area._liveTransactionCount = uniqueRecords.length;
    }
  }
}

// ============================================================
// Lazy-load helpers (Chart.js / Leaflet)
// ============================================================
const _loadedLibs = {};
function loadLib(url, type) {
  if (_loadedLibs[url]) return _loadedLibs[url];
  _loadedLibs[url] = new Promise((resolve, reject) => {
    const el = type === 'css'
      ? Object.assign(document.createElement('link'), { rel:'stylesheet', href:url })
      : Object.assign(document.createElement('script'), { src:url });
    el.onload = resolve; el.onerror = reject;
    document.head.appendChild(el);
  });
  return _loadedLibs[url];
}
async function ensureChartJs() {
  if (window.Chart) return;
  await loadLib('https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js','js');
}
async function ensureLeaflet() {
  if (window.L) return;
  await loadLib('https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css','css');
  await loadLib('https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js','js');
}

// ============================================================
// Render Functions
// ============================================================
function render() {
  const app = document.getElementById('app');
  const ranked = getRankedAreas();
  const selected = state.selectedAreaId ? ranked.find(a => a.id === state.selectedAreaId) : ranked[0];

  // Backwards compat: 'detail' view â†’ show ranking + auto-open modal
  const isDetailCompat = (state.view === 'detail');
  const effectiveView = isDetailCompat ? 'ranking' : state.view;

  app.innerHTML = `
    ${renderHeader()}
    <div class="max-w-6xl mx-auto px-4 py-6">
      ${renderWeights()}
      ${effectiveView === 'ranking' ? renderRanking(ranked) : ''}
      ${effectiveView === 'compare' ? renderCompare(ranked) : ''}
      ${effectiveView === 'map' ? renderMap(ranked) : ''}
      ${renderFooter()}
    </div>
  `;

  // Re-bindã‚¤ãƒ™ãƒ³ãƒˆ
  bindEvents(ranked);

  // ãƒãƒ£ãƒ¼ãƒˆæç”»ãƒ»ãƒãƒƒãƒ—åˆæœŸåŒ–ï¼ˆDOMãŒå­˜åœ¨ã—ã¦ã‹ã‚‰ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é…å»¶èª­ã¿è¾¼ã¿ï¼‰
  requestAnimationFrame(() => {
    if (effectiveView === 'compare') ensureChartJs().then(() => drawCompareCharts(ranked));
    if (effectiveView === 'map') {
      // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯DOMãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºå®šã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹
      setTimeout(() => {
        ensureLeaflet().then(() => {
          initializeMap(ranked);
          if (state.mapSelectedAreaId) {
            const selArea = ranked.find(a => a.id === state.mapSelectedAreaId);
            if (selArea) updateMapSidebar(selArea, ranked);
          }
        });
      }, 50);
    }
    // Auto-open detail modal for city pages (backwards compat)
    if (isDetailCompat && state.selectedAreaId) {
      state.view = 'ranking'; // normalize state
      openCmpDetailModal(state.selectedAreaId);
    }
  });
}

function renderHeader() {
  const tabs = [
    { id: 'ranking', label: 'ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°' },
    { id: 'compare', label: 'ğŸ“Š æ¯”è¼ƒ' },
    { id: 'map', label: 'ğŸ—ºï¸ åœ°å›³' }
  ];
  const currentTab = tabs.find(t => t.id === state.view) || tabs[0];
  return `
    <!-- å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div style="background:white;border-bottom:1px solid #e5e7eb;padding:10px 16px;">
      <div style="max-width:72rem;margin:0 auto;display:flex;align-items:center;justify-content:space-between;">
        <a href="/" style="text-decoration:none;display:flex;align-items:center;">
          <picture>
            <source srcset="/images/header-banner.webp" type="image/webp">
            <img src="/images/header-banner.png" alt="æ³¨æ–‡ä½å®…æ¯”è¼ƒ.com - çµ¶å¯¾ã«å¾Œæ‚”ã—ãªã„å®¶ã¥ãã‚Š" style="height:56px;width:auto;">
          </picture>
        </a>
        <div id="global-nav-links" style="display:flex;align-items:center;gap:16px;font-size:13px;">
          <a href="/" style="color:#6b7280;text-decoration:none;font-weight:500;">ç‰©ä»¶æ¯”è¼ƒ</a>
          <span style="color:#2563EB;font-weight:600;">ã‚¨ãƒªã‚¢æ¯”è¼ƒ</span>
          <a href="/knowledge/" style="color:#6b7280;text-decoration:none;font-weight:500;">çŸ¥è­˜</a>
          <a href="/about/" style="color:#6b7280;text-decoration:none;font-weight:500;">é‹å–¶è€…æƒ…å ±</a>
        </div>
      </div>
    </div>
    <!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§æ¶ˆãˆã‚‹ï¼‰ -->
    <header class="glass border-b border-gray-200">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 mobile-title-text">ğŸ  ä¸‰é‡çœŒ æ³¨æ–‡ä½å®…ã‚¨ãƒªã‚¢æ¯”è¼ƒ</h1>
            <p class="text-sm text-gray-500 mt-1 mobile-subtitle-text">ä¸‰é‡çœŒåŒ—éƒ¨ã®åœŸåœ°ç›¸å ´ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿ã‚’æ¯”è¼ƒã—ã¦ã€æ³¨æ–‡ä½å®…ã«æœ€é©ãªã‚¨ãƒªã‚¢ã‚’è¦‹ã¤ã‘ã‚ˆã†</p>
            <a href="index.html" style="display:inline-block;margin-top:6px;font-size:13px;color:#3b82f6;font-weight:500;text-decoration:none;">ğŸ  æ³¨æ–‡ä½å®…æ¯”è¼ƒ.comã§ç‰©ä»¶ã‚’æ¯”è¼ƒã™ã‚‹ â†’</a>
            ${state.mcpStatus === 'connected' ? (() => {
              let totalTx = 0;
              AREAS.forEach(a => { if (a._liveTransactions) totalTx += a._liveTransactions.length; });
              const dateStr = state.fetchedAt ? new Date(state.fetchedAt).toLocaleDateString('ja-JP') : '';
              return `<p class="text-xs text-green-600 mt-1">ğŸ“Š å–å¼•ãƒ‡ãƒ¼ã‚¿ ${totalTx.toLocaleString()}ä»¶${dateStr ? `ï¼ˆ${dateStr} æ›´æ–°ï¼‰` : ''}</p>`;
            })() : state.mcpStatus === 'connecting' ? `<p class="text-xs text-blue-500 mt-1">â³ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</p>` : ''}
          </div>
        </div>
      </div>
    </header>
    <!-- ã‚¿ãƒ–ãƒãƒ¼ï¼ˆPCã®ã¿è¡¨ç¤ºï¼‰ -->
    <nav id="pc-nav-bar" class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-gray-200 shadow-sm">
      <div class="max-w-6xl mx-auto px-4 py-2">
        <div class="flex gap-2">
          ${tabs.map(t => `
            <button data-tab="${t.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-all ${state.view === t.id ? 'tab-active' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
              ${t.label}
            </button>
          `).join('')}
        </div>
      </div>
    </nav>
    <!-- ãƒ¢ãƒã‚¤ãƒ«: å³ä¸Šå›ºå®šãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒœã‚¿ãƒ³ -->
    <button id="mobile-menu-fab" onclick="openMobileDrawer()" style="display:none;position:fixed;top:12px;right:12px;z-index:60;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.92);backdrop-filter:blur(8px);box-shadow:0 2px 8px rgba(0,0,0,0.15);border:1px solid #e5e7eb;font-size:18px;color:#374151;cursor:pointer;" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
      â˜°
    </button>
    <!-- ãƒ¢ãƒã‚¤ãƒ«: å³ã‚µã‚¤ãƒ‰ãƒ‰ãƒ­ãƒ¯ãƒ¼ -->
    <div id="mobile-drawer-overlay" style="display:none;position:fixed;inset:0;z-index:70;background:rgba(0,0,0,0.4);opacity:0;transition:opacity 0.3s;" onclick="closeMobileDrawer()"></div>
    <div id="mobile-drawer-panel" style="display:none;position:fixed;top:0;right:0;z-index:80;height:100%;width:260px;background:#fff;box-shadow:-4px 0 20px rgba(0,0,0,0.15);transform:translateX(100%);transition:transform 0.3s ease-out;">
      <div style="padding:16px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:14px;font-weight:700;color:#1f2937;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
        <button onclick="closeMobileDrawer()" style="width:32px;height:32px;border-radius:50%;background:#f3f4f6;border:none;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:20px;cursor:pointer;">&times;</button>
      </div>
      <div style="padding:16px;display:flex;flex-direction:column;gap:8px;">
        ${tabs.map(t => `
          <button data-tab="${t.id}" onclick="closeMobileDrawer()" class="${state.view === t.id ? 'tab-active' : ''}" style="width:100%;text-align:left;padding:12px 16px;border-radius:8px;font-size:14px;font-weight:500;border:none;cursor:pointer;transition:background 0.2s;${state.view === t.id ? '' : 'background:#f9fafb;color:#4b5563;'}">
            ${t.label}
          </button>
        `).join('')}
      </div>
      <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒŠãƒ“ -->
      <div style="padding:0 16px 16px;border-top:1px solid #e5e7eb;margin-top:8px;">
        <div style="font-size:11px;font-weight:600;color:#9ca3af;margin:12px 0 8px;letter-spacing:0.05em;">ã‚µã‚¤ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <a href="/" style="display:block;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:500;background:#f9fafb;color:#4b5563;text-decoration:none;">ç‰©ä»¶æ¯”è¼ƒ</a>
          <span style="display:block;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;background:#dbeafe;color:#1d4ed8;">ã‚¨ãƒªã‚¢æ¯”è¼ƒ</span>
          <a href="/knowledge/" style="display:block;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:500;background:#f9fafb;color:#4b5563;text-decoration:none;">çŸ¥è­˜</a>
          <a href="/about/" style="display:block;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:500;background:#f9fafb;color:#4b5563;text-decoration:none;">é‹å–¶è€…æƒ…å ±</a>
        </div>
      </div>
    </div>
  `;
}

function openMobileDrawer() {
  const overlay = document.getElementById('mobile-drawer-overlay');
  const panel = document.getElementById('mobile-drawer-panel');
  if (!overlay || !panel) return;
  overlay.style.opacity = '1';
  overlay.style.pointerEvents = 'auto';
  panel.style.transform = 'translateX(0)';
  document.body.style.overflow = 'hidden';
}
function closeMobileDrawer() {
  const overlay = document.getElementById('mobile-drawer-overlay');
  const panel = document.getElementById('mobile-drawer-panel');
  if (!overlay || !panel) return;
  overlay.style.opacity = '0';
  overlay.style.pointerEvents = 'none';
  panel.style.transform = 'translateX(100%)';
  document.body.style.overflow = '';
}

function renderMCPStatus() {
  const statusColors = {
    disconnected: { bg: 'bg-gray-100', text: 'text-gray-600', dot: 'bg-gray-400' },
    connecting: { bg: 'bg-blue-50', text: 'text-blue-700', dot: 'bg-blue-500' },
    connected: { bg: 'bg-green-50', text: 'text-green-700', dot: 'bg-green-500' },
    error: { bg: 'bg-amber-50', text: 'text-amber-700', dot: 'bg-amber-500' }
  };
  const s = statusColors[state.mcpStatus];
  const statusLabel = { disconnected: 'æœªæ¥ç¶š', connecting: 'å–å¾—ä¸­', connected: 'ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆ', error: 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯' }[state.mcpStatus];

  return `
    <div class="card p-4 mb-4 flex items-center justify-between flex-wrap gap-3">
      <div class="flex items-center gap-3">
        <div class="status-badge ${s.bg} ${s.text}">
          <span class="pulse-dot ${s.dot}"></span>
          ${statusLabel}
        </div>
        <span id="mcp-status-text" class="text-sm text-gray-500">${state.mcpMessage || 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...'}</span>
      </div>
      <div class="flex gap-2">
        ${state.mcpStatus === 'connected' ? `
          <button id="btn-connect-mcp" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
            ğŸ”„ æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
          </button>
        ` : state.mcpStatus === 'connecting' ? `
          <span class="text-xs text-blue-600 self-center">å–å¾—ä¸­...</span>
        ` : `
          <button id="btn-connect-mcp" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
            ğŸ”Œ MCPã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š
          </button>
        `}
      </div>
    </div>
  `;
}

function renderWeights() {
  // Hide on map view
  if (state.view === 'map') return '';

  const items = [
    { key: 'price', label: 'ä¾¡æ ¼ã®æ‰‹é ƒã•', icon: 'ğŸ’°' },
    { key: 'access', label: 'åå¤å±‹ã‚¢ã‚¯ã‚»ã‚¹', icon: 'ğŸšƒ' },
    { key: 'growth', label: 'è³‡ç”£ä¾¡å€¤ä¸Šæ˜‡', icon: 'ğŸ“ˆ' },
    { key: 'living', label: 'ç”Ÿæ´»åˆ©ä¾¿æ€§', icon: 'ğŸª' },
    { key: 'family', label: 'å­è‚²ã¦ç’°å¢ƒ', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦' },
    { key: 'nature', label: 'è‡ªç„¶ç’°å¢ƒ', icon: 'ğŸŒ¿' }
  ];

  // Determine active preset
  const activePreset = Object.entries(WEIGHT_PRESETS).find(([k, p]) =>
    Object.entries(p.weights).every(([wk, wv]) => state.weights[wk] === wv)
  );

  return `
    <div class="card p-4 mb-6">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <span style="font-size:14px;font-weight:700;color:#1f2937;">ğŸ¯ å„ªå…ˆåº¦</span>
          ${Object.entries(WEIGHT_PRESETS).map(([k, p]) => `
            <button data-weight-preset="${k}" style="padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;border:1.5px solid ${activePreset && activePreset[0] === k ? '#3b82f6' : '#e5e7eb'};background:${activePreset && activePreset[0] === k ? '#eff6ff' : '#fff'};color:${activePreset && activePreset[0] === k ? '#2563eb' : '#6b7280'};cursor:pointer;transition:all 0.2s;white-space:nowrap;">
              ${p.label}
            </button>
          `).join('')}
        </div>
        <button id="weights-toggle" style="display:flex;align-items:center;gap:4px;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:500;color:#6b7280;background:#f9fafb;border:1px solid #e5e7eb;cursor:pointer;transition:all 0.2s;white-space:nowrap;">
          âš™ï¸ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
          <svg style="width:12px;height:12px;transition:transform 0.3s;${state.weightsExpanded ? 'transform:rotate(180deg);' : ''}" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
        </button>
      </div>
      <div id="weights-sliders" style="overflow:hidden;max-height:${state.weightsExpanded ? '300px' : '0'};opacity:${state.weightsExpanded ? '1' : '0'};transition:max-height 0.35s ease, opacity 0.3s ease;margin-top:${state.weightsExpanded ? '16px' : '0'};">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          ${items.map(i => `
            <div class="flex items-center gap-3">
              <span class="text-xl w-8 text-center">${i.icon}</span>
              <div class="flex-1">
                <div class="flex justify-between mb-1">
                  <span class="text-sm font-medium text-gray-700">${i.label}</span>
                  <span class="text-sm font-bold text-blue-600" id="wv-${i.key}">${state.weights[i.key]}</span>
                </div>
                <input type="range" min="0" max="50" value="${state.weights[i.key]}" data-weight="${i.key}"
                  class="w-full cursor-pointer" style="background: linear-gradient(to right, #3b82f6 0%, #3b82f6 ${state.weights[i.key]*2}%, #e5e7eb ${state.weights[i.key]*2}%, #e5e7eb 100%);">
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

function renderRanking(ranked) {
  const medals = ['medal-gold','medal-silver','medal-bronze'];
  const scoreKeys = [
    { key: 'price', label: 'ä¾¡æ ¼' },
    { key: 'access', label: 'äº¤é€š' },
    { key: 'growth', label: 'æˆé•·' },
    { key: 'living', label: 'åˆ©ä¾¿' },
    { key: 'family', label: 'å­è‚²' },
    { key: 'nature', label: 'è‡ªç„¶' }
  ];

  return `
    <div class="space-y-4 fade-in">
      <h2 class="text-lg font-bold text-gray-800">ğŸ† ãŠã™ã™ã‚ã‚¨ãƒªã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      ${ranked.map((a, idx) => `
        <div class="card p-5 cursor-pointer" data-area-detail="${a.id}">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 flex flex-col items-center w-16">
              <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg ${idx < 3 ? medals[idx] : 'bg-slate-400'}">
                ${idx + 1}
              </div>
              <div class="text-2xl font-bold text-blue-600 mt-1">${a.scores.total}<span class="text-xs text-gray-400 font-normal">pt</span></div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="text-xl font-bold text-gray-900">${a.name}</h3>
                ${a.popGrowthRate > 0 ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">äººå£å¢—åŠ ä¸­</span>' : ''}
                ${a._liveTransactionCount ? `<span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">LIVE ${a._liveTransactionCount}ä»¶</span>` : ''}
              </div>
              <p class="text-sm text-gray-600 mb-3">${a.description}</p>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                <div class="text-center p-2 bg-blue-50 rounded-lg">
                  <div class="text-xs text-gray-500">ä½å®…åœ°ä¾¡æ ¼</div>
                  <div class="text-sm font-bold text-blue-700">${(a.residentialPrice/10000).toFixed(1)}ä¸‡/mÂ²</div>
                </div>
                <div class="text-center p-2 bg-green-50 rounded-lg">
                  <div class="text-xs text-gray-500">åå¤å±‹ã¾ã§</div>
                  <div class="text-sm font-bold text-green-700">${a.accessToNagoya}åˆ†</div>
                </div>
                <div class="text-center p-2 bg-amber-50 rounded-lg">
                  <div class="text-xs text-gray-500">åœ°ä¾¡å¤‰å‹•</div>
                  <div class="text-sm font-bold text-amber-700">+${a.yoyChange}%</div>
                </div>
                <div class="text-center p-2 bg-purple-50 rounded-lg">
                  <div class="text-xs text-gray-500">äººå£</div>
                  <div class="text-sm font-bold text-purple-700">${(a.population/10000).toFixed(1)}ä¸‡äºº</div>
                </div>
              </div>
            </div>
            <div class="flex-shrink-0 w-28 space-y-1 hidden sm:block">
              ${scoreKeys.map(s => `
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-400 w-8 text-right">${s.label}</span>
                  <div class="score-bar flex-1"><div class="score-bar-fill bg-blue-500" style="width:${a.scores[s.key]}%"></div></div>
                  <span class="text-xs text-gray-500 w-5 text-right">${a.scores[s.key]}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderCompare(ranked) {
  const cols = state.cmpSelectedColumns.map(k => CMP_COLUMNS.find(c => c.key === k)).filter(Boolean);
  const MEDAL = ['#3b82f6','#3b82f6','#3b82f6'];
  return `
    <div class="space-y-5 fade-in">
      <h2 class="text-lg font-bold text-gray-800">ğŸ“Š ã‚¨ãƒªã‚¢æ¯”è¼ƒ</h2>

      <!-- Filter Tags + Presets -->
      <div class="card p-4">
        <div class="flex flex-wrap items-center gap-2 mb-3">
          ${cols.map(c => `
            <span class="cmp-filter-tag active">
              ${c.icon} ${c.label}
              <span class="cmp-tag-x" data-cmp-remove-col="${c.key}">&times;</span>
            </span>
          `).join('')}
          <button class="cmp-add-col-btn" id="cmp-open-col-modal">+ é …ç›®ã‚’è¿½åŠ </button>
        </div>
        <div class="flex flex-wrap gap-2">
          ${Object.entries(CMP_PRESETS).map(([k,v]) => `
            <button class="cmp-preset-btn" data-cmp-preset="${k}">${v.label}</button>
          `).join('')}
        </div>
      </div>

      <!-- Summary Rows -->
      <div style="display:flex;flex-direction:column;gap:6px;">
        ${ranked.map((a, idx) => {
          const medalBg = idx < 3 ? '#3b82f6' : '#94a3b8';
          return `
          <div class="cmp-row" data-cmp-open-detail="${a.id}">
            <span style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:700;flex-shrink:0;background:${medalBg}">${idx+1}</span>
            <span style="font-weight:600;color:#111827;width:5em;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:14px;">${a.name}</span>
            ${cols.map(c => {
              const val = getCmpVal(a, c.key);
              const scoreColor = c.isScore ? (val >= 80 ? '#2563eb' : val >= 70 ? '#16a34a' : '#4b5563') : '#1f2937';
              return `<div style="flex:1;text-align:center;min-width:0;">
                <div style="font-size:11px;color:#9ca3af;margin-bottom:2px;" class="hidden sm:block">${c.label}</div>
                <div style="font-size:13px;font-weight:700;color:${scoreColor}">${c.format(val)}</div>
              </div>`;
            }).join('')}
            <svg style="width:16px;height:16px;flex-shrink:0;color:#d1d5db;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

function renderDetail(area, ranked) {
  if (!area) return '<p>ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
  const scoreItems = [
    { key: 'price', label: 'ä¾¡æ ¼ã®æ‰‹é ƒã•', color: '#3b82f6' },
    { key: 'access', label: 'åå¤å±‹ã‚¢ã‚¯ã‚»ã‚¹', color: '#10b981' },
    { key: 'growth', label: 'è³‡ç”£ä¾¡å€¤ä¸Šæ˜‡', color: '#f59e0b' },
    { key: 'living', label: 'ç”Ÿæ´»åˆ©ä¾¿æ€§', color: '#ef4444' },
    { key: 'family', label: 'å­è‚²ã¦ç’°å¢ƒ', color: '#8b5cf6' },
    { key: 'nature', label: 'è‡ªç„¶ç’°å¢ƒ', color: '#06b6d4' }
  ];

  return `
    <div class="space-y-6 fade-in">
      <div class="flex items-center gap-3 flex-wrap">
        <button id="btn-back" class="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors">â† æˆ»ã‚‹</button>
        <h2 class="text-lg font-bold text-gray-800">ğŸ” ${area.name} ã®è©³ç´°åˆ†æ</h2>
        <button id="btn-to-map" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-50 transition-colors ml-auto">ğŸ—ºï¸ ãƒãƒƒãƒ—ã§è¡¨ç¤º</button>
      </div>

      <div class="flex flex-wrap gap-2">
        ${ranked.map(a => `
          <button data-area-switch="${a.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-all ${area.id===a.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}">
            ${a.name}
          </button>
        `).join('')}
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ -->
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">ç·åˆè©•ä¾¡</h3>
          <canvas id="chart-radar" height="280"></canvas>
          <div class="text-center mt-4">
            <span class="text-4xl font-bold text-blue-600">${area.scores.total}</span>
            <span class="text-sm text-gray-400 ml-1">/ 100ç‚¹</span>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-4">
            ${scoreItems.map(s => `
              <div class="text-center">
                <div class="text-xs text-gray-500">${s.label}</div>
                <div class="text-lg font-bold" style="color:${s.color}">${area.scores[s.key]}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- åŸºæœ¬æƒ…å ± -->
        <div class="card p-6">
          <h3 class="text-base font-bold text-gray-700 mb-4">åŸºæœ¬ãƒ‡ãƒ¼ã‚¿</h3>
          <div class="space-y-3">
            ${[
              ['ğŸ  ä½å®…åœ°å¹³å‡', `${area.residentialPrice.toLocaleString()}å††/mÂ²`],
              ['ğŸ’´ åªå˜ä¾¡', `${area.pricePerTsubo.toLocaleString()}å††/åª`],
              ['ğŸ“ˆ å‰å¹´æ¯”å¤‰å‹•', `+${area.yoyChange}%`],
              ['ğŸ‘¥ äººå£', `${area.population.toLocaleString()}äºº`],
              ['ğŸšƒ åå¤å±‹ã¾ã§', `ç´„${area.accessToNagoya}åˆ†`],
              ['ğŸ¥ åŒ»ç™‚æ–½è¨­', `${area.hospitals}æ–½è¨­`],
              ['ğŸ« æ•™è‚²æ–½è¨­', `${area.schools}æ–½è¨­`],
              ['ğŸ› å•†æ¥­æ–½è¨­', `${area.shopping}æ–½è¨­`],
            ].map(([l,v]) => `
              <div class="flex justify-between items-center py-2 border-b border-gray-50">
                <span class="text-sm text-gray-600">${l}</span>
                <span class="text-sm font-bold text-gray-900">${v}</span>
              </div>
            `).join('')}
            ${area._liveAvgTradePrice ? `
              <div class="flex justify-between items-center py-2 border-b border-blue-100 bg-blue-50 rounded px-2 mt-2">
                <span class="text-sm text-blue-600 font-medium">ğŸ”´ LIVE å¹³å‡å–å¼•ä¾¡æ ¼</span>
                <span class="text-sm font-bold text-blue-700">${area._liveAvgTradePrice.toLocaleString()}å††</span>
              </div>
            ` : ''}
          </div>
        </div>
      </div>

      <!-- åœ°ä¾¡æ¨ç§» -->
      <div class="card p-6">
        <h3 class="text-base font-bold text-gray-700 mb-4">åœ°ä¾¡æ¨ç§»</h3>
        <canvas id="chart-detail-trend" height="200"></canvas>
      </div>

      <!-- æ¦‚è¦ãƒ»ãƒã‚¤ãƒ³ãƒˆãƒ»æ³¨æ„ç‚¹ -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-5">
          <h3 class="text-base font-bold text-gray-700 mb-3">ğŸ“ æ¦‚è¦</h3>
          <p class="text-sm text-gray-600 leading-relaxed">${area.description}</p>
        </div>
        <div class="rounded-xl p-5 bg-green-50 border border-green-200">
          <h3 class="text-base font-bold text-green-700 mb-3">âœ… ãƒã‚¤ãƒ³ãƒˆ</h3>
          <ul class="space-y-2">
            ${area.highlights.map(h => `<li class="text-sm text-green-800 flex items-start gap-2"><span class="mt-0.5">â€¢</span>${h}</li>`).join('')}
          </ul>
        </div>
        <div class="rounded-xl p-5 bg-amber-50 border border-amber-200">
          <h3 class="text-base font-bold text-amber-700 mb-3">âš ï¸ æ³¨æ„ç‚¹</h3>
          <ul class="space-y-2">
            ${area.risks.map(r => `<li class="text-sm text-amber-800 flex items-start gap-2"><span class="mt-0.5">â€¢</span>${r}</li>`).join('')}
          </ul>
        </div>
      </div>

      <!-- ãŠã™ã™ã‚ã‚¨ãƒªã‚¢ -->
      <div class="rounded-xl p-6 bg-blue-50 border border-blue-200">
        <h3 class="text-base font-bold text-blue-700 mb-3">ğŸ¯ ${area.name}ã®ãŠã™ã™ã‚ç‰©ä»¶ã‚¨ãƒªã‚¢</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          ${area.recAreas.map((r,i) => `
            <div class="bg-white rounded-lg p-4 border border-blue-100">
              <div class="text-xs text-blue-500 font-medium mb-1">ãŠã™ã™ã‚ ${i+1}</div>
              <div class="text-sm font-medium text-gray-800">${r}</div>
            </div>
          `).join('')}
        </div>
      </div>

    </div>
  `;
}

// ============================================================
// Map View
// ============================================================
function renderMap(ranked) {
  const selArea = state.mapSelectedAreaId ? ranked.find(a => a.id === state.mapSelectedAreaId) : null;
  return `
    <div class="space-y-4 fade-in">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-800">ğŸ—ºï¸ ã‚¨ãƒªã‚¢ãƒãƒƒãƒ—</h2>
        <div class="flex gap-2">
          <button id="btn-district-area-toggle" class="school-toggle ${showDistrictAreas ? 'active' : ''}" onclick="toggleDistrictAreas()">
            <span>${showDistrictAreas ? 'ğŸ“Š ã‚¨ãƒªã‚¢ ON' : 'ğŸ“Š ã‚¨ãƒªã‚¢'}</span>
          </button>
          <button id="btn-school-toggle" class="school-toggle ${showSchoolDistricts ? 'active' : ''}" onclick="toggleSchoolDistricts()">
            <span>${showSchoolDistricts ? 'ğŸ« å­¦åŒº ON' : 'ğŸ« å­¦åŒº'}</span>
          </button>
          <button id="btn-fullscreen-toggle" class="map-fullscreen-btn" onclick="toggleMapFullscreen()">
            <span id="fullscreen-icon">â›¶</span> <span id="fullscreen-label">æ‹¡å¤§</span>
          </button>
        </div>
      </div>
      <!-- Fullscreen floating controls -->
      <div id="map-fullscreen-controls" class="map-fullscreen-controls">
        <span style="font-weight:600;font-size:13px;color:#1e40af;">ğŸ—ºï¸ ã‚¨ãƒªã‚¢ãƒãƒƒãƒ—</span>
        <button class="school-toggle ${showDistrictAreas ? 'active' : ''}" onclick="toggleDistrictAreas()">
          <span>${showDistrictAreas ? 'ğŸ“Š ã‚¨ãƒªã‚¢ ON' : 'ğŸ“Š ã‚¨ãƒªã‚¢'}</span>
        </button>
        <button class="school-toggle ${showSchoolDistricts ? 'active' : ''}" onclick="toggleSchoolDistricts()">
          <span>${showSchoolDistricts ? 'ğŸ« å­¦åŒº ON' : 'ğŸ« å­¦åŒº'}</span>
        </button>
        <button class="map-fullscreen-btn active" onclick="toggleMapFullscreen()">
          <span>âœ•</span> <span>é–‰ã˜ã‚‹</span>
        </button>
      </div>
      <div class="card overflow-hidden">
        <div class="map-layout" style="position:relative;">
          <div id="map-container"></div>
          <div id="map-loading-overlay" class="map-loading-overlay hidden">
            <div class="map-loading-box">
              <div class="map-loading-spinner"></div>
              <div id="map-loading-text" style="font-size:13px;font-weight:600;color:#1e40af;">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>
              <div class="map-loading-progress"><div id="map-loading-bar" class="map-loading-progress-bar" style="width:0%"></div></div>
            </div>
          </div>
          <div id="map-sidebar">
            ${selArea ? '' : `
              <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="text-4xl mb-3">ğŸ“</div>
                <p class="text-sm font-medium text-gray-700 mb-1">ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                <p class="text-xs text-gray-400">ãƒãƒƒãƒ—ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>åœŸåœ°æƒ…å ±ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
              </div>
            `}
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Map Fullscreen Toggle
// ============================================================
let _mapFullscreen = false;

function toggleMapFullscreen() {
  _mapFullscreen = !_mapFullscreen;
  const layout = document.querySelector('.map-layout');
  const btn = document.getElementById('btn-fullscreen-toggle');
  const icon = document.getElementById('fullscreen-icon');
  const label = document.getElementById('fullscreen-label');
  const floatingCtrl = document.getElementById('map-fullscreen-controls');
  if (!layout) return;

  if (_mapFullscreen) {
    layout.classList.add('map-fullscreen');
    if (btn) btn.classList.add('active');
    if (icon) icon.textContent = 'âœ•';
    if (label) label.textContent = 'é–‰ã˜ã‚‹';
    // ã‚«ãƒ¼ãƒ‰ã®è§’ä¸¸ã‚’ç„¡åŠ¹åŒ–
    const card = layout.closest('.card');
    if (card) card.style.borderRadius = '0';
    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º
    if (floatingCtrl) floatingCtrl.classList.add('visible');
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹åŒ–
    document.body.style.overflow = 'hidden';
  } else {
    layout.classList.remove('map-fullscreen');
    if (btn) btn.classList.remove('active');
    if (icon) icon.textContent = 'â›¶';
    if (label) label.textContent = 'æ‹¡å¤§';
    const card = layout.closest('.card');
    if (card) card.style.borderRadius = '';
    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éè¡¨ç¤º
    if (floatingCtrl) floatingCtrl.classList.remove('visible');
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©æ´»
    document.body.style.overflow = '';
  }

  // Leafletåœ°å›³ã‚µã‚¤ã‚ºå†è¨ˆç®—
  if (mapInstance) {
    setTimeout(() => { mapInstance.invalidateSize(); }, 200);
  }
}

// ESCã‚­ãƒ¼ã§å…¨ç”»é¢è§£é™¤
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && _mapFullscreen) {
    toggleMapFullscreen();
  }
});

// ============================================================
// School District Layer
// ============================================================
const SCHOOL_DISTRICT_COLORS = [
  '#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316',
  '#14b8a6','#6366f1','#84cc16','#e11d48','#0ea5e9','#a855f7','#10b981','#f43f5e'
];

// ============================================================
// District Area Layer (toggleable, like school districts)
// ============================================================
const DISTRICT_AREA_COLORS = [
  '#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316',
  '#14b8a6','#6366f1','#84cc16','#e11d48','#0ea5e9','#a855f7','#10b981','#f43f5e'
];

function toggleDistrictAreas() {
  showDistrictAreas = !showDistrictAreas;
  const btn = document.getElementById('btn-district-area-toggle');
  if (btn) {
    btn.classList.toggle('active', showDistrictAreas);
    btn.querySelector('span').textContent = showDistrictAreas ? 'ğŸ“Š ã‚¨ãƒªã‚¢ ON' : 'ğŸ“Š ã‚¨ãƒªã‚¢';
  }
  if (showDistrictAreas) {
    renderDistrictAreas();
  } else {
    if (districtAreaLayer && mapInstance) {
      mapInstance.removeLayer(districtAreaLayer);
      districtAreaLayer = null;
    }
    // Clear district sidebar if showing
    state.mapSelectedDistrict = null;
  }
}

function renderDistrictAreas() {
  if (!mapInstance) return;
  if (districtAreaLayer) { mapInstance.removeLayer(districtAreaLayer); }
  districtAreaLayer = L.layerGroup();

  // Collect all districts with coordinates from all areas that have transactions
  const districtEntries = [];
  AREAS.forEach(area => {
    if (!area._liveTransactions) return;
    const districtMap = {};
    area._liveTransactions.forEach(tx => {
      if (!tx.District) return;
      if (!districtMap[tx.District]) districtMap[tx.District] = 0;
      districtMap[tx.District]++;
    });
    Object.entries(districtMap).forEach(([districtName, count]) => {
      const coords = findDistrictCoords(districtName, area.name);
      if (coords) {
        districtEntries.push({ districtName, cityName: area.name, cityId: area.id, coords, count, area });
      }
    });
  });

  let colorIdx = 0;
  districtEntries.forEach(entry => {
    const color = DISTRICT_AREA_COLORS[colorIdx++ % DISTRICT_AREA_COLORS.length];
    const radius = Math.max(200, Math.min(600, entry.count * 80));

    const circle = L.circle([entry.coords[0], entry.coords[1]], {
      radius: radius,
      color: color,
      weight: 2,
      opacity: 0.8,
      fillColor: color,
      fillOpacity: 0.15,
      dashArray: '4 3'
    });

    // Tooltip with district name
    circle.bindTooltip(`${entry.districtName} (${entry.count}ä»¶)`, {
      permanent: false, direction: 'top', className: 'map-tooltip'
    });

    // Click â†’ show district info in sidebar
    circle.on('click', () => {
      state.mapSelectedDistrict = { cityId: entry.cityId, districtName: entry.districtName };
      state.mapSelectedAreaId = entry.cityId;
      const ranked = getRankedAreas();
      updateDistrictSidebar(entry.area, entry.districtName, ranked);
      // Highlight this district circle
      renderDistrictAreas();
    });

    // Highlight selected district
    if (state.mapSelectedDistrict &&
        state.mapSelectedDistrict.cityId === entry.cityId &&
        state.mapSelectedDistrict.districtName === entry.districtName) {
      circle.setStyle({ fillOpacity: 0.35, weight: 3, opacity: 1, dashArray: null });
    }

    circle.on('mouseover', function() { this.setStyle({ fillOpacity: 0.3, weight: 3 }); });
    circle.on('mouseout', function() {
      const isSelected = state.mapSelectedDistrict &&
        state.mapSelectedDistrict.cityId === entry.cityId &&
        state.mapSelectedDistrict.districtName === entry.districtName;
      this.setStyle({
        fillOpacity: isSelected ? 0.35 : 0.15,
        weight: isSelected ? 3 : 2
      });
    });

    districtAreaLayer.addLayer(circle);

    // Add label marker
    const label = L.marker([entry.coords[0], entry.coords[1]], {
      icon: L.divIcon({
        html: `<div style="font-size:10px;font-weight:600;color:${color};text-shadow:1px 1px 2px white,-1px -1px 2px white,1px -1px 2px white,-1px 1px 2px white;white-space:nowrap;text-align:center;pointer-events:none;">${entry.districtName}</div>`,
        className: 'school-icon-marker',
        iconSize: [80, 16],
        iconAnchor: [40, 8]
      }),
      interactive: false
    });
    districtAreaLayer.addLayer(label);
  });

  districtAreaLayer.addTo(mapInstance);
}

// ============================================================
// School District Layer
// ============================================================
async function loadSchoolDistrictData() {
  if (schoolDistrictData) return schoolDistrictData;
  try {
    const resp = await fetch('school-districts.geojson');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    schoolDistrictData = await resp.json();
    console.log(`School districts loaded: ${schoolDistrictData.features.length} zones`);
    return schoolDistrictData;
  } catch(e) {
    console.warn('School district data load failed:', e);
    return null;
  }
}

function toggleSchoolDistricts() {
  showSchoolDistricts = !showSchoolDistricts;
  const btn = document.getElementById('btn-school-toggle');
  if (btn) {
    btn.classList.toggle('active', showSchoolDistricts);
    btn.querySelector('span').textContent = showSchoolDistricts ? 'ğŸ« å­¦åŒº ON' : 'ğŸ« å­¦åŒº';
  }
  if (showSchoolDistricts) {
    renderSchoolDistricts();
  } else {
    if (schoolDistrictLayer && mapInstance) {
      mapInstance.removeLayer(schoolDistrictLayer);
      schoolDistrictLayer = null;
    }
    if (schoolMarkerLayer && mapInstance) {
      mapInstance.removeLayer(schoolMarkerLayer);
      schoolMarkerLayer = null;
    }
  }
}

async function renderSchoolDistricts() {
  if (!mapInstance) return;
  const data = await loadSchoolDistrictData();
  if (!data) return;

  // Remove existing layers
  if (schoolDistrictLayer) { mapInstance.removeLayer(schoolDistrictLayer); }
  if (schoolMarkerLayer) { mapInstance.removeLayer(schoolMarkerLayer); }

  // Separate polygons and points
  const polygonFeatures = { type: 'FeatureCollection', features: data.features.filter(f => f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon') };
  const pointFeatures = data.features.filter(f => f.geometry.type === 'Point' && f.properties.type === 'school');

  // Render polygon overlays (school district boundaries)
  let colorIdx = 0;
  schoolDistrictLayer = L.geoJSON(polygonFeatures, {
    style: (feature) => {
      const color = SCHOOL_DISTRICT_COLORS[colorIdx++ % SCHOOL_DISTRICT_COLORS.length];
      return { color, weight: 2, opacity: 0.7, fillColor: color, fillOpacity: 0.08, dashArray: '4 3' };
    },
    onEachFeature: (feature, layer) => {
      const p = feature.properties;
      layer.bindPopup(`
        <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
          <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">ğŸ« ${p.name}</div>
          <table style="font-size:11px;">
            <tr><td style="color:#6b7280;padding-right:8px;">è¨­ç½®è€…</td><td>${p.org}</td></tr>
            <tr><td style="color:#6b7280;padding-right:8px;">æ‰€åœ¨åœ°</td><td>${p.address}</td></tr>
          </table>
        </div>
      `, { maxWidth: 240 });
      layer.on('mouseover', function() { this.setStyle({ fillOpacity: 0.25, weight: 3 }); });
      layer.on('mouseout', function() { this.setStyle({ fillOpacity: 0.08, weight: 2 }); });
    }
  }).addTo(mapInstance);
  schoolDistrictLayer.bringToBack();

  // Render school icon markers
  const schoolIcon = L.divIcon({
    html: '<div style="font-size:20px;text-align:center;line-height:1;filter:drop-shadow(1px 1px 1px rgba(0,0,0,0.3));">ğŸ«</div>',
    className: 'school-icon-marker',
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -14]
  });

  schoolMarkerLayer = L.layerGroup();
  pointFeatures.forEach(f => {
    const p = f.properties;
    const coords = f.geometry.coordinates;
    const marker = L.marker([coords[1], coords[0]], { icon: schoolIcon, zIndexOffset: 500 });
    marker.bindPopup(`
      <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
        <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">ğŸ« ${p.name}</div>
        <table style="font-size:11px;">
          <tr><td style="color:#6b7280;padding-right:8px;">è¨­ç½®è€…</td><td>${p.org}</td></tr>
          <tr><td style="color:#6b7280;padding-right:8px;">æ‰€åœ¨åœ°</td><td>${p.address}</td></tr>
        </table>
      </div>
    `, { maxWidth: 240 });
    schoolMarkerLayer.addLayer(marker);
  });
  schoolMarkerLayer.addTo(mapInstance);
}

function initializeMap(ranked) {
  const container = document.getElementById('map-container');
  if (!container || !window.L) return;

  // Destroy existing map if present (container re-created by render)
  if (mapInstance) {
    try { mapInstance.remove(); } catch {}
    mapInstance = null;
    mapMarkers = {};
    txMarkerLayer = null;
  }

  // Create map centered on northern Mie
  mapInstance = L.map('map-container', { zoomControl: true }).setView([34.98, 136.56], 10);

  // OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>',
    maxZoom: 18
  }).addTo(mapInstance);

  // Transaction marker layer
  txMarkerLayer = L.layerGroup().addTo(mapInstance);

  // Create city markers
  ranked.forEach((area, idx) => {
    const color = COLORS[AREAS.findIndex(a => a.id === area.id) % COLORS.length];
    const rank = idx + 1;
    const icon = createMapIcon(color, rank, area.scores.total, area.id === state.mapSelectedAreaId);

    const marker = L.marker([area.lat, area.lng], { icon, zIndexOffset: 1000 })
      .addTo(mapInstance);

    marker.bindTooltip(`${area.name} (${area.scores.total}pt)`, {
      direction: 'top', offset: [0, -20], className: 'map-tooltip'
    });

    marker.on('click', async () => {
      state.mapSelectedAreaId = area.id;
      state.mapSelectedDistrict = null; // Reset district selection
      ranked.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, a.id === area.id));
      });
      updateMapSidebar(area, ranked);
      // Geocode districts before showing pins
      await geocodeAreaDistricts(area);
      showTransactionPins(area);
      mapInstance.flyTo([area.lat, area.lng], 13, { duration: 0.8 });

      // æœªå–å¾—ã‚¨ãƒªã‚¢ãªã‚‰å„ªå…ˆæŒ‡å®šï¼ˆè‡ªå‹•å–å¾—ä¸­â†’æ¬¡ã«å‡¦ç†ã€åœæ­¢ä¸­â†’ç›´æ¥å–å¾—ï¼‰
      if (!AREA_FULL_LOADED.has(area.id)) {
        _fetchPriorityAreaId = area.id;
        if (!_autoFetchRunning && mcpReinfo && mcpReinfo.connected) {
          fetchAreaFullData(area.id);
        }
      }
    });

    mapMarkers[area.id] = marker;
  });

  // Ensure map renders correctly (especially on mobile)
  setTimeout(() => { if (mapInstance) mapInstance.invalidateSize(); }, 100);
  setTimeout(() => { if (mapInstance) mapInstance.invalidateSize(); }, 500);

  // Show all transaction pins at overview
  showAllTransactionPins(ranked);

  // Restore layers if enabled
  if (showSchoolDistricts) {
    renderSchoolDistricts();
  }
  if (showDistrictAreas) {
    renderDistrictAreas();
  }

  // If area already selected, zoom to it and auto-fetch full data
  if (state.mapSelectedAreaId) {
    const sel = ranked.find(a => a.id === state.mapSelectedAreaId);
    if (sel) {
      showTransactionPins(sel);
      mapInstance.setView([sel.lat, sel.lng], 13);
      if (!AREA_FULL_LOADED.has(sel.id)) {
        _fetchPriorityAreaId = sel.id;
        if (!_autoFetchRunning && mcpReinfo && mcpReinfo.connected) {
          fetchAreaFullData(sel.id);
        }
      }
    }
  }
}

// ============================================================
// Station Coordinate Database (Northern Mie Prefecture)
// ============================================================
const STATION_COORDS = {
  // å››æ—¥å¸‚å¸‚
  'è¿‘é‰„å››æ—¥å¸‚':[34.9665,136.6142],'å››æ—¥å¸‚':[34.9667,136.6186],'å¯Œç”°':[34.989,136.6266],
  'å¯Œæ´²åŸ':[34.997,136.631],'é˜¿å€‰å·':[34.976,136.6175],'å·åŸç”º':[34.972,136.6153],
  'æ–°æ­£':[34.962,136.6154],'èµ¤å €':[34.958,136.6156],'æ—¥æ°¸':[34.944,136.6088],
  'å—æ—¥æ°¸':[34.952,136.612],'æ³Š':[34.938,136.611],'è¿½åˆ†':[34.934,136.605],
  'å†…éƒ¨':[34.928,136.5925],'å°å¤æ›½':[34.936,136.599],'æ²³åŸç”°':[34.912,136.5814],
  'å¡©æµœ':[34.938,136.6217],'æµ·å±±é“':[34.956,136.6238],'éœãƒ¶æµ¦':[34.957,136.6262],
  'å¤§çŸ¢çŸ¥':[34.997,136.628],'å¹³æ´¥':[34.996,136.618],'æšå­¦åœ’å‰':[34.993,136.608],
  'å±±åŸ':[34.981,136.5936],'ä¿ã€…':[34.991,136.582],'åŒ—æ¥ ':[34.918,136.61],
  'æ¥ ':[34.912,136.615],'å—å››æ—¥å¸‚':[34.947,136.62],'ä¸­å·åŸ':[34.961,136.607],
  'ä¼Šå‹¢æ¾æœ¬':[34.969,136.601],'è¥¿æ—¥é‡':[34.95,136.597],'è¿‘é‰„å¯Œç”°':[34.988,136.622],
  // æ¡‘åå¸‚
  'æ¡‘å':[35.0614,136.6918],'æ’­ç£¨':[35.046,136.677],'ç›Šç”Ÿ':[35.066,136.6785],
  'é¦¬é“':[35.06,136.686],'è¥¿æ¡‘å':[35.062,136.686],'åœ¨è‰¯':[35.073,136.676],
  'æ˜Ÿå·':[35.081,136.671],'ä¸ƒå’Œ':[35.087,136.659],'ç©´å¤ª':[35.091,136.65],
  'å¤šåº¦':[35.117,136.629],'é•·å³¶':[35.076,136.715],'è“®èŠ±å¯º':[35.078,136.665],
  'ä¸‹æ·±è°·':[35.039,136.669],'ä¼Šå‹¢æœæ—¥':[35.032,136.669],
  // éˆ´é¹¿å¸‚
  'ç™½å­':[34.843,136.611],'éˆ´é¹¿':[34.871,136.543],'éˆ´é¹¿å¸‚':[34.881,136.581],
  'ä¸‰æ—¥å¸‚':[34.874,136.577],'å¹³ç”°ç”º':[34.876,136.559],'åŠ ä½ç™»':[34.886,136.523],
  'ç‰å£':[34.855,136.601],'æŸ³':[34.848,136.599],'ç£¯å±±':[34.836,136.615],
  'åƒä»£å´':[34.831,136.617],'ç®•ç”°':[34.863,136.593],'é¼“ãƒ¶æµ¦':[34.838,136.613],
  'å¾³ç”°':[34.884,136.559],'ä¼Šå‹¢è‹¥æ¾':[34.856,136.608],'åƒé‡Œ':[34.887,136.506],
  'ä¸­ç€¬å¤':[34.866,136.571],
  // ã„ãªã¹å¸‚
  'ä¸‰é‡Œ':[35.093,136.554],'åŒ—å‹¢ä¸­å¤®å…¬åœ’å£':[35.087,136.548],'éº»ç”Ÿç”°':[35.099,136.548],
  'é˜¿ä¸‹å–œ':[35.126,136.549],'æ¥šåŸ':[35.116,136.549],'å¤§æ³‰':[35.108,136.554],
  'æ¢…æˆ¸äº•':[35.084,136.551],
  // äº€å±±å¸‚
  'äº€å±±':[34.855,136.449],'é–¢':[34.855,136.397],'åŠ å¤ª':[34.85,136.355],
  'äº•ç”°å·':[34.874,136.489],
  // è°é‡ç”º
  'è°é‡':[35.017,136.516],'ä¸­è°é‡':[35.024,136.509],'å¤§ç¾½æ ¹åœ’':[35.029,136.502],
  'æ¹¯ã®å±±æ¸©æ³‰':[35.036,136.486],'æ¡œ':[35.009,136.528],
  // æ±å“¡ç”º
  'æ±å“¡':[35.06,136.595],'å¤§é•·':[35.066,136.589],'åŒ—å¤§ç¤¾':[35.073,136.592],
};

// Station â†’ Nagoya commute time (minutes, approximate)
const STATION_TO_NAGOYA_MIN = {
  // å››æ—¥å¸‚å¸‚
  'è¿‘é‰„å››æ—¥å¸‚':35,'å››æ—¥å¸‚':50,'å¯Œç”°':38,'å¯Œæ´²åŸ':40,'é˜¿å€‰å·':37,'å·åŸç”º':36,
  'æ–°æ­£':36,'èµ¤å €':37,'æ—¥æ°¸':40,'å—æ—¥æ°¸':39,'æ³Š':42,'è¿½åˆ†':43,
  'å†…éƒ¨':45,'å°å¤æ›½':44,'æ²³åŸç”°':48,'å¡©æµœ':42,'æµ·å±±é“':38,'éœãƒ¶æµ¦':37,
  'å¤§çŸ¢çŸ¥':40,'å¹³æ´¥':42,'æšå­¦åœ’å‰':44,'å±±åŸ':46,'ä¿ã€…':48,'åŒ—æ¥ ':48,
  'æ¥ ':50,'å—å››æ—¥å¸‚':40,'ä¸­å·åŸ':38,'ä¼Šå‹¢æ¾æœ¬':40,'è¥¿æ—¥é‡':42,'è¿‘é‰„å¯Œç”°':37,
  // æ¡‘åå¸‚
  'æ¡‘å':25,'æ’­ç£¨':30,'ç›Šç”Ÿ':27,'é¦¬é“':26,'è¥¿æ¡‘å':26,'åœ¨è‰¯':28,
  'æ˜Ÿå·':30,'ä¸ƒå’Œ':32,'ç©´å¤ª':34,'å¤šåº¦':40,'é•·å³¶':22,'è“®èŠ±å¯º':31,
  'ä¸‹æ·±è°·':32,'ä¼Šå‹¢æœæ—¥':33,
  // éˆ´é¹¿å¸‚
  'ç™½å­':55,'éˆ´é¹¿':65,'éˆ´é¹¿å¸‚':60,'ä¸‰æ—¥å¸‚':62,'å¹³ç”°ç”º':63,'åŠ ä½ç™»':68,
  'ç‰å£':57,'æŸ³':58,'ç£¯å±±':56,'åƒä»£å´':54,'ç®•ç”°':59,'é¼“ãƒ¶æµ¦':55,
  'å¾³ç”°':63,'ä¼Šå‹¢è‹¥æ¾':56,'åƒé‡Œ':70,'ä¸­ç€¬å¤':61,
  // ã„ãªã¹å¸‚
  'ä¸‰é‡Œ':52,'åŒ—å‹¢ä¸­å¤®å…¬åœ’å£':53,'éº»ç”Ÿç”°':54,'é˜¿ä¸‹å–œ':58,'æ¥šåŸ':56,'å¤§æ³‰':54,'æ¢…æˆ¸äº•':51,
  // äº€å±±å¸‚
  'äº€å±±':70,'é–¢':80,'åŠ å¤ª':90,'äº•ç”°å·':65,
  // è°é‡ç”º
  'è°é‡':50,'ä¸­è°é‡':52,'å¤§ç¾½æ ¹åœ’':54,'æ¹¯ã®å±±æ¸©æ³‰':58,'æ¡œ':48,
  // æ±å“¡ç”º
  'æ±å“¡':38,'å¤§é•·':40,'åŒ—å¤§ç¤¾':42,
};

function findStationCoords(stationName) {
  if (!stationName) return null;
  if (STATION_COORDS[stationName]) return STATION_COORDS[stationName];
  const cleaned = stationName.replace(/é§…$/, '').replace(/\(.*\)/, '').trim();
  if (STATION_COORDS[cleaned]) return STATION_COORDS[cleaned];
  for (const [key, coords] of Object.entries(STATION_COORDS)) {
    if (cleaned.includes(key) || key.includes(cleaned)) return coords;
  }
  return null;
}

// ============================================================
// District Geocoding (Nominatim + localStorage cache)
// ============================================================
const DISTRICT_CACHE = new Map();
const DISTRICT_CACHE_KEY = 'mie-realestate-district-coords-v2';

// Load cached coords from localStorage on startup
function loadDistrictCache() {
  try {
    const stored = localStorage.getItem(DISTRICT_CACHE_KEY);
    if (!stored) return;
    const obj = JSON.parse(stored);
    for (const [k, v] of Object.entries(obj)) {
      DISTRICT_CACHE.set(k, v);
    }
    console.log(`District cache loaded: ${DISTRICT_CACHE.size} entries`);
  } catch(e) { console.warn('Cache load failed:', e); }
}

function saveDistrictCache() {
  try {
    const obj = {};
    for (const [k, v] of DISTRICT_CACHE.entries()) obj[k] = v;
    localStorage.setItem(DISTRICT_CACHE_KEY, JSON.stringify(obj));
  } catch(e) { console.warn('Cache save failed:', e); }
}

async function geocodeDistrict(district, cityName) {
  const cacheKey = `${cityName}-${district}`;
  if (DISTRICT_CACHE.has(cacheKey)) return DISTRICT_CACHE.get(cacheKey);

  // Try GSI (å›½åœŸåœ°ç†é™¢) API first, then Nominatim as fallback
  const queries = [
    `ä¸‰é‡çœŒ${cityName}${district}`,
    `${cityName}${district}`,
  ];

  // GSI API (more reliable for Japanese addresses)
  for (const q of queries) {
    try {
      const url = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(q)}`;
      const resp = await fetch(url);
      if (!resp.ok) continue;
      const results = await resp.json();
      if (results.length > 0) {
        const coords_arr = results[0].geometry.coordinates; // [lng, lat]
        const lat = parseFloat(coords_arr[1]);
        const lng = parseFloat(coords_arr[0]);
        if (lat >= 34.2 && lat <= 35.5 && lng >= 135.8 && lng <= 137.0) {
          const coords = [lat, lng];
          DISTRICT_CACHE.set(cacheKey, coords);
          return coords;
        }
      }
    } catch(e) { /* skip */ }
  }

  // Nominatim fallback
  const nomQueries = [`${district}, ${cityName}, ä¸‰é‡çœŒ`, `${district}, ${cityName}`];
  for (const q of nomQueries) {
    try {
      const url = `https://nominatim.openstreetmap.org/search?` +
        `q=${encodeURIComponent(q)}&format=json&limit=1&countrycodes=jp`;
      const resp = await fetch(url, {
        headers: { 'User-Agent': 'MieRealEstateApp/1.0' }
      });
      if (!resp.ok) continue;
      const results = await resp.json();
      if (results.length > 0) {
        const lat = parseFloat(results[0].lat);
        const lng = parseFloat(results[0].lon);
        if (lat >= 34.2 && lat <= 35.5 && lng >= 135.8 && lng <= 137.0) {
          const coords = [lat, lng];
          DISTRICT_CACHE.set(cacheKey, coords);
          return coords;
        }
      }
    } catch(e) { /* skip */ }
  }

  // Mark as not found so we don't retry
  DISTRICT_CACHE.set(cacheKey, null);
  return null;
}

// Background geocoding - doesn't block UI
async function geocodeDistrictsBackground() {
  // Collect uncached district+city pairs
  const uncached = [];
  for (const area of AREAS) {
    if (!area._liveTransactions) continue;
    for (const tx of area._liveTransactions) {
      if (!tx.District) continue;
      const key = `${area.name}-${tx.District}`;
      if (!DISTRICT_CACHE.has(key) && !uncached.find(u => u.key === key)) {
        uncached.push({ key, district: tx.District, cityName: area.name });
      }
    }
  }

  if (uncached.length === 0) return;

  const total = uncached.length;
  let done = 0;

  for (const { district, cityName } of uncached) {
    done++;
    updateStatusText(`åœ°åŒºã®ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­... (${done}/${total})`);
    await geocodeDistrict(district, cityName);
    // Save every 5 results
    if (done % 5 === 0) saveDistrictCache();
    // Rate limit: 300ms between requests (GSI API is less restrictive than Nominatim)
    if (done < total) await new Promise(r => setTimeout(r, 300));
  }

  saveDistrictCache();

  // Refresh map pins with newly geocoded positions
  updateStatusText(`ä½ç½®æƒ…å ±å–å¾—å®Œäº† (${done}ä»¶) â€” ãƒ”ãƒ³ã‚’æ›´æ–°ä¸­...`);
  if (state.view === 'map' && txMarkerLayer) {
    const ranked = getRankedAreas();
    if (state.mapSelectedAreaId) {
      const sel = ranked.find(a => a.id === state.mapSelectedAreaId);
      if (sel) showTransactionPins(sel);
    } else {
      showAllTransactionPins(ranked);
    }
  }

  const cached = Array.from(DISTRICT_CACHE.values()).filter(v => v !== null).length;
  updateStatusText(`ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº† â€” åœ°åŒºä½ç½®: ${cached}ä»¶è§£æ±ºæ¸ˆã¿`);
}

function findDistrictCoords(district, cityName) {
  if (!district || !cityName) return null;
  const key = `${cityName}-${district}`;
  return DISTRICT_CACHE.get(key) || null;
}

// Aggregate metrics for a single district within an area
function aggregateDistrictMetrics(area, districtName) {
  if (!area._liveTransactions || !districtName) return null;
  // Preserve original index in _liveTransactions for map pin reference
  const txs = area._liveTransactions
    .map((t, i) => ({ ...t, _areaIdx: i }))
    .filter(t => t.District === districtName);
  if (txs.length === 0) return null;

  // Prices
  const prices = txs.filter(t => t.TradePrice != null && !isNaN(t.TradePrice)).map(t => t.TradePrice);
  const avgPrice = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : null;
  const minPrice = prices.length > 0 ? Math.min(...prices) : null;
  const maxPrice = prices.length > 0 ? Math.max(...prices) : null;

  // Price per mÂ²
  const pricePerM2 = txs
    .filter(t => t.TradePrice != null && !isNaN(t.TradePrice) && t.Area && t.Area > 0)
    .map(t => t.TradePrice / t.Area);
  const avgPricePerM2 = pricePerM2.length > 0 ? pricePerM2.reduce((a, b) => a + b, 0) / pricePerM2.length : null;

  // Most frequent station
  const stationCounts = {};
  txs.forEach(t => {
    if (t.NearestStation) {
      const s = t.NearestStation.replace(/\(.*\)/, '').trim();
      stationCounts[s] = (stationCounts[s] || 0) + 1;
    }
  });
  const topStation = Object.entries(stationCounts).sort((a, b) => b[1] - a[1])[0];
  const nearestStation = topStation ? topStation[0] : null;

  // Nagoya commute time
  let nagoyaMin = null;
  if (nearestStation) {
    const cleaned = nearestStation.replace(/é§…$/, '').trim();
    nagoyaMin = STATION_TO_NAGOYA_MIN[cleaned] || STATION_TO_NAGOYA_MIN[nearestStation] || null;
    if (!nagoyaMin) {
      for (const [key, min] of Object.entries(STATION_TO_NAGOYA_MIN)) {
        if (cleaned.includes(key) || key.includes(cleaned)) { nagoyaMin = min; break; }
      }
    }
  }
  if (!nagoyaMin) nagoyaMin = area.accessToNagoya; // fallback to city level

  // Distance to station (average)
  const distances = txs.filter(t => t.DistanceToStation).map(t => {
    const m = String(t.DistanceToStation).match(/(\d+)/);
    return m ? parseInt(m[1]) : null;
  }).filter(Boolean);
  const avgDistance = distances.length > 0 ? Math.round(distances.reduce((a, b) => a + b, 0) / distances.length) : null;

  // Property type distribution
  const typeCounts = {};
  txs.forEach(t => {
    const type = t.Type || t.Use || 'ãã®ä»–';
    typeCounts[type] = (typeCounts[type] || 0) + 1;
  });
  const typeDistribution = Object.entries(typeCounts)
    .map(([name, count]) => ({ name, count, pct: Math.round(count / txs.length * 100) }))
    .sort((a, b) => b.count - a.count);

  // Average building age
  const currentYear = new Date().getFullYear();
  const ages = txs.filter(t => t.BuildingYear).map(t => {
    const yr = String(t.BuildingYear);
    // Handle "ä»¤å’ŒXå¹´", "å¹³æˆXå¹´", "æ˜­å’ŒXå¹´" or just year number
    let builtYear = parseInt(yr);
    if (yr.includes('ä»¤å’Œ')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 2018 + n; }
    else if (yr.includes('å¹³æˆ')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 1988 + n; }
    else if (yr.includes('æ˜­å’Œ')) { const n = parseInt(yr.replace(/[^0-9]/g, '')); builtYear = 1925 + n; }
    if (builtYear > 1900 && builtYear <= currentYear) return currentYear - builtYear;
    return null;
  }).filter(Boolean);
  const avgBuildingAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : null;

  // District coordinates
  const coords = findDistrictCoords(districtName, area.name);

  return {
    districtName, cityName: area.name, cityId: area.id,
    count: txs.length, transactions: txs,
    avgPrice, minPrice, maxPrice,
    avgPricePerM2,
    nearestStation, nagoyaMin, avgDistance,
    typeDistribution, avgBuildingAge, coords
  };
}

// Geocode all districts for a single area BEFORE showing pins
async function geocodeAreaDistricts(area, options = {}) {
  if (!area._liveTransactions) return;
  const uncached = [];
  for (const tx of area._liveTransactions) {
    if (!tx.District) continue;
    const key = `${area.name}-${tx.District}`;
    if (!DISTRICT_CACHE.has(key) && !uncached.find(u => u.key === key)) {
      uncached.push({ key, district: tx.District, cityName: area.name });
    }
  }
  if (uncached.length === 0) return;

  const showOverlay = options.showOverlay !== undefined ? options.showOverlay : true;
  const total = uncached.length;
  let done = 0;
  if (showOverlay) showMapLoading(`${area.name} åœ°åŒºæƒ…å ±å–å¾—ä¸­...`, 0);
  for (const { district, cityName } of uncached) {
    done++;
    if (showOverlay) updateMapLoading(`${area.name} åœ°åŒºæƒ…å ±å–å¾—ä¸­... (${done}/${total})`, (done / total) * 100);
    await geocodeDistrict(district, cityName);
    if (done % 5 === 0) saveDistrictCache();
    if (done < total) await new Promise(r => setTimeout(r, 200));
  }
  saveDistrictCache();
  if (showOverlay) hideMapLoading();
}

function hashStr(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) {
    h = ((h << 5) - h + s.charCodeAt(i)) | 0;
  }
  return Math.abs(h);
}

function estimateTxPosition(area, tx, idx) {
  // Priority 1: District geocoded coords (most accurate for this data)
  const districtCoords = findDistrictCoords(tx.District, area.name);
  if (districtCoords) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.001 + (idx % 7) * 0.0005;
    return {
      lat: districtCoords[0] + Math.cos(jitterAngle) * jitter,
      lng: districtCoords[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 2: Station coordinates (from NearestStation field)
  const stationCoords = findStationCoords(tx.NearestStation);
  if (stationCoords) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.0008 + (idx % 5) * 0.0004;
    return {
      lat: stationCoords[0] + Math.cos(jitterAngle) * jitter,
      lng: stationCoords[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 3: District name â†’ fuzzy match against station names
  const stationFromDistrict = findStationCoords(tx.District);
  if (stationFromDistrict) {
    const jitterAngle = (idx * 137.508) * (Math.PI / 180);
    const jitter = 0.0015 + (idx % 7) * 0.0005;
    return {
      lat: stationFromDistrict[0] + Math.cos(jitterAngle) * jitter,
      lng: stationFromDistrict[1] + Math.sin(jitterAngle) * jitter
    };
  }

  // Priority 4: Fallback - bias inland from city center
  const districtKey = tx.District || tx.NearestStation || `tx-${idx}`;
  const hash = hashStr(districtKey + area.id);
  const baseAngle = 150 + (hash % 200);
  const angle = baseAngle * (Math.PI / 180);
  const spread = 0.004 + (hash % 40) / 40 * 0.012;
  const baseLat = area.lat + Math.cos(angle) * spread;
  const baseLng = area.lng + Math.sin(angle) * spread;

  const jitterAngle = (idx * 137.508) * (Math.PI / 180);
  const jitter = 0.0008 + (idx % 5) * 0.0004;

  return {
    lat: baseLat + Math.cos(jitterAngle) * jitter,
    lng: baseLng + Math.sin(jitterAngle) * jitter
  };
}

// Get color based on price (green=cheap, yellow=mid, red=expensive)
function priceColor(price) {
  if (!price || isNaN(price)) return '#9ca3af';
  if (price < 5000000) return '#22c55e';    // green: <500ä¸‡
  if (price < 15000000) return '#3b82f6';   // blue: 500-1500ä¸‡
  if (price < 30000000) return '#f59e0b';   // amber: 1500-3000ä¸‡
  if (price < 50000000) return '#ef4444';   // red: 3000-5000ä¸‡
  return '#7c3aed';                          // purple: >5000ä¸‡
}

async function showAllTransactionPins(ranked) {
  if (!txMarkerLayer) return;
  txMarkerLayer.clearLayers();

  // Geocode districts for all areas with transactions (AREASæœ¬ä½“ã‚’å‚ç…§)
  for (const area of AREAS) {
    if (area._liveTransactions && area._liveTransactions.length > 0) {
      await geocodeAreaDistricts(area, { showOverlay: false });
    }
  }

  let totalPins = 0;
  AREAS.forEach(area => {
    const transactions = area._liveTransactions;
    if (!transactions) return;
    const color = COLORS[AREAS.indexOf(area) % COLORS.length];
    transactions.forEach((tx, i) => {
      const pos = estimateTxPosition(area, tx, i);
      const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
      totalPins++;
      const cm = L.circleMarker([pos.lat, pos.lng], {
        radius: 5,
        fillColor: hasPrice ? priceColor(tx.TradePrice) : '#9ca3af',
        color: '#fff',
        weight: 1,
        opacity: 0.8,
        fillOpacity: 0.6
      });
      cm.bindPopup(buildTxPopup(tx, area.name), { maxWidth: 220 });
      txMarkerLayer.addLayer(cm);
    });
  });
  console.log(`[PIN] showAllTransactionPins: ${totalPins} total pins created`);
}

// Map loading overlay controls
function showMapLoading(areaName, pct) {
  const overlay = document.getElementById('map-loading-overlay');
  if (!overlay) return;
  overlay.classList.remove('hidden');
  updateMapLoading(areaName, pct);
}

function updateMapLoading(label, pct) {
  const textEl = document.getElementById('map-loading-text');
  const barEl = document.getElementById('map-loading-bar');
  if (textEl) textEl.textContent = label;
  if (barEl) barEl.style.width = pct + '%';
}

function hideMapLoading() {
  const overlay = document.getElementById('map-loading-overlay');
  if (overlay) overlay.classList.add('hidden');
}

// Transaction pin index for sidebar click â†’ map navigation
let txMarkersByIdx = {};

function showTransactionPins(area) {
  if (!txMarkerLayer) return;
  txMarkerLayer.clearLayers();
  txMarkersByIdx = {};

  // å¸¸ã«AREASæœ¬ä½“ã‹ã‚‰æœ€æ–°ã®_liveTransactionsã‚’å–å¾—ï¼ˆrankedã‚³ãƒ”ãƒ¼ã¯å¤ã„å ´åˆãŒã‚ã‚‹ï¼‰
  const canonical = AREAS.find(a => a.id === area.id) || area;
  const transactions = canonical._liveTransactions;
  if (!transactions) return;

  let pinCount = 0;
  transactions.forEach((tx, i) => {
    const pos = estimateTxPosition(area, tx, i);
    const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
    const cm = L.circleMarker([pos.lat, pos.lng], {
      radius: 7,
      fillColor: hasPrice ? priceColor(tx.TradePrice) : '#9ca3af',
      color: '#fff',
      weight: 1.5,
      opacity: 0.9,
      fillOpacity: hasPrice ? 0.7 : 0.4
    });
    cm.bindPopup(buildTxPopup(tx, area.name), { maxWidth: 240 });
    txMarkerLayer.addLayer(cm);
    txMarkersByIdx[i] = { marker: cm, pos };
    pinCount++;
  });
  console.log(`[PIN] showTransactionPins: ${area.name} â€” ${pinCount} pins created from ${transactions.length} transactions`);
}

// Navigate map to a specific transaction pin and open popup
function flyToTransaction(idx) {
  const entry = txMarkersByIdx[idx];
  if (!entry || !mapInstance) return;
  mapInstance.flyTo([entry.pos.lat, entry.pos.lng], 16, { duration: 0.6 });
  setTimeout(() => {
    entry.marker.setRadius(12);
    entry.marker.openPopup();
    setTimeout(() => entry.marker.setRadius(7), 2000);
  }, 650);
}

function buildTxPopup(tx, cityName) {
  const hasPrice = tx.TradePrice != null && !isNaN(tx.TradePrice);
  const priceStr = hasPrice
    ? (tx.TradePrice >= 10000 ? `${(tx.TradePrice/10000).toFixed(0)}ä¸‡å††` : `${tx.TradePrice.toLocaleString()}å††`)
    : 'ä¾¡æ ¼ä¸æ˜';
  return `
    <div style="font-family:'Noto Sans JP',sans-serif;font-size:12px;line-height:1.6;">
      <div style="font-weight:700;font-size:14px;color:#1e40af;margin-bottom:4px;">${priceStr}</div>
      <table style="font-size:11px;">
        ${tx.District ? `<tr><td style="color:#6b7280;padding-right:8px;">åœ°åŒº</td><td>${tx.District}</td></tr>` : ''}
        ${tx.Area ? `<tr><td style="color:#6b7280;padding-right:8px;">é¢ç©</td><td>${tx.Area}mÂ²</td></tr>` : ''}
        ${tx.Type || tx.Use ? `<tr><td style="color:#6b7280;padding-right:8px;">ç¨®åˆ¥</td><td>${tx.Type || tx.Use}</td></tr>` : ''}
        ${tx.NearestStation ? `<tr><td style="color:#6b7280;padding-right:8px;">æœ€å¯„é§…</td><td>${tx.NearestStation}${tx.DistanceToStation ? ` (${tx.DistanceToStation})` : ''}</td></tr>` : ''}
        ${tx.BuildingYear ? `<tr><td style="color:#6b7280;padding-right:8px;">ç¯‰å¹´</td><td>${tx.BuildingYear}</td></tr>` : ''}
        ${tx.Structure ? `<tr><td style="color:#6b7280;padding-right:8px;">æ§‹é€ </td><td>${tx.Structure}</td></tr>` : ''}
      </table>
      <div style="font-size:10px;color:#9ca3af;margin-top:4px;">${cityName}</div>
    </div>`;
}

function createMapIcon(color, rank, score, isSelected) {
  const size = isSelected ? 48 : 40;
  const borderWidth = isSelected ? 3 : 2;
  const shadow = isSelected ? 'filter: drop-shadow(0 2px 6px rgba(0,0,0,0.3));' : 'filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));';
  const svgString = `
    <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg" style="${shadow}">
      <circle cx="${size/2}" cy="${size/2}" r="${size/2-2}" fill="${color}" opacity="0.9" stroke="white" stroke-width="${borderWidth}"/>
      <text x="${size/2}" y="${size/2-2}" text-anchor="middle" fill="white" font-size="${isSelected ? 11 : 10}" font-weight="500" font-family="sans-serif">${rank}ä½</text>
      <text x="${size/2}" y="${size/2+10}" text-anchor="middle" fill="white" font-size="${isSelected ? 13 : 11}" font-weight="700" font-family="sans-serif">${score}</text>
    </svg>`;
  return L.icon({
    iconUrl: 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString))),
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2],
    tooltipAnchor: [0, -size/2]
  });
}

function updateMapSidebar(area, ranked) {
  const sidebar = document.getElementById('map-sidebar');
  if (!sidebar) return;

  // rankedé…åˆ—ã‹ã‚‰scoresä»˜ãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ï¼ˆAREASç›´å‚ç…§ã¯scoresãŒç„¡ã„ï¼‰
  const rankedArea = ranked.find(a => a.id === area.id) || area;
  // AREASæœ¬ä½“ã‹ã‚‰æœ€æ–°ã®_liveTransactionsã‚’å–å¾—ï¼ˆrankedã‚³ãƒ”ãƒ¼ã¯å¤ã„å ´åˆãŒã‚ã‚‹ï¼‰
  const canonical = AREAS.find(a => a.id === area.id) || area;
  area = rankedArea;

  const rank = ranked.findIndex(a => a.id === area.id) + 1;
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const medalStr = rank <= 3 ? medals[rank-1] : `${rank}ä½`;

  const isFullLoaded = AREA_FULL_LOADED.has(area.id);
  const isFetching = _currentFetchAreaId === area.id;
  const txCount = canonical._liveTransactions ? canonical._liveTransactions.length : 0;

  const loadingBadge = isFetching
    ? '<span class="inline-flex items-center gap-1 text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full mb-2"><span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</span>'
    : isFullLoaded
      ? `<span class="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded-full mb-2">âœ… å…¨æœŸé–“ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆã¿ï¼ˆ${txCount}ä»¶ï¼‰</span>`
      : `<span class="text-xs text-gray-400 mb-2">æ¦‚è¦ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼ˆ${txCount}ä»¶ï¼‰</span>`;

  const txSection = txCount > 0
    ? renderTransactionList(canonical._liveTransactions)
    : (state.mcpStatus === 'connected'
      ? '<p class="text-xs text-gray-400 mt-2">å–å¼•ãƒ‡ãƒ¼ã‚¿ãªã—</p>'
      : '<p class="text-xs text-gray-400 mt-2">MCPã«æ¥ç¶šã™ã‚‹ã¨å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>');

  sidebar.innerHTML = `
    <div class="sidebar-header">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-xl">${medalStr}</span>
          <h3 class="text-lg font-bold text-gray-900">${area.name}</h3>
        </div>
        <span class="text-2xl font-bold text-blue-600">${area.scores.total}<span class="text-xs font-normal text-gray-400">pt</span></span>
      </div>
    </div>
    <div class="sidebar-body space-y-4">
      ${loadingBadge}
      <!-- Key metrics -->
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-blue-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">ä½å®…åœ°ä¾¡æ ¼</div>
          <div class="text-sm font-bold text-blue-700">${(area.residentialPrice/10000).toFixed(1)}ä¸‡/mÂ²</div>
        </div>
        <div class="bg-green-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">åå¤å±‹ã¾ã§</div>
          <div class="text-sm font-bold text-green-700">${area.accessToNagoya}åˆ†</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">åœ°ä¾¡å¤‰å‹•</div>
          <div class="text-sm font-bold text-amber-700">+${area.yoyChange}%</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">äººå£</div>
          <div class="text-sm font-bold text-purple-700">${(area.population/10000).toFixed(1)}ä¸‡äºº</div>
        </div>
      </div>

      <!-- Live average price -->
      ${area._liveAvgTradePrice ? `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center gap-2 mb-1">
            <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
            <span class="text-xs font-medium text-blue-700">LIVE å¹³å‡å–å¼•ä¾¡æ ¼</span>
          </div>
          <div class="text-lg font-bold text-blue-800">${(area._liveAvgTradePrice / 10000).toFixed(0)}ä¸‡å††</div>
          <div class="text-xs text-blue-500">${area._liveTransactionCount}ä»¶ã®å–å¼•ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç®—å‡º</div>
        </div>
      ` : ''}

      <!-- Description -->
      <div>
        <p class="text-xs text-gray-600 leading-relaxed">${area.description}</p>
      </div>

      <!-- Highlights -->
      <div class="bg-green-50 rounded-lg p-3">
        <div class="text-xs font-bold text-green-700 mb-2">âœ… ãƒã‚¤ãƒ³ãƒˆ</div>
        ${area.highlights.map(h => `<div class="text-xs text-green-800 mb-1">â€¢ ${h}</div>`).join('')}
      </div>

      <!-- Transaction data -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs font-bold text-gray-700">ğŸ“Š å–å¼•ãƒ‡ãƒ¼ã‚¿</div>
          <div class="text-xs text-gray-400">${area._liveTransactions ? area._liveTransactions.length + 'ä»¶' : ''}</div>
        </div>
        ${txSection}
        ${area._liveTransactions && area._liveTransactions.length > 0 ? `
          <div class="mt-2 flex flex-wrap gap-1 items-center">
            <span class="text-xs text-gray-400">å‡¡ä¾‹:</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#22c55e;display:inline-block;"></span>~500ä¸‡</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#3b82f6;display:inline-block;"></span>~1500ä¸‡</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#f59e0b;display:inline-block;"></span>~3000ä¸‡</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;"></span>~5000ä¸‡</span>
            <span class="inline-flex items-center gap-1 text-xs"><span style="width:8px;height:8px;border-radius:50%;background:#7c3aed;display:inline-block;"></span>5000ä¸‡~</span>
          </div>
        ` : ''}
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2">
        <button data-map-to-detail="${area.id}" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors text-center">
          ğŸ” è©³ç´°ã‚’è¦‹ã‚‹
        </button>
        <button data-map-zoom-out class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors">
          ğŸ—ºï¸ å…¨ä½“è¡¨ç¤º
        </button>
      </div>
    </div>
  `;

  // Bind sidebar buttons
  const detailBtn = sidebar.querySelector('[data-map-to-detail]');
  if (detailBtn) {
    detailBtn.addEventListener('click', () => {
      state.selectedAreaId = area.id;
      state.view = 'detail';
      render();
    });
  }

  const zoomOutBtn = sidebar.querySelector('[data-map-zoom-out]');
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = null;
      if (mapInstance) mapInstance.flyTo([34.98, 136.56], 10, { duration: 0.8 });
      // Reset marker icons
      const ranked2 = getRankedAreas();
      ranked2.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        if (mapMarkers[a.id]) mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, false));
      });
      // Show all transaction pins again
      showAllTransactionPins(ranked2);
      // Reset sidebar
      sidebar.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full text-center p-8">
          <div class="text-4xl mb-3">ğŸ“</div>
          <p class="text-sm font-medium text-gray-700 mb-1">ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
          <p class="text-xs text-gray-400">ãƒãƒƒãƒ—ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>åœŸåœ°æƒ…å ±ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>`;
    });
  }

  // Bind transaction row clicks â†’ fly to map pin
  sidebar.querySelectorAll('tr[data-tx-idx]').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.txIdx);
      // Highlight active row
      sidebar.querySelectorAll('tr.tx-active').forEach(r => r.classList.remove('tx-active'));
      row.classList.add('tx-active');
      // Fly to pin
      flyToTransaction(idx);
    });
  });
}

function updateDistrictSidebar(area, districtName, ranked) {
  const sidebar = document.getElementById('map-sidebar');
  if (!sidebar) return;

  const metrics = aggregateDistrictMetrics(area, districtName);
  if (!metrics) {
    sidebar.innerHTML = `<div class="p-4 text-sm text-gray-500">åœ°åŒºãƒ‡ãƒ¼ã‚¿ãªã—</div>`;
    return;
  }

  const avgPriceStr = metrics.avgPrice ? `${(metrics.avgPrice / 10000).toFixed(0)}ä¸‡å††` : '-';
  const priceRange = (metrics.minPrice && metrics.maxPrice)
    ? `${(metrics.minPrice / 10000).toFixed(0)}ã€œ${(metrics.maxPrice / 10000).toFixed(0)}ä¸‡å††`
    : '-';
  const m2PriceStr = metrics.avgPricePerM2 ? `${(metrics.avgPricePerM2 / 10000).toFixed(1)}ä¸‡/mÂ²` : '-';
  const stationStr = metrics.nearestStation || '-';
  const nagoyaStr = metrics.nagoyaMin ? `ç´„${metrics.nagoyaMin}åˆ†` : `ç´„${area.accessToNagoya}åˆ†`;
  const distStr = metrics.avgDistance ? `å¾’æ­©${metrics.avgDistance}åˆ†` : '-';
  const ageStr = metrics.avgBuildingAge !== null ? `ç¯‰${metrics.avgBuildingAge}å¹´` : '-';

  // Type distribution bar
  const typeColors = { 'å®…åœ°(åœŸåœ°)': '#22c55e', 'å®…åœ°(åœŸåœ°ã¨å»ºç‰©)': '#3b82f6', 'ä¸­å¤ãƒãƒ³ã‚·ãƒ§ãƒ³ç­‰': '#f59e0b', 'è¾²åœ°': '#84cc16', 'æ—åœ°': '#14b8a6' };
  const typeBar = metrics.typeDistribution.map(t => {
    const color = typeColors[t.name] || '#9ca3af';
    return `<div style="width:${t.pct}%;background:${color};height:100%;display:inline-block;" title="${t.name} ${t.pct}%"></div>`;
  }).join('');
  const typeLegend = metrics.typeDistribution.slice(0, 4).map(t => {
    const color = typeColors[t.name] || '#9ca3af';
    return `<span class="inline-flex items-center gap-1 text-xs"><span style="width:6px;height:6px;border-radius:50%;background:${color};display:inline-block;"></span>${t.name.replace('å®…åœ°(','').replace(')','').replace('ä¸­å¤ãƒãƒ³ã‚·ãƒ§ãƒ³ç­‰','ãƒãƒ³ã‚·ãƒ§ãƒ³')} ${t.pct}%</span>`;
  }).join(' ');

  // Transaction list filtered to this district
  const districtTxs = metrics.transactions;
  const txSection = renderTransactionList(districtTxs);

  sidebar.innerHTML = `
    <div class="sidebar-header">
      <button id="btn-back-to-city" class="flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800 mb-2 cursor-pointer" style="background:none;border:none;padding:0;">
        â† ${area.name}ã«æˆ»ã‚‹
      </button>
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-900">ğŸ“ ${districtName}</h3>
        <span class="text-sm font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">${metrics.count}ä»¶</span>
      </div>
    </div>
    <div class="sidebar-body space-y-4">
      <!-- Key metrics -->
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-blue-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">å¹³å‡å–å¼•ä¾¡æ ¼</div>
          <div class="text-sm font-bold text-blue-700">${avgPriceStr}</div>
        </div>
        <div class="bg-indigo-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">ã¡å˜ä¾¡</div>
          <div class="text-sm font-bold text-indigo-700">${m2PriceStr}</div>
        </div>
        <div class="bg-green-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">æœ€å¯„é§…</div>
          <div class="text-sm font-bold text-green-700" style="font-size:11px;">${stationStr}</div>
        </div>
        <div class="bg-emerald-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">åå¤å±‹ã¾ã§</div>
          <div class="text-sm font-bold text-emerald-700">${nagoyaStr}</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">é§…è·é›¢</div>
          <div class="text-sm font-bold text-amber-700">${distStr}</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-2 text-center">
          <div class="text-xs text-gray-500">å¹³å‡ç¯‰å¹´æ•°</div>
          <div class="text-sm font-bold text-purple-700">${ageStr}</div>
        </div>
      </div>

      <!-- Price range -->
      <div class="bg-gray-50 rounded-lg p-2">
        <div class="text-xs text-gray-500 mb-1">ä¾¡æ ¼å¸¯</div>
        <div class="text-sm font-medium text-gray-700">${priceRange}</div>
      </div>

      <!-- Type distribution -->
      ${metrics.typeDistribution.length > 0 ? `
        <div>
          <div class="text-xs text-gray-500 mb-1">ç”¨é€”åˆ†å¸ƒ</div>
          <div style="height:8px;border-radius:4px;overflow:hidden;background:#e5e7eb;display:flex;">${typeBar}</div>
          <div class="mt-1 flex flex-wrap gap-2">${typeLegend}</div>
        </div>
      ` : ''}

      <!-- Transaction data -->
      <div>
        <div class="text-xs font-bold text-gray-700 mb-2">ğŸ“Š å–å¼•ãƒ‡ãƒ¼ã‚¿ï¼ˆ${districtName}ï¼‰</div>
        ${txSection || '<p class="text-xs text-gray-400">å–å¼•ãƒ‡ãƒ¼ã‚¿ãªã—</p>'}
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2">
        <button id="btn-district-back" class="flex-1 px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors text-center">
          â†© ${area.name}ã¸æˆ»ã‚‹
        </button>
        <button data-map-zoom-out class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-200 transition-colors">
          ğŸ—ºï¸ å…¨ä½“è¡¨ç¤º
        </button>
      </div>
    </div>
  `;

  // Bind back button
  const backBtn = sidebar.querySelector('#btn-back-to-city');
  const backBtn2 = sidebar.querySelector('#btn-district-back');
  const goBack = () => {
    state.mapSelectedDistrict = null;
    updateMapSidebar(area, ranked);
    showTransactionPins(area);
  };
  if (backBtn) backBtn.addEventListener('click', goBack);
  if (backBtn2) backBtn2.addEventListener('click', goBack);

  // Bind zoom out
  const zoomOutBtn = sidebar.querySelector('[data-map-zoom-out]');
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      state.mapSelectedAreaId = null;
      state.mapSelectedDistrict = null;
      if (mapInstance) mapInstance.flyTo([34.98, 136.56], 10, { duration: 0.8 });
      const ranked2 = getRankedAreas();
      ranked2.forEach((a, i) => {
        const c = COLORS[AREAS.findIndex(x => x.id === a.id) % COLORS.length];
        if (mapMarkers[a.id]) mapMarkers[a.id].setIcon(createMapIcon(c, i + 1, a.scores.total, false));
      });
      showAllTransactionPins(ranked2);
      sidebar.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full text-center p-8">
          <div class="text-4xl mb-3">ğŸ“</div>
          <p class="text-sm font-medium text-gray-700 mb-1">ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
          <p class="text-xs text-gray-400">ãƒãƒƒãƒ—ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>åœŸåœ°æƒ…å ±ãƒ»å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>`;
    });
  }

  // Bind transaction row clicks
  sidebar.querySelectorAll('tr[data-tx-idx]').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.txIdx);
      sidebar.querySelectorAll('tr.tx-active').forEach(r => r.classList.remove('tx-active'));
      row.classList.add('tx-active');
      flyToTransaction(idx);
    });
  });
}

function renderTransactionList(transactions) {
  if (!transactions || transactions.length === 0) return '';

  // Keep original index for map pin reference
  // Use _areaIdx if present (from district filtering), otherwise use array index
  const indexed = transactions.map((t, i) => ({
    ...t,
    _origIdx: (t._areaIdx !== undefined) ? t._areaIdx : i
  }));
  // Show all transactions (including those without price)
  const validTx = [...indexed];
  if (validTx.length === 0) return '<p class="text-xs text-gray-400">å–å¼•ãƒ‡ãƒ¼ã‚¿ãªã—</p>';

  // Sort by price descending (null prices at end)
  validTx.sort((a, b) => {
    const pa = (a.TradePrice != null && !isNaN(a.TradePrice)) ? a.TradePrice : -1;
    const pb = (b.TradePrice != null && !isNaN(b.TradePrice)) ? b.TradePrice : -1;
    return pb - pa;
  });

  return `
    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
      <table class="tx-table">
        <thead>
          <tr>
            <th>ä¾¡æ ¼</th>
            <th>é¢ç©</th>
            <th>åœ°åŒº</th>
            <th>æœ€å¯„é§…</th>
          </tr>
        </thead>
        <tbody>
          ${validTx.map(t => {
            const hasP = t.TradePrice != null && !isNaN(t.TradePrice);
            const pStr = hasP ? (t.TradePrice >= 10000 ? (t.TradePrice/10000).toFixed(0) + 'ä¸‡' : t.TradePrice.toLocaleString() + 'å††') : '-';
            return `
            <tr data-tx-idx="${t._origIdx}" title="ã‚¯ãƒªãƒƒã‚¯ã§åœ°å›³ä¸Šã®ãƒ”ãƒ³ã¸ç§»å‹•">
              <td class="font-medium" style="color:${hasP ? priceColor(t.TradePrice) : '#9ca3af'}">${pStr}</td>
              <td>${t.Area ? t.Area + 'mÂ²' : '-'}</td>
              <td class="text-gray-500" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.District || '-'}</td>
              <td class="text-gray-500" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.NearestStation || '-'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function renderFooter() {
  return `
    <footer class="mt-8 py-6 border-t border-gray-200">
      <div class="text-center space-y-2">
        <p class="text-xs text-gray-400">
          ãƒ‡ãƒ¼ã‚¿å‡ºå…¸: å›½åœŸäº¤é€šçœ ä¸å‹•ç”£æƒ…å ±ãƒ©ã‚¤ãƒ–ãƒ©ãƒªAPI / ç·å‹™çœ e-Stat APIï¼ˆ2025å¹´å…¬ç¤ºåœ°ä¾¡ãƒ™ãƒ¼ã‚¹ï¼‰
        </p>
        <p class="text-xs text-gray-400">
          MCPæ¥ç¶šå…ˆ: <code class="bg-gray-100 px-1 rounded">mcp.n-3.ai</code> (reinfolib-real-estate-price, reinfolib-city-list)
        </p>
        <p class="text-xs text-gray-400">
          â€» æœ¬ãƒ„ãƒ¼ãƒ«ã¯å‚è€ƒæƒ…å ±ã§ã‚ã‚Šã€ä¸å‹•ç”£è³¼å…¥ã®æœ€çµ‚åˆ¤æ–­ã¯å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„
        </p>
        <p class="text-xs text-gray-300 mt-3">Â© æ³¨æ–‡ä½å®…æ¯”è¼ƒ.com â€” Powered by å›½åœŸäº¤é€šçœ ä¸å‹•ç”£æƒ…å ±ãƒ©ã‚¤ãƒ–ãƒ©ãƒª + è¡Œæ”¿ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿</p>
      </div>
    </footer>
  `;
}







// ============================================================
// Chart Drawing (Chart.js)
// ============================================================
function destroyCharts() {
  Object.values(state.charts).forEach(c => { try { c.destroy(); } catch {} });
  state.charts = {};
}

// ============================================================
// Compare: Modal Functions (Pattern C)
// ============================================================
function destroyCmpCharts() {
  Object.values(state.cmpCharts).forEach(c => { try { c.destroy(); } catch {} });
  state.cmpCharts = {};
}

// ============================================================
// SEO Content rendering inside detail modal
// ============================================================
function renderModalSeoContent(areaId) {
  if (typeof CITY_SEO_DATA === 'undefined') return '';
  const seo = CITY_SEO_DATA[areaId];
  if (!seo) return '';

  let html = '<hr style="margin:20px 0;border-color:#e5e7eb;">';

  // Tips (ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆ)
  if (seo.tips && seo.tips.length > 0) {
    html += `<div style="margin-bottom:16px;">`;
    html += seo.tips.map(t => `
      <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;padding:14px 16px;margin-bottom:10px;">
        <div style="font-size:13px;font-weight:700;color:#1d4ed8;margin-bottom:6px;">ğŸ  ${t.title}</div>
        <div style="font-size:13px;color:#1e3a5f;line-height:1.7;">${t.body}</div>
      </div>
    `).join('');
    html += `</div>`;
  }

  // FAQ (ã‚ˆãã‚ã‚‹è³ªå•)
  if (seo.faqs && seo.faqs.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <div style="font-size:14px;font-weight:700;color:#1f2937;margin-bottom:10px;">â“ ã‚ˆãã‚ã‚‹è³ªå•</div>`;
    html += seo.faqs.map(f => `
      <div class="border border-gray-200 rounded-lg overflow-hidden" style="margin-bottom:6px;">
        <button style="width:100%;text-align:left;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;background:#f9fafb;border:none;cursor:pointer;font-size:13px;font-weight:500;color:#1f2937;" onclick="this.parentElement.classList.toggle('faq-open')">
          <span>${f.question}</span>
          <svg style="width:16px;height:16px;color:#9ca3af;flex-shrink:0;transition:transform 0.2s;" class="faq-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div class="faq-answer" style="padding:10px 14px;font-size:13px;color:#4b5563;line-height:1.7;border-top:1px solid #f3f4f6;">${f.answer}</div>
      </div>
    `).join('');
    html += `</div>`;
  }

  // Checklist (ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)
  const checklist = CITY_SEO_DATA._checklist;
  if (checklist && checklist.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <div style="font-size:14px;font-weight:700;color:#1f2937;margin-bottom:4px;">âœ… åœŸåœ°è³¼å…¥å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</div>
      <div style="font-size:11px;color:#9ca3af;margin-bottom:8px;">ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</div>`;
    if (seo.checklist_notes) {
      html += `<div style="background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:10px 12px;margin-bottom:10px;font-size:12px;color:#92400e;">ğŸ’¡ ${seo.checklist_notes}</div>`;
    }
    html += `<div style="font-size:13px;font-weight:600;color:#2563eb;margin-bottom:8px;" id="cl-progress">0/${checklist.length} å®Œäº†</div>`;
    html += checklist.map(item => `
      <label style="display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:8px;border:1px solid #f3f4f6;margin-bottom:4px;cursor:pointer;" data-cl-id="${item.id}">
        <input type="checkbox" style="margin-top:3px;width:16px;height:16px;cursor:pointer;" data-cl-check="${item.id}" onchange="clUpdate('${areaId}')">
        <div>
          <div style="font-size:13px;font-weight:500;color:#1f2937;">${item.label}</div>
          <div style="font-size:11px;color:#6b7280;margin-top:2px;">${item.detail}</div>
        </div>
      </label>
    `).join('');
    html += `</div>`;
  }

  // Neighbor links (è¿‘éš£ã‚¨ãƒªã‚¢)
  if (seo.neighbors && seo.neighbors.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <div style="font-size:14px;font-weight:700;color:#1f2937;margin-bottom:8px;">ğŸ”— è¿‘éš£ã‚¨ãƒªã‚¢ã®æ³¨æ–‡ä½å®…æƒ…å ±</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">
        ${seo.neighbors.map(n => `<a href="/area/mie/${n.id}/" style="padding:6px 14px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;font-size:12px;font-weight:500;color:#374151;text-decoration:none;">${n.name} â†’</a>`).join('')}
      </div>
    </div>`;
  }

  // CTA (ç‰©ä»¶æ¯”è¼ƒãƒ„ãƒ¼ãƒ«)
  html += `
    <div style="background:linear-gradient(135deg,#eff6ff,#eef2ff);border:1px solid #bfdbfe;border-radius:12px;padding:20px;margin-bottom:16px;text-align:center;">
      <div style="font-size:14px;font-weight:700;color:#1f2937;margin-bottom:6px;">å…·ä½“çš„ãªç‰©ä»¶ãŒè¦‹ã¤ã‹ã£ãŸã‚‰...</div>
      <div style="font-size:12px;color:#4b5563;margin-bottom:12px;">AIãŒè¤‡æ•°ç‰©ä»¶ã‚’è‡ªå‹•æ¯”è¼ƒã€‚SUUMOãƒ»ãƒ›ãƒ¼ãƒ ã‚ºç­‰ã®URLã‚’è²¼ã‚‹ã ã‘ã§ã€è¦‹ã‚„ã™ã„æ¯”è¼ƒè¡¨ã‚’ä½œæˆã—ã¾ã™ã€‚</div>
      <a href="/" style="display:inline-flex;align-items:center;gap:6px;padding:10px 20px;background:#2563eb;color:white;border-radius:8px;font-size:13px;font-weight:500;text-decoration:none;">ğŸ  æ³¨æ–‡ä½å®…æ¯”è¼ƒ.comã§ç‰©ä»¶ã‚’æ¯”è¼ƒã™ã‚‹ â†’</a>
    </div>`;

  // Share buttons
  const pageUrl = seo.cityUrl ? 'https://research.chuumon-soudan.com' + seo.cityUrl : window.location.href;
  const pageTitle = seo.nameJa ? seo.nameJa + 'ã§æ³¨æ–‡ä½å®…ï½œåœŸåœ°ç›¸å ´ãƒ»è²»ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³' : document.title;
  const encodedUrl = encodeURIComponent(pageUrl);
  const encodedTitle = encodeURIComponent(pageTitle);
  html += `
    <div style="display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;padding:12px 0;">
      <span style="font-size:11px;color:#9ca3af;">ã“ã®ãƒšãƒ¼ã‚¸ã‚’ã‚·ã‚§ã‚¢:</span>
      <a href="https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:4px;padding:5px 12px;background:#000;color:white;border-radius:6px;font-size:11px;font-weight:500;text-decoration:none;">ğ• ãƒã‚¹ãƒˆ</a>
      <a href="https://social-plugins.line.me/lineit/share?url=${encodedUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:4px;padding:5px 12px;background:#06c755;color:white;border-radius:6px;font-size:11px;font-weight:500;text-decoration:none;">LINE</a>
      <a href="https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:4px;padding:5px 12px;background:#1877f2;color:white;border-radius:6px;font-size:11px;font-weight:500;text-decoration:none;">Facebook</a>
    </div>`;

  return html;
}

function openCmpDetailModal(areaId) {
  const ranked = getRankedAreas();
  const area = ranked.find(a => a.id === areaId);
  if (!area) return;

  const scoreKeys = ['price','access','growth','living','family','nature'];
  const SCORE_LABELS_LONG = { price:'ä¾¡æ ¼ã®æ‰‹é ƒã•', access:'åå¤å±‹ã‚¢ã‚¯ã‚»ã‚¹', growth:'è³‡ç”£ä¾¡å€¤ä¸Šæ˜‡', living:'ç”Ÿæ´»åˆ©ä¾¿æ€§', family:'å­è‚²ã¦ç’°å¢ƒ', nature:'è‡ªç„¶ç’°å¢ƒ' };
  const SCORE_COLORS = { price:'#3b82f6', access:'#10b981', growth:'#f59e0b', living:'#ef4444', family:'#8b5cf6', nature:'#06b6d4' };

  const body = document.getElementById('cmp-detail-modal-body');
  body.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-gray-900">${area.name}</h2>
      <button id="cmp-close-detail" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition text-lg">&times;</button>
    </div>
    <p class="text-sm text-gray-600 mb-4 leading-relaxed">${area.description}</p>
    <div class="text-center mb-4">
      <span class="text-4xl font-bold text-blue-600">${area.scores.total}</span>
      <span class="text-sm text-gray-400 ml-1">/ 100ç‚¹</span>
    </div>
    <div style="position:relative; height:240px; margin-bottom:16px;">
      <canvas id="cmp-radar-modal"></canvas>
    </div>
    <div class="grid grid-cols-3 gap-2 mb-4">
      ${scoreKeys.map(k => `
        <div class="text-center">
          <div class="text-xs text-gray-400">${SCORE_LABELS_LONG[k]}</div>
          <div class="text-lg font-bold" style="color:${SCORE_COLORS[k]}">${area.scores[k]}</div>
        </div>
      `).join('')}
    </div>
    <hr class="mb-4">
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
      <div class="text-center p-3 bg-blue-50 rounded-xl">
        <div class="text-xs text-gray-500 mb-1">ä½å®…åœ°ä¾¡æ ¼</div>
        <div class="text-sm font-bold text-blue-700">${(area.residentialPrice/10000).toFixed(1)}ä¸‡/mÂ²</div>
      </div>
      <div class="text-center p-3 bg-green-50 rounded-xl">
        <div class="text-xs text-gray-500 mb-1">åå¤å±‹ã¾ã§</div>
        <div class="text-sm font-bold text-green-700">${area.accessToNagoya}åˆ†</div>
      </div>
      <div class="text-center p-3 bg-amber-50 rounded-xl">
        <div class="text-xs text-gray-500 mb-1">åœ°ä¾¡å¤‰å‹•</div>
        <div class="text-sm font-bold text-amber-700">+${area.yoyChange}%</div>
      </div>
      <div class="text-center p-3 bg-purple-50 rounded-xl">
        <div class="text-xs text-gray-500 mb-1">äººå£</div>
        <div class="text-sm font-bold text-purple-700">${(area.population/10000).toFixed(1)}ä¸‡äºº</div>
      </div>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
      <div class="flex items-center gap-2 text-sm"><span class="text-gray-400">ğŸ¥</span><span class="text-gray-600">åŒ»ç™‚ ${area.hospitals}ä»¶</span></div>
      <div class="flex items-center gap-2 text-sm"><span class="text-gray-400">ğŸ«</span><span class="text-gray-600">å­¦æ ¡ ${area.schools}æ ¡</span></div>
      <div class="flex items-center gap-2 text-sm"><span class="text-gray-400">ğŸŒ³</span><span class="text-gray-600">å…¬åœ’ ${area.parks}ç®‡æ‰€</span></div>
      <div class="flex items-center gap-2 text-sm"><span class="text-gray-400">ğŸ›’</span><span class="text-gray-600">å•†æ¥­ ${area.shopping}ä»¶</span></div>
    </div>
    <div class="mb-4">
      <div class="text-xs font-semibold text-gray-500 mb-2">ãŠã™ã™ã‚ã‚¨ãƒªã‚¢</div>
      <div class="flex flex-wrap gap-2">
        ${area.recAreas.map(r => `<span class="text-xs px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full">${r}</span>`).join('')}
      </div>
    </div>
    ${area.risks.length ? `
    <div class="mb-4">
      <div class="text-xs font-semibold text-gray-500 mb-2">æ³¨æ„ç‚¹</div>
      <div class="flex flex-wrap gap-2">
        ${area.risks.map(r => `<span class="text-xs px-3 py-1.5 bg-red-50 text-red-600 rounded-full">${r}</span>`).join('')}
      </div>
    </div>
    ` : ''}
    <div class="bg-gray-50 rounded-xl p-4">
      <div class="text-xs font-semibold text-gray-500 mb-2">åœ°ä¾¡æ¨ç§»ï¼ˆ2020-2025ï¼‰</div>
      <div style="position:relative; height:180px;">
        <canvas id="cmp-trend-modal"></canvas>
      </div>
    </div>
    <div style="margin-top:16px; text-center; text-align:center;">
      <button style="display:inline-block; padding:10px 24px; background:#059669; color:#fff; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer;" data-cmp-goto-map="${area.id}">ğŸ—ºï¸ åœ°å›³ã§è¦‹ã‚‹</button>
    </div>
    ${renderModalSeoContent(area.id)}
  `;

  document.getElementById('cmp-detail-modal').classList.add('open');
  document.getElementById('cmp-close-detail').addEventListener('click', () => closeCmpModal('cmp-detail-modal'));
  const mapBtn = body.querySelector('[data-cmp-goto-map]');
  if (mapBtn) mapBtn.addEventListener('click', () => {
    closeCmpModal('cmp-detail-modal');
    state.mapSelectedAreaId = areaId;
    state.view = 'map';
    render();
  });

  // Restore checklist state if exists
  if (typeof clRestore === 'function') {
    setTimeout(() => clRestore(areaId), 100);
  }

  // Draw charts after modal opens
  ensureChartJs().then(() => {
    setTimeout(() => {
      destroyCmpCharts();
      // Radar
      const radarCtx = document.getElementById('cmp-radar-modal');
      if (radarCtx) {
        state.cmpCharts.radar = new Chart(radarCtx, {
          type: 'radar',
          data: {
            labels: scoreKeys.map(k => SCORE_LABELS_LONG[k]),
            datasets: [{
              data: scoreKeys.map(k => area.scores[k]),
              backgroundColor: 'rgba(59,130,246,0.15)',
              borderColor: '#3b82f6',
              borderWidth: 2,
              pointBackgroundColor: '#3b82f6',
              pointRadius: 4,
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { r: { min: 0, max: 100, ticks: { stepSize: 25, font: { size: 10 } }, pointLabels: { font: { size: 11, family: 'Noto Sans JP' } } } },
            plugins: { legend: { display: false } }
          }
        });
      }
      // Trend
      const trendCtx = document.getElementById('cmp-trend-modal');
      if (trendCtx) {
        state.cmpCharts.trend = new Chart(trendCtx, {
          type: 'line',
          data: {
            labels: area.trend.map(t => t.y),
            datasets: [{
              data: area.trend.map(t => t.p),
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59,130,246,0.1)',
              fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#3b82f6',
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
              y: { ticks: { callback: v => `${(v/10000).toFixed(1)}ä¸‡`, font: { size: 10 } } },
              x: { ticks: { font: { size: 10 } } }
            },
            plugins: { legend: { display: false } }
          }
        });
      }
    }, 100);
  });
}

function openCmpColModal() {
  const body = document.getElementById('cmp-col-modal-body');
  body.innerHTML = `
    <div class="flex items-center justify-between mb-5">
      <h2 class="text-lg font-bold text-gray-900">è¡¨ç¤ºé …ç›®ã‚’é¸æŠ</h2>
      <button id="cmp-close-col" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition text-lg">&times;</button>
    </div>
    <div class="space-y-2 mb-5">
      ${CMP_COLUMNS.map(c => `
        <label class="flex items-center gap-3 p-2.5 rounded-lg hover:bg-gray-50 cursor-pointer transition">
          <input type="checkbox" class="cmp-col-checkbox rounded" data-cmp-col-key="${c.key}" ${state.cmpSelectedColumns.includes(c.key) ? 'checked' : ''}>
          <span class="text-sm">${c.icon} ${c.label}</span>
        </label>
      `).join('')}
    </div>
    <div class="flex justify-end gap-3">
      <button id="cmp-cancel-col" class="px-4 py-2 text-sm text-gray-600 rounded-lg hover:bg-gray-100 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="cmp-apply-col" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">é©ç”¨</button>
    </div>
  `;

  document.getElementById('cmp-col-modal').classList.add('open');
  document.getElementById('cmp-close-col').addEventListener('click', () => closeCmpModal('cmp-col-modal'));
  document.getElementById('cmp-cancel-col').addEventListener('click', () => closeCmpModal('cmp-col-modal'));
  document.getElementById('cmp-apply-col').addEventListener('click', () => {
    const checks = document.querySelectorAll('.cmp-col-checkbox:checked');
    state.cmpSelectedColumns = Array.from(checks).map(c => c.dataset.cmpColKey);
    if (state.cmpSelectedColumns.length === 0) state.cmpSelectedColumns = ['total'];
    closeCmpModal('cmp-col-modal');
    render();
  });
}

function closeCmpModal(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('open');
  if (id === 'cmp-detail-modal') destroyCmpCharts();
}

function drawCompareCharts(ranked) {
  // Pattern C: no static charts in compare view; charts are drawn on-demand in modals
  // Keep this function as a no-op so the render pipeline doesn't break
}

function drawDetailCharts(area) {
  destroyCharts();

  // Radar chart
  const radarCtx = document.getElementById('chart-radar');
  if (radarCtx) {
    state.charts.radar = new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: ['ä¾¡æ ¼', 'äº¤é€š', 'æˆé•·æ€§', 'åˆ©ä¾¿æ€§', 'å­è‚²ã¦', 'è‡ªç„¶'],
        datasets: [{
          label: area.name,
          data: [area.scores.price, area.scores.access, area.scores.growth, area.scores.living, area.scores.family, area.scores.nature],
          backgroundColor: '#3b82f6' + '30',
          borderColor: '#3b82f6',
          borderWidth: 2,
          pointBackgroundColor: '#3b82f6',
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          r: {
            beginAtZero: true, max: 100,
            ticks: { font: { size: 10 }, stepSize: 20 },
            pointLabels: { font: { size: 12 } }
          }
        }
      }
    });
  }

  // Detail trend line
  const trendCtx = document.getElementById('chart-detail-trend');
  if (trendCtx) {
    state.charts.detailTrend = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: area.trend.map(t => t.y),
        datasets: [{
          label: `${area.name} åœ°ä¾¡æ¨ç§»`,
          data: area.trend.map(t => t.p),
          borderColor: '#3b82f6',
          backgroundColor: '#3b82f6' + '15',
          borderWidth: 3,
          pointRadius: 5,
          pointBackgroundColor: '#3b82f6',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { title: { display: true, text: 'å††/mÂ²', font: { size: 11 } } }
        }
      }
    });
  }
}

// ============================================================
// Event Binding
// ============================================================
function bindEvents(ranked) {
  // Tab switches
  document.querySelectorAll('[data-tab]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.view = btn.dataset.tab;
      // ãƒ¢ãƒã‚¤ãƒ«ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚’é–‰ã˜ã‚‹
      closeMobileDrawer();
      render();
    });
  });

  // Weight sliders
  document.querySelectorAll('input[data-weight]').forEach(slider => {
    slider.addEventListener('input', (e) => {
      const key = e.target.dataset.weight;
      const val = parseInt(e.target.value);
      state.weights[key] = val;
      const vEl = document.getElementById(`wv-${key}`);
      if (vEl) vEl.textContent = val;
      e.target.style.background = `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${val*2}%, #e5e7eb ${val*2}%, #e5e7eb 100%)`;
      // Debounced re-render for ranking
      clearTimeout(state._renderTimeout);
      state._renderTimeout = setTimeout(() => render(), 150);
    });
  });

  // Area detail click â†’ open modal (not navigate to detail view)
  document.querySelectorAll('[data-area-detail]').forEach(el => {
    el.addEventListener('click', () => {
      openCmpDetailModal(el.dataset.areaDetail);
    });
  });

  // Area switch buttons (legacy, kept for backwards compat)
  document.querySelectorAll('[data-area-switch]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.selectedAreaId = btn.dataset.areaSwitch;
      render();
    });
  });

  // Back button (legacy)
  const backBtn = document.getElementById('btn-back');
  if (backBtn) backBtn.addEventListener('click', () => { state.view = 'ranking'; render(); });

  // Weight preset buttons
  document.querySelectorAll('[data-weight-preset]').forEach(btn => {
    btn.addEventListener('click', () => {
      const preset = WEIGHT_PRESETS[btn.dataset.weightPreset];
      if (preset) {
        state.weights = { ...preset.weights };
        render();
      }
    });
  });

  // Weights toggle (customize)
  const weightsToggle = document.getElementById('weights-toggle');
  if (weightsToggle) {
    weightsToggle.addEventListener('click', () => {
      state.weightsExpanded = !state.weightsExpanded;
      const sliders = document.getElementById('weights-sliders');
      if (sliders) {
        if (state.weightsExpanded) {
          sliders.style.maxHeight = '300px';
          sliders.style.opacity = '1';
          sliders.style.marginTop = '16px';
        } else {
          sliders.style.maxHeight = '0';
          sliders.style.opacity = '0';
          sliders.style.marginTop = '0';
        }
        // Rotate arrow
        const arrow = weightsToggle.querySelector('svg');
        if (arrow) arrow.style.transform = state.weightsExpanded ? 'rotate(180deg)' : '';
      }
    });
  }

  // === Compare Pattern C events ===
  // Open detail modal on row click
  document.querySelectorAll('[data-cmp-open-detail]').forEach(el => {
    el.addEventListener('click', () => openCmpDetailModal(el.dataset.cmpOpenDetail));
  });

  // Remove column tag
  document.querySelectorAll('[data-cmp-remove-col]').forEach(el => {
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      const key = el.dataset.cmpRemoveCol;
      state.cmpSelectedColumns = state.cmpSelectedColumns.filter(k => k !== key);
      if (state.cmpSelectedColumns.length === 0) state.cmpSelectedColumns = ['total'];
      render();
    });
  });

  // Open column selector modal
  const colBtn = document.getElementById('cmp-open-col-modal');
  if (colBtn) colBtn.addEventListener('click', () => openCmpColModal());

  // Preset buttons
  document.querySelectorAll('[data-cmp-preset]').forEach(el => {
    el.addEventListener('click', () => {
      const preset = CMP_PRESETS[el.dataset.cmpPreset];
      if (preset) {
        state.cmpSelectedColumns = [...preset.cols];
        render();
      }
    });
  });
}

// === Global modal handlers (overlay click + Escape) ===
document.querySelectorAll('.cmp-modal-overlay').forEach(m => {
  m.addEventListener('click', (e) => {
    if (e.target === m) closeCmpModal(m.id);
  });
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.cmp-modal-overlay.open').forEach(m => closeCmpModal(m.id));
  }
});

// ============================================================
// Initialize
// ============================================================
loadDistrictCache();
render();
// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚: ã¾ãšé™çš„JSONã‚’èª­ã¿è¾¼ã¿ã€ãªã‘ã‚Œã°MCPæ¥ç¶šã‚’æ¡ˆå†…
loadStaticData();
</script>
</body>
</html>
